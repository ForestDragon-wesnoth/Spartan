#textdomain wesnoth-Hoplite

    ## [event]
        ## name=unused#preload
        ## #debugging code.
        ## [lua]
            ## code=<<
## local old = wesnoth.wml_actions.store_unit
## function wesnoth.wml_actions.store_unit(cfg)
## wesnoth.message("store_unit:",cfg.variable)
## wesnoth.message(wml.get_child(cfg,"filter").type)old(cfg)
## end
## local old = wesnoth.wml_actions.unstore_unit
## function wesnoth.wml_actions.unstore_unit(cfg)
    ## wesnoth.message("unstore_unit:",cfg.variable)
    ## old(cfg)
## end
## >>
        ## [/lua]
    ## [/event]
    [event]
        # is used to show icon in status bar
        name=preload
        first_time_only=no
        id=show_cursed
        [lua]
            code=<<
                 local _ = wesnoth.textdomain "wesnoth-Hoplite"
                 local old_unit_status = wesnoth.theme_items.unit_status
                 function wesnoth.theme_items.unit_status()
                     local u = wesnoth.get_displayed_unit()
                     if not u then return {} end
                     local s = old_unit_status()
                     if u.status.unhealable then
                         table.insert(s, { "element", {
                             image = "misc/status-cursed.png",
                             tooltip = _"Cursed: You are unable to use healing potions, phoenix amulet revival (and most other methods of healing), and killing enemies only restores half as much energy as normal."
                         } })
                     end
                     return s
                 end
             >>
        [/lua]
    [/event]

    [side]
        side=1
        controller=human
        team_name=hoplite
        user_team_name= _ "team_name^Hoplite"
        color=red

        type=Hoplite
        id=Hoplite
        name= _ "Hoplite"
#        unrenamable=yes
        canrecruit=yes
        facing=n
        recruit=

        gold=0
        income=-2
        suppress_end_turn_confirmation=yes
        gold_lock=yes
        income_lock=yes
        faction_lock=yes
        team_lock=yes
        leader_lock=yes
        color_lock=yes
    [/side]

#ifdef MULTIPLAYER
    [side]
        side=2
        controller=human
        team_name=hoplite
        user_team_name= _ "team_name^Hoplite"
        color=teal

        type=Hoplite
        id=Hoplite2
        name= _ "Hoplite"
#        unrenamable=yes
        canrecruit=yes
        facing=n
        recruit=

        gold=0
        income=-2
        suppress_end_turn_confirmation=yes
        gold_lock=yes
        income_lock=yes
        faction_lock=yes
        team_lock=yes
        leader_lock=yes
        color_lock=yes
    [/side]
#endif

    [side]
#ifdef MULTIPLAYER
        side=3
#else
        side=2
#endif
        controller=ai
        team_name=enemy
        user_team_name= _ "team_name^Enemies"
        color=blue
        no_leader=yes

        recruit=

        [ai]
            aggression=1.0
        [/ai]

        gold=0
        income=-2
        allow_player=no
    [/side]

    [side]
#ifdef MULTIPLAYER
        side=4
#else
        side=3
#endif
        controller=null#until unlocked
        team_name=hoplite
        user_team_name= _ "team_name^Allies"
        color=green
        no_leader=yes
        hidden=yes

        recruit=

        [ai]
            aggression=1.0
            [goal]
                name=protect_unit
                [criteria]
                    id=Hoplite,Hoplite2
                [/criteria]
                value=20
                protect_radius=3
            [/goal]
            attack_depth=2
            simple_targeting=yes
            aggression=1
        [/ai]

        gold=0
        income=-2
        allow_player=no
    [/side]
    [event]
        name=prestart
        {~add-ons/Spartan/macros/level_generation.cfg}
        {~add-ons/Spartan/macros/upgrade_events.cfg}
        {~add-ons/Spartan/macros/misc_events.cfg}

#ifndef MULTIPLAYER
        {VARIABLE hoplite_playerside 1}
        {VARIABLE hoplite_enemyside 2}
        {VARIABLE hoplite_allyside 3}
#endif
#ifdef MULTIPLAYER
        {VARIABLE hoplite_playerside 1,2}
        {VARIABLE hoplite_enemyside 3}
        {VARIABLE hoplite_allyside 4}
        {VARIABLE hoplite_multiplayer yes}
#endif

        {VARIABLE hoplite_debug yes}

#ifndef MULTIPLAYER
        {VARIABLE hoplite_energy 100}
        {VARIABLE hoplite_maxenergy 100}
        {SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
#endif

#ifdef MULTIPLAYER
        {VARIABLE hoplite_energy1 100}
        {VARIABLE hoplite_maxenergy1 100}
        {VARIABLE hoplite_energy2 100}
        {VARIABLE hoplite_maxenergy2 100}
        {SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
        {SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
#endif
        {VARIABLE hoplite_spearthrow_radius 2}
#ifdef MULTIPLAYER
        {VARIABLE hoplite_spearthrow_radius2 2}
#endif
        {VARIABLE hoplite_teleport_radius 2}
#ifdef MULTIPLAYER
        {VARIABLE hoplite_teleport_radius2 2}
#endif
        {VARIABLE_OP forge_delay add 1}
        {VARIABLE hoplite_shield_distance1 1}
        {VARIABLE hoplite_shield_distance2 1}

        [disallow_end_turn]
        [/disallow_end_turn]

        [item]
            image="scenery/trapdoor-open.png"
            x,y=6,2
        [/item]
        {VARIABLE_OP hoplite_depth add 1}
        {SET_LABEL 2 1 "Depth: $hoplite_depth|"}
        {HOPLITE_GENERATE_TERRAIN}
        {HOPLITE_SCATTER_ENEMY 2 Hoplite_Orcgrunt Ur}

        [micro_ai]
            side=$hoplite_enemyside
            ai_type=coward
            action=add
            id=ranged_enemy_retreat
            [filter]
                ability=hoplite_ranged
		[not]
		  type=Hoplite_Archmage
		[/not]
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_enemyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=4
                    [filter_radius]
                        terrain=!,Xu,Xo*
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=2
        [/micro_ai]
        [micro_ai]
            side=$hoplite_enemyside
            ai_type=coward
            action=add
            id=archmage_retreat
            [filter]
	        type=Hoplite_Archmage
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_enemyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=4
                    [filter_radius]
                        terrain=!,Xu,Xo*
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=1
        [/micro_ai]
        [micro_ai]
            side=$hoplite_enemyside
            ai_type=coward
            action=add
            id=summoner_retreat
            [filter]
                type=Hoplite_Demilich,Hoplite_Serpentmage
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_enemyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=5
                    [filter_radius]
                        terrain=!,Xu,Xo*
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=3
            attack_if_trapped=yes
        [/micro_ai]
        [micro_ai]
            side=$hoplite_enemyside
            ai_type=coward
            action=add
            id=wyvern_retreat
            [filter]
                type=Hoplite_Wyvern
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_enemyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=2
                    [filter_radius]
                        terrain=!,Xu,Xo*
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=2
        [/micro_ai]
        [micro_ai]
            side=$hoplite_enemyside
            ai_type=lurkers
            action=add

            [filter]
                [filter_location]
                    [filter]
                        id=Hoplite,Hoplite2
                        [filter_vision]
                            visible=no
                            side=$hoplite_enemyside
                        [/filter_vision]
                    [/filter]
                    radius=4
                [/filter_location]
            [/filter]
            [filter_location]
            [/filter_location]
            [filter_location_wander]
            [/filter_location_wander]
        [/micro_ai]
        [micro_ai]
            side=$hoplite_allyside
            ai_type=lurkers
            action=add

            [filter]
	        [not]
		  type=Hoplite_Elizabeth
		[/not]
                [filter_location]
		    [not]
                    [filter]
                        side=$hoplite_enemyside
#                        [filter_vision]
#                            visible=yes
#                            side=$hoplite_allyside
#                        [/filter_vision]
                    [/filter]
                    radius=3
		    [/not]
                [/filter_location]
            [/filter]
            [filter_location]
            [/filter_location]
            [filter_location_wander]
            [/filter_location_wander]
        [/micro_ai]
        [micro_ai]
            side=$hoplite_allyside
            ai_type=lurkers
            action=add

            [filter]
		type=Hoplite_Elizabeth
                [filter_location]
		    [not]
                    [filter]
                        side=$hoplite_enemyside
#                        [filter_vision]
#                            visible=yes
#                            side=$hoplite_allyside
#                        [/filter_vision]
                    [/filter]
                    radius=3
		    [or]
                    [filter]
                        side=$hoplite_enemyside
			[filter_adjacent]
			  side=$hoplite_playerside
			[/filter_adjacent]
                    [/filter]
		    radius=99
		    [/or]
		    [/not]
                [/filter_location]
            [/filter]
            [filter_location]
            [/filter_location]
            [filter_location_wander]
            [/filter_location_wander]
        [/micro_ai]
        [micro_ai]
            side=$hoplite_enemyside
            ai_type=lurkers
            action=add

            [filter]
                ability=ambush
                [not]
                    [filter_location]
                        [filter]
                            side=$hoplite_playerside,$hoplite_allyside
                        [/filter]
                        radius=2
                    [/filter_location]
                [/not]
            [/filter]
            [filter_location]
                terrain=Gll^F**
            [/filter_location]
            [filter_location_wander]
                terrain=Gll^F**
            [/filter_location_wander]
        [/micro_ai]
        [micro_ai]
            side=$hoplite_enemyside
            ai_type=healer_support
            id=augurs
            action=add

            [filter]
                type=Hoplite_Augur
            [/filter]
            [filter_second]
                side=$hoplite_enemyside
            [/filter_second]
            aggression=0.1
        [/micro_ai]
        [micro_ai]
            side=$hoplite_enemyside
            ai_type=stationed_guardian
            action=add
	    [filter]
	       id=Donovan
	    [/filter]
            distance=3
            station_x,station_y=6,5
            guard_x,guard_y=6,5
        [/micro_ai]

        [micro_ai]
            side=$hoplite_enemyside
            ai_type=coward
            action=add
            id=ranged_enemy_retreat
            [filter]
                ability=hoplite_bombthrow_ai
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_enemyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=3
                    [filter_radius]
                        terrain=!,Xu,Xo*
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=2
        [/micro_ai]
	[tunnel]
	[filter]
	[/filter]
	[source]
	terrain=*^Pob
	[/source]
	[target]
	terrain=*^Pob
	[/target]
	[/tunnel]
	[tunnel]
	[filter]
	[/filter]
	[source]
	terrain=*^Por
	[/source]
	[target]
	terrain=*^Por
	[/target]
	[/tunnel]

        #	{VARIABLE orcarcher_charging no}
        #	{VARIABLE skelearcher_charging no}
        #	{VARIABLE nagahunter_charging no}
        #	{VARIABLE darkwizard_charging no}
        #	{VARIABLE spiderqueen_web_charging no}
        #	{VARIABLE archmage_charging no}

        [objectives]
            side=$hoplite_playerside
            [objective]
#                description= _ "Descend into the dungeon."
                description= _ "Retrieve the Prometheus' heart at depth 40 and exit the cave at any depth afterwards via the stairs."
                condition=win
            [/objective]
#ifdef MULTIPLAYER
            [objective]
                description= _ "Death of either hoplite"
                condition=lose
            [/objective]
#else
            [objective]
                description= _ "Death of the Hoplite"
                condition=lose
            [/objective]
#endif
            [note]
               description=_"If you want to learn more about the custom mechanics or see your achievements, check the 'information menu' righclick option."
	    [/note]
            [note]
               description=_"In multiplayer, enemies are stronger than usual (+5 hitpoints for normal enemies, +50% for bosses), and there are roughly 1.5 times as many of them."
	    [show_if]
	    {VARIABLE_CONDITIONAL hoplite_multiplayer equals yes}
	    [/show_if]
            [/note]
        [/objectives]
    [/event]
    [event]
        name=start
	[disallow_end_turn]
        [/disallow_end_turn]
        [get_global_variable]
          namespace=hoplite
          from_global=hoplite_depth11_unlocked
          to_local=hoplite_depth11_unlocked
          side=1
        [/get_global_variable]
        [get_global_variable]
          namespace=hoplite
          from_global=hoplite_depth21_unlocked
          to_local=hoplite_depth21_unlocked
          side=1
        [/get_global_variable]
        [get_global_variable]
          namespace=hoplite
          from_global=hoplite_depth0_unlocked
          to_local=hoplite_depth0_unlocked
          side=1
        [/get_global_variable]
        [get_global_variable]
          namespace=hoplite
          from_global=hoplite_depth31_unlocked
          to_local=hoplite_depth31_unlocked
          side=1
        [/get_global_variable]
        [get_global_variable]
          namespace=hoplite
          from_global=hoplite_depth41_unlocked
          to_local=hoplite_depth41_unlocked
          side=1
        [/get_global_variable]
        [get_global_variable]
          namespace=hoplite
          from_global=hoplite_depth99_unlocked
          to_local=hoplite_depth99_unlocked
          side=1
        [/get_global_variable]
        {IF_VAR hoplite_depth11_unlocked equals yes (
            [then]
                [message]
                    speaker=narrator
#                    caption=_ "Checkpoints:"
#                    message=_"Start from depth 1, or depth 21? (choosing the second option gives you the spear of Ares, Artemis' shortsword, Hephaestus' platemail, and 10 upgrades. If you want to, you can remove this option by clearing achievements in the information menu.)"
                    message=_"Choose where to start the game from:"
#ifdef MULTIPLAYER
                                for_side=1
#endif
                    [option]
                        image="scenery/dwarven-doors-closed.png"
                        description=_"Depth 1 (no upgrades)"
                        [command]
                        [/command]
                    [/option]
                    [option]
                        image="scenery/trapdoor-open.png"
                        description=_"Depth 11 (5 upgrades)"
			[show_if]
			[variable]
			  name=hoplite_depth11_unlocked
			  equals=yes
			[/variable]
			[/show_if]
                        [command]
                            {VARIABLE hoplite_debugmenu yes}
                            {VARIABLE spiderqueen_beaten yes}
                            {VARIABLE dungeon_seen yes}
                            {VARIABLE waterdepth_seen yes}
                            {VARIABLE spiderqueen_seen yes}
                      	    {VARIABLE forge_delay 0}#to prevent a forge appearing on the first depth		    

                            [if]
                                [have_unit]
                                    id=Hoplite2
                                [/have_unit]
                                [then]
                                    {VARIABLE hoplite_upgradesleft1 5}
                                    {VARIABLE hoplite_upgradesleft2 5}
                                [/then]
                                [else]
                                    {VARIABLE hoplite_upgradesleft 5}
                                [/else]
                            [/if]
                            {REPEAT 5 (
                                [fire_event]
                                    id=forge_dialog
                                [/fire_event]
                            )}
                            {CLEAR_VARIABLE hoplite_debugmenu}
                            {CLEAR_VARIABLE hoplite_upgrade}
                            {CLEAR_VARIABLE hoplite_upgradesleft}
                            {CLEAR_VARIABLE hoplite_upgradesleft1}
                            {CLEAR_VARIABLE hoplite_upgradesleft2}
                            {VARIABLE hoplite_depth 10}
                            [fire_event]
                                id=hoplite_depthdescent
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        image="scenery/trapdoor-open.png"
                        description=_"Depth 21 (10 upgrades, artifact gear, algadur)"
			[show_if]
			[variable]
			  name=hoplite_depth21_unlocked
			  equals=yes
			[/variable]
			[/show_if]
                        [command]
			{VARIABLE algadurmet yes}
			{VARIABLE algadurlinestart yes}
	{UNIT $hoplite_allyside (Hoplite_Steelclad2) 6 9 (
        id=Algadur
	name=_"Algadur"
	facing=s
	placement=map
	passable=yes
	{IS_LOYAL}
        )}
#ifdef MULTIPLAYER	    
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Algadur
		[/filter]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2
	        [/effect]
            [/object]
#endif
                            {HOPLITE_ARTIFACTS}
                            {VARIABLE hoplite_debugmenu yes}
                            {VARIABLE spiderqueen_beaten yes}
                            {VARIABLE archmage_beaten yes}
                            {VARIABLE ares_beaten yes}
                            {VARIABLE dungeon_seen yes}
                            {VARIABLE waterdepth_seen yes}
                            {VARIABLE spiderqueen_seen yes}
                            {VARIABLE archmage_seen yes}
                            {VARIABLE ares_seen yes}
                      	    {VARIABLE forge_delay 0}#to prevent a forge appearing on the first depth		    

                            [if]
                                [have_unit]
                                    id=Hoplite2
                                [/have_unit]
                                [then]
                                    {VARIABLE hoplite_upgradesleft1 10}
                                    {VARIABLE hoplite_upgradesleft2 10}
                                [/then]
                                [else]
                                    {VARIABLE hoplite_upgradesleft 10}
                                [/else]
                            [/if]
                            {REPEAT 10 (
                                [fire_event]
                                    id=forge_dialog
                                [/fire_event]
                            )}
                            {CLEAR_VARIABLE hoplite_debugmenu}
                            {CLEAR_VARIABLE hoplite_upgrade}
                            {CLEAR_VARIABLE hoplite_upgradesleft}
                            {CLEAR_VARIABLE hoplite_upgradesleft1}
                            {CLEAR_VARIABLE hoplite_upgradesleft2}
                            {VARIABLE hoplite_depth 20}
                            [fire_event]
                                id=hoplite_depthdescent
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        image="scenery/summoning-center.png~GS()~CS(150,0,180)"
                        description=_"Underworld (12 upgrades, artifact gear, algadur)"
			[show_if]
			[variable]
			  name=hoplite_depth0_unlocked
			  equals=yes
			[/variable]
			[/show_if]
                        [command]
			{VARIABLE algadurmet yes}
			{VARIABLE algadurlinestart yes}
	{UNIT $hoplite_allyside (Hoplite_Steelclad2) 6 9 (
        id=Algadur
	name=_"Algadur"
	facing=s
	placement=map
	passable=yes
	{IS_LOYAL}
        )}
#ifdef MULTIPLAYER	    
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Algadur
		[/filter]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2
	        [/effect]
            [/object]
#endif
                            {HOPLITE_ARTIFACTS}
                            {VARIABLE hoplite_debugmenu yes}
                            {VARIABLE spiderqueen_beaten yes}
                            {VARIABLE archmage_beaten yes}
                            {VARIABLE ares_beaten yes}
                            {VARIABLE dungeon_seen yes}
                            {VARIABLE waterdepth_seen yes}
                            {VARIABLE spiderqueen_seen yes}
                            {VARIABLE archmage_seen yes}
                            {VARIABLE ares_seen yes}
                      	    {VARIABLE forge_delay 0}#to prevent a forge appearing on the first depth		    

                            [if]
                                [have_unit]
                                    id=Hoplite2
                                [/have_unit]
                                [then]
                                    {VARIABLE hoplite_upgradesleft1 12}
                                    {VARIABLE hoplite_upgradesleft2 12}
                                [/then]
                                [else]
                                    {VARIABLE hoplite_upgradesleft 12}
                                [/else]
                            [/if]
                            {REPEAT 12 (
                                [fire_event]
                                    id=forge_dialog
                                [/fire_event]
                            )}
                            {CLEAR_VARIABLE hoplite_debugmenu}
                            {CLEAR_VARIABLE hoplite_upgrade}
                            {CLEAR_VARIABLE hoplite_upgradesleft}
                            {CLEAR_VARIABLE hoplite_upgradesleft1}
                            {CLEAR_VARIABLE hoplite_upgradesleft2}
           [set_variable]
             name=darkportal_entrydepth
             value=21
           [/set_variable]
           {COLOR_ADJUST 80 80 80}
           {COLOR_ADJUST 150 150 150}
	   [sound]
	     name=lightning.ogg
	   [/sound]
	  {IF_VAR portal_entrydepth less_than 0 (
          [then]
           {VARIABLE hoplite_depth $portal_entrydepth}
	  [/then]
	  [else]
	   {RANDOM -1..-7}
           {VARIABLE hoplite_depth $random}
          [/else])}
          {VARIABLE darkportal_active yes}
          {VARIABLE hoplite_stairway no}
          [sound]
             name={SOUND_LIST:LICH_HIT}
	  [/sound]
       {COLOR_ADJUST -512 -512 -512}
       [delay]
          time=2000
       [/delay]
       [set_variable]
          name=depthdescent_nofade
          value=yes
       [/set_variable]
       [fire_event]
	  id=hoplite_depthdescent
       [/fire_event]
       {CLEAR_VARIABLE depthdescent_nofade}
       {REPLACE_SCENARIO_MUSIC ooze.ogg}
#ifndef SPARTAN_MUSIC_FOUND
       {REPLACE_SCENARIO_MUSIC the_deep_path.ogg}
#endif
       {CLEAR_VARIABLE random}
     {VARIABLE hoplite_usedportal yes}
                        [/command]
                    [/option]
                    [option]
                        image="scenery/trapdoor-open.png"
                        description=_"Depth 31 (20 upgrades, artifact gear, algadur and elizabeth)"
			[show_if]
			[variable]
			  name=hoplite_depth31_unlocked
			  equals=yes
			[/variable]
			[/show_if]
                        [command]
			{VARIABLE algadurmet yes}
			{VARIABLE algadurlinestart yes}
	{UNIT $hoplite_allyside (Hoplite_Steelclad2) 6 9 (
        id=Algadur
	name=_"Algadur"
	facing=s
	placement=map
	passable=yes
	{IS_LOYAL}
        )}
#ifdef MULTIPLAYER	    
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Algadur
		[/filter]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2
	        [/effect]
            [/object]
#endif
			{VARIABLE elizabethmet yes}
            {UNIT $hoplite_allyside (Hoplite_Elizabeth) 6 9 (
            id=Elizabeth
            name=_"Elizabeth"
     	    facing=s
	    placement=map
	    passable=yes
	    {IS_LOYAL}
            )}
  	    {UNIT $hoplite_allyside (Hoplite_Fireguardian) 5 9 (
	    placement=map
     	    passable=yes
            )}
  	    {UNIT $hoplite_allyside (Hoplite_Fireguardian) 7 9 (
	    placement=map
     	    passable=yes
            )}
#ifdef MULTIPLAYER	    
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Elizabeth
		[/filter]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2#to two-shot normal enemies in MP
	        [/effect]
		[effect]
		  apply_to=attack
		  range=ranged
		  increase_damage=3#to one-shot normal enemies in MP
	        [/effect]
            [/object]
#endif
                            {HOPLITE_ARTIFACTS}
                            {VARIABLE hoplite_debugmenu yes}
                            {VARIABLE spiderqueen_beaten yes}
                            {VARIABLE archmage_beaten yes}
                            {VARIABLE ares_beaten yes}
                            {VARIABLE duo_beaten yes}
                            {VARIABLE reaper_beaten yes}
                            {VARIABLE dungeon_seen yes}
                            {VARIABLE waterdepth_seen yes}
                            {VARIABLE spiderqueen_seen yes}
                            {VARIABLE archmage_seen yes}
                            {VARIABLE ares_seen yes}
                            {VARIABLE duo_seen yes}
                            {VARIABLE reaper_seen yes}
                      	    {VARIABLE forge_delay 0}#to prevent a forge appearing on the first depth

                            [if]
                                [have_unit]
                                    id=Hoplite2
                                [/have_unit]
                                [then]
                                    {VARIABLE hoplite_upgradesleft1 20}
                                    {VARIABLE hoplite_upgradesleft2 20}
                                [/then]
                                [else]
                                    {VARIABLE hoplite_upgradesleft 20}
                                [/else]
                            [/if]
                            {REPEAT 23 (
                                [fire_event]
                                    id=forge_dialog
                                [/fire_event]
                            )}
                            {CLEAR_VARIABLE hoplite_debugmenu}
                            {CLEAR_VARIABLE hoplite_upgrade}
                            {CLEAR_VARIABLE hoplite_upgradesleft}
                            {CLEAR_VARIABLE hoplite_upgradesleft1}
                            {CLEAR_VARIABLE hoplite_upgradesleft2}
                            {VARIABLE hoplite_depth 30}
                            [fire_event]
                                id=hoplite_depthdescent
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        image="terrain/stairs-spiral.png"
                        description=_"Depth 41 (23 upgrades, artifact gear, prometheus' heart (+50 max energy), algadur and elizabeth)"
			[show_if]
			[variable]
			  name=hoplite_depth41_unlocked
			  equals=yes
			[/variable]
			[/show_if]
                        [command]
	{IF_VAR hoplite_maxenergy greater_than 0 (
	[then]
        {VARIABLE_OP hoplite_energy add 50}
        {VARIABLE_OP hoplite_maxenergy add 50}
	{SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
	[/then])}
	{IF_VAR hoplite_maxenergy1 greater_than 0 (
	[then]
        {VARIABLE_OP hoplite_energy1 add 50}
        {VARIABLE_OP hoplite_maxenergy1 add 50}
	{SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
        {VARIABLE_OP hoplite_energy2 add 50}
        {VARIABLE_OP hoplite_maxenergy2 add 50}
	{SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
	[/then])}
			{VARIABLE algadurmet yes}
			{VARIABLE algadurlinestart yes}
	{UNIT $hoplite_allyside (Hoplite_Steelclad2) 6 9 (
        id=Algadur
	name=_"Algadur"
	facing=s
	placement=map
	passable=yes
	{IS_LOYAL}
        )}
#ifdef MULTIPLAYER	    
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Algadur
		[/filter]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2
	        [/effect]
            [/object]
#endif
			{VARIABLE elizabethmet yes}
            {UNIT $hoplite_allyside (Hoplite_Elizabeth) 6 9 (
            id=Elizabeth
            name=_"Elizabeth"
     	    facing=s
	    placement=map
	    passable=yes
	    {IS_LOYAL}
            )}
  	    {UNIT $hoplite_allyside (Hoplite_Fireguardian) 5 9 (
	    placement=map
     	    passable=yes
            )}
  	    {UNIT $hoplite_allyside (Hoplite_Fireguardian) 7 9 (
	    placement=map
     	    passable=yes
            )}
#ifdef MULTIPLAYER	    
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Elizabeth
		[/filter]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2#to two-shot normal enemies in MP
	        [/effect]
		[effect]
		  apply_to=attack
		  range=ranged
		  increase_damage=3#to one-shot normal enemies in MP
	        [/effect]
            [/object]
#endif
                            {HOPLITE_ARTIFACTS}
                            {VARIABLE hoplite_debugmenu yes}
                            {VARIABLE spiderqueen_beaten yes}
                            {VARIABLE archmage_beaten yes}
                            {VARIABLE ares_beaten yes}
                            {VARIABLE duo_beaten yes}
                            {VARIABLE reaper_beaten yes}
                            {VARIABLE archmage2_beaten yes}
                            {VARIABLE dungeon_seen yes}
                            {VARIABLE waterdepth_seen yes}
                            {VARIABLE spiderqueen_seen yes}
                            {VARIABLE archmage_seen yes}
                            {VARIABLE ares_seen yes}
                            {VARIABLE duo_seen yes}
                            {VARIABLE reaper_seen yes}
                      	    {VARIABLE forge_delay 0}#to prevent a forge appearing on the first depth		    

                            [if]
                                [have_unit]
                                    id=Hoplite2
                                [/have_unit]
                                [then]
                                    {VARIABLE hoplite_upgradesleft1 23}
                                    {VARIABLE hoplite_upgradesleft2 23}
                                [/then]
                                [else]
                                    {VARIABLE hoplite_upgradesleft 23}
                                [/else]
                            [/if]
                            {REPEAT 23 (
                                [fire_event]
                                    id=forge_dialog
                                [/fire_event]
                            )}
                            {CLEAR_VARIABLE hoplite_debugmenu}
                            {CLEAR_VARIABLE hoplite_upgrade}
                            {CLEAR_VARIABLE hoplite_upgradesleft}
                            {CLEAR_VARIABLE hoplite_upgradesleft1}
                            {CLEAR_VARIABLE hoplite_upgradesleft2}
                            {VARIABLE hoplite_depth 40}
                            [fire_event]
                                id=hoplite_depthdescent
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        image="units/human-magi/elder-mage-ranged3.png~RC(magenta>red)"
                        description=_"Sandbox mode (choose the starting depth/upgrades, debug menu is available, but achievements can't be completed in this mode. The companions can be spawned with the spartan debug menu)"
			[show_if]
			[variable]
			  name=hoplite_depth99_unlocked
			  equals=yes
			[/variable]
			[/show_if]
                        [command]
                        [message]
                            speaker=narrator
                            message=_"Which depth to start at?"
            
                           [text_input]
                              variable=depth
                           [/text_input]
                        [/message]
                        [message]
                            speaker=narrator
                            message=_"How many upgrades to start with?"
            
                           [text_input]
                              variable=hoplite_startupgrades
                           [/text_input]
                        [/message]
                            {VARIABLE hoplite_debug yes}
                            {VARIABLE hoplite_noachieve yes}
                            {VARIABLE hoplite_debugmenu yes}
			    {IF_VAR depth greater_than 10 (
			    [or]
			    {VARIABLE_CONDITIONAL depth less_than 0}
			    [/or]
 			    [then]
                            {VARIABLE spiderqueen_beaten yes}
      	 		    [/then])}
			    {IF_VAR depth greater_than 15 (
			    [or]
			    {VARIABLE_CONDITIONAL depth less_than 0}
			    [/or]
 			    [then]
                            {VARIABLE archmage_beaten yes}
      	 		    [/then])}
			    {IF_VAR depth greater_than 20 (
			    [or]
			    {VARIABLE_CONDITIONAL depth less_than 0}
			    [/or]
 			    [then]
                            {HOPLITE_ARTIFACTS}
                            {VARIABLE ares_beaten yes}
      	 		    [/then])}
			    {IF_VAR depth greater_than 25 (
			    [or]
			    {VARIABLE_CONDITIONAL depth less_than 0}
			    [/or]
 			    [then]
                            {VARIABLE donovan_beaten yes}
      	 		    [/then])}

                {IF_VAR depth greater_than 30 (
                [or]
                {VARIABLE_CONDITIONAL depth less_than 0}
                [/or]
                [then]
                            {VARIABLE duo_beaten yes}
                    [/then])}

                {IF_VAR depth greater_than 35 (
                [or]
                {VARIABLE_CONDITIONAL depth less_than 0}
                [/or]
                [then]
                            {VARIABLE archmage2_beaten yes}
                    [/then])}

                            {VARIABLE dungeon_seen yes}
                            {VARIABLE waterdepth_seen yes}
                            {VARIABLE spiderqueen_seen yes}
                            {VARIABLE archmage_seen yes}
                            {VARIABLE ares_seen yes}

                            {IF_VAR depth greater_than 40 (
			    [then]
	{IF_VAR hoplite_maxenergy greater_than 0 (
	[then]
        {VARIABLE_OP hoplite_energy add 50}
        {VARIABLE_OP hoplite_maxenergy add 50}
	{SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
	[/then])}
	{IF_VAR hoplite_maxenergy1 greater_than 0 (
	[then]
        {VARIABLE_OP hoplite_energy1 add 50}
        {VARIABLE_OP hoplite_maxenergy1 add 50}
	{SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
        {VARIABLE_OP hoplite_energy2 add 50}
        {VARIABLE_OP hoplite_maxenergy2 add 50}
	{SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
	[/then])}
			    [/then])}
                        
                            {IF_VAR hoplite_startupgrades greater_than 0 (
			    [then]
                            [if]
                                [have_unit]
                                    id=Hoplite2
                                [/have_unit]
                                [then]
                                    {VARIABLE hoplite_upgradesleft1 $hoplite_startupgrades}
                                    {VARIABLE hoplite_upgradesleft2 $hoplite_startupgrades}
                                [/then]
                                [else]
                                    {VARIABLE hoplite_upgradesleft $hoplite_startupgrades}
                                [/else]
                            [/if]
                            {REPEAT $hoplite_startupgrades (
                                [fire_event]
                                    id=forge_dialog
                                [/fire_event]
                            )}
			    [/then])}
                            {CLEAR_VARIABLE hoplite_debugmenu}
			    {CLEAR_VARIABLE hoplite_startupgrades}
                            {CLEAR_VARIABLE hoplite_upgrade}
                            {CLEAR_VARIABLE hoplite_upgradesleft}
                            {CLEAR_VARIABLE hoplite_upgradesleft1}
                            {CLEAR_VARIABLE hoplite_upgradesleft2}
			    {IF_VAR depth not_equals 1 (
			    [then]
                            {VARIABLE hoplite_depth $depth}
			    {IF_VAR depth less_than 0 (
			    [then]
                            {VARIABLE_OP hoplite_depth add 1}
			    [/then]
			    [else]
                            {VARIABLE_OP hoplite_depth sub 1}
			    [/else])}
                            [fire_event]
                                id=hoplite_depthdescent
                            [/fire_event]
			    {IF_VAR hoplite_depth less_than 0 (
			    [then]
                            {REPLACE_SCENARIO_MUSIC ooze.ogg}
#ifndef SPARTAN_MUSIC_FOUND
                            {REPLACE_SCENARIO_MUSIC the_deep_path.ogg}
#endif
			    [/then])}
			    [/then])}
                            {CLEAR_VARIABLE depth}
                        [/command]
                    [/option]
                [/message]
            [/then]
        )}
	{IF_VAR hoplite_debug equals yes (
	[then]
        [modify_side]
          side=$hoplite_allyside
          controller=ai
          hidden=no
        [/modify_side]
	[/then])}
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=$hoplite_playerside
            [not]
                [filter_wml]
                    attacks_left=1
                [/filter_wml]
                [filter_adjacent]
                    side=$hoplite_enemyside
                [/filter_adjacent]
            [/not]
        [/filter]
        [if]
            [have_unit]
                side=$hoplite_enemyside
            [/have_unit]
            [then]
                [end_turn]
                [/end_turn]
            [/then]
            [else]
                {MODIFY_UNIT id=$unit.id moves 1}
                [set_variable]
                    name=hoplite_wizardbeam_cooldown
                    sub=1
                [/set_variable]
                #to prevent spam-leaping after enemies are dead:
                [fire_event]
                    id=hoplite_varcheck
                [/fire_event]
            [/else]
        [/if]
    [/event]
    [event]
        name=attack end
        first_time_only=no
        [filter]
            side=$hoplite_playerside
        [/filter]
        [filter_attack]
            [not]
                special=hoplite_hitandrun
            [/not]
        [/filter_attack]
        [end_turn]
        [/end_turn]
    [/event]
    #to prevent units from receiving rest healing:
    [event]
        name=moveto
        id=forge
        first_time_only=no
        [filter]
            side=$hoplite_playerside
        [/filter]
        [if]
            [have_unit]
                id=$unit.id
                x,y=$forge_x,$forge_y
            [/have_unit]
            [then]
                [fire_event]
                    id=forge_dialog
                [/fire_event]
            [/then]
            [elseif]
                [have_unit]
                    id=$unit.id
                    x,y=$circle_x,$circle_y
                [/have_unit]
                [and]
                    [variable]
                        name=bossfight
                        not_equals=yes
                    [/variable]
                [/and]
                [then]
                    {HOPLITE_PORTALMENU}
                [/then]
            [/elseif]
            [elseif]
                [have_unit]
                    id=$unit.id
                    x,y=$darkcircle_x,$darkcircle_y
                [/have_unit]
                [and]
                    [variable]
                        name=bossfight
                        not_equals=yes
                    [/variable]
                [/and]
                [then]
                    {HOPLITE_DARKPORTALMENU}
                [/then]
            [/elseif]
            [elseif]
                [have_unit]
                    id=$unit.id
                    x,y=$textitem.x,$textitem.y
                [/have_unit]
                [then]
		[message]
		  speaker=narrator
		  caption=$textitem.caption
		  image=$textitem.image
		  message=$textitem.message
		[/message]
                {VARIABLE textitem_seen yes}
                [/then]
            [/elseif]
        [/if]
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=$hoplite_playerside
            x,y=6,2
        [/filter]
        {IF_VAR bossfight not_equals yes (
            [and]
                [variable]
                    name=hoplite_stairway
                    not_equals=yes
                [/variable]
            [/and]
            [and]
                [variable]
                    name=hoplite_depth
                    less_than=40
                [/variable]
            [/and]
            [then]
                [fire_event]
                    id=hoplite_depthdescent
                [/fire_event]
            [/then]
        )}
        {IF_VAR hoplite_depth greater_than 99 (
            [then]
                [sound]
                    name=fanfare-short.wav
                [/sound]
                [message]
                    speaker=narrator
                    caption=_ "Victory"
                    message=_"You have retreived the artifacts, and slain the mighty beings inhabiting the dungeon. You can put the campaign down, or return to complete the achievements (which remain complete even if you restart the campaign) and get father than you previously have."
                    image=wesnoth-icon.png
                [/message]
                {ACHIEVEMENT_MESSAGE _"Victory: leave the dungeon via the stairs after obtaining the Prometheus' heart" victory}
                [delay]
                    time=1000
                [/delay]
                [endlevel]
                    result=victory
                    linger_mode=no
                    carryover_report=no
                [/endlevel]
            [/then]
        )}
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=$hoplite_playerside
            x,y=7,2
        [/filter]
        {IF_VAR bossfight not_equals yes (
            [and]
#                [variable]
#                    name=hoplite_stairway
#                    equals=yes
#                [/variable]
                [variable]
                    name=hoplite_depth
                    greater_than_equal_to=40
                [/variable]
            [/and]
            [and]
                [variable]
                    name=hoplite_depth
                    less_than=100
                [/variable]
            [/and]
            [then]
                [fire_event]
                    id=hoplite_depthdescent
                [/fire_event]
            [/then]
        )}
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=$hoplite_playerside
            x,y=5,2
        [/filter]
        {IF_VAR bossfight not_equals yes (
            [and]
                [variable]
                    name=hoplite_depth
                    greater_than_equal_to=40
                [/variable]
#                [variable]
#                    name=hoplite_stairway
#                    equals=yes
#                [/variable]
            [/and]
            [and]
                [variable]
                    name=hoplite_depth
                    less_than=100
                [/variable]
            [/and]
            [then]
                [sound]
                    name=fanfare-short.wav
                [/sound]
                [message]
                    speaker=narrator
                    caption=_ "Victory"
                    message=_"You have retreived the artifacts, and slain the mighty beings inhabiting the dungeon. You can put the campaign down, or return to complete the achievements (which remain complete even if you restart the campaign) and get father than you previously have."
                    image=wesnoth-icon.png
                [/message]
                {ACHIEVEMENT_MESSAGE _"Victory: leave the dungeon via the stairs after obtaining the Prometheus' heart" victory}
                [delay]
                    time=1000
                [/delay]
                [endlevel]
                    result=victory
                    linger_mode=no
                    carryover_report=no
                [/endlevel]
            [/then]
        )}
    [/event]

    [event]
        name=start
        [set_menu_item]
            id=hoplite_controlai
            description= _ "Order nearby allies to to move here"
            [show_if]
                [have_unit]
                    side=$hoplite_allyside
                    [filter_location]
                        x,y=$x1,$y1
                        radius=2
                    [/filter_location]
                [/have_unit]
                [and]
                    [not]
                        [have_unit]
                            x,y=$x1,$y1
                        [/have_unit]
                    [/not]
                [/and]
            [/show_if]
            [command]
                [modify_unit]
                    [filter]
                        side=$hoplite_allyside
                        [filter_location]
                            x,y=$x1,$y1
                            radius=2
                        [/filter_location]
                    [/filter]
                    goto_x,goto_y=$x1,$y1
                [/modify_unit]
            [/command]
        [/set_menu_item]
        [set_menu_item]
            id=hoplite_pushally
            description= _ "Push this ally."
            [show_if]
                [have_unit]
                    side=$hoplite_allyside
                    x,y=$x1,$y1
                    [filter_location]
                        [filter]
                            id=Hoplite,Hoplite2
                        [/filter]
                        radius=1
                    [/filter_location]
                [/have_unit]
                [or]
                    [have_unit]
                        id=Hoplite2
                        x,y=$x1,$y1
                        [filter_location]
                            [filter]
                                id=Hoplite
                                side=$side_number
                            [/filter]
                            radius=1
                        [/filter_location]
                    [/have_unit]
                [/or]
                [or]
                    [have_unit]
                        id=Hoplite
                        x,y=$x1,$y1
                        [filter_location]
                            [filter]
                                id=Hoplite2
                                side=$side_number
                            [/filter]
                            radius=1
                        [/filter_location]
                    [/have_unit]
                [/or]
            [/show_if]
            [command]
                [animate_unit]
                    flag=standing
                    [facing]
                        [filter]
                            x,y=$x1,$y1
                        [/filter]
                    [/facing]
                    [filter]
                        id=Hoplite,Hoplite2
                        side=$side_number
                    [/filter]
                [/animate_unit]
                [store_unit]
                    [filter]
                        id=Hoplite,Hoplite2
                        side=$side_number
                    [/filter]
                    variable=hoplitefacing
                    kill=no
                [/store_unit]
                [store_locations]
                    [not]
                        [filter]
                        [/filter]
                    [/not]

                    [filter_adjacent_location]
                        x,y=$x1,$y1
                        adjacent=-$hoplitefacing.facing
                    [/filter_adjacent_location]

                    variable=knockback_target_hex
                [/store_locations]

                [if]
                    [variable]
                        name=knockback_target_hex.length
                        greater_than=0
                    [/variable]
                    [and]
                        [have_location]
                            x,y=$knockback_target_hex.x,$knockback_target_hex.y
                            terrain=!,Xo*,Xu,Qlf,W**
                        [/have_location]
                    [/and]

                    [then]
                        [sound]
                            name=mace.wav
                        [/sound]
                        {MOVE_UNIT x,y=$x1,$y1 $knockback_target_hex.x $knockback_target_hex.y}
                    [/then]
                    [else]
                        [print]
                            text= _ "Ally can't be pushed in that direction!"
                            size=20
                            red=255
                            duration=2000
                        [/print]
                    [/else]
                [/if]
                {CLEAR_VARIABLE knockback_direction,knockback_target_hex,hoplitefacing}
            [/command]
        [/set_menu_item]
        [set_menu_item]
            id=hoplite_recallelizabeth
            description= _ "Teleport Elizabeth to your position."
            [show_if]
                [have_unit]
                    id=Elizabeth
                    x,y=$x1,$y1
                [/have_unit]
            [/show_if]
            [command]
                [store_unit]
                    [filter]
                        id=Hoplite,Hoplite2
                        side=$side_number
                    [/filter]
                    variable=current_hopliteloc
                    kill=no
                [/store_unit]
	[animate_unit]
		flag=pre_teleport
		[filter]
		         id=Elizabeth
		[/filter]
	[/animate_unit]
	      {TELEPORT_UNIT id=Elizabeth $current_hopliteloc.x $current_hopliteloc.y}
	[animate_unit]
		flag=post_teleport
		[filter]
		         id=Elizabeth
		[/filter]
	[/animate_unit]
	      {CLEAR_VARIABLE current_hopliteloc}
            [/command]
        [/set_menu_item]
    [set_menu_item]
        id=hoplite_enthrall
        description=_"Enthrall this enemy (costs 50 energy per enemy level)"
        [show_if]
            [have_unit]
	        side=$hoplite_enemyside
#		level=0,1,2
                x,y=$x1,$y1
                [not]
                    ability=hoplite_boss
                [/not]
                [filter_location]
                    [filter]
                        id=Hoplite,Hoplite2
                        side=$side_number
                    [/filter]
		    radius=1
                [/filter_location]
            [/have_unit]
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    [variable]
                        name=enthrall_unlocked1
                        equals=yes
                    [/variable]
		[and]
                [have_unit]
		id=Hoplite
                [filter_adjacent]
		  x,y=$x1,$y1
                [/filter_adjacent]
                [/have_unit]
		[/and]
                    [and]
                        [variable]
                            name=hoplite_enthrall_cooldown1
                            less_than=1
                        [/variable]
                    [/and]
                ) (
                    [variable]
                        name=enthrall_unlocked2
                        equals=yes
                    [/variable]
		[and]
                [have_unit]
		id=Hoplite2
                [filter_adjacent]
		  x,y=$x1,$y1
                [/filter_adjacent]
                [/have_unit]
		[/and]
                    [and]
                        [variable]
                            name=hoplite_enthrall_cooldown2
                            less_than=1
                        [/variable]
                    [/and]
                )}
                [or]
                    [variable]
                        name=enthrall_unlocked
                        equals=yes
                    [/variable]
                    [and]
                        [variable]
                            name=hoplite_enthrall_cooldown
                            less_than=1
                        [/variable]
                    [/and]
                [/or]
            [/and]
        [/show_if]
        [command]
	[store_unit]
	 [filter]
	   x,y=$x1,$y1
	 [/filter]
	 variable=enthrallenemy
	 kill=no
	[/store_unit]
	[if]
	[have_unit]
	  x,y=$x1,$y1
	  ability=hoplite_ranged
	  [or]
	  x,y=$x1,$y1
	  ability=hoplite_semiranged
	  [/or]
	[/have_unit]
	[then]
        [print]
           text= _ "Can't enthrall enemies with ranged attacks!"
           size=22
           red=255
	   duration=2000
        [/print]
	[/then]
	[elseif]
	[have_unit]
	  x,y=$x1,$y1
	  ability=summonerfilter
	[/have_unit]
	[then]
        [print]
           text= _ "Can't enthrall summoners!"
           size=22
           red=255
	   duration=2000
        [/print]
	[/then]
	[/elseif]
#    [elseif]
#    [have_unit]
#      x,y=$x1,$y1
#      ability=hoplite_boss
#    [/have_unit]
#    [then]
#        [print]
#           text= _ "Can't enthrall bosses!"
#           size=22
#           red=255
#       duration=100
#        [/print]
#    [/then]
#    [/elseif]
	[else]
	{VARIABLE enthrallenergy $enthrallenemy.level}
	{VARIABLE_OP enthrallenergy multiply 50}
        {IF_VAR enthrallenergy less_than 25 (
        [then]
	{VARIABLE enthrallenergy 25}
        [/then])}
            [if]
#ifdef MULTIPLAYER
                [have_unit]
                    id=Hoplite
                    side=$side_number
                [/have_unit]
                [and]
                    [variable]
                        name=hoplite_energy1
                        greater_than_equal_to=$enthrallenergy
                    [/variable]
                [/and]
                [or]
                    [have_unit]
                        id=Hoplite2
                        side=$side_number
                    [/have_unit]
                    [and]
                        [variable]
                            name=hoplite_energy2
                            greater_than_equal_to=$enthrallenergy
                        [/variable]
                    [/and]
                [/or]
#endif
#ifndef MULTIPLAYER
                    [variable]
                        name=hoplite_energy
                        greater_than_equal_to=$enthrallenergy
                    [/variable]
#endif
        [then]
#ifdef MULTIPLAYER
                    [if]
                        [have_unit]
                            id=Hoplite
                            side=$side_number
                        [/have_unit]
                        [then]
                            {VARIABLE_OP hoplite_energy1 sub $enthrallenergy}
                            {SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
                        [/then]
                        [else]
                            {VARIABLE_OP hoplite_energy2 sub $enthrallenergy}
                            {SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
                        [/else]
                    [/if]
#endif
#ifndef MULTIPLAYER
        {VARIABLE_OP hoplite_energy sub $enthrallenergy}
        {SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
#endif
	[sound]
	  name=magic-dark-big.ogg
	[/sound]
	[modify_unit]
	  [filter]
	     x,y=$x1,$y1
	  [/filter]
	  side=$hoplite_allyside
	[/modify_unit]
    [object]
		silent=yes
		duration=forever
		[filter]
		  x,y=$x1,$y1
		[/filter]
		[effect]
		  apply_to=halo
		  halo="halo/elven/shyde-stationary-halo[1~6].png:150"
	    [/effect]
        [effect]
          apply_to=new_ability
          [abilities]
            [dummy]
                id=hoplite_thrall#for filtering
            [/dummy]
          [/abilities]
        [/effect]
    [/object]

            [if]
                [have_unit]
                    id=Hoplite2
                [/have_unit]
                [then]
                {HOPLITE_PLAYERFILTER (
		{IF_VAR enthrallII_unlocked1 equals yes (
		[then]
            {VARIABLE tmp_enthrallII_buff yes}
		[/then])}
		) (
		{IF_VAR enthrallII_unlocked2 equals yes (
		[then]
            {VARIABLE tmp_enthrallII_buff yes}
		[/then])}
		)}
		[/then]
		[else]
		{IF_VAR enthrallII_unlocked equals yes (
		[then]
            {VARIABLE tmp_enthrallII_buff yes}
		[/then])}
		[/else]
            [/if]
    {IF_VAR tmp_enthrallII_buff equals yes (
    [then]
        [object]
        silent=yes
        duration=forever
        [filter]
          x,y=$x1,$y1
        [/filter]
        [effect]
          apply_to=hitpoints
          increase_total=5
            [/effect]
        [effect]
            apply_to=attack
            increase_damage=2
        [/effect]
        [effect]
          apply_to=new_ability
          [abilities]
                  [regenerate]
                     value=2
                     id=hoplite_regenerates2
                     name= _ "regenerates +2"
                     female_name= _ "female^regenerates +2"
                     description= _ "The unit will heal itself 2 HP per turn."
                     affect_self=yes
                     poison=slowed
                  [/regenerate]
          [/abilities]
        [/effect]
        [/object]
    [/then]
    )}
    {CLEAR_VARIABLE tmp_enthrallII_buff}
	[heal_unit]
	  [filter]
	     x,y=$x1,$y1
	  [/filter]
	  amount=full
	  animate=no
	[/heal_unit]
        [modify_side]
          side=$hoplite_allyside
          controller=ai
          hidden=no
        [/modify_side]
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                            {HOPLITE_PLAYERFILTER (
                                {VARIABLE hoplite_enthrall_cooldown1 3}
                            ) (
                                {VARIABLE hoplite_enthrall_cooldown2 3}
                            )}
                        [/then]
                        [else]
                            {VARIABLE hoplite_enthrall_cooldown 3}
                        [/else]
                    [/if]
        [end_turn]
        [/end_turn]
	[/then]
	[else]
        [print]
           text= _ "Not enough energy!"
           size=22
           red=255
	   duration=100
        [/print]
	[/else]
	[/if]
	[/else]
	[/if]
	{CLEAR_VARIABLE enthrallenemy}
	{CLEAR_VARIABLE enthrallenergy}
	[/command]
        [/set_menu_item]
    [set_menu_item]
        id=hoplite_loyal_thrall
        description=_"Turn this thrall into a loyal thrall (you can only have one loyal thrall at a time)"
        [show_if]
            [have_unit]
            side=$hoplite_allyside
            ability=hoplite_thrall
            x,y=$x1,$y1
            [/have_unit]
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    [variable]
                        name=enthrallIIb_unlocked1
                        equals=yes
                    [/variable]
        [and]
                [have_unit]
        id=Hoplite
                [filter_adjacent]
          x,y=$x1,$y1
                [/filter_adjacent]
                [/have_unit]
        [/and]
                ) (
                    [variable]
                        name=enthrallIIb_unlocked2
                        equals=yes
                    [/variable]
        [and]
                [have_unit]
        id=Hoplite2
                [filter_adjacent]
          x,y=$x1,$y1
                [/filter_adjacent]
                [/have_unit]
        [/and]
                )}
                [or]
                    [variable]
                        name=enthrallIIb_unlocked
                        equals=yes
                    [/variable]
                [/or]
            [/and]
        [/show_if]
        [command]

        [object]
            silent=yes
            duration=forever
            [filter]
                ability=hoplite_loyalthrall$side_number
            [/filter]
            [effect]
                apply_to=remove_ability
                [abilities]
                    [dummy]
                        id=hoplite_loyalthrall$side_number
                    [/dummy]
                [/abilities]
            [/effect]
        [/object]

        [object]
            silent=yes
            duration=forever
            [filter]
                ability=hoplite_loyalthrall$side_number
            [/filter]
            [effect]
                apply_to=remove_ability
                [abilities]
                    [dummy]
                        id=hoplite_loyalthrall$side_number
                    [/dummy]
                [/abilities]
            [/effect]
        [/object]

        [/command]
    [/set_menu_item]

#ifdef MULTIPLAYER	
        [set_menu_item]
            id=hoplite_pushally
            description= _ "Swap places with your teammate."
            [show_if]
                [have_unit]
		    id=Hoplite,Hoplite2
                    x,y=$x1,$y1
	            side=$side_number
                    [filter_location]
                        [filter]
                            id=Hoplite,Hoplite2
			    [not]
			      side=$side_number
			    [/not]
                        [/filter]
                        radius=1
                    [/filter_location]
                [/have_unit]
		[or]
                [have_unit]
		    id=Hoplite,Hoplite2
                    x,y=$x1,$y1
		    [not]
	            side=$side_number
		    [/not]
                    [filter_location]
                        [filter]
                            id=Hoplite,Hoplite2
			    side=$side_number
                        [/filter]
                        radius=1
                    [/filter_location]
                [/have_unit]
		[/or]
            [/show_if]
            [command]
                [animate_unit]
                  flag=standing
                  [filter]
                        id=Hoplite,Hoplite2
                        side=$side_number
                  [/filter]
                  [facing]
		    [filter]
                        id=Hoplite,Hoplite2
			[not]
                        side=$side_number
			[/not]
	            [/filter]
                  [/facing]
                [/animate_unit]
		[hide_unit]
                   id=Hoplite,Hoplite2
	    	   [not]
                     side=$side_number
	 	   [/not]		   
		[/hide_unit]
		[if]
		 [have_unit]
		   id=Hoplite2
		   side=$side_number
		 [/have_unit]
		 [then]
                 [animate_unit]
                   flag=hopliteswap_b
                   [filter]
                        id=Hoplite2
                        side=$side_number
                   [/filter]
                 [/animate_unit]
		 [/then]
		 [else]
                 [animate_unit]
                   flag=hopliteswap
                   [filter]
                        id=Hoplite
                        side=$side_number
                   [/filter]
                 [/animate_unit]
		 [/else]
		 [/if]
                [store_unit]
                    [filter]
                        id=Hoplite,Hoplite2
                        side=$side_number
                    [/filter]
                    variable=hoplite_a
                    kill=yes
                [/store_unit]
                [store_unit]
                    [filter]
                        id=Hoplite,Hoplite2
			[not]
                         side=$side_number
			[/not]
                    [/filter]
                    variable=hoplite_b
                    kill=yes
                [/store_unit]
                [lock_view]
                [/lock_view]
		{VARIABLE hoplite_a2_x $hoplite_a.x}
		{VARIABLE hoplite_a2_y $hoplite_a.y}
		{VARIABLE hoplite_a.x $hoplite_b.x}
		{VARIABLE hoplite_a.y $hoplite_b.y}
		{VARIABLE hoplite_b.x $hoplite_a2_x}
		{VARIABLE hoplite_b.y $hoplite_a2_y}

                [unlock_view]
                [/unlock_view]
		[unstore_unit]
		    variable=hoplite_a
		[/unstore_unit]
		[unstore_unit]
		    variable=hoplite_b
		[/unstore_unit]
		[unhide_unit]
                   id=Hoplite,Hoplite2
	    	   [not]
                     side=$side_number
	 	   [/not]		   
		[/unhide_unit]
		[sound]
		    name={SOUND_LIST:MISS}
		[/sound]
                {CLEAR_VARIABLE hoplite_a}
                {CLEAR_VARIABLE hoplite_b}
                {CLEAR_VARIABLE hoplite_a2_x}
                {CLEAR_VARIABLE hoplite_a2_y}
            [/command]
        [/set_menu_item]
#endif	
    [/event]
    [event]
        name=die
        first_time_only=no
        [filter]
            side=$hoplite_playerside
            canrecruit=yes
        [/filter]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    {HOPLITE_INFO_MENU}
    #secret hoplite debug menu (since set_var for each depth is a bit too tedious. the menu is accessed by debug with set_var):
    {HOPLITE_DEBUG_MENU}
    {HOPLITE_ACHIEVEMENT_EVENTS}
