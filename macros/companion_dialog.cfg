#textdomain wesnoth-Hoplite

#define SPARTAN_COMPANION_DIALOG_EVENTS
    [event]
        id=hoplite_depthdescent_dialog
        first_time_only=no
        {IF_VAR hoplite_tutorial equals yes (
            [then]
                [fire_event]
                    id=spartan_tutorial_depthdescent_events
                [/fire_event]
            [/then]
        )}

        {IF_VAR algadur_line_underworld not_equals yes (
            [and]
                {VARIABLE_CONDITIONAL hoplite_depth less_than 0 }
            [/and]
            [and]
                [have_unit]
                    id=Algadur
                [/have_unit]
            [/and]
            [then]
                [message]
                    speaker=Algadur
                    message=_"By the blazes, my beard be damned! Just where in the bloody hell are we?!"
                [/message]
                [delay]
                    time=1000
                [/delay]
                [message]
                    speaker=Algadur
                    message=_"(shaking) D... did ye hear that?... Aaaa! Ghosts! I be damned! I knew 'tis would go horribly, I knew it!... Looks like we have no bloody choice but ta chop whatever shadow moves until we get some bloody answers! If we die here, we shall at least show 'em all we 'ave!"
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    message=_"Very well, time to fight our way out of here!"
                [/message]
                {VARIABLE algadur_line_underworld yes}
            [/then]
        )}

        [if]
            #    {VARIABLE_CONDITIONAL archmagemet not_equals yes}
            #	[and]
            [have_unit]
                id=Spiderqueen
            [/have_unit]
            #	[/and]
            [then]
                {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 1000 0}
                #    [message]
                #        speaker=Spiderqueen
                #        message=_"Hiss... who do we have here? Another deliciousss mortal entersss my lair. More curiously, one from the same world as I."
                #    [/message]

                #counts the kills from both hoplites

                {VARIABLE tmp_spartan_totalkills_dialog 0}
                {VARIABLE_OP tmp_spartan_totalkills_dialog add $totalkills_progress1}
                {VARIABLE_OP tmp_spartan_totalkills_dialog add $totalkills_progress2}

                [message]
                    speaker=Orc_messenger
                    message=_"<i>*panting*</i> Commander Arachne, we have a big problem!"
                [/message]

                [if]
                    {VARIABLE_CONDITIONAL tmp_spartan_totalkills_dialog greater_than_equal_to 12}
                    [then]
                        [message]
                            speaker=Orc_messenger
#ifdef MULTIPLAYER
                            message=_"<i>*panting*</i> These two killed at least a dozen of our soldiers, all by themselves!"
#else
                            message=_"<i>*panting*</i> This man killed at least a dozen of our soldiers, all by himself!"
#endif
                        [/message]
                        [message]
                            speaker=Spiderqueen
                            message=_"This human isn't some ordinary Wesnothian peasant like you're used to. Can't say I am surprised he got this far. Her Majesty Galatea didn't give me enough troops to guard the damn entrance, and now I'm stuck with bottom of the barrel incompetent trash like you!"
                        [/message]
                    [/then]
                    [elseif]
                        {VARIABLE_CONDITIONAL tmp_spartan_totalkills_dialog equals 0}
                        [then]
                            [message]
                                speaker=Orc_messenger
#ifdef MULTIPLAYER
                                message=_"<i>*panting*</i> These two got past our defenses, all by themselves!"
#else
                                message=_"<i>*panting*</i> This man got past our defenses, all by himself!"
#endif
                            [/message]
                            [message]
                                speaker=Spiderqueen
                                message=_"How many troops did we lose?"
                            [/message]
                            [message]
                                speaker=Orc_messenger
                                message=_"I don't think they actually killed any of our soldiers yet, just ran past em like it's no big deal..."
                            [/message]
                            [message]
                                speaker=Spiderqueen
                                message=_"Wait, you are telling me that the enemy DID NOT EVEN NEED TO KILL OUR TROOPS TO GET PAST?! WHAT KIND OF USELESS IMBECILES AM I STUCK HERE WITH?!"
                            [/message]
                        [/then]
                    [/elseif]
                    [else]
                        [message]
                            speaker=Orc_messenger
#ifdef MULTIPLAYER
                            message=_"<i>*panting*</i> These two killed $tmp_spartan_totalkills_dialog| of our soldiers, all by themselves!"
#else
                            message=_"<i>*panting*</i> This man killed $tmp_spartan_totalkills_dialog| of our soldiers, all by himself!"
#endif
                        [/message]
                        [message]
                            speaker=Spiderqueen
                            message=_"This human isn't some ordinary Wesnothian peasant like you're used to. Can't say I am surprised he got this far. Her Majesty Galatea didn't give me enough troops to guard the damn entrance, and now I'm stuck with bottom of the barrel incompetent trash like you!"
                        [/message]
                    [/else]
                [/if]

                [delay]
                    time=500
                [/delay]

                [message]
                    speaker=Spiderqueen
                    message=_"(looks at $protagonist_name1|) Hiss... Well, well, who do we have here? So the deliciousss yet troublesome mortal entersss my lair. More curiously, one from the same world as I. So you managed to get past my worthless underlings, but don't think that I can be defeated as easily!" #wmllint: no spellcheck
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    message=_"Stand aside, Arachne, and in the name of Athena I swear that I won't harm you if you do! I am here only to stop Galatea's plans."
                [/message]
                [message]
                    speaker=Spiderqueen
                    message=_"Athena? ATHENA?! <b>ATHEEEEENA?!!!</b> Don't you dare mention that despicable, worthless, vile, pathetic excuse of a goddess in front of me! <b>I WILL RIP YOUR GUTS OUT AND FEED THEM TO MY SPIDERLINGS!!!</b>" #wmllint: no spellcheck
                [/message]
                {SPARTAN_SMOOTH_REPLACE_MUSIC march-of-the-droids.ogg 1000 0}
            [/then]
        [/if]

        [if]
            #    {VARIABLE_CONDITIONAL archmagemet not_equals yes}
            #	[and]
            [have_unit]
                id=Ares
            [/have_unit]
            #	[/and]
            [then]
                {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 1000 0}
                [message]
                    speaker=Ares
#ifdef MULTIPLAYER
                    message=_"So you've arrived, $protagonist_name1| and $protagonist_name2|, warriors of Sparta! It fills me with pride that two of my warriors have prevailed through these treacherous depths so far!"
#else
                    message=_"So you've arrived, $protagonist_name1|, warrior of Sparta! It fills me with pride that one of my warriors has prevailed through these treacherous depths so far!"
#endif
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    message=_"Wait, are you... Ares?!"
                [/message]
                [message]
                    speaker=Ares
                    message=_"Indeed, it is I. Or, more accurately speaking, an avatar of myself with merely a small fraction of my might. I heard the prayers of your squad back in our world, so I sent this avatar you see before you, and I now speak through it. Now, I shall tell you the purpose of this visit."
                [/message]
                [message]
                    speaker=Ares
                    message=_"You see, what lies ahead is far deadlier than the paltry opposition you've faced thus far. Your current strength alone is not enough to prevail against Galatea and her strongest minions! Only with my legendary armaments can you achieve victory!"
                [/message]
                [message]
                    speaker=Ares
                    message=_"But before then, I must be fully certain that this divine weaponry won't go to waste. Destroy this avatar, and you shall earn it. If the avatar kills you, you weren't worthy of such a fine reward in the first place."
                [/message]
#ifdef MULTIPLAYER
                [message]
                    id=Hoplite
                    message=_"Very well then, I accept your challenge, Ares!"
                [/message]
                [message]
                    id=Hoplite2
                    message=_"I accept your challenge too!"
                [/message]
#else
                [message]
                    id=Hoplite
                    message=_"Very well then, I accept your challenge, Ares!"
                [/message]
#endif

                {SPARTAN_SMOOTH_REPLACE_MUSIC gathering_storm.ogg 1000 0}
            [/then]
        [/if]

        [if]
            [have_unit]
                id=Scylla
            [/have_unit]
            [then]
                {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 1000 0}
                [message]
                    id=Hoplite,Hoplite2
                    message=_"Nagas again? Doesn't seem to be that many this time..."
                [/message]
                [message]
                    speaker=Scylla
                    message=_"You ssstand before Scylla, Queen of the Stormtail Clan, one of Her Majesty Galatea's most trusted generals, and the mightiessst and mossst beautiful naga in thisss cave! Kneel and pledge allegiance if you wish to be ssspared, human!" #wmllint: no spellcheck
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    message=_"I shall not bow to some arrogant naga sorceress! Either stand aside, or you leave me no choice."
                [/message]
                {ALGADUR_LINE scylla_start (
                    [message]
                        speaker=Algadur
                        message=_"These Stormtail scum killed plenty of me shield-brothers along with the orcs! Time fer some payback!"
                    [/message]
                )}
                {SPARTAN_SMOOTH_REPLACE_MUSIC AcrutaLaoDnor.ogg 1000 0}
                [message]
                    speaker=Scylla
                    message=_"Foolisssh human, I ssshall tear you to piecesss with my water magic and feed your corpssse to Charybdisss!" #wmllint: no spellcheck
                [/message]
                [message]
                    speaker=Charybdis
                    message=_"<i>*nods*</i>"
                [/message]
            [/then]
        [/if]

        [if]
            {VARIABLE_CONDITIONAL archmagemet not_equals yes}
            [and]
                [have_unit]
                    id=Archmage
                    [not]
                        [filter_wml]
                            variation=shaxtal
                        [/filter_wml]
                    [/not]
                [/have_unit]
            [/and]
            [then]
                {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 1000 0}

                #TODO: maybe improve the dialog later, once I decide on archmage's new role in the story a bit more
#ifdef MULTIPLAYER
                [message]
                    speaker=Archmage
                    message=_"So they finally found my hiding place... (looks at the spartans) I know what you are, abominations! I won't let you lay a finger on my precious books, deceitful demons!"
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    message=_"You call us demons?! Come to your senses, old man! We are just as human as you!"
                [/message]
                [message]
                    speaker=Archmage
                    message=_"Lies! You expect me to believe that two men could possibly have fought their way here through the dozens of orcs, undead and worse wandering these caves? You are clearly yet another bunch of Galatea's minions, disguised assassins sent to kill me and destroy the books!"
                [/message]
#else
                [message]
                    speaker=Archmage
                    #	   message=_"So the Chaos Empire finally found my hiding place... (looks at the hoplite) I know what you are, abomination! I won't let you lay a finger on my precious books, you Uria-worshipping scum!"
                    message=_"So they finally found my hiding place... (looks at the $spartan_classname_lowercase1|) I know what you are, abomination! I won't let you lay a finger on my precious books, deceitful demon!"
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    #	   message=_"I know not what is this Chaos Empire you speak of, nor am I part of it."
                    message=_"You call me a demon?! Come to your senses, old man! I'm just as human as you!"
                [/message]
                [message]
                    speaker=Archmage
                    message=_"Lies! You expect me to believe that one man could possibly have fought his way here through the dozens of orcs, undead and worse wandering these caves? You are clearly yet another one of Galatea's minions, a disguised assassin sent to kill me and destroy the books!"
                [/message]
#endif

                [if]
                    [have_unit]
                        id=Elizabeth
                    [/have_unit]
                    [then]
                        #rare dialog if you somehow get elizabeth before encountering archmage, like when using debug
                        [message]
                            speaker=Elizabeth
                            message=_"Master Arcanus, calm down!"
                        [/message]
                        [delay]
                            time=500
                        [/delay]
                        [message]
                            speaker=Archmage
                            message=_"E-Elizabeth?! Where have you been for so long?"
                        [/message]
                        [message]
                            speaker=Elizabeth
#ifdef MULTIPLAYER
                            message=_"I was stuck in the underworld, entered a portal I shouldn't have. But it's thanks to $protagonist_name1| and $protagonist_name2| I managed to escape it. I fought side by side with him, and I assure you, he can be trusted."
#else
                            message=_"I was stuck in the underworld, entered a portal I shouldn't have. But it's thanks to $protagonist_name1| I managed to escape it. I fought side by side with him, and I assure you, he can be trusted."
#endif
                        [/message]
                        [message]
                            speaker=Archmage
                            message=_"Very well."
                        [/message]
                        {SPARTAN_BOSSMUSICEND}
                        #archmage becomes peaceful:
                        [modify_unit]
                            [filter]
                                side=$hoplite_enemyside
                            [/filter]
                            side=$hoplite_allyside
                        [/modify_unit]
                        {VARIABLE archmage_beaten yes}
                        [remove_item]
                            image="scenery/trapdoor-closed.png"
                            x,y=6,2
                        [/remove_item]
                        [item]
                            image="scenery/trapdoor-open.png"
                            x,y=6,2
                        [/item]

                        {CLEAR_VARIABLE bossfight}

                        {VARIABLE archmage_beaten yes}
                        {VARIABLE archmage_spared yes}#variable will also be used for sparing archmage with the healing potion later
                        {VARIABLE elizabeth_line_archmage yes}#for filtering later
                        {VARIABLE noautomove_this_depth yes}#level can be explored as normal
                    [/then]
                    [else]
                        [message]
                            id=Hoplite,Hoplite2
                            message=_"I'd rather not spill more blood than necessary, but if it is a fight you want, it's a fight you will get!"
                        [/message]

                        {ALGADUR_LINE archmage (
                            [message]
                                speaker=Algadur
#ifdef MULTIPLAYER
                                message=_"Anyone who wants ta kill my shield-brothers will have ta face me too!"
#else
                                message=_"Anyone who wants ta kill my shield-brother will have ta face me too!"
#endif
                            [/message]
                        )}
                        {SPARTAN_SMOOTH_REPLACE_MUSIC burning.ogg 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
                        {SPARTAN_SMOOTH_REPLACE_MUSIC battle-epic.ogg 1000 0}
#endif
                    [/else]
                [/if]
                {VARIABLE archmagemet yes}
            [/then]
        [/if]
        [if]
            {VARIABLE_CONDITIONAL archmagemet2 not_equals yes}
            [and]
                [have_unit]
                    id=Archmage
                    [filter_wml]
                        variation=shaxtal
                    [/filter_wml]
                [/have_unit]
            [/and]
            [then]
                {HOPLITE_UNSTORE_COMPANIONS}
                {SPARTAN_SMOOTH_REPLACE_MUSIC overlive.ogg 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
                {SPARTAN_SMOOTH_REPLACE_MUSIC frantic.ogg 1000 0}
#endif
                [if]
                    [have_unit]
                        id=Elizabeth
                    [/have_unit]
                    [then]
                        {IF_VAR elizabeth_line_archmage equals yes (
                            [then]
                                [message]
                                    speaker=Elizabeth
                                    message=_"M-master! Wha... What happened to you?!"
                                [/message]
                            [/then]
                            [else]
                                [message]
                                    speaker=Elizabeth
                                    message=_"M-master? Is that you? Do... do you remember me?"
                                [/message]
                            [/else]
                        )}
                        {SCROLL_TO 6 4}
                        [delay]
                            time=1000
                        [/delay]
                        [message]
                            speaker=Archmage
                            message=_"(in a metallic female voice) You being so eager to call <b>me</b> master is appreciated, dear, but if you were referring to this old man, then I would like to inform you that he is no more. His husk is now merely another disposable drone for the empire."
                        [/message]
                        [message]
                            speaker=Algadur
                            message=_"My beard be damned! Look at this thing's bloody face!"
                        [/message]
                        [message]
                            speaker=Elizabeth
                            message=_"Wh... just what the hell are you?!"
                        [/message]
                        [message]
                            speaker=Archmage
                            message=_"Have you been living under a rock, Elizabeth? Never seen a shaxtal in your entire life?"
                        [/message]
                        [message]
                            speaker=Elizabeth
                            message=_"How... how do you know my name?"
                        [/message]
                        [message]
                            speaker=Archmage
                            message=_"Ah, it just so happens that I may have had the pleasure of knowing you in a past life of sorts. Unlike you, however, I'm now near the top of the current hierarchy, while you still remain near the very bottom like the failure that you are."
                        [/message]
                        [message]
                            speaker=Elizabeth
                            message=_"Wha... I..."
                        [/message]
                        [message]
                            speaker=Archmage
                            message=_"More importantly, you have been sentenced to death for interfering with the empire's geopolitical expansion. If you surrender, we promise to make your death quick and painless. If you won't, then I can assure you that I will truly make you regret make such a foolish choice."
                        [/message]
                        [if]
                            [have_unit]
                                id=Algadur
                            [/have_unit]
                            [then]
                                [message]
                                    speaker=Algadur
                                    message=_"Surrender ta you?! Blazes no! I'd rather shave my beard than become braindead enough ta accept that! Prepare ta taste my axe, abomination!"
                                [/message]
                            [/then]
                            [else]
                                [message]
                                    speaker=Elizabeth
                                    message=_"Surrender to you?! Hell no! I'd rather die than lick your imperial boots!"
                                [/message]
                            [/else]
                        [/if]
                        [message]
                            id=Hoplite,Hoplite2
                            # wmllint: local spelling Chaaaaaarge
                            message=_"You will pay dearly for what you did to Elizabeth's mentor, you Uria-worshipping demon! Chaaaaaarge!"
                        [/message]
                        [delay]
                            time=500
                        [/delay]
                        [message]
                            speaker=Archmage
                            message=_"Enemies of Uria truly do never learn... very well, if you want to lay your worthless lives for your worthless cause, then so be it! My warm blood bath is already prepared, so I'll leave killing you to this mindless drone."
                        [/message]
                        [delay]
                            time=500
                        [/delay]
                        [message]
                            speaker=Archmage
                            message=_"(switches to a male metallic voice) Initiating protocol 21B. Weapon systems online. Report to Uria's Fire after completion of the objective."
                        [/message]
                        {VARIABLE elizabeth_line_archmage2 yes}
                    [/then]
                    #if you have Algadur but not Elizabeth somehow:
                    [elseif]
                        [have_unit]
                            id=Algadur
                        [/have_unit]
                        [then]
                            [message]
                                speaker=Archmage
                                message=_"(in a female metallic voice) Were you expecting to encounter this old man here? Well, he is no more. His husk is now merely another disposable drone for the empire..."
                            [/message]
                            [message]
                                speaker=Algadur
                                message=_"My beard be damned! Look at this thing's bloody face!"
                            [/message]
                            [message]
                                speaker=Archmage
                                message=_"...and more importantly, you have been sentenced to death for interfering with the empire's geopolitical expansion. If you surrender, we promise to make your death quick and painless. If you won't, then I can assure you that I will truly make you regret make such a foolish choice."
                            [/message]
                            [message]
                                speaker=Algadur
                                message=_"Surrender ta you?! Blazes no! I'd shave my beard before I become braindead enough ta accept that! Prepare ta taste my axe, abomination!"
                            [/message]
                            [message]
                                id=Hoplite,Hoplite2
                                message=_"You will pay dearly for what you did to this old man, you Uria-worshipping demon! Chaaaaaarge!"
                            [/message]
                            [delay]
                                time=500
                            [/delay]
                            [message]
                                speaker=Archmage
                                message=_"The heretics truly do never learn... very well, if you want to lay your worthless lives for your 'cause', then so be it! My warm blood bath is already prepared, so I'll leave killing you to this mindless drone."
                            [/message]
                            [message]
                                speaker=Archmage
                                message=_"(switches to a male metallic voice) Initiating protocol 21B. Weapon systems online. Report to Uria's Fire after completion of the objective."
                            [/message]
                        [/then]
                    [/elseif]
                    [else]
                        [message]
                            speaker=Archmage
                            message=_"(in a female metallic voice) Were you expecting to encounter this old man here? Well, he is no more. His husk is now merely another disposable drone for the empire."
                        [/message]
                        [message]
                            speaker=Archmage
                            message=_"More importantly, however, you have been sentenced to death for interfering with the empire's geopolitical expansion. If you surrender, we promise to make your death quick and painless. If you won't, then I can assure you that I will truly make you regret make such a foolish choice."
                        [/message]
                        [message]
                            id=Hoplite,Hoplite2
                            message=_"How arrogant of you to think a proud warrior of Sparta will just surrender to the likes of you. You will pay dearly for what you did to this old man, you Uria-worshipping demon!"
                        [/message]
                        [delay]
                            time=500
                        [/delay]
                        [message]
                            speaker=Archmage
                            message=_"You refuse? The heretics truly do never learn... very well, if you want to lay your worthless life for your worthless cause, then so be it! My warm blood bath is already prepared, so I'll leave killing you to this mindless drone."
                        [/message]
                        [message]
                            speaker=Archmage
                            message=_"(switches to a male metallic voice) Initiating protocol 21B. Weapon systems online. Report to Uria's Fire after completion of the objective."
                        [/message]
                    [/else]
                [/if]
                {SPARTAN_SMOOTH_REPLACE_MUSIC gathering_storm.ogg 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
                {SPARTAN_SMOOTH_REPLACE_MUSIC battle-epic.ogg 1000 0}
#endif
                {VARIABLE archmagemet2 yes}
            [/then]
        [/if]
        {IF_VAR reaper_met not_equals yes (
            [and]
                {VARIABLE_CONDITIONAL hoplite_depth equals -10}
            [/and]
            [then]
                {VARIABLE reaper_met yes}
                {HOPLITE_UNSTORE_COMPANIONS}
                [delay]
                    time=500
                [/delay]
                [unhide_unit]
                    id=Reaper
                [/unhide_unit]
                {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 1000 0}
                [if]
                    [have_unit]
                    	side=$hoplite_playerside,$hoplite_allyside
                        [not]
                            id=Hoplite
                        [/not]
                        count=1-999
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Reaper
                            message=_"Who do we have here? A group of mortals foolish enough to enter the land of the dead. Do you desire to hasten your demise?"
                        [/message]
                        [message]
                            id=Hoplite,Hoplite2
                            message=_"We must return to the world of the living, and if we must go through you, then so be it!"
                        [/message]
                        [message]
                            speaker=Reaper
                            message=_"<i>laughs</i> I have seen millions of mortals, but you are certainly among the most bold. I must admit, I am somewhat amused. Since I am feeling quite generous at the moment, If you can defeat a small fraction of my power, I will permit you to leave my domain this time."
                        [/message]
                        [message]
                            id=Hoplite,Hoplite2
                            message=_"Very well, I accept your challenge!"
                        [/message]
                        [message]
                            speaker=Reaper
                            message=_"Your souls shall be a fine addition to my collection, mortals!"
                        [/message]
                    [/then]
                    [else]
                        #most likely won't happen in actual gameplay, but possible in debug:
                        [message]
                            speaker=Reaper
                            message=_"Who do we have here? A $spartan_classname_lowercase1|, a lone mortal foolish enough to enter the land of the dead. Do you desire to hasten your demise?"
                        [/message]
                        [message]
                            id=Hoplite,Hoplite2
                            message=_"I must return to the world of the living, and if I must go through you, then so be it!"
                        [/message]
                        [message]
                            speaker=Reaper
                            message=_"<i>laughs</i> I have seen millions of mortals, but you are certainly among the most bold. I must admit, I am somewhat amused. Since I am feeling quite generous at the moment, If you can defeat a small fraction of my power, I will permit you to leave my domain this time."
                        [/message]
                        [message]
                            id=Hoplite,Hoplite2
                            message=_"Very well, I accept your challenge!"
                        [/message]
                        [message]
                            speaker=Reaper
                            message=_"Your soul shall be a fine addition to my collection, mortal!"
                        [/message]        
                    [/else]
                [/if]
                {SPARTAN_SMOOTH_REPLACE_MUSIC moleman.ogg 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
                {SPARTAN_SMOOTH_REPLACE_MUSIC battle-epic.ogg 1000 0}
#endif
            [/then]
        )}

        #Galatea boss dialog:

        [if]
            [have_unit]
                id=Galatea
                [not]
                    type=Hoplite_Galatea_prologue
                [/not]
            [/have_unit]
            [then]
                {SPARTAN_SMOOTH_REPLACE_MUSIC overlive.ogg 1000 0}
                [message]
                    speaker=Galatea
                    #ifdef MULTIPLAYER
                    message=_"So you two are the ones who defeated hundreds of my troops and even my generals. And now you have the audacity to step into my throne room too."
                    #else
                    message=_"So you are the one who defeated hundreds of my troops and even my generals. And now you have the audacity to step into my throne room too."
                    #endif
                [/message]
                [message]
                    id=Hoplite
                    #ifdef MULTIPLAYER
                    message=_"Indeed. We, $protagonist_name1| and $protagonist_name2|, have come to stop your plans of invading our homeland again!"
                    #else
                    message=_"Indeed. I, $protagonist_name1|, have come to stop your plans of invading my homeland again!"
                    #endif
                [/message]
                #"he" refers to the Merchant, who Galatea got her current powers from
                [message]
                    speaker=Galatea
                    #ifdef MULTIPLAYER
                    message=_"How did you even get this far? You are just two men... unless he... no no, surely he would not betray me..."
                    #else
                    message=_"How did you even get this far? You are just one man... unless he... no no, surely he would not betray me..."
                    #endif
                [/message]
                #forges scattered across the cave are mostly made by dwarves
                [if]
                [have_unit]
                    id=Algadur
                [/have_unit]
                [then]
                    [message]
                        speaker=Algadur
                        message=_"Our dwarven forges can do more than ye think, ye vile tyranness! Now it's time fer some payback fer all my shield-brothers yer troops killed!"
                    [/message]
                    [message]
                        speaker=Galatea
                        #ifdef MULTIPLAYER
                        message=_"Spartans and dwarves... both your kinds proved to be unusually resistant to my mind control spells, but now I only need to succeed on two people instead of whole squads."
                        #else
                        message=_"Spartans and dwarves... both your kinds proved to be unusually resistant to my mind control spells, but now I only need to succeed on one person instead of whole squads."
                        #endif
                    [/message]
                [/then]
                [else]
                    [message]
                        id=Hoplite
                        message=_"A true warrior of Sparta can handle anything you could possibly throw at him!"
                    [/message]
                    [message]
                        speaker=Galatea
                        #ifdef MULTIPLAYER
                        message=_"Your kind proved to be unusually resistant to my mind control spells during the war, but now I only need to succeed on two people instead of whole squads."
                        #else
                        message=_"Your kind proved to be unusually resistant to my mind control spells during the war, but now I only need to succeed on one person instead of whole squads."
                        #endif
                    [/message]
                [/else]
                [/if]
                [message]
                    speaker=Galatea
                    #ifdef MULTIPLAYER
                    message=_"With your current power, $protagonist_name1| and $protagonist_name2|, if you are on my side I may still be able to free Mallion from your countrymen."
                    #else
                    message=_"With your current power, $protagonist_name1|, if you are on my side I may still be able to free Mallion from your countrymen."
                    #endif
                [/message]

                #for the multiplayer dialog:

                [store_unit]
                    [filter]
                        id=Hoplite,Hoplite2
                    [/filter]
                    variable=hoplite_protagonist_portraits
                    kill=no
                [/store_unit]                

                {FLASH_WHITE (
                    [sound]
                        name=lightning.ogg
                    [/sound]
                )}
                [message]
                    speaker=Galatea
                    #ifdef MULTIPLAYER
                    message=_"<span color='#FF00FF' size='large' font-style='italic'>Obey me, $protagonist_name1| and $protagonist_name2|!!!</span>"
                    #else
                    message=_"<span color='#FF00FF' size='large' font-style='italic'>Obey me, $protagonist_name1|!!!</span>"
                    #endif
                [/message]
                #ifdef MULTIPLAYER
                #since second_image is bugged in 1.18, using this as a workaround instead
                [message]
                    speaker=narrator
                    caption=_"$protagonist_name1| and $protagonist_name2|"
                    #show both protagonists at once
                    image="misc/blank-hex.png~SCALE(600,400)~BLIT($hoplite_protagonist_portraits[1].profile|,-100,0)~BLIT($hoplite_protagonist_portraits[0].profile|,50,0)" 
                    message=_"Argh..."
                    sound={SOUND_LIST:HUMAN_HIT}
                [/message]
                #else
                [message]
                    id=Hoplite
                    message=_"Argh..."
                    sound={SOUND_LIST:HUMAN_HIT}
                [/message]
                #endif

                {FLASH_WHITE (
                    [sound]
                        name=lightning.ogg
                    [/sound]
                )}
                [message]
                    speaker=Galatea
                    #ifdef MULTIPLAYER
                    message=_"<span color='#FF00FF' size='large' font-style='italic'>Pledge your allegiance to me, $protagonist_name1| and $protagonist_name2|!!!</span>"
                    #else
                    message=_"<span color='#FF00FF' size='large' font-style='italic'>Pledge your allegiance to me, $protagonist_name1|!!!</span>"
                    #endif
                [/message]
                #ifdef MULTIPLAYER
                [message]
                    speaker=narrator
                    caption=_"$protagonist_name1| and $protagonist_name2|"
                    #show both protagonists at once
                    image="misc/blank-hex.png~SCALE(600,400)~BLIT($hoplite_protagonist_portraits[1].profile|,-100,0)~BLIT($hoplite_protagonist_portraits[0].profile|,50,0)" 
                    message=_"AAAArrrgh... No..."
                    sound={SOUND_LIST:HUMAN_HIT}
                [/message]
                #else
                [message]
                    id=Hoplite
                    message=_"AAAArrrgh... No..."
                    sound={SOUND_LIST:HUMAN_HIT}
                [/message]
                #endif
                {FLASH_WHITE (
                    [sound]
                        name=lightning.ogg
                    [/sound]
                )}
                [message]
                    speaker=Galatea
                    #ifdef MULTIPLAYER
                    message=_"<span color='#FF00FF' size='large' font-style='italic'>You will be my finest warriors, $protagonist_name1| and $protagonist_name2|!!!</span>"
                    #else
                    message=_"<span color='#FF00FF' size='large' font-style='italic'>You will be my finest warrior, $protagonist_name1|!!!</span>"
                    #endif
                [/message]
                #ifdef MULTIPLAYER
                [message]
                    speaker=narrator
                    caption=_"$protagonist_name1| and $protagonist_name2|"
                    #show both protagonists at once
                    image="misc/blank-hex.png~SCALE(600,400)~BLIT($hoplite_protagonist_portraits[1].profile|,-100,0)~BLIT($hoplite_protagonist_portraits[0].profile|,50,0)" 
                    message=_"AAAAAAAAAAAAAAAAA..."
                    sound={SOUND_LIST:HUMAN_HIT}
                [/message]
                [message]
                    speaker=narrator
                    caption=_"$protagonist_name1| and $protagonist_name2|"
                    #show both protagonists at once
                    image="misc/blank-hex.png~SCALE(600,400)~BLIT($hoplite_protagonist_portraits[1].profile|,-100,0)~BLIT($hoplite_protagonist_portraits[0].profile|,50,0)" 
                    message=_"..."
                [/message]
                #else
                [message]
                    id=Hoplite
                    message=_"AAAAAAAAAAAAAAAAA..."
                    sound={SOUND_LIST:HUMAN_HIT}
                [/message]
                [message]
                    id=Hoplite
                    message=_"..."
                [/message]
                #endif
                [delay]
                    time=2000
                [/delay]
                {ALGADUR_LINE galatea1 (
                    [message]
                        speaker=Algadur
                #ifdef MULTIPLAYER
                        message=_"What is happening to ye, shield-brothers? $protagonist_name1|? $protagonist_name2|?"
                #else
                        message=_"What is happening to ye, shield-brother? $protagonist_name1|?"
                #endif
                    [/message]
                )}
                #ifdef MULTIPLAYER
                [message]
                    speaker=narrator
                    caption=_"$protagonist_name1| and $protagonist_name2|"
                    #show both protagonists at once
                    image="misc/blank-hex.png~SCALE(600,400)~BLIT($hoplite_protagonist_portraits[1].profile|,-100,0)~BLIT($hoplite_protagonist_portraits[0].profile|,50,0)" 
                    message=_"We... serve..."
                [/message]
                #else
                [message]
                    id=Hoplite
                    message=_"I... serve..."
                [/message]
                #endif
                {ELIZABETH_LINE galatea1 (
                    [message]
                        speaker=Elizabeth
                        message=_"Don't tell me..."
                    [/message]
                )}
                [message]
                    speaker=Galatea
                    message=_"Yes, yes, pledge allegiance to me!"
                [/message]
                [delay]
                    time=1000
                [/delay]
                {SPARTAN_SMOOTH_REPLACE_MUSIC Trite_And_Wrong.ogg 1000 0}
                #ifdef MULTIPLAYER
                [message]
                    speaker=narrator
                    caption=_"$protagonist_name1| and $protagonist_name2|"
                    #show both protagonists at once
                    image="misc/blank-hex.png~SCALE(600,400)~BLIT($hoplite_protagonist_portraits[1].profile|,-100,0)~BLIT($hoplite_protagonist_portraits[0].profile|,50,0)" 
                    message=_"We serve... Sparta!!!"
                [/message]
                #else
                [message]
                    id=Hoplite
                    message=_"I serve... Sparta!!!"
                [/message]
                #endif

                [message]
                    speaker=Galatea
                    message=_"I-Impossible! The spell still failed?!"
                [/message]
                [message]
                    id=Hoplite
                    #ifdef MULTIPLAYER
                    message=_"No matter what dark sorcery you try to use, We will protect our homeland from your hordes at all costs!"
                    #else
                    message=_"No matter what dark sorcery you try to use, I will protect my homeland from your hordes at all costs!"
                    #endif
                [/message]
                [message]
                    #ifdef MULTIPLAYER
                    id=Hoplite2
                    message=_"We defeated everything you have thrown at us so far, and we shall defeat you too! Now it is time to end this!"
                    #else
                    id=Hoplite
                    message=_"I defeated everything you have thrown at me so far, and I shall defeat you too! Now it is time to end this!"
                    #endif
                [/message]
                [delay]
                    time=1000
                [/delay]
                [message]
                    speaker=Galatea
                    message=_"If I can't make you loyal to me, I shall have to get rid of you myself! I won't let anyone or anything stand between me and Mallion, mark my words!"
                [/message]
                [message]
                    speaker=Galatea
                    message=_"<span color='#FF00FF' size='large' font-style='italic'>My loyal troops, attack!</span>"
                [/message]
                [message]
                    side=$hoplite_enemyside
                    level=3
                    message=_"Yes, Your Majesty!!!"
                [/message]

                {SPARTAN_SMOOTH_REPLACE_MUSIC ThoseofUsWhoFight.ogg 1000 0}
                {CLEAR_VARIABLE hoplite_protagonist_portraits}
            [/then]
        [/if]

        {IF_VAR hoplite_depth equals 40 (
            [then]
                {SPARTAN_SMOOTH_REPLACE_MUSIC into_the_shadows.ogg 1000 0}
                {HOPLITE_UNSTORE_COMPANIONS}
                {MOVE_UNIT id=Hoplite,Hoplite2 6 5}
                {MOVE_UNIT ability=hoplite_companion 6 5}

                #TODO: remove this line of dialog when Galatea fight is added:
                [message]
                    speaker=narrator
                    message=_"Final boss against Galatea has not yet been added, so the ending remains unchanged from older version until a later update."
                    image=wesnoth-icon.png
                [/message]

                [if]
                    [have_unit]
                        [not]
                            id=Hoplite
                        [/not]
                    [/have_unit]
                    [then]
                        [message]
                            id=Hoplite,Hoplite2
                            message=_"This is it. Finally, we found it - the heart of Prometheus."
                        [/message]
                    [/then]
                    [else]
                        [message]
                            id=Hoplite,Hoplite2
                            message=_"This is it. Finally, I found it - the heart of Prometheus"
                        [/message]
                    [/else]
                [/if]

                #TODO: completely rewrite the prometheus heart dialog or scrap it outright

                [if]
                    [have_unit]
                        id=Algadur
                    [/have_unit]
                    [and]
                        [have_unit]
                            id=Elizabeth
                        [/have_unit]
                    [/and]
                    [then]
                        [message]
                            speaker=Algadur
                            message=_"By the gods' beards! Is 'tis what I think it is? So we 'ave found the Ruby of Fire?"
                        [/message]
                        [message]
                            speaker=Elizabeth
                            message=_"Not quite. It is the Prometheus' Heart, a gem similar to the Ruby of Fire in nature. Its power doesn't quite hold up to that of its more famous counterpart, but it is still rather impressive."
                        [/message]
                    [/then]
                    [elseif]
                        [have_unit]
                            id=Algadur
                        [/have_unit]
                        [and]
                            [not]
                                [have_unit]
                                    id=Elizabeth
                                [/have_unit]
                            [/not]
                        [/and]
                        [then]
                            [message]
                                speaker=Algadur
                                message=_"By the gods' beards! Is 'tis what I think it is? So we 'ave found the Ruby of Fire?"
                            [/message]
                        [/then]
                    [/elseif]
                    [elseif]
                        [have_unit]
                            id=Elizabeth
                        [/have_unit]
                        [and]
                            [not]
                                [have_unit]
                                    id=Algadur
                                [/have_unit]
                            [/not]
                        [/and]
                        [then]
                            [message]
                                speaker=Elizabeth
                                message=_"My goodness, it's the Prometheus' Heart, a gem not unlike the Ruby of Fire! Its power doesn't quite hold up to that of its more famous counterpart, but it is still rather impressive."
                            [/message]
                        [/then]
                    [/elseif]
                [/if]
                [remove_item]
                    x,y=6,4
                [/remove_item]
                [item]
                    x,y=6,4
                    image="items/brazier.png"
                [/item]
                [sound]
                    name=fanfare-short.wav
                [/sound]
                {HOPLITE_APPLY_PROMETHEUS_HEART}
                [if]
                    [have_unit]
                        id=Algadur
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Algadur
                            message=_"Now that we got 'tis beauty, we must hurry up an' leave the leave before any of the demon-worshipers catch up ta us!"
                        [/message]
                        [message]
                            speaker=Elizabeth
                            message=_"Indeed, we can't waste a minute. However, going down into the dungeon could also be also a promising option. After all, the surface is probably overrun by the Chaos Empire. (to the hoplite) What do you think?"
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=Elizabeth
                            message=_"Now that we got this gem, we must hurry up and leave the leave before any of Uria's worshipers catch up to us, we can't waste a minute. However, going down into the dungeon could also be also a promising option. After all, the surface is probably overrun by the Chaos Empire. What do you think?"
                        [/message]
                    [/else]
                [/if]
                {SPARTAN_SMOOTH_REPLACE_MUSIC kreepor.ogg 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
                {SPARTAN_SMOOTH_REPLACE_MUSIC underground.ogg 1000 0}
#endif
                {MOVE_UNIT id=Hoplite,Hoplite2 6 2}
                #dialog: choose, oh hoplite, do you leave the dungeon to keep the mighty gem you have acquired, or descend even deeper into this endless abyss?
            [/then]
        )}
        {IF_VAR algadurlinesmith not_equals yes (
            [and]
                [have_unit]
                    id=Algadur
                [/have_unit]
            [/and]
            [and]
                [have_unit]
                    id=runesmith
                [/have_unit]
            [/and]
            [then]
                {VARIABLE algadurlinesmith yes}
                [message]
                    speaker=Algadur
                    message=_"One of our runesmiths is bein' attacked! Quick, we must help 'im!"
                [/message]
            [/then]
        )}
        {IF_VAR algadurlinestart not_equals yes (
            [and]
                [have_unit]
                    id=Algadur
                [/have_unit]
            [/and]
            [then]
                [message]
                    side=$hoplite_enemyside
                    race=orc
                    message=_"I repeat again, bearded maggots - Her Majesty Galatea ordered us to search this cave for some sort of workshop. Either you hand over the territory willingly, or we gonna keep butchering your puny kind, hehe."
                [/message]
                [message]
                    speaker=Algadur
                    message=_"A true dwarf nevers surrenders to trash like you, ya surface-dwellin' pigs! If I'm goin' down, then I'm sure as hell bringin' ye all with me!" #wmllint: no spellcheck
                [/message]
                {VARIABLE algadurlinestart yes}
            [/then]
        )}
        #patron lines:
        [if]
            [have_unit]
                id=Jeremias
                side=$hoplite_enemyside
            [/have_unit]
            [then]
                [message]
                    speaker=Jeremias
                    message=_"I'm far too old for this..."
                [/message]
            [/then]
        [/if]
        [if]
            [have_unit]
                id=inferno8
                side=$hoplite_enemyside
            [/have_unit]
            [then]
                [message]
                    speaker=inferno8
                    message=_"(singing) Ah, there's no better thing in this mortal world than fire
Destruction, passion, all-consuming desire
The human body was such a tire
I prefer being a walking flame, a state of existence much higher
Beware my abyssal flames' ire
Cause if you get in way you'll be no more than ash on a pyre!"
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    message=_"A singing... fire elemental?"
                [/message]
                [message]
                    speaker=inferno8
                    message=_"I am no mere elemental! I am The Eighth Inferno himself - once a mere human mage, I have ascended to this flawless fiery form!"
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    message=_"You traded your own body to become this? You are... certainly quite the pyromaniac."
                [/message]
                [message]
                    speaker=inferno8
                    message=_"A mortal like you wouldn't understand the sheer perfection of flame. As long as I consume matter, I am immortal! And now... you shall be next to become fuel for my flames! You heard me sing, now prepare to get singed!"
                [/message]
            [/then]
        [/if]
        [if]
            [have_unit]
                id=inferno8_matriarch
                side=$hoplite_enemyside
            [/have_unit]
            [then]
                [message]
                    speaker=inferno8_matriarch
                    message=_"Is that... one of the sun-worshippers? Good to see my prey is in this world too."
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    message=_"Sun-worshippers? What are you talking about? In Sparta we have our own gods, and I know not about these 'sun-worshippers' you speak of."
                [/message]
                [message]
                    speaker=inferno8_matriarch
                    message=_"Hmmm, never seen a 'Sparta' on the invasion maps... But no matter! I'm in the mood for some good ol' fashioned killing, and your armor looks close enough to that of my prey. You will suffice as a replacement! Now prepare to die, human!"
                [/message]
            [/then]
        [/if]
        [if]
            [have_unit]
                id=Heindal
                side=$hoplite_enemyside
            [/have_unit]
            [then]
                #TODO: change this line for other classes that don't have shields!
                [message]
                    speaker=Heindal
                    message=_"Who are you supposed to be, hiding behind your shield like a coward?"
                [/message]
                [message]
                    id=Hoplite
                    message=_"You can lecture me on cowardice once you have slain half as many men and beasts as I have. You speak to $protagonist_name1|, $spartan_classname_lowercase1| from Sparta. Now stand aside!"
                [/message]
                [message]
                    speaker=Heindal
                    message=_"Killing rats doesn't make you a fighter, you loudmouth!"
                [/message]
                [message]
                    id=Hoplite
                    message=_"I gave you a chance to stand aside, you're not getting a second one. Now taste cold steel!"
                [/message]
            [/then]
        [/if]
        {IF_VAR elizabethmet not_equals yes (
            [and]
                [have_unit]
                    id=Elizabeth
                [/have_unit]
            [/and]
            [then]
                {SCROLL_TO 6 5}
                {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 1000 0}
                {MOVE_UNIT id=Hoplite,Hoplite2 6 5}
                [message]
                    speaker=Elizabeth
                    image="portraits/humans/mage-red+female.png~BLEND(0,0,0,0.95)"
                    message=_"So you have finally arrived. I hope the message glyphs I scattered nearby were of help to you. You may be wondering who I am, so let me get that out of the way..."
                [/message]
                [remove_object]
                    id=Elizabeth
                    object_id=conceal
                [/remove_object]
                [modify_unit]
                    [filter]
                        id=Elizabeth
                    [/filter]
                    name=_"Elizabeth"
                    {TRAIT_LOYAL}
                [/modify_unit]

                #TODO: expand/improve the dialog once I improve archmage/elizabeth to better fit into the Spartan story
                #right now the dialog is rather WIP

                [message]
                    speaker=Elizabeth
                    message=_"<i>*ahem*</i> I am Elizabeth, a Red Mage from Alduin Academy. And you are?"
                [/message]
                #using ifdef here didn't work, using if/have_unit
                [if]
                    [have_unit]
                        id=Hoplite2
                    [/have_unit]
                    [then]
                        [message]
                            id=Hoplite
                            message=_"I am $protagonist_name1|, a $spartan_classname_lowercase1| from Sparta."
                        [/message]
                        {IF_VAR spartan_selected_character1 equals $spartan_selected_character2 (
                        [then]
                        [message]
                            id=Hoplite2
                            message=_"And I am $protagonist_name2|, also a Spartan $spartan_classname_lowercase2| like him."
                        [/message]
                        [/then]
                        [else]
                        [message]
                            id=Hoplite2
                            message=_"And I am $protagonist_name2|, a $spartan_classname_lowercase2|, also from Sparta."
                        [/message]
                        [/else]
                        )}
                    [/then]
                    [else]
                        [message]
                            id=Hoplite
                            message=_"I am $protagonist_name1|, a $spartan_classname_lowercase1| from Sparta."
                        [/message]
                    [/else]
                [/if]
                [if]
                    [have_unit]
                        id=Algadur
                    [/have_unit]
                    [then]
                    #using ifdef here didn't work, using if/have_unit
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                        [message]
                            speaker=Algadur
                            message=_"And I'm Algadur, shield-brother of $protagonist_name1| and $protagonist_name2| here. Those two saved my life from orcs, so I've been fighting alongside them since then."
                        [/message]
                        [/then]
                        [else]
                        [message]
                            speaker=Algadur
                            message=_"And I'm Algadur, shield-brother of $protagonist_name1| here. He saved my life from orcs, so I've been fighting alongside him since then."
                        [/message]
                        [/else]
                    [/if]
                    [/then]
                    [else]
                    [/else]
                [/if]
                [message]
                    speaker=Elizabeth
                    message=_"Sparta, you say? None of the maps of the Great Continent mention any such places... Where is it located exactly?"
                [/message]
                [message]
                    id=Hoplite
                    message=_"Sparta is not located on the Great Continent, nor anywhere in Irdya for that matter. I am from a different world altogether."
                [/message]
                [message]
                    speaker=Elizabeth
                    message=_"I see. So, $protagonist_name1|, what brings you to Irdya?"
                [/message]
                #using ifdef here didn't work, using if/have_unit
                [if]
                    [have_unit]
                        id=Hoplite2
                    [/have_unit]
                    [then]
                        [message]
                            id=Hoplite
                            message=_"Not long ago, Sparta has been attacked by Galatea. She brainwashed orcs, necromancers, and other beings from Irdya and used them for the invasion. While attacking, she accused of abducting her creator. His name is Mallion, I think. "
                        [/message]
                        [message]
                            id=Hoplite2
                            message=_"We managed to repel her invasion and I followed her into a portal to this world. Then I found a cave, where apparently Galatea's lair is local, then fought through dozens of her troops, found another smaller portal and ended up here."
                        [/message]
                    [/then]
                    [else]
                        [message]
                            id=Hoplite
                            message=_"Not long ago, Sparta has been attacked by Galatea. She brainwashed orcs, necromancers, and other beings from Irdya and used them for the invasion. While attacking, she accused of abducting her creator. His name is Mallion, I think. We managed to repel her invasion and I followed her into a portal to this world. Then I found a cave, where apparently Galatea's lair is local, then fought through dozens of her troops, found another smaller portal and ended up here."
                        [/message]
                    [/else]
                [/if]
                [message]
                    speaker=Elizabeth
                    message=_"Understood... Wait, did you just say Mallion?"
                [/message]
                [message]
                    id=Hoplite
                    message=_"Yes, what about him?"
                [/message]
                [message]
                    speaker=Elizabeth
                    message=_"I've actually entered the cave to investigate the rumors about Mallion. I heard that he has been doing magical experiments to open portals to different worlds. Though back then I haven't heard anything about this 'Galatea' you speak of, nor were the locals under her control yet."
                [/message]
                [message]
                    speaker=Elizabeth
                    message=_"Then eventually, I stumbled onto a purple portal, got a bit too curious... and well, here I am now. *sigh* There is nothing I desire more than getting out of this nightmare."
                [/message]

                #using ifdef here didn't work, using if/have_unit
                [if]
                    [have_unit]
                        id=Hoplite2
                    [/have_unit]
                    [then]
                        [message]
                            id=Hoplite
                            message=_"Admittedly, me and $protagonist_name2| got too curious with portals too. Since you have been stuck here longer than I, tell me what you know of this place. Is there a possibility of escape?"
                        [/message]
                        [message]
                            speaker=Elizabeth
                            message=_"There is, but... Well, how do I put it... there is one of the Grim Reaper's chambers ahead, with a portal back to the mortal world. I, obvious enough, am in no way skilled enough to tackle such a being alone. And that's where you two come in."
                        [/message]
                        [message]
                            id=Hoplite2
                            message=_"You think a few mortal warriors have a chance of fighting Death himself?! I... I am quite flattered, but..."
                        [/message]
                    [/then]
                    [else]
                        [message]
                            id=Hoplite
                            message=_"Admittedly I got too curious with portals too. Since you have been stuck here longer than I, tell me what you know of this place. Is there a possibility of escape?"
                        [/message]
                        [message]
                            speaker=Elizabeth
                            message=_"There is, but... Well, how do I put it... there is one of the Grim Reaper's chambers ahead, with a portal back to the mortal world. I, obvious enough, am in no way skilled enough to tackle such a being alone. And that's where you come in."
                        [/message]
                        [message]
                            id=Hoplite
                            message=_"You think a mortal warrior like me has a chance of fighting Death himself?! I... I am quite flattered, but..."
                        [/message]
                    [/else]
                [/if]

                [message]
                    speaker=Algadur
                    message=_"You want us to fight Death himself?! Are ya out of yer damn mind, woman?!"
                [/message]
                [message]
                    speaker=Elizabeth
                    message=_"Yes, I fully understand that isn't exactly the best-sounding idea, but what choice do we have? We could sit here for eternity and slowly go insane, <b>or</b> we could gamble our souls for a chance to leave this place. The latter option isn't exactly that great, but it seems to me like he lesser of two evils."
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    message=_"I suppose you are right, we have not much left to lose and a lot to gain. Very well, time to make the impossible possible!"
                [/message]
                [message]
                    speaker=Algadur
                    message=_"Argh, fine, I guess ye're givin' us no choice, lass... Very well, let's do 'tis." #wmllint: no spellcheck
                [/message]
                {ACHIEVEMENT_MESSAGE elizabeth}
                {SPARTAN_ACHIEVEMENT_MESSAGE_IF_CLASS_MATCHES sorcerer elizabeth_sorcerer 1}
                {SPARTAN_ACHIEVEMENT_MESSAGE_IF_CLASS_MATCHES sorcerer elizabeth_sorcerer 2}

                {SPARTAN_SMOOTH_REPLACE_MUSIC ooze.ogg 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
                {SPARTAN_SMOOTH_REPLACE_MUSIC the_deep_path.ogg 1000 0}
#endif
                {VARIABLE elizabethmet yes}
            [/then]
        )}
        {IF_VAR elizabeth_cooldown less_than 1 (
            [and]
                {VARIABLE_CONDITIONAL Elizabeth_stored.x greater_than 0}
            [/and]
            [and]
                {VARIABLE_CONDITIONAL hoplite_depth greater_than 0}
                [or]
                    {VARIABLE_CONDITIONAL elizabethstays not_equals yes}
                [/or]
            [/and]
            [then]
                [unstore_unit]
                    variable=Elizabeth_stored
                    find_vacant=yes
                    x,y=6,10
                [/unstore_unit]
                {CLEAR_VARIABLE Elizabeth_stored}
                [animate_unit]
                    flag=post_teleport
                    [filter]
                        id=Elizabeth
                    [/filter]
                [/animate_unit]
                {IF_VAR elizabethstays equals yes (
                    [then]
                        [message]
                            speaker=Elizabeth
                            message=_"Hey, you're back! How's your trip to the underworld been? Fine, you say? Good to hear that."
                        [/message]
                        {CLEAR_VARIABLE elizabethstays}
                    [/then]
                    [else]
                        {RANDOM 1..3}
                        {IF_VAR random equals 1 (
                            [then]
                                [message]
                                    speaker=Elizabeth
                                    message=_"Hey, I'm back! Hope I didn't miss anything important..."
                                [/message]
                            [/then]
                        )}
                        {IF_VAR random equals 2 (
                            [then]
                                [message]
                                    speaker=Elizabeth
                                    message=_"Whew, I'm back! Did I miss much of the fun? No? Good to know."
                                [/message]
                            [/then]
                        )}
                        {IF_VAR random equals 3 (
                            [then]
                                [message]
                                    speaker=Elizabeth
                                    message=_"Man, that was quite the rest! Too bad I now have to fight again..."
                                [/message]
                            [/then]
                        )}
                    [/else]
                )}
                {CLEAR_VARIABLE Elizabeth_stored}
            [/then]
        )}
        {IF_VAR algadur_cooldown less_than 1 (
            [and]
                {VARIABLE_CONDITIONAL Algadur_stored.x greater_than 0}
            [/and]
            [and]
                {VARIABLE_CONDITIONAL hoplite_depth greater_than 0}
                [or]
                    {VARIABLE_CONDITIONAL algadurstays not_equals yes}
                [/or]
            [/and]
            [then]
                [unstore_unit]
                    variable=Algadur_stored
                    find_vacant=yes
                    x,y=6,10
                [/unstore_unit]
                {CLEAR_VARIABLE Algadur_stored}
                {IF_VAR algadurstays equals yes (
                    [then]
                        [message]
                            speaker=Algadur
                            message=_"Ye're back! Glad ta see ya in one piece, lad."
                        [/message]
                        {CLEAR_VARIABLE algadurstays}
                    [/then]
                    [else]
                        {RANDOM 1..3}
                        {IF_VAR random equals 1 (
                            [then]
                                [message]
                                    speaker=Algadur
                                    message=_"I'm back, sorry for keepin' ya waiting'."
                                [/message]
                            [/then]
                        )}
                        {IF_VAR random equals 2 (
                            [then]
                                [message]
                                    speaker=Algadur
                                    message=_"I'm back and ready ta fight! Now, whose head should I chop off 'tis time?"
                                [/message]
                            [/then]
                        )}
                        {IF_VAR random equals 3 (
                            [then]
                                [message]
                                    speaker=Algaadur
                                    message=_"I'm back. How am I, ye ask? Don't worry, lad, 'tis just a flesh wound, survived worse."
                                [/message]
                            [/then]
                        )}
                    [/else]
                )}
                {CLEAR_VARIABLE Algadur_stored}
            [/then]
        )}
        {IF_VAR chaos_line1 not_equals yes (
            [and]
                [have_unit]
                    side=$hoplite_enemyside
                    type=Hoplite_Chaosinvader
                [/have_unit]
            [/and]
            [and]
                {VARIABLE_CONDITIONAL bossfight not_equals yes}
            [/and]
            [and]
                [not]
                    [have_unit]
                        id=Donovan
                    [/have_unit]
                [/not]
            [/and]
            [then]
                [if]
                    [have_unit]
                        side=$hoplite_allyside
                        ability=hoplite_companion
                    [/have_unit]
                    [or]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                    [/or]
                    [then]
                        [message]
                            type=Hoplite_Chaosinvader
                            # wmllint: local spelling Chaaaarge
                            message=_"Look, brothers! It is the very heretics Brother Donovan warned us about! Let us show these heathen wretches the might of Uria! Chaaaarge!"
                        [/message]
                    [/then]
                    [else]
                        [message]
                            type=Hoplite_Chaosinvader
                            message=_"Look, brothers! It is the very heretic Brother Donovan warned us about! Let us show this heathen wretch the might of Uria! Chaaaarge!"
                        [/message]
                    [/else]
                [/if]
                [message]
                    speaker=Algadur
                    # wmllint: local spelling demon-worshippin
                    message=_"These demon-worshippin' lunatics are 'ere too?! Bloody hell, they must've overrun half the caves already!"
                [/message]
                {VARIABLE chaos_line1 yes}
            [/then]
        )}
        {IF_VAR donovanmet not_equals yes (
            [and]
                [have_unit]
                    id=Donovan
                    side=$hoplite_enemyside
                [/have_unit]
            [/and]
            [then]
                {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 1000 0}

                [message]
                    speaker=Donovan
                    message=_"Halt in the name of Her Majesty Galatea! Too long have you been an obstacle to her plans, but I will not allow you to interfere in our ice magic experiments too!"
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    message=_"I won't let yet another one of Galatea's brainwashed warriors stand in my way, and I certainly not let you keep amassing your ice statue army either. Bring it on!"
                [/message]
                [message]
                    speaker=Donovan
                    message=_"You are no match for the power of ice magic, as I will now demonstrate."
                [/message]
                [message]
                    speaker=Donovan
                    message=_"Kill the intruder!"
                [/message]

                {SPARTAN_SMOOTH_REPLACE_MUSIC mad-mad-men.ogg 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
                {SPARTAN_SMOOTH_REPLACE_MUSIC battle-epic.ogg 1000 0}
#endif
            [/then]
        )}

        #old dialog

        {IF_VAR donovanmet not_equals yes (
            [and]
                [have_unit]
                    id=Donovan_old
                    side=$hoplite_enemyside
                [/have_unit]
            [/and]
            [then]
                {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 1000 0}
                [hide_unit]
                    side=$hoplite_allyside
                [/hide_unit]
                {MOVE_UNIT id=Hoplite,Hoplite2 6 7}

                #TODO: properly rewrite the character or outright replace him. currently just made him not quite a chaos empire member

                #	[message]
                #	        speaker=Donovan
                #	        message=_"Halt in the name of Uria, soldier! The armor you're wearing is not of the standard approved by the imperial armory. Explain yourself!"
                #	[/message]
                #	[message]
                #	        id=Hoplite,Hoplite2
                #	        message=_"I am not from this empire you speak of. I am a hoplite from Sparta."
                #	[/message]
                #	[message]
                #	        speaker=Donovan
                #	        message=_"Oh, so are not part of the imperial army, right... Well, we are quite eager to hire some mercenaries, to replace the regiments lost #due to our recent conquest. Capable warriors like you are in high demand but short supply, after all. Here's the offer: pledge your allegiance #to our glorious empire, and you shall receive the honor of serving our goddess Uria as a fellow knight of chaos, and a payment of 55 Urvathan #silver a month."
                #	[/message]
                #	[message]
                #	        id=Hoplite,Hoplite2
                #	        message=_"My allegiance is to Sparta, and Sparta only. Nor do I worship gods outside our pantheon. Now stand aside, knight, I am on a very #important quest."
                #	[/message]
                #	[message]
                #	        speaker=Donovan
                #	        message=_"You... you dare to reject my generosity, you ungrateful heathen wretch?! Are you truly so blind as to not see that Uria is the one and #only true god?! Hrmph... very well, if you refuse to serve her in life, then you shall have to serve her in death! En garde, heretic! May Uria #have mercy on your soul, for I will not!"
                #	[/message]

                #temporary dialog until character gets rewritten or more likely replaced

                [message]
                    speaker=Donovan
                    message=_"Halt in the name of Her Majesty Galatea, worthy foe! Too long have you been an obstacle to her plans, so I shall put an end to you!"
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    message=_"I won't let yet another brainwashed warrior stand in my way, bring it on!"
                [/message]
                [message]
                    speaker=Donovan
                    message=_"Very well then. Charge!"
                [/message]

                {SPARTAN_SMOOTH_REPLACE_MUSIC mad-mad-men.ogg 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
                {SPARTAN_SMOOTH_REPLACE_MUSIC battle-epic.ogg 1000 0}
#endif
                [unhide_unit]
                    side=$hoplite_allyside
                [/unhide_unit]
                {HOPLITE_UNSTORE_COMPANIONS}
            [/then]
        )}
        [if]
            [have_unit]
                id=merchant
            [/have_unit]
            [then]
                {VARIABLE_OP spartan_merchant_lines add 1}
                #TODO: add a switch case for different dialog

                {SPARTAN_GET_SHOP_DATA_GLOBAL_VARS}

                [if]
                    {VARIABLE_CONDITIONAL spartan_met_merchants_this_playthrough equals yes}
                    [then]
                        #TODO: maybe add Elizabeth dialog here too
                        [if]
                            {VARIABLE_CONDITIONAL hoplite_depth less_than_equal_to 0}
                            [and]
                                {VARIABLE_CONDITIONAL hoplite_underworld_line not_equals yes}
                            [/and]
                            [then]
                                {VARIABLE hoplite_underworld_line yes}
                                {HOPLITE_UNSTORE_COMPANIONS}
                                [message]
                                    id=Hoplite,Hoplite2
                                    message=_"Wait, you're here too?"
                                [/message]
                                [if]
                                    [have_unit]
                                        id=Elizabeth
                                    [/have_unit]
                                    [then]
                                        [message]
                                            id=Elizabeth
                                            message=_"Wait you know him? Who is he?"
                                        [/message]
                                        [message]
                                            speaker=merchant
#ifdef MULTIPLAYER
                                            message=_"No one to be concerned about, Miss Elizabeth. I'm just a merchant, interested in the journey of $protagonist_name1| and $protagonist_name2|. A good merchant must know where to find customers, and so far those two are my main customers, so I moved here for now."
#else
                                            message=_"No one to be concerned about, Miss Elizabeth. I'm just a merchant, interested in $protagonist_name1|'s journey. A good merchant must know where to find customers, and so far he is my main customer, so I moved here for now."
#endif
                                        [/message]
                                        [message]
                                            id=Elizabeth
                                            message=_"H-how do you know my name?! Also, why should I trust some suspicious-looking cloaked merchant that doesn't even show his face?"
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"Believe me, Miss Elizabeth, if I meant either of you any harm..."
                                        [/message]
                                        [delay]
                                            time=500
                                        [/delay]
                                        [message]
                                            speaker=merchant
                                            message=_"<i><b>...You would already be dead.</b></i>"
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"<i>*gulp*</i>"
                                        [/message]
                                        [message]
                                            id=Elizabeth
                                            message=_"A-alright, p-point taken!"
                                        [/message]
                                        [message]
                                            speaker=merchant
#ifdef MULTIPLAYER
                                            message=_"(looks at Elizabeth's, $protagonist_name1|'s and $protagonist_name2|'s expressions) Ah, my sincere apologies, didn't mean to frighten you like that."
#else
                                            message=_"(looks at Elizabeth's and $protagonist_name1|'s expressions) Ah, my sincere apologies, didn't mean to frighten you like that."
#endif
                                        [/message]
                                    [/then]
                                    [else]
                                        [message]
                                            speaker=merchant
                                            message=_"A good merchant must know where to find customers, and so far my main customer is you, $protagonist_name1|, so I moved here for now."
                                        [/message]
                                    [/else]
                                [/if]
                                [message]
                                    id=Hoplite,Hoplite2
                                    message=_"Alright... Do you happen to know a way out of here?"
                                [/message]
                                [message]
                                    speaker=merchant
                                    message=_"My methods of travel... would not work for you. My advice to be to find a stable portal to Irdya. The spirits wandering this place cannot use them, but a mortal like yourself can."
                                [/message]
                                [if]
                                    [have_unit]
                                        id=Elizabeth
                                    [/have_unit]
                                    [then]
                                        [message]
                                            speaker=Elizabeth
                                            message=_"Your 'methods of travel'? 'mortal like yourself'? So you didn't use a portal, and can just freely travel between worlds?!"
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"Perhaps."
                                        [/message]
                                        [message]
                                            speaker=Elizabeth
                                            message=_"What sort of ability is that?! Only Death himself should be able to come and go as he pleases... what really are you?"
                                        [/message]
                                        [message]
                                            speaker=merchant
#ifdef MULTIPLAYER
                                            message=_"Some questions are best left unanswered, Miss Elizabeth. I offer my services and $protagonist_name1| or $protagonist_name2| can choose to partake. That is all."
#else
                                            message=_"Some questions are best left unanswered, Miss Elizabeth. I offer my services and $protagonist_name1| can choose to partake. That is all."
#endif
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"(to Elizabeth) I suppose he's right, we should focus more on trying to leave this place. What matters now is that this merchant is one of the few being here that isn't actively trying to kill us."
                                        [/message]
                                        [message]
                                            speaker=Elizabeth
                                            message=_"I suppose so..."
                                        [/message]
                                    [/then]
                                    [else]
                                        [message]
                                            id=Hoplite
                                            message=_"What are you then? You imply you aren't a mortal, yet somehow you don't quite seem like a wandering spirit either..."
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"Some questions are best left unanswered, $protagonist_name1|. What matters is that I offer you goods and pacts to help in your quest against Galatea, and you pay <span color='#a456ff'>Orbs of Insight</span> in return."
                                        [/message]
                                    [/else]
                                [/if]
                            [/then]
                            [else]
                                #TODO: add more randomly-chosen lines here

                                {VARIABLE_OP spartan_merchant_randline rand 1..5}

                                [switch]
                                    variable=spartan_merchant_randline
                                    [case]
                                        value=1
                                        [message]
                                            speaker=merchant
#ifdef MULTIPLAYER
                                            message=_"Welcome back, $protagonist_name1| and $protagonist_name2|! I hope you two brought some <span color='#a456ff'>Orbs of Insight</span>. If not, you can have a look at my pacts again instead."
#else
                                            message=_"Welcome back, $protagonist_name1|! I hope you brought some <span color='#a456ff'>Orbs of Insight</span>. If not, you can have a look at my pacts again instead."
#endif
                                        [/message]
                                    [/case]
                                    [case]
                                        value=2
                                        [message]
                                            speaker=merchant
#ifdef MULTIPLAYER
                                            message=_"We meet yet again, $protagonist_name1| and $protagonist_name2|, as expected. Have a look at my wares once more, for a fair price of <span color='#a456ff'>Orbs of Insight</span>."
#else
                                            message=_"We meet yet again, $protagonist_name1|, as expected. Have a look at my wares once more, for a fair price of <span color='#a456ff'>Orbs of Insight</span>."
#endif
                                        [/message]
                                    [/case]
                                    [case]
                                        value=3
                                        [message]
                                            speaker=merchant
#ifdef MULTIPLAYER
                                            message=_"Ah, $protagonist_name1| and $protagonist_name2|, good to see you two again! Did you find any more <span color='#a456ff'>Orbs of Insight</span> to trade?"
#else
                                            message=_"Ah, $protagonist_name1|, good to see you again! Did you find any more <span color='#a456ff'>Orbs of Insight</span> to trade?"
#endif
                                        [/message]
                                    [/case]
                                [/switch]

                                {CLEAR_VARIABLE spartan_merchant_randline}

                                #pact dealer got removed for now, since it was difficult to fit him into dialog
                                #	    [message]
                                #	        speaker=pact_dealer
                                #	    	message=_"If not, you can have a look at my pacts again instead..."
                                #       [/message]

                                #TODO: maybe make this not guaranteed to spawn. maybe make it random

                                {IF_VAR merchant_line_ashpile not_equals yes (
                                    [then]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"By the way, I've been wondering - this cave is swarming will all kinds of foes, yet your shops are some of the safest and quietest places I've seen here. How is that possible in such a dangerous location for business?"
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"Let me tell you a little story. A large squad of orcs was once passing by near my shop. When seeing a lone, wandering, seemingly unarmed merchant, they assumed I would be an easy target and tried to rob me. That was their biggest and final mistake."
                                        [/message]
                                        [sound]
                                            name=magic-faeriefire.ogg
                                        [/sound]
                                        {SCATTER_UNITS 1 "Hoplite_Dummy_Unit" 1 (
                                            terrain={SPARTAN_UNITSPAWN_TERRAIN}
                                            [not]
                                                x,y=$forge_x,$forge_y
                                            [/not]
                                            [and]
                                                [filter]
                                                    id=merchant
                                                    radius=2
                                                [/filter]
                                            [/and]
                                        ) (
                                            side=$hoplite_enemyside
                                        )}
                                        [store_unit]
                                            [filter]
                                                type=Hoplite_Dummy_Unit
                                            [/filter]
                                            variable=ash_pile_loc
                                            kill=yes
                                        [/store_unit]
                                        [item]
                                            image="items/ashpile.png"
                                            name=merchant_ashpile
                                            x,y=$ash_pile_loc.x,$ash_pile_loc.y
                                        [/item]
                                        {CLEAR_VARIABLE ash_pile_loc}
                                        [delay]
                                            time=1000
                                        [/delay]
                                        [message]
                                            speaker=merchant
                                            message=_"(points at the large ash pile) Behold, this is what is left of that orc squad. I spared exactly one of them, however, and told him that anyone who tries to rob my shops will meet the same fate. He fled as fast as his legs could carry him. After that, nobody in this place ever dared to disturb my business anymore."
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"<i>*gulp*</i> I see..."
                                        [/message]
                                        [sound]
                                            name=magic-faeriefire.ogg
                                        [/sound]
                                        [remove_item]
                                            image=merchant_ashpile
                                        [/remove_item]
                                        {VARIABLE merchant_line_ashpile yes}
                                    [/then]
                                )}
                            [/else]
                        [/if]
                    [/then]
                    [else]
                        #lines for meeting merchants first time each playthrough
                        {VARIABLE spartan_met_merchants_this_playthrough yes}

                        {VARIABLE_OP spartan_orbshop_data1.visited_across_playthroughs add 1}
#ifdef MULTIPLAYER
#ifndef LOCALMP
                        {VARIABLE_OP spartan_orbshop_data2.visited_across_playthroughs add 1}
#endif
#endif
                        {SPARTAN_SYNC_ORBSHOP_DATA}

                        #in MP, only host data for merchants is checked, for now
                        [switch]
                            variable=spartan_orbshop_data1.visited_across_playthroughs
                            [case]
                                value=1
#ifdef MULTIPLAYER
                                [message]
                                    id=Hoplite,Hoplite2
                                    message=_"What is this place..."
                                [/message]
                                [message]
                                    speaker=merchant
                                    message=_"Ah, greetings, $protagonist_name1| and $protagonist_name2| from Sparta."
                                [/message]
                                [message]
                                    id=Hoplite,Hoplite2
                                    message=_"(draws weapons) Who are you? What are you? How do you know us?"
                                [/message]
#else
                                [message]
                                    id=Hoplite,Hoplite2
                                    message=_"What is this place..."
                                [/message]
                                [message]
                                    speaker=merchant
                                    message=_"Ah, greetings, $protagonist_name1|, $spartan_classname_lowercase1| from Sparta."
                                [/message]
                                [message]
                                    id=Hoplite,Hoplite2
                                    message=_"(draws weapons) Who are you? What are you? How do you know me?"
                                [/message]
#endif
                                [message]
                                    speaker=merchant
                                    message=_"I assure you, I mean you no harm. I am a wandering merchant, but not just an ordinary one."
                                [/message]
                                [message]
                                    id=Hoplite,Hoplite2
#ifdef MULTIPLAYER
                                    message=_"(lowers weapons) Well, we do have some silver coins from my world. What do you sell?"
#else
                                    message=_"(lowers weapons) Well, I do have some silver coins from my world. What do you sell?"
#endif
                                [/message]
                                [message]
                                    speaker=merchant
                                    message=_"Ah, but unlike most I do not deal in silver or gold, or other petty mortal things. I seek <span color='#a456ff'>Orbs of Insight</span>, easily recognizable by their purple glow, these curious objects ended up here in Irdya after the rift between worlds opened. As for my wares, come here and have a look for yourself, perhaps something will catch your eye."
                                [/message]
                                [if]
                                    {VARIABLE_CONDITIONAL spartan_orbs_of_insight1 greater_than 0}
                                    [and]
                                        {VARIABLE_CONDITIONAL spartan_orbs_of_insight2 greater_than 0}
                                    [/and]
                                    [then]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"(Checks pockets, takes out an <span color='#a456ff'>Orb of Insight</span>) Alright, we do have such orbs with us. Might as well see what you got."
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"Excellent. Besides my wares, I can also offer you pacts."
                                        [/message]
                                        #pact dealer got removed for now, since it was difficult to fit him into dialog
                                        #	         [message]
                                        #	            speaker=pact_dealer
                                        #	        	message=_"Besides my brother's wares, perhaps my pacts could interest you too?"
                                        #            [/message]
                                    [/then]
                                    [elseif]
                                        {VARIABLE_CONDITIONAL spartan_orbs_of_insight1 greater_than 0}
                                        [then]
                                            [message]
                                                id=Hoplite
                                                message=_"(Checks pockets, takes out an <span color='#a456ff'>Orb of Insight</span>) Alright, I do have such orbs with me. Might as well see what you got."
                                            [/message]
                                            [message]
                                                speaker=merchant
                                                message=_"Excellent. Besides my wares, I can also offer you pacts."
                                            [/message]
                                        [/then]
                                    [/elseif]
                                    [elseif]
                                        {VARIABLE_CONDITIONAL spartan_orbs_of_insight2 greater_than 0}
                                        [then]
                                            [message]
                                                id=Hoplite2
                                                message=_"(Checks pockets, takes out an <span color='#a456ff'>Orb of Insight</span>) Alright, I do have such orbs with me. Might as well see what you got."
                                            [/message]
                                            [message]
                                                speaker=merchant
                                                message=_"Excellent. Besides my wares, I can also offer you pacts."
                                            [/message]
                                        [/then]
                                    [/elseif]
                                    [else]
                                        [message]
                                            id=Hoplite,Hoplite2
#ifdef MULTIPLAYER
                                            message=_"Alas it seems neither of us have such orbs at the moment."
#else
                                            message=_"Alas it seems I have no orbs with me at the moment."
#endif
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"Perhaps we can cross paths another time then. In the meantime, perhaps my pacts could interest you?"
                                        [/message]
                                    [/else]
                                [/if]
                                [message]
                                    id=Hoplite,Hoplite2
                                    message=_"Pacts?"
                                [/message]
                                [message]
                                    speaker=merchant
                                    message=_"I offer powerful boons... but each comes with a cost. Best read the fine print carefully."
                                [/message]
                                #pact dealer got removed for now, since it was difficult to fit him into dialog
                                #	         [message]
                                #	            speaker=pact_dealer
                                #	        	message=_"I offer powerful boons... but each comes with a curse. Best read the fine print carefully."
                                #            [/message]
                                [if]
                                    [have_unit]
                                        id=Algadur
                                    [/have_unit]
                                    [then]
                                        [message]
                                            speaker=Algadur
                                            # wmllint: local spelling Somethin
                                            message=_"(whispers) <i>Somethin' feels very off 'bout him, gives me goosebumps...</i>"
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"(whispers) <i>Looks unusual, yes, but he's one of the few beings in this place that aren't actively trying to kill us at least. We should be careful, but might as well have a look at his wares.</i>"
                                        [/message]
                                        [message]
                                            speaker=Algadur
                                            message=_"<i>Alright, if you say so...</i>"
                                        [/message]
                                    [/then]
                                [/if]
                            [/case]
                            #lines for visiting the shop after the first playthrough
                            [else]
                                #add more lines here
                                {IF_VAR spartan_orbshop_data1.visited_across_playthroughs greater_than 5 (
                                    [then]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            #	            message=_"This place... feels foreign, yet somehow disturbingly familiar... I cannot shake this strange feeling of deja vu, that I somehow already been here, over and over..."
                                            message=_"This place... feels foreign, yet somehow disturbingly familiar... I cannot shake this strange feeling of deja vu, that I somehow already been here, maybe even more than once..."
                                        [/message]
                                    [/then]
                                    [else]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"Something feels... off about this place, I can't quite put my finger on it, but it's nothing like the rest of the cave..."
                                        [/message]
                                    [/else]
                                )}
                                {IF_VAR spartan_orbshop_data1.orbs_spent greater_than_equal_to 10 (
                                    [then]
                                        [message]
                                            speaker=merchant
                                            message=_"Ah, welcome back, my favorite customer! Pleasure to see you again."
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"Favorite customer?! But... we haven't met... have we?"
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            #	        	message=_"It's hard to explain to most mortals, but let's just say we both did, and we did not..."
                                            message=_"Ah, pardon me, just a slip of the tongue, I assure you. What I meant to say was you look like the type of person that could become my next favorite customer."
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"You see, I am a wandering merchant, but not just an ordinary one. My currency is <span color='#a456ff'>Orbs of Insight</span>. With my collection of these <span size='small'><i>and my own powers</i></span>, it was easy to see your arrival in advance."
                                        [/message]
                                    [/then]
                                    [else]
#ifdef MULTIPLAYER
                                        [message]
                                            speaker=merchant
                                            message=_"Ah, greetings again, $protagonist_name1| and $protagonist_name2| from Sparta."
                                        [/message]
#else
                                        [message]
                                            speaker=merchant
                                            message=_"Ah, greetings again, $protagonist_name1|, $spartan_classname_lowercase1| from Sparta."
                                        [/message]
#endif
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"(draws weapons) Who are you? What are you? How do you know me? What do you mean about 'again'?"
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"I assure you, I mean you no harm. I am a wandering merchant, but not just an ordinary one. My currency is <span color='#a456ff'>Orbs of Insight</span>. With my collection of these <span size='small'><i>and my own powers</i></span>, it was easy to see your coming in advance."
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"(lowers weapons) I see..."
                                        [/message]
                                    [/else]
                                )}
                                [if]
                                    {VARIABLE_CONDITIONAL spartan_orbs_of_insight1 greater_than 0}
                                    [and]
                                        {VARIABLE_CONDITIONAL spartan_orbs_of_insight2 greater_than 0}
                                    [/and]
                                    [then]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"(Checks pockets, takes out an <span color='#a456ff'>Orb of Insight</span>) Alright, we do have such orbs with us. Might as well see what you got."
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"Excellent. Besides my wares, I can also offer you pacts."
                                        [/message]
                                        #pact dealer got removed for now, since it was difficult to fit him into dialog
                                        #	         [message]
                                        #	            speaker=pact_dealer
                                        #	        	message=_"Besides my brother's wares, perhaps my pacts could interest you too?"
                                        #            [/message]
                                    [/then]
                                    [elseif]
                                        {VARIABLE_CONDITIONAL spartan_orbs_of_insight1 greater_than 0}
                                        [then]
                                            [message]
                                                id=Hoplite
                                                message=_"(Checks pockets, takes out an <span color='#a456ff'>Orb of Insight</span>) Alright, I do have such orbs with me. Might as well see what you got."
                                            [/message]
                                            [message]
                                                speaker=merchant
                                                message=_"Excellent. Besides my wares, I can also offer you pacts."
                                            [/message]
                                        [/then]
                                    [/elseif]
                                    [elseif]
                                        {VARIABLE_CONDITIONAL spartan_orbs_of_insight2 greater_than 0}
                                        [then]
                                            [message]
                                                id=Hoplite2
                                                message=_"(Checks pockets, takes out an <span color='#a456ff'>Orb of Insight</span>) Alright, I do have such orbs with me. Might as well see what you got."
                                            [/message]
                                            [message]
                                                speaker=merchant
                                                message=_"Excellent. Besides my wares, I can also offer you pacts."
                                            [/message]
                                        [/then]
                                    [/elseif]
                                    [else]
                                        [message]
                                            id=Hoplite,Hoplite2
#ifdef MULTIPLAYER
                                            message=_"Alas it seems neither of us have such orbs at the moment."
#else
                                            message=_"Alas it seems I have no orbs with me at the moment."
#endif
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"Perhaps we can cross paths another time then. In the meantime, perhaps my pacts could interest you?"
                                        [/message]
                                    [/else]
                                [/if]
                                [message]
                                    id=Hoplite,Hoplite2
                                    message=_"Pacts?"
                                [/message]
                                [message]
                                    speaker=merchant
                                    message=_"I offer powerful boons... but each comes with a curse. Best read the fine print carefully."
                                [/message]
                                #pact dealer got removed for now, since it was difficult to fit him into dialog
                                #	        [message]
                                #	            speaker=pact_dealer
                                #	        	message=_"I offer powerful boons... but each comes with a curse. Best read the fine print carefully."
                                #            [/message]
                                [if]
                                    [have_unit]
                                        id=Algadur
                                    [/have_unit]
                                    [then]
                                        [message]
                                            speaker=Algadur
                                            message=_"(whispers) <i>Somethin' feels very off 'bout him, gives me goosebumps...</i>"
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"(whispers) <i>Looks unusual, yes, but he's one of the few beings in this place that aren't actively trying to kill us at least. We should be careful, but might as well have a look at his wares.</i>"
                                        [/message]
                                        [message]
                                            speaker=Algadur
                                            message=_"<i>Alright, if you say so...</i>"
                                        [/message]
                                    [/then]
                                [/if]
                            [/else]
                        [/switch]
                    [/else]
                [/if]

                #TODO: once I make the shop spawn in the underworld too, add underworld-specific lines
            [/then]
        [/if]
    [/event]
    [event]
        name=last breath
        first_time_only=yes
        [filter]
            type=Hoplite_Spider_Queen
        [/filter]
        [message]
            speaker=unit
            message=_"Damn you, $spartan_classname_lowercase1|! Damn you Athena for turning me into this! Damn you Galatea for giving me useless troops! Damn you AAAAAAAAAAAAAAAAAAAAALL!!!!..." #wmllint: no spellcheck
        [/message]
    [/event]
    [event]
        name=last breath
        first_time_only=yes
        [filter]
            type=Hoplite_Archmage
            [not]
                [filter_wml]
                    variation=shaxtal
                [/filter_wml]
            [/not]
        [/filter]
        {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 500 0}
#ifdef MULTIPLAYER
        [message]
            speaker=unit
            message=_"All the effort I put in to protect these priceless tomes from Galatea, ended by two of demon assassins..."
        [/message]
        [message]
            id=Hoplite
            message=_"Once again, neither of us is a demon!"
        [/message]
        [message]
            id=Hoplite2
            message=_"Nor are we on Galatea's side for that matter."
        [/message]

        {SPARTAN_DIALOG_MP_DEPENDING_ON_CLASS sorcerer (
        [message]
            speaker=unit
            message=_"If you are actually telling the truth, I have one... last wish. Take the most valuable spellbooks with you (points to a specific bookshelf) these ones, so they don't fall into the enemy's hands. You two are quite skilled mages, but I believe these books will help you improve even further."
        [/message]

        ) (
        [message]
            speaker=unit
            message=_"If you are actually telling the truth, I have one... last wish. Take the most valuable spellbooks with you (points to a specific bookshelf) these ones, so they don't fall into the enemy's hands. One of you is clearly a skilled mage, and even the other seems to show some magical potential."
        [/message]
        ) (
        [message]
            speaker=unit
            message=_"If you are actually telling the truth, I have one... last wish. Take the most valuable spellbooks with you (points to a specific bookshelf) these ones, so they don't fall into the enemy's hands. You two don't exactly look like mages, but somehow I sense a lot of magical potential in you, perhaps you can make use of them..."
        [/message]
        )}
#else
        [message]
            speaker=unit
            #	   message=_"All the effort I put in to preserve the little I could save from the Alduin academy, ended by one demon assassin..."
            message=_"All the effort I put in to protect these priceless tomes from Galatea, ended by one demon assassin..."
        [/message]
        [message]
            id=Hoplite,Hoplite2
            message=_"Once again, I am not a demon, nor am I on Galatea's side!"
        [/message]
        [if]
        {VARIABLE_CONDITIONAL spartan_selected_character1 equals sorcerer}
        [then]
        [message]
            speaker=unit
            message=_"If you are actually telling the truth, I have one... last wish. Take the most valuable spellbooks with you (points to a specific bookshelf) these ones, so they don't fall into the enemy's hands. You are clearly quite a skilled mage, but I believe these books will help you improve even further."
        [/message]
        [/then]
        [else]
        [message]
            speaker=unit
            message=_"If you are actually telling the truth, I have one... last wish. Take the most valuable spellbooks with you (points to a specific bookshelf) these ones, so they don't fall into the enemy's hands. You don't exactly look like a mage, but somehow I sense a lot of magical potential in you, perhaps you can make use of them..."
        [/message]
        [/else]
        [/if]
#endif
        [message]
            speaker=unit
            message=_"And if you ever run into... my apprentice Elizabeth, please don't tell her... that you... fatally wounded me. I don't want to continue the cycle of pointless bloodshed that I started..."
        [/message]
        [message]
            id=Hoplite,Hoplite2
            # wmllint: local spelling Pyromancy
#ifdef MULTIPLAYER
            message=_"Very well, we will honor your request. (takes the books) Let's see... 'Advanced Teleportation', 'Enthralling', 'Pyromancy' and more. Definitely worth giving it a read."
#else
            message=_"Very well, I will honor your request. (takes the books) Let's see... 'Advanced Teleportation', 'Enthralling', 'Pyromancy' and more. Definitely worth giving it a read."
#endif
        [/message]

        #TODO idea: add option to spare the archmage if you have the healing potion upgrade
        #TODO: sparing the archmage could be one of the steps required to get true ending

        #	[message]
        #	   speaker=unit
        #	   message=_"You have won this fight, but that does not mean won the war. If the Chaos Empire seizes the Prometheus' Heart, then they will only be even closer to their goals. *sigh* All the effort I put in to preserve the little I could save from the Alduin academy, only to soon go to waste. If you truly intend to destroy the place, at least spare the spellbooks..."
        #	[/message]
    [/event]
    [event]
        name=last breath
        first_time_only=yes
        [filter]
            type=Hoplite_Ares
        [/filter]
        [message]
            speaker=unit
            message=_"You've proven yourself more than worthy. Take the holy armaments and continue your quest!"
        [/message]
    [/event]
    [event]
        name=last breath
        first_time_only=yes
        [filter]
            type=Hoplite_Archmage
            [filter_wml]
                variation=shaxtal
            [/filter_wml]
        [/filter]
        {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 500 0}
        [message]
            speaker=unit
            message=_"Error: critical condition. Reporting mission failure. Initiating shutdown and memory wipe."
        [/message]
    [/event]
    #TODO: investigate whether this dialog even triggers properly
    [event]
        name=die
        id=shaxtal_death_dialog
        first_time_only=yes
        [filter]
            type=Hoplite_Archmage
            [filter_wml]
                variation=shaxtal
            [/filter_wml]
        [/filter]
        [message]
            speaker=Elizabeth
            message=_"Wow... just wow... to think we have just brought down this abomination..."
        [/message]
        [message]
            speaker=Algadur
            message=_"Aye, find it hard ta believe it too."
        [/message]
        [message]
            speaker=Elizabeth
            message=_"We may have barely escaped the Chaos Empire's grip, but at the same time made them view us as more than just mere rabble. We must find the gem as soon as we can, and flee as far as possible, else this won't be the worst we'll see of their wrath."
        [/message]
    [/event]
    [event]
        name=last breath
        first_time_only=yes
        [filter]
            type=Hoplite_Donovan
        [/filter]
        {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 500 0}
        [if]
            [have_unit]
                id=Hoplite2
            [/have_unit]
            [then]
                {IF_VAR spartan_selected_character1 equals $spartan_selected_character2 (
                [then]
                [message]
                    speaker=unit
                    message=_"I lost... lost to two $spartan_classname_lowercase1|s, even with all the ice magic I had... I failed be useful to Galatea..."
                [/message]
                [/then]
                [else]
                [message]
                    speaker=unit
                    message=_"I lost... lost to a $spartan_classname_lowercase1| and a $spartan_classname_lowercase2|, even with all the ice magic I had... I failed be useful to Galatea..."
                [/message]
                [/else]
                )}
            [/then]
            [else]
                [message]
                    speaker=unit
                    message=_"I lost... lost to one damn $spartan_classname_lowercase1|, even with all the ice magic I had... I failed be useful to Galatea..."
                [/message]
            [/else]
        [/if]
    [/event]
    [event]
        name=last breath
        first_time_only=yes
        [filter]
            type=Hoplite_Scylla
        [/filter]
        {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 500 0}
        [message]
            speaker=unit
            message=_"You may have besssted me, human, but know that the other Stormtails will avenge my death..." #wmllint: no spellcheck
        [/message]
    [/event]
    [event]
        name=last breath
        first_time_only=yes
        [filter]
            type=Hoplite_Warlock
        [/filter]
        [message]
            speaker=unit
            #	   message=_"Hail... Uria..."
            message=_"Hail... Galatea..."
        [/message]
    [/event]
    [event]
        name=die
        first_time_only=yes
        [filter]
            type=Hoplite_Donovan
        [/filter]
        [if]
            [have_unit]
                id=Algadur
            [/have_unit]
            [then]
                [message]
                    speaker=Algadur
                    #	   message=_"Serves 'im right, that lunatic! Them bloody demon-worshippers deserve far worse than death for what they've done ta my kind!"
                    message=_"Serves 'im right, that Galatea-worshipping lunatic!"
                [/message]
            [/then]
        [/if]
    [/event]
    [event]
        name=last breath
        first_time_only=yes
        [filter]
            type=Hoplite_Grimreaper
        [/filter]
        {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 1000 0}
        [message]
            speaker=unit
            message=_"..."
        [/message]
        [delay]
            time=500
        [/delay]
        [message]
            speaker=unit
            message=_"Very well, mortal, that was rather entertaining. You have earned the right to return to the mortal realm, and retain your existence for now. I have to leave now, as there are still thousands of souls left for me to harvest..."
        [/message]
    [/event]
    [event]
        name=last breath
        first_time_only=yes
        [filter]
            id=inferno8
            side=$hoplite_enemyside
        [/filter]
        [message]
            speaker=unit
            message=_"As they say, the fire that burns twice as bright... burns half as long..."
        [/message]
    [/event]
    [event]
        name=last breath
        first_time_only=yes
        [filter]
            id=inferno8_matriarch
            side=$hoplite_enemyside
        [/filter]
        [message]
            speaker=unit
            message=_"Argh, not only did I not find my original prey, but I even failed to kill a substitute... The dark gods won't be pleased with me in the afterlife..."
        [/message]
    [/event]
    [event]
        name=last breath
        first_time_only=yes
        [filter]
            id=Heindal
            side=$hoplite_enemyside
        [/filter]
        [message]
            speaker=unit
            message=_"You scumbag ... arggghh."
        [/message]
    [/event]
    [event]
        name=spartan_enthrall
        first_time_only=yes
        [filter]
            id=Jeremias
        [/filter]
        [message]
            speaker=unit
            message=_"Um, I'll help, but only if the danger stays, like, really far away from me."
        [/message]
    [/event]
    [event]
        name=spartan_enthrall
        first_time_only=yes
        [filter]
            id=inferno8
        [/filter]
        [message]
            speaker=unit
            message=_"Somehow my rage towards you... just disappeared. My apologies about the whole 'trying to burn you to death' situation. I decided that from now on I will burn your enemies instead!"
        [/message]
        [message]
            speaker=second_unit
            message=_"Very well."
        [/message]
    [/event]
    [event]
        name=spartan_enthrall
        first_time_only=yes
        [filter]
            id=inferno8_matriarch
        [/filter]
        [message]
            speaker=unit
            message=_"<i>*blushes*</i> A mind control spell? My, my, you're a far more interesting man than you seemed at first glance, not like those boring sun-worshippers I mistook you for. *giggles*"
        [/message]
        [message]
            speaker=second_unit
            message=_"Wait, you saw through the spell?"
        [/message]
        [message]
            speaker=unit
            message=_"Yes, spells like that are somewhat common in my homeland, so I've gotten good at repelling them. But honestly I am impressed enough that I'll tag along with you anyway!"
        [/message]
        [message]
            speaker=unit
            message=_"I can do all sorts of things for you even without the spell *winks*"
        [/message]
        [if]
            [have_unit]
                id=Elizabeth
            [/have_unit]
            [then]
                [message]
                    speaker=second_unit
                    message=_"Erm, well... While I do admit you are quite attractive..."
                [/message]
                [message]
                    speaker=Elizabeth
                    message=_"Snap out of it, $protagonist_name$second_unit.side||! She tried to kill us not to long ago, don't just fall for her seduction!"
                [/message]
                [message]
                    speaker=unit
                    message=_"Don't ruin the moment, damn it! Are you perhaps... jealous? *giggles*"
                [/message]
                [message]
                    speaker=Elizabeth
                    message=_"..."
                [/message]
                [message]
                    speaker=second_unit
                    message=_"Alright, ladies, let's just return to combat for now, we can sort this out later."
                [/message]
                [message]
                    speaker=unit
                    message=_"Very well. Time to slice your enemies into tiny bits!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=second_unit
                    message=_"Erm, well... While I do admit you are quite attractive, we're also in the middle of a battle right now, not exactly the best time nor place for what you are suggesting."
                [/message]
                [message]
                    speaker=unit
                    message=_"Very well, we can discuss this some other time. Time to slice your enemies into tiny bits!"
                [/message]
            [/else]
        [/if]
    [/event]
    [event]
        name=spartan_enthrall
        first_time_only=yes
        [filter]
            id=Heindal
        [/filter]
        [message]
            speaker=unit
            message=_"Maybe you are not such a loudmouth after all... I'll join you."
        [/message]
    [/event]
    [event]
        name=die
        first_time_only=yes
        [filter]
            type=Hoplite_Grimreaper
        [/filter]
        [message]
            speaker=Elizabeth
            message=_"(heavy breathing) We... did it? My goodness, we actually did it!"
        [/message]
        [message]
            speaker=Algadur
            message=_"Ta think I'd 'ave ta fight the Death it-bloody-self! 'tis was quite the day, admittedly."
        [/message]
        [message]
            id=Hoplite,Hoplite2
            message=_"No time for chit-chat, we must hurry to the portal at once!"
        [/message]
    [/event]
    [event]
        name=last breath
        first_time_only=no
        [filter]
            id=Algadur
            type=Hoplite_Steelclad
        [/filter]
        [message]
            speaker=unit
            message=_"Argh... ye orcish swines won't get me today. I'll shall avenge my brothers later, but now I must run..."
        [/message]
        {MOVE_UNIT id=Algadur 6 2}
        [kill]
            id=Algadur
            animate=no
            fire_event=no
        [/kill]
    [/event]
    [event]
        name=last breath
        first_time_only=no
        [filter]
            side=$hoplite_allyside
            ability=hoplite_companion
        [/filter]
        [switch]
            variable=unit.type
            [case]
                value=Hoplite_Elizabeth
                [message]
                    speaker=unit
                    message=_"Uh... I'm pretty darn wounded. Got to go now, I'll catch up with you later!"
                [/message]
                #curse makes allies take 1 depth longer to respawn
                [if]
                    {VARIABLE_CONDITIONAL unit.status.unhealable equals yes}
                    [then]
                        [message]
                            speaker=unit
                            message=_"Damn it, I'm cursed! I will take longer to recover than usual..."
                        [/message]
                    [/then]
                [/if]
                {MOVE_UNIT type=Hoplite_Elizabeth 6 10}
                [store_unit]
                    [filter]
                        id=Elizabeth
                    [/filter]
                    variable=Elizabeth_stored
                    kill=yes
                [/store_unit]
                {VARIABLE Elizabeth_stored.hitpoints $Elizabeth_stored.max_hitpoints}
                {CLEAR_VARIABLE Elizabeth_stored.status.poisoned}
                {CLEAR_VARIABLE Elizabeth_stored.status.slowed}
                {VARIABLE elizabeth_cooldown 3}
                {IF_VAR companion_recovery_unlocked1 equals yes (
                    [or]
                        {VARIABLE_CONDITIONAL companion_recovery_unlocked2 equals yes}
                    [/or]
                    [then]
                        {VARIABLE elizabeth_cooldown 2}
                    [/then]
                )}
                {IF_VAR companion_recoveryII_unlocked1 equals yes (
                    [or]
                        {VARIABLE_CONDITIONAL companion_recoveryII_unlocked2 equals yes}
                    [/or]
                    [then]
                        {VARIABLE elizabeth_cooldown 1}
                    [/then]
                )}
                #curse makes allies take 1 depth longer to respawn
                {IF_VAR Elizabeth_stored.status.unhealable equals yes (
                    [then]
                        {VARIABLE_OP elizabeth_cooldown add 1}
                    [/then]
                )}
            [/case]
            [case]
                value=Hoplite_Steelclad2
                [message]
                    speaker=unit
                    message=_"I 'ave to go heal my wounds, and catch up with ye later. I ain't gonna be of any use to ya dead."
                [/message]
                #curse makes allies take 1 depth longer to respawn
                [if]
                    {VARIABLE_CONDITIONAL unit.status.unhealable equals yes}
                    [then]
                        [message]
                            speaker=unit
                            message=_"Argh, I'm cursed! Gonna take longer ta recover than usual..."
                        [/message]
                    [/then]
                [/if]
                {MOVE_UNIT type=Hoplite_Steelclad2 6 10}
                [store_unit]
                    [filter]
                        id=Algadur
                    [/filter]
                    variable=Algadur_stored
                    kill=yes
                [/store_unit]
                {VARIABLE Algadur_stored.hitpoints $Algadur_stored.max_hitpoints}
                {CLEAR_VARIABLE Algadur_stored.status.poisoned}
                {CLEAR_VARIABLE Algadur_stored.status.slowed}
                {VARIABLE algadur_cooldown 3}
                {IF_VAR companion_recovery_unlocked1 equals yes (
                    [or]
                        {VARIABLE_CONDITIONAL companion_recovery_unlocked2 equals yes}
                    [/or]
                    [then]
                        {VARIABLE algadur_cooldown 2}
                    [/then]
                )}
                {IF_VAR companion_recoveryII_unlocked1 equals yes (
                    [or]
                        {VARIABLE_CONDITIONAL companion_recoveryII_unlocked2 equals yes}
                    [/or]
                    [then]
                        {VARIABLE algadur_cooldown 1}
                    [/then]
                )}
                #curse makes allies take 1 depth longer to respawn
                {IF_VAR Algadur_stored.status.unhealable equals yes (
                    [then]
                        {VARIABLE_OP algadur_cooldown add 1}
                    [/then]
                )}
            [/case]
        [/switch]
    [/event]
    [event]
        name=die
        id=algadur_axe_line
        first_time_only=yes
        [filter]
            [not]
                ability=hoplite_boss
            [/not]
        [/filter]
        [filter_second]
            side=$hoplite_playerside
        [/filter_second]
        [filter_second_attack]
            name=axe
        [/filter_second_attack]
        [filter_condition]
            [have_unit]
                id=Algadur
            [/have_unit]
        [/filter_condition]
        [message]
            speaker=Algadur
            message=_"I see ye wield an axe too, eh? Good choice!"
        [/message]
        {VARIABLE algadur_line_axe yes}
    [/event]
    [event]
        name=die
        id=algadur_axe_boss_line
        first_time_only=yes
        [filter]
            ability=hoplite_boss
        [/filter]
        [filter_second]
            side=$hoplite_playerside
        [/filter_second]
        [filter_second_attack]
            name=axe
        [/filter_second_attack]
        [filter_condition]
            [have_unit]
                id=Algadur
            [/have_unit]
        [/filter_condition]
        [message]
            speaker=Algadur
            message=_"As ye've just demonstrated, a good axe can fell even the mightiest of foes!"
        [/message]
        {VARIABLE algadur_line_axe_boss yes}
    [/event]
    #for when Algadur kills a tough orc, like a Warlord:
    [event]
        name=die
        id=algadur_lvl3_orc_line
        first_time_only=yes
        [filter]
            level=3
            race=orc
        [/filter]
        [filter_second]
            id=Algadur
        [/filter_second]
        [message]
            speaker=Algadur
            message=_"This is for the brothers you and your kind have slain, you oversized gnat!"
        [/message]
        {VARIABLE algadur_line_lvl3orc yes}
    [/event]
    [event]
        name=spartan_custom_predescent_events
        id=spartan_pre_descent_dialog
        first_time_only=yes
        [filter_condition]
            [have_unit]
                id=Jeremias
                side=$hoplite_enemyside
            [/have_unit]
        [/filter_condition]
        #dialog if jeremias unit survives
        [message]
            speaker=Jeremias
            message=_"That was close! Damn heroes."
        [/message]
        [message]
            speaker=Jeremias
            message=_"And the mess they make. Who's supposed to clean up after them?"
        [/message]
    [/event]
    [event]
        id=spartan_charybdis_death
        name=die
        first_time_only=no
        [filter]
            id=Charybdis
        [/filter]
        [message]
            speaker=Scylla
            message=_"You will pay for killing my favorite pet, human bassstard!" #wmllint: no spellcheck
        [/message]
        #TODO: maybe summon reinforcements here
    [/event]
    #dialog moved from level generation file
    [event]
        id=spartan_portaldialog_return
        first_time_only=no
        {IF_VAR elizabeth_line_return not_equals yes (
            [and]
                [have_unit]
                    id=Elizabeth
                [/have_unit]
            [/and]
            [then]
                [message]
                    speaker=Elizabeth
                    message=_"Fresh air! Freedom, at last! This better not be a dream again... (pinches herself) Yep, this is real. Whew..."
                [/message]
                [delay]
                    time=500
                [/delay]
                [message]
                    speaker=Elizabeth
                    message=_"Now that I'm back, I wonder just how much the world has changed while I was gone, just how many years have passed, and how Master Arcanus is doing without me..."
                [/message]

                {IF_VAR archmage_spared equals yes (
                    [then]
                        #TODO: expand this dialog later
                        [message]
                            id=Hoplite
                            message=_"He was alive and well last time I saw him at least."
                        [/message]
                    [/then]
                    [elseif]
                        {VARIABLE_CONDITIONAL archmage_beaten equals yes}
                        [then]
                            #TODO: maybe improve the dialog later too
                            [message]
                                id=Hoplite
                                message=_"<i>*somberly looks down*</i>"
                            [/message]
                            {IF_VAR algadur_line_archmage equals yes (
                                [then]
                                    [message]
                                        speaker=Algadur
                                        message=_"<i>*somberly looks down*</i>"
                                    [/message]
                                [/then]
                            )}
                            [message]
                                speaker=Elizabeth
                                message=_"What's with your expression all of the sudden?"
                            [/message]
                            [message]
                                id=Hoplite
                                message=_"<i>*sigh*</i> He is... no longer with us."
                            [/message]
                            [message]
                                speaker=Elizabeth
                                message=_"<span size='large'>W-Wait what, he died while I was in the underworld? *sobs* No, it can't be... What a cruel irony, I escape the underworld only to find my mentor dead...</span>"
                            [/message]
                            [message]
                                id=Hoplite
                                message=_"His last wish was for me to guard his most prized spellbooks so they do not fall in Galatea's hands."
                            [/message]
                            [message]
                                speaker=Elizabeth
                                message=_"I see..."
                            [/message]
                        [/then]
                    [/elseif]
                    [else]
                        #in the rare condition (like debug) where elizabeth returns to the underworld while the archmage is neither killed nor spared, say nothing
                    [/else]
                )}

                {VARIABLE elizabeth_line_return yes}
            [/then]
        )}
        {IF_VAR algaur_line_return not_equals yes (
            [and]
                [have_unit]
                    id=Algadur
                [/have_unit]
            [/and]
            [then]
                [message]
                    speaker=Algadur
                    message=_"Whew... back to good ol' caves."
                [/message]
                {VARIABLE algadur_line_return yes}
            [/then]
        )}
    [/event]
#enddef
