#textdomain wesnoth-Hoplite

#define HOPLITE_PORTALMENU
    [message]
        speaker=narrator
        caption=_ "Blue Portal"
        message=_ "This circle looks similar to the one that got you here, It may be the way back to the mortal realm. Do you touch it?"
        image=scenery/summoning-center.png~SCALE(216,216)
        [option]
            image="scenery/summoning-center.png"
            description=_"Yes"
            [command]
                [set_variable]
                    name=portal_entrydepth
                    value=$hoplite_depth
                [/set_variable]
                {COLOR_ADJUST 80 80 80}
                {COLOR_ADJUST 150 150 150}
                [sound]
                    name=lightning.ogg
                [/sound]
                [set_variable]
                    name=hoplite_depth
                    value=$darkportal_entrydepth
                [/set_variable]
                [set_variable]
                    name=darkportal_active
                    value=no
                [/set_variable]
                {IF_VAR hoplite_depth greater_than 39 (
                    [then]
                        {VARIABLE hoplite_stairway yes}
                    [/then])}
                    [sound]
                        name={SOUND_LIST:HOLY}
                    [/sound]
                    {COLOR_ADJUST -512 -512 -512}
                    [delay]
                        time=2000
                    [/delay]
                    [set_variable]
                        name=depthdescent_nofade
                        value=yes
                    [/set_variable]
                    [fire_event]
                        id=hoplite_depthdescent
                    [/fire_event]
                    {CLEAR_VARIABLE depthdescent_nofade}
                    {ACHIEVEMENT_MESSAGE return}
                    {CLEAR_VARIABLE random}
                    [set_variable]
                        name=hoplite_usedportal
                        value=yes
                    [/set_variable]
                    [fire_event]
                        id=spartan_portaldialog_return
                    [/fire_event]
                [/command]
            [/option]
            [option]
                image="misc/blank-hex.png"
                description=_"No"
                [command]
                [/command]
            [/option]
        [/message]
#enddef

#define HOPLITE_DARKPORTALMENU
    {IF_VAR elizabeth_line_portal not_equals yes (
        [and]
            [have_unit]
                id=Elizabeth
            [/have_unit]
        [/and]
        [then]
            [message]
                speaker=Elizabeth
                message=_"Wait a second, this is exactly like the accursed portal that brought me into the underworld! I don't know about you, but I sure as hell am not going back there!"
            [/message]
            {VARIABLE elizabeth_line_portal yes}
        [/then])}
        {IF_VAR dark_portal_entrydepth greater_than 0 (
            [and]
                [have_unit]
                    id=Algadur
                [/have_unit]
            [/and]
            [and]
                {VARIABLE_CONDITIONAL algadur_line_portal2b not_equals yes}
            [/and]
            [then]
                [message]
                    speaker=Algadur
                    message=_"Aye, the lass over 'ere is right. We should stay clear from these things!"
                [/message]
                {VARIABLE algadur_line_portal2b yes}
            [/then]
            [elseif]
                [have_unit]
                    id=Algadur
                [/have_unit]
                [and]
                    {VARIABLE_CONDITIONAL algadur_line_portal1 not_equals yes}
                [/and]
                [and]
                    {VARIABLE_CONDITIONAL algadur_line_portal2 not_equals yes}
                [/and]
                [then]
                    [message]
                        speaker=Algadur
                        message=_"Are ye sure ye want to mess with 'tis thing? I don't like the look of it..."
                    [/message]
                    {VARIABLE algadur_line_portal1 yes}
                [/then]
            [/elseif])}
            [message]
                speaker=narrator
                caption=_ "Dark Portal"
                message=_ "You find a strange circle on the floor with an inscription written in an unknown language. Do you touch it?"
                image=scenery/summoning-center.png~SCALE(216,216)~GS()~CS(150,0,180)
                [option]
                    image="misc/blank-hex.png"
                    description=_"No"
                    [command]
                        {IF_VAR algadur_line_portal2 not_equals yes (
                            [and]
                                [have_unit]
                                    id=Algadur
                                [/have_unit]
                            [/and]
                            [then]
                                [message]
                                    speaker=Algadur
                                    message=_"Aye, good choice."
                                [/message]
                                {VARIABLE algadur_line_portal2 yes}
                            [/then])}
                            {IF_VAR elizabeth_line_portal1 not_equals yes (
                                [and]
                                    [have_unit]
                                        id=Elizabeth
                                    [/have_unit]
                                [/and]
                                [then]
                                    [message]
                                        speaker=Elizabeth
                                        message=_"Yeah, let's get going."
                                    [/message]
                                    {VARIABLE elizabeth_line_portal1 yes}
                                [/then])}
                            [/command]
                        [/option]
                        [option]
                            image="scenery/summoning-center.png~GS()~CS(150,0,180)"
                            description=_"Yes"
                            [command]
                                [if]
                                    [have_unit]
                                        id=Elizabeth
                                    [/have_unit]
                                    [then]
                                        {IF_VAR elizabeth_line_portal2 not_equals yes (
                                            [then]
                                                [message]
                                                    speaker=Elizabeth
                                                    message=_"*sigh* If you really, really want to go there, feel free to, but I am staying here."
                                                [/message]
                                                {VARIABLE elizabeth_line_portal2 yes}
                                            [/then])}
                                            [store_unit]
                                                [filter]
                                                    id=Elizabeth
                                                [/filter]
                                                variable=Elizabeth_stored
                                                kill=yes
                                            [/store_unit]
                                            {VARIABLE Elizabeth_stored.hitpoints $Elizabeth_stored.max_hitpoints}
                                            {VARIABLE elizabeth_cooldown 0}
                                            {VARIABLE elizabethstays yes}
                                        [/then]
                                    [/if]
                                    {IF_VAR algadur_line_portal3 not_equals yes (
                                        [and]
                                            [have_unit]
                                                id=Algadur
                                            [/have_unit]
                                        [/and]
                                        [then]
                                            [message]
                                                speaker=Algadur
                                                message=_"Though I loath the idea, I do owe ya a lot... *sigh*"
                                            [/message]
                                            {VARIABLE algadur_line_portal3 yes}
                                        [/then])}
                                        [set_variable]
                                            name=darkportal_entrydepth
                                            value=$hoplite_depth
                                        [/set_variable]
                                        {COLOR_ADJUST 80 80 80}
                                        {COLOR_ADJUST 150 150 150}
                                        [sound]
                                            name=lightning.ogg
                                        [/sound]
                                        {IF_VAR portal_entrydepth less_than 0 (
                                            [then]
                                                {VARIABLE hoplite_depth $portal_entrydepth}
                                            [/then]
                                            [else]
                                                {RANDOM -0..-3}
                                                {VARIABLE hoplite_depth $random}
                                            [/else])}
                                            {VARIABLE darkportal_active yes}
                                            {VARIABLE hoplite_stairway no}
                                            [sound]
                                                name={SOUND_LIST:LICH_HIT}
                                            [/sound]
                                            {COLOR_ADJUST -512 -512 -512}
                                            [delay]
                                                time=1000
                                            [/delay]
                                            [set_variable]
                                                name=depthdescent_nofade
                                                value=yes
                                            [/set_variable]
                                            [fire_event]
                                                id=hoplite_depthdescent
                                            [/fire_event]
                                            {CLEAR_VARIABLE random}
                                            {VARIABLE hoplite_usedportal yes}
                                        [/command]
                                    [/option]
                                [/message]
#enddef

#define HOPLITE_GENERATE_TERRAIN
    {RANDOM 2..4}
    {SCATTER_UNITS $random "Hoplite_Dummy_Unit" 2 (
        terrain=Ur
        x=4-8
        y=4-7
        [not]
            [filter]
            [/filter]
            [or]
                [filter]
                    type=Hoplite_Dummy_Unit
                [/filter]
                radius=3
            [/or]
            [or]
                [filter]
                    y=0-3
                [/filter]
            [/or]
            [or]
                [filter]
                    x=4-8
                    y=8-10
                [/filter]
            [/or]
        [/not]
    ) (
        side=$hoplite_enemyside
        max_moves=2
    )}
    [store_unit]
        [filter]
            type=Hoplite_Dummy_Unit
            [filter_wml]
                max_moves=2
            [/filter_wml]
        [/filter]
        variable=lavastart
    [/store_unit]

    [foreach]
        array=lavastart
        index_var=a
        [do]
            {RANDOM 2..4}
            {REPEAT $random (
                {UNIT 2 Hoplite_Dummy_Unit $this_item.x $this_item.y ()}
            )}
        [/do]
    [/foreach]
    [kill]
        type=Hoplite_Dummy_Unit
        [filter_location]
            terrain=!,Ur
        [/filter_location]
    [/kill]
    [store_unit]
        [filter]
            type=Hoplite_Dummy_Unit
        [/filter]
        variable=lava
    [/store_unit]
    [foreach]
        array=lava
        index_var=a
        [do]
            {IF_VAR hoplite_depth less_than 0 (
                [then]
                    [terrain]
                        x,y=$this_item.x,$this_item.y
                        terrain=Qxua
                    [/terrain]
                [/then]
                #   [elseif]
                #   [variable]
                #       name=hoplite_depth
                #       less_than=5
                #   [/variable]
                #   [and]
                #   [variable]
                #       name=hoplite_depth
                #       greater_than_equal_to=0
                #   [/variable]
                #   [/and]
                #   [then]
                #        [terrain]
                #       x,y=$this_item.x,$this_item.y
                #            terrain=Qxu
                #        [/terrain]
                #   [/then]
                #   [/elseif]
                [else]
                    [terrain]
                        x,y=$this_item.x,$this_item.y
                        terrain=Qlf
                    [/terrain]
                [/else])}
                [kill]
                    id=$this_item.id
                    animate=no
                    fire_event=no
                [/kill]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE lavastart}
        {CLEAR_VARIABLE lava}
        {IF_VAR hoplite_depth less_than 0 (
            [then]
                [store_locations]
                    [filter_location]
                        terrain=Xu*^*
                    [/filter_location]
                    variable=walls
                [/store_locations]
                [foreach]
                    array=walls
                    index_var=a
                    [do]
                        [if]
                            [have_location]
                                x,y=$this_item.x,$this_item.y
                                terrain=Xu*^*
                            [/have_location]
                            [then]
                                [terrain]
                                    x,y=$this_item.x,$this_item.y
                                    terrain=Qxua
                                [/terrain]
                            [/then]
                        [/if]
                    [/do]
                [/foreach]

                [terrain]
                    x=0-99
                    y=0
                    terrain=Qxua
                [/terrain]
                [terrain]
                    x=0
                    y=0-99
                    terrain=Qxua
                [/terrain]
                [terrain]
                    x=0-99
                    y=0
                    terrain=Qxua
                [/terrain]
                [terrain]
                    x=12
                    y=0-99
                    terrain=Qxua
                [/terrain]
                [terrain]
                    x=0-99
                    y=11
                    terrain=Qxua
                [/terrain]
                #        [terrain]
                #	    [filter_location]
                #	       terrain=Xu*
                #	    [/filter_location]
                #            terrain=Qxur
                #        [/terrain]
                {CLEAR_VARIABLE walls}
            [/then])}
#enddef
#define HOPLITE_GENERATE_FORGE X Y
    {VARIABLE_OP forge_delay add 1}
    [if]
        [have_unit]
            ability=hoplite_boss
        [/have_unit]
        [and]
            {VARIABLE_CONDITIONAL spartan_difficulty_values.boss_goldenforges equals yes}
        [/and]
        [then]
            {VARIABLE goldenforge yes}
        [/then]
    [/if]

    {IF_VAR forge_delay greater_than_equal_to 1 (
        [and]
            [variable]
                name=hoplite_depth
                less_than_equal_to=30
            [/variable]
        [/and]
        [and]
            [variable]
                name=hoplite_depth
                greater_than_equal_to=0
            [/variable]
        [/and]
        [or]
            [variable]
                name=forge_delay
                greater_than_equal_to=2
            [/variable]
            [and]
                [variable]
                    name=hoplite_depth
                    greater_than=30
                [/variable]
                [and]
                    [variable]
                        name=hoplite_depth
                        less_than_equal_to=50
                    [/variable]
                [/and]
                [or]
                    [variable]
                        name=hoplite_depth
                        less_than=0
                    [/variable]
                    [and]
                        [variable]
                            name=hoplite_depth
                            greater_than_equal_to=-10
                        [/variable]
                    [/and]
                [/or]
            [/and]
        [/or]
        [or]
            [variable]
                name=forge_delay
                greater_than_equal_to=3
            [/variable]
            [and]
                [variable]
                    name=hoplite_depth
                    greater_than=50
                [/variable]
                [or]
                    [variable]
                        name=hoplite_depth
                        less_than=-10
                    [/variable]
                [/or]
            [/and]
        [/or]
        [then]
            {SCATTER_UNITS 1 "Hoplite_Dummy_Unit" 2 (
                terrain=U*^*,Urb^*,D*^*,A*^*,R*^*,G*f*,Iwr^*
                [not]
                    terrain={SPARTAN_WALL_TERRAIN},*^F*
                [/not]
                x={X}
                y={Y}
                [not]
                    [filter]
                    [/filter]
                [/not]
                [not]
                    terrain=*^Wyb
                [/not]
            ) (
                side=$hoplite_enemyside
            )}
            [store_unit]
                [filter]
                    type=Hoplite_Dummy_Unit
                [/filter]
                variable=forge
                kill=yes
            [/store_unit]
            {IF_VAR goldenforge equals yes (
                [then]
                    [item]
                        image=terrain/forge-golden-working.png
                        x,y=$forge.x,$forge.y
                    [/item]
                [/then]
                [else]
                    [item]
                        image=terrain/forge-working.png
                        x,y=$forge.x,$forge.y
                    [/item]
                [/else]
            )}
            {VARIABLE forge_x $forge.x}
            {VARIABLE forge_y $forge.y}
            {VARIABLE haveforge yes}
            {VARIABLE usedforge no}
            {CLEAR_VARIABLE forge}
            {CLEAR_VARIABLE forge_delay}
        [/then])}
#enddef
#define HOPLITE_SCATTER_ENEMY NUMBER TYPE TERRAIN
    [set_variable]
        name=hoplite_scatterenemy_count
        value={NUMBER}
    [/set_variable]
#ifdef MULTIPLAYER
    [set_variable]
        name=hoplite_scatterenemy_count
        multiply=1.5
    [/set_variable]
#endif
    [set_variable]
        name=hoplite_scatterenemy_count
        multiply=$spartan_difficulty_values.spawnrate_mult
    [/set_variable]
    [set_variable]
        name=hoplite_scatterenemy_count
        round=ceiling
    [/set_variable]
    #enemies are more clustered together as the depths progress
    {IF_VAR hoplite_scatterenemy_count greater_than 10 (
        [then]
            {IF_VAR hoplite_scatterenemy_count greater_than 20 (
                [then]
                    {VARIABLE tmp_scatter_radius 0}
                [/then]
                [else]
                    {VARIABLE tmp_scatter_radius 1}
                [/else]
            )}
        [/then]
        [else]
            {VARIABLE tmp_scatter_radius 2}
        [/else]
    )}

    {SCATTER_UNITS $hoplite_scatterenemy_count {TYPE} $tmp_scatter_radius (
        terrain={TERRAIN}
        [not]
            [filter]
            [/filter]
            [or]
                x,y=6,10
                radius=2
            [/or]
            [or]
                [filter]
                    side=$hoplite_playerside
                [/filter]
                radius=1
            [/or]
            [or]
                [filter]
                    side=$hoplite_allyside
                    level=2-99
                [/filter]
                radius=1
            [/or]
        [/not]
    ) (
        side=$hoplite_enemyside
        placement=map
        passable=yes
    )}
    [store_unit]
        [filter]
            side=$hoplite_enemyside
        [/filter]
        variable=enemycount
        kill=no
    [/store_unit]
    {CLEAR_VARIABLE enemycount}
    {CLEAR_VARIABLE enemycheckrepeat}
    {CLEAR_VARIABLE hoplite_scatterenemy_count}
#enddef

#define HOPLITE_ADD_ENEMY_TO_LIST VAR TYPE
    [set_variables]
        name={VAR}
        mode=append
        [value]
            type={TYPE}
        [/value]
    [/set_variables]
#enddef

#define HOPLITE_ADD_ENEMY_TO_LIST_AFTER_DEPTH VAR DEPTH TYPE
    {IF_VAR hoplite_depth greater_than_equal_to {DEPTH} (
        [then]
            [set_variables]
                name={VAR}
                mode=append
                [value]
                    type={TYPE}
                [/value]
            [/set_variables]
        [/then]
    )}
#enddef

#define HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH VAR DEPTH TYPES
    {IF_VAR hoplite_depth greater_than_equal_to {DEPTH} (
        [then]
            [set_variables]
                name=tmp_types_table
                [split]
                    list={TYPES}
                    key=type
                    separator=,
                [/split]
            [/set_variables]
            [foreach]
                array=tmp_types_table
                index_var=i
                [do]
                    [set_variables]
                        name={VAR}
                        mode=append
                        [value]
                            type=$this_item.type
                        [/value]
                    [/set_variables]
                [/do]
            [/foreach]
            {CLEAR_VARIABLE tmp_types_table}
        [/then]
    )}
#enddef

#define HOPLITE_ADD_ENEMIES_TO_LIST_BEFORE_DEPTH VAR DEPTH TYPES
    {IF_VAR hoplite_depth less_than {DEPTH} (
        [then]
            [set_variables]
                name=tmp_types_table
                [split]
                    list={TYPES}
                    key=type
                    separator=,
                [/split]
            [/set_variables]
            [foreach]
                array=tmp_types_table
                index_var=i
                [do]
                    [set_variables]
                        name={VAR}
                        mode=append
                        [value]
                            type=$this_item.type
                        [/value]
                    [/set_variables]
                [/do]
            [/foreach]
            {CLEAR_VARIABLE tmp_types_table}
        [/then]
    )}
#enddef

#will be used for 1. underworld depths, and 2. making some lower-level enemies stop spawning in lategame depths
#define HOPLITE_ADD_ENEMY_TO_LIST_BEFORE_DEPTH VAR DEPTH TYPE
    {IF_VAR hoplite_depth less_than {DEPTH} (
        [then]
            [set_variables]
                name={VAR}
                mode=append
                [value]
                    type={TYPE}
                [/value]
            [/set_variables]
        [/then]
    )}
#enddef

#define HOPLITE_ADD_ENEMIES_TO_LIST_BETWEEN_DEPTHS VAR DEPTH DEPTH2 TYPES
    {IF_VAR hoplite_depth greater_than_equal_to {DEPTH} (
        [and]
            {VARIABLE_CONDITIONAL hoplite_depth less_than {DEPTH2}}
        [/and]
        [then]
            [set_variables]
                name=tmp_types_table
                [split]
                    list={TYPES}
                    key=type
                    separator=,
                [/split]
            [/set_variables]
            [foreach]
                array=tmp_types_table
                index_var=i
                [do]
                    [set_variables]
                        name={VAR}
                        mode=append
                        [value]
                            type=$this_item.type
                        [/value]
                    [/set_variables]
                [/do]
            [/foreach]
            {CLEAR_VARIABLE tmp_types_table}
        [/then]
    )}
#enddef

#will be used for 1. underworld depths, and 2. making some lower-level enemies stop spawning in lategame depths
#define HOPLITE_ADD_ENEMY_TO_LIST_BETWEEN_DEPTHS VAR DEPTH DEPTH2 TYPE
    {IF_VAR hoplite_depth greater_than_equal_to {DEPTH} (
        [and]
            {VARIABLE_CONDITIONAL hoplite_depth less_than {DEPTH2}}
        [/and]
        [then]
            [set_variables]
                name={VAR}
                mode=append
                [value]
                    type={TYPE}
                [/value]
            [/set_variables]
        [/then]
    )}
#enddef

#define HOPLITE_SCATTER_ENEMIES_NEW NUMBER ENEMYTABLE TERRAIN
    [set_variable]
        name=hoplite_scatterenemy_points
        value={NUMBER}
    [/set_variable]
#ifdef MULTIPLAYER
    [set_variable]
        name=hoplite_scatterenemy_points
        multiply=1.5
    [/set_variable]
#endif
    [set_variable]
        name=hoplite_scatterenemy_points
        multiply=$spartan_difficulty_values.spawnrate_mult
    [/set_variable]
    [set_variable]
        name=hoplite_scatterenemy_points
        round=ceiling
    [/set_variable]

    {VARIABLE unit_type_table_i 0}
    {VARIABLE hoplite_scatterenemy_failsafe_counter 0}
    {VARIABLE tmp_scatter_radius 3}
    [while]
        {VARIABLE_CONDITIONAL hoplite_scatterenemy_points greater_than 0}
        [and]
            #if the scatter code can't find a low-enough level unit to spawn while going through 10 units in a row, stop spawning
            #(otherwise the while loop can get stuck and cause the game to freeze, when, for example, there is 1 enemy point left, but all the spawnable units are lvl2 or above)
            {VARIABLE_CONDITIONAL hoplite_scatterenemy_failsafe_counter less_than 10}
        [/and]
        [do]
            #reduces minimum distance between enemies if it is impossible to place them at original distance
            [if]
                [have_location]
                    terrain={TERRAIN}
                    [not]
                        [filter]
                        [/filter]
                        radius=$tmp_scatter_radius
                        [or]
                            x,y=6,10
                            radius=2
                        [/or]
                        [or]
                            [filter]
                                side=$hoplite_playerside
                            [/filter]
                            radius=1
                        [/or]
                        [or]
                            [filter]
                                side=$hoplite_allyside
                                #now check for companion ability instead of level, otherwise cave bears can prevent a few units from spawning outright on later levels
                                #               level=2-99
                                ability=hoplite_companion
                            [/filter]
                            radius=1
                        [/or]
                    [/not]
                    include_borders=no
                [/have_location]
                [else]
                    {VARIABLE_OP tmp_scatter_radius sub 1}
                    #if it is impossible to find an empty hex even at 0 min distance, stop the while loop
                    {IF_VAR tmp_scatter_radius less_than 0 (
                        [then]
                            {VARIABLE hoplite_scatterenemy_failsafe_counter 10}
                        [/then]
                    )}
                [/else]
            [/if]
            #    [delay]
            #      time=100#delay for testing
            #    [/delay]
            #    {CHATMSG "enemy spawn points: "$hoplite_scatterenemy_points}
            #    {CHATMSG "index: "$unit_type_table_i}
            [store_unit_type]
                type=${ENEMYTABLE}[$unit_type_table_i].type
                variable=tmp_spartan_spawnedtype#something weird is going on with this variable
            [/store_unit_type]
            #    {CHATMSG "level: "$tmp_spartan_spawnedtype.level}
            #if there is not enough enemy points left for the enemy's level, skip
            [if]
                {VARIABLE_CONDITIONAL tmp_spartan_spawnedtype.level greater_than $hoplite_scatterenemy_points}
                #    [or]
                #    {VARIABLE_CONDITIONAL tmp_spartan_spawnedtype.level equals $emptyvar}#failsafe to avoid infinite loops
                #    [/or]
                [then]
                    #    {VARIABLE unit_type_table_i ("$(($unit_type_table_i + 1) % ${ENEMYTABLE}.length)")}
                    {VARIABLE_OP hoplite_scatterenemy_failsafe_counter add 1}
                    #            {CHATMSG "skipping unit, failsafes: "$hoplite_scatterenemy_failsafe_counter}
                [/then]
                [else]
                    #using a custom [random_placement] instead of the default scatter unit macro
                    [random_placement]
                        num_items=1
                        variable=random_placement_location
                        allow_less=yes
                        min_distance=0
                        [filter_location]
                            terrain={TERRAIN}
                            [not]
                                [filter]
                                [/filter]
                                radius=$tmp_scatter_radius
                                [or]
                                    x,y=6,10
                                    radius=2
                                [/or]
                                [or]
                                    [filter]
                                        side=$hoplite_playerside
                                    [/filter]
                                    radius=1
                                [/or]
                                [or]
                                    [filter]
                                        side=$hoplite_allyside
                                        #now check for companion ability instead of level, otherwise cave bears can prevent a few units from spawning outright on later levels
                                        #                   level=2-99
                                        ability=hoplite_companion
                                    [/filter]
                                    radius=1
                                [/or]
                            [/not]
                            include_borders=no
                        [/filter_location]
                        [command]
                            {CHATMSG "spawning unit"}

                            {IF_VAR tmp_spartan_spawnedtype.level equals 0 (
                                [then]
                                    {VARIABLE tmp_enemy_points 0.5}
                                [/then]
                                [else]
                                    {VARIABLE tmp_enemy_points $tmp_spartan_spawnedtype.level}
                                [/else]
                            )}
                            [unit]
                                type=${ENEMYTABLE}[$unit_type_table_i].type
                                x,y=$random_placement_location.x,$random_placement_location.y
                                side=$hoplite_enemyside
                                placement=map
                                passable=yes
                                random_gender=yes
                            [/unit]
                            #            {VARIABLE unit_type_table_i ("$(($unit_type_table_i + 1) % ${ENEMYTABLE}.length)")}
                            {VARIABLE_OP hoplite_scatterenemy_points sub $tmp_enemy_points}
                            {VARIABLE hoplite_scatterenemy_failsafe_counter 0}#reset the failsafe counter if a unit is eventually found
                            {CLEAR_VARIABLE tmp_enemy_points}
                        [/command]
                    [/random_placement]
                [/else]
            [/if]
            {VARIABLE unit_type_table_i ("$(($unit_type_table_i + 1) % ${ENEMYTABLE}.length)")}
            {CLEAR_VARIABLE random_placement_location}
            {CLEAR_VARIABLE tmp_spartan_spawnedtype}
        [/do]
    [/while]
    {CLEAR_VARIABLE unit_type_table_i}
    {CLEAR_VARIABLE hoplite_scatterenemy_points}
#enddef

#define HOPLITE_GENERATION_AMOUNT VARIABLE
    #the slowed-down scaling is scrapped for now, might re-add later, might not, leaving the macro just in case
    #	{IF_VAR {VARIABLE} greater_than_equal_to 10 (
    #	[then]
    #	  {VARIABLE_OP {VARIABLE} multiply 0.5}
    #	  {VARIABLE_OP {VARIABLE} round floor}
    #	  {VARIABLE_OP {VARIABLE} add 5}
    #	[/then])}
#enddef

#define HOPLITE_CHAOSUNITS ELSE
    {IF_VAR hoplite_depth greater_than 25 (
        [then]
            {VARIABLE_OP chaoschance rand (1,2,3)}
            {IF_VAR chaoschance equals 2 (
                [or]
                    {VARIABLE_CONDITIONAL hoplite_depth equals 23}
                [/or]
                [or]
                    {VARIABLE_CONDITIONAL hoplite_depth equals 24}
                [/or]
                [then]
                    {VARIABLE_OP hoplite_enemy multiply 0.75}
                    {VARIABLE_OP hoplite_enemy round floor}
                    {IF_VAR hoplite_depth greater_than 27 (
                        [then]
                            {VARIABLE hoplite_enemytable Hoplite_Chaosinvader,Hoplite_Chaosbowman,Hoplite_Headhunter,Hoplite_Chaosinvader,Hoplite_Chaosbowman,Hoplite_Headhunter,Hoplite_Chaosinvader,Hoplite_Demonwarrior,Hoplite_Chaosinvader,Hoplite_Demonstorm}
                        [/then]
                        [else]
                            {VARIABLE hoplite_enemytable Hoplite_Chaosinvader,Hoplite_Chaosbowman,Hoplite_Headhunter,Hoplite_Chaosinvader,Hoplite_Chaosbowman,Hoplite_Headhunter,Hoplite_Chaosinvader,Hoplite_Demonwarrior}
                        [/else])}
                    [/then]
                    [else]
                        {ELSE}
                    [/else])}
                    {CLEAR_VARIABLE chaoschance}
                [/then]
                [else]
                    {ELSE}
                [/else])}
#enddef

#define HOPLITE_CRYPT_GENERATION
    [set_variable]
        name=hoplite_enemy
        value=$hoplite_depth
    [/set_variable]
    {VARIABLE hoplite_enemy $hoplite_depth}
    {VARIABLE_OP hoplite_enemy add 1}
    {HOPLITE_GENERATION_AMOUNT hoplite_enemy}
    {VARIABLE hoplite_enemyamount $hoplite_enemy}
    {VARIABLE hoplite_enemyterrain {SPARTAN_UNITSPAWN_TERRAIN}}

    #before depth 40, use normal unitpool. starting from 40, replace common enemies with stronger ones where possible
    {HOPLITE_ADD_ENEMIES_TO_LIST_BEFORE_DEPTH hoplite_enemytable 40 Hoplite_Spearman,Hoplite_Skelearcher,Hoplite_Shielder,Hoplite_Poltergeist,Hoplite_Skelearcher,Hoplite_Spearman,Hoplite_Demilich,Hoplite_Dark_Adept}
    {HOPLITE_ADD_ENEMIES_TO_LIST_BETWEEN_DEPTHS hoplite_enemytable 8 60 Hoplite_Skelehorseman}
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 11 Hoplite_Armor,Hoplite_Pikeman}
    {HOPLITE_ADD_ENEMIES_TO_LIST_BETWEEN_DEPTHS hoplite_enemytable 11 40 Hoplite_Spearman}#to dilute the enemy pool a bit before depth 40
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 16 Hoplite_Demonstorm}
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 18 Hoplite_Defender}
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 20 Hoplite_Skeleknight}
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 23 Hoplite_Shadow}
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 25 Hoplite_Lich}
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 31 Hoplite_Ferrous_Titan}
    {HOPLITE_ADD_ENEMIES_TO_LIST_BETWEEN_DEPTHS hoplite_enemytable 40 60 Hoplite_Pikeman,Hoplite_Defender,Hoplite_Poltergeist,Hoplite_Demilich,Hoplite_Dark_Adept,Hoplite_Pikeman,Hoplite_Skelehorseman,Hoplite_Skeleknight}
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 60 Hoplite_Pikeman,Hoplite_Shadow,Hoplite_Demilich,Hoplite_Pikeman,Hoplite_Demonstorm,Hoplite_Pikeman,Hoplite_Demonstorm,Hoplite_Skeleknight}
    #increasing the chance of lvl3s spawning. make sure to update this list when new lvl3s get added
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 60 Hoplite_Lich,Hoplite_Ferrous_Titan}

    {CLEAR_VARIABLE hoplite_enemy}
#enddef

#define HOPLITE_CRYPT_RANDTYPE
    #   {RANDOM 1..7}
    #   {RANDOM 10..11}
    {RANDOM 1..12}
    {IF_VAR random equals 1 (
        [or]
            [variable]
                name=random
                equals=6
            [/variable]
        [/or]
        [then]
            [replace_map]
                map_file=~add-ons/Spartan/maps/Hoplite_Maze1.map
                expand=yes
                shrink=yes
            [/replace_map]
            {HOPLITE_GENERATE_FORGE 9 8}
        [/then]
        [elseif]
            [variable]
                name=random
                equals=2
            [/variable]
            [or]
                [variable]
                    name=random
                    equals=7
                [/variable]
            [/or]
            [or]
                [variable]
                    name=random
                    equals=12
                [/variable]
            [/or]
            [then]
                [replace_map]
                    map_file=~add-ons/Spartan/maps/Hoplite_Maze2.map
                    expand=yes
                    shrink=yes
                [/replace_map]
                {HOPLITE_GENERATE_FORGE 3 8}
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=random
                equals=3
            [/variable]
            [then]
                [replace_map]
                    map_file=~add-ons/Spartan/maps/Hoplite_Maze3.map
                    expand=yes
                    shrink=yes
                [/replace_map]
                {HOPLITE_GENERATE_FORGE 4,10 2}
                [item]
                    image="items/dragonstatue.png"
                    x,y=2,2
                [/item]
                [item]
                    image="items/dragonstatue.png~FL(horiz)"
                    x,y=10,2
                [/item]
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=random
                equals=4
            [/variable]
            [then]
                [replace_map]
                    map_file=~add-ons/Spartan/maps/Hoplite_Maze4.map
                    expand=yes
                    shrink=yes
                [/replace_map]
                {HOPLITE_GENERATE_FORGE 3,9 6}
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=random
                equals=5
            [/variable]
            [then]
                [replace_map]
                    map_file=~add-ons/Spartan/maps/Hoplite_Maze5.map
                    expand=yes
                    shrink=yes
                [/replace_map]
                {HOPLITE_GENERATE_FORGE 2,10 7}
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=random
                equals=8
            [/variable]
            [then]
                [replace_map]
                    map_file=~add-ons/Spartan/maps/Hoplite_Maze6.map
                    expand=yes
                    shrink=yes
                [/replace_map]
                {RANDOM 12..16}
                {SCATTER_UNITS $random "Hoplite_Dummy_Unit" 1 (
                    terrain=Urb
                    [not]
                        [filter]
                        [/filter]
                        [or]
                            x,y=6,2
                            radius=1
                        [/or]
                        [or]
                            x,y=6,10
                            radius=2
                        [/or]
                    [/not]
                ) (
                    side=$hoplite_enemyside
                )}
                [store_unit]
                    [filter]
                        type=Hoplite_Dummy_Unit
                    [/filter]
                    variable=walls
                [/store_unit]

                [foreach]
                    array=walls
                    index_var=a
                    [do]
                        [terrain]
                            x,y=$this_item.x,$this_item.y
                            terrain=Xos
                        [/terrain]
                        [kill]
                            id=$this_item.id
                            animate=no
                            fire_event=no
                        [/kill]
                    [/do]
                [/foreach]

                {CLEAR_VARIABLE walls}
                {HOPLITE_GENERATE_FORGE 2,10 7}
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=random
                equals=9
            [/variable]
            [then]
                [replace_map]
                    map_file=~add-ons/Spartan/maps/Hoplite_Maze7.map
                    expand=yes
                    shrink=yes
                [/replace_map]
                {HOPLITE_GENERATE_FORGE 6 4}
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=random
                equals=10
            [/variable]
            [then]
                [replace_map]
                    map_file=~add-ons/Spartan/maps/Hoplite_Maze8.map
                    expand=yes
                    shrink=yes
                [/replace_map]
                {HOPLITE_GENERATE_FORGE 2-10 3,4}
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=random
                equals=11
            [/variable]
            [then]
                [replace_map]
                    map_file=~add-ons/Spartan/maps/Hoplite_Maze9.map
                    expand=yes
                    shrink=yes
                [/replace_map]
                {HOPLITE_GENERATE_FORGE 2-10 3,4}
            [/then]
        [/elseif]
    )}
    {RANDOM 1..5}
    {IF_VAR random equals 3 (
        [and]
            {VARIABLE_CONDITIONAL hoplite_depth greater_than 5}
        [/and]
        [then]
            [replace_schedule]
                {SPARTAN_UNDERGROUND_RED}
            [/replace_schedule]
        [/then])}
        {IF_VAR random equals 5 (
            [and]
                {VARIABLE_CONDITIONAL hoplite_depth greater_than 5}
            [/and]
            [then]
                [replace_schedule]
                    {SPARTAN_UNDERGROUND_BLUE}
                [/replace_schedule]
            [/then])}
#enddef

#moved to macro since it's used for both cave and dwarven biomes

#define SPARTAN_CAVE_UNITPOOL
    #before depth 40, use normal unitpool. after depth 40, common lvl1 units are replaced by their lvl2 counterparts
    {HOPLITE_ADD_ENEMIES_TO_LIST_BEFORE_DEPTH hoplite_enemytable 40 Hoplite_Orcgrunt,Hoplite_Orcarcher}
    #bat swarm spawns after the first two orcs
    [if]
        {VARIABLE_CONDITIONAL spartan_message_batswarm equals yes}
        [then]
            {HOPLITE_ADD_ENEMIES_TO_LIST_BEFORE_DEPTH hoplite_enemytable 20 Hoplite_Vampire_Bat,Hoplite_Vampire_Bat}
            {HOPLITE_ADD_ENEMIES_TO_LIST_BETWEEN_DEPTHS hoplite_enemytable 5 10 Hoplite_Vampire_Bat}
            {HOPLITE_ADD_ENEMIES_TO_LIST_BETWEEN_DEPTHS hoplite_enemytable 5 40 Hoplite_Blood_Bat}
            {HOPLITE_ADD_ENEMIES_TO_LIST_BETWEEN_DEPTHS hoplite_enemytable 8 40 Hoplite_Blood_Bat}
            {HOPLITE_ADD_ENEMIES_TO_LIST_BETWEEN_DEPTHS hoplite_enemytable 10 40 Hoplite_Blood_Bat}
            {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 15 Hoplite_Dread_Bat}
            {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 20 Hoplite_Dread_Bat}
            {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 30 Hoplite_Dread_Bat}
            {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 40 Hoplite_Dread_Bat,Hoplite_Dread_Bat,Hoplite_Dread_Bat}
        [/then]
        [else]
            #cutthroats don't spawn during bat swarm
            {HOPLITE_ADD_ENEMIES_TO_LIST_BEFORE_DEPTH hoplite_enemytable 40 Hoplite_Cutthroat}
        [/else]
    [/if]
    {HOPLITE_ADD_ENEMIES_TO_LIST_BEFORE_DEPTH hoplite_enemytable 40 Hoplite_Orcbomber,Hoplite_Orcgrunt,Hoplite_Orcwarrior}
    {IF_VAR spartan_message_batswarm equals yes (
        [else]
            #cutthroats don't spawn during bat swarm
            {HOPLITE_ADD_ENEMIES_TO_LIST_BEFORE_DEPTH hoplite_enemytable 40 Hoplite_Cutthroat}
        [/else]
    )}
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 6 Hoplite_Fireguardian}
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 11 Hoplite_Mudgolem,Hoplite_Orc_Crossbowman}
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 16 Hoplite_Lavatentacle,Hoplite_Demonwarrior,Hoplite_Demonstorm}
    {IF_VAR spartan_message_batswarm equals yes (
        [else]
            #assassins don't spawn during early bat swarms (after depth 40 they can still spawn)
            {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 18 Hoplite_Assassin}
        [/else]
    )}
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 18 Hoplite_Orc_Elitebomber}
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 25 Hoplite_Orcwarlord}
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 31 Hoplite_Orc_Slurbow}
    {HOPLITE_ADD_ENEMIES_TO_LIST_BETWEEN_DEPTHS hoplite_enemytable 40 60 Hoplite_Orcwarrior,Hoplite_Orc_Crossbowman,Hoplite_Assassin,Hoplite_Orc_Elitebomber,Hoplite_Fireguardian,Hoplite_Assassin,Hoplite_Demonwarrior,Hoplite_Demonstorm}
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 60 Hoplite_Assassin,Hoplite_Orc_Crossbowman,Hoplite_Orc_Elitebomber,Hoplite_Demonwarrior,Hoplite_Demonstorm,Hoplite_Mudgolem}
    #increasing the chance of lvl3s spawning. make sure to update this list when new lvl3s get added
    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 60 Hoplite_Orcwarlord,Hoplite_Orc_Slurbow}
#enddef

#define RANDOM_MAP_TYPE
    {IF_VAR hoplite_tutorial equals yes (
        [then]
            {VARIABLE customfloor yes}
            [fire_event]
                id=spartan_tutorial_level_generation
            [/fire_event]
        [/then]
    )}

    {IF_VAR hoplite_depth equals 5 (
        #[or]
        # [variable]
        #    name=hoplite_depth
        #    equals=30
        # [/variable]
        #[/or]
        [then]
            [replace_map]
                map_file=~add-ons/Spartan/maps/Hoplite_Spidernest.map
                expand=yes
                shrink=yes
            [/replace_map]
            {UNIT $hoplite_enemyside (Hoplite_Spider_Queen) 6 5 (
                id=Spiderqueen
                name=_"Arachne"
                {SPARTAN_IS_BOSS}
            )}

            {UNIT $hoplite_enemyside Hoplite_Orcgrunt 6 7 (
                id=Orc_messenger
                generate_name=yes
            )}

            #        {RANDOM 8..11}
            #slightly fewer spider spawns, since Arachne now has an orc grunt minion
            {RANDOM 7..9}

            {HOPLITE_SCATTER_ENEMY $random Hoplite_Spider_Minion {SPARTAN_UNITSPAWN_TERRAIN}}
            {HOPLITE_GENERATE_FORGE 2-10 4-5}
            {VARIABLE customfloor yes}
            {VARIABLE bossfight yes}
            #scrapped spiderqueen rematch code
            #	{IF_VAR hoplite_depth greater_than_equal_to 50 (
            #	[then]
            #	[remove_item]
            #	   image="scenery/trapdoor-open.png"
            #	   x=6,7
            #	   y=2,2
            #	[/remove_item]
            #	[item]
            #	   image="scenery/trapdoor-closed.png"
            #	   x,y=7,2
            #	[/item]
            #	[/then]
            #	[else]
            [remove_item]
                image="scenery/trapdoor-open.png"
                x,y=6,2
            [/remove_item]
            [item]
                image="scenery/trapdoor-closed.png"
                x,y=6,2
            [/item]
            #	[/else])}
            #	{VARIABLE spiderqueen_seen yes}
        [/then]
        [elseif]
            [variable]
                name=hoplite_depth
                equals=10
            [/variable]
            [or]
                [variable]
                    name=hoplite_depth
                    equals=35
                [/variable]
            [/or]
            [then]
                [replace_schedule]
                    {SPARTAN_UNDERGROUND_RED}
                [/replace_schedule]
                [replace_map]
                    map_file=~add-ons/Spartan/maps/Hoplite_Library.map
                    expand=yes
                    shrink=yes
                [/replace_map]
                {UNIT $hoplite_enemyside (Hoplite_Archmage) 6 4 (
                    id=Archmage
                    name=_"Arcanus"
                    facing=s
                    {SPARTAN_IS_BOSS}
                )}
                {IF_VAR hoplite_depth equals 35 (
                    [then]
                        [replace_schedule]
                            {SPARTAN_UNDERWORLD}
                        [/replace_schedule]
                        [object]
                            silent=yes
                            duration=forever
                            [filter]
                                id=Archmage
                            [/filter]
                            [effect]
                                apply_to=attack
                                range=ranged
                                increase_damage=100%
                            [/effect]
                            [effect]
                                apply_to=hitpoints
                                increase=100%
                                increase_total=100%
                            [/effect]
                            [effect]
                                apply_to=variation
                                name=shaxtal
                            [/effect]
                        [/object]
                        {UNIT $hoplite_enemyside (Hoplite_Demonstorm) 3 4 (facing=se)}
                        {UNIT $hoplite_enemyside (Hoplite_Demonstorm) 9 4 (facing=sw)}
                        {UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 5 6 (facing=se)}
                        {UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 7 6 (facing=sw)}
                        {UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 3 8 (facing=se)}
                        {UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 9 8 (facing=sw)}
                        [if]
                            [have_unit]
                                id=Hoplite2
                            [/have_unit]
                            [then]
                                {UNIT $hoplite_enemyside (Hoplite_Mudgolem) 5 3 (facing=se)}
                                {UNIT $hoplite_enemyside (Hoplite_Mudgolem) 7 3 (facing=sw)}
                            [/then]
                        [/if]
                    [/then]
                    [else]
                        {UNIT $hoplite_enemyside (Hoplite_Fireguardian) 3 4 (facing=se)}
                        {UNIT $hoplite_enemyside (Hoplite_Fireguardian) 9 4 (facing=sw)}
                        [if]
                            [have_unit]
                                id=Hoplite2
                            [/have_unit]
                            [then]
                                {UNIT $hoplite_enemyside (Hoplite_Fireguardian) 5 6 (facing=se)}
                                {UNIT $hoplite_enemyside (Hoplite_Fireguardian) 7 6 (facing=sw)}
                            [/then]
                        [/if]
                    [/else])}
                    #scrapped code, would have only matter if archmage rematch was AFTER 40
                    #	{IF_VAR hoplite_depth greater_than_equal_to 50 (
                    #	[then]
                    #	[remove_item]
                    #	   image="scenery/trapdoor-open.png"
                    #	   x=6,7
                    #	   y=2,2
                    #	[/remove_item]
                    #	[item]
                    #	   image="scenery/trapdoor-closed.png"
                    #	   x,y=7,2
                    #	[/item]
                    #	[/then]
                    #	[else]
                    [remove_item]
                        image="scenery/trapdoor-open.png"
                        x,y=6,2
                    [/remove_item]
                    [item]
                        image="scenery/trapdoor-closed.png"
                        x,y=6,2
                    [/item]
                    #	[/else])}
                    [item]
                        image="items/bookcase.png"
                        x=2
                        y=3-8
                    [/item]
                    [item]
                        image="items/bookcase.png"
                        x,y=3,3
                    [/item]
                    [item]
                        image="items/bookcase.png"
                        x,y=4,2
                    [/item]
                    [item]
                        image="items/bookcase-sw.png"
                        x=10
                        y=3-8
                    [/item]
                    [item]
                        image="items/bookcase-sw.png"
                        x,y=9,3
                    [/item]
                    [item]
                        image="items/bookcase-sw.png"
                        x,y=8,2
                    [/item]
                    {HOPLITE_GENERATE_FORGE 2-10 4-5}
                    {VARIABLE customfloor yes}
                    {VARIABLE bossfight yes}
                    #	{VARIABLE archmage_seen yes}
                [/then]
            [/elseif]
            [elseif]
                [variable]
                    name=hoplite_depth
                    equals=15
                [/variable]
                [then]
                    [replace_map]
                        map_file=~add-ons/Spartan/maps/Hoplite_Shrine.map
                        expand=yes
                        shrink=yes
                    [/replace_map]
                    [replace_schedule]
                        {SPARTAN_UNDERGROUND_RED}
                    [/replace_schedule]
                    {UNIT $hoplite_enemyside (Hoplite_Ares) 6 4 (
                        id=Ares
                        name=_"Ares"
                        facing=s
                        {SPARTAN_IS_BOSS}
                    )}
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                            {UNIT $hoplite_enemyside (Hoplite_Hydra) 5 6 (facing=se)}
                            {UNIT $hoplite_enemyside (Hoplite_Hydra) 7 6 (facing=sw)}
                        [/then]
                    [/if]
                    {UNIT $hoplite_enemyside (Hoplite_Hydra) 4 4 (facing=se)}
                    {UNIT $hoplite_enemyside (Hoplite_Hydra) 8 4 (facing=sw)}
                    [remove_item]
                        image="scenery/trapdoor-open.png"
                        x=6,7
                        y=2,2
                    [/remove_item]
                    [item]
                        image="scenery/trapdoor-closed.png"
                        #	   x,y=7,2
                        x,y=6,2
                    [/item]
                    #	[item]
                    #	   image="terrain/stairs-spiral.png"
                    #	   x,y=5,2
                    #	[/item]
                    {HOPLITE_GENERATE_FORGE 2-10 4-5}
                    {VARIABLE customfloor yes}
                    {VARIABLE bossfight yes}
                    #	{VARIABLE ares_seen yes}
                    #	{VARIABLE hoplite_stairway yes}
                    {VARIABLE ares_leap_cooldown 3}
                [/then]
            [/elseif]
            [elseif]
                [variable]
                    name=hoplite_depth
                    equals=20
                [/variable]
                [then]
                    [replace_map]
                        map_file=~add-ons/Spartan/maps/Hoplite_donovandepth.map
                        expand=yes
                        shrink=yes
                    [/replace_map]
                    [replace_schedule]
                        {SPARTAN_UNDERGROUND_BLUE}
                    [/replace_schedule]
                    {UNIT $hoplite_enemyside (Hoplite_Donovan) 6 5 (
                        id=Donovan
                        name=_"Donovan"
                        facing=s
                        {SPARTAN_IS_BOSS}
                    )}
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                            {UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 5 5 (facing=se)}
                            {UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 7 5 (facing=sw)}
                        [/then]
                    [/if]
                    {UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 5 4 (facing=se)}
                    {UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 7 4 (facing=sw)}
                    {UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 5 6 (facing=se)}
                    {UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 7 6 (facing=sw)}
                    [remove_item]
                        image="scenery/trapdoor-open.png"
                        x=6,7
                        y=2,2
                    [/remove_item]
                    [item]
                        image="scenery/trapdoor-closed.png"
                        x,y=6,2
                    [/item]
                    {HOPLITE_GENERATE_FORGE 2-10 4-5}
                    {VARIABLE customfloor yes}
                    {VARIABLE bossfight yes}
                    #	{VARIABLE donovan_seen yes}
                [/then]
            [/elseif]
            [elseif]
                [variable]
                    name=hoplite_depth
                    equals=25
                [/variable]
                [then]
                    [replace_map]
                        map_file=~add-ons/Spartan/maps/Hoplite_Scylla_Lair.map
                        expand=yes
                        shrink=yes
                    [/replace_map]
                    [replace_schedule]
                        {SPARTAN_UNDERGROUND_BLUE}
                    [/replace_schedule]
                    {UNIT $hoplite_enemyside (Hoplite_Scylla) 6 5 (
                        id=Scylla
                        name=_"Scylla"
                        facing=s
                        {SPARTAN_IS_BOSS}
                    )}
                    #scylla's pet kraken
                    {UNIT $hoplite_enemyside (Hoplite_Kraken) 9 4 (
                        id=Charybdis
                        name=_"Charybdis"
                        facing=sw
                    )}
                    {UNIT $hoplite_enemyside (Hoplite_Nagamage) 2 3 (facing=se)}
                    {UNIT $hoplite_enemyside (Hoplite_Nagamage) 2 5 (facing=se)}
                    {UNIT $hoplite_enemyside (Hoplite_Nagamage) 10 5 (facing=sw)}
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                            {UNIT $hoplite_enemyside (Hoplite_Nagahunter) 2 7 (facing=se)}
                            {UNIT $hoplite_enemyside (Hoplite_Nagahunter) 10 7 (facing=sw)}
                        [/then]
                    [/if]
                    [remove_item]
                        image="scenery/trapdoor-open.png"
                        x=6,7
                        y=2,2
                    [/remove_item]
                    [item]
                        image="scenery/trapdoor-closed.png"
                        x,y=6,2
                    [/item]
                    {HOPLITE_GENERATE_FORGE 2-10 1-5}
                    {VARIABLE customfloor yes}
                    {VARIABLE bossfight yes}
                    #   {VARIABLE scylla_seen yes}
                [/then]
            [/elseif]
            [elseif]
                [variable]
                    name=hoplite_depth
                    equals=30
                [/variable]
                [then]
                    [replace_map]
                        map_file=~add-ons/Spartan/maps/Hoplite_Minotaurroom.map
                        expand=yes
                        shrink=yes
                    [/replace_map]
                    [replace_schedule]
                        {SPARTAN_UNDERGROUND}
                    [/replace_schedule]
                    [time_area]
                        id=heat
                        x=0-5,3,6,0-3
                        y=0-8,9,0-1,9
                        {SPARTAN_UNDERGROUND_RED}
                    [/time_area]
                    [time_area]
                        id=void
                        x=7-12,9,6
                        y=0-8,9,2
                        {SPARTAN_UNDERWORLD}
                    [/time_area]
                    {UNIT $hoplite_enemyside (Hoplite_Minotaur) 3 3 (
                        id=Minotaur
                        name=_"Minotaur"
                        facing=s
                        {SPARTAN_IS_BOSS}
                    )}
                    {UNIT $hoplite_enemyside (Hoplite_Warlock) 9 3 (
                        id=Warlock
                        name=_"Minos"
                        facing=s
                        {SPARTAN_IS_BOSS}
                    )}
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                            #Minotaur minions:
                            {UNIT $hoplite_enemyside (Hoplite_Fireguardian) 1 9 (facing=se)}
                            {UNIT $hoplite_enemyside (Hoplite_Fireguardian) 5 7 (facing=se)}
                            #Warlock minions:
                            {UNIT $hoplite_enemyside (Hoplite_Demilich) 10 3 (facing=se)}
                            {UNIT $hoplite_enemyside (Hoplite_Spearman) 9 8 (facing=sw)}
                        [/then]
                    [/if]
                    #Minotaur minions:
                    {UNIT $hoplite_enemyside (Hoplite_Fireguardian) 2 4 (facing=se)}
                    #	{UNIT $hoplite_enemyside (Hoplite_Mudgolem) 5 5 (facing=sw)}
                    {UNIT $hoplite_enemyside (Hoplite_Demonwarrior) 5 3 (facing=sw)}
                    {UNIT $hoplite_enemyside (Hoplite_Fireguardian) 3 8 (facing=se)}
                    #Warlock minions:
                    #	{UNIT $hoplite_enemyside (Hoplite_Demilich) 7 3 (facing=se)}
                    {UNIT $hoplite_enemyside (Hoplite_Armor) 8 4 (facing=se)}
                    {UNIT $hoplite_enemyside (Hoplite_Skelearcher) 10 5 (facing=sw)}
                    {UNIT $hoplite_enemyside (Hoplite_Shielder) 8 7 (facing=sw)}

                    #code not needed since the boss is earlier than depth 40
                    #	{IF_VAR hoplite_depth greater_than_equal_to 50 (
                    #	[then]
                    #	[remove_item]
                    #	   image="scenery/trapdoor-open.png"
                    #	   x=6,7
                    #	   y=2,2
                    #	[/remove_item]
                    #	[item]
                    #	   image="scenery/trapdoor-closed.png"
                    #	   x,y=7,2
                    #	[/item]
                    #	[item]
                    #	   image="terrain/stairs-spiral.png"
                    #	   x,y=5,2
                    #	[/item]
                    #        [/then]
                    #	[else]
                    #	[remove_item]
                    #	   image="scenery/trapdoor-open.png"
                    #	   x=6,7
                    #	   y=2,2
                    #	[/remove_item]
                    ##	[item]
                    ##	   image="scenery/trapdoor-closed.png"
                    ##	   x,y=6,2
                    ##	[/item]
                    #	[/else])}
                    {SPARTAN_PLACE_DARKPORTAL 6 2}
                    {HOPLITE_GENERATE_FORGE 2-10 4-5}
                    {VARIABLE customfloor yes}
                    {VARIABLE bossfight yes}
                    #	{VARIABLE duo_seen yes}
                    #now you can no longer skip straight to depth 31 by picking "No" in the portal menu
                    {VARIABLE spartan_exitlocked_this_depth yes}
                [/then]
            [/elseif]
            [elseif]
                [variable]
                    name=hoplite_depth
                    equals=-10
                [/variable]
                [then]
                    [replace_map]
                        map_file=~add-ons/Spartan/maps/Hoplite_Crypt.map
                        expand=yes
                        shrink=yes
                    [/replace_map]
                    [replace_schedule]
                        {SPARTAN_UNDERWORLD}
                    [/replace_schedule]
                    {UNIT $hoplite_enemyside (Hoplite_Grimreaper) 6 4 (
                        id=Reaper
                        name=_"Grim Reaper"
                        facing=s
                        {SPARTAN_IS_BOSS}
                    )}
                    [hide_unit]
                        id=Reaper
                    [/hide_unit]
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                            {RANDOM 8..12}
                            {HOPLITE_SCATTER_ENEMY $random Hoplite_Poltergeist,Hoplite_Poltergeist,Hoplite_Spectremage,Hoplite_Faceless {SPARTAN_UNITSPAWN_TERRAIN}}
                        [/then]
                        [else]
                            {RANDOM 5..8}
                            {HOPLITE_SCATTER_ENEMY $random Hoplite_Poltergeist,Hoplite_Poltergeist,Hoplite_Spectremage,Hoplite_Faceless {SPARTAN_UNITSPAWN_TERRAIN}}
                        [/else]
                    [/if]
                    [remove_item]
                        image="scenery/trapdoor-open.png"
                        x=6,7
                        y=2,2
                    [/remove_item]
                    {SPARTAN_PLACE_RETURN_PORTAL 6 2}
                    {HOPLITE_GENERATE_FORGE 2-10 4-5}
                    {VARIABLE customfloor yes}
                    {VARIABLE bossfight yes}
                    #	{VARIABLE reaper_seen yes}
                    #now you can no longer skip straight to depth -11 by picking "No" in the portal menu
                    {VARIABLE spartan_exitlocked_this_depth yes}
                [/then]
            [/elseif]
            [elseif]
                [variable]
                    name=hoplite_depth
                    equals=40
                [/variable]
                [then]
                    {VARIABLE noautomove_this_depth yes}#level can be explored as normal
                    [replace_map]
                        map_file=~add-ons/Spartan/maps/Hoplite_Shrine2.map
                        expand=yes
                        shrink=yes
                    [/replace_map]
                    [replace_schedule]
                        {SPARTAN_UNDERGROUND_RED}
                    [/replace_schedule]
                    [time_area]
                        id=heat
                        x,y=6,4
                        radius=2
                        {SPARTAN_UNDERGROUND_PROMETHEUSFIRE}
                    [/time_area]
                    [item]
                        x,y=6,4
                        #          image="items/prometheus-fire1.png"
                        halo="items/brazier-prometheus-fire1.png:100,items/brazier-prometheus-fire2.png:100"
                    [/item]
                    [terrain]
                        x,y=6,4
                        terrain=Uri^li
                    [/terrain]
                    {HOPLITE_GENERATE_FORGE 2-10 4-5}
                    {VARIABLE customfloor yes}
                    {VARIABLE hoplite_stairway yes}
                [/then]
            [/elseif]
            [else]
                {IF_VAR hoplite_depth greater_than 5 (
                    [then]
                        #   {VARIABLE_OP random_event rand (1..2)}
                        {VARIABLE_OP random_event rand (1..6)}
                    [/then])}
                    {IF_VAR debug_forcerandomevent equals yes (
                        [then]
                            {VARIABLE random_event 1}
                        [/then]
                    )}
                    {IF_VAR random_event equals 1 (
                        [then]
                            #TODO: add more rare biome types
                            {VARIABLE_OP random_event_type rand (1,2)}
                            {IF_VAR random_event_type equals 1 (
                                [then]
                                    {VARIABLE hoplite_event_biomechosen rarebiome_dwarven}
                                [/then]
                            )}
                            {IF_VAR random_event_type equals 2 (
                                [then]
                                    {VARIABLE hoplite_event_biomechosen rarebiome_mysterious_shop}
                                [/then]
                            )}
                            {CLEAR_VARIABLE random_event}
                            {CLEAR_VARIABLE random_event_type}
                        [/then]
                    )}
                [/else]
            )}

            #if players get a bit unlucky with dwarf spawn RNG and they didn't have any attemtps to save Algadur for 18 depths, give a guaranteed algadur spawn on depth 18
            {IF_VAR hoplite_depth equals 18 (
                [and]
                    {VARIABLE_CONDITIONAL algadurlinestart not_equals yes}
                [/and]
                [then]
                    {VARIABLE hoplite_event_biomechosen rarebiome_dwarven}
                [/then]
            )}

            #if players get a bit unlucky with dwarf spawn RNG and they didn't have any attemtps to save Algadur for 18 depths, give a guaranteed algadur spawn on depth 18
            {IF_VAR hoplite_depth equals 4 (
                [and]
                    {VARIABLE_CONDITIONAL spartan_difficulty_values.merchant_on_depth_4 equals yes}
                [/and]
                [then]
                    {VARIABLE hoplite_event_biomechosen rarebiome_mysterious_shop}
                [/then]
            )}

            {IF_VAR customfloor equals yes (
                [then]
                    {VARIABLE hoplite_biome customfloor}#to avoid biome-specific code triggering in boss rooms
                [/then]
            )}
            {IF_VAR customfloor not_equals yes (
                [then]
                    #added a biomerandlist variable, since it's easier to work with than just having lots of if/else statements
                    {VARIABLE spartan_biomerandlist cave,dungeon}
                    {IF_VAR hoplite_depth greater_than 2 (
                        [then]
                            {VARIABLE spartan_biomerandlist $spartan_biomerandlist|,aquatic}
                        [/then]
                    )}
                    {IF_VAR hoplite_depth greater_than 5 (
                        [then]
                            {VARIABLE spartan_biomerandlist $spartan_biomerandlist|,sand}
                        [/then]
                    )}
                    #TODO: add ice biome after depth 10
                    #jungle is a fairly difficult biome that spawns after the Avatar of War bossfight
                    {IF_VAR hoplite_depth greater_than 15 (
                        [then]
                            {VARIABLE spartan_biomerandlist $spartan_biomerandlist|,jungle}
                        [/then]
                    )}
                    {VARIABLE_OP hoplite_biome rand $spartan_biomerandlist}
                    {IF_VAR hoplite_depth less_than_equal_to 0 (
                        [then]
                            #after meeting elizabeth, mysterious shop has a 1/5 chance to spawn in underworld (added just in case to avoid conflicts)
                            {IF_VAR elizabethmet equals yes (
                                [then]
                                    #TODO: maybe have this use random event code, so it's affected by 'guaranteed random events' code
                                    {VARIABLE_OP hoplite_biome rand underworld,underworld,underworld,underworld,rarebiome_mysterious_shop}
                                [/then]
                                [else]
                                    {VARIABLE_OP hoplite_biome rand underworld}
                                [/else]
                            )}
                        [/then]
                    )}

                    {IF_VAR hoplite_event_biomechosen not_equals $emptyvar (
                        [then]
                            {VARIABLE hoplite_biome $hoplite_event_biomechosen}
                        [/then]
                    )}
                    {IF_VAR hoplite_forcebiome not_equals $emptyvar (
                        [then]
                            {VARIABLE hoplite_biome $hoplite_forcebiome}
                        [/then]
                    )}
                    {IF_VAR hoplite_biome equals dungeon (
                        #no longer needed
                        #[and]
                        #  [variable]
                        #     name=hoplite_depth
                        #     greater_than_equal_to=0
                        #  [/variable]
                        #[/and]
                        [then]
                            {HOPLITE_CRYPT_RANDTYPE}
                            {HOPLITE_CRYPT_GENERATION}
                            {VARIABLE dungeon_seen yes}
                        [/then]
                        [elseif]
                            [variable]
                                name=hoplite_biome
                                equals=aquatic
                            [/variable]
                            [then]
                                {RANDOM 1..6}
                                [switch]
                                    variable=random
                                    [case]
                                        value=1
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Hoplite_Flooded_Cave1.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 2-10 3}
                                    [/case]
                                    [case]
                                        value=2
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Hoplite_Flooded_Cave2.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 1,11 4-6}
                                    [/case]
                                    [case]
                                        value=3
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Hoplite_Flooded_Cave3.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 4 8}
                                    [/case]
                                    [case]
                                        value=4
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Hoplite_Flooded_Cave4.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 2,10 4-6}
                                    [/case]
                                    [case]
                                        value=5
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Hoplite_Flooded_Cave5.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 9 8}
                                    [/case]
                                    [case]
                                        value=6
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Hoplite_Flooded_Cave6.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 1,11 4-6}
                                    [/case]
                                [/switch]

                                #low tide/high tide random events, random 1 is low tide, random 2 is high:
                                {RANDOM 1..6}

                                {IF_VAR random equals 1 (
                                    [then]
                                        #replace shallow water with ford
                                        [terrain]
                                            terrain=Wwf
                                            [and]
                                                terrain=Ww*^*
                                            [/and]
                                            layer=base
                                        [/terrain]
                                        #replace deep water with shallow water
                                        [terrain]
                                            terrain=Ww
                                            [and]
                                                terrain=Wo*^*
                                            [/and]
                                            layer=base
                                        [/terrain]
                                        {VARIABLE spartan_message_low_tide yes}
                                    [/then]
                                )}
                                {IF_VAR random equals 2 (
                                    [then]
                                        #replace sand with ford
                                        [terrain]
                                            terrain=Wwf
                                            [and]
                                                terrain=D*^*
                                            [/and]
                                            layer=base
                                        [/terrain]
                                        {VARIABLE spartan_message_high_tide yes}
                                    [/then]
                                )}

                                {VARIABLE hoplite_enemyamount "$($hoplite_depth + 1)"}
                                {VARIABLE hoplite_enemyterrain W*^*,D*^*}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_BEFORE_DEPTH hoplite_enemytable 40 Hoplite_Tentacle,Hoplite_Giantcrab,Hoplite_Nagahunter}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 6 Hoplite_Cuttlefish}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_BETWEEN_DEPTHS hoplite_enemytable 6 40 Hoplite_Tentacle,Hoplite_Nagahunter}#cuttlefish slightly dilluted by the lvl1 units
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 8 Hoplite_Serpentmage}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 11 Hoplite_Nagamage}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 16 Hoplite_Hydra,Hoplite_Bonepirate}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 21 Hoplite_Nagaharpooner}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 25 Hoplite_Kraken}
                                #after depth 40 common enemies are replaced with lvl2s
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 40 Hoplite_Bonepirate,Hoplite_Hydra,Hoplite_Nagamage,Hoplite_Nagaharpooner}
                                {VARIABLE waterdepth_seen yes}
                            [/then]
                        [/elseif]
                        [elseif]
                            [variable]
                                name=hoplite_biome
                                equals=sand
                            [/variable]
                            [then]
                                [replace_schedule]
                                    {SPARTAN_DESERT_CAVE}
                                [/replace_schedule]
                                {RANDOM 1..5}
                                [switch]
                                    variable=random
                                    [case]
                                        value=1
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Hoplite_Sand.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 2-10 3-4}
                                    [/case]
                                    [case]
                                        value=2
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Sand_Caverns.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 2-10 3-4}
                                    [/case]
                                    [case]
                                        value=3
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Sand_Desert.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 2-10 3-4}
                                    [/case]
                                    [case]
                                        value=4
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Sand_Citadel.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 2-10 3-4}
                                    [/case]
                                    [case]
                                        value=5
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Sand_Oasis.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 2-10 3-4}
                                    [/case]
                                [/switch]
                                {VARIABLE hoplite_enemyamount "$($hoplite_depth + 1)"}
                                {VARIABLE hoplite_enemyterrain {SPARTAN_UNITSPAWN_TERRAIN}}
                                #before depth 40, use normal unitpool. after depth 40, common lvl1 units are replaced by their lvl2 counterparts
                                #PLACEHOLDER UNITPOOL, add proper enemies later
                                {HOPLITE_ADD_ENEMIES_TO_LIST_BEFORE_DEPTH hoplite_enemytable 40 Hoplite_Cyclops,Hoplite_Mudcrawler,Hoplite_Sand_Scorpion,Hoplite_Cyclops,Hoplite_Mudcrawler,Hoplite_Sand_Scorpion}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 8 Hoplite_Dust_Devil}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 11 Hoplite_Cyclops_Brute,Hoplite_Mudgolem}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_BETWEEN_DEPTHS hoplite_enemytable 11 40 Hoplite_Cyclops}#to dilute the enemy pool a bit before depth 40
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 14 Hoplite_Giant_Mudcrawler}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 18 Hoplite_Cyclops_Breaker}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 21 Hoplite_Sand_Tornado}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 25 Hoplite_Cyclops_Warmonger}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 40 Hoplite_Cyclops_Breaker,Hoplite_Giant_Mudcrawler}
                                {VARIABLE sand_seen yes}

                                #sandstorm:
                                #    {RANDOM 1..3}
                                {RANDOM 1..4}#decided to make it a little less common, especially since I might add fog to some other biomes (like swamp, as rovik suggested) later on

                                {IF_VAR random equals 1 (
                                    [then]
                                        [replace_schedule]
                                            {SPARTAN_DESERT_SANDSTORM}
                                        [/replace_schedule]

                                        [modify_side]
                                            side=1
                                            fog=yes
                                        [/modify_side]
                                        [if]
                                            [have_unit]
                                                id=Hoplite2
                                            [/have_unit]
                                            [then]
                                                [modify_side]
                                                    side=2
                                                    fog=yes
                                                [/modify_side]
                                            [/then]
                                        [/if]
                                        [redraw]
                                            clear_shroud=yes
                                        [/redraw]

                                        {VARIABLE spartan_message_sandstorm yes}
                                    [/then]
                                )}
                            [/then]
                        [/elseif]
                        [elseif]
                            [variable]
                                name=hoplite_biome
                                equals=jungle
                            [/variable]
                            #no longer needed
                            #  [and]
                            #  [variable]
                            #     name=hoplite_depth
                            #     greater_than_equal_to=0
                            #  [/variable]
                            #  [/and]
                            [then]
                                {RANDOM 1..4}
                                [switch]
                                    variable=random
                                    [case]
                                        value=1
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Hoplite_Jungle1.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 2-10 3-4}
                                    [/case]
                                    [case]
                                        value=2
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Hoplite_Jungle2.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 2-10 3-4}
                                    [/case]
                                    [case]
                                        value=3
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Hoplite_Jungle3.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 2-10 3-4}
                                    [/case]
                                    [case]
                                        value=4
                                        [replace_map]
                                            map_file=~add-ons/Spartan/maps/Hoplite_Jungle4.map
                                            expand=yes
                                            shrink=yes
                                        [/replace_map]
                                        {HOPLITE_GENERATE_FORGE 2-10 3-4}
                                    [/case]
                                [/switch]
                                {VARIABLE hoplite_enemyamount "$($hoplite_depth + 1)"}
                                {VARIABLE hoplite_enemyterrain {SPARTAN_UNITSPAWN_TERRAIN}}
                                #TODO: add 'stop spawning weaker units after depth 40' code like with other biomes, after I add more lvl2-3s
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 0 Hoplite_Salamander,Hoplite_Blowgunner,Hoplite_Salamander,Hoplite_Blowgunner,Hoplite_Salamander,Hoplite_Witchdoctor,Hoplite_Toad_Rider}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 20 Hoplite_Wyvern}
                                {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable 22 Hoplite_Cobra}

                                {VARIABLE jungle_seen yes}
                            [/then]
                        [/elseif]
                        [elseif]
                            [variable]
                                name=hoplite_biome
                                equals=underworld
                            [/variable]
                            #no longer needed
                            #  [and]
                            #  [variable]
                            #     name=hoplite_depth
                            #     less_than_equal_to=0
                            #  [/variable]
                            #  [/and]
                            [then]
                                [replace_map]
                                    map_file=~add-ons/Spartan/maps/Hoplite.map
                                    expand=yes
                                    shrink=yes
                                [/replace_map]
                                {HOPLITE_GENERATE_TERRAIN}
                                {HOPLITE_GENERATE_FORGE 2-10 4-5}

                                [replace_schedule]
                                    {SPARTAN_UNDERWORLD}
                                [/replace_schedule]
                                {IF_VAR underworld_message not_equals yes (
                                    [then]
                                        [sound]
                                            name=wail.wav
                                        [/sound]
                                        {VARIABLE underworld_message yes}
                                        {VARIABLE underworld_seen yes}
                                    [/then])}
                                    {VARIABLE hoplite_enemyamount $hoplite_depth}
                                    {VARIABLE_OP hoplite_enemyamount multiply -1.5}
                                    {VARIABLE_OP hoplite_enemyamount round floor}
                                    {VARIABLE_OP hoplite_enemyamount add 7}
                                    {VARIABLE hoplite_enemyterrain {SPARTAN_UNITSPAWN_TERRAIN},Qx*^*}

                                    #since this is the underworld, before and after are swapped
                                    {HOPLITE_ADD_ENEMIES_TO_LIST_AFTER_DEPTH hoplite_enemytable -10 Hoplite_Poltergeist,Hoplite_Poltergeist,Hoplite_Shadow,Hoplite_Spectremage}
                                    {HOPLITE_ADD_ENEMIES_TO_LIST_BEFORE_DEPTH hoplite_enemytable -4 Hoplite_Abysstentacle,Hoplite_Faceless,Hoplite_Shadow,Hoplite_Banshee}
                                    {HOPLITE_ADD_ENEMIES_TO_LIST_BEFORE_DEPTH hoplite_enemytable -6 Hoplite_Cerberus}
                                    {HOPLITE_ADD_ENEMIES_TO_LIST_BEFORE_DEPTH hoplite_enemytable -10 Hoplite_Shadow,Hoplite_Poltergeist,Hoplite_Shadow,Hoplite_Spectremage,Hoplite_Cerberus,Hoplite_Banshee}

                                    {IF_VAR hoplite_depth less_than -12 (
                                        [then]
                                            {RANDOM 1..6}
                                            {IF_VAR random equals 3 (
                                                [then]
                                                    {SCATTER_UNITS 1 "Hoplite_Dummy_Unit" 2 (
                                                        terrain=Ur,Urb
                                                        y=2-6
                                                        [not]
                                                            [filter]
                                                            [/filter]
                                                            [or]
                                                                x,y=$forge_x,$forge_y
                                                            [/or]
                                                        [/not]
                                                    ) (
                                                        side=$hoplite_enemyside
                                                    )}
                                                    [store_unit]
                                                        [filter]
                                                            type=Hoplite_Dummy_Unit
                                                        [/filter]
                                                        variable=circle
                                                        kill=yes
                                                    [/store_unit]
                                                    {SPARTAN_PLACE_RETURN_PORTAL $circle.x $circle.y}
                                                    {CLEAR_VARIABLE circle}
                                                [/then])}
                                            [/then])}
                                        [/then]
                                    [/elseif]
                                    [elseif]
                                        [variable]
                                            name=hoplite_biome
                                            equals=rarebiome_dwarven
                                        [/variable]
                                        [then]
                                            {RANDOM 1..4}
                                            [switch]
                                                variable=random
                                                [case]
                                                    value=1
                                                    [replace_map]
                                                        map_file=~add-ons/Spartan/maps/Dwarvish_mine.map
                                                        expand=yes
                                                        shrink=yes
                                                    [/replace_map]
                                                    {HOPLITE_GENERATE_FORGE 2-10 4-5}
                                                [/case]
                                                [case]
                                                    value=2
                                                    [replace_map]
                                                        map_file=~add-ons/Spartan/maps/Dwarvish_railroad.map
                                                        expand=yes
                                                        shrink=yes
                                                    [/replace_map]
                                                    {HOPLITE_GENERATE_FORGE 2-10 4-5}
                                                [/case]
                                                [case]
                                                    value=3
                                                    [replace_map]
                                                        map_file=~add-ons/Spartan/maps/Dwarvish_castle.map
                                                        expand=yes
                                                        shrink=yes
                                                    [/replace_map]
                                                    {HOPLITE_GENERATE_FORGE 4-8 3-6}
                                                [/case]
                                                [case]
                                                    value=4
                                                    [replace_map]
                                                        map_file=~add-ons/Spartan/maps/Dwarvish_cliff.map
                                                        expand=yes
                                                        shrink=yes
                                                    [/replace_map]
                                                    {HOPLITE_GENERATE_FORGE 2-10 3-4}
                                                [/case]
                                            [/switch]
                                            [replace_schedule]
                                                {SPARTAN_UNDERGROUND}
                                            [/replace_schedule]

                                            {IF_VAR algadurmet not_equals yes (
                                                [then]
                                                    {UNIT $hoplite_allyside (Hoplite_Steelclad) 6 7 (
                                                        id=Algadur
                                                        name=_"Algadur"
                                                        facing=s
                                                        placement=map
                                                        passable=yes
                                                    )}
                                                    [unit_overlay]
                                                        id=Algadur
                                                        image=misc/hero-icon.png
                                                    [/unit_overlay]
#ifdef MULTIPLAYER
                                                    [object]
                                                        silent=yes
                                                        duration=forever
                                                        [filter]
                                                            id=Algadur
                                                        [/filter]
                                                        [effect]
                                                            apply_to=attack
                                                            range=melee
                                                            increase_damage=3#this way, when maxed, he'll deal 15 damage, enough to one-shot normal enemies in MP
                                                        [/effect]
                                                    [/object]
#endif
                                                [/then]
                                                [else]
                                                    {UNIT $hoplite_allyside (Hoplite_Runesmith) 6 7 (
                                                        id=runesmith
                                                        generate_name=yes
                                                        #   name=_"Runesmith"
                                                        facing=s
                                                        placement=map
                                                        passable=yes
                                                    )}
                                                    [unit_overlay]
                                                        id=runesmith
                                                        image=misc/hero-icon.png
                                                    [/unit_overlay]
                                                [/else])}
                                                {VARIABLE herobuff "$($hoplite_depth / 4)"}
                                                [if]
                                                    [variable]
                                                        name=herobuff
                                                        greater_than=8
                                                    [/variable]
                                                    [then]
                                                        {VARIABLE herobuff 8}
                                                    [/then]
                                                [/if]
                                                {REPEAT $herobuff (
                                                    [object]
                                                        silent=yes
                                                        duration=forever
                                                        [filter]
                                                            id=runesmith
                                                        [/filter]
                                                        [effect]
                                                            apply_to=hitpoints
                                                            increase=5
                                                            increase_total=5
                                                        [/effect]
                                                    [/object]
                                                )}
                                                {VARIABLE herobuff2 "$($hoplite_depth / 4)"}
                                                {VARIABLE_OP herobuff2 round floor}
                                                [if]
                                                    [variable]
                                                        name=herobuff2
                                                        greater_than=7
                                                    [/variable]
                                                    [then]
                                                        {VARIABLE herobuff2 7}
                                                    [/then]
                                                [/if]

                                                #on higher difficulties, more dwarf fighters can spawn

                                                {VARIABLE_OP herobuff2 multiply $spartan_difficulty_values.spawnrate_mult}
                                                {VARIABLE_OP herobuff2 round floor}

                                                {REPEAT $herobuff2 (
                                                    {VARIABLE_OP dwarf_facing rand (s,se,sw,n,ne,nw)}
                                                    {UNIT $hoplite_allyside (Hoplite_Dwarffighter) 6 7 (
                                                        placement=map
                                                        passable=yes
                                                        facing=$dwarf_facing
                                                    )}
                                                    {CLEAR_VARIABLE dwarf_facing}
                                                )}
                                                {CLEAR_VARIABLE herobuff,herobuff2,dwarf_facing}

                                                {RANDOM 6..8}
                                                {SCATTER_UNITS $random "Hoplite_Dummy_Unit" 2 (
                                                    terrain=U*^*
                                                    [not]
                                                        [filter]
                                                        [/filter]
                                                    [/not]
                                                ) (
                                                    side=$hoplite_enemyside
                                                )}
                                                [store_unit]
                                                    [filter]
                                                        type=Hoplite_Dummy_Unit
                                                    [/filter]
                                                    variable=corpses
                                                    kill=yes
                                                [/store_unit]
                                                [foreach]
                                                    array=corpses
                                                    index_var=a
                                                    [do]
                                                        {RANDOM 1..3}
                                                        [if]
                                                            [variable]
                                                                name=random
                                                                equals=2
                                                            [/variable]
                                                            [then]
                                                                [item]
                                                                    image="units/dwarves/thunderer/thunderer-die3.png~RC(magenta>green)"
                                                                    x,y=$this_item.x,$this_item.y
                                                                [/item]
                                                            [/then]
                                                            [else]
                                                                [item]
                                                                    image="units/orcs/grunt-die-8.png~RC(magenta>blue)"
                                                                    x,y=$this_item.x,$this_item.y
                                                                [/item]
                                                            [/else]
                                                        [/if]
                                                    [/do]
                                                [/foreach]

                                                {CLEAR_VARIABLE corpses}

                                                {VARIABLE hoplite_enemyamount "$($hoplite_depth * 1.2 + 1)"}#slightly above-average number of enemies, due to dwarf allies
                                                {VARIABLE hoplite_enemyterrain {SPARTAN_UNITSPAWN_TERRAIN}}
                                                {SPARTAN_CAVE_UNITPOOL}
                                            [/then]
                                        [/elseif]
                                        [elseif]
                                            [variable]
                                                name=hoplite_biome
                                                equals=rarebiome_mysterious_shop
                                            [/variable]
                                            [then]
                                                {RANDOM 1..1}
                                                #TODO: maybe add different random shop maps. fairly low-priority though
                                                [switch]
                                                    variable=random
                                                    [case]
                                                        value=1
                                                        [replace_map]
                                                            map_file=~add-ons/Spartan/maps/Hoplite_Mysterious_Shop.map
                                                            expand=yes
                                                            shrink=yes
                                                        [/replace_map]
                                                        #                {HOPLITE_GENERATE_FORGE 6 3-7}
                                                        {HOPLITE_GENERATE_FORGE 3-4,8-9 4-6}
                                                    [/case]
                                                [/switch]
                                                {CLEAR_VARIABLE orbshop_in_underworld}
                                                {IF_VAR hoplite_depth less_than_equal_to 0 (
                                                    [then]
                                                        [replace_schedule]
                                                            {SPARTAN_UNDERWORLD}
                                                        [/replace_schedule]
                                                        {VARIABLE orbshop_in_underworld yes}#TODO use this for dialog filters
                                                        #replace ancient walls with chasms in underworld
                                                        [terrain]
                                                            terrain=Qxua
                                                            [and]
                                                                terrain=Xoa
                                                            [/and]
                                                        [/terrain]
                                                    [/then]
                                                    [else]
                                                        [replace_schedule]
                                                            {SPARTAN_UNDERGROUND_BLUE}#TODO: maybe custom schedule instead
                                                        [/replace_schedule]
                                                    [/else]
                                                )}

                                                #now is in center
                                                #    {UNIT $hoplite_allyside (Hoplite_Mysterious_Merchant) 4 5 (
                                                {UNIT $hoplite_allyside (Hoplite_Mysterious_Merchant) 6 5 (
                                                    id=merchant
                                                    #    name=_"Mysterious Merchant"
                                                    name=_"The Merchant"
                                                    facing=se
                                                    placement=map
                                                    passable=yes
                                                )}

                                                #pact dealer got removed for now, since it was difficult to fit him into dialog
                                                #    {UNIT $hoplite_allyside (Hoplite_Mysterious_Merchant) 8 5 (
                                                #        id=pact_dealer
                                                #    name=_"Pact Dealer"
                                                #    facing=sw
                                                #    placement=map
                                                #    passable=yes
                                                #        )}

                                                {VARIABLE hoplite_enemyamount 0}
                                                {VARIABLE noautomove_this_depth yes}#level can be explored as normal
                                                [if]
                                                    [have_unit]
                                                        id=Hoplite2
                                                    [/have_unit]
                                                    [then]
                                                        #this way both players are able to shop, even if neither of them has the patience upgrade
                                                        {VARIABLE noinfinitemove_this_depth yes}
                                                    [/then]
                                                [/if]
                                            [/then]
                                        [/elseif]
                                        [else]
                                            [replace_map]
                                                map_file=~add-ons/Spartan/maps/Hoplite.map
                                                expand=yes
                                                shrink=yes
                                            [/replace_map]
                                            {HOPLITE_GENERATE_TERRAIN}
                                            {HOPLITE_GENERATE_FORGE 2-10 4-5}
                                            {RANDOM 1..5}
                                            {IF_VAR random equals 3 (
                                                [and]
                                                    {VARIABLE_CONDITIONAL hoplite_depth greater_than 5}
                                                [/and]
                                                [then]
                                                    [replace_schedule]
                                                        {SPARTAN_UNDERGROUND_RED}
                                                    [/replace_schedule]
                                                [/then])}

                                                {VARIABLE hoplite_enemyamount "$($hoplite_depth + 1)"}
                                                {VARIABLE hoplite_enemyterrain {SPARTAN_UNITSPAWN_TERRAIN},Qlf}
                                                #otherwise this affects underworld unitpool
                                                {IF_VAR hoplite_depth greater_than 0 (
                                                    [then]
                                                        #bat swarm:
                                                        {RANDOM 1..5}

                                                        {IF_VAR random equals 1 (
                                                            [then]
                                                                #besides being used for messages, the variable is also used in SPARTAN_CAVE_UNITPOOL

                                                                {VARIABLE spartan_message_batswarm yes}
                                                            [/then]
                                                        )}

                                                        {SPARTAN_CAVE_UNITPOOL}
                                                    [/then]
                                                )}
                                            [/else])}
                                            #[/then])}

                                            #[/then])}
                                            {IF_VAR hoplite_depth greater_than 40 (
                                                [and]
                                                    [variable]
                                                        name=bossfight
                                                        not_equals=yes
                                                    [/variable]
                                                [/and]
                                                [then]
                                                    {RANDOM 1..10}
                                                    {IF_VAR random equals 1 (
                                                        [then]
                                                            {SCATTER_UNITS 1 "Hoplite_Dummy_Unit" 2 (
                                                                terrain=Ur,Urb
                                                                y=3-7
                                                                [not]
                                                                    [filter]
                                                                    [/filter]
                                                                    [or]
                                                                        x,y=$forge_x,$forge_y
                                                                    [/or]
                                                                [/not]
                                                            ) (
                                                                side=$hoplite_enemyside
                                                            )}
                                                            [store_unit]
                                                                [filter]
                                                                    type=Hoplite_Dummy_Unit
                                                                [/filter]
                                                                variable=darkcircle
                                                                kill=yes
                                                            [/store_unit]
                                                            {SPARTAN_PLACE_DARKPORTAL $darkcircle.x $darkcircle.y}
                                                            {VARIABLE darkcircle_x $darkcircle.x}
                                                            {VARIABLE darkcircle_y $darkcircle.y}
                                                            {CLEAR_VARIABLE darkcircle}
                                                        [/then])}
                                                    [/then])}
                                                    [fire_event]
                                                        id=random_textitem
                                                    [/fire_event]
                                                    #        {HOPLITE_SCATTER_ENEMY $hoplite_enemyamount $hoplite_enemytable $hoplite_enemyterrain}

                                                    #moved into depthdescent event, to make enemies spawn AFTER allies (otherwise in really lategame enemies they could previously prevent allies from spawning)
                                                    #  {HOPLITE_SCATTER_ENEMIES_NEW $hoplite_enemyamount hoplite_enemytable $hoplite_enemyterrain}
                                                    #	{CLEAR_VARIABLE hoplite_enemyamount}
                                                    #	{CLEAR_VARIABLE hoplite_enemytable}
                                                    #	{CLEAR_VARIABLE hoplite_enemyterrain}
                                                [/then])}
                                                {CLEAR_VARIABLE random_event}
                                                {CLEAR_VARIABLE hoplite_event_biomechosen}
#enddef

#define SPARTAN_LEVEL_GENERATION_EVENTS
    [event]
        id=hoplite_depthdescent
        first_time_only=no
        [fire_event]
            name=spartan_custom_predescent_events
        [/fire_event]
        {VARIABLE hoplite_nospear yes}
        {IF_VAR depthdescent_nofade not_equals yes (
            [then]
                {FADE_TO_BLACK}
            [/then])}
            [kill]
                side=$hoplite_enemyside,$hoplite_allyside
                [not]
                    trait=loyal
                    #	      ability=hoplite_companion
                    #        [or]
                    #          ability=hoplite_loyalthrall_filter
                    #        [/or]
                [/not]
                animate=no
                fire_event=no
            [/kill]
#ifdef MULTIPLAYER
            {TELEPORT_UNIT id=Hoplite 5 10}
            {TELEPORT_UNIT id=Hoplite2 7 10}
            #clear fog from stuff like Sandstorm
            [modify_side]
                side=1
                fog=no
            [/modify_side]
            [modify_side]
                side=2
                fog=no
            [/modify_side]
#else
            {TELEPORT_UNIT id=Hoplite 6 10}
            #clear fog from stuff like Sandstorm
            [modify_side]
                side=1
                fog=no
            [/modify_side]
#endif
            [replace_schedule]
                {SPARTAN_UNDERGROUND}
            [/replace_schedule]
            [remove_time_area]
                id=heat,void
            [/remove_time_area]
            [store_unit]
                [filter]
                    id=Hoplite
                [/filter]
                variable=hoplitehealed
                kill=no
            [/store_unit]
            #depth healing used to be half, but decided to nerf it to a third to make healing upgrades more valuable, and to encourage players to be more careful
            #(companions/loyal thralls still heal 50% per depth, as at the moment there aren't really other reliable ways to heal them)
            {VARIABLE hoplitehealed.moves $hoplitehealed.max_moves}
            {VARIABLE hoplitehealed.attacks_left $hoplitehealed.max_attacks}
            [unstore_unit]
                variable=hoplitehealed
            [/unstore_unit]
            [heal_unit]
                [filter]
                    id=Hoplite
                [/filter]
                amount="$($hoplitehealed.max_hitpoints / 3)"
                animate=no
            [/heal_unit]
            #if the Hoplite leaped into the exit, clear leap
            [object]
                silent=yes
                duration=turn end
                [filter]
                    id=Hoplite
                [/filter]
                [effect]
                    apply_to=remove_ability
                    [abilities]
                        {ABILITY_LEAPING2}
                        {ABILITY_HOPLITE_TELEPORTING}
                    [/abilities]
                [/effect]
            [/object]
            {CLEAR_VARIABLE hopliteheal}
            {CLEAR_VARIABLE hoplitehealed}
            [if]
                [have_unit]
                    id=Hoplite2
                [/have_unit]
                [then]
                    [store_unit]
                        [filter]
                            id=Hoplite2
                        [/filter]
                        variable=hoplitehealed2
                        kill=no
                    [/store_unit]
                    #depth healing used to be half, but decided to nerf it to a third to make healing upgrades more valuable, and to encourage players to be more careful
                    #(companions/loyal thralls still heal 50% per depth, as at the moment there aren't really other reliable ways to heal them)
                    #	    {VARIABLE_OP hopliteheal2 divide 2}
                    {VARIABLE hoplitehealed2.moves 1}
                    {VARIABLE hoplitehealed2.attacks_left 1}
                    [unstore_unit]
                        variable=hoplitehealed2
                    [/unstore_unit]
                    [heal_unit]
                        [filter]
                            id=Hoplite2
                        [/filter]
                        amount="$($hoplitehealed2.max_hitpoints / 3)"
                        animate=no
                    [/heal_unit]
                    {CLEAR_VARIABLE hoplitehealed2}
                    #if the Hoplite leaped into the exit, clear leap
                    [object]
                        silent=yes
                        duration=turn end
                        [filter]
                            id=Hoplite2
                        [/filter]
                        [effect]
                            apply_to=remove_ability
                            [abilities]
                                {ABILITY_LEAPING2}
                                {ABILITY_HOPLITE_TELEPORTING}
                            [/abilities]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [have_unit]
                    trait=loyal
                    side=$hoplite_allyside
                    #	       ability=hoplite_companion
                    #           [or]
                    #                ability=hoplite_loyalthrall_filter
                    #           [/or]
                [/have_unit]
                [then]
                    [store_unit]
                        [filter]
                            #                 ability=hoplite_companion
                            #                 [or]
                            #                  ability=hoplite_loyalthrall_filter
                            #                 [/or]
                            trait=loyal
                            side=$hoplite_allyside
                        [/filter]
                        variable=companionhealed
                        kill=no
                    [/store_unit]

                    [foreach]
                        array=companionhealed
                        index_var=a
                        [do]
                            {VARIABLE this_item.moves 1}
                            {VARIABLE this_item.attacks_left 1}
                            [unstore_unit]
                                variable=this_item
                            [/unstore_unit]
                            [heal_unit]
                                [filter]
                                    id=$this_item.id
                                [/filter]
                                amount="$($this_item.max_hitpoints / 2)"
                                animate=no
                            [/heal_unit]
                            #moved lower
                            #                    {TELEPORT_UNIT id=$this_item.id 6 10}
                        [/do]
                    [/foreach]

                    {CLEAR_VARIABLE companionheal}
                    {CLEAR_VARIABLE companionhealed}
                [/then]
            [/if]
            {HOPLITE_ADD_ENERGY_BY_SIDE 1 $hoplite_maxenergy1}
#ifdef MULTIPLAYER
            {HOPLITE_ADD_ENERGY_BY_SIDE 2 $hoplite_maxenergy2}
#endif

            ##ifdef MULTIPLAYER
            #	{VARIABLE hoplite_energy1 $hoplite_maxenergy1}
            #	{VARIABLE hoplite_energy2 $hoplite_maxenergy2}
            ##removed labels for now, in favor of the new custom UI
            ##	{SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
            ##	{SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
            ##endif
            ##ifndef MULTIPLAYER
            #	{VARIABLE hoplite_energy1 $hoplite_maxenergy1}
            ##removed labels for now, in favor of the new custom UI
            ##	{SET_LABEL 10 1 "Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
            ##endif

            {IF_VAR hoplite_tutorial equals yes (
                [then]
                    {VARIABLE_OP hoplite_tutorialdepth add 1}
                [/then]
                [else]
                    {IF_VAR darkportal_active equals yes (
                        [then]
                            {VARIABLE_OP hoplite_depth add -1}
                            {VARIABLE_OP hoplite_infodepth2 add 1}#for the enemy catalog
                        [/then]
                        [else]
                            {VARIABLE_OP hoplite_depth add 1}
                            {VARIABLE_OP hoplite_infodepth add 1}#for the enemy catalog
                        [/else]
                    )}
                [/else]
            )}

            {CHECKPOINT_MESSAGE _"You may start the game from depth 11 in new playthroughs." depth11 hoplite_depth greater_than 10 }
            {CHECKPOINT_MESSAGE _"You may start the game from depth 21 in new playthroughs." depth21 hoplite_depth greater_than 20 }
            {CHECKPOINT_MESSAGE _"You may start the game from the underworld in new playthroughs." depth0 hoplite_depth less_than -6 }
            {CHECKPOINT_MESSAGE _"You may start the game from depth 31 in new playthroughs." depth31 hoplite_depth greater_than 30 }
            {CHECKPOINT_MESSAGE _"You may start the game from depth 41 in new playthroughs." depth41 hoplite_depth greater_than 39 }

            #TODO: make sandbox unlocked after beating depth 100 secret boss, instead of just reaching depth 100 (after I implement the boss)

            {CHECKPOINT_MESSAGE _"Sandbox mode unlocked: you may start the game at any depth with any amount of upgrades, and with the debug rightclick menu, but unable to earn achievements." depth99 hoplite_depth greater_than 99 }
            {HOPLITE_ACHIEVEMENT_DEPTHCHECK}
            #reset the map:
            {CLEAR_VARIABLE customfloor}
            {CLEAR_VARIABLE haveforge}
            {CLEAR_VARIABLE usedforge}
            {CLEAR_VARIABLE forge_x}
            {CLEAR_VARIABLE forge_y}
            {CLEAR_VARIABLE goldenforge}

            {CLEAR_VARIABLE circle_x}
            {CLEAR_VARIABLE circle_y}
            {CLEAR_VARIABLE darkcircle_x}
            {CLEAR_VARIABLE darkcircle_y}
            {CLEAR_VARIABLE noautomove_this_depth}
            {CLEAR_VARIABLE noinfinitemove_this_depth}
            {CLEAR_VARIABLE spartan_exitlocked_this_depth}
            [remove_item]
                x=0-99
                y=0-99
            [/remove_item]
            [remove_item]
                image=hoplite_textitem
            [/remove_item]
            {CLEAR_VARIABLE textitem}
            {CLEAR_VARIABLE darkwizard_hopliteloc_x}
            {CLEAR_VARIABLE darkwizard_hopliteloc_y}
            #reset the trapdoor image:
            {IF_VAR hoplite_depth greater_than_equal_to 40 (
                [then]
                    {VARIABLE hoplite_stairway yes}
                [/then])}
                {IF_VAR hoplite_depth greater_than_equal_to 40 (
                    [and]
                        [variable]
                            name=hoplite_depth
                            less_than=100
                        [/variable]
                    [/and]
                    [then]
                        [item]
                            image="scenery/trapdoor-open.png"
                            x,y=7,2
                        [/item]
                        [item]
                            image="terrain/stairs-spiral.png"
                            x,y=5,2
                        [/item]
                    [/then]
                    [else]
                    [/else])}
                    {IF_VAR hoplite_depth greater_than 99 (
                        [then]
                            [item]
                                image="terrain/stairs-spiral.png"
                                x,y=6,2
                            [/item]
                        [/then]
                        [elseif]
                            [variable]
                                name=hoplite_depth
                                less_than=40
                            [/variable]
                            [then]
                                [item]
                                    image="scenery/trapdoor-open.png"
                                    x,y=6,2
                                [/item]
                            [/then]
                        [/elseif])}
                        [replace_schedule]
                            {SPARTAN_UNDERGROUND}
                        [/replace_schedule]
                        {CLEAR_VARIABLE bossfight}
                        {CLEAR_VARIABLE customfloor}
                        {RANDOM_MAP_TYPE}
                        [if]
                            [have_unit]
                                id=Elizabeth
                            [/have_unit]
                            #	    [and]
                            #	    {VARIABLE_CONDITIONAL elizabethmet equals yes}
                            #	    [/and]
                            [and]
                                {VARIABLE_CONDITIONAL elizabethII_unlocked1 equals yes}
                                [or]
                                    {VARIABLE_CONDITIONAL elizabethII_unlocked2 equals yes}
                                [/or]
                            [/and]
                            [then]
                                {UNIT $hoplite_allyside (Hoplite_Fireguardian) 5 9 (
                                    placement=map
                                    passable=yes
                                )}
                                {UNIT $hoplite_allyside (Hoplite_Fireguardian) 7 9 (
                                    placement=map
                                    passable=yes
                                )}
                            [/then]
                        [/if]

                        {IF_VAR bear_unlocked1 equals yes (
                            [then]
                                {SCATTER_UNITS 1 Hoplite_Cavebear_ally 1 (
                                    terrain={SPARTAN_UNITSPAWN_TERRAIN}
                                    [not]
                                        [filter]
                                        [/filter]
                                    [/not]
                                ) (
                                    id=cavebear1
                                    side=$hoplite_allyside
                                    [modifications]
                                        [object]
                                            silent=yes
                                            [effect]
                                                apply_to=new_ability
                                                [abilities]
                                                    [dummy]
                                                        id=spartan_ally_owner_side1
                                                    [/dummy]
                                                [/abilities]
                                            [/effect]
                                        [/object]
                                    [/modifications]
                                )}
                            [/then]
                        )}

                        {IF_VAR bear_unlocked2 equals yes (
                            [then]
                                {SCATTER_UNITS 1 Hoplite_Cavebear_ally 1 (
                                    terrain={SPARTAN_UNITSPAWN_TERRAIN}
                                    [not]
                                        [filter]
                                        [/filter]
                                    [/not]
                                ) (
                                    id=cavebear2
                                    side=$hoplite_allyside
                                    [modifications]
                                        [object]
                                            silent=yes
                                            [effect]
                                                apply_to=new_ability
                                                [abilities]
                                                    [dummy]
                                                        id=spartan_ally_owner_side2
                                                    [/dummy]
                                                [/abilities]
                                            [/effect]
                                        [/object]
                                    [/modifications]
                                )}
                            [/then]
                        )}

                        {IF_VAR hoplite_rats1 greater_than 0 (
                            [then]
                                {VARIABLE tmp_ratspawn $hoplite_rats1}
                                {IF_VAR rat_powerII_unlocked equals yes (
                                    [or]
                                        {VARIABLE_CONDITIONAL rat_powerII_unlocked1 equals yes}
                                    [/or]
                                    [then]
                                        #two-thirds as many rats with colossal rats
                                        {VARIABLE_OP tmp_ratspawn multiply 2}
                                        {VARIABLE_OP tmp_ratspawn divide 3}
                                    [/then]
                                )}
                                {SCATTER_UNITS $tmp_ratspawn Hoplite_Giantrat_ally 1 (
                                    terrain={SPARTAN_UNITSPAWN_TERRAIN}
                                    [not]
                                        [filter]
                                        [/filter]
                                    [/not]
                                ) (
                                    side=$hoplite_allyside
                                    [modifications]
                                        [object]
                                            silent=yes
                                            [effect]
                                                apply_to=new_ability
                                                [abilities]
                                                    [dummy]
                                                        id=spartan_ally_owner_side1
                                                    [/dummy]
                                                [/abilities]
                                            [/effect]
                                        [/object]
                                    [/modifications]
                                )}
                            [/then])}
                            {IF_VAR hoplite_rats2 greater_than 0 (
                                [then]
                                    {VARIABLE tmp_ratspawn $hoplite_rats2}
                                    {IF_VAR rat_powerII_unlocked2 equals yes (
                                        [then]
                                            #two-thirds as many rats with colossal rats
                                            {VARIABLE_OP tmp_ratspawn multiply 2}
                                            {VARIABLE_OP tmp_ratspawn divide 3}
                                        [/then]
                                    )}
                                    {SCATTER_UNITS $tmp_ratspawn Hoplite_Giantrat_ally 1 (
                                        terrain={SPARTAN_UNITSPAWN_TERRAIN}
                                        [not]
                                            [filter]
                                            [/filter]
                                        [/not]
                                    ) (
                                        side=$hoplite_allyside
                                        [modifications]
                                            [object]
                                                silent=yes
                                                [effect]
                                                    apply_to=new_ability
                                                    [abilities]
                                                        [dummy]
                                                            id=spartan_ally_owner_side2
                                                        [/dummy]
                                                    [/abilities]
                                                [/effect]
                                            [/object]
                                        [/modifications]
                                    )}
                                [/then])}
                                {CLEAR_VARIABLE tmp_ratspawn}
                                {IF_VAR ambush_unlocked1 equals yes (
                                    [or]
                                        [variable]
                                            name=ambush_unlocked2
                                            equals=yes
                                        [/variable]
                                    [/or]
                                    [then]
                                        #allies are not immediately targeted upon entering a depth:
                                        [modify_side]
                                            side=$hoplite_allyside
                                            team_name=hoplite,enemy
                                            user_team_name=_"Allies"
                                        [/modify_side]
                                    [/then])}
                                    #removed labels for now, in favor of the new custom UI
                                    #  {IF_VAR hoplite_tutorial equals yes (
                                    #  [then]
                                    #  {SET_LABEL 2 1 "Tutorial: $hoplite_tutorialdepth|"}
                                    #  [/then]
                                    #  [else]
                                    #  {SET_LABEL 2 1 "Depth: $hoplite_depth|"}
                                    #  [/else]
                                    #  )}
                                    #maybe re-add later:
                                    #	{IF_VAR hoplite_depth less_than 0 (
                                    #	[then]
                                    #	{SET_LABEL 2 1 "Depth: ???"}
                                    #	[/then])}
                                    #restore spear of both players

                                    #teleport allies to player after map loads but before enemies are spawned:

                                    [store_unit]
                                        [filter]
                                            trait=loyal
                                            side=$hoplite_allyside
                                        [/filter]
                                        variable=companionteleport
                                        kill=no
                                    [/store_unit]

                                    [foreach]
                                        array=companionteleport
                                        index_var=a
                                        [do]
                                            {TELEPORT_UNIT id=$this_item.id 6 10}
                                        [/do]
                                    [/foreach]

                                    {CLEAR_VARIABLE companionteleport}

                                    #spawning enemies AFTER allies now:

                                    {HOPLITE_SCATTER_ENEMIES_NEW $hoplite_enemyamount hoplite_enemytable $hoplite_enemyterrain}
                                    {CLEAR_VARIABLE hoplite_enemyamount}
                                    {CLEAR_VARIABLE hoplite_enemytable}
                                    {CLEAR_VARIABLE hoplite_enemyterrain}

                                    {IF_VAR hoplite_spear_on_ground1 equals yes (
                                        [then]
                                            [object]
                                                silent=yes
                                                duration=forever
                                                [filter]
                                                    id=Hoplite
                                                [/filter]
                                                [effect]
                                                    apply_to=variation
                                                    name=none
                                                [/effect]
                                            [/object]
                                            {VARIABLE hoplite_spear_on_ground1 no}
                                            {CLEAR_VARIABLE hoplite_spearloc1}
                                        [/then]
                                    )}
                                    {IF_VAR hoplite_spear_on_ground2 equals yes (
                                        [then]
                                            [object]
                                                silent=yes
                                                duration=forever
                                                [filter]
                                                    id=Hoplite2
                                                [/filter]
                                                [effect]
                                                    apply_to=variation
                                                    name=none
                                                [/effect]
                                            [/object]

                                            {VARIABLE hoplite_spear_on_ground2 no}
                                            {CLEAR_VARIABLE hoplite_spearloc2}
                                        [/then]
                                    )}

#ifdef SPARTAN_MUSIC_FOUND
                                    #commented out as music now changes in companion_dialog.cfg
                                    #	{IF_VAR bossfight equals yes (
                                    #	[and]
                                    #	  [have_unit]
                                    #	     type=Hoplite_Spider_Queen
                                    #	  [/have_unit]
                                    #	[/and]
                                    #	[then]
                                    #      {SPARTAN_SMOOTH_REPLACE_MUSIC march-of-the-droids.ogg 1000 0}
                                    #	[/then]
                                    #	)}
                                    #	{IF_VAR bossfight equals yes (
                                    #	[and]
                                    #	{VARIABLE_CONDITIONAL archmagemet equals yes}
                                    #	[/and]
                                    #	[and]
                                    #	  [have_unit]
                                    #	     type=Hoplite_Archmage
                                    #	     [filter_wml]
                                    #	     [not]
                                    #	       variation=shaxtal
                                    #	     [/not]
                                    #	     [/filter_wml]
                                    #	  [/have_unit]
                                    #	[/and]
                                    #	[then]
                                    #      {SPARTAN_SMOOTH_REPLACE_MUSIC burning.ogg 1000 0}
                                    #	[/then])}
                                    #	{IF_VAR bossfight equals yes (
                                    #	[and]
                                    #	  [have_unit]
                                    #	     type=Hoplite_Ares
                                    #	  [/have_unit]
                                    #	[/and]
                                    #	[then]
                                    #      {SPARTAN_SMOOTH_REPLACE_MUSIC gathering_storm.ogg 1000 0}
                                    #	[/then])}
                                    {IF_VAR bossfight equals yes (
                                        [and]
                                            [have_unit]
                                                type=Hoplite_Minotaur
                                            [/have_unit]
                                        [/and]
                                        [then]
                                            {SPARTAN_SMOOTH_REPLACE_MUSIC tunneled.ogg 1000 0}
                                        [/then])}
                                        #	{IF_VAR bossfight equals yes (
                                        #	[and]
                                        #	  [have_unit]
                                        #	     type=Hoplite_Grimreaper
                                        #	  [/have_unit]
                                        #	[/and]
                                        #	[then]
                                        #      {SPARTAN_SMOOTH_REPLACE_MUSIC moleman.ogg 1000 0}
                                        #	[/then])}
#endif
#ifndef SPARTAN_MUSIC_FOUND
                                        {IF_VAR bossfight equals yes (
                                            [then]
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC battle-epic.ogg 1000 0}
                                            [/then]
                                        )}
#endif
                                        [set_variable]
                                            name=hoplite_revive_cooldown1
                                            sub=1
                                        [/set_variable]
                                        [set_variable]
                                            name=hoplite_revive_cooldown2
                                            sub=1
                                        [/set_variable]
                                        #        [set_variable]
                                        #	    name=hoplite_healpotion_cooldown
                                        #	    sub=1
                                        #	[/set_variable]
                                        #        [set_variable]
                                        #	    name=hoplite_healpotion_cooldown1
                                        #	    sub=1
                                        #	[/set_variable]
                                        #        [set_variable]
                                        #	    name=hoplite_healpotion_cooldown2
                                        #	    sub=1
                                        #	[/set_variable]
                                        {VARIABLE_OP healpotions_in_inventory1 add $healpotions_per_depth1}
                                        {IF_VAR healpotions_in_inventory1 greater_than $healpotion_capacity1 (
                                            [then]
                                                {VARIABLE healpotions_in_inventory1 $healpotion_capacity1}
                                            [/then]
                                        )}
                                        {VARIABLE_OP healpotions_in_inventory2 add $healpotions_per_depth2}
                                        {IF_VAR healpotions_in_inventory2 greater_than $healpotion_capacity2 (
                                            [then]
                                                {VARIABLE healpotions_in_inventory2 $healpotion_capacity2}
                                            [/then]
                                        )}
                                        [set_variable]
                                            name=hoplite_adrenalinerush_cooldown1
                                            sub=1
                                        [/set_variable]
                                        [set_variable]
                                            name=hoplite_adrenalinerush_cooldown2
                                            sub=1
                                        [/set_variable]
                                        [set_variable]
                                            name=hoplite_shadowclone_cooldown1
                                            sub=1
                                        [/set_variable]
                                        [set_variable]
                                            name=hoplite_shadowclone_cooldown2
                                            sub=1
                                        [/set_variable]
                                        [set_variable]
                                            name=hoplite_summonedarcher_cooldown1
                                            sub=1
                                        [/set_variable]
                                        [set_variable]
                                            name=hoplite_summonedarcher_cooldown2
                                            sub=1
                                        [/set_variable]
                                        [set_variable]
                                            name=hoplite_book_of_pacts_cooldown1
                                            sub=1
                                        [/set_variable]
                                        [set_variable]
                                            name=hoplite_book_of_pacts_cooldown2
                                            sub=1
                                        [/set_variable]
                                        [set_variable]
                                            name=algadur_cooldown
                                            sub=1
                                        [/set_variable]
                                        [set_variable]
                                            name=elizabeth_cooldown
                                            sub=1
                                        [/set_variable]
                                        {VARIABLE hoplite_harpoon_cooldown1_1 0}
                                        {VARIABLE hoplite_harpoon_cooldown1_2 0}
                                        {VARIABLE hoplite_harpoon_cooldown1 0}
                                        {VARIABLE hoplite_harpoon_cooldown2_1 0}
                                        {VARIABLE hoplite_harpoon_cooldown2_2 0}
                                        {VARIABLE hoplite_harpoon_cooldown2 0}
                                        {VARIABLE shadowclone_leap_cooldown 0}
                                        {VARIABLE hoplite_wizardbeam_cooldown 0}
                                        {VARIABLE hoplite_wizardbeam_cooldown1 0}
                                        {VARIABLE hoplite_wizardbeam_cooldown2 0}
                                        {VARIABLE hoplite_enthrall_cooldown 0}
                                        {VARIABLE hoplite_enthrall_cooldown1 0}
                                        {VARIABLE hoplite_enthrall_cooldown2 0}
                                        #	{CLEAR_VARIABLE demilich_delay}
                                        #	{CLEAR_VARIABLE serpentmage_delay}
                                        {CLEAR_VARIABLE hoplite_ratking}
                                        {CLEAR_VARIABLE hoplite_ratking1}
                                        {CLEAR_VARIABLE hoplite_ratking2}
                                        #        {MODIFY_UNIT id=Hoplite attacks_left 1}
                                        #        {MODIFY_UNIT id=Hoplite moves 1}
                                        #empty replace schedule is pointless, removed
                                        #        [replace_schedule]
                                        #	[/replace_schedule]
                                        {FADE_IN}

                                        {IF_VAR spartan_message_sandstorm equals yes (
                                            [then]
                                                [sound]
                                                    name=magic-faeriefire.ogg
                                                [/sound]
                                                [print]
                                                    text= _ "Sandstorm!"
                                                    size=30
                                                    red=255
                                                    green=155
                                                    duration=2000
                                                [/print]
                                                {CLEAR_VARIABLE spartan_message_sandstorm}
                                            [/then]
                                        )}
                                        {IF_VAR spartan_message_batswarm equals yes (
                                            [then]
                                                [sound]
                                                    name={SOUND_LIST:BAT_HIT}
                                                [/sound]
                                                [print]
                                                    text= _ "Bat Swarm!"
                                                    size=30
                                                    red=255
                                                    green=155
                                                    duration=2000
                                                [/print]
                                                {CLEAR_VARIABLE spartan_message_batswarm}
                                            [/then]
                                        )}
                                        {IF_VAR spartan_message_low_tide equals yes (
                                            [then]
                                                [sound]
                                                    name=water-blast.wav
                                                [/sound]
                                                [print]
                                                    text= _ "Low Tide!"
                                                    size=30
                                                    red=255
                                                    green=155
                                                    duration=2000
                                                [/print]
                                                {CLEAR_VARIABLE spartan_message_low_tide}
                                            [/then]
                                        )}
                                        {IF_VAR spartan_message_high_tide equals yes (
                                            [then]
                                                [sound]
                                                    name=water-blast.wav
                                                [/sound]
                                                [print]
                                                    text= _ "High Tide!"
                                                    size=30
                                                    red=255
                                                    green=155
                                                    duration=2000
                                                [/print]
                                                {CLEAR_VARIABLE spartan_message_high_tide}
                                            [/then]
                                        )}

                                        #semi-random music code

                                        #TODO: early depths (pre-archmage) should be just kreepor.ogg, but then later depths should slowly introduce more new tracks to old biomes
                                        #later biomes (like ones introduced post-archmage, such as jungle/ice/sand/etc.) and rare biomes should have their own tracks
                                        {IF_VAR hoplite_biome equals cave (
                                            [then]
                                                #later depths have a chance to play a different track than usual, around the time players are likely to get bored of kreepor
                                                {IF_VAR hoplite_depth greater_than 5 (
                                                    [then]
                                                        {IF_VAR hoplite_depth greater_than 20 (
                                                            [then]
                                                                {VARIABLE_OP tmp_spartan_randommusic rand kreepor.ogg,kreepor.ogg,northerners.ogg,emergence.ogg}
                                                            [/then]
                                                            [else]
                                                                {VARIABLE_OP tmp_spartan_randommusic rand kreepor.ogg,kreepor.ogg,northerners.ogg}
                                                            [/else]
                                                        )}
                                                    [/then]
                                                    [else]
                                                        {VARIABLE_OP tmp_spartan_randommusic rand kreepor.ogg}
                                                    [/else]
                                                )}
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC $tmp_spartan_randommusic 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC underground.ogg 0 0}
#endif
                                            [/then]
                                        )}
                                        {IF_VAR hoplite_biome equals dungeon (
                                            [then]
                                                #later depths have a chance to play a different track than usual, around the time players are likely to get bored of kreepor
                                                {IF_VAR hoplite_depth greater_than 5 (
                                                    [then]
                                                        {IF_VAR hoplite_depth greater_than 20 (
                                                            [then]
                                                                {VARIABLE_OP tmp_spartan_randommusic rand kreepor.ogg,kreepor.ogg,lost.ogg,bloody_bloodlust.ogg}
                                                            [/then]
                                                            [else]
                                                                {VARIABLE_OP tmp_spartan_randommusic rand kreepor.ogg,kreepor.ogg,lost.ogg}
                                                            [/else]
                                                        )}
                                                    [/then]
                                                    [else]
                                                        {VARIABLE_OP tmp_spartan_randommusic rand kreepor.ogg}
                                                    [/else]
                                                )}
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC $tmp_spartan_randommusic 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC underground.ogg 0 0}
#endif
                                            [/then]
                                        )}

                                        {IF_VAR hoplite_biome equals aquatic (
                                            [then]
                                                #later depths have a chance to play a different track than usual, around the time players are likely to get bored of kreepor
                                                {IF_VAR hoplite_depth greater_than 5 (
                                                    [then]
                                                        {IF_VAR hoplite_depth greater_than 20 (
                                                            [then]
                                                                {VARIABLE_OP tmp_spartan_randommusic rand kreepor.ogg,kreepor.ogg,down.ogg,emergence.ogg}
                                                            [/then]
                                                            [else]
                                                                {VARIABLE_OP tmp_spartan_randommusic rand kreepor.ogg,kreepor.ogg,down.ogg}
                                                            [/else]
                                                        )}
                                                    [/then]
                                                    [else]
                                                        {VARIABLE_OP tmp_spartan_randommusic rand kreepor.ogg}
                                                    [/else]
                                                )}
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC $tmp_spartan_randommusic 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC underground.ogg 0 0}
#endif
                                            [/then]
                                        )}

                                        {IF_VAR hoplite_biome equals sand (
                                            [then]
                                                #TODO: maybe add more sand tracks later
                                                {VARIABLE_OP tmp_spartan_randommusic rand camel_soup.ogg,weight_of_revenge.ogg}
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC $tmp_spartan_randommusic 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC underground.ogg 0 0}
#endif
                                            [/then]
                                        )}

                                        {IF_VAR hoplite_biome equals jungle (
                                            [then]
                                                #TODO: maybe add more jungle tracks later
                                                {VARIABLE_OP tmp_spartan_randommusic rand emergence.ogg}
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC $tmp_spartan_randommusic 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC underground.ogg 0 0}
#endif
                                            [/then]
                                        )}

                                        {IF_VAR hoplite_biome equals underworld (
                                            [then]
                                                {IF_VAR hoplite_depth less_than_equal_to -7 (
                                                    [then]
                                                        {VARIABLE_OP tmp_spartan_randommusic rand ooze.ogg,eternal.ogg,the_hall_redux.ogg,time_was_flying_by.ogg}
                                                    [/then]
                                                    [else]
                                                        {VARIABLE_OP tmp_spartan_randommusic rand ooze.ogg,eternal.ogg,the_hall_redux.ogg}
                                                    [/else]
                                                )}

                                                {SPARTAN_SMOOTH_REPLACE_MUSIC $tmp_spartan_randommusic 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC the_deep_path.ogg 0 0}
#endif
                                            [/then]
                                        )}

                                        {IF_VAR hoplite_biome equals rarebiome_dwarven (
                                            [then]
                                                {VARIABLE_OP tmp_spartan_randommusic rand knalgan_theme.ogg}
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC $tmp_spartan_randommusic 1000 0}
                                            [/then]
                                        )}

                                        {IF_VAR hoplite_biome equals rarebiome_mysterious_shop (
                                            [then]
                                                {VARIABLE_OP tmp_spartan_randommusic rand into_the_shadows.ogg,eternal.ogg}
#ifndef SPARTAN_MUSIC_FOUND
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC into_the_shadows.ogg 0 0}
#endif
                                                {SPARTAN_SMOOTH_REPLACE_MUSIC $tmp_spartan_randommusic 1000 0}
                                            [/then]
                                        )}

                                        {CLEAR_VARIABLE tmp_spartan_randommusic}
                                        [fire_event]
                                            id=spartan_spawn_patron_units
                                        [/fire_event]
                                        [fire_event]
                                            id=hoplite_depthdescent_pacteffects
                                        [/fire_event]
                                        [fire_event]
                                            id=hoplite_depthdescent_dialog
                                        [/fire_event]
                                        {CLEAR_VARIABLE depthdescent_nofade}
                                    [/event]
                                    [event]
                                        id=spartan_spawn_patron_units
                                        first_time_only=no

                                        [if]
                                            {VARIABLE_CONDITIONAL hoplite_biome equals cave}
                                            [then]
                                                #1/10 chance to spawn Jeremias
                                                {VARIABLE_OP tmp_patrontype rand (none,none,none,none,none,none,none,none,none,jeremias)}

                                                {IF_VAR tmp_patrontype equals jeremias (
                                                    [and]
                                                        {VARIABLE_CONDITIONAL patron_jeremias_spawned not_equals yes}
                                                    [/and]
                                                    [then]
                                                        {VARIABLE patron_jeremias_spawned yes}

                                                        {SCATTER_UNITS 1 "Hoplite_Patron_Jeremias" 1 (
                                                            terrain={SPARTAN_UNITSPAWN_TERRAIN}
                                                            [not]
                                                                [filter]
                                                                [/filter]
                                                                [or]
                                                                    y=7-10
                                                                [/or]
                                                            [/not]
                                                        ) (
                                                            id=Jeremias
                                                            name="Jeremiáš"#intentionally left untranslatable for now, since it is a patron username
                                                            side=$hoplite_enemyside
                                                        )}
                                                    [/then]
                                                )}
                                            [/then]
                                        [/if]

                                        [if]
                                            {VARIABLE_CONDITIONAL hoplite_depth greater_than 15}#only spawns post-ares
                                            [and]
                                                {VARIABLE_CONDITIONAL hoplite_biome equals cave}
                                                [or]
                                                    {VARIABLE_CONDITIONAL hoplite_biome equals sand}
                                                [/or]
                                            [/and]
                                            [then]
                                                #1/10 chance to spawn Inferno8
                                                {VARIABLE_OP tmp_patrontype rand (none,none,none,none,none,none,none,none,none,inferno8)}

                                                {IF_VAR tmp_patrontype equals inferno8 (
                                                    [and]
                                                        {VARIABLE_CONDITIONAL patron_inferno8_spawned not_equals yes}
                                                    [/and]
                                                    [then]
                                                        {VARIABLE patron_inferno8_spawned yes}

                                                        {SCATTER_UNITS 1 "Hoplite_Patron_Inferno8" 1 (
                                                            terrain={SPARTAN_UNITSPAWN_TERRAIN}
                                                            [not]
                                                                [filter]
                                                                [/filter]
                                                                [or]
                                                                    y=7-10
                                                                [/or]
                                                            [/not]
                                                        ) (
                                                            id=inferno8
                                                            name="inferno8"#intentionally left untranslatable for now, since it is a patron username
                                                            side=$hoplite_enemyside
                                                        )}
                                                    [/then]
                                                )}
                                            [/then]
                                        [/if]

                                        [if]
                                            {VARIABLE_CONDITIONAL hoplite_depth greater_than 15}#only spawns post-ares
                                            [and]
                                                {VARIABLE_CONDITIONAL hoplite_biome equals dungeon}
                                            [/and]
                                            [then]
                                                #1/10 chance to spawn matriarch of darkness, suggested by inferno8
                                                #            {VARIABLE_OP tmp_patrontype rand (none,none,none,none,none,none,none,none,none,inferno8_matriarch)}
                                                {VARIABLE_OP tmp_patrontype rand (inferno8_matriarch)}

                                                {IF_VAR tmp_patrontype equals inferno8_matriarch (
                                                    [and]
                                                        {VARIABLE_CONDITIONAL patron_inferno8_matriarch_spawned not_equals yes}
                                                    [/and]
                                                    [then]
                                                        {VARIABLE patron_inferno8_matriarch_spawned yes}

                                                        {SCATTER_UNITS 1 "Hoplite_Patron_Matriarch_of_Darkness" 1 (
                                                            terrain={SPARTAN_UNITSPAWN_TERRAIN}
                                                            [not]
                                                                [filter]
                                                                [/filter]
                                                                [or]
                                                                    y=7-10
                                                                [/or]
                                                            [/not]
                                                        ) (
                                                            id=inferno8_matriarch
                                                            name=_"Erebusa"#character name, rather than username, so translatable this time
                                                            side=$hoplite_enemyside
                                                        )}
                                                    [/then]
                                                )}
                                            [/then]
                                        [/if]

                                        {CLEAR_VARIABLE tmp_patrontype}
                                    [/event]
#enddef
