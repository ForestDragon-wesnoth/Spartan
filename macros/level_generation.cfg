{~add-ons/Spartan/macros/schedules.cfg}
{~add-ons/Spartan/macros/companion_dialog.cfg}

#define HOPLITE_PORTALMENU
            [message]
            speaker=narrator
            caption="Blue Portal"
            message="This circle looks similar to the one that got you here, It may be the way back to the mortal realm. Do you touch it?"
            image=scenery/summoning-center.png~SCALE(216,216)
            [option]
              image="scenery/summoning-center.png"
 	      description=_"Yes"
	      [command]
           [set_variable]
             name=portal_entrydepth
             value=$hoplite_depth
           [/set_variable]
           {COLOR_ADJUST 80 80 80}
           {COLOR_ADJUST 150 150 150}
	   [sound]
	     name=lightning.ogg
	   [/sound]
           [set_variable]
             name=hoplite_depth
             value=$darkportal_entrydepth
           [/set_variable]
           [set_variable]
             name=darkportal_active
             value=no
           [/set_variable]
	   {IF_VAR hoplite_depth greater_than 39 (
	   [then]
           {VARIABLE hoplite_stairway yes}
	   [/then])}
       [sound]
	     name={SOUND_LIST:HOLY}
       [/sound]
       {COLOR_ADJUST -512 -512 -512}
       [delay]
          time=2000
       [/delay]
       [set_variable]
          name=depthdescent_nofade
          value=yes
       [/set_variable]
       [fire_event]
	  id=hoplite_depthdescent
       [/fire_event]
       {CLEAR_VARIABLE depthdescent_nofade}
       {REPLACE_SCENARIO_MUSIC kreepor.ogg}
#ifndef SPARTAN_MUSIC_FOUND
       {REPLACE_SCENARIO_MUSIC underground.ogg}
#endif
       {ACHIEVEMENT_MESSAGE _"To hell and back: Return to the mortal realm from the underworld." return}
       {CLEAR_VARIABLE random}
           [set_variable]
             name=hoplite_usedportal
             value=yes
           [/set_variable]
       {IF_VAR elizabeth_line_return not_equals yes (
       [and]
       [have_unit]
           id=Elizabeth
       [/have_unit]
       [/and]
       [then]
       [message]
           speaker=Elizabeth
           message=_"Fresh air! Freedom, at last! This better not be a dream again... (pinches heself) Yep, this is real. Whew..."
       [/message]
       [delay]
           time=500
       [/delay]
       [message]
           speaker=Elizabeth
           message=_"Now that I'm back, I wonder just how much the world has changed while I was gone, just how many years have passed, and how my friend Elyssa is doing without me, or if she's even alive at all..."
       [/message]
       {VARIABLE elizabeth_line_return yes}
       [/then])}
       {IF_VAR algaur_line_return not_equals yes (
       [and]
       [have_unit]
           id=Algadur
       [/have_unit]
       [/and]
       [then]
       [message]
           speaker=Algadur
           message=_"Whew... back to good ol' caves."
       [/message]
       {VARIABLE algadur_line_return yes}
       [/then])}
                                    [/command]
                         	   [/option]
                                   [option]
                             	    image="misc/blank-hex.png"
 	           		    description=_"No"
	          		    [command]
                                    [/command]
                         	   [/option]
               			 [/message]			    
#enddef

#define HOPLITE_DARKPORTALMENU
       {IF_VAR elizabeth_line_portal not_equals yes (
       [and]
       [have_unit]
           id=Elizabeth
       [/have_unit]
       [/and]
       [then]
       [message]
           speaker=Elizabeth
           message=_"Wait a second, this is exactly like the accursed portal that brought me into the underworld! I don't know about you, but I sure as hell am not going back there!"
       [/message]
       {VARIABLE elizabeth_line_portal yes}
       [/then])}
       {IF_VAR dark_portal_entrydepth greater_than 0 (
       [and]
       [have_unit]
           id=Algadur
       [/have_unit]
       [/and]
       [and]
       {VARIABLE_CONDITIONAL algadur_line_portal2b not_equals yes}
       [/and]
       [then]
       [message]
           speaker=Algadur
           message=_"Aye, the lass over 'ere is right. We should stay clear from these things!"
       [/message]
       {VARIABLE algadur_line_portal2b yes}
       [/then]
       [elseif]
       [have_unit]
           id=Algadur
       [/have_unit]
       [and]
       {VARIABLE_CONDITIONAL algadur_line_portal1 not_equals yes}
       [/and]
       [and]
       {VARIABLE_CONDITIONAL algadur_line_portal2 not_equals yes}
       [/and]
       [then]
       [message]
           speaker=Algadur
           message=_"Are ye sure ye want to mess with 'tis thing? I don't like the look of it..."
       [/message]
       {VARIABLE algadur_line_portal1 yes}
       [/then]
       [/elseif])}
            [message]
            speaker=narrator
            caption="Dark Portal"
            message="You find a strange circle on the floor with an inscription written in an unknown language.  Do you touch it?"
            image=scenery/summoning-center.png~SCALE(216,216)~GS()~CS(150,0,180)
            [option]
                image="misc/blank-hex.png"
 	        description=_"No"
	        [command]
       {IF_VAR algadur_line_portal2 not_equals yes (
       [and]
       [have_unit]
           id=Algadur
       [/have_unit]
       [/and]
       [then]
       [message]
           speaker=Algadur
           message=_"Aye, good choice."
       [/message]
       {VARIABLE algadur_line_portal2 yes}
       [/then])}
       {IF_VAR elizabeth_line_portal1 not_equals yes (
       [and]
       [have_unit]
           id=Elizabeth
       [/have_unit]
       [/and]
       [then]
       [message]
           speaker=Elizabeth
           message=_"Yeah, let's get going."
       [/message]
       {VARIABLE elizabeth_line_portal1 yes}
       [/then])}
                [/command]
            [/option]
            [option]
              image="scenery/summoning-center.png~GS()~CS(150,0,180)"
 	      description=_"Yes"
	      [command]
       [if]
       [have_unit]
           id=Elizabeth
       [/have_unit]
       [then]
       {IF_VAR elizabeth_line_portal2 not_equals yes (
       [then]
       [message]
           speaker=Elizabeth
           message=_"*sigh* If you really, really want to go there, feel free to, but I am staying here."
       [/message]
       {VARIABLE elizabeth_line_portal2 yes}
       [/then])}
       [store_unit]
          [filter]
             id=Elizabeth
          [/filter]
          variable=elizabeth_stored
          kill=yes
       [/store_unit]
            {VARIABLE elizabeth_stored.hitpoints $elizabeth_stored.max_hitpoints}
            {VARIABLE elizabeth_cooldown 0}
            {VARIABLE elizabethstays yes}
       [/then]
       [/if]
       {IF_VAR algadur_line_portal3 not_equals yes (
       [and]
       [have_unit]
           id=Algadur
       [/have_unit]
       [/and]
       [then]
       [message]
           speaker=Algadur
           message=_"Though I loath the idea, I do owe ya a lot... *sigh*"
       [/message]
       {VARIABLE algadur_line_portal3 yes}
       [/then])}
           [set_variable]
             name=darkportal_entrydepth
             value=$hoplite_depth
           [/set_variable]
           {COLOR_ADJUST 80 80 80}
           {COLOR_ADJUST 150 150 150}
	   [sound]
	     name=lightning.ogg
	   [/sound]
	  {IF_VAR portal_entrydepth less_than 0 (
          [then]
           {VARIABLE hoplite_depth $portal_entrydepth}
	  [/then]
	  [else]
	   {RANDOM -0..-3}
           {VARIABLE hoplite_depth $random}
          [/else])}
          {VARIABLE darkportal_active yes}
          {VARIABLE hoplite_stairway no}
          [sound]
             name={SOUND_LIST:LICH_HIT}
	  [/sound]
       {COLOR_ADJUST -512 -512 -512}
       [delay]
          time=1000
       [/delay]
       [set_variable]
          name=depthdescent_nofade
          value=yes
       [/set_variable]
       [fire_event]
	  id=hoplite_depthdescent
       [/fire_event]
       {CLEAR_VARIABLE depthdescent_nofade}
       {SPARTAN_SMOOTH_REPLACE_MUSIC ooze.ogg 1000 0}
#ifndef SPARTAN_MUSIC_FOUND
       {SPARTAN_SMOOTH_REPLACE_MUSIC the_deep_path.ogg 1000 0}
#endif
       {CLEAR_VARIABLE random}
     {VARIABLE hoplite_usedportal yes}
         [/command]
         [/option]
         [/message]			    
#enddef

#define HOPLITE_GENERATE_TERRAIN
        {RANDOM 2..4}
		{SCATTER_UNITS $random "Hoplite_Dummy_Unit" 2 (
            terrain=Ur
	    x=4-8
	    y=4-7
            [not]
                [filter]
                [/filter]
		[or]
		[filter]
		   type=Hoplite_Dummy_Unit
		[/filter]
		   radius=3
		[/or]
		[or]
                [filter]
		   y=0-3
                [/filter]
		[/or]
		[or]
                [filter]
		   x=4-8
		   y=8-10
                [/filter]
		[/or]
            [/not]
        ) (
            side=$hoplite_enemyside
	    max_moves=2
        )}
	            [store_unit]
                        [filter]
                            type=Hoplite_Dummy_Unit
			    [filter_wml]
			       max_moves=2
			    [/filter_wml]
                        [/filter]
                        variable=lavastart
                    [/store_unit]
                    {FOREACH lavastart a}
		    {RANDOM 2..4}
		    {REPEAT $random (
		    {UNIT 2 Hoplite_Dummy_Unit $lavastart[$a].x $lavastart[$a].y ()}
                    )}
	            {NEXT a}
        [kill]
	   type=Hoplite_Dummy_Unit
	   [filter_location]
	     terrain=!,Ur
	   [/filter_location]
	[/kill]
	            [store_unit]
                        [filter]
                            type=Hoplite_Dummy_Unit
                        [/filter]
                        variable=lava
                    [/store_unit]
                            {FOREACH lava a}
	{IF_VAR hoplite_depth less_than 0 (
	[then]
        [terrain]
	    x,y=$lava[$a].x,$lava[$a].y
            terrain=Qxua
        [/terrain]
	[/then]
#	[elseif]
#	[variable]
#	    name=hoplite_depth
#	    less_than=5
#	[/variable]
#	[and]
#	[variable]
#	    name=hoplite_depth
#	    greater_than_equal_to=0
#	[/variable]
#	[/and]
#	[then]
#        [terrain]
#	    x,y=$lava[$a].x,$lava[$a].y
#            terrain=Qxu
#        [/terrain]
#	[/then]
#	[/elseif]
	[else]
        [terrain]
	    x,y=$lava[$a].x,$lava[$a].y
            terrain=Qlf
        [/terrain]
	[/else])}
	[kill]
	    id=$lava[$a].id
	    animate=no
	    fire_event=no
	[/kill]
	{NEXT a}
	{CLEAR_VARIABLE lavastart}
	{CLEAR_VARIABLE lava}
	{IF_VAR hoplite_depth less_than 0 (
	[then]
	[store_locations]
	  [filter_location]
	     terrain=Xu*
	  [/filter_location]
	  variable=walls
	[/store_locations]
	{FOREACH walls a}
	[if]
	 [have_location]
	    x,y=$walls[$a].x,$walls[$a].y
	    terrain=Xu*
	 [/have_location]
	 [then]
        [terrain]
	    x,y=$walls[$a].x,$walls[$a].y
            terrain=Qxua
        [/terrain]
	 [/then]
	[/if]
	{NEXT a}
        [terrain]
	    x=0-99
	    y=0
            terrain=Qxua
        [/terrain]
        [terrain]
	    x=0
	    y=0-99
            terrain=Qxua
        [/terrain]
        [terrain]
	    x=0-99
	    y=0
            terrain=Qxua
        [/terrain]
        [terrain]
	    x=12
	    y=0-99
            terrain=Qxua
        [/terrain]
        [terrain]
	    x=0-99
	    y=11
            terrain=Qxua
        [/terrain]
#        [terrain]
#	    [filter_location]
#	       terrain=Xu*
#	    [/filter_location]
#            terrain=Qxur
#        [/terrain]
	{CLEAR_VARIABLE walls}
	[/then])}
#enddef	
#define HOPLITE_GENERATE_FORGE X Y
	{VARIABLE_OP forge_delay add 1}		    
        {IF_VAR forge_delay equals 2 (
	[and]
	 [variable]
	  name=hoplite_depth
	  less_than_equal_to=25
	 [/variable]
	[/and]
	[and]
	 [variable]
	  name=hoplite_depth
	  greater_than_equal_to=0
	 [/variable]
	[/and]
	[or]
	 [variable]
	  name=forge_delay
	  equals=3
	 [/variable]
	 [and]
	 [variable]
	  name=hoplite_depth
	  greater_than=25
	 [/variable]
 	 [or]
	 [variable]
	  name=hoplite_depth
	  less_than=0
	 [/variable]
	 [/or]
	 [/and]
	[/or]
	[then]
		{SCATTER_UNITS 1 "Hoplite_Dummy_Unit" 2 (
            terrain=Ur,Urb,Re
	    x={X}
	    y={Y}
	    [not]
	    [filter]
	    [/filter]
	    [/not]
        ) (
            side=$hoplite_enemyside
        )}
            [store_unit]
              [filter]
                 type=Hoplite_Dummy_Unit
              [/filter]
               variable=forge
	       kill=yes
            [/store_unit]
	    [item]
	       image=terrain/forge-working.png
	       x,y=$forge.x,$forge.y
	    [/item]
	    {VARIABLE forge_x $forge.x}
	    {VARIABLE forge_y $forge.y}
	    {VARIABLE haveforge yes}
	    {VARIABLE usedforge no}
	    {CLEAR_VARIABLE forge}
	    {CLEAR_VARIABLE forge_delay}
	    [/then])}
#enddef
#define HOPLITE_SCATTER_ENEMY NUMBER TYPE TERRAIN
        [set_variable]
	   name=hoplite_scatterenemy_count
	   value={NUMBER}
	[/set_variable]
#ifdef MULTIPLAYER
        [set_variable]
	   name=hoplite_scatterenemy_count
	   multiply=1.5
	[/set_variable]
        [set_variable]
	   name=hoplite_scatterenemy_count
	   round=ceiling
	[/set_variable]
#endif
#enemies are more clustered together as the depths progress
  {IF_VAR hoplite_scatterenemy_count greater_than 10 (
  [then]
      {IF_VAR hoplite_scatterenemy_count greater_than 20 (
      [then]
      {VARIABLE tmp_scatter_radius 0}
      [/then]
      [else]
      {VARIABLE tmp_scatter_radius 1}
      [/else]
      )}
  [/then]
  [else]
      {VARIABLE tmp_scatter_radius 2}
  [/else]
  )}


		{SCATTER_UNITS $hoplite_scatterenemy_count {TYPE} $tmp_scatter_radius (
            terrain={TERRAIN}
            [not]
                [filter]
                [/filter]
		[or]
		x,y=6,10
		radius=2
		[/or]
		[or]
		[filter]
		   side=$hoplite_playerside
		[/filter]
		radius=1
		[/or]
		[or]
		[filter]
		   side=$hoplite_allyside
       level=2-99
		[/filter]
		radius=1
		[/or]
            [/not]
        ) (
            side=$hoplite_enemyside
	    placement=map
	    passable=yes
        )}
	[store_unit]
	  [filter]
	   side=$hoplite_enemyside
	  [/filter]
	  variable=enemycount
	  kill=no
	[/store_unit]
	{CLEAR_VARIABLE enemycount}
	{CLEAR_VARIABLE enemycheckrepeat}
        {CLEAR_VARIABLE hoplite_scatterenemy_count}
#enddef

#define HOPLITE_GENERATION_AMOUNT VARIABLE
	{IF_VAR {VARIABLE} greater_than_equal_to 10 (
	[then]
	  {VARIABLE_OP {VARIABLE} multiply 0.5}
	  {VARIABLE_OP {VARIABLE} round floor}
	  {VARIABLE_OP {VARIABLE} add 5}	  
	[/then])}
#enddef

#define HOPLITE_CHAOSUNITS ELSE
{IF_VAR hoplite_depth greater_than 25 (
#{IF_VAR hoplite_depth greater_than 0 (
[then]
{VARIABLE_OP chaoschance rand (1,2,3)}
{IF_VAR chaoschance equals 2 (
[or]
{VARIABLE_CONDITIONAL hoplite_depth equals 23}
[/or]
[or]
{VARIABLE_CONDITIONAL hoplite_depth equals 24}
[/or]
[then]
{VARIABLE_OP hoplite_enemy multiply 0.75}
{VARIABLE_OP hoplite_enemy round floor}
{IF_VAR hoplite_depth greater_than 27 (
[then]
	{VARIABLE hoplite_enemytable Hoplite_Chaosinvader,Hoplite_Chaosbowman,Hoplite_Headhunter,Hoplite_Chaosinvader,Hoplite_Chaosbowman,Hoplite_Headhunter,Hoplite_Chaosinvader,Hoplite_Demonwarrior,Hoplite_Chaosinvader,Hoplite_Demonstorm}
[/then]
[else]
	{VARIABLE hoplite_enemytable Hoplite_Chaosinvader,Hoplite_Chaosbowman,Hoplite_Headhunter,Hoplite_Chaosinvader,Hoplite_Chaosbowman,Hoplite_Headhunter,Hoplite_Chaosinvader,Hoplite_Demonwarrior}
[/else])}
[/then]
[else]
{ELSE}
[/else])}
{CLEAR_VARIABLE chaoschance}
[/then]
[else]
{ELSE}
[/else])}
#enddef

#define HOPLITE_CRYPT_GENERATION
        [set_variable]
	   name=hoplite_enemy
	   value=$hoplite_depth
	[/set_variable]
        {VARIABLE hoplite_enemy $hoplite_depth}
        {VARIABLE_OP hoplite_enemy add 1}
	{HOPLITE_GENERATION_AMOUNT hoplite_enemy}
	{VARIABLE hoplite_enemyamount $hoplite_enemy}
	{VARIABLE hoplite_enemyterrain Urb}
        {HOPLITE_CHAOSUNITS (
	{IF_VAR hoplite_depth greater_than_equal_to 12 (
  	[and]
	  [variable]
	     name=hoplite_depth
	     less_than=16
	  [/variable]
	[/and]
	[then]
	{VARIABLE hoplite_enemytable Hoplite_Spearman,Hoplite_Skelearcher,Hoplite_Shielder,Hoplite_Poltergeist,Hoplite_Skelearcher,Hoplite_Spearman,Hoplite_Demilich,Hoplite_Dark_Wizard}
	[/then]
	[elseif]
	  [variable]
	     name=hoplite_depth
	     greater_than_equal_to=16
	  [/variable]
  	  [and]
	  [variable]
	     name=hoplite_depth
	     less_than=30
	  [/variable]
	  [/and]
 	  [then]
   	  {VARIABLE hoplite_enemytable Hoplite_Spearman,Hoplite_Skelearcher,Hoplite_Shielder,Hoplite_Poltergeist,Hoplite_Skelearcher,Hoplite_Spearman,Hoplite_Demilich,Hoplite_Dark_Wizard,Hoplite_Armor,Hoplite_Spearman,Hoplite_Pikeman}
	  [/then]
	[/elseif]
  [elseif]
    [variable]
       name=hoplite_depth
       greater_than_equal_to=30
    [/variable]
    [then]
      {VARIABLE hoplite_enemytable Hoplite_Spearman,Hoplite_Skelearcher,Hoplite_Shielder,Hoplite_Poltergeist,Hoplite_Skelearcher,Hoplite_Spearman,Hoplite_Demilich,Hoplite_Dark_Wizard,Hoplite_Armor,Hoplite_Spearman,Hoplite_Pikeman,Hoplite_Lich}
    [/then]
  [/elseif]
	[else]
   	{VARIABLE hoplite_enemytable Hoplite_Spearman,Hoplite_Skelearcher,Hoplite_Shielder,Hoplite_Spearman,Hoplite_Skelearcher,Hoplite_Spearman,Hoplite_Demilich,Hoplite_Dark_Wizard}
	[/else])}
	)}
	{CLEAR_VARIABLE hoplite_enemy}
#enddef


#define HOPLITE_CRYPT_RANDTYPE
#   {RANDOM 1..7}
#   {RANDOM 10..11}
   {RANDOM 1..12}
   {IF_VAR random equals 1 (
   [or]
     [variable]
        name=random
	equals=6
     [/variable]
   [/or]
   [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Maze1.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        {HOPLITE_GENERATE_FORGE 9 8}
   [/then]
   [elseif]
   [variable]
     name=random
     equals=2
   [/variable]
   [or]
     [variable]
        name=random
	equals=7
     [/variable]
   [/or]
   [or]
     [variable]
        name=random
	equals=12
     [/variable]
   [/or]
   [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Maze2.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        {HOPLITE_GENERATE_FORGE 3 8}
   [/then]
   [/elseif]
   [elseif]
   [variable]
     name=random
     equals=3
   [/variable]
   [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Maze3.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        {HOPLITE_GENERATE_FORGE 4,10 2}
	[item]
	   image="items/dragonstatue.png"
	   x,y=2,2
	[/item]
	[item]
	   image="items/dragonstatue.png~FL(horiz)"
	   x,y=10,2
	[/item]
   [/then]
   [/elseif]
   [elseif]
   [variable]
     name=random
     equals=4
   [/variable]
   [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Maze4.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        {HOPLITE_GENERATE_FORGE 3,9 6}
   [/then]
   [/elseif]
   [elseif]
   [variable]
     name=random
     equals=5
   [/variable]
   [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Maze5.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        {HOPLITE_GENERATE_FORGE 2,10 7}
   [/then]
   [/elseif]
   [elseif]
   [variable]
     name=random
     equals=8
   [/variable]
   [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Maze6.map}"
            expand=yes
            shrink=yes
        [/replace_map]
	{RANDOM 12..16}
		{SCATTER_UNITS $random "Hoplite_Dummy_Unit" 1 (
            terrain=Urb
            [not]
                [filter]
                [/filter]
		[or]
		   x,y=6,2
		   radius=1
		[/or]
		[or]
		   x,y=6,10
		   radius=2
		[/or]
            [/not]
        ) (
            side=$hoplite_enemyside
        )}
	            [store_unit]
                        [filter]
                            type=Hoplite_Dummy_Unit
                        [/filter]
                        variable=walls
                    [/store_unit]
                            {FOREACH walls a}
        [terrain]
	    x,y=$walls[$a].x,$walls[$a].y
            terrain=Xos
        [/terrain]
	[kill]
	    id=$walls[$a].id
	    animate=no
	    fire_event=no
	[/kill]
	{NEXT a}
	{CLEAR_VARIABLE walls}
        {HOPLITE_GENERATE_FORGE 2,10 7}
   [/then]
   [/elseif]
   [elseif]
   [variable]
     name=random
     equals=9
   [/variable]
   [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Maze7.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        {HOPLITE_GENERATE_FORGE 6 4}
   [/then]
   [/elseif]
   [elseif]
   [variable]
     name=random
     equals=10
   [/variable]
   [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Maze8.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        {HOPLITE_GENERATE_FORGE 2-10 3,4}
   [/then]
   [/elseif]
   [elseif]
   [variable]
     name=random
     equals=11
   [/variable]
   [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Maze9.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        {HOPLITE_GENERATE_FORGE 2-10 3,4}
   [/then]
   [/elseif]
   )}
#enddef

#define RANDOM_MAP_TYPE
{IF_VAR hoplite_depth equals 10 (
#[or]
# [variable]
#    name=hoplite_depth
#    equals=30
# [/variable]
#[/or]
[then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Spidernest.map}"
            expand=yes
            shrink=yes
        [/replace_map]
	{UNIT $hoplite_enemyside (Hoplite_Spider_Queen) 6 5 (
        id=Spiderqueen
	name=_"Spider Queen"
	{IS_HERO}
        )}
	{IF_VAR hoplite_depth equals 30 (
	[then]
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Spiderqueen
		[/filter]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=5
	        [/effect]
		[effect]
		  apply_to=attack
		  range=ranged
		  increase_damage=3
	        [/effect]
		[effect]
		  apply_to=hitpoints
		  increase=30
		  increase_total=30
	        [/effect]
		[effect]
		  apply_to=image_mod
		  add="~SCALE(82,82)"
	        [/effect]
            [/object]
            [if]
            [have_unit]
             id=Hoplite2
            [/have_unit]
            [then]
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Spiderqueen
		[/filter]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2
	        [/effect]
		[effect]
		  apply_to=attack
		  range=ranged
		  increase_damage=1
	        [/effect]
            [/object]
	    [/then]
	    [/if]
        {RANDOM 12..16}
        {HOPLITE_SCATTER_ENEMY $random Hoplite_Spider_Minion,Hoplite_Spider_Minion,Hoplite_Giantspider Ur,Ur*}
	[/then]
	[else]
            [if]
            [have_unit]
             id=Hoplite2
            [/have_unit]
            [then]
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Spiderqueen
		[/filter]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=3
	        [/effect]
		[effect]
		  apply_to=hitpoints
		  increase=50%
		  increase_total=50%
	        [/effect]
            [/object]
	    [/then]
	    [/if]
        {RANDOM 8..11}
        {HOPLITE_SCATTER_ENEMY $random Hoplite_Spider_Minion Ur,Ur*}
	[/else])}
        {HOPLITE_GENERATE_FORGE 2-10 4-5}
	{VARIABLE customfloor yes}
	{VARIABLE bossfight yes}
	{IF_VAR hoplite_depth greater_than_equal_to 50 (
	[then]
	[remove_item]
	   image="scenery/trapdoor-open.png"
	   x=6,7
	   y=2,2
	[/remove_item]	
	[item]
	   image="scenery/trapdoor-closed.png"
	   x,y=7,2
	[/item]
	[/then]
	[else]
	[remove_item]
	   image="scenery/trapdoor-open.png~GS()"
	   x,y=6,2
	[/remove_item]	
	[item]
	   image="scenery/trapdoor-closed.png~GS()"
	   x,y=6,2
	[/item]
	[/else])}
	{VARIABLE spiderqueen_seen yes}
[/then]
[elseif]
 [variable]
   name=hoplite_depth
   equals=15
 [/variable]
[or]
 [variable]
    name=hoplite_depth
    equals=35
 [/variable]
[/or]
  [then]
        [replace_schedule]
	   {SPARTAN_UNDERGROUND_RED}
	[/replace_schedule]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Library.map}"
            expand=yes
            shrink=yes
        [/replace_map]
	{UNIT $hoplite_enemyside (Hoplite_Archmage) 6 4 (
        id=Archmage
	name=_"Archmage"
	facing=s
	{IS_HERO}
        )}
	{IF_VAR hoplite_depth equals 35 (
	[then]
        [replace_schedule]
	   {SPARTAN_UNDERWORLD}
	[/replace_schedule]
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Archmage
		[/filter]
		[effect]
		  apply_to=attack
		  range=ranged
		  increase_damage=100%
	        [/effect]
		[effect]
		  apply_to=hitpoints
		  increase=100%
		  increase_total=100%
	        [/effect]
		[effect]
		  apply_to=variation
		  name=shaxtal
	        [/effect]
            [/object]
	{UNIT $hoplite_enemyside (Hoplite_Demonstorm) 3 4 (facing=se)}
	{UNIT $hoplite_enemyside (Hoplite_Demonstorm) 9 4 (facing=sw)}
	{UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 5 6 (facing=se)}
	{UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 7 6 (facing=sw)}
	{UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 3 8 (facing=se)}
	{UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 9 8 (facing=sw)}
        [if]
        [have_unit]
          id=Hoplite2
        [/have_unit]
        [then]
	{UNIT $hoplite_enemyside (Hoplite_Mudgolem) 5 3 (facing=se)}
	{UNIT $hoplite_enemyside (Hoplite_Mudgolem) 7 3 (facing=sw)}
	[/then]
	[/if]
	[/then]
	[else]
	{UNIT $hoplite_enemyside (Hoplite_Fireguardian) 3 4 (facing=se)}
	{UNIT $hoplite_enemyside (Hoplite_Fireguardian) 9 4 (facing=sw)}
        [if]
        [have_unit]
          id=Hoplite2
        [/have_unit]
        [then]
	{UNIT $hoplite_enemyside (Hoplite_Fireguardian) 5 6 (facing=se)}
	{UNIT $hoplite_enemyside (Hoplite_Fireguardian) 7 6 (facing=sw)}
	[/then]
	[/if]
	[/else])}
        [if]
        [have_unit]
          id=Hoplite2
        [/have_unit]
        [then]
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Archmage
		[/filter]
		[effect]
		  apply_to=hitpoints
		  increase=50%
		  increase_total=50%
	        [/effect]
		[effect]
		  apply_to=attack
		  range=ranged
		  increase_damage=5
	        [/effect]
            [/object]
	[/then]
	[/if]
	{IF_VAR hoplite_depth greater_than_equal_to 50 (
	[then]
	[remove_item]
	   image="scenery/trapdoor-open.png"
	   x=6,7
	   y=2,2
	[/remove_item]	
	[item]
	   image="scenery/trapdoor-closed.png"
	   x,y=7,2
	[/item]
	[/then]
	[else]
	[remove_item]
	   image="scenery/trapdoor-open.png"
	   x,y=6,2
	[/remove_item]	
	[item]
	   image="scenery/trapdoor-closed.png"
	   x,y=6,2
	[/item]
	[/else])}
	[item]
	   image="items/bookcase.png"
	   x=2
	   y=3-8
	[/item]
	[item]
	   image="items/bookcase.png"
	   x,y=3,3
	[/item]
	[item]
	   image="items/bookcase.png"
	   x,y=4,2
	[/item]
	[item]
	   image="items/bookcase-sw.png"
	   x=10
	   y=3-8
	[/item]
	[item]
	   image="items/bookcase-sw.png"
	   x,y=9,3
	[/item]
	[item]
	   image="items/bookcase-sw.png"
	   x,y=8,2
	[/item]
        {HOPLITE_GENERATE_FORGE 2-10 4-5}
	{VARIABLE customfloor yes}
	{VARIABLE bossfight yes}
	{VARIABLE archmage_seen yes}
	[/then]
  [/elseif]
[elseif]
 [variable]
   name=hoplite_depth
   equals=20
 [/variable]
  [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Shrine.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        [replace_schedule]
	   {SPARTAN_UNDERGROUND_RED}
	[/replace_schedule]
	{UNIT $hoplite_enemyside (Hoplite_Ares) 6 4 (
        id=Ares
	name=_"Avatar of War"
	facing=s
	{IS_HERO}
        )}
        [if]
        [have_unit]
          id=Hoplite2
        [/have_unit]
        [then]
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Ares
		[/filter]
		[effect]
		  apply_to=hitpoints
		  increase=50%
		  increase_total=50%
	        [/effect]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2
	        [/effect]
		[effect]
		  apply_to=attack
		  range=ranged
		  increase_damage=5
	        [/effect]
            [/object]
   	    {UNIT $hoplite_enemyside (Hoplite_Hydra) 5 6 (facing=se)}
	    {UNIT $hoplite_enemyside (Hoplite_Hydra) 7 6 (facing=sw)}
	[/then]
	[/if]
	{UNIT $hoplite_enemyside (Hoplite_Hydra) 4 4 (facing=se)}
	{UNIT $hoplite_enemyside (Hoplite_Hydra) 8 4 (facing=sw)}
	[remove_item]
	   image="scenery/trapdoor-open.png"
	   x=6,7
	   y=2,2
	[/remove_item]	
	[item]
	   image="scenery/trapdoor-closed.png"
#	   x,y=7,2
	   x,y=6,2
	[/item]	
#	[item]
#	   image="terrain/stairs-spiral.png"
#	   x,y=5,2
#	[/item]	
        {HOPLITE_GENERATE_FORGE 2-10 4-5}
	{VARIABLE customfloor yes}
	{VARIABLE bossfight yes}
	{VARIABLE ares_seen yes}
#	{VARIABLE hoplite_stairway yes}
        {VARIABLE ares_leap_cooldown 3}
	[/then]
[/elseif]
[elseif]
 [variable]
   name=hoplite_depth
   equals=25
 [/variable]
  [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_donovandepth.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        [replace_schedule]
	   {SPARTAN_UNDERGROUND_BLUE}
	[/replace_schedule]
	{UNIT $hoplite_enemyside (Hoplite_Donovan) 6 5 (
        id=Donovan
	name=_"Donovan"
	facing=s
	{IS_HERO}
        )}
        [if]
        [have_unit]
          id=Hoplite2
        [/have_unit]
        [then]
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Donovan
		[/filter]
		[effect]
		  apply_to=hitpoints
		  increase=50%
		  increase_total=50%
	        [/effect]
            [/object]
   	    {UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 5 5 (facing=se)}
	    {UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 7 5 (facing=sw)}
	[/then]
	[/if]
	{UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 5 4 (facing=se)}
	{UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 7 4 (facing=sw)}
	{UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 5 6 (facing=se)}
	{UNIT $hoplite_enemyside (Hoplite_Chaosinvader) 7 6 (facing=sw)}
	[remove_item]
	   image="scenery/trapdoor-open.png"
	   x=6,7
	   y=2,2
	[/remove_item]	
	[item]
	   image="scenery/trapdoor-closed.png"
	   x,y=6,2
	[/item]	
        {HOPLITE_GENERATE_FORGE 2-10 4-5}
	{VARIABLE customfloor yes}
	{VARIABLE bossfight yes}
	{VARIABLE donovan_seen yes}
	[/then]
[/elseif]
[elseif]
 [variable]
   name=hoplite_depth
   equals=30
 [/variable]
  [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Minotaurroom.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        [replace_schedule]
	   {SPARTAN_UNDERGROUND}
	[/replace_schedule]
        [time_area]
	    id=heat
            x=0-5,3,6,0-3
            y=0-8,9,0-1,9
            {SPARTAN_UNDERGROUND_RED}
        [/time_area]
        [time_area]
	    id=void
            x=7-12,9,6
            y=0-8,9,2
            {SPARTAN_UNDERWORLD}
        [/time_area]
        {UNIT $hoplite_enemyside (Hoplite_Minotaur) 3 3 (
        id=Minotaur
	name=_"Minotaur"
	facing=s
	{IS_HERO}
        )}
	{UNIT $hoplite_enemyside (Hoplite_Warlock) 9 3 (
        id=Warlock
	name=_"Warlock"
	facing=s
	{IS_HERO}
        )}
        [if]
        [have_unit]
          id=Hoplite2
        [/have_unit]
        [then]
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Minotaur
		[/filter]
		[effect]
		  apply_to=hitpoints
		  increase=50%
		  increase_total=50%
	        [/effect]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2
	        [/effect]
            [/object]
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Warlock
		[/filter]
		[effect]
		  apply_to=hitpoints
		  increase=50%
		  increase_total=50%
	        [/effect]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2
	        [/effect]
		[effect]
		  apply_to=attack
		  range=ranged
		  increase_damage=3
	        [/effect]
            [/object]
#Minotaur minions:
	{UNIT $hoplite_enemyside (Hoplite_Fireguardian) 1 9 (facing=se)}
        {UNIT $hoplite_enemyside (Hoplite_Fireguardian) 5 7 (facing=se)}
#Warlock minions:	
	{UNIT $hoplite_enemyside (Hoplite_Demilich) 10 3 (facing=se)}
	{UNIT $hoplite_enemyside (Hoplite_Spearman) 9 8 (facing=sw)}
	[/then]
	[/if]
#Minotaur minions:
	{UNIT $hoplite_enemyside (Hoplite_Fireguardian) 2 4 (facing=se)}
#	{UNIT $hoplite_enemyside (Hoplite_Mudgolem) 5 5 (facing=sw)}
	{UNIT $hoplite_enemyside (Hoplite_Demonwarrior) 5 3 (facing=sw)}
        {UNIT $hoplite_enemyside (Hoplite_Fireguardian) 3 8 (facing=se)}
#Warlock minions:	
#	{UNIT $hoplite_enemyside (Hoplite_Demilich) 7 3 (facing=se)}
	{UNIT $hoplite_enemyside (Hoplite_Armor) 8 4 (facing=se)}
	{UNIT $hoplite_enemyside (Hoplite_Skelearcher) 10 5 (facing=sw)}
	{UNIT $hoplite_enemyside (Hoplite_Shielder) 8 7 (facing=sw)}
	
	{IF_VAR hoplite_depth greater_than_equal_to 50 (
	[then]
	[remove_item]
	   image="scenery/trapdoor-open.png"
	   x=6,7
	   y=2,2
	[/remove_item]	
	[item]
	   image="scenery/trapdoor-closed.png"
	   x,y=7,2
	[/item]	
	[item]
	   image="terrain/stairs-spiral.png"
	   x,y=5,2
	[/item]
        [/then]
	[else]
	[remove_item]
	   image="scenery/trapdoor-open.png"
	   x=6,7
	   y=2,2
	[/remove_item]	
#	[item]
#	   image="scenery/trapdoor-closed.png"
#	   x,y=6,2
#	[/item]	
	[/else])}
	[item]
	   image="scenery/summoning-center.png~GS()~CS(150,0,180)~NO_TOD_SHIFT()"
	   x,y=6,2
	[/item]
        {VARIABLE darkcircle_x 6}
        {VARIABLE darkcircle_y 2}
        {HOPLITE_GENERATE_FORGE 2-10 4-5}
	{VARIABLE customfloor yes}
	{VARIABLE bossfight yes}
	{VARIABLE duo_seen yes}
	{VARIABLE hoplite_stairway yes}
        {VARIABLE ares_leap_cooldown 3}
	[/then]
[/elseif]
[elseif]
 [variable]
   name=hoplite_depth
   equals=-10
 [/variable]
  [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Crypt.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        [replace_schedule]
	   {SPARTAN_UNDERWORLD}
	[/replace_schedule]
	{IF_VAR reaper_beaten equals yes (
	[then]
	{UNIT $hoplite_enemyside (Hoplite_Grimreaper) 6 4 (
        id=Reaper
	name=_"Grim Reaper"
	facing=s
	{IS_HERO}
        )}
        [if]
        [have_unit]
          id=Hoplite2
        [/have_unit]
        [then]
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Reaper
		[/filter]
		[effect]
		  apply_to=hitpoints
		  increase=50%
		  increase_total=50%
	        [/effect]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2
	        [/effect]
            [/object]
	[/then])}
        {RANDOM 8..12}
        {HOPLITE_SCATTER_ENEMY $random Hoplite_Poltergeist,Hoplite_Poltergeist,Hoplite_Spectremage,Hoplite_Faceless Ur*}
	[/then]
	[else]
        {RANDOM 5..8}
        {HOPLITE_SCATTER_ENEMY $random Hoplite_Poltergeist,Hoplite_Poltergeist,Hoplite_Spectremage,Hoplite_Faceless Ur*}
	[/else]
	[/if]
	[remove_item]
	   image="scenery/trapdoor-open.png"
	   x=6,7
	   y=2,2
	[/remove_item]	
	[item]
	   image="scenery/summoning-center.png~NO_TOD_SHIFT()"
	   x,y=6,2
	[/item]	
        {VARIABLE circle_x 6}
        {VARIABLE circle_y 2}
        {HOPLITE_GENERATE_FORGE 2-10 4-5}
	{VARIABLE customfloor yes}
	{VARIABLE bossfight yes}
	{VARIABLE reaper_seen yes}
	{VARIABLE hoplite_stairway yes}
	[/then]
  [/elseif]
  [elseif]
 [variable]
   name=hoplite_depth
   equals=40
 [/variable]
  [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Shrine2.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        [replace_schedule]
	   {SPARTAN_UNDERGROUND_RED}
	[/replace_schedule]
        [time_area]
	    id=heat
            x,y=6,4
	    radius=2
            {SPARTAN_UNDERGROUND_PROMETHEUSFIRE}
        [/time_area]
	[item]
	  x,y=6,4
#          image="items/prometheus-fire1.png"
	  halo="items/brazier-prometheus-fire1.png:100,items/brazier-prometheus-fire2.png:100"
	[/item]
	[terrain]
	  x,y=6,4
	  terrain=Uri^li
	[/terrain]
        {HOPLITE_GENERATE_FORGE 2-10 4-5}
	{VARIABLE customfloor yes}
	{VARIABLE hoplite_stairway yes}
	[/then]
  [/elseif]
  [else]
  {IF_VAR hoplite_depth greater_than 5 (
  [then]
#   {VARIABLE_OP random_event rand (1..2)}
   {VARIABLE_OP random_event rand (1..8)}
  [/then])}
  {IF_VAR random_event equals 2 (
  [then]
#TODO  
#   {VARIABLE_OP random_event_type rand (1,2)}
#   {IF_VAR random_event_type equals 1 (
#   [then]
        [replace_schedule]
	   {SPARTAN_UNDERGROUND}
	[/replace_schedule]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        {HOPLITE_GENERATE_TERRAIN}
	{IF_VAR algadurmet not_equals yes (
	[then]
        {HOPLITE_GENERATE_FORGE 2-10 4-5}
	{UNIT $hoplite_allyside (Hoplite_Steelclad) 6 5 (
        id=Algadur
	name=_"Algadur"
	facing=s
	placement=map
	passable=yes
	{IS_LOYAL}
        )}
#ifdef MULTIPLAYER	    
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Algadur
		[/filter]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=3#this way, when maxed, he'll deal 15 damage, enough to one-shot normal enemies in MP
	        [/effect]
            [/object]
#endif
	[/then]
	[else]
	{UNIT $hoplite_allyside (Hoplite_Runesmith) 6 5 (
        id=runesmith
	generate_name=yes
#	name=_"Runesmith"
	facing=s
	placement=map
	passable=yes
	{IS_HERO}
        )}
	[/else])}
	{VARIABLE herobuff $hoplite_depth}
	{IF_VAR herobuff greater_than 0 (
	[then]
	{VARIABLE_OP herobuff divide 4}
	{VARIABLE_OP herobuff round floor}
	{VARIABLE herobuff2 $herobuff}
	[/then])}
	[if]
	 [variable]
	    name=herobuff
	    greater_than=7
	 [/variable]
	 [then]
 	 {VARIABLE herobuff 7}
	 [/then]
	[/if]
	{REPEAT $herobuff (
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=runesmith
		[/filter]
		[effect]
		  apply_to=hitpoints
		  increase=5
		  increase_total=5
	        [/effect]
            [/object]
	)}
	{VARIABLE_OP herobuff2 multiply 0.75}
        {VARIABLE_OP herobuff2 round floor}
	[if]
	 [variable]
	    name=herobuff2
	    greater_than=6
	 [/variable]
	 [then]
 	 {VARIABLE herobuff2 6}
	 [/then]
	[/if]
	{REPEAT $herobuff2 (
        {VARIABLE_OP dwarf_facing rand (s,se,sw,n,ne,nw)}
	 {UNIT $hoplite_allyside (Hoplite_Dwarffighter) 6 5 (
	 placement=map
 	 passable=yes
	 facing=$dwarf_facing
         )}
	{CLEAR_VARIABLE dwarf_facing}
	)}
	{CLEAR_VARIABLE herobuff,herobuff2,dwarf_facing}

  {RANDOM 6..8}
    {SCATTER_UNITS $random "Hoplite_Dummy_Unit" 2 (
            terrain=Ur
      [not]
      [filter]
      [/filter]
      [/not]
        ) (
            side=$hoplite_enemyside
        )}
            [store_unit]
              [filter]
                 type=Hoplite_Dummy_Unit
              [/filter]
               variable=corpses
         kill=yes
            [/store_unit]
      {FOREACH corpses a}
      {RANDOM 1..3}
      [if]
       [variable]
          name=random
    equals=2
       [/variable]
       [then]
      [item]
         image="units/dwarves/thunderer/thunderer-die3.png~RC(magenta>green)"
         x,y=$corpses[$a].x,$corpses[$a].y
      [/item]
       [/then]
       [else]
      [item]
         image="units/orcs/grunt-die-8.png~RC(magenta>blue)"
         x,y=$corpses[$a].x,$corpses[$a].y
      [/item]
       [/else]
       [/if]
      {NEXT a}
      {CLEAR_VARIABLE corpses}

	{VARIABLE heroambush_enemies $hoplite_depth}
  {VARIABLE_OP heroambush_enemies multiply 1.2}
	{VARIABLE_OP heroambush_enemies round floor}
	{IF_VAR hoplite_depth greater_than 10 (
  	  [and]
	  [variable]
	     name=hoplite_depth
	     less_than=14
	  [/variable]
	  [/and]
	  [then]
        {HOPLITE_SCATTER_ENEMY $heroambush_enemies Hoplite_Orcgrunt,Hoplite_Orcarcher,Hoplite_Cutthroat,Hoplite_Orcbomber,Hoplite_Fireguardian,Hoplite_Cutthroat,Hoplite_Orcwarrior,Hoplite_Dark_Wizard Ur}
#	{VARIABLE fireguardian_seen yes}
	  [/then]
	[elseif]
	  [variable]
	     name=hoplite_depth
	     greater_than_equal_to=14
	  [/variable]
  	  [and]
	  [variable]
	     name=hoplite_depth
	     less_than=22
	  [/variable]
	  [/and]
	  [then]
        {HOPLITE_SCATTER_ENEMY $heroambush_enemies Hoplite_Orcgrunt,Hoplite_Orcarcher,Hoplite_Cutthroat,Hoplite_Orcbomber,Hoplite_Fireguardian,Hoplite_Cutthroat,Hoplite_Orcwarrior,Hoplite_Dark_Wizard,Hoplite_Mudgolem Ur}
	  [/then]
	[/elseif]
	[elseif]
	  [variable]
	     name=hoplite_depth
	     greater_than_equal_to=22
	  [/variable]
	  [then]
        {HOPLITE_SCATTER_ENEMY $heroambush_enemies Hoplite_Orcgrunt,Hoplite_Orcarcher,Hoplite_Cutthroat,Hoplite_Orcbomber,Hoplite_Fireguardian,Hoplite_Cutthroat,Hoplite_Orcwarrior,Hoplite_Dark_Wizard,Hoplite_Mudgolem,Hoplite_Demonwarrior Ur}
	  [/then]
	[/elseif]
	[else]
        {HOPLITE_SCATTER_ENEMY $heroambush_enemies Hoplite_Orcgrunt,Hoplite_Orcarcher,Hoplite_Cutthroat,Hoplite_Orcgrunt,Hoplite_Cutthroat,Hoplite_Orcbomber,Hoplite_Orcwarrior,Hoplite_Dark_Wizard Ur,Ur*}
	[/else])}
	{CLEAR_VARIABLE heroambush_enemies}

 	    {VARIABLE customfloor yes}
  [/then])}
#  [/then])}
  {CLEAR_VARIABLE random_event}
  [/else]
  )}
{IF_VAR customfloor not_equals yes (
  [then]
{IF_VAR hoplite_depth greater_than 15 (
[then]
{RANDOM 1..4}
[/then]
[else]
{RANDOM 1..3}
[/else])}
{IF_VAR random equals 2 (
[and]
  [variable]
     name=hoplite_depth
     greater_than_equal_to=0
  [/variable]
[/and]
[then]
   {HOPLITE_CRYPT_RANDTYPE}
   {HOPLITE_CRYPT_GENERATION}
   {VARIABLE dungeon_seen yes}
[/then]
[elseif]
  [variable]
     name=random
     equals=3
  [/variable]
  [and]
  [variable]
     name=hoplite_depth
     greater_than=2
  [/variable]
  [/and]
  [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Flooded_Cave.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        {HOPLITE_GENERATE_FORGE 2-10 3}
        {VARIABLE hoplite_aquatic $hoplite_depth}
        {VARIABLE_OP hoplite_aquatic add 1}
	{HOPLITE_GENERATION_AMOUNT hoplite_aquatic}
	{VARIABLE hoplite_enemyamount $hoplite_aquatic}
	{VARIABLE hoplite_enemyterrain W**,D*}
	{IF_VAR hoplite_depth greater_than 6 (
	[and]
	  [variable]
	     name=hoplite_depth
	     less_than=11
	  [/variable]
	[/and]
	[then]
   	{VARIABLE hoplite_enemytable Hoplite_Tentacle,Hoplite_Giantcrab,Hoplite_Nagahunter,Hoplite_Tentacle,Hoplite_Giantcrab,Hoplite_Nagahunter,Hoplite_Cuttlefish}
	[/then]
	[elseif]
	  [variable]
	     name=hoplite_depth
	     greater_than_equal_to=11
	  [/variable]
	[and]
	  [variable]
	     name=hoplite_depth
	     less_than=16
	  [/variable]
	[/and]	  
	  [then]
   	  {VARIABLE hoplite_enemytable Hoplite_Tentacle,Hoplite_Giantcrab,Hoplite_Nagahunter,Hoplite_Tentacle,Hoplite_Giantcrab,Hoplite_Nagahunter,Hoplite_Cuttlefish,Hoplite_Serpentmage}
	  [/then]
	[/elseif]
	[elseif]
	  [variable]
	     name=hoplite_depth
	     greater_than_equal_to=16
	  [/variable]
	[and]
	  [variable]
	     name=hoplite_depth
	     less_than=20
	  [/variable]
	[/and]	  
	  [then]
   	  {VARIABLE hoplite_enemytable Hoplite_Tentacle,Hoplite_Giantcrab,Hoplite_Nagahunter,Hoplite_Tentacle,Hoplite_Nagahunter,Hoplite_Cuttlefish,Hoplite_Serpentmage,Hoplite_Nagamage}
	  [/then]
	[/elseif]
	[elseif]
	  [variable]
	     name=hoplite_depth
	     greater_than_equal_to=20
	  [/variable]
	  [then]
   	  {VARIABLE hoplite_enemytable Hoplite_Tentacle,Hoplite_Giantcrab,Hoplite_Nagahunter,Hoplite_Tentacle,Hoplite_Hydra,Hoplite_Nagamage,Hoplite_Cuttlefish,Hoplite_Serpentmage}
	  [/then]
	[/elseif]
	[else]
   	{VARIABLE hoplite_enemytable Hoplite_Tentacle,Hoplite_Giantcrab,Hoplite_Nagahunter}
	[/else])}
	{CLEAR_VARIABLE hoplite_aquatic}
	{VARIABLE waterdepth_seen yes}
  [/then]
[/elseif]
[elseif]
  [variable]
     name=random
     equals=4
  [/variable]
  [and]
  [variable]
     name=hoplite_depth
     greater_than_equal_to=0
  [/variable]
  [/and]
  [then]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite_Jungle.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        {HOPLITE_GENERATE_FORGE 2-10 3-4}
        {VARIABLE hoplite_jungle $hoplite_depth}
        {VARIABLE_OP hoplite_jungle add 1}
	{HOPLITE_GENERATION_AMOUNT hoplite_jungle}
   	{VARIABLE hoplite_enemyamount $hoplite_jungle}
   	{VARIABLE hoplite_enemyterrain Gll,Gll^***}
	{IF_VAR hoplite_depth greater_than 18 (
	[and]
	{VARIABLE_CONDITIONAL hoplite_depth less_than 22}
	[/and]
	[then]
   	{VARIABLE hoplite_enemytable Hoplite_Salamander,Hoplite_Blowgunner,Hoplite_Salamander,Hoplite_Blowgunner,Hoplite_Salamander,Hoplite_Witchdoctor}
	[/then]
	[elseif]
	{VARIABLE_CONDITIONAL hoplite_depth greater_than 21}
  [and]
  {VARIABLE_CONDITIONAL hoplite_depth less_than 24}
  [/and]
	[then]
   	{VARIABLE hoplite_enemytable Hoplite_Salamander,Hoplite_Blowgunner,Hoplite_Salamander,Hoplite_Blowgunner,Hoplite_Salamander,Hoplite_Witchdoctor,Hoplite_Wyvern}
	[/then]
	[/elseif]
  [elseif]
  {VARIABLE_CONDITIONAL hoplite_depth greater_than 23}
  [then]
    {VARIABLE hoplite_enemytable Hoplite_Salamander,Hoplite_Blowgunner,Hoplite_Salamander,Hoplite_Blowgunner,Hoplite_Salamander,Hoplite_Witchdoctor,Hoplite_Wyvern,Hoplite_Cobra}
  [/then]
  [/elseif]
	[else]
   	{VARIABLE hoplite_enemytable Hoplite_Salamander,Hoplite_Blowgunner,Hoplite_Salamander,Hoplite_Blowgunner,Hoplite_Salamander}
	[/else])}
	{CLEAR_VARIABLE hoplite_jungle}
	{VARIABLE jungle_seen yes}
  [/then]
[/elseif]
[else]
        [replace_map]
            map_data="{~add-ons/Spartan/maps/Hoplite.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        {HOPLITE_GENERATE_TERRAIN}
        {HOPLITE_GENERATE_FORGE 2-10 4-5}
        {VARIABLE hoplite_enemy $hoplite_depth}
        {VARIABLE_OP hoplite_enemy add 1}
	{HOPLITE_GENERATION_AMOUNT hoplite_enemy}
   	{VARIABLE hoplite_enemyamount $hoplite_enemy}
   	{VARIABLE hoplite_enemyterrain Ur,Qlf}
        {HOPLITE_CHAOSUNITS (
	{IF_VAR hoplite_depth greater_than 7 (
	[and]
	  [variable]
	     name=hoplite_depth
	     less_than=12
	  [/variable]
	[/and]
	[then]
   	{VARIABLE hoplite_enemytable Hoplite_Orcgrunt,Hoplite_Orcarcher,Hoplite_Cutthroat,Hoplite_Orcbomber,Hoplite_Orcgrunt,Hoplite_Cutthroat,Hoplite_Orcwarrior,Hoplite_Dark_Wizard}
	[/then]
	[elseif]
	  [variable]
	     name=hoplite_depth
	     greater_than_equal_to=12
	  [/variable]
	[and]
	  [variable]
	     name=hoplite_depth
	     less_than=16
	  [/variable]
	[/and]
	  [then]
          {VARIABLE hoplite_enemytable Hoplite_Orcgrunt,Hoplite_Orcarcher,Hoplite_Cutthroat,Hoplite_Orcbomber,Hoplite_Fireguardian,Hoplite_Cutthroat,Hoplite_Orcwarrior,Hoplite_Dark_Wizard}
	  [/then]
	[/elseif]
	[elseif]
	  [variable]
	     name=hoplite_depth
	     greater_than_equal_to=16
	  [/variable]
  	  [and]
	  [variable]
	     name=hoplite_depth
	     less_than=22
	  [/variable]
	  [/and]
	  [then]
          {VARIABLE hoplite_enemytable Hoplite_Orcgrunt,Hoplite_Orcarcher,Hoplite_Cutthroat,Hoplite_Orcbomber,Hoplite_Fireguardian,Hoplite_Cutthroat,Hoplite_Orcwarrior,Hoplite_Dark_Wizard,Hoplite_Mudgolem}
	  [/then]
	[/elseif]
	[elseif]
	  [variable]
	     name=hoplite_depth
	     greater_than_equal_to=26
	  [/variable]
	  [then]
          {VARIABLE hoplite_enemytable Hoplite_Orcgrunt,Hoplite_Orcarcher,Hoplite_Cutthroat,Hoplite_Orcbomber,Hoplite_Fireguardian,Hoplite_Cutthroat,Hoplite_Lavatentacle,Hoplite_Orcwarrior,Hoplite_Dark_Wizard,Hoplite_Mudgolem,Hoplite_Demonwarrior}
	  [/then]
	[/elseif]
	[else]
        {VARIABLE hoplite_enemytable Hoplite_Orcgrunt,Hoplite_Orcarcher,Hoplite_Cutthroat,Hoplite_Orcbomber,Hoplite_Orcgrunt,Hoplite_Cutthroat,Hoplite_Orcwarrior}
	[/else])}
	)}
	{CLEAR_VARIABLE hoplite_enemy}
[/else])}
#[/then])}

#[/then])}
{IF_VAR hoplite_depth greater_than 26 (
[and]
 [variable]
    name=bossfight
    not_equals=yes
 [/variable]
[/and]
[then]
#	{RANDOM 1..6}
	{RANDOM 1..2}
	{IF_VAR random equals 3 (
	[then]
		{SCATTER_UNITS 1 "Hoplite_Dummy_Unit" 2 (
            terrain=Ur,Urb
	    y=2-6
	    [not]
	    [filter]
	    [/filter]
	    [or]
	      x,y=$forge_x,$forge_y
	    [/or]
	    [/not]
        ) (
            side=$hoplite_enemyside
        )}
            [store_unit]
              [filter]
                 type=Hoplite_Dummy_Unit
              [/filter]
               variable=darkcircle
	       kill=yes
            [/store_unit]
	    [item]
	       image="scenery/summoning-center.png~GS()~CS(150,0,180)~NO_TOD_SHIFT()"
	       x,y=$darkcircle.x,$darkcircle.y
	    [/item]
	    {VARIABLE darkcircle_x $darkcircle.x}
	    {VARIABLE darkcircle_y $darkcircle.y}
	    {CLEAR_VARIABLE darkcircle}
	[/then])}
[/then])}
#fleshed out negative depths:
{IF_VAR hoplite_depth less_than 0 (
[and]
 [variable]
   name=bossfight
   not_equals=yes
 [/variable]
[/and]
[then]
   [replace_schedule]
      {SPARTAN_UNDERWORLD}
   [/replace_schedule]
   {IF_VAR underworld_message not_equals yes (
   [then]
   [sound]
     name=wail.wav
   [/sound]
     {VARIABLE underworld_message yes}
     {VARIABLE underworld_seen yes}
   [/then])}
{VARIABLE poltergeists $hoplite_depth}
{VARIABLE_OP poltergeists multiply -1.5}
{VARIABLE_OP poltergeists round floor}
{VARIABLE_OP poltergeists add 2}
        [if]
	 [variable]
	   name=hoplite_depth
	   less_than=-4
	 [/variable]
	 [and]
	 [variable]
	   name=hoplite_depth
	   greater_than=-6
	 [/variable]
	 [/and]
	 [then]
         {HOPLITE_SCATTER_ENEMY $poltergeists Hoplite_Poltergeist,Hoplite_Poltergeist,Hoplite_Poltergeist,Hoplite_Spectremage,Hoplite_Faceless Ur*,Qx**}
	 [/then]
	 [elseif]
	 [variable]
	   name=hoplite_depth
	   less_than=-7
	 [/variable]
	 [then]
         {HOPLITE_SCATTER_ENEMY $poltergeists Hoplite_Poltergeist,Hoplite_Poltergeist,Hoplite_Abysstentacle,Hoplite_Spectremage,Hoplite_Faceless Ur*,Qx**}
	 [/then]
	 [/elseif]
	 [else]
         {HOPLITE_SCATTER_ENEMY $poltergeists Hoplite_Poltergeist,Hoplite_Poltergeist,Hoplite_Poltergeist,Hoplite_Spectremage Ur*,Qx**}
	[/else]
	[/if]
	{CLEAR_VARIABLE poltergeists}
	{IF_VAR hoplite_depth less_than -12 (
	[then]
	{RANDOM 1..6}
	{IF_VAR random equals 3 (
	[then]
		{SCATTER_UNITS 1 "Hoplite_Dummy_Unit" 2 (
            terrain=Ur,Urb
	    y=2-6
	    [not]
	    [filter]
	    [/filter]
	    [or]
	      x,y=$forge_x,$forge_y
	    [/or]
	    [/not]
        ) (
            side=$hoplite_enemyside
        )}
            [store_unit]
              [filter]
                 type=Hoplite_Dummy_Unit
              [/filter]
               variable=circle
	       kill=yes
            [/store_unit]
	    [item]
	       image="scenery/summoning-center.png~NO_TOD_SHIFT()"
	       x,y=$circle.x,$circle.y
	    [/item]
	    {VARIABLE circle_x $circle.x}
	    {VARIABLE circle_y $circle.y}
	    {CLEAR_VARIABLE circle}
	    [/then])}
	    [/then])}
	[/then])}
	[fire_event]
	    id=random_textitem
	[/fire_event]
        {HOPLITE_SCATTER_ENEMY $hoplite_enemyamount $hoplite_enemytable $hoplite_enemyterrain}
	{CLEAR_VARIABLE hoplite_enemyamount}
	{CLEAR_VARIABLE hoplite_enemytable}
	{CLEAR_VARIABLE hoplite_enemyterrain}
[/then])}
{CLEAR_VARIABLE random_event}
#enddef

[event]
   id=hoplite_depthdescent
   first_time_only=no
   {VARIABLE hoplite_nospear yes}
   {IF_VAR depthdescent_nofade not_equals yes (
   [then]
        {FADE_TO_BLACK}
   [/then])}
        [kill]
	    side=$hoplite_enemyside,$hoplite_allyside
	    [not]
        trait=loyal
#	      ability=hoplite_companion
#        [or]
#          ability=hoplite_loyalthrall_filter
#        [/or]
	    [/not]
	    animate=no
	    fire_event=no
	[/kill]
#ifdef MULTIPLAYER
	{TELEPORT_UNIT id=Hoplite 5 10}
	{TELEPORT_UNIT id=Hoplite2 7 10}
#else
	{TELEPORT_UNIT id=Hoplite 6 10}
#endif
        [replace_schedule]
	   {SPARTAN_UNDERGROUND}
	[/replace_schedule]
	[remove_time_area]
	   id=heat,void
	[/remove_time_area]
            [store_unit]
               [filter]
                 id=Hoplite
               [/filter]
               variable=hoplitehealed
	       kill=no
            [/store_unit]
	    {VARIABLE hopliteheal $hoplitehealed.max_hitpoints}
	    {VARIABLE_OP hopliteheal divide 2}
	    {VARIABLE hoplitehealed.moves 1}
	    {VARIABLE hoplitehealed.attacks_left 1}
	    [unstore_unit]
	       variable=hoplitehealed
	    [/unstore_unit]
	    [heal_unit]
	       [filter]
	         id=Hoplite
	       [/filter]
	       amount=$hopliteheal
	       animate=no
	    [/heal_unit]
	   {CLEAR_VARIABLE hopliteheal}
	   {CLEAR_VARIABLE hoplitehealed}
	   [if]
	    [have_unit]
	      id=Hoplite2
	    [/have_unit]
	    [then]
            [store_unit]
               [filter]
                 id=Hoplite2
               [/filter]
               variable=hoplitehealed2
	       kill=no
            [/store_unit]
	    {VARIABLE hopliteheal2 $hoplitehealed2.max_hitpoints}
	    {VARIABLE_OP hopliteheal2 divide 2}
	    {VARIABLE hoplitehealed2.moves 1}
	    {VARIABLE hoplitehealed2.attacks_left 1}
	    [unstore_unit]
	       variable=hoplitehealed2
	    [/unstore_unit]
	    [heal_unit]
	       [filter]
	         id=Hoplite2
	       [/filter]
	       amount=$hopliteheal2
	       animate=no
	    [/heal_unit]
	   {CLEAR_VARIABLE hopliteheal2}
	   {CLEAR_VARIABLE hoplitehealed2}
	   [/then]
	[/if]
	[if]
	    [have_unit]
	       ability=hoplite_companion
         [or]
          ability=hoplite_loyalthrall_filter
         [/or]
	    [/have_unit]
	    [then]
      	    {TELEPORT_UNIT ability=hoplite_companion 6 10}
      	    {TELEPORT_UNIT ability=hoplite_loyalthrall_filter 6 10}
            [store_unit]
               [filter]
                 ability=hoplite_companion
                 [or]
                  ability=hoplite_loyalthrall_filter
                 [/or]
               [/filter]
               variable=companionhealed
	       kill=no
            [/store_unit]
	    {FOREACH companionhealed a}
	    {VARIABLE companionheal $companionhealed[$a].max_hitpoints}
	    {VARIABLE_OP companionheal divide 2}
	    {VARIABLE_OP companionhealed[$a].hitpoints add $companionheal}
	    {IF_VAR companionhealed[$a].hitpoints greater_than $companionhealed[$a].max_hitpoints (
	    [then]
            {VARIABLE companionhealed[$a].hitpoints $companionhealed[$a].max_hitpoints}
            [/then])}
	    {VARIABLE companionhealed[$a].moves 1}
	    {VARIABLE companionhealed[$a].attacks_left 1}
	    [unstore_unit]
	       variable=companionhealed
	    [/unstore_unit]
	    {NEXT a}
	   {CLEAR_VARIABLE companionheal}
	   {CLEAR_VARIABLE companionhealed}
	   [/then]
	[/if]
#ifdef MULTIPLAYER
	{VARIABLE hoplite_energy1 $hoplite_maxenergy1}
	{VARIABLE hoplite_energy2 $hoplite_maxenergy2}
	{SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
	{SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
#endif	
#ifndef MULTIPLAYER
	{VARIABLE hoplite_energy $hoplite_maxenergy}
	{SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
#endif	
	{IF_VAR darkportal_active equals yes (
	[then]
	   {VARIABLE_OP hoplite_depth add -1}
           {VARIABLE_OP hoplite_infodepth2 add 1}#for the enemy catalog
	[/then]
	[else]
	{VARIABLE_OP hoplite_depth add 1}
        {VARIABLE_OP hoplite_infodepth add 1}#for the enemy catalog
	[/else]
	)}
        {CHECKPOINT_MESSAGE _"You may start the game from depth 11 in new playthroughs." depth11 hoplite_depth greater_than 10 }
        {CHECKPOINT_MESSAGE _"You may start the game from depth 21 in new playthroughs." depth21 hoplite_depth greater_than 20 }
        {CHECKPOINT_MESSAGE _"You may start the game from the underworld in new playthroughs." depth0 hoplite_depth less_than -6 }
        {CHECKPOINT_MESSAGE _"You may start the game from depth 31 in new playthroughs." depth31 hoplite_depth greater_than 30 }
        {CHECKPOINT_MESSAGE _"You may start the game from depth 41 in new playthroughs." depth41 hoplite_depth greater_than 39 }
        {CHECKPOINT_MESSAGE _"Sandbox mode unlocked: you may start the game at any depth with any amount of upgrades, and with the debug rightclick menu, but unable to earn achievements." depth99 hoplite_depth greater_than 99 }
	{HOPLITE_ACHIEVEMENT_DEPTHCHECK}
	{VARIABLE_OP hoplite_revive_cooldown sub 1}
#reset the map:
	{CLEAR_VARIABLE customfloor}
	{CLEAR_VARIABLE haveforge}
	{CLEAR_VARIABLE usedforge}
	{CLEAR_VARIABLE forge_x}
	{CLEAR_VARIABLE forge_y}	
        {CLEAR_VARIABLE circle_x}
        {CLEAR_VARIABLE circle_y}
        {CLEAR_VARIABLE darkcircle_x}
        {CLEAR_VARIABLE darkcircle_y}
        [remove_item]
   	   x=0-99
	   y=0-99
	[/remove_item]
	{CLEAR_VARIABLE darkwizard_hopliteloc_x}		    
	{CLEAR_VARIABLE darkwizard_hopliteloc_y}		    
#reset the trapdoor image:
        {IF_VAR hoplite_depth greater_than_equal_to 40 (
	[then]
	   {VARIABLE hoplite_stairway yes}
	[/then])}
        {IF_VAR hoplite_depth greater_than_equal_to 40 (
	[and]
	  [variable]
	    name=hoplite_depth
	    less_than=100
	  [/variable]
	[/and]
	[then]
	[item]
	   image="scenery/trapdoor-open.png"
	   x,y=7,2
	[/item]	
	[item]
	   image="terrain/stairs-spiral.png"
	   x,y=5,2
	[/item]	
	[/then]
	[else]
	[/else])}
        {IF_VAR hoplite_depth greater_than 99 (
        [then]
	[item]
	   image="terrain/stairs-spiral.png"
	   x,y=6,2
	[/item]	
	[/then]
	[elseif]
	[variable]
	   name=hoplite_depth
	   less_than=40
	[/variable]
	[then]
        [item]
	   image="scenery/trapdoor-open.png"
   	   x,y=6,2
	[/item]
	[/then]
	[/elseif])}
        [replace_schedule]
	   {SPARTAN_UNDERGROUND}
	[/replace_schedule]
	{CLEAR_VARIABLE bossfight}
	{CLEAR_VARIABLE customfloor}
        {RANDOM_MAP_TYPE}
{RANDOM 1..5}
{IF_VAR random equals 3 (
[and]
  {VARIABLE_CONDITIONAL customfloor not_equals yes}
[/and]
[and]
  {VARIABLE_CONDITIONAL hoplite_depth greater_than 5}
[/and]
[then]
        [replace_schedule]
	   {SPARTAN_UNDERGROUND_RED}
	[/replace_schedule]
[/then])}
	[if]
	    [have_unit]
	       id=Elizabeth
	    [/have_unit]
#	    [and]
#	    {VARIABLE_CONDITIONAL elizabethmet equals yes}
#	    [/and]
	    [and]
	    {VARIABLE_CONDITIONAL elizabethII_unlocked equals yes}
	    [/and]
	    [then]
  	    {UNIT $hoplite_allyside (Hoplite_Fireguardian) 5 9 (
	    placement=map
     	    passable=yes
            )}
  	    {UNIT $hoplite_allyside (Hoplite_Fireguardian) 7 9 (
	    placement=map
     	    passable=yes
            )}
	    [/then]
	[/if]

        {RATSPAWNCHECK ratsI}	
        {RATSPAWNCHECK ratsII}	
        {RATSPAWNCHECK ratsIII}	
	{IF_VAR rats greater_than 0 (
	[then]
	{SCATTER_UNITS $rats Hoplite_Giantrat_ally 1 (
            terrain=Ur*,R*,D*,Gll
            [not]
                [filter]
                [/filter]
            [/not]
        ) (
            side=$hoplite_allyside
        )}
	[/then])}
        {IF_VAR rats2 greater_than 0 (
	[then]
	{SCATTER_UNITS $rats2 Hoplite_Giantrat_ally2 1 (
            terrain=Ur*,R*,D*,Gll
            [not]
                [filter]
                [/filter]
            [/not]
        ) (
            side=$hoplite_allyside
        )}
	[/then])}
	{CLEAR_VARIABLE rats}
	{CLEAR_VARIABLE rats2}
	{IF_VAR ambush_unlocked equals yes (
	[or]
	[variable]
	  name=ambush_unlocked1
	  equals=yes
	[/variable]
	[/or]
	[or]
	[variable]
	  name=ambush_unlocked2
	  equals=yes
	[/variable]
	[/or]
	[then]
#allies are not immediately targeted upon entering a depth:	
       [modify_side]
	    side=$hoplite_allyside
	    team_name=hoplite,enemy
	    user_team_name=_"Allies"
       [/modify_side]	 
	[/then])}
#todo: remove the surprise event:	
	{IF_VAR surprise_unlocked equals yes (
	       [then]
		              [store_unit]
                                   [filter]
				       side=$hoplite_enemyside
                                   [/filter]
   
                                   kill=no
                                   variable=slowed
                               [/store_unit]

                               {FOREACH slowed a}
                               {VARIABLE slowed[$a].status.slowed yes}
                               [unstore_unit]
                                   variable=slowed[$a]
                               [/unstore_unit]
			       {NEXT a}
			       
	       [/then])}
	{SET_LABEL 2 1 "Depth: $hoplite_depth|"}
#maybe re-add later:
#	{IF_VAR hoplite_depth less_than 0 (
#	[then]
#	{SET_LABEL 2 1 "Depth: ???"}
#	[/then])}
        [object]
		silent=yes
		duration=forever
		[filter]
		  id=Hoplite
		[/filter]
		[effect]
		  apply_to=variation
		  name=none
	        [/effect]
	[/object]
	    {VARIABLE hoplite_spear_on_ground no}
	{CLEAR_VARIABLE spearloc_x}
	{CLEAR_VARIABLE spearloc_y}
	{CLEAR_VARIABLE spearloc1_x}
	{CLEAR_VARIABLE spearloc1_y}
	{CLEAR_VARIABLE spearloc2_x}
	{CLEAR_VARIABLE spearloc2_y}
#ifdef SPARTAN_MUSIC_FOUND
	{IF_VAR bossfight equals yes (
	[and]
	  [have_unit]
	     type=Hoplite_Spider_Queen
	  [/have_unit]
	[/and]
	[then]
      {SPARTAN_SMOOTH_REPLACE_MUSIC march-of-the-droids.ogg 1000 0}
	[/then]
	)}
	{IF_VAR bossfight equals yes (
	[and]
	{VARIABLE_CONDITIONAL archmagemet equals yes}
	[/and]
	[and]
	  [have_unit]
	     type=Hoplite_Archmage
	     [filter_wml]
	     [not]
	       variation=shaxtal
	     [/not]
	     [/filter_wml]
	  [/have_unit]
	[/and]
	[then]
      {SPARTAN_SMOOTH_REPLACE_MUSIC burning.ogg 1000 0}
	[/then])}
	{IF_VAR bossfight equals yes (
	[and]
	  [have_unit]
	     type=Hoplite_Ares
	  [/have_unit]
	[/and]
	[then]
      {SPARTAN_SMOOTH_REPLACE_MUSIC gathering_storm.ogg 1000 0}
	[/then])}
	{IF_VAR bossfight equals yes (
	[and]
	  [have_unit]
	     type=Hoplite_Minotaur
	  [/have_unit]
	[/and]
	[then]
      {SPARTAN_SMOOTH_REPLACE_MUSIC tunneled.ogg 1000 0}
	[/then])}
	{IF_VAR bossfight equals yes (
	[and]
	  [have_unit]
	     type=Hoplite_Grimreaper
	  [/have_unit]
	[/and]
	[then]
      {SPARTAN_SMOOTH_REPLACE_MUSIC moleman.ogg 1000 0}
	[/then])}
#endif	
#ifndef SPARTAN_MUSIC_FOUND
	{IF_VAR bossfight equals yes (
	[then]
      {SPARTAN_SMOOTH_REPLACE_MUSIC battle-epic.ogg 1000 0}
	[/then]
	)}
#endif
        [set_variable]
	    name=hoplite_revive_cooldown
	    sub=1
	[/set_variable]
        [set_variable]
	    name=hoplite_revive_cooldown1
	    sub=1
	[/set_variable]
        [set_variable]
	    name=hoplite_revive_cooldown2
	    sub=1
	[/set_variable]
        [set_variable]
	    name=hoplite_healpotion_cooldown
	    sub=1
	[/set_variable]
        [set_variable]
	    name=hoplite_healpotion_cooldown1
	    sub=1
	[/set_variable]
        [set_variable]
	    name=hoplite_healpotion_cooldown2
	    sub=1
	[/set_variable]
        [set_variable]
	    name=hoplite_adrenalinerush_cooldown
	    sub=1
	[/set_variable]
        [set_variable]
	    name=hoplite_adrenalinerush_cooldown1
	    sub=1
	[/set_variable]
        [set_variable]
	    name=hoplite_adrenalinerush_cooldown2
	    sub=1
	[/set_variable]
        [set_variable]
	    name=hoplite_shadowclone_cooldown
	    sub=1
	[/set_variable]
        [set_variable]
	    name=hoplite_shadowclone_cooldown1
	    sub=1
	[/set_variable]
        [set_variable]
	    name=hoplite_shadowclone_cooldown2
	    sub=1
	[/set_variable]
        [set_variable]
	    name=algadur_cooldown
	    sub=1
	[/set_variable]
        [set_variable]
	    name=elizabeth_cooldown
	    sub=1
	[/set_variable]
        {VARIABLE hoplite_harpoon_cooldown1_1 0}
        {VARIABLE hoplite_harpoon_cooldown1_2 0}
        {VARIABLE hoplite_harpoon_cooldown1 0}
        {VARIABLE hoplite_harpoon_cooldown2_1 0}
        {VARIABLE hoplite_harpoon_cooldown2_2 0}
        {VARIABLE hoplite_harpoon_cooldown2 0}
        {VARIABLE shadowclone_leap_cooldown 0}
	{VARIABLE hoplite_wizardbeam_cooldown 0}
	{VARIABLE hoplite_wizardbeam_cooldown1 0}
	{VARIABLE hoplite_wizardbeam_cooldown2 0}
	{VARIABLE hoplite_enthrall_cooldown 0}
	{VARIABLE hoplite_enthrall_cooldown1 0}
	{VARIABLE hoplite_enthrall_cooldown2 0}
#	{CLEAR_VARIABLE demilich_delay}
#	{CLEAR_VARIABLE serpentmage_delay}
	{CLEAR_VARIABLE hoplite_ratking}
	{CLEAR_VARIABLE hoplite_ratking1}
	{CLEAR_VARIABLE hoplite_ratking2}
#        {MODIFY_UNIT id=Hoplite attacks_left 1}
#        {MODIFY_UNIT id=Hoplite moves 1}
        [replace_schedule]
	[/replace_schedule]
	{FADE_IN}
	[fire_event]
	  id=hoplite_depthdescent_dialog
	[/fire_event]
[/event]