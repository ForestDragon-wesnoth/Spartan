#{~add-ons/Spartan/macros/ranged_macro.cfg}

#define TEXTITEM X Y IMAGE CAPTION MESSAGE
    [remove_item]
        image=hoplite_textitem
    [/remove_item]
    {CLEAR_VARIABLE textitem}
    {CLEAR_VARIABLE textitem_seen}
    [set_variables]
        name=textitem
        mode=append
        [value]
            x={X}
	    y={Y}
	    image={IMAGE}~SCALE(144,144)
	    caption={CAPTION}
	    message={MESSAGE}
        [/value]
    [/set_variables]
    [item]
        image={IMAGE}
        x,y={X},{Y}
        name=hoplite_textitem
    [/item]
#enddef

#define RANDOM_TEXTITEM IMAGE CAPTION MESSAGE
    [remove_item]
        image=hoplite_textitem
    [/remove_item]
    {CLEAR_VARIABLE textitem}
	{SCATTER_UNITS 1 "Hoplite_Dummy_Unit" 1 (
        terrain=!,Xu*,Xo*,W**,Rr,Qxua,Qlf,Q***,Gll^Ftr
	[not]
	  x,y=$forge_x,$forge_y
	  [or]
	  x,y=$darkcircle_x,$darkcircle_y
	  [/or]
	  [or]
	  x,y=6,2
	  radius=1
	  [/or]
	  [or]
	  x,y=6,10
	  radius=1
	  [/or]
	[/not]
    ) (
        side=$hoplite_enemyside
    )}
	[store_unit]
        [filter]
            type=Hoplite_Dummy_Unit
        [/filter]
        variable=textitemloc
    [/store_unit]
    [set_variables]
        name=textitem
        mode=append
        [value]
            x=$textitemloc.x
	    y=$textitemloc.y
	    image={IMAGE}~SCALE(144,144)
	    caption={CAPTION}
	    message={MESSAGE}
        [/value]
    [/set_variables]
    [item]
        image={IMAGE}
        x,y=$textitemloc.x,$textitemloc.y
        name=hoplite_textitem
    [/item]
	[kill]
	    id=$textitemloc.id
	    animate=no
	    fire_event=no
	[/kill]
#enddef

[event]
  id=random_textitem
  first_time_only=no
  [remove_item]
      image=hoplite_textitem
  [/remove_item]
  {CLEAR_VARIABLE textitem}
  {CLEAR_VARIABLE textitem_seen}
  {IF_VAR customfloor not_equals yes (
  [then]
  {IF_VAR hoplite_debugmenu equals yes (
  [then]
  {VARIABLE itemchance 2}
  [/then]
  [else]
  {VARIABLE_OP itemchance rand 1..3}
  [/else])}
  {IF_VAR hoplite_depth less_than 0 (
  [then]
	{VARIABLE_OP glyph_count add 1}
#	{IF_VAR reaper_beaten not_equals yes (
#	[and]
#	{VARIABLE_CONDITIONAL glyph_count equals 5}
#	[/and]
#	[then]
#	{VARIABLE glyph_count 99}#no glyph
#	[/then])}
	[switch]
	  variable=glyph_count
	  [case]
	    value=2
            {RANDOM_TEXTITEM "items/crystal-glyph-message.png~NO_TOD_SHIFT()" _"Message Glyph" _"If you are reading this, it could mean that I am not the only mortal stuck in this nightmare. I don't know who you are, what you are or where you are, but I'd like to ask that we cooperate in getting out of here. I scattered more such glyphs across the underworld, with information that may help you. They will be my way to keep in touch with you, even if a rather unreliable one.

<i>-El.</i>"}
	  [/case]
	  [case]
	    value=3
            {RANDOM_TEXTITEM "items/crystal-glyph-message.png~NO_TOD_SHIFT()" _"Message Glyph" _"You probably have already encountered the inhabitants of this world, haven't you? Tortured souls of the dead, knowing nothing more than to aimlessly wander this hell. Having spent an immesurable amount of time here, they are quite eager to take the souls of any mortals daring to step foot here, hoping that it might put an end to their suffering.

<i>-El.</i>"}
	  [/case]
	  [case]
	    value=4
            {RANDOM_TEXTITEM "items/crystal-glyph-message.png~NO_TOD_SHIFT()" _"Message Glyph" _"Having to deal with those accursed ghosts for what feels like forever already makes me feel like I am Sisiphus, to be honest. Not to mention having to worry about the angel of death sweeping in to harvest my soul... I swear, I'll go insane if I have to endure one more week of this madness! Anyway, you're getting very close, so keep going.

<i>-El.</i>"}
	  [/case]
	  [case]
	    value=5
            {UNIT $hoplite_allyside (Hoplite_Elizabeth) 6 5 (
            id=Elizabeth
            name=_"???"
     	    facing=s
	    placement=map
	    passable=yes
	    {IS_LOYAL}
            )}
            [object]
		silent=yes
		duration=forever
		id=conceal
		[filter]
		  id=Elizabeth
		[/filter]
		[effect]
		  apply_to=image_mod
		  add="~BLEND(0,0,0,0.95)"
	        [/effect]
            [/object]
#ifdef MULTIPLAYER	    
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=Elizabeth
		[/filter]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2#to two-shot normal enemies in MP
	        [/effect]
		[effect]
		  apply_to=attack
		  range=ranged
		  increase_damage=4#to one-shot normal enemies in MP
	        [/effect]
            [/object]
#endif
	  [/case]
	[/switch]
  [/then])}
  {IF_VAR itemchance equals 2 (
  [then]
  [if]
  [have_location]
     terrain=Ur
  [/have_location]
  [and]
  [have_location]
     terrain=Qlf
  [/have_location]
  [/and]
  [then]
	{VARIABLE_OP itemtype rand 1..4}
  [/then]
  [elseif]
  [have_location]
     terrain=Urb
  [/have_location]
  [and]
  [have_location]
     terrain=Xo*
  [/have_location]
  [/and]
  [then]
	{VARIABLE_OP itemtype rand 5..6}
  [/then]
  [/elseif]
  [elseif]
  [have_location]
     terrain=W*
  [/have_location]
  [then]
    {VARIABLE_OP itemtype rand 7..8}
  [/then]
  [/elseif]
  [elseif]
  [have_location]
     terrain=Gll
  [/have_location]
  [then]
    {VARIABLE_OP itemtype rand 9..10}
  [/then]
  [/elseif]
  [/if]
  {IF_VAR hoplite_depth greater_than 0 (
  [then]
	[switch]
	  variable=itemtype
	  [case]
	    value=1
            {RANDOM_TEXTITEM "scenery/rock3.png" _"Rock" _"(crudely written) Krog was here."}
	  [/case]
	  [case]
	    value=2
            {RANDOM_TEXTITEM "scenery/signpost.png" _"Sign" _"Do not dumb here! This be no dumb area! Me smart!"}
	  [/case]
	  [case]
	    value=3
            {RANDOM_TEXTITEM "scenery/signpost.png" _"Sign" _"<i>(some kind of gibberish likely written by an orc)</i>"}
	  [/case]
	  [case]
	    value=4
            {RANDOM_TEXTITEM "scenery/rock-cairn2.png" _"Makeshift Tombstone" _"Here lies one of my men whose name I do not know. May he rest in peace, and may we avenge the orcs who slain him."}
	  [/case]
      [case]
        value=5
        #tombs of male humans:
        {VARIABLE_OP tmp_tomb_image rand ("items/stone-tablet.png","scenery/monolith2.png","items/coffin-closed.png","scenery/monolith3.png")}
        {VARIABLE_OP tmp_tomb_name rand (Addraecyn,Addraenvan,Addraer,Addraercyn,Addraryn,Addreddry,Addredry,Addregwyn,Addrenyc,Addreoddry,Addreoddyn,Addreonyc,Addreorcyn,Addreran,Addribryn,Addriddyn,Addrocyn,Addroryn,Addrunvan,Addrurcyn,Addryllyn,Addrynvan,Aethacyn,Aethadry,Aethaec,Aethaeran,Aethaeryn,Aethagwyn,Aethanry,Aetharcyn,Aethec,Aethellyn,Aethenvan,Aetheoc,Aetheollyn,Aetheonyc,Aetheorcyn,Aethercyn,Aetherraent,Aethibryn,Aethiddry,Aethircyn,Aethobryn,Aethoddyn,Aethonnyn,Aethuc,Aethudry,Aethugwyn,Aethun,Aethunry,Aethydry,Aethynyc,Blac,Bladoc,Blaec,Blaedry,Blanry,Blebryn,Bledoc,Blemyr,Blennyn,Blenvan,Bleollyn,Blercyn,Blidd,Bliddry,Blillyn,Blinvan,Blollyn,Blubryn,Blucyn,Bludry,Blullyn,Bluran,Blybryn,Blydd,Blygwyn,Blymyr,Blyr,Bucyn,Cac,Cadry,Caebryn,Caedry,Caeran,Caercyn,Car,Carac,Caraddry,Caradoc,Caraedry,Caraennyn,Cararyn,Caredd,Careddry,Caregwyn,Caren,Careobryn,Careogwyn,Careonvan,Careorraent,Careoryn,Carercyn,Caric,Cariddry,Carocyn,Caroddyn,Caror,Caroran,Carraent,Carudoc,Carullyn,Carygwyn,Caryn,Cebryn,Cemyr,Cennyn,Ceoc,Ceoddry,Ceoddyn,Ceomyr,Ceonnyn,Ceonry,Ceoryn,Cicyn,Cin,Cinry,Coc,Convan,Corcyn,Cubryn,Cunry,Curyn,Cynyc,Cyryn,Dac,Dadd,Dadoc,Daeddry,Daedoc,Daellyn,Demyr,Denvan,Deodd,Deollyn,Deonyc,Derraent,Dibryn,Dinnyn,Dircyn,Dycyn,Dyddyn,Gaddry,Gaebryn,Gaedry,Gaercyn,Gagwyn,Gan,Gannyn,Gar,Gecyn,Geddyn,Gegwyn,Geodry,Ginvan,Glacyn,Gladoc,Glaercyn,Glarraent,Gleddry,Gleoddyn,Gleran,Gliddyn,Glillyn,Glinry,Glircyn,Gloddry,Gloddyn,Glonry,Glonvan,Glumyr,Glun,Glunry,Glunvan,Glyc,Glydd,Glydoc,Glynry,Glynvan,Glyran,Goc,Gor,Gubryn,Gudd,Gullyn,Gumyr,Gur,Gwadoc,Gwaec,Gwaeddyn,Gwan,Gweddyn,Gwegwyn,Gwellyn,Gwennyn,Gwenyc,Gweocyn,Gweodd,Gweodoc,Gweodry,Gweogwyn,Gweoran,Gwidoc,Gwilam,Gwodd,Gwoddyn,Gwollyn,Gwor,Gwucyn,Gwudoc,Gwumyr,Gwuran,Gwybryn,Gwycyn,Gwyddry,Gwydoc,Gwymyr,Gwynnyn,Gydoc,Gyllyn,Gymyr,Haldar,Labryn,Ladoc,Laellyn,Lan,Lannyn,Laran,Lec,Lemyr,Lenvan,Leogwyn,Lercyn,Ligwyn,Lin,Liryn,Lonnyn,Lorraent,Luddry,Ludoc,Lunnyn,Lunvan,Lurraent,Mac,Maddyn,Maennyn,Manry,Manyc,Marcyn,Mec,Menvan,Meollyn,Meon,Meonnyn,Meorraent,Middry,Midry,Mimyr,Modd,Moddry,Monry,Moran,Morcyn,Mubryn,Mudoc,Mugwyn,Murcyn,Mydoc,Mygwyn,Myn,Myrraent,Owac,Owadd,Owaddyn,Owaecyn,Owaedry,Owain,Owarcyn,Owaryn,Owecyn,Owedry,Oweomyr,Oweor,Oweorcyn,Oweran,Owercyn,Owidry,Owinvan,Owinyc,Owodd,Owoddry,Owogwyn,Owollyn,Oworan,Oworcyn,Oworraent,Owuddry,Owuddyn,Owugwyn,Owur,Owyran,Rabryn,Radd,Ranvan,Rar,Reoddyn,Reodry,Rhaecyn,Rhaedoc,Rhaemyr,Rhaerraent,Rhanry,Rharcyn,Rhenry,Rhenvan,Rhenyc,Rheodd,Rheoddyn,Rheollyn,Rheor,Rheoran,Rheorraent,Rheran,Rherraent,Rhobryn,Rhodry,Rhollyn,Rhonvan,Rhubryn,Rhugwyn,Rhunyc,Rhur,Rhygwyn,Rhyllyn,Rhynyc,Rhyrcyn,Rhyrraent,Rocyn,Roddyn,Romyr,Ron,Ronry,Rubryn,Ruddry,Rumyr,Run,Rurcyn,Rybryn,Rycyn,Ryddry,Rygwyn,Rynnyn,Rynry,Saec,Saellyn,Saemyr,Saenvan,Saercyn,Sanyc,Saran,Sarraent,Secyn,Seddyn,Sedry,Sellyn,Sennyn,Seoddry,Seorcyn,Sercyn,Siddry,Simyr,Siryn,Sodd,Sodry,Soran,Suc,Sudd,Surcyn,Sydd,Syran,Syryn,Tabryn,Taec,Taedd,Taedoc,Taemyr,Taenvan,Taercyn,Tanry,Tarcyn,Teddyn,Tegwyn,Ten,Tennyn,Tenvan,Teobryn,Teoddyn,Teor,Teorcyn,Terraent,Tinry,Tinvan,Tiryn,Todd,Tudd,Tuddry,Tudoc,Tunvan,Turraent,Tyddyn,Vaddyn,Vaeddyn,Vaedry,Vaennyn,Varcyn,Ven,Vennyn,Veocyn,Veoddyn,Veodry,Veogwyn,Veomyr,Vinvan,Vinyc,Virraent,Vobryn,Vogwyn,Vonry,Vuddyn,Vugwyn,Vyc,Vygwyn,Vyrcyn,Yracyn,Yraec,Yran,Yrannyn,Yranvan,Yraryn,Yredd,Yreddyn,Yregwyn,Yreryn,Yrinvan,Yrirraent,Yroddry,Yrullyn,Yrumyr,Yrunnyn,Yrunvan,Yryllyn,Yrymyr,Yrynyc,Yryrcyn)}
        {VARIABLE_OP tmp_tomb_title rand ("an ordinary peasant by the name of","Sir","Lord","Count","Sergeant","Lieutenant","General","Grand Marshal","Archmage","an infamous assassin","Duke","Prince","King")}
        {VARIABLE_OP tmp_tomb_cause_of_death rand ("lived a fulfilling life and died of old age","lived a fulfilling life and died of old age","killed by an assassin","killed in battle while defending his homeland","died to an enemy's arrow","killed in a duel","betrayed and killed by his subordinate","his cause of death is unknown")}

            {RANDOM_TEXTITEM $tmp_tomb_image| _"Tomb" _"Here lies $tmp_tomb_title| $tmp_tomb_name|, $tmp_tomb_cause_of_death|. May he rest in peace"}
        
      [/case]
      [case]
        value=6
        #tombs of female humans:
        {VARIABLE_OP tmp_tomb_image rand ("items/stone-tablet.png","scenery/monolith2.png","items/coffin-closed.png","scenery/monolith3.png")}
        {VARIABLE_OP tmp_tomb_name rand (Alabrylla,Alaebrylla,Alaeniver,Alalla,Alalonna,Alaryan,Aleacla,Aleaniver,Aleara,Alearka,Alena,Alengwen,Alilonna,Alingwen,Alolla,Alolonna,Alora,Alubrylla,Aluniver,Aluryan,Alussa,Alwcla,Alwllyra,Alwlyan,Alwna,Alybrylla,Alynoic,Alyra,Alyryan,Braedda,Brassa,Bravyan,Breabrylla,Breall,Brealla,Brealonna,Breana,Brell,Brellyra,Brera,Brerka,Breryan,Bricla,Brirka,Brobrylla,Brollyra,Brona,Bronoic,Brora,Brorka,Brungwen,Bruryan,Brwra,Brycla,Brynoic,Caella,Caena,Caengwen,Caevyan,Call,Calla,Cassa,Cealonna,Cera,Ceryan,Cibrylla,Cicla,Cinoic,Cira,Cissa,Clacla,Claella,Claelyan,Claenoic,Clalla,Clallyra,Clara,Clarka,Clavyan,Cleacla,Cleall,Clealyan,Cleana,Cleanoic,Clenoic,Clibrylla,Clill,Clillyra,Clilyan,Clinoic,Clissa,Clobrylla,Clollyra,Clona,Clongwen,Clungwen,Clurka,Cluvyan,Clwdda,Clwlla,Clwvyan,Clydda,Clylla,Cora,Coryan,Cucla,Cudda,Curyan,Cwdda,Cwlonna,Cwngwen,Cwvyan,Cydda,Cylla,Cyllyra,Cylyan,Cyniver,Cyvyan,Daedda,Daelyan,Daengwen,Daenoic,Dalla,Dallyra,Dangwen,Dara,Dassa,Deanoic,Deassa,Della,Devyan,Dicla,Diniver,Dissa,Dollyra,Dullyra,Dulonna,Dwbrylla,Dwdda,Dwna,Dwnoic,Dwra,Dybrylla,Dydda,Dyssa,Elacla,Elaedda,Elaell,Elaelonna,Elaessa,Elaevyan,Elallyra,Elalonna,Elara,Elavyan,Elealla,Eleanoic,Elearka,Elenoic,Elerka,Elivyan,Elulonna,Elurka,Elwllyra,Elwlonna,Elwngwen,Elwra,Elycla,Elyllyra,Elyngwen,Elyniver,Elyrka,Gwaera,Gwaessa,Gwangwen,Gweacla,Gwedda,Gwerka,Gwicla,Gwirka,Gwobrylla,Gwoll,Gwona,Gwongwen,Gwonoic,Gworyan,Gwullyra,Gwussa,Gwwcla,Gwwna,Gwwvyan,Gwycla,Gwydda,Heldra,Jacla,Jaena,Jaerka,Jaevyan,Jalyan,Jana,Jarka,Jassa,Jeabrylla,Jealla,Jeanoic,Jeniver,Jiryan,Jissa,Joll,Jolla,Jona,Jongwen,Jonoic,Jora,Jorka,Jovyan,Judda,Jull,Julonna,Jura,Jwll,Jwlyan,Jycla,Jyniver,Jynoic,Jyrka,Jyvyan,Laeniver,Laenoic,Laeryan,Langwen,Larka,Lassa,Lealonna,Lealyan,Ledda,Lelonna,Lelyan,Lengwen,Lerka,Lessa,Lidda,Lill,Lina,Lirka,Liryan,Livyan,Locla,Lodda,Lollyra,Lolonna,Lulla,Lulyan,Lungwen,Lunoic,Luryan,Lwcla,Lwlla,Lwnoic,Lwryan,Lycla,Lylla,Lylyan,Lyna,Lynoic,Maecla,Maeniver,Mavyan,Meacla,Mealyan,Meana,Meangwen,Meanoic,Medda,Melonna,Mengwen,Meniver,Meradda,Meraecla,Meraelyan,Merall,Merallyra,Meralonna,Merana,Meranoic,Merealonna,Mereangwen,Mereaniver,Merebrylla,Merella,Merengwen,Meressa,Merilyan,Merina,Merinoic,Merissa,Merivyan,Merolla,Merolyan,Merona,Meroniver,Merubrylla,Merudda,Merurka,Merwlla,Merwnoic,Merwryan,Merydda,Merylyan,Messa,Milonna,Molyan,Moniver,Mossa,Mudda,Mullyra,Mulyan,Muryan,Mwbrylla,Mwlyan,Mwngwen,Mwnoic,Mycla,Myll,Mylla,Myra,Myvyan,Nabrylla,Naebrylla,Naecla,Naell,Nalyan,Nangwen,Nealla,Neallyra,Nealonna,Neavyan,Nera,Nessa,Ninoic,Niryan,Nivyan,Nobrylla,Nolla,Nonoic,Norka,Noryan,Nucla,Nulla,Nulyan,Nungwen,Nuvyan,Nwllyra,Nwryan,Nwvyan,Nybrylla,Nyll,Nylyan,Nyryan,Nyssa,Nyvyan,Raebrylla,Raera,Raerka,Ralonna,Rara,Rarka,Rassa,Reacla,Realla,Reana,Reangwen,Rella,Relyan,Rengwen,Rerka,Revyan,Rilonna,Rilyan,Rirka,Rora,Rucla,Ruryan,Rwdda,Rwlla,Rwllyra,Rwlonna,Rwngwen,Rybrylla,Ryna,Ryngwen,Saell,Saellyra,Saeniver,Saerka,Saessa,Sallyra,Sanoic,Sara,Sassa,Searka,Sena,Senoic,Sera,Silonna,Sira,Siryan,Sona,Sorka,Subrylla,Sull,Sulonna,Sulyan,Sura,Sussa,Swlla,Swlyan,Swngwen,Swnoic,Swvyan,Syllyra,Sylyan,Syssa,Ysacla,Ysaenoic,Ysaerka,Ysanoic,Yseacla,Ysealonna,Ysealyan,Ysedda,Ysell,Yselonna,Ysilyan,Ysinoic,Ysodda,Ysongwen,Ysonoic,Ysura,Yswniver,Ysycla,Ysylla,Ysylyan,Ysyrka,Ysyssa)}
        {VARIABLE_OP tmp_tomb_title rand ("an ordinary peasant by the name of","Lady","Countess","Duchess","Archmage","an infamous assassin","Princess","Queen")}
        {VARIABLE_OP tmp_tomb_cause_of_death rand ("lived a fulfilling life and died of old age","lived a fulfilling life and died of old age","killed by an assassin","betrayed and killed by her subordinate","her cause of death is unknown")}

            {RANDOM_TEXTITEM $tmp_tomb_image| _"Tomb" _"Here lies $tmp_tomb_title| $tmp_tomb_name|, $tmp_tomb_cause_of_death|. May she rest in peace"}
        
      [/case]
      [case]
        value=7
        {RANDOM_TEXTITEM "scenery/shipwreck-1.png" _"Shipwreck" _"<i>An old shipwreck seems to have founds its way all the way into this flooded part of the caves. Seems it's already been thoroughly ransacked by the nagas.</i>"}
      [/case]
      [case]
        value=8
            {RANDOM_TEXTITEM "scenery/signpost.png" _"Sign" _"Caution: water resevoir infested by cuttlefish and crabs"}
      [/case]
	  [case]
	    value=9
            {RANDOM_TEXTITEM "scenery/rock4.png" _"Rock" _"Today's offering to the gods: one freshly cooked dwarf and six leg bones of the undead."}
	  [/case]
	  [case]
	    value=10
            {RANDOM_TEXTITEM "items/altar-bloody.png" _"Lizard Altar" _"<i>One can only imagine what kind of unspeakable deeds have been done here...</i>"}
	  [/case]
	[/switch]
  [/then])}
#  [/then])}
  [/then])}
  [/then])}
[/event]

[event]
    id=hoplite_death_event
    first_time_only=no
    [if]
        [have_unit]
            side=$hoplite_enemyside
#            [not]
#	        ability=hoplite_dying
#	    [/not]
        [/have_unit]
        [and]
        [/and]
        [then]
        [/then]
        [else]
            [set_variable]
                name=hoplite_nospear
                value=yes
            [/set_variable]
            [set_variable]
                name=hoplite_depthdescending#matters for the harpoon upgrade
                value=yes
            [/set_variable]
            [if]
                [have_unit]
                    type=Hoplite_Runesmith
                [/have_unit]
                [then]
                {ACHIEVEMENT_MESSAGE _"Smithing master: rescue a dwarf runesmith." runesmith}
                    [move_unit]
                        id=allyhero
                        to_x=6
                        to_y=5
                    [/move_unit]
                    [move_unit]
                        id=Hoplite,Hoplite2,Algadur
                        to_x=6
                        to_y=5
                    [/move_unit]
	{IF_VAR algadurlinesmith2 not_equals yes (
	[and]
	[have_unit]
	  id=Algadur
	[/have_unit]
	[/and]
	[then]
	{VARIABLE algadurlinesmith2 yes}
	[message]
	          speaker=runesmith
		  message=_"May I ask to whom I owe my life bein' saved?"
        [/message]
	[message]
	          speaker=Algadur
		  message=_"It's 'tis lad over 'ere, a 'hoplite' as they call 'em. He saved me sorry arse too. Good thing not all humans are demon-worshippin' lunatics."
        [/message]
	[message]
	          speaker=runesmith
		  message=_"That is good ta hear, my friend. (to the hoplite) As my gratitute, I will offer ye the finest smithin' Knalga has to offer, free of charge! I 'ave not managed ta save much from my forge, but it should be about enough ta make some fine enchanted gear. Nowhere near enough for a new set of full plate armor, though."
        [/message]
	[/then])}
	{IF_VAR linesmith not_equals yes (
	[and]
	[not]
	[have_unit]
	  id=Algadur
	[/have_unit]
	[/not]
	[/and]
	[then]
	{VARIABLE linesmith yes}
	[message]
	          speaker=runesmith
		  message=_"May I ask to whom I owe my life bein' saved?"
        [/message]
	[delay]
	   time=500
	[/delay]
	[message]
	          speaker=runesmith
		  message=_"A 'hoplite', eh? I wonder what that even means... Nevermind, as my gratitute, I will offer ye the finest smithin' Knalga has to offer, free of charge! I 'ave not managed ta save much from my forge, but it should be about enough ta make some fine enchanted gear. Nowhere near enough for a new set of full plate armor, though."
        [/message]
	[/then])}
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                            [message]
                                speaker=narrator
                                caption= _ "Runesmith"
                                image="portraits/dwarves/runemaster.png"
                                message= _ "As gratitude for saving him, the runesmith offers you a free upgrade. (side 1):"
#ifdef MULTIPLAYER
                                side_for=1
#endif
                                {FORGE_UPGRADE_LIST}
                            [/message]
                            [set_variable]
                                name=current_side_2
                                value=yes
                            [/set_variable]
                            [message]
                                speaker=narrator
                                caption= _ "Runesmith"
                                image="portraits/dwarves/runemaster.png"
                                message= _ "As gratitude for saving him, the runesmith offers you a free upgrade. (side 2):"
#ifdef MULTIPLAYER
                                side_for=2
#endif
                                {FORGE_UPGRADE_LIST}
                            [/message]
                            {CLEAR_VARIABLE current_side_2}
                        [/then]
                        [else]
                            [message]
                                speaker=narrator
                                caption= _ "Runesmith"
                                image="portraits/dwarves/runemaster.png"
                                message= _ "As gratitude for saving him, the runesmith offers you a free upgrade:"
                                {FORGE_UPGRADE_LIST}
                            [/message]
                        [/else]
                    [/if]
                    [move_unit]
                        type=Hoplite_Runesmith,Hoplite_Dwarffighter
                        side=$hoplite_allyside
                        to_x=6
                        to_y=10
                    [/move_unit]
                    [kill]
                        race=dwarf
                        side=$hoplite_allyside
                        [not]
                            ability=hoplite_companion
                        [/not]
                        animate=no
                        fire_event=no
                    [/kill]
                [/then]
            [/if]
            [if]
                [have_unit]
                    id=Algadur
                [/have_unit]
                [then]
		{IF_VAR algadurmet not_equals yes (
		[then]
		[message]
		  speaker=Algadur
		  message=_"I... ain't dead? (looks around) By Thursagan's beard, I'm alive! I'm a-bloodly-live! (looks at the hoplite) I don't know who ye are, but for savin' me I owe ye everythin' I got; my life, my axe and my loyalty. I know yer might is far beyond mine, but ya could always use more men, don't ye? Who even are ye, really? A 'hoplite', ye say? From Sparta? Never heard of either, but given that I spent my whole life in the caves, that's not saying much."
		[/message]
		[message]
		  speaker=Algadur
		  message=_"Almost forgot, name's Algadur. Ye might be wonderin' how I got my sorry arse here. Well, tis' all started when the Chaos Empire's bloody underlings attacked our outpost. Aye, I was among Althurin's men, in the squad sent to halt them bloody trolls. We got cornered, had to back into this darn orc camp, and were nearly all slaughtered had it not been for yer arrival. Words can't express how much I owe ya, hoplite of Sparta."
		[/message]
                [object]
		silent=yes
		duration=forever
		[filter]
		  id=Algadur
		[/filter]
		[effect]
		  apply_to=type
		  name=Hoplite_Steelclad2
	        [/effect]
                [/object]
		[/then])}
		{VARIABLE algadurmet yes}
                {ACHIEVEMENT_MESSAGE _"The Dwarf: recruit Algadur." algadur}
                [/then]
            [/if]
            [if]
                [variable]
                    name=haveforge
                    equals=yes
                [/variable]
                [and]
                    [variable]
                        name=usedforge
                        not_equals=yes
                    [/variable]
                [/and]
                [then]
                    [move_unit]
                        id=Hoplite,Hoplite2
                        to_x,to_y=$forge_x,$forge_y
                    [/move_unit]
                    [fire_event]
                        name=moveto
                        [primary_unit]
                            side=$hoplite_playerside
                            x,y=$forge_x,$forge_y
                        [/primary_unit]
                    [/fire_event]
                [/then]
            [/if]
            {IF_VAR darkcircle_x greater_than 0 (
                [then]
                    {MOVE_UNIT id=Hoplite,Hoplite2 $darkcircle_x $darkcircle_y}
                    [fire_event]
                        name=moveto
                        [primary_unit]
                            side=$hoplite_playerside
                            x,y=$darkcircle_x,$darkcircle_y
                        [/primary_unit]
                    [/fire_event]
                [/then]
            )}
            {IF_VAR textitem.x greater_than 0 (
	    [and]
                {VARIABLE_CONDITIONAL textitem_seen not_equals yes}
	    [/and]
                [then]
                    {MOVE_UNIT id=Hoplite,Hoplite2 $textitem.x $textitem.y}
                    [fire_event]
                        name=moveto
                        [primary_unit]
                            side=$hoplite_playerside
                            x,y=$textitem.x $textitem.y
                        [/primary_unit]
                    [/fire_event]
                [/then]
            )}
            {IF_VAR circle_x greater_than 0 (
                [then]
                    {MOVE_UNIT id=Hoplite,Hoplite2 $circle_x $circle_y}
                    [fire_event]
                        name=moveto
                        [primary_unit]
                            side=$hoplite_playerside
                            x,y=$circle_x,$circle_y
                        [/primary_unit]
                    [/fire_event]
                [/then]
            )}
            {IF_VAR hoplite_usedportal not_equals yes (
                [then]
                    [kill]
                        side=$hoplite_allyside
                        x,y=6,2
                        animate=no
                    [/kill]
                    [move_unit]
                        id=Hoplite
                        to_x=6
                        to_y=2
                    [/move_unit]
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                            [move_unit]
                                id=Hoplite2
                                to_x=5
                                to_y=3
                            [/move_unit]
                        [/then]
                    [/if]
		    
		    {IF_VAR hoplite_depth less_than 40 (
		    [and]
		    {VARIABLE_CONDITIONAL darkcircle_x not_equals 6}
		    [/and]
		    [and]
		    {VARIABLE_CONDITIONAL darkcircle_y not_equals 2}
		    [/and]
		    [then]
                [fire_event]
                    id=hoplite_depthdescent
                [/fire_event]
		    [/then])}
                [/then]
            )}
        [/else]
    [/if]
[/event]    

[event]
    name=side 1 turn
    first_time_only=no
  	{CHATMSG "patience/rest side 1"}
    [fire_event]
        id=hoplite_varcheck
    [/fire_event]

#ifdef MULTIPLAYER    
    {IF_VAR patience_unlocked1 equals yes (
        [and]
            {VARIABLE_CONDITIONAL side1_patience not_equals yes}
        [/and]
        [then]
            [allow_end_turn]
            [/allow_end_turn]
	    {VARIABLE side1_patience yes}
        [/then]
        [elseif]
           {VARIABLE_CONDITIONAL patience_unlocked2 equals yes}
	   [and]
            {VARIABLE_CONDITIONAL patience_unlocked1 not_equals yes}
	   [/and]
	   [then]
            [disallow_end_turn]
            [/disallow_end_turn]
	    {CLEAR_VARIABLE side1_patience}
	  [/then]
        [/elseif]
    )}
#endif
    {IF_VAR hoplite_still equals yes (
    [then]
        #add extra energy per upgrade:

        {IF_VAR patience_unlocked equals yes (
        [or]
          {VARIABLE_CONDITIONAL patience_unlocked1 equals yes}
        [/or]
        [then]
            {HOPLITE_ADD_ENERGY_BY_SIDE 1 5}
        [/then]
        )}

        {IF_VAR rest_unlocked equals yes (
        [or]
          {VARIABLE_CONDITIONAL rest_unlocked1 equals yes}
        [/or]
        [then]
            {HOPLITE_ADD_ENERGY_BY_SIDE 1 5}
        [/then]
        )}
        {IF_VAR restII_unlocked equals yes (
        [or]
          {VARIABLE_CONDITIONAL restII_unlocked1 equals yes}
        [/or]
        [then]
            {HOPLITE_ADD_ENERGY_BY_SIDE 1 5}
            [heal_unit]
                [filter]
                    id=Hoplite
                    [not]
                        [filter_wml]
                            [status]
                                unhealable=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                [/filter]
                amount=2
                animate=yes
                restore_statuses=no
            [/heal_unit]
            [modify_unit]
                [filter]
                    id=Hoplite
                    [not]
                        [filter_wml]
                            [status]
                                unhealable=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                [/filter]
                [status]
                    poisoned=no
                [/status]
            [/modify_unit]
        [/then]
        )}
    [/then]
    )}

    {CLEAR_VARIABLE hoplite_still}
    {CLEAR_VARIABLE hoplite_nospear}
    {CLEAR_VARIABLE hoplite_depthdescending}
    {VARIABLE_OP hoplite_wizardbeam_cooldown sub 1}
    {VARIABLE_OP hoplite_wizardbeam_cooldown1 sub 1}
    {VARIABLE_OP hoplite_wizardbeam_cooldown2 sub 1}
    {VARIABLE_OP hoplite_enthrall_cooldown sub 1}
    {VARIABLE_OP hoplite_enthrall_cooldown1 sub 1}
    {VARIABLE_OP hoplite_enthrall_cooldown2 sub 1}
    {VARIABLE_OP hoplite_harpoon_cooldown2 sub 1}
    {VARIABLE_OP hoplite_harpoon_cooldown2_1 sub 1}
    {VARIABLE_OP hoplite_harpoon_cooldown2_2 sub 1}
[/event]
#ifdef MULTIPLAYER
[event]
    name=side 2 turn
    first_time_only=no
    {CHATMSG "patience/rest side 2"}
    [fire_event]
        id=hoplite_varcheck
    [/fire_event]
    {IF_VAR patience_unlocked2 equals yes (
        [and]
            {VARIABLE_CONDITIONAL side2_patience not_equals yes}
        [/and]
        [then]
            [allow_end_turn]
            [/allow_end_turn]
	    {VARIABLE side2_patience yes}
        [/then]
        [elseif]
           {VARIABLE_CONDITIONAL patience_unlocked1 equals yes}
	   [and]
            {VARIABLE_CONDITIONAL patience_unlocked2 not_equals yes}
	   [/and]
	   [then]
            [disallow_end_turn]
            [/disallow_end_turn]
	    {CLEAR_VARIABLE side2_patience}
	  [/then]
        [/elseif]
    )}
    {IF_VAR hoplite_still2 equals yes (
    [then]
        #add extra energy per upgrade:

        {IF_VAR patience_unlocked2 equals yes (
        [then]
            {HOPLITE_ADD_ENERGY_BY_SIDE 2 5}
        [/then]
        )}

        {IF_VAR rest_unlocked2 equals yes (
        [then]
            {HOPLITE_ADD_ENERGY_BY_SIDE 2 5}
        [/then]
        )}
        {IF_VAR restII_unlocked2 equals yes (
        [then]
            {HOPLITE_ADD_ENERGY_BY_SIDE 2 5}
            [heal_unit]
                [filter]
                    id=Hoplite2
                    [not]
                        [filter_wml]
                            [status]
                                unhealable=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                [/filter]
                amount=2
                animate=yes
                restore_statuses=no
            [/heal_unit]
            [modify_unit]
                [filter]
                    id=Hoplite
                    [not]
                        [filter_wml]
                            [status]
                                unhealable=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                [/filter]
                [status]
                    poisoned=no
                [/status]
            [/modify_unit]
        [/then]
        )}
    [/then]
    )}

    {CLEAR_VARIABLE hoplite_still2}
[/event]
#endif
[event]
    name=side turn
    first_time_only=no
	{CHATMSG "if slowed end turn"}
    {MODIFY_UNIT side=$side_number resting false}
    [if]
        [have_unit]
            id=Hoplite,Hoplite2
            side=$side_number
            [filter_wml]
                [status]
                    slowed=yes
                [/status]
            [/filter_wml]
        [/have_unit]
        [and]
            [not]
                [have_unit]
                    side=$hoplite_enemyside
                    [filter_adjacent]
                        id=Hoplite,Hoplite2
                        side=$side_number
                    [/filter_adjacent]
                [/have_unit]
            [/not]
        [/and]
        [then]
            [end_turn]
            [/end_turn]
        [/then]
    [/if]
[/event]
#this is probably to make the ally side not waste turns until an ally has actually been placed
[event]
   name=unit placed
   first_time_only=yes
   [filter]
      side=$hoplite_allyside
   [/filter]
   {CHATMSG "hoplite allyside ai or null check"}
   [modify_side]
      side=$hoplite_allyside
      controller=ai
      hidden=no
   [/modify_side]
[/event]
[event]
   name=unit placed
   first_time_only=no
   [filter]
      side=$hoplite_allyside
      type=Hoplite_Giantrat_ally
   [/filter]
   {CHATMSG "hoplite rat buff"}
#this code seems a bit unneccessary, check it later
   {IF_VAR rat_powerII_unlocked equals yes (
   [or]
   [variable]
     name=rat_powerII_unlocked1
     equals=yes
   [/variable]
   [/or]
   [then]
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=$unit.id
		[/filter]
		[effect]
		  apply_to=type
		  name=Hoplite_Colossalrat_ally
	        [/effect]
		[effect]
		  apply_to=hitpoints
		  heal_full=yes
	        [/effect]
            [/object]
   [/then])}
   {IF_VAR rat_power_unlocked equals yes (
   [and]
   [variable]
     name=rat_powerII_unlocked
     not_equals=yes
   [/variable]
   [/and]
   [or]
   [variable]
     name=rat_power_unlocked1
     equals=yes
   [/variable]
   [and]
   [variable]
     name=rat_powerII_unlocked1
     not_equals=yes
   [/variable]
   [/and]
   [/or]
   [then]
        [object]
		silent=yes
		duration=forever
		[filter]
		  id=$unit.id
          [not]
             ability=hoplite_ratbuff1
          [/not]
		[/filter]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2
	        [/effect]
		[effect]
		  apply_to=hitpoints
		  increase=5
		  increase_total=5
	        [/effect]
            [effect]
                apply_to=new_ability
                [abilities]
                    [dummy]
                        id=hoplite_ratbuff1
                    [/dummy]
                [/abilities]
            [/effect]
        [/object]
   [/then])}
   {IF_VAR rat_powerIII_unlocked equals yes (
   [and]
    {VARIABLE_CONDITIONAL hoplite_ratking not_equals yes}
   [/and]
   [or]
   {VARIABLE_CONDITIONAL rat_powerIII_unlocked1 equals yes}
   [and]
    {VARIABLE_CONDITIONAL hoplite_ratking1 not_equals yes}
   [/and]
   [/or]
   [then]
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=$unit.id
		[/filter]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2
	        [/effect]
		[effect]
		  apply_to=hitpoints
		  increase=10
		  increase_total=10
	        [/effect]
	        [effect]
		apply_to=new_ability
		[abilities]
			{ABILITY_HOPLITE_KNOCKBACKIMMUNE}
		[/abilities]
        	[/effect]	
		[effect]
		  apply_to=movement
		  set=1
	        [/effect]
		[effect]
		  apply_to=image_mod
		  add="~SCALE(88,88)"
	        [/effect]
            [/object]
	    {VARIABLE hoplite_ratking yes}
	    {VARIABLE hoplite_ratking1 yes}
   [/then])}
[/event]
#ifdef MULTIPLAYER
[event]
   name=unit placed
   first_time_only=no
   [filter]
      side=$hoplite_allyside
      type=Hoplite_Giantrat_ally2
   [/filter]
   {CHATMSG "hoplite multiplayer rat buff"}
   {IF_VAR rat_powerII_unlocked2 equals yes (
   [then]
            [object]
		silent=yes
		duration=forever
		[filter]
		  id=$unit.id
		[/filter]
		[effect]
		  apply_to=type
		  name=Hoplite_Colossalrat_ally
	        [/effect]
		[effect]
		  apply_to=hitpoints
		  heal_full=yes
	        [/effect]
            [/object]
   [/then])}
   {IF_VAR rat_power_unlocked2 equals yes (
   [and]
   [variable]
     name=rat_powerII_unlocked2
     not_equals=yes
   [/variable]
   [/and]
   [then]
        [object]
        silent=yes
        duration=forever
        [filter]
          id=$unit.id
          [not]
             ability=hoplite_ratbuff1
          [/not]
        [/filter]
        [effect]
          apply_to=attack
          range=melee
          increase_damage=2
            [/effect]
        [effect]
          apply_to=hitpoints
          increase=5
          increase_total=5
            [/effect]
            [effect]
                apply_to=new_ability
                [abilities]
                    [dummy]
                        id=hoplite_ratbuff1
                    [/dummy]
                [/abilities]
            [/effect]
        [/object]
   [/then])}
   {IF_VAR rat_powerIII_unlocked2 equals yes (
   [and]
    {VARIABLE_CONDITIONAL hoplite_ratking2 not_equals yes}
   [/and]
   [then]
            [object]
		silent=yes
		duration=forever
        id=hoplite_ratbuff3#added id to prevent this being stacked
		[filter]
		  id=$unit.id
		[/filter]
		[effect]
		  apply_to=attack
		  range=melee
		  increase_damage=2
	        [/effect]
		[effect]
		  apply_to=hitpoints
		  increase=10
		  increase_total=10
	        [/effect]
	        [effect]
		apply_to=new_ability
		[abilities]
			{ABILITY_HOPLITE_KNOCKBACKIMMUNE}
		[/abilities]
        	[/effect]	
		[effect]
		  apply_to=movement
		  set=1
	        [/effect]
		[effect]
		  apply_to=image_mod
		  add="~SCALE(88,88)"
	        [/effect]
            [/object]
	    {VARIABLE hoplite_ratking2 yes}
   [/then])}
[/event]
[event]
   name=unit placed
   first_time_only=no
   [filter]
      side=$hoplite_enemyside
      level=0,1,2
      [not]
        ability=hoplite_buffed
      [/not]
   [/filter]
   {CHATMSG "hoplite multiplayer enemy buff"}
   {IF_VAR unit.level equals 0 (
   [then]
     {VARIABLE hpbuff_amount 3}
   [/then]
   [else]
     {VARIABLE hpbuff_amount 5}
   [/else])}
            [object]
		silent=yes
		duration=forever
		[filter]
		  x,y=$x1,$y1
		[/filter]
		[effect]
		  apply_to=hitpoints
		  increase=$hpbuff_amount
		  increase_total=$hpbuff_amount
	        [/effect]
        	[effect]
		apply_to=new_ability
		[abilities]
                    [dummy]
                       id=hoplite_buffed
                    [/dummy]
		[/abilities]
          	[/effect]	
            [/object]
	    {CLEAR_VARIABLE hpbuff_amount}
[/event]
#endif
[event]
    name=side 2 turn end
    first_time_only=no
#ifdef MULTIPLAYER    
    {CHATMSG "hoplite rest event 2"}
    {IF_VAR rest_unlocked2 equals yes (
        [then]
            [store_unit]
                [filter]
                    id=Hoplite2
                    side=$side_number
                [/filter]
                variable=hoplite_rest2
                kill=no
            [/store_unit]
            [if]
                [variable]
                    name=hoplite_rest2.moves
                    greater_than=0
                [/variable]
                [and]
                    [variable]
                        name=hoplite_rest2.attacks_left
                        greater_than=0
                    [/variable]
                [/and]
                [then]
                    {VARIABLE hoplite_still2 yes}
                [/then]
            [/if]
        [/then]
    )}
#endif    
    {CLEAR_VARIABLE hoplite_usedportal}
    {CLEAR_VARIABLE hoplite_rest2}
[/event]
#[event]
##ifdef MULTIPLAYER
#    name=side 3 turn
##else
#    name=side 2 turn
##endif
#
#	{CHATMSG "ally shortranged macros"}
#    first_time_only=no
#    {SHORTRANGED_MACRO_ALLY Hoplite_Orcgrunt orcgrunt sword blade}
#    {SHORTRANGED_MACRO_ALLY Hoplite_Orcwarrior orcwarrior greatsword blade}
#    {SHORTRANGED_MACRO_ALLY Hoplite_Giantcrab giantcrab claws blade}
#    {SHORTRANGED_MACRO_ALLY Hoplite_Hydra hydra bite blade}
#    {SHORTRANGED_MACRO_ALLY Hoplite_Spider_Minion spiderminion fangs blade}
#    {SHORTRANGED_MACRO_ALLY Hoplite_Faceless faceless sword blade}
#[/event]
[event]
    name=die
    first_time_only=no
    [filter]
        side=$hoplite_enemyside
    [/filter]
#erasing of ranged targethexes is now handled inside the ranged attack file
#    [switch]
#        variable=unit.type
#        [case]
#            value=Hoplite_Orcarcher
#            [remove_item]
#                image=misc/targethex-archer.png
#                x,y=$x1,$y1
#                radius=4
#            [/remove_item]
#            {CLEAR_VARIABLE orcarcher}
#            {CLEAR_VARIABLE orcarcher_hopliteloc_x}
#            {CLEAR_VARIABLE orcarcher_hopliteloc_y}
#        [/case]
#        [case]
#            value=Hoplite_Skelearcher
#            [remove_item]
#                image=misc/targethex-archer.png
#                x,y=$x1,$y1
#                radius=4
#            [/remove_item]
#            {CLEAR_VARIABLE skelearcher}
#            {CLEAR_VARIABLE skelearcher_hopliteloc_x}
#            {CLEAR_VARIABLE skelearcher_hopliteloc_y}
#        [/case]
#        [case]
#            value=Hoplite_Nagahunter
#            [remove_item]
#                image=misc/targethex-archer.png
#                x,y=$x1,$y1
#                radius=4
#            [/remove_item]
#            {CLEAR_VARIABLE nagahunter}
#            {CLEAR_VARIABLE nagahunter_hopliteloc_x}
#            {CLEAR_VARIABLE nagahunter_hopliteloc_y}
#        [/case]
#        [case]
#            value=Hoplite_Dark_Wizard
#            [remove_item]
#                image=misc/targethex.png
#                x,y=$x1,$y1
#                radius=4
#            [/remove_item]
#            {CLEAR_VARIABLE darkwizard}
#            {CLEAR_VARIABLE darkwizard_hopliteloc_x}
#            {CLEAR_VARIABLE darkwizard_hopliteloc_y}
#        [/case]
#        [case]
#            value=Hoplite_Spectremage
#            [remove_item]
#                image=misc/targethex.png
#                x,y=$x1,$y1
#                radius=4
#            [/remove_item]
#            {CLEAR_VARIABLE spectremage}
#            {CLEAR_VARIABLE spectremage_hopliteloc_x}
#            {CLEAR_VARIABLE spectremage_hopliteloc_y}
#        [/case]
#        [case]
#            value=Hoplite_Giantspider
#            [remove_item]
#                image=misc/targethex-archer.png
#                x,y=$x1,$y1
#                radius=3
#            [/remove_item]
#            {CLEAR_VARIABLE giantspider}
#            {CLEAR_VARIABLE giantspider_hopliteloc_x}
#            {CLEAR_VARIABLE giantspider_hopliteloc_y}
#        [/case]
#        [case]
#            value=Hoplite_Spider_Queen
#            [remove_item]
#                image=misc/targethex-archer.png
#                x,y=$x1,$y1
#                radius=3
#            [/remove_item]
#            {CLEAR_VARIABLE spiderqueen_web}
#            {CLEAR_VARIABLE spiderqueen_web_hopliteloc_x}
#            {CLEAR_VARIABLE spiderqueen_web_hopliteloc_y}
#        [/case]
#        [case]
#            value=Hoplite_Cuttlefish
#            [remove_item]
#                image=misc/targethex-cuttlefish.png
#                x,y=$x1,$y1
#                radius=3
#            [/remove_item]
#            {CLEAR_VARIABLE cuttlefish}
#            {CLEAR_VARIABLE cuttlefish_hopliteloc_x}
#            {CLEAR_VARIABLE cuttlefish_hopliteloc_y}
#        [/case]
#    [/switch]
    [fire_event]
       id=hoplite_death_event
    [/fire_event]
    {IF_VAR reaper_being_unstored not_equals yes (
        [and]
            [have_unit]
                id=$second_unit.id
                side=$hoplite_playerside
            [/have_unit]
        [/and]
        [then]
            {VARIABLE energybonus $unit.level}
            {VARIABLE_OP energybonus multiply 10}
            {IF_VAR unit.level less_than 1 (
                [then]
                    {VARIABLE_OP energybonus add 5}
                [/then]
            )}
            [if]
                [have_unit]
                    id=Hoplite2
                [/have_unit]
                [then]
                    {HOPLITE_PLAYERFILTER (
                        {IF_VAR bloodlust_unlocked1 equals yes (
                            [then]
                                {VARIABLE_OP energybonus add 5}
                            [/then]
                        )}
                        {IF_VAR bloodlustIII_active1 equals yes (
                            [then]
                                {VARIABLE_OP energybonus add 5}
                            [/then]
                        )}
                        {IF_VAR bloodlustII_unlocked1 equals yes (
                            [and]
                                [have_unit]
                                    id=$second_unit.id
                                    [not]
                                        [filter_wml]
                                            [status]
                                                unhealable=yes
                                            [/status]
                                        [/filter_wml]
                                    [/not]
                                [/have_unit]
                            [/and]
                            [then]
                                {VARIABLE hopliteheal $unit.level}
                                {VARIABLE_OP hopliteheal multiply 2}
                                {IF_VAR bloodlustIII_active1 equals yes (
                                    [then]
                                        {VARIABLE_OP hopliteheal multiply 2}
                                    [/then]
                                )}
                                [heal_unit]
                                    [filter]
                                        id=$second_unit.id
                                    [/filter]
                                    amount=$hopliteheal
                                    animate=yes
                                    restore_statuses=no
                                [/heal_unit]
                                [modify_unit]
                                    [filter]
                                        id=$second_unit.id
                                    [/filter]
                                    [status]
                                        poisoned=no
                                    [/status]
                                [/modify_unit]
                                {CLEAR_VARIABLE hopliteheal}
                            [/then]
                        )}
                    ) (
                        {IF_VAR bloodlust_unlocked2 equals yes (
                            [then]
                                {VARIABLE_OP energybonus add 5}
                            [/then]
                        )}
                        {IF_VAR bloodlustIII_active2 equals yes (
                            [then]
                                {VARIABLE_OP energybonus add 5}
                            [/then]
                        )}
                        {IF_VAR bloodlustII_unlocked2 equals yes (
                            [and]
                                [have_unit]
                                    id=$second_unit.id
                                    [not]
                                        [filter_wml]
                                            [status]
                                                unhealable=yes
                                            [/status]
                                        [/filter_wml]
                                    [/not]
                                [/have_unit]
                            [/and]
                            [then]
                                {VARIABLE hopliteheal $unit.level}
                                {VARIABLE_OP hopliteheal multiply 2}
                                {IF_VAR bloodlustIII_active2 equals yes (
                                    [then]
                                        {VARIABLE_OP hopliteheal multiply 2}
                                    [/then]
                                )}
                                [heal_unit]
                                    [filter]
                                        id=$second_unit.id
                                    [/filter]
                                    amount=$hopliteheal
                                    animate=yes
                                    restore_statuses=no
                                [/heal_unit]
                                [modify_unit]
                                    [filter]
                                        id=$second_unit.id
                                    [/filter]
                                    [status]
                                        poisoned=no
                                    [/status]
                                [/modify_unit]
                                {CLEAR_VARIABLE hopliteheal}
                            [/then]
                        )}
                    )}
                [/then]
                [else]
                    {IF_VAR bloodlust_unlocked equals yes (
                        [then]
                            {VARIABLE_OP energybonus add 5}
                        [/then]
                    )}
                    {IF_VAR bloodlustIII_active equals yes (
                        [then]
                            {VARIABLE_OP energybonus add 5}
                        [/then]
                    )}
                    {IF_VAR bloodlustII_unlocked equals yes (
                        [and]
                            [have_unit]
                                id=$second_unit.id
                                [not]
                                    [filter_wml]
                                        [status]
                                            unhealable=yes
                                        [/status]
                                    [/filter_wml]
                                [/not]
                            [/have_unit]
                        [/and]
                        [then]
                            {VARIABLE hopliteheal $unit.level}
                            {VARIABLE_OP hopliteheal multiply 2}
                            {IF_VAR bloodlustIII_active equals yes (
                                [then]
                                    {VARIABLE_OP hopliteheal multiply 2}
                                [/then]
                            )}
                            [heal_unit]
                                [filter]
                                    id=$second_unit.id
                                [/filter]
                                amount=$hopliteheal
                                animate=yes
                                restore_statuses=no
                            [/heal_unit]
                            [modify_unit]
                                [filter]
                                    id=$second_unit.id
                                [/filter]
                                [status]
                                    poisoned=no
                                [/status]
                            [/modify_unit]
                            {CLEAR_VARIABLE hopliteheal}
                        [/then]
                    )}
                [/else]
            [/if]
            [if]
                [have_unit]
                    id=$second_unit.id
                    [filter_wml]
                        [status]
                            unhealable=yes
                        [/status]
                    [/filter_wml]
                [/have_unit]
                [then]
                    {VARIABLE_OP energybonus divide 2}
                    {VARIABLE_OP energybonus round floor}
                [/then]
            [/if]
            [if]
                [have_unit]
                    id=$second_unit.id
             		    side=$hoplite_allyside
                [/have_unit]
                [then]
                    {VARIABLE_OP energybonus divide 2}
                    {VARIABLE_OP energybonus round floor}
                [/then]
            [/if]
            {HOPLITE_ADD_ENERGY_BY_VAR second_unit $energybonus}

            {CLEAR_VARIABLE energybonus}
        [/then]
    )}
    [switch]
        variable=second_unit.side
        [case]
            value=$hoplite_playerside
            {VARIABLE hoplite_killedenemy yes}
            {IF_VAR berserk_complete not_equals yes (
                [then]
                    {VARIABLE_OP berserk_progress add 1}
                    {IF_VAR berserk_progress equals 30 (
                        [then]
                            {ACHIEVEMENT_MESSAGE _"Berserk: Kill 30 enemies in one playthrough." berserk}
                        [/then]
                    )}
                [/then]
            )}
            {IF_VAR warmonger_complete not_equals yes (
                [and]
                    [variable]
                        name=berserker_complete
                        equals=yes
                    [/variable]
                [/and]
                [then]
                    {VARIABLE_OP warmonger_progress add 1}
                    {IF_VAR warmonger_progress equals 100 (
                        [then]
                            {ACHIEVEMENT_MESSAGE _"Warmonger: Kill 100 enemies in one playthrough." warmonger}
                        [/then]
                    )}
                [/then]
            )}
            {IF_VAR godofwar_complete not_equals yes (
                [and]
                    [variable]
                        name=godofwar_complete
                        equals=yes
                    [/variable]
                [/and]
                [then]
                    {VARIABLE_OP godofwar_progress add 1}
                    {IF_VAR godofwar_progress equals 300 (
                        [then]
                            {ACHIEVEMENT_MESSAGE _"God of War: Kill 300 enemies in one playthrough." godofwar}
                        [/then]
                    )}
                [/then]
            )}
        [/case]
        [case]
            value=$hoplite_allyside
            [if]
                [have_unit]
                    id=$second_unit.id
                    type=Hoplite_Giantrat_ally
                [/have_unit]
                [then]
                    {IF_VAR ratmaster_complete not_equals yes (
                        [then]
                            {VARIABLE_OP ratmaster_progress add 1}
                            {IF_VAR ratmaster_progress equals 10 (
                                [then]
                                    {ACHIEVEMENT_MESSAGE _"Who's a good rat? Yes, you are: have your rats kill 10 enemies in one playthrough." ratmaster}
                                [/then]
                            )}
                        [/then]
                    )}
                [/then]
            [/if]
        [/case]
    [/switch]
    [switch]
        variable=second_unit.id
        [case]
            value=Hoplite
            {IF_VAR hoplite_multiplayer equals yes (
                [then]
                    {VARIABLE hoplite_killedenemy_thisturn1 yes}
                [/then]
                [else]
                    {VARIABLE hoplite_killedenemy_thisturn yes}
                [/else]
            )}
        [/case]
        [case]
            value=Hoplite2
            {VARIABLE hoplite_killedenemy_thisturn2 yes}
        [/case]
    [/switch]
[/event]
[event]
    name=last breath
    first_time_only=no
    [filter]
        side=$hoplite_enemyside
#        level=3,4
    [/filter]
#    [object]
#        silent=yes
#        duration=turn
#        [filter]
#	     x,y=$x1,$y1
#        [/filter]
#	[effect]
#		apply_to=new_ability
#		[abilities]
#                    [dummy]
#                       id=hoplite_dying
#                    [/dummy]
#               [/abilities]
#	[/effect]
#    [/object]
    [switch]
        variable=unit.type
        [case]
            value=Hoplite_Spider_Queen
            {IF_VAR hoplite_depth greater_than 20 (
                [then]
                    [remove_item]
                        image="scenery/trapdoor-closed.png"
                        x,y=7,2
                    [/remove_item]
                    [item]
                        image="scenery/trapdoor-open.png"
                        x,y=7,2
                    [/item]
                [/then]
                [else]
                    [remove_item]
                        image="scenery/trapdoor-closed.png"
                        x,y=6,2
                    [/remove_item]
                    [item]
                        image="scenery/trapdoor-open.png"
                        x,y=6,2
                    [/item]
                [/else]
            )}
            {IF_VAR bossfight equals yes (
                [then]
                    {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 500 0}
                    {FLASH_WHITE (
                        [sound]
                            name=lightning.ogg
                        [/sound]
                        {VARIABLE reaper_being_unstored yes}
                        [kill]
                            type=Hoplite_Spider_Minion,Hoplite_Giantspider
                            animate=no
                            fire_event=yes
                        [/kill]
                        {CLEAR_VARIABLE reaper_being_unstored}
                    )}
                    [delay]
                        time=500
                    [/delay]
                    {SPARTAN_BOSSMUSICEND}
                    {ACHIEVEMENT_MESSAGE _"Arachnid Slayer: defeat the spider queen" spiderqueen}
                [/then]
            )}
            {VARIABLE spiderqueen_beaten yes}
            {CLEAR_VARIABLE bossfight}
        [/case]
        [case]
            value=Hoplite_Archmage
            [remove_item]
                image=misc/targethex.png
                x,y=0-99
            [/remove_item]
            {VARIABLE archmage_beaten yes}
            [remove_item]
                image="scenery/trapdoor-closed.png"
                x,y=6,2
            [/remove_item]
            [item]
                image="scenery/trapdoor-open.png"
                x,y=6,2
            [/item]
            {IF_VAR bossfight equals yes (
                [then]
#                    {REPLACE_SCENARIO_MUSIC silence.ogg}
                    [if]
		    [have_unit]
		          id=Archmage
			  x,y=$x1,$y1
			  [not]
			    [filter_wml]
			       variation=shaxtal
			    [/filter_wml]
			  [/not]
		    [/have_unit]
		    [then]
	    	    [message]
			   speaker=unit
			   message=_"You have won this fight, but that does not mean won the war. If the Chaos Empire seizes the Prometheus' Heart, then they will only be even closer to their goals. *sigh* All the effort I put in to preserve the little I could save from the Alduin academy, only to soon go to waste. If you truly intend to destroy the place, at least spare the spellbooks..."
		    [/message]
		    [/then]
		    [/if]
                    [if]
		    [have_unit]
		           id=Archmage
			   x,y=$x1,$y1
			   [filter_wml]
			   variation=shaxtal
			   [/filter_wml]
		    [/have_unit]
		    [then]
	    	    [message]
			   speaker=unit
			   message=_"Error: critical condition. Reporting mission failure. Initiating shutdown and memory wipe."
		    [/message]
            {VARIABLE archmage_beaten2 yes}
		    [/then]
		    [/if]
                    {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 500 0}
                    {FLASH_WHITE (
                        [sound]
                            name=lightning.ogg
                        [/sound]
                        {VARIABLE reaper_being_unstored yes}
                        [kill]
                            type=Hoplite_Fireguardian,Hoplite_Mudgolem
                            animate=no
                            fire_event=yes
                        [/kill]
                        {CLEAR_VARIABLE reaper_being_unstored}
                    )}
                    [delay]
                        time=500
                    [/delay]
                    {SPARTAN_BOSSMUSICEND}
                    [if]
		    [have_unit]
		          id=Archmage
			  x,y=$x1,$y1
			  [not]
			    [filter_wml]
			       variation=shaxtal
			    [/filter_wml]
			  [/not]
		    [/have_unit]
		    [then]
                    {ACHIEVEMENT_MESSAGE _"Wizard Bane: defeat the archmage" archmage}
		    [/then]
		    [/if]
                    [if]
		    [have_unit]
		           id=Archmage
			   x,y=$x1,$y1
			   [filter_wml]
			   variation=shaxtal
			   [/filter_wml]
		    [/have_unit]
		    [then]
                    {ACHIEVEMENT_MESSAGE _"Shaxtal Exterminator: defeat the archmage once again" archmage2}
		    [/then]
		    [/if]
		    {IF_VAR hoplite_depth equals 35 (
		    [then]
       	{IF_VAR elizabeth_stored.x greater_than 0 (
	[then]
        [unstore_unit]
            variable=elizabeth_stored
	    find_vacant=yes
	    x,y=6,10
        [/unstore_unit]
	[animate_unit]
		flag=post_teleport
		[filter]
		         id=Elizabeth
		[/filter]
	[/animate_unit]
	[/then]
	)}
	{IF_VAR algadur_stored.x greater_than 0 (
	[then]
        [unstore_unit]
            variable=algadur_stored
	    find_vacant=yes
	    x,y=6,10
        [/unstore_unit]
	[/then]
	)}
		    [message]
		        speaker=Elizabeth
		        message=_"Wow... just wow... to think we have just brought down this abomination..."
		    [/message]
		    [message]
		        speaker=Algadur
		        message=_"Aye, find it hard ta believe it too."
		    [/message]
		    [message]
		        speaker=Elizabeth
		        message=_"We may have barely escaped the Chaos Empire's grip, but at the same time made them view us as more than just mere rabble. We must find the gem as soon as we can, and flee as far as possible, else this won't be the worst we'll see of their wrath."
		    [/message]
		    [/then])}
                [/then]
            )}
            {CLEAR_VARIABLE bossfight}
            {CLEAR_VARIABLE archmage}
            {CLEAR_VARIABLE archmage_hopliteloc_x}
            {CLEAR_VARIABLE archmage_hopliteloc_y}
            {CLEAR_VARIABLE archmage_hopliteloc_lightning_x}
            {CLEAR_VARIABLE archmage_hopliteloc_lightning_y}
        [/case]
        [case]
            value=Hoplite_Ares
            {IF_VAR hoplite_artifacts not_equals yes (
                [then]
         	    {VARIABLE hoplite_artifacts yes}
                    [item]
                        image=items/armor-golden.png
                        x,y=6,4
                    [/item]
                    [item]
                        image=items/spear-ares.png
                        x,y=6,4
                    [/item]
                    {MOVE_UNIT id=Hoplite 6 4}
                    {MOVE_UNIT id=Hoplite2 6 4}
                    [remove_item]
                        x,y=6,4
                    [/remove_item]
                    {HOPLITE_ARTIFACTS}
                [/then]
            )}
            {VARIABLE ares_beaten yes}
            [remove_item]
                x,y=$ares_hopliteloc_explosion_x,$ares_hopliteloc_explosion_y
            [/remove_item]
            {IF_VAR hoplite_depth greater_than_equal_to 50 (
	    [then]
            [remove_item]
                image="scenery/trapdoor-closed.png"
                x,y=7,2
            [/remove_item]
            [item]
                image="scenery/trapdoor-open.png"
                x,y=7,2
            [/item]
	    [/then]
	    [else]
            [remove_item]
                image="scenery/trapdoor-closed.png"
                x,y=6,2
            [/remove_item]
            [item]
                image="scenery/trapdoor-open.png"
                x,y=6,2
            [/item]
	    [/else])}
            {IF_VAR bossfight equals yes (
                [then]
                    {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 500 0}
                    {FLASH_WHITE (
                        [sound]
                            name=lightning.ogg
                        [/sound]
                        {VARIABLE reaper_being_unstored yes}
                        [kill]
                            type=Hoplite_Hydra,Hoplite_Fireguardian
                            animate=no
                            fire_event=yes
                        [/kill]
                        {CLEAR_VARIABLE reaper_being_unstored}
                    )}
                    [delay]
                        time=500
                    [/delay]
                    {SPARTAN_BOSSMUSICEND}
                    {ACHIEVEMENT_MESSAGE _"Hero: defeat the avatar of war on depth 20" ares}
                [/then]
            )}
            {CLEAR_VARIABLE bossfight}
        [/case]
        [case]
            value=Hoplite_Donovan
            {IF_VAR bossfight equals yes (
                [then]
                    {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 1000 0}
			[message]
			   speaker=unit
			   message=_"I lost... lost to one damn heathen, even with all the men I had... An utter failure like myself deserves not a single bit of Uria's forgiveness or mercy..."
			[/message]

                    {FLASH_WHITE (
                        [sound]
                            name=lightning.ogg
                        [/sound]
                        {VARIABLE reaper_being_unstored yes}
                        [kill]
			    side=$hoplite_enemyside
			    level=0,1,2
                            animate=no
                            fire_event=yes
                        [/kill]
                        [kill]
                            type=Hoplite_Grimreaper
                            animate=no
                            fire_event=no
                        [/kill]
                        {CLEAR_VARIABLE reaper_being_unstored}
                    )}
                    [delay]
                        time=500
                    [/delay]
                    {SPARTAN_BOSSMUSICEND}
                    {ACHIEVEMENT_MESSAGE _"You shall not pass! : defeat the knight of chaos at depth 25" donovan}
			[message]
			   speaker=Algadur
			   message=_"Serves 'im right, that lunatic! Them bloody demon-worshippers deserve far worse than death for what they've done ta my kind!"
			[/message]
            {VARIABLE donovan_beaten yes}
            {CLEAR_VARIABLE bossfight}
	    [/then])}
        [/case]
        [case]
            value=Hoplite_Minotaur
	    {REMOVE_IMAGE $unit.x $unit.y}
	    [if]
	    [have_unit]
	       type=Hoplite_Warlock
	    [/have_unit]
	    [then]
	    [/then]
	    [else]
            {VARIABLE duo_beaten yes}
            {IF_VAR bossfight equals yes (
                [then]
                    {CLEAR_VARIABLE bossfight}
                    {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 500 0}
                    {FLASH_WHITE (
                        [sound]
                            name=lightning.ogg
                        [/sound]
                        {VARIABLE reaper_being_unstored yes}
                        [kill]
                            side=$hoplite_enemyside
			    level=1,2
                            animate=no
                            fire_event=yes
                        [/kill]
                        {CLEAR_VARIABLE reaper_being_unstored}
                    )}
                    [delay]
                        time=500
                    [/delay]
                    {SPARTAN_BOSSMUSICEND}
                    {ACHIEVEMENT_MESSAGE _"Always two, there are: defeat the minotaur/warlock duo on depth 30" duo}
                [/then]
            )}
	    [/else]
	    [/if]
        [/case]
        [case]
            value=Hoplite_Warlock
	    [if]
	    [have_unit]
	       type=Hoplite_Minotaur
	    [/have_unit]
	    [then]
	    [/then]
	    [else]
            {VARIABLE duo_beaten yes}
            {IF_VAR bossfight equals yes (
                [then]
                    {CLEAR_VARIABLE bossfight}
			[message]
			   speaker=unit
			   message=_"Hail... Uria..."
			[/message]
                    {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 500 0}
                    {FLASH_WHITE (
                        [sound]
                            name=lightning.ogg
                        [/sound]
                        {VARIABLE reaper_being_unstored yes}
                        [kill]
                            side=$hoplite_enemyside
			    level=1,2
                            animate=no
                            fire_event=yes
                        [/kill]
                        {CLEAR_VARIABLE reaper_being_unstored}
                    )}
                    [delay]
                        time=500
                    [/delay]
                    {SPARTAN_BOSSMUSICEND}
                    {ACHIEVEMENT_MESSAGE _"Always two, there are: defeat the minotaur&warlock on depth 30" duo}
                [/then]
            )}
	    [/else]
	    [/if]
        [/case]
        [case]
            value=Hoplite_Grimreaper
            {VARIABLE reaper_being_unstored yes}
            {CLEAR_VARIABLE reaper_being_unstored}
            {IF_VAR bossfight equals yes (
                [then]
                    {SPARTAN_SMOOTH_REPLACE_MUSIC silence.ogg 1000 0}
			[message]
			   speaker=unit
			   message=_"..."
			[/message]
			[delay]
			   time=500
			[/delay]
			[message]
			   speaker=unit
			   message=_"Very well, mortal, you have earned the right to return to the mortal realm, and retain your meaningless existence, for now. I have to leave now, as there are still thousands of souls left for me to harvest..."
			[/message]
                    {FLASH_WHITE (
                        [sound]
                            name=lightning.ogg
                        [/sound]
                        {VARIABLE reaper_being_unstored yes}
                        [kill]
			    side=$hoplite_enemyside
			    level=0,1,2
                            animate=no
                            fire_event=yes
                        [/kill]
                        [kill]
                            type=Hoplite_Grimreaper
                            animate=no
                            fire_event=no
                        [/kill]
                        {CLEAR_VARIABLE reaper_being_unstored}
                    )}
                    [delay]
                        time=500
                    [/delay]
                    {SPARTAN_BOSSMUSICEND}
                    {ACHIEVEMENT_MESSAGE _"Angel of Death: defeat the grim reaper in the depths of the underworld" reaper}
       	{IF_VAR elizabeth_stored.x greater_than 0 (
	[then]
        [unstore_unit]
            variable=elizabeth_stored
	    find_vacant=yes
	    x,y=6,10
        [/unstore_unit]
	[animate_unit]
		flag=post_teleport
		[filter]
		         id=Elizabeth
		[/filter]
	[/animate_unit]
    {CLEAR_VARIABLE elizabeth_stored}
	[/then]
	)}
	{IF_VAR algadur_stored.x greater_than 0 (
	[then]
        [unstore_unit]
            variable=algadur_stored
	    find_vacant=yes
	    x,y=6,10
        [/unstore_unit]
        {CLEAR_VARIABLE algadur_stored}
	[/then]
	)}
		    [message]
		        speaker=Elizabeth
		        message=_"(heavy breathing) We... did it? My goodness, we actually did it!"
		    [/message]
		    [message]
		        speaker=Algadur
		        message=_"Ta think I'd 'ave ta fight the Death it-bloody-self! 'tis was quite the day, admittedly."
		    [/message]
		    [message]
		        id=Hoplite,Hoplite2
		        message=_"No time for chit-chat, we must hurry to the portal at once!"
		    [/message]
            [/then]
            )}
            {VARIABLE reaper_beaten yes}
            {CLEAR_VARIABLE bossfight}
            {CLEAR_VARIABLE grimreaper_cooldown}
            {CLEAR_VARIABLE reaperhorde}
        [/case]
    [/switch]
[/event]
[event]
    name=last breath
    first_time_only=no
    [filter]
        side=$hoplite_allyside
        level=2,3
    [/filter]
    [switch]
        variable=unit.type
        [case]
            value=Hoplite_Elizabeth
	    [message]
		   speaker=unit
		   message=_"Uh... I'm pretty darn wounded. Got to go now, I'll catch up with you later!"
	    [/message]
	    {MOVE_UNIT type=Hoplite_Elizabeth 6 10}
                [store_unit]
                    [filter]
                        id=Elizabeth
                    [/filter]
                    variable=elizabeth_stored
                    kill=yes
                [/store_unit]
            {VARIABLE elizabeth_stored.hitpoints $elizabeth_stored.max_hitpoints}
            {VARIABLE elizabeth_cooldown 3}
	    {IF_VAR companion_recovery_unlocked equals yes (
	    [then]
            {VARIABLE elizabeth_cooldown 2}
	    [/then])}
	    {IF_VAR companion_recoveryII_unlocked equals yes (
	    [then]
            {VARIABLE elizabeth_cooldown 1}
	    [/then])}
	[/case]
        [case]
            value=Hoplite_Steelclad
	    [message]
		   speaker=unit
		   message=_"Argh... ye orcish swines won't get me today. I'll shall avenge my brothers later, but now I must run..."
	    [/message]
	    {MOVE_UNIT type=Hoplite_Steelclad 6 2}
	    [kill]
	          id=$unit.id
		  animate=no
		  fire_event=no
	    [/kill]
	[/case]
        [case]
            value=Hoplite_Steelclad2
	    [message]
		   speaker=unit
		   message=_"I 'ave to go heal my wounds, and catch up with ye later. I ain't gonna be of any use to ya dead."
	    [/message]
	    {MOVE_UNIT type=Hoplite_Steelclad2 6 10}
                [store_unit]
                    [filter]
                        id=Algadur
                    [/filter]
                    variable=algadur_stored
                    kill=yes
                [/store_unit]
            {VARIABLE algadur_stored.hitpoints $algadur_stored.max_hitpoints}
            {VARIABLE algadur_cooldown 3}
	    {IF_VAR companion_recovery_unlocked equals yes (
	    [then]
            {VARIABLE algadur_cooldown 2}
	    [/then])}
	    {IF_VAR companion_recoveryII_unlocked equals yes (
	    [then]
            {VARIABLE algadur_cooldown 1}
	    [/then])}
	[/case]
    [/switch]
[/event]
[event]
    id=forge_dialog
    first_time_only=no
    [if]
        [variable]
            name=usedforge
            not_equals=yes
        [/variable]
        [and]
            [variable]
                name=bossfight
                not_equals=yes
            [/variable]
        [/and]
        [then]
            {IF_VAR hoplite_upgradesleft greater_than 0 (
                [or]
                    [variable]
                        name=hoplite_upgradesleft1
                        greater_than=0
                    [/variable]
                [/or]
                [or]
                    [variable]
                        name=hoplite_upgradesleft2
                        greater_than=0
                    [/variable]
                [/or]
                [then]
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
			{VARIABLE hoplite_upgrademenu1 yes}
                        [while]
                         [variable]
                            name=hoplite_upgrademenu1
                            equals=yes
                         [/variable]
                         [do]
                            [message]
                                speaker=narrator
                                caption= _ "Forge"
                                message= _ "Choose an upgrade for side 1 ($hoplite_upgradesleft1| upgrades left):"
#ifdef MULTIPLAYER
                                side_for=1
#endif
                                {FORGE_UPGRADE_LIST}
                            [/message]
			 [/do]
			[/while]
                            [set_variable]
                                name=current_side_2
                                value=yes
                            [/set_variable]
			{VARIABLE hoplite_upgrademenu2 yes}
                        [while]
                         [variable]
                            name=hoplite_upgrademenu2
                            equals=yes
                         [/variable]
                         [do]
                            [message]
                                speaker=narrator
                                caption= _ "Forge"
                                message= _ "Choose an upgrade for side 2 ($hoplite_upgradesleft2| upgrades left):"
#ifdef MULTIPLAYER
                                side_for=2
#endif
                                {FORGE_UPGRADE_LIST}
                            [/message]
			 [/do]
			[/while]
                            {CLEAR_VARIABLE current_side_2}
                        [/then]
                        [else]
			{VARIABLE hoplite_upgrademenu yes}
                        [while]
                         [variable]
                            name=hoplite_upgrademenu
                            equals=yes
                         [/variable]
			 [do]
                            [message]
                                speaker=narrator
                                caption= _ "Forge"
                                message= _ "Choose an upgrade ($hoplite_upgradesleft| upgrades left):"
                                {FORGE_UPGRADE_LIST}
                            [/message]
			 [/do]
			[/while]
                        [/else]
                    [/if]
                [/then]
                [else]
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
			{VARIABLE hoplite_upgrademenu1 yes}
                        [while]
                         [variable]
                            name=hoplite_upgrademenu1
                            equals=yes
                         [/variable]
			 [do]
                            [message]
                                speaker=narrator
                                caption= _ "Forge"
                                message= _ "Choose an upgrade for side 1:"
                                #	side_for=1
                                {FORGE_UPGRADE_LIST}
                            [/message]
			  [/do]
			 [/while]
                            [set_variable]
                                name=current_side_2
                                value=yes
                            [/set_variable]
			{VARIABLE hoplite_upgrademenu2 yes}
                        [while]
                         [variable]
                            name=hoplite_upgrademenu2
                            equals=yes
                         [/variable]
			 [do]
                            [message]
                                speaker=narrator
                                caption= _ "Forge"
                                message= _ "Choose an upgrade for side 2:"
                                #	side_for=2
                                {FORGE_UPGRADE_LIST}
                            [/message]
			 [/do]
			[/while]
                            {CLEAR_VARIABLE current_side_2}
                        [/then]
                        [else]
			{VARIABLE hoplite_upgrademenu yes}
                        [while]
                         [variable]
                            name=hoplite_upgrademenu
                            equals=yes
                         [/variable]
			 [do]
                            [message]
                                speaker=narrator
                                caption= _ "Forge"
                                message= _ "Choose an upgrade:"
                                {FORGE_UPGRADE_LIST}
                            [/message]
			 [/do]
			[/while]
                        [/else]
                    [/if]
                [/else]
            )}
        [/then]
        [elseif]
            [variable]
                name=usedforge
                not_equals=yes
            [/variable]
            [and]
                [variable]
                    name=bossfight
                    equals=yes
                [/variable]
            [/and]
            [then]
                [message]
                    speaker=narrator
                    message= _ "Forges can't be used during a boss fight!"
                [/message]
            [/then]
        [/elseif]
    [/if]
[/event]
[event]
    id=hoplite_varcheck
    first_time_only=no
    {CHATMSG "hoplite varcheck"}
#ifdef MULTIPLAYER
    [if]
        [variable]
            name=hoplite_spear_on_ground2
            equals=yes
        [/variable]
	[and]
	 [have_unit]
	    id=Hoplite2
	    [filter_wml]
	     [not]
	       variation=spearless
	     [/not]
	    [/filter_wml]
	 [/have_unit]
	[/and]
        [then]
            [object]
                silent=yes
                duration=forever
                [filter]
                    id=Hoplite2
                [/filter]
                [effect]
                    apply_to=variation
                    name=spearless
                [/effect]
            [/object]
        [/then]
        [elseif]
            [variable]
                name=hoplite_spear_on_ground2
                not_equals=yes
            [/variable]
	[and]
	 [have_unit]
	    id=Hoplite2
	    [filter_wml]
	     [not]
	       variation=none
	     [/not]
	    [/filter_wml]
	 [/have_unit]
	[/and]
	   [then]
            [object]
                silent=yes
                duration=forever
                [filter]
                    id=Hoplite2
                [/filter]
                [effect]
                    apply_to=variation
                    name=none
                [/effect]
            [/object]
	   [/then]
        [/elseif]
    [/if]
#endif
    [if]
        [variable]
            name=hoplite_spear_on_ground
            equals=yes
        [/variable]
	[or]
            [variable]
                name=hoplite_spear_on_ground1
                equals=yes
            [/variable]
	[/or]
	[and]
	 [have_unit]
	    id=Hoplite
	    [filter_wml]
	     [not]
	       variation=spearless
	     [/not]
	    [/filter_wml]
	 [/have_unit]
	[/and]
        [then]
            [object]
                silent=yes
                duration=forever
                [filter]
                    id=Hoplite
                [/filter]
                [effect]
                    apply_to=variation
                    name=spearless
                [/effect]
            [/object]
        [/then]
        [elseif]
            [variable]
                name=hoplite_spear_on_ground
                equals=yes
            [/variable]
	[or]
            [variable]
                name=hoplite_spear_on_ground1
                equals=yes
            [/variable]
	[/or]
	[and]
	 [have_unit]
	    id=Hoplite
	    [filter_wml]
	     [not]
	       variation=spearless
	     [/not]
	    [/filter_wml]
	 [/have_unit]
   	[/and]
            [then]
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=Hoplite
                    [/filter]
                    [effect]
                        apply_to=variation
                        name=spearless
                    [/effect]
                [/object]
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=hoplite_spear_on_ground
                not_equals=yes
            [/variable]
	[and]
            [variable]
                name=hoplite_spear_on_ground1
                not_equals=yes
            [/variable]
	 [have_unit]
	    id=Hoplite
	    [filter_wml]
	     [not]
	       variation=none
	     [/not]
	    [/filter_wml]
	 [/have_unit]
	[/and]
	    [then]
            [object]
                silent=yes
                duration=forever
                [filter]
                    id=Hoplite
                [/filter]
                [effect]
                    apply_to=variation
                    name=none
                [/effect]
            [/object]
	    [/then]
        [/elseif]
    [/if]
[/event]
[event]
    id=hoplite_adrenaline
    first_time_only=no
    {IF_VAR adrenaline_unlocked equals yes (
    [or]
    {VARIABLE_CONDITIONAL adrenaline_unlocked1 equals yes}
    [/or]
        [then]
	{CHATMSG "adrenaline event"}
            [store_unit]
                [filter]
		    id=Hoplite
                [/filter]
                variable=hoplite_andrenalinerush
                kill=no
            [/store_unit]
                {VARIABLE andrenalinerushfilter $hoplite_andrenalinerush.max_hitpoints}
                {VARIABLE_OP andrenalinerushfilter divide 2}
                {VARIABLE_OP andrenalinerushfilter round ceiling}
                {IF_VAR hoplite_andrenalinerush.hitpoints greater_than 0 (
                    [and]
                        [variable]
                            name=hoplite_andrenalinerush.hitpoints
                            less_than_equal_to=$andrenalinerushfilter
                        [/variable]
                    [/and]
                    [and]
                        {VARIABLE_CONDITIONAL hoplite_adrenalinerush_cooldown less_than 1}
                        [and]
                            {VARIABLE_CONDITIONAL hoplite_multiplayer not_equals yes}
                        [/and]
                        [or]
                            {VARIABLE_CONDITIONAL hoplite_adrenalinerush_cooldown1 less_than 1}
                            [and]
                                {VARIABLE_CONDITIONAL hoplite_multiplayer equals yes}
                            [/and]
			[/or]
                    [/and]
                    [then]
                        [if]
			    [have_unit]
			        id=Hoplite2
		            [/have_unit]
                            [then]
                                {VARIABLE adrenalinerush_energybonus $hoplite_maxenergy1}
                                {VARIABLE_OP adrenalinerush_energybonus divide 2}
                                {VARIABLE_OP adrenalinerush_energybonus round floor}
                                {HOPLITE_ADD_ENERGY_BY_SIDE 1 $adrenalinerush_energybonus}
                        				{VARIABLE hoplite_adrenalinerush_cooldown1 1}
                            [/then]
                            [else]
                                        {VARIABLE adrenalinerush_energybonus $hoplite_maxenergy}
                                        {VARIABLE_OP adrenalinerush_energybonus divide 2}
                                        {VARIABLE_OP adrenalinerush_energybonus round floor}
                                        {HOPLITE_ADD_ENERGY_BY_SIDE 1 $adrenalinerush_energybonus}
                              					{VARIABLE hoplite_adrenalinerush_cooldown 1}
                            [/else]
			    [/if]
                        [unstore_unit]
                            variable=hoplite_andrenalinerush
                            text= _ "Adrenaline rush!"
                            blue=255
                        [/unstore_unit]
			[sound]
			    name=magic-faeriefire.ogg
			[/sound]
			[delay]
			    time=500
			[/delay]
			{IF_VAR bloodlustIII_unlocked equals yes (
			[then]
                        {HOPLITE_RAGE_EVENT Hoplite}
                        {VARIABLE bloodlustIII_active yes}
                        {VARIABLE bloodlustIII_progress 0}
			[/then])}
			{IF_VAR bloodlustIII_unlocked1 equals yes (
			[then]
                        {HOPLITE_RAGE_EVENT Hoplite}
                        {VARIABLE bloodlustIII_active1 yes}
                        {VARIABLE bloodlustIII_progress1 0}
			[/then])}
                    [/then]
                )}
            {CLEAR_VARIABLE hoplite_adrenalinerush}
            {CLEAR_VARIABLE adrenalinerush_energybonus}
       [/then])}
    [if]
        [have_unit]
	    id=Hoplite2
        [/have_unit]
        [then]
    {IF_VAR adrenaline_unlocked2 equals yes (
        [then]
	{CHATMSG "adrenaline event 2"}
            [store_unit]
                [filter]
		    id=Hoplite2
                [/filter]
                variable=hoplite_andrenalinerush
                kill=no
            [/store_unit]
                {VARIABLE andrenalinerushfilter $hoplite_andrenalinerush.max_hitpoints}
                {VARIABLE_OP andrenalinerushfilter divide 2}
                {VARIABLE_OP andrenalinerushfilter round ceiling}
                {IF_VAR hoplite_andrenalinerush.hitpoints greater_than 0 (
                    [and]
                        [variable]
                            name=hoplite_andrenalinerush.hitpoints
                            less_than_equal_to=$andrenalinerushfilter
                        [/variable]
                    [/and]
                    [and]
                        {VARIABLE_CONDITIONAL hoplite_adrenalinerush_cooldown2 less_than 1}
                    [/and]
                    [then]
                                {VARIABLE adrenalinerush_energybonus $hoplite_maxenergy2}
                                {VARIABLE_OP adrenalinerush_energybonus divide 2}
                                {VARIABLE_OP adrenalinerush_energybonus round floor}
                                {HOPLITE_ADD_ENERGY_BY_SIDE 2 $adrenalinerush_energybonus}
                        				{VARIABLE hoplite_adrenalinerush_cooldown2 1}
                        [unstore_unit]
                            variable=hoplite_andrenalinerush
                            text= _ "Adrenaline rush!"
                            blue=255
                        [/unstore_unit]
			[sound]
			    name=magic-faeriefire.ogg
			[/sound]
			[delay]
			    time=500
			[/delay]
			{IF_VAR bloodlustIII_unlocked2 equals yes (
			[then]
                        {HOPLITE_RAGE_EVENT Hoplite2}
                        {VARIABLE bloodlustIII_active2 yes}
                        {VARIABLE bloodlustIII_progress2 0}
			[/then])}
                    [/then]
                )}
            {CLEAR_VARIABLE hoplite_adrenalinerush}
            {CLEAR_VARIABLE adrenalinerush_energybonus}
       [/then])}
	[/then]
    [/if]
[/event]
