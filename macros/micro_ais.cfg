#textdomain wesnoth-Hoplite

#define SPARTAN_MICRO_AIS
        {SPARTAN_RANGED_MICROAI 3}
        {SPARTAN_RANGED_MICROAI 4}
        {SPARTAN_RANGED_MICROAI 5}
        {SPARTAN_RANGED_MICROAI 6}
        {SPARTAN_RANGED_MICROAI 7}
        {SPARTAN_RANGED_MICROAI 8}

        [micro_ai]
            # ranged_enemy_retreat. if attacks_left > 0, can attack with melee if cornered
            side=$hoplite_enemyside
            ai_type=coward
            action=add
            [filter]
                ability=hoplite_ranged
                formula="attacks_left > 0"
                [not]
                    type=Hoplite_Archmage
                [/not]
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_enemyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=2#radius for standing in place
                    [filter_radius]
                        terrain=!,{SPARTAN_WALL_TERRAIN}
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=2
            attack_if_trapped=yes#just in case the unit has melee weapons
            ca_score=170000#set below 200k so that this is triggered after goto_x/goto_y (otherwise it would interfere with the "order unit to move" feature)
        [/micro_ai]
        [micro_ai]
            # copy of ranged_enemy_retreat when the unit runs out of attacks_left, set attack_if_trapped to "no" to avoid a lua error when trying to attack if cornered
            side=$hoplite_enemyside
            ai_type=coward
            action=add
            [filter]
                ability=hoplite_ranged
                formula="attacks_left = 0"
                [not]
                    type=Hoplite_Archmage
                [/not]
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_enemyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=2#radius for standing in place
                    [filter_radius]
                        terrain=!,{SPARTAN_WALL_TERRAIN}
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=2
            attack_if_trapped=no
            ca_score=170000#set below 200k so that this is triggered after goto_x/goto_y (otherwise it would interfere with the "order unit to move" feature)
        [/micro_ai]
        [micro_ai]
            # ranged_ally_retreat. if attacks_left > 0, can attack with melee if cornered
            side=$hoplite_allyside
            ai_type=coward
            action=add
            [filter]
                ability=hoplite_ranged
                formula="attacks_left > 0"
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_allyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=2#radius for standing in place
                    [filter_radius]
                        terrain=!,{SPARTAN_WALL_TERRAIN}
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=2
            attack_if_trapped=yes#just in case the unit has melee weapons
            ca_score=170000#set below 200k so that this is triggered after goto_x/goto_y (otherwise it would interfere with the "order unit to move" feature)
        [/micro_ai]
        [micro_ai]
            # copy of ranged_ally_retreat when the unit runs out of attacks_left, set attack_if_trapped to "no" to avoid a lua error when trying to attack if cornered
            side=$hoplite_allyside
            ai_type=coward
            action=add
            [filter]
                ability=hoplite_ranged
                formula="attacks_left = 0"
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_allyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=2#radius for standing in place
                    [filter_radius]
                        terrain=!,{SPARTAN_WALL_TERRAIN}
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=2
            attack_if_trapped=no
            ca_score=170000#set below 200k so that this is triggered after goto_x/goto_y (otherwise it would interfere with the "order unit to move" feature)
        [/micro_ai]
        [micro_ai]
            # archmage_retreat
            side=$hoplite_enemyside
            ai_type=coward
            action=add
            [filter]
                type=Hoplite_Archmage
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_enemyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=3#radius for standing in place
                    [filter_radius]
                        terrain=!,{SPARTAN_WALL_TERRAIN}
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=1
#            attack_if_trapped=yes
#Archmage does not have a melee attack, so setting it to no
            attack_if_trapped=no
            ca_score=170000#set below 200k so that this is triggered after goto_x/goto_y (otherwise it would interfere with the "order unit to move" feature)
        [/micro_ai]
        [micro_ai]
            # coward_retreat_enemy
            side=$hoplite_enemyside
            ai_type=coward
            action=add
            [filter]
                ability=spartan_cowardly
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_enemyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=5
                    [filter_radius]
                        terrain=!,{SPARTAN_WALL_TERRAIN}
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=3
            attack_if_trapped=yes
            ca_score=170000#set below 200k so that this is triggered after goto_x/goto_y (otherwise it would interfere with the "order unit to move" feature)
        [/micro_ai]
        [micro_ai]
            # coward_retreat_ally
            side=$hoplite_allyside
            ai_type=coward
            action=add
            [filter]
                ability=spartan_cowardly
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_allyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=5
                    [filter_radius]
                        terrain=!,{SPARTAN_WALL_TERRAIN}
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=3
            attack_if_trapped=yes
            ca_score=170000#set below 200k so that this is triggered after goto_x/goto_y (otherwise it would interfere with the "order unit to move" feature)
        [/micro_ai]
        [micro_ai]
            # curse of fear is a stronger version of cowardly
            side=$hoplite_enemyside
            ai_type=coward
            action=add
            [filter]
                ability=spartan_terrified
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_enemyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=7
                    [filter_radius]
                        terrain=!,{SPARTAN_WALL_TERRAIN}
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=5
            attack_if_trapped=yes
            ca_score=171000#set below 200k so that this is triggered after goto_x/goto_y (otherwise it would interfere with the "order unit to move" feature), also slightly above normal cowardly MAI
        [/micro_ai]
        [micro_ai]
            # curse of fear is a stronger version of cowardly
            side=$hoplite_allyside
            ai_type=coward
            action=add
            [filter]
                ability=spartan_terrified
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_enemyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=7
                    [filter_radius]
                        terrain=!,{SPARTAN_WALL_TERRAIN}
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=5
            attack_if_trapped=yes
            ca_score=171000#set below 200k so that this is triggered after goto_x/goto_y (otherwise it would interfere with the "order unit to move" feature), also slightly above normal cowardly MAI
        [/micro_ai]
        [micro_ai]
            # wyvern_retreat
            side=$hoplite_enemyside
            ai_type=coward
            action=add
            [filter]
                type=Hoplite_Wyvern
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_enemyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=2
                    [filter_radius]
                        terrain=!,{SPARTAN_WALL_TERRAIN}
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=2
            attack_if_trapped=yes
            ca_score=170000#set below 200k so that this is triggered after goto_x/goto_y (otherwise it would interfere with the "order unit to move" feature)
        [/micro_ai]
        [micro_ai]
            # wyvern_retreat_ally
            side=$hoplite_allyside
            ai_type=coward
            action=add
            [filter]
                type=Hoplite_Wyvern
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_allyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    radius=2
                    [filter_radius]
                        terrain=!,{SPARTAN_WALL_TERRAIN}
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=2
            attack_if_trapped=yes
            ca_score=170000#set below 200k so that this is triggered after goto_x/goto_y (otherwise it would interfere with the "order unit to move" feature)
        [/micro_ai]
        [micro_ai]
            side=$hoplite_enemyside
            ai_type=lurkers
            action=add

            [filter]
                [filter_location]
                    [filter]
                        id=Hoplite,Hoplite2
                        [filter_vision]
                            visible=no
                            side=$hoplite_enemyside
                        [/filter_vision]
                    [/filter]
                    radius=4
                [/filter_location]
            [/filter]
            [filter_location]
            [/filter_location]
            [filter_location_wander]
            [/filter_location_wander]
            ca_score=90000#lower priority than coward MAIs/attack CA
        [/micro_ai]
        #turned off for now, since it actually made the ally AI worse
        #        [micro_ai]
        #            side=$hoplite_allyside
        #            ai_type=lurkers
        #            action=add
        #
        #            [filter]
        #	        [not]
        #		  type=Hoplite_Elizabeth
        #		[/not]
        #                [filter_location]
        #		    [not]
        #                    [filter]
        #                        side=$hoplite_enemyside
        ##                        [filter_vision]
        ##                            visible=yes
        ##                            side=$hoplite_allyside
        ##                        [/filter_vision]
        #                    [/filter]
        #                    radius=3
        #		    [/not]
        #                [/filter_location]
        #            [/filter]
        #            [filter_location]
        #            [/filter_location]
        #            [filter_location_wander]
        #            [/filter_location_wander]
        #            ca_score=90000#lower priority than coward MAIs/attack CA
        #        [/micro_ai]
        [micro_ai]
            side=$hoplite_allyside
            ai_type=lurkers
            action=add

            [filter]
                type=Hoplite_Elizabeth
                [filter_location]
                    [not]
                        [filter]
                            side=$hoplite_enemyside
                            #                        [filter_vision]
                            #                            visible=yes
                            #                            side=$hoplite_allyside
                            #                        [/filter_vision]
                        [/filter]
                        radius=3
                        [or]
                            [filter]
                                side=$hoplite_enemyside
                                [filter_adjacent]
                                    side=$hoplite_playerside
                                [/filter_adjacent]
                            [/filter]
                            radius=99
                        [/or]
                    [/not]
                [/filter_location]
            [/filter]
            [filter_location]
            [/filter_location]
            [filter_location_wander]
            [/filter_location_wander]
            ca_score=90000#lower priority than coward MAIs/attack CA
        [/micro_ai]
        [micro_ai]
            side=$hoplite_enemyside
            ai_type=lurkers
            action=add

            [filter]
                ability=ambush
                [not]
                    [filter_location]
                        [filter]
                            side=$hoplite_playerside,$hoplite_allyside
                        [/filter]
                        radius=2
                    [/filter_location]
                    [or]
                        ability=teleport_jungle
                    [/or]
                [/not]
            [/filter]
            [filter_location]
                terrain=*^F*
            [/filter_location]
            [filter_location_wander]
                terrain=*^F*
            [/filter_location_wander]
            ca_score=120000#lower priority than coward MAIs/attack CA, higher than other lurker CAs
        [/micro_ai]
        #forest hiding behavior for allies:
        [micro_ai]
            side=$hoplite_allyside
            ai_type=lurkers
            action=add

            [filter]
                ability=ambush
                [not]
                    [filter_location]
                        [filter]
                            side=$hoplite_enemyside
                        [/filter]
                        radius=2
                    [/filter_location]
                    [or]
                        ability=teleport_jungle
                    [/or]
                [/not]
            [/filter]
            [filter_location]
                terrain=*^F*
            [/filter_location]
            [filter_location_wander]
                terrain=*^F*
            [/filter_location_wander]
            ca_score=120000#lower priority than coward MAIs/attack CA, higher than other lurker CAs
        [/micro_ai]
        [micro_ai]
            # augurs
            side=$hoplite_enemyside
            ai_type=healer_support
            action=add
            [filter]
                type=Hoplite_Augur
            [/filter]
            #            aggression=0.1
        [/micro_ai]
        [micro_ai]
            # augurs_ally
            side=$hoplite_allyside
            ai_type=healer_support
            action=add
            [filter]
                type=Hoplite_Augur
            [/filter]
            #            aggression=0.1
        [/micro_ai]
        #this is no longer useful
        #[micro_ai]
        #    side=$hoplite_enemyside
        #    ai_type=stationed_guardian
        #    action=add
        #    [filter]
        #        # wmllint: recognize Donovan
        #        id=Donovan
        #    [/filter]
        #    distance=3
        #    station_x,station_y=6,5
        #    guard_x,guard_y=6,5
        #[/micro_ai]
        [micro_ai]
            # bomber_enemy_retreat
            side=$hoplite_enemyside
            ai_type=coward
            action=add
            [filter]
                ability=hoplite_bombthrow_ai
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_enemyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    #using $| so that the variable isn't instantly substituted
                    radius=$|this_unit.abilities.spartan_bombthrow.radius
                    [filter_radius]
                        terrain=!,{SPARTAN_WALL_TERRAIN}
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=2
            attack_if_trapped=yes
        [/micro_ai]
        [micro_ai]
            # bomber_ally_retreat
            side=$hoplite_allyside
            ai_type=coward
            action=add
            [filter]
                ability=hoplite_bombthrow_ai
                [filter_location]
                    [filter]
                        [filter_side]
                            [enemy_of]
                                side=$hoplite_allyside
                            [/enemy_of]
                        [/filter_side]
                    [/filter]
                    #using $| so that the variable isn't instantly substituted
                    radius=$|this_unit.abilities.spartan_bombthrow.radius
                    [filter_radius]
                        terrain=!,{SPARTAN_WALL_TERRAIN}
                    [/filter_radius]
                [/filter_location]
            [/filter]
            distance=2
            attack_if_trapped=yes
        [/micro_ai]
        #potential fix for "AI sometimes randomly stops attacking"
        [micro_ai]
            # ai_noattack_fix_enemyai
            side=$hoplite_enemyside
            ai_type=simple_attack
            action=add
            ca_score=105000#above normal attack CA, below the "attack with first weapon" CA, way lower CA than "spartan_ai_force_attack_with_best"
            [filter]
            [/filter]
            weapon=-1
        [/micro_ai]
        [micro_ai]
            # ai_noattack_fix_allyai
            side=$hoplite_allyside
            ai_type=simple_attack
            action=add
            ca_score=105000#above normal attack CA, below the "attack with first weapon" CA, way lower CA than "spartan_ai_force_attack_with_best"
            [filter]
            [/filter]
            weapon=-1
        [/micro_ai]
        #simple_attack forces AI to use specific attacks
        [micro_ai]
            # shielder_enemyai
            side=$hoplite_enemyside
            ai_type=simple_attack
            action=add
            ca_score=110000#above normal attack CA
            [filter]
                ability=spartan_ai_use_first_attack
            [/filter]
            weapon=1#unlike in WML, for lua here for lua 1 is the first weapon slot
        [/micro_ai]
        [micro_ai]
            # shielder_allyai
            side=$hoplite_allyside
            ai_type=simple_attack
            action=add
            ca_score=110000#above normal attack CA
            [filter]
                ability=spartan_ai_use_first_attack
            [/filter]
            weapon=1#unlike in WML, for lua here for lua 1 is the first weapon slot
        [/micro_ai]
        #workaround for scorpion and possibly some other units
        [micro_ai]
            # spartan_ai_force_attack_with_best_enemy
            side=$hoplite_enemyside
            ai_type=simple_attack
            action=add
            ca_score=200000#very high, above poison CA
            [filter]
                ability=spartan_ai_force_attack_with_best
            [/filter]
            weapon=-1
        [/micro_ai]
        [micro_ai]
            # spartan_ai_force_attack_with_best_ally
            side=$hoplite_allyside
            ai_type=simple_attack
            action=add
            ca_score=200000#very high, above poison CA
            [filter]
                ability=spartan_ai_force_attack_with_best
            [/filter]
            weapon=-1
        [/micro_ai]

        #TODO MAKE THIS WORK PROPERLY!!!

        #modify ally side to avoid attacking bombs

        #TODO: allow AI to use knockback attacks on bombs

        #DOES NOT WORK RIGHT NOW, maybe simple_attack micro ais are taking priority

        #[modify_ai]
        #    side=$hoplite_allyside
        #    action=add
        #    path=aspect[attacks].facet[]
        #    [facet]
        #        invalidate_on_gamestate_change=yes
        #        [filter_own]
        #        [/filter_own]
        #        [filter_enemy]
        #            [not]
        #                ability=spartan_bombfilter
        #            [/not]
        #        [/filter_enemy]
        #    [/facet]
        #[/modify_ai]
#enddef