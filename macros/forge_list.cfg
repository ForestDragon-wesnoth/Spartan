#textdomain wesnoth-Hoplite

#define ADD_UPGRADE_TO_DISCOVERED ID SIDE

    {IF_VAR {ID}_discovered{SIDE} not_equals yes (
        [then]
            [set_variables]
                name=hoplite_discoveredupgrades{SIDE}
                mode=append
                [value]
                    id={ID}
                [/value]
            [/set_variables]
        [/then]
    )}

    [set_global_variable]
        namespace=spartan
        from_local=hoplite_discoveredupgrades{SIDE}
        to_global=discoveredupgrades_array
        side={SIDE}
        immediate=yes
    [/set_global_variable]
    {VARIABLE {ID}discovered{SIDE} yes}

    #progress here is mostly just visual, what matters is the array length
    {VARIABLE discover_upgrades_progress{SIDE} $hoplite_discoveredupgrades{SIDE}.length}
    {VARIABLE discover_upgradesII_progress{SIDE} $hoplite_discoveredupgrades{SIDE}.length}
    {VARIABLE discover_upgradesIII_progress{SIDE} $hoplite_discoveredupgrades{SIDE}.length}

    {IF_VAR hoplite_discoveredupgrades{SIDE}.length greater_than_equal_to 20 (
        [then]
            {ACHIEVEMENT_MESSAGE_LONE discover_upgrades {SIDE}}
        [/then]
    )}

    {IF_VAR hoplite_discoveredupgrades{SIDE}.length greater_than_equal_to 40 (
        [then]
            {ACHIEVEMENT_MESSAGE_LONE discover_upgradesII {SIDE}}
        [/then]
    )}

    {IF_VAR hoplite_discoveredupgrades{SIDE}.length greater_than_equal_to 60 (
        [then]
            {ACHIEVEMENT_MESSAGE_LONE discover_upgradesIII {SIDE}}
        [/then]
    )}
#enddef

#define HOPLITE_UNPACK_DISCOVERED_ACHIEVEMENTS_ARRAY SIDE
    [foreach]
        array=hoplite_discoveredupgrades{SIDE}
        index_var=i
        [do]
            {VARIABLE $this_item.id|_discovered{SIDE} yes}
        [/do]
    [/foreach]
#enddef

#define HOPLITE_RETREIVE_DISCOVERED_UPGRADES
    [get_global_variable]
        namespace=spartan
        from_global=discoveredupgrades_array
        to_local=hoplite_discoveredupgrades1
        side=1
    [/get_global_variable]
    {HOPLITE_UNPACK_DISCOVERED_ACHIEVEMENTS_ARRAY 1}
#ifdef MULTIPLAYER
    [get_global_variable]
        namespace=spartan
        from_global=discoveredupgrades_array
        to_local=hoplite_discoveredupgrades2
        side=2
    [/get_global_variable]
    {HOPLITE_UNPACK_DISCOVERED_ACHIEVEMENTS_ARRAY 2}
#endif
    #progress here is mostly just visual, what matters is the array length
    {VARIABLE discover_upgrades_progress1 $hoplite_discoveredupgrades1.length}
    {VARIABLE discover_upgradesII_progress1 $hoplite_discoveredupgrades1.length}
    {VARIABLE discover_upgradesIII_progress1 $hoplite_discoveredupgrades1.length}
    {VARIABLE discover_upgrades_progress2 $hoplite_discoveredupgrades2.length}
    {VARIABLE discover_upgradesII_progress2 $hoplite_discoveredupgrades2.length}
    {VARIABLE discover_upgradesIII_progress2 $hoplite_discoveredupgrades2.length}
#enddef

#define HOPLITE_CLEAR_DISCOVEREDUPGRADES SIDE
    [foreach]
        array=hoplite_discoveredupgrades{SIDE}
        index_var=i
        [do]
            {CLEAR_VARIABLE $this_item.id|_discovered{SIDE}}
        [/do]
    [/foreach]
    [clear_global_variable]
        namespace=spartan
        global=discoveredupgrades_array
        side={SIDE}
        immediate=yes
    [/clear_global_variable]
#enddef

#define UNLOCK_AND_ADD_UPGRADE_TO_UPGRADE_ARRAY ID SIDE

    {IF_VAR {ID}_unlocked{SIDE} not_equals yes (
        [then]
            [set_variable]
                name={ID}_unlocked{SIDE}
                value=yes
            [/set_variable]

            [set_variables]
                name=hoplite_current_upgrades{SIDE}
                mode=append
                [value]
                    id={ID}
                [/value]
            [/set_variables]
        [/then]
    )}
#enddef

#currently mostly used for rewind time feature

#define HOPLITE_CLEAR_UPGRADES SIDE
    [foreach]
        array=hoplite_current_upgrades{SIDE}
        index_var=i
        [do]
            {CLEAR_VARIABLE $this_item.id|_unlocked{SIDE}}
        [/do]
    [/foreach]
    {CLEAR_VARIABLE hoplite_current_upgrades{SIDE}}
#enddef

#define FORGE_EFFECT_START ID
    [if]
        {VARIABLE_CONDITIONAL tmp_forge_upgrade_is_shared equals yes}
        [then]
            [if]
                [have_unit]
                    id=Hoplite2
                [/have_unit]
                [then]
                    {HOPLITE_PLAYERFILTER1b (
                        {VARIABLE hoplite_upgradeid Hoplite}
                        {CLEAR_VARIABLE hoplite_upgrademenu1}
                    ) (
                        {VARIABLE hoplite_upgradeid Hoplite2}
                        {CLEAR_VARIABLE hoplite_upgrademenu2}
                    )}
                    {VARIABLE_OP hoplite_upgrades1 add 1}
                    {VARIABLE_OP hoplite_upgrades2 add 1}
                [/then]
                [else]
                    {VARIABLE hoplite_upgradeid Hoplite}
                    {VARIABLE_OP hoplite_upgrades1 add 1}
                    {CLEAR_VARIABLE hoplite_upgrademenu}
                [/else]
            [/if]
        [/then]
        [else]
            [if]
                [have_unit]
                    id=Hoplite2
                [/have_unit]
                [then]
                    {HOPLITE_PLAYERFILTER1b (
                        {VARIABLE hoplite_upgradeid Hoplite}
                        {VARIABLE_OP hoplite_upgrades1 add 1}
                        {CLEAR_VARIABLE hoplite_upgrademenu1}
                    ) (
                        {VARIABLE hoplite_upgradeid Hoplite2}
                        {VARIABLE_OP hoplite_upgrades2 add 1}
                        {CLEAR_VARIABLE hoplite_upgrademenu2}
                    )}
                [/then]
                [else]
                    {VARIABLE hoplite_upgradeid Hoplite}
                    {VARIABLE_OP hoplite_upgrades1 add 1}
                    {CLEAR_VARIABLE hoplite_upgrademenu}
                [/else]
            [/if]
        [/else]
    [/if]
#enddef

#define FORGE_EFFECT_END ID
    {CLEAR_VARIABLE hoplite_upgradeid}
    [if]
        {VARIABLE_CONDITIONAL tmp_spartan_no_upgrade_sound_or_delay not_equals yes}
        [then]
            [sound]
                name=mace.wav
            [/sound]
            [delay]
                time=300
            [/delay]
            [sound]
                name=mace.wav
            [/sound]
            [delay]
                time=300
            [/delay]
            [sound]
                name=mace.wav
            [/sound]
            {IF_VAR hoplite_debugmenu not_equals yes (
                [then]
                    [delay]
                        time=1000
                    [/delay]
                [/then]
            )}
        [/then]
    [/if]
    #                [if]
    #                [have_unit]
    #	           id=Hoplite2
    #                [/have_unit]
    #        	[then]
    #                {HOPLITE_PLAYERFILTER1b (
    #                [set_variable]
    #                   name={ID}_unlocked1
    #                   value=yes
    #                [/set_variable]
    #                {ADD_UPGRADE_TO_DISCOVERED {ID} 1}
    #    	        ) (
    #                [set_variable]
    #                   name={ID}_unlocked2
    #                   value=yes
    #                [/set_variable]
    #                {ADD_UPGRADE_TO_DISCOVERED {ID} 2}
    #                )}
    #		[/then]
    #		[else]
    #                [set_variable]
    #                   name={ID}_unlocked1
    #                   value=yes
    #                [/set_variable]
    #                #TODO: remove this later, as this only exists for testing (to prevent upgrades immediately breaking before being converted to work with #unlocked1):
    #                [set_variable]
    #                   name={ID}_unlocked
    #                   value=yes
    #                [/set_variable]
    #                {ADD_UPGRADE_TO_DISCOVERED {ID} 1}
    #		[/else]
    #		[/if]

    [if]
        {VARIABLE_CONDITIONAL tmp_forge_upgrade_is_shared equals yes}
        [then]
            {UNLOCK_AND_ADD_UPGRADE_TO_UPGRADE_ARRAY {ID} 1}
            {ADD_UPGRADE_TO_DISCOVERED {ID} 1}
#ifdef MULTIPLAYER
            {UNLOCK_AND_ADD_UPGRADE_TO_UPGRADE_ARRAY {ID} 2}
            {ADD_UPGRADE_TO_DISCOVERED {ID} 2}
#endif
        [/then]
        [else]
            {HOPLITE_PLAYERFILTER1b (
                {UNLOCK_AND_ADD_UPGRADE_TO_UPGRADE_ARRAY {ID} 1}
                {ADD_UPGRADE_TO_DISCOVERED {ID} 1}
            ) (
                {UNLOCK_AND_ADD_UPGRADE_TO_UPGRADE_ARRAY {ID} 2}
                {ADD_UPGRADE_TO_DISCOVERED {ID} 2}
            )}
        [/else]
    [/if]

    {VARIABLE powerhouse_progress1 $hoplite_upgrades1}
    {VARIABLE powerhouse_progress2 $hoplite_upgrades2}

    {IF_VAR powerhouse_progress1 equals 30 (
        [then]
            {ACHIEVEMENT_MESSAGE_LONE powerhouse 1}
        [/then]
    )}
    {IF_VAR powerhouse_progress2 equals 30 (
        [then]
            {ACHIEVEMENT_MESSAGE_LONE powerhouse 2}
        [/then]
    )}

    {IF_VAR hoplite_upgrades1 greater_than_equal_to 10 (
        [and]
            {VARIABLE_CONDITIONAL hoplite_upgrades2 greater_than_equal_to 10}
        [/and]
        [then]
            {VARIABLE tmp_upgradesmatch yes}

            #      [chat]
            #         message=_"player 1 begin"
            #      [/chat]

            [foreach]
                array=hoplite_current_upgrades1
                index_var=i
                [do]
                    {IF_VAR $this_item.id|_unlocked2 equals yes (
                        [then]
                            #               [chat]
                            #                  message=_"matching $this_item.id|"
                            #               [/chat]
                        [/then]
                        [else]
                            #               [chat]
                            #                  message=_"mismatching $this_item.id|"
                            #               [/chat]
                            {VARIABLE tmp_upgradesmatch no}
                        [/else]
                    )}
                [/do]
            [/foreach]

            #      [chat]
            #         message=_"player 2 begin"
            #      [/chat]

            [foreach]
                array=hoplite_current_upgrades2
                index_var=i
                [do]
                    {IF_VAR $this_item.id|_unlocked1 equals yes (
                        [then]
                            #               [chat]
                            #                  message=_"matching $this_item.id|"
                            #               [/chat]
                        [/then]
                        [else]
                            #               [chat]
                            #                  message=_"mismatching $this_item.id|"
                            #               [/chat]
                            {VARIABLE tmp_upgradesmatch no}
                        [/else]
                    )}
                [/do]
            [/foreach]

            {IF_VAR tmp_upgradesmatch equals yes (
                [then]
                    {ACHIEVEMENT_MESSAGE great_minds_think_alike}
                [/then]
            )}
        [/then]
    )}

    {IF_VAR hoplite_upgradesleft greater_than 0 (
        [or]
            [variable]
                name=hoplite_upgradesleft1
                greater_than=0
            [/variable]
        [/or]
        [or]
            [variable]
                name=hoplite_upgradesleft2
                greater_than=0
            [/variable]
        [/or]
        [then]
            [if]
                [have_unit]
                    id=Hoplite2
                [/have_unit]
                [then]
                    {HOPLITE_PLAYERFILTER1b (
                        [set_variable]
                            name=hoplite_upgradesleft1
                            sub=1
                        [/set_variable]
                    ) (
                        [set_variable]
                            name=hoplite_upgradesleft2
                            sub=1
                        [/set_variable]
                    )}
                [/then]
                [else]
                    [set_variable]
                        name=hoplite_upgradesleft
                        sub=1
                    [/set_variable]
                [/else]
            [/if]
        [/then]
    )}
    {IF_VAR hoplite_debugmenu not_equals yes (
        [and]
            {VARIABLE_CONDITIONAL spartan_upgrade_without_forge not_equals yes}
        [/and]
        [then]
            [set_variable]
                name=usedforge
                value=yes
            [/set_variable]

#            {IF_VAR goldenforge equals yes (
            {IF_VAR forge_value greater_than_equal_to 2 (
                [then]
                    [remove_item]
                        image="terrain/forge-golden-working.png"
                        x,y=$forge_x,$forge_y
                    [/remove_item]
                    [item]
                        image=terrain/forge-golden.png
                        x,y=$forge_x,$forge_y
                    [/item]
                [/then]
                [else]
                    [remove_item]
                        image="terrain/forge-working.png"
                        x,y=$forge_x,$forge_y
                    [/remove_item]
                    [item]
                        image=terrain/forge.png
                        x,y=$forge_x,$forge_y
                    [/item]
                [/else]
            )}
        [/then]
    )}
#enddef

#define FORGE_COMPANION_OBJECT UNITID EFFECTS
    [if]
        [have_unit]
            id={UNITID}
            trait=loyal#IMPORTANT, so that not-yet-saved Algadur cannot be upgraded
        [/have_unit]
        [then]
        [/then]
        [else]
            #temporarily unstore companions to apply upgrades before storing them again
            {VARIABLE companionid {UNITID}}
            {IF_VAR companionid equals Algadur (
                [then]
                    [unstore_unit]
                        variable=Algadur_stored
                        x,y=1,1
                        find_vacant=yes
                    [/unstore_unit]
                    [hide_unit]
                        id=Algadur
                    [/hide_unit]
                    #[unstore_unit]
                    #    variable=Algadur_stored
                    #    x,y=recall,recall
                    #[/unstore_unit]
                [/then]
            )}
            {IF_VAR companionid equals Elizabeth (
                [then]
                    [unstore_unit]
                        variable=Elizabeth_stored
                        x,y=1,1
                        find_vacant=yes
                    [/unstore_unit]
                    [hide_unit]
                        id=Elizabeth
                    [/hide_unit]
                    #[unstore_unit]
                    #    variable=Elizabeth_stored
                    #    x,y=recall,recall
                    #[/unstore_unit]
                [/then]
            )}
            {IF_VAR companionid equals Galatea (
                [then]
                    [unstore_unit]
                        variable=Galatea_stored
                        x,y=1,1
                        find_vacant=yes
                    [/unstore_unit]
                    [hide_unit]
                        id=Galatea
                    [/hide_unit]
                    #[unstore_unit]
                    #    variable=Galatea_stored
                    #    x,y=recall,recall
                    #[/unstore_unit]
                [/then]
            )}
        [/else]
    [/if]
    [object]
        silent=yes
        duration=forever
        [filter]
            id={UNITID}
        [/filter]
        {EFFECTS}
    [/object]

    #after companions that are on cooldown are unstored, store them again

    {IF_VAR algadur_cooldown greater_than 0 (
    [and]
        [have_unit]
            id=Algadur
            trait=loyal
        [/have_unit]
    [/and]
        [then]
            [unhide_unit]
                id=Algadur
            [/unhide_unit]
            [store_unit]
                [filter]
                    id=Algadur
                [/filter]
                variable=Algadur_stored
                kill=yes
            [/store_unit]
        [/then]
    )}
    {IF_VAR elizabeth_cooldown greater_than 0 (
    [and]
        [have_unit]
            id=Elizabeth
            trait=loyal
        [/have_unit]
    [/and]
        [then]
            [unhide_unit]
                id=Elizabeth
            [/unhide_unit]
            [store_unit]
                [filter]
                    id=Elizabeth
                [/filter]
                variable=Elizabeth_stored
                kill=yes
            [/store_unit]
        [/then]
    )}
    {IF_VAR galatea_cooldown greater_than 0 (
    [and]
        [have_unit]
            id=Galatea
            side=$hoplite_allyside
            trait=loyal
        [/have_unit]
    [/and]
        [then]
            [unhide_unit]
                id=Galatea
            [/unhide_unit]
            [store_unit]
                [filter]
                    id=Galatea
                [/filter]
                variable=Galatea_stored
                kill=yes
            [/store_unit]
        [/then]
    )}
#enddef

#define ADD_FORGE_UPGRADE_TO_LIST ID NAME DESCR ICON OTHER_PARAMS
    #this is used to automatically add the shared note
    [set_variables]
        name=hoplite_tmp_forge_otherparams
        mode=append
        [value]
            {OTHER_PARAMS}
        [/value]
    [/set_variables]

    {IF_VAR hoplite_tmp_forge_otherparams.is_shared equals yes (
        [then]
            {VARIABLE tmp_extra_note {IS_SHARED_NOTE}}
        [/then]
        [else]
            {VARIABLE tmp_extra_note ""}
        [/else]
    )}

    [set_variables]
        name=hoplite_forge_upgrade
        mode=append
        [value]
            id={ID}
            icon={ICON}
            name={NAME}
            descr={DESCR}
            full_descr="<span color='#ffff99'>"+{NAME}+"</span>: "+{DESCR}+$tmp_extra_note|
            #should support comma-seperated lists of upgrades/bosses
            #accepts required_bosses=/required_upgrades=/required_companions/required_weapon/not_obtainable_by_forge as values
            #also "is_shared=yes" for companion upgrades and Ambush
            #add a "only require one of the required upgrades" parameter, for stuff like flame blast
            #also require_companion
            {OTHER_PARAMS}
        [/value]
    [/set_variables]
    {CLEAR_VARIABLE hoplite_tmp_forge_otherparams,tmp_extra_note}
#enddef

#define HOPLITE_CREATE_CURRENT_UPGRADES_DIALOG_OPTIONS SIDE
    [foreach]
        array=hoplite_forge_upgrade
        index_var=i
        [do]
            {IF_VAR $this_item.id|_unlocked{SIDE} equals yes (
                [then]
                    [set_variables]
                        name=hoplite_currentupgrades_options
                        mode=append
                        [value]
                            image=$this_item.icon|
                            description=$this_item.full_descr|
                            [command]
                            [/command]
                        [/value]
                    [/set_variables]
                [/then]
            )}
        [/do]
    [/foreach]
#enddef

#define HOPLITE_CREATE_DISCOVERED_UPGRADES_DIALOG_OPTIONS SIDE
    [foreach]
        array=hoplite_forge_upgrade
        index_var=i
        [do]
            {IF_VAR $this_item.id|_unlocked{SIDE} equals yes (
                [then]
                    [set_variables]
                        name=hoplite_discoveredupgrades_options
                        mode=append
                        [value]
                            image=$this_item.icon|
                            description=$this_item.full_descr|
                            [command]
                            [/command]
                        [/value]
                    [/set_variables]
                [/then]
                [elseif]
                    {VARIABLE_CONDITIONAL $this_item.id|_discovered{SIDE} equals yes}
                    [then]
                        [set_variables]
                            name=hoplite_discoveredupgrades_options
                            mode=append
                            [value]
                                image="$this_item.icon|~SEPIA()"
                                description=$this_item.full_descr|
                                [command]
                                [/command]
                            [/value]
                        [/set_variables]
                    [/then]
                [/elseif]
                [else]
                    [set_variables]
                        name=hoplite_discoveredupgrades_options
                        mode=append
                        [value]
                            image="units/unknown-unit.png~RC(magenta>white)"
                            description=_"???: you haven't discovered this upgrade yet."
                            [command]
                            [/command]
                        [/value]
                    [/set_variables]
                [/else]
            )}
        [/do]
    [/foreach]
#enddef

#define HOPLITE_CREATE_FORGE_OPTIONS SIDE

    #used to add a failsafe if the player does not have access to any remaining upgrades whatsoever (should be unlikely to happen in a normal match, but very much possible with spartan debug)
    {VARIABLE tmp_at_least_one_upgrade_available no}

    [foreach]
        array=hoplite_forge_upgrade
        index_var=i
        [do]
            [if]
                {VARIABLE_CONDITIONAL $this_item.id|_unlocked{SIDE} not_equals yes}
                [then]
                    {VARIABLE tmp_upgrade_islocked no}#used mainly for boss-locked upgrades/companion-locked upgrades when you have one companion but not another
                    {VARIABLE tmp_upgrade_ishidden no}#unlike locked, prevent the upgrade from being visible altogether (used for upgrades that require other upgrades, or companion upgrades when you have no companions)

                    {IF_VAR this_item.required_upgrades not_equals $emptyvar (
                        [then]
                            #      [chat]
                            #         message="upgrade has requirements"
                            #      [/chat]
                            [set_variables]
                                name=tmp_required_upgrades_list
                                [split]
                                    list=$this_item.required_upgrades
                                    key=id
                                    separator=,
                                [/split]
                            [/set_variables]

                            #used for certain upgrades like Flame Blast:

                            {IF_VAR this_item.require_only_one_upgrade equals yes (
                                [then]
                                    {VARIABLE tmp_upgrade_ishidden yes}
                                    [foreach]
                                        array=tmp_required_upgrades_list
                                        index_var=e
                                        [do]
                                            #      [chat]
                                            #         message="requirement id: $this_item.id|"
                                            #      [/chat]

                                            {IF_VAR $this_item.id|_unlocked{SIDE} equals yes (
                                                [then]
                                                    {VARIABLE tmp_upgrade_ishidden no}
                                                [/then]
                                            )}
                                        [/do]
                                    [/foreach]
                                [/then]
                                [else]
                                    [foreach]
                                        array=tmp_required_upgrades_list
                                        index_var=e
                                        [do]
                                            #      [chat]
                                            #         message="requirement id: $this_item.id|"
                                            #      [/chat]

                                            {IF_VAR $this_item.id|_unlocked{SIDE} not_equals yes (
                                                [then]
                                                    {VARIABLE tmp_upgrade_ishidden yes}
                                                    {VARIABLE_OP tmp_missing_upgrades add 1}
                                                [/then]
                                            )}
                                        [/do]
                                    [/foreach]

                                    {IF_VAR tmp_missing_upgrades greater_than 0 (
                                        [and]
                                            {VARIABLE_CONDITIONAL tmp_required_upgrades_list.length greater_than 1}
                                        [/and]
                                        [and]
                                            #only show the upgrade in the list if at least one of the required upgrades is taken
                                            {VARIABLE_CONDITIONAL tmp_missing_upgrades less_than $tmp_required_upgrades_list.length}
                                        [/and]
                                        [then]
                                            {VARIABLE tmp_upgrade_ishidden no}

                                            {VARIABLE tmp_requiredupgrades_text ""}

                                            [foreach]
                                                array=tmp_required_upgrades_list
                                                index_var=e
                                                [do]
                                                    #      [chat]
                                                    #         message="requirement id: $this_item.id|"
                                                    #      [/chat]

                                                    {IF_VAR tmp_requiredupgrades_text equals "" (
                                                        [else]
                                                            {VARIABLE tmp_requiredupgrades_text "$tmp_requiredupgrades_text|,"}
                                                        [/else]
                                                    )}

                                                    {SPARTAN_GET_UPGRADE_NAME $this_item.id}

                                                    {IF_VAR $this_item.id|_unlocked{SIDE} equals yes (
                                                        [then]
                                                            {VARIABLE tmp_requiredupgrades_text _"$tmp_requiredupgrades_text|<span color='#99ff66'>$tmp_upgradename|</span>"}
                                                        [/then]
                                                        [else]
                                                            {VARIABLE tmp_requiredupgrades_text _"$tmp_requiredupgrades_text|<span color='#ff6666'>$tmp_upgradename|</span>"}
                                                        [/else]
                                                    )}

                                                    {CLEAR_VARIABLE tmp_upgradename}
                                                [/do]
                                            [/foreach]

                                            {VARIABLE tmp_upgrade_islocked yes}
                                            {VARIABLE tmp_lockreason _"(this upgrade requires the following upgrades: $tmp_requiredupgrades_text|) "}
                                            {VARIABLE tmp_lockreason_undiscovered _"???: this upgrade requires the following upgrades: $tmp_requiredupgrades_text|"}
                                            {CLEAR_VARIABLE tmp_requiredupgrades_text}
                                        [/then]
                                    )}

                                    {CLEAR_VARIABLE tmp_missing_upgrades}
                                [/else]
                            )}

                            {CLEAR_VARIABLE tmp_required_upgrades_list}
                        [/then]
                    )}

                    {IF_VAR this_item.required_bosses not_equals $emptyvar (
                    #one of the custom difficulty settings disables boss requirements for upgrades
                    [and]
                        [not]
                            {VARIABLE_CONDITIONAL spartan_difficulty_values.no_boss_restriction_on_upgrades equals yes}
                        [/not]
                    [/and]
                        [then]
                            #      [chat]
                            #         message="upgrade has boss requirements"
                            #      [/chat]
                            [set_variables]
                                name=tmp_required_bosses_list
                                [split]
                                    list=$this_item.required_bosses
                                    key=id
                                    separator=,
                                [/split]
                            [/set_variables]

                            [foreach]
                                array=tmp_required_bosses_list
                                index_var=e
                                [do]
                                    #      [chat]
                                    #         message="boss id: $this_item.id|"
                                    #      [/chat]

                                    {IF_VAR $this_item.id|_beaten not_equals yes (
                                        [then]
                                            {VARIABLE tmp_upgrade_islocked yes}
                                            {VARIABLE tmp_lockreason _"(beat a certain boss to unlock this upgrade) "}
                                            {VARIABLE tmp_lockreason_undiscovered _"???: beat a certain boss to unlock this upgrade"}
                                        [/then]
                                    )}
                                [/do]
                            [/foreach]

                            {CLEAR_VARIABLE tmp_required_upgrades_list}
                        [/then]
                    )}

                    {IF_VAR this_item.required_companions not_equals $emptyvar (
                        [then]
                            [if]
                                [have_unit]
                                    side=$hoplite_allyside
                                    ability=hoplite_companion
                                [/have_unit]
                                [or]
                                    {VARIABLE_CONDITIONAL Algadur_stored.x greater_than 0}
                                [/or]
                                [or]
                                    {VARIABLE_CONDITIONAL Elizabeth_stored.x greater_than 0}
                                [/or]
                                [or]
                                    {VARIABLE_CONDITIONAL Galatea_stored.x greater_than 0}
                                [/or]
                                [then]
                                    #'any' is for upgrades like quick recovery:
                                    {IF_VAR this_item.required_companions equals any (
                                        [else]
                                            [set_variables]
                                                name=tmp_required_companions_list
                                                [split]
                                                    list=$this_item.required_companions
                                                    key=id
                                                    separator=,
                                                [/split]
                                            [/set_variables]

                                            [foreach]
                                                array=tmp_required_companions_list
                                                index_var=e
                                                [do]
                                                    [if]
                                                        [have_unit]
                                                            id=$this_item.id
                                                        [/have_unit]
                                                        [or]
                                                            {VARIABLE_CONDITIONAL $this_item.id|_stored.x greater_than 0}
                                                        [/or]
                                                        [else]
                                                            {VARIABLE tmp_upgrade_islocked yes}
                                                            {VARIABLE tmp_lockreason _"(recruit a certain companion to unlock this upgrade) "}
                                                            {VARIABLE tmp_lockreason_undiscovered _"???: recruit a certain companion to unlock this upgrade"}
                                                        [/else]
                                                    [/if]
                                                [/do]
                                            [/foreach]

                                            {CLEAR_VARIABLE tmp_required_companions_list}

                                            #Galatea upgrades are fully hidden until you get Galatea
                                            {IF_VAR this_item.galatea_secret_companion_upgrade equals yes (
                                            [and]
                                                [not]
                                                    [have_unit]
                                                        id=Galatea
                                                    [/have_unit]
                                                    [or]
                                                        {VARIABLE_CONDITIONAL Galatea_stored.x greater_than 0}
                                                    [/or]
                                                [/not]
                                            [/and]
                                            [then]
                                                {VARIABLE tmp_upgrade_ishidden yes}
                                            [/then]
                                            )}

                                        [/else]
                                    )}
                                [/then]
                                [else]
                                    {VARIABLE tmp_upgrade_ishidden yes}
                                [/else]
                            [/if]
                        [/then]
                    )}

                    #in case I add either alt characters or just weapon restrictions at start:
                    {IF_VAR this_item.required_weapon not_equals $emptyvar (
                        [then]
                            [if]
                                [have_unit]
                                    side={SIDE}
                                    canrecruit=yes
                                    [has_attack]
                                        name=$this_item.required_weapon
                                    [/has_attack]
                                [/have_unit]
                                [else]
                                    {VARIABLE tmp_upgrade_ishidden yes}
                                [/else]
                            [/if]
                        [/then]
                    )}

                    {IF_VAR this_item.required_classes not_equals $emptyvar (
                        [then]
                            #      [chat]
                            #         message="upgrade requires class"
                            #      [/chat]
                            [set_variables]
                                name=tmp_required_classes_list
                                [split]
                                    list=$this_item.required_classes
                                    key=id
                                    separator=,
                                [/split]
                            [/set_variables]

                            [foreach]
                                array=tmp_required_classes_list
                                index_var=e
                                [do]
                                    #      [chat]
                                    #         message="requirement id: $this_item.id|"
                                    #      [/chat]

                                    {IF_VAR spartan_selected_character{SIDE} equals $this_item.id (
                                        [then]
                                            {VARIABLE tmp_found_at_least_one_matching_class yes}
                                        [/then]
                                    )}
                                [/do]
                            [/foreach]
                            {IF_VAR tmp_found_at_least_one_matching_class equals yes (
                                [else]
                                    {VARIABLE tmp_upgrade_ishidden yes}
                                [/else]
                            )}

                            {CLEAR_VARIABLE tmp_required_classes_list}
                            {CLEAR_VARIABLE tmp_found_at_least_one_matching_class}
                        [/then]
                    )}

                    {IF_VAR this_item.not_obtainable_by_forge equals yes (
                        [then]
                            {VARIABLE tmp_upgrade_ishidden yes}
                        [/then]
                    )}

                    {IF_VAR banned_upgrades{SIDE} not_equals $emptyvar (
                        [then]
                            [set_variables]
                                name=tmp_banned_upgrades_list
                                [split]
                                    list=$banned_upgrades{SIDE}
                                    key=id
                                    separator=,
                                [/split]
                            [/set_variables]
                            {VARIABLE tmp_compared_upgrade_id $this_item.id}
                            [foreach]
                                array=tmp_banned_upgrades_list
                                index_var=e
                                [do]
                                    {IF_VAR this_item.id equals $tmp_compared_upgrade_id (
                                        [then]
                                            {VARIABLE tmp_upgrade_ishidden yes}
                                        [/then]
                                    )}
                                [/do]
                            [/foreach]
                            {CLEAR_VARIABLE tmp_banned_upgrades_list,tmp_compared_upgrade_id}
                        [/then]
                    )}

                    {IF_VAR tmp_upgrade_islocked equals no (
                        [and]
                            {VARIABLE_CONDITIONAL tmp_upgrade_ishidden equals no}
                        [/and]
                        [then]
                            {IF_VAR this_item.is_shared equals yes (
                                [then]
                                    [set_variables]
                                        name=hoplite_forgeupgrades_options
                                        mode=append
                                        [value]
                                            image=$this_item.icon|
                                            description=$this_item.full_descr|
                                            [command]
                                                {VARIABLE tmp_forge_upgrade_id $this_item.id}
                                                {VARIABLE tmp_forge_upgrade_is_shared yes}
                                                [fire_event]
                                                    id=spartan_forge_effect_event
                                                [/fire_event]
                                            [/command]
                                        [/value]
                                    [/set_variables]
                                [/then]
                                [else]
                                    [set_variables]
                                        name=hoplite_forgeupgrades_options
                                        mode=append
                                        [value]
                                            image=$this_item.icon|
                                            description=$this_item.full_descr|
                                            [command]
                                                {VARIABLE tmp_forge_upgrade_id $this_item.id}
                                                {VARIABLE tmp_forge_upgrade_is_shared no}
                                                [fire_event]
                                                    id=spartan_forge_effect_event
                                                [/fire_event]
                                            [/command]
                                        [/value]
                                    [/set_variables]
                                [/else]
                            )}
                            {VARIABLE tmp_at_least_one_upgrade_available yes}
                        [/then]
                        [elseif]
                            {VARIABLE_CONDITIONAL tmp_upgrade_islocked equals yes}
                            [and]
                                {VARIABLE_CONDITIONAL tmp_upgrade_ishidden equals no}
                            [/and]
                            [then]
                                {IF_VAR $this_item.id|_discovered{SIDE} equals yes (
                                    [then]
                                        [set_variables]
                                            name=hoplite_forgeupgrades_options
                                            mode=append
                                            [value]
                                                image="$this_item.icon|~SEPIA()~BLIT(icons/locked.png)"
                                                description=$tmp_lockreason|+$this_item.full_descr|
                                                [command]
                                                [/command]
                                            [/value]
                                        [/set_variables]
                                    [/then]
                                    [else]
                                        [set_variables]
                                            name=hoplite_forgeupgrades_options
                                            mode=append
                                            [value]
                                                image="units/unknown-unit.png~RC(magenta>white)"
                                                description=$tmp_lockreason_undiscovered|
                                                [command]
                                                [/command]
                                            [/value]
                                        [/set_variables]
                                    [/else]
                                )}
                            [/then]
                        [/elseif]
                        [else]
                        [/else]
                    )}
                [/then]
            [/if]
        [/do]
    [/foreach]
    #failsafe option to exit menu if there is no upgrades left
    {IF_VAR tmp_at_least_one_upgrade_available equals no (
        [then]
            [set_variables]
                name=hoplite_forgeupgrades_options
                mode=append
                [value]
                    image="attacks/blank-attack.png"
                    description=_"Leave the forge
(you cannot take any upgrades now)"
                    [command]
                        [if]
                            [have_unit]
                                id=Hoplite2
                            [/have_unit]
                            [then]
                                {HOPLITE_PLAYERFILTER1b (
                                    {VARIABLE hoplite_upgradesleft1 0}
                                    {VARIABLE tmp_hoplite_upgraderepeat 0}
                                    {CLEAR_VARIABLE hoplite_upgrademenu1}
                                ) (
                                    {VARIABLE hoplite_upgradesleft2 0}
                                    {VARIABLE tmp_hoplite_upgraderepeat 0}
                                    {CLEAR_VARIABLE hoplite_upgrademenu2}
                                )}
                            [/then]
                            [else]
                                {VARIABLE hoplite_upgradesleft 0}
                                {VARIABLE tmp_hoplite_upgraderepeat 0}
                                {CLEAR_VARIABLE hoplite_upgrademenu}
                            [/else]
                        [/if]
                    [/command]
                [/value]
            [/set_variables]
        [/then]
    )}
#enddef

#ifdef MULTIPLAYER

#define IS_SHARED_NOTE
    _"
   (this upgrade is shared between players
   and will show in both players' upgrade list)"#enddef

#else

#in singleplayer, the shared ugprade note is pointless, and therefore is not shown

#define IS_SHARED_NOTE
#enddef

#endif

#define SPARTAN_FORGE_EVENTS
    [event]
        name=prestart
        id=spartan_create_forgelist_event
        #upgrade code is no longer directly included in event macro. will instead be called via fire event and a switch/case statement for which upgrade the player picked

        {ADD_FORGE_UPGRADE_TO_LIST algadurI _"Algadur I" _"+2 axe damage/+3 hammer damage/+10 max hitpoints for Algadur" attacks/battleaxe.png (
            is_shared=yes
            required_companions=Algadur
        )}
        {ADD_FORGE_UPGRADE_TO_LIST algadurII _"Algadur II" _"+2 axe damage/+3 hammer damage/+10% resistances for Algadur" "attacks/battleaxe.png~BLIT(icons/overlay_II.png)" (
            is_shared=yes
            required_upgrades=algadurI
            required_bosses=ares
            required_companions=Algadur
        )}
        {ADD_FORGE_UPGRADE_TO_LIST algadurIII _"Algadur III" _"+3 axe damage/+4 hammer damage/+10 max hitpoints for Algadur" "attacks/battleaxe.png~BLIT(icons/overlay_III.png)" (
            is_shared=yes
            required_upgrades=algadurII
            required_bosses=scylla
            required_companions=Algadur
        )}
        {ADD_FORGE_UPGRADE_TO_LIST algadur_tough _"Tough Dwarf" _"knockback resistance 1/+8 max hitpoints for Algadur" "icons/cuirass_muscled.png" (
            is_shared=yes
            required_upgrades=algadurI
            required_bosses=donovan
            required_companions=Algadur
        )}
        {ADD_FORGE_UPGRADE_TO_LIST algadur_toughII _"Tough Dwarf II" _"regenerates +2/+10 max hitpoints for Algadur" "icons/regeneration.png~BLIT(icons/overlay_II.png)" (
            is_shared=yes
            required_upgrades=algadur_tough
            required_bosses=duo
            required_companions=Algadur
        )}
        {ADD_FORGE_UPGRADE_TO_LIST algadur_toughIII _"Tough Dwarf III" _"knockback resistance 2/regenerates +3/+10 max hitpoints for Algadur" "icons/cuirass_muscled.png~BLIT(icons/overlay_III.png)" (
            is_shared=yes
            required_upgrades=algadur_toughII
            required_bosses=grandseer
            required_companions=Algadur
        )}

        {ADD_FORGE_UPGRADE_TO_LIST algadur_leap _"Algadur Leap" _"Algadur can leap every 3 turns" icons/boots_elven.png (
            is_shared=yes
            required_upgrades=algadurI
            required_bosses=donovan
            required_companions=Algadur
        )}
        {ADD_FORGE_UPGRADE_TO_LIST algadur_frenzy _"Berserker Frenzy" _"Algadur gains the 'combo' special on his attacks
    (can attack again after killing an enemy)
    (only works once per turn)" "attacks/frenzy.png" (
            is_shared=yes
            required_upgrades=algadurIII
            required_bosses=duo
            required_companions=Algadur
        )}

        {ADD_FORGE_UPGRADE_TO_LIST elizabethI _"Elizabeth I" _"+2 damage/+5 hitpoints/+10% magical resistances for Elizabeth" attacks/staff-ruby.png (
            is_shared=yes
            required_companions=Elizabeth
        )}
        {ADD_FORGE_UPGRADE_TO_LIST elizabethII _"Elizabeth II" _"flame blast applies burn 2/+5 hitpoints/+10% magical resistances for Elizabeth" "attacks/staff-ruby.png~BLIT(icons/overlay_II.png)" (
            is_shared=yes
            required_upgrades=elizabethI
            required_companions=Elizabeth
        )}

        {ADD_FORGE_UPGRADE_TO_LIST elizabethIII _"Elizabeth III" _"+2 damage/+10 hitpoints for Elizabeth
        Flame Blast range increased from 4 to 5" "attacks/staff-ruby.png~BLIT(icons/overlay_III.png)" (
            is_shared=yes
            required_upgrades=elizabethII
            required_bosses=grandseer
            required_companions=Elizabeth
        )}

        {ADD_FORGE_UPGRADE_TO_LIST elizabethIV _"Elizabeth IV" _"+1 teleport distance/+4 flame blast damage/+10 hitpoints for Elizabeth" "attacks/staff-ruby.png~BLIT(icons/overlay_IV.png)" (
            is_shared=yes
            required_upgrades=elizabethIII
            required_bosses=orc_overlord
            required_companions=Elizabeth
        )}

        {ADD_FORGE_UPGRADE_TO_LIST elizabeth_summoner _"Elizabeth the Summoner" _"Elizabeth now instantly summons 2 allied fire guardians whenever entering a depth.
    (instant fire guardians do not count towards the summon limit)
    fire guardian summon cooldown reduced from 5 to 4 turns
    fire guardian summon limit increased from 2 to 3" "icons/fireguardian.png" (
            is_shared=yes
            required_upgrades=elizabethI
            required_companions=Elizabeth
        )}

        {ADD_FORGE_UPGRADE_TO_LIST elizabeth_summonerII _"Elizabeth the Summoner II" _"Elizabeth now instantly summons 3 allied fire guardians whenever entering a depth instead of 2.
    (instant fire guardians do not count towards the summon limit)
    fire guardian summon cooldown reduced from 4 to 3 turns
    fire guardian summon limit increased from 3 to 4" "icons/fireguardian.png~BLIT(icons/overlay_II.png)" (
            is_shared=yes
            required_upgrades=elizabeth_summoner
            required_bosses=reaper
            required_companions=Elizabeth
        )}

        {ADD_FORGE_UPGRADE_TO_LIST elizabeth_summonerIII _"Elizabeth the Summoner III" _"Elizabeth now instantly summons 4 allied fire guardians whenever entering a depth instead of 3.
    (instant fire guardians do not count towards the summon limit)
    fire guardian summon cooldown reduced from 3 to 2 turns
    fire guardian summon limit increased from 4 to 5" "icons/fireguardian.png~BLIT(icons/overlay_III.png)" (
            is_shared=yes
            required_upgrades=elizabeth_summonerII
            required_bosses=grandseer
            required_companions=Elizabeth
        )}

        {SPARTAN_TRUE_ENDING_COMPANION_UPGRADES}

        {ADD_FORGE_UPGRADE_TO_LIST companion_recovery _"Quick recovery I" _"the cooldown for companions after getting wounded
        is now only only 2 depths instead of 3." icons/companionrecovery.png (
            is_shared=yes
            required_companions=any
        )}
        {ADD_FORGE_UPGRADE_TO_LIST companion_recoveryII _"Quick recovery II" _"the companions' cooldown is now only 1 depth." "icons/companionrecoveryII.png~BLIT(icons/overlay_II.png)" (
            is_shared=yes
            required_upgrades=companion_recovery
            required_companions=any
        )}
        {ADD_FORGE_UPGRADE_TO_LIST armorI _"Improved Armor" _"+10 max hp." icons/breastplate.png ()}
        {ADD_FORGE_UPGRADE_TO_LIST armorII _"Improved Armor II" _"+10 max hp." "icons/breastplate.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=armorI
            required_bosses=spiderqueen
        )}
        {ADD_FORGE_UPGRADE_TO_LIST armorIII _"Improved Armor III" _"+10 max hp." "icons/breastplate.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=armorII
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST armorIV _"Improved Armor IV" _"+10 max hp." "icons/breastplate.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=armorIII
            required_bosses=donovan
        )}
        {ADD_FORGE_UPGRADE_TO_LIST armorV _"Improved Armor V" _"+10 max hp." "icons/breastplate.png~BLIT(icons/overlay_V.png)" (
            required_upgrades=armorIV
            required_bosses=duo
        )}
        {ADD_FORGE_UPGRADE_TO_LIST armorVI _"Improved Armor VI" _"+10 max hp." "icons/breastplate.png~BLIT(icons/overlay_VI.png)" (
            required_upgrades=armorV
            required_bosses=grandseer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST armorVII _"Improved Armor VII" _"+10 max hp." "icons/breastplate.png~BLIT(icons/overlay_VII.png)" (
            required_upgrades=armorVI
            required_bosses=orc_overlord
        )}
        {ADD_FORGE_UPGRADE_TO_LIST regeneration _"Regeneration" _"you are healed by 2 hp every turn (also slows poison)." icons/regeneration.png (
            required_upgrades=armorIV
            required_bosses=donovan#same as armor IV
        )}
        {ADD_FORGE_UPGRADE_TO_LIST regenerationII _"Regeneration II" _"you are healed by 4 hp every turn instead of 2." "icons/regeneration.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=regeneration
            required_bosses=orc_overlord#same as armor VII
        )}
        {ADD_FORGE_UPGRADE_TO_LIST firmstance _"Firm Stance" _"gain the 'knockback resistance 1' ability" icons/cuirass_muscled.png (
            required_upgrades=armorI
        )}
        {ADD_FORGE_UPGRADE_TO_LIST firmstanceII _"Firm Stance II" _"gain the 'knockback resistance 2' ability
   instead of knockback resist 1" "icons/cuirass_muscled.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=firmstance
            required_bosses=ares
        )}

        #Sorcerer class gets a nerfed version of the armor upgrades, getting fewer upgrades, upgrades appear later, and no access to Regeneration/Firm Stance

        {ADD_FORGE_UPGRADE_TO_LIST sorcerer_robeI _"Sturdy Robe" _"+10 max hp." icons/cloak_leather_brown.png (
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST sorcerer_robeII _"Sturdy Robe II" _"+10 max hp." "icons/cloak_leather_brown.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=sorcerer_robeI
            required_bosses=archmage
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST sorcerer_robeIII _"Sturdy Robe III" _"+10 max hp." "icons/cloak_leather_brown.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=sorcerer_robeII
            required_bosses=donovan
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST sorcerer_robeIV _"Sturdy Robe IV" _"+10 max hp." "icons/cloak_leather_brown.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=sorcerer_robeIII
            required_bosses=grandseer
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST healpotionI _"Healing Potion" _"You can recover 10 hitpoints via a rightclick menu on the hero.
   Or heal an adjacent ally by 10 hitpoints via rightclick menu
   this also cures poison/burn
   (Only usable once per depth.)" icons/potion_red_small.png (
        )}
        {ADD_FORGE_UPGRADE_TO_LIST healpotionII _"Healing Potion II" _"The healing potion recovers 15 hitpoints instead of 10." "icons/potion_red_medium.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=healpotionI
        )}
        {ADD_FORGE_UPGRADE_TO_LIST healpotionIII _"Healing Potion III" _"The healing potion recovers 22 hitpoints instead of 15." "icons/healpotionIII.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=healpotionII
            required_bosses=spiderqueen
        )}
        {ADD_FORGE_UPGRADE_TO_LIST healpotionIV _"Healing Potion IV" _"The healing potion recovers 30 hitpoints instead of 22." "icons/healpotionIV.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=healpotionIII
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST healpotionV _"Healing Potion V" _"The healing potion recovers 40 hitpoints instead of 30." "icons/healpotionIV.png~BLIT(icons/overlay_V.png)" (
            required_upgrades=healpotionIV
            required_bosses=scylla
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST healpotionenergy _"Invigorating Healing" _"Drinking a healing potion also restores 50%
   of your maximum energy.
   (if used on an AI-controlled ally, the energy bonus 
   is replaced with +1 MP for 1 turn instead)
   (healing another player grants energy to them as usual)" icons/healpotionenergy.png (
            required_upgrades=healpotionI
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST healpotionenergyII _"Invigorating Healing II" _"Drinking a healing potion restores 80%
   of your maximum energy
   and gives +50% damage until the end of the healed unit's turn.
   (if used on an AI-controlled ally, the energy bonus 
   is replaced with +1 MP for 1 turn instead)
   (healing another player grants energy to them as usual)" "icons/healpotionenergy.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=healpotionenergy
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST healpotion_bag _"Potion Bag" _"Unused potions now carry over into later depths
   You can carry up to 2 potions at a time
   (you still get only 1 potion per depth)" icons/healpotionbag.png (
            required_upgrades=healpotionI
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST healpotion_bagII _"Potion Bag II" _"You can now carry up to 3 potions." "icons/healpotionbag.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=healpotion_bag
            required_bosses=duo
        )}
        {ADD_FORGE_UPGRADE_TO_LIST healpotion_production _"Master Alchemist" _"Gain 2 healing potions per depth instead of 1" "icons/healpotionIV.png" (
            required_upgrades=healpotion_bagII
            required_bosses=grandseer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST phoenixamulet _"Phoenix Amulet" _"Instead of dying, you recover 10 hitpoints
   deal 10 fire damage to adjacent enemies,
   and slow all enemies on the map
   The effect has a cooldown of 3 depths." icons/phoenix_amulet.png (
            required_upgrades=healpotionI
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST phoenixamuletII _"Phoenix Amulet II" _"Reviving now heals the same amount as the healing potion
   and potion upgrades like Invigorating Healing
   now also trigger when revived" "icons/phoenix_amulet.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=phoenixamulet,healpotionII
        )}
        {ADD_FORGE_UPGRADE_TO_LIST amuletcharge _"Amulet Charge" _"the phoenix amulet cooldown is reduced from 3 depths to 2." icons/phoenix_amulet.png (
            required_upgrades=phoenixamulet
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST amuletchargeII _"Amulet Charge II" _"the phoenix amulet cooldown is reduced from 2 depths to 1." "icons/phoenix_amulet.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=amuletcharge
            required_bosses=reaper
        )}
        {ADD_FORGE_UPGRADE_TO_LIST impale _"Spear Impale" _"killing an enemy with spear damages the enemy behind the target." attacks/spear.png (
            required_weapon=spear#only classes with this weapon can get this upgrade
        )}
        {ADD_FORGE_UPGRADE_TO_LIST impaleII _"Spear Impale II" _"the target will deal 33% less damage for a turn after being struck with the spear." "attacks/spear.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=impale
        )}
        {ADD_FORGE_UPGRADE_TO_LIST impaleIII _"Spear Impale III" _"If there isn't an enemy behind the killed target, the enemy behind you gets attacked instead." "attacks/spear.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=impaleII
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST speardmg _"Spear Mastery" _"+5 melee spear damage" "attacks/spear-ares.png" (
            required_upgrades=impale
            required_bosses=donovan
        )}
        {ADD_FORGE_UPGRADE_TO_LIST skill_spear _"Precise Stab" _"New Skill: +10 damage on melee spear
   until the end of your turn, costs 50 energy
   (skills can be used via rightclick menu on the hero)" attacks/spear-precise-stab.png (
            required_upgrades=impale
            required_bosses=spiderqueen
        )}
        {ADD_FORGE_UPGRADE_TO_LIST precisestabII _"Precise Stab II" _"Precise Stab gives +15 damage instead of +10" "attacks/spear-precise-stab.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=skill_spear
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST precisestabIII _"Precise Stab III" _"Precise Stab gives +20 damage instead of +15" "attacks/spear-precise-stab.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=precisestabII
            required_bosses=duo
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST spear_counter _"Defensive Formation" _"Skipping your turn gives you counterattack on spear until the start of your next turn" "attacks/spear.png" (
            required_upgrades=patience,swordcounterattack
            required_weapon=spear#only classes with this weapon can get this upgrade. only necessary for first upgrades in a branch
        )}
        {ADD_FORGE_UPGRADE_TO_LIST swordhitandrun _"Hit and Run" _"attacking with the short sword now lets you move 1 tile after attacking." attacks/shortsword-lightblue-aura.png (
            required_weapon=sword#only classes with this weapon can get this upgrade. only necessary for first upgrades in a branch
        )}
        {ADD_FORGE_UPGRADE_TO_LIST swordcombo _"Sword Combo" _"killing an enemy with shortsword lets you attack again with any weapon once per turn
   (does not apply to kills done by Counterattack)" "attacks/shortsword-red-aura.png" (
            required_upgrades=swordhitandrun
            required_bosses=spiderqueen
        )}
        {ADD_FORGE_UPGRADE_TO_LIST swordcomboII _"Sword Combo II" _"Sword Combo can now be triggered twice per turn." "attacks/shortsword-red-aura.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=swordcombo
            required_bosses=donovan
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST swordlunge _"Sword Lunge" _"the shortsword deals 5 more damage right after leaping.
   (the bonus is 7 if you have the artifacts)
   (does not stack if you leap multiple times in one turn)" "attacks/shortsword-yellow-aura.png" (
            required_upgrades=swordhitandrun
        )}
        {ADD_FORGE_UPGRADE_TO_LIST swordcounterattack _"Counterattack" _"the shortsword can now be used in defense." attacks/sword-human-short.png (
            required_weapon=sword#only classes with this weapon can get this upgrade. only necessary for first upgrades in a branch
        )}

        #Sorcerer-exclusive staff upgrades, currently mostly based on shortsword upgrades but intentionally without lunge/combo since this is Sorcerer's only melee attack, and counterattack is harder to get

        {ADD_FORGE_UPGRADE_TO_LIST staffhitandrun _"Hit and Run" _"attacking with the staff now lets you move 1 tile after attacking." attacks/staff-magic.png (
            required_weapon=staff#only classes with this weapon can get this upgrade. only necessary for first upgrades in a branch
            required_classes=sorcerer
        )}

        #commented out, since it no longer fit my vision for the Sorcerer class (and it was weird that sorcerer was as good at counterattacking as the hoplite)

        #{ADD_FORGE_UPGRADE_TO_LIST staffcounterattack _"Counterattack" _"the staff can now be used in defense." attacks/staff-magic.png (
        #    required_upgrades=staffhitandrun
        #    required_bosses=spiderqueen
        #    required_classes=sorcerer
        #)}

        {ADD_FORGE_UPGRADE_TO_LIST staff_energy _"Energy Siphon" _"hitting an enemy with the staff gives 5 energy per enemy level
        (only works in offense)" attacks/staff-elven.png (
            required_weapon=staff#only classes with this weapon can get this upgrade. only necessary for first upgrades in a branch
            required_classes=sorcerer
        )}

        {ADD_FORGE_UPGRADE_TO_LIST staff_energyII _"Energy Siphon II" _"hitting an enemy with the staff gives 10 energy per enemy level
        (only works in offense)" "attacks/staff-elven.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=staff_energy
            required_bosses=archmage
            required_classes=sorcerer
        )}

        {ADD_FORGE_UPGRADE_TO_LIST skill_staff_enchantment _"Staff Enchantments" _"New Skills with effects until the end of your turn: 
        <span color='#ffff99'>Smiting Staff</span>: +5 damage on staff, becomes arcane type, 5 turn cooldown
        <span color='#ffff99'>Burning Bash</span>: staff applies burn, becomes fire type, 5 turn cooldown 
        burning enemies take 2 damage per turn until killed        
   (skills can be used via rightclick menu on the hero)" attacks/staff-enchant-fire.png (
            required_weapon=staff#only classes with this weapon can get this upgrade. only necessary for first upgrades in a branch
            required_classes=sorcerer
        )}

        {ADD_FORGE_UPGRADE_TO_LIST staff_enchantmentII _"Staff Enchantments II" _"New Skill: <span color='#ffff99'>Freezing Touch</span>: staff applies slow, becomes cold type
    6 turn cooldown 
    Smiting Staff cooldown reduced by 1
    Burning Bash cooldown reduced by 1" "attacks/staff-enchant-cold.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=skill_staff_enchantment
            required_bosses=spiderqueen
            required_classes=sorcerer
        )}

        {ADD_FORGE_UPGRADE_TO_LIST staff_enchantmentIII _"Staff Enchantments III" _"Smiting Staff gains 'holy 5' special
    (deals +5 damage to undead/demons)
    Burning Bash deals 3 burn damage per turn
    Freezing Touch cooldown reduced by 1" "attacks/staff-enchant-arcane.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=staff_enchantmentII
            required_bosses=archmage
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST staff_enchantmentIV _"Staff Enchantments IV" _"Smiting Staff gives +7 damage instead of +5
    Burning Bash deals 4 burn damage per turn
    Smiting Staff cooldown reduced by 1
    Freezing Touch cooldown reduced by 1" "attacks/staff-enchant-fire.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=staff_enchantmentIII
            required_bosses=ares
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST staff_enchantmentV _"Staff Enchantments V" _"Smiting Staff gains 'holy 10' special instead of holy 5
    (deals +10 damage to undead/demons)
    Burning Bash deals 5 burn damage per turn
    Smiting Staff cooldown reduced by 1
    Freezing Touch cooldown reduced by 1" "attacks/staff-enchant-arcane.png~BLIT(icons/overlay_V.png)" (
            required_upgrades=staff_enchantmentIV
            required_bosses=scylla
            required_classes=sorcerer
        )}
        #putting a holy damage upgrade right before the underworld biome, since all the enemies are undead
        {ADD_FORGE_UPGRADE_TO_LIST staff_enchantmentVI _"Staff Enchantments VI" _"Smiting Staff gains 'holy 15' special instead of holy 10
    (deals +15 damage to undead/demons)
    Burning Bash deals 6 burn damage per turn
    Freezing Touch gains the 'sweeping slow' special
    (slows enemies that are adjacent to both you and the target)
    Burning Bash cooldown reduced by 1" "attacks/staff-enchant-cold.png~BLIT(icons/overlay_VI.png)" (
            required_upgrades=staff_enchantmentV
            required_bosses=duo
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST staff_enchantmentVII _"Staff Enchantments VII" _"Smiting Staff gives +12 damage instead of +7
    Burning Bash deals 7 burn damage per turn
    Freezing Touch gives you +30% fire resistance until the start of your next turn" "attacks/staff-enchant-arcane.png~BLIT(icons/overlay_VII.png)" (
            required_upgrades=staff_enchantmentVI
            required_bosses=grandseer
            required_classes=sorcerer
        )}

        #Sorcerer-exclusive skills:

        {ADD_FORGE_UPGRADE_TO_LIST skill_ringfrost _"Ring of Frost" _"New Skill: deal 10 cold damage to enemies in a 2-tile radius,
        (but NOT adjacent enemies)
        ends your turn, costs 50 energy
   (skills can be used via rightclick menu on the hero)" attacks/iceball.png (
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST ringfrostII _"Ring of Frost II" _"Ring of Frost now deals 15 damage" "attacks/iceball.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=skill_ringfrost
            required_bosses=archmage
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST ringfrostIII _"Ring of Frost III" _"Ring of Frost now deals 20 damage" "attacks/iceball.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=ringfrostII
            required_bosses=donovan
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST ringfrostIV _"Ring of Frost IV" _"Ring of Frost now deals 25 damage" "attacks/iceball.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=ringfrostIII
            required_bosses=duo
            required_classes=sorcerer
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST skill_fireguardian _"Summon Fire Guardian" _"New Skill: summon an allied Fire Guardian
   costs 50 energy
   (skills can be used via rightclick menu on the hero)" icons/fireguardian.png (
            required_classes=sorcerer
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST fireguardianII _"Fire Guardian II" _"Summoned Fire Guardians have +5 hp" "icons/fireguardian.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=skill_fireguardian
            required_bosses=archmage
            required_classes=sorcerer
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST fireguardianIII _"Fire Guardian III" _"Summoned Fire Guardians have +2 damage and +5 hp" "icons/fireguardian.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=fireguardianII
            required_bosses=donovan
            required_classes=sorcerer
        )}

        #Sorcerer-exclusive targeted spells:

        {ADD_FORGE_UPGRADE_TO_LIST spell_lightning _"Lightning Bolt" _"New Targeted Spell: deal 10 fire damage 
        to one enemy anywhere on the map,
        ends your turn, costs 75 energy
    (targeted spells can be used via rightclick menu on the map)" attacks/lightning.png (
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST lightningII _"Lightning Bolt II" _"Lightning Bolt now deals 15 damage" "attacks/lightning.png~BLIT(icons/overlay_II.png)"(
            required_upgrades=spell_lightning
            required_bosses=spiderqueen
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST lightningIII _"Lightning Bolt III" _"Lightning Bolt now deals 20 damage" "attacks/lightning.png~BLIT(icons/overlay_III.png)"(
            required_upgrades=lightningII
            required_bosses=ares
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST lightningIV _"Lightning Bolt IV" _"Lightning Bolt now deals 25 damage" "attacks/lightning.png~BLIT(icons/overlay_IV.png)"(
            required_upgrades=lightningIII
            required_bosses=scylla
            required_classes=sorcerer
        )}
        #COMMENTED OUT FOR NOW SINCE THE UPGRADE WAS TOO OP AGAINST BOSSES. MAYBE RE-ADD LATER WHEN I DECIDE HOW TO NERF IT A BIT
        #{ADD_FORGE_UPGRADE_TO_LIST lightning_slow _"Electric Shock" _"Lightning Bolt now slows the target" "attacks/lightning.png"(
        #    required_upgrades=lightningII
        #    required_bosses=archmage
        #    required_classes=sorcerer
        #)}
        {ADD_FORGE_UPGRADE_TO_LIST lightning_chain _"Chain Lightning" _"Lightning Bolt now also hits a random enemy adjacent to the target
        each bounce deals 50% of the previous damage
        this effect keeps chaining as long as the chain attack 
        would deal at least 5 damage" "attacks/lightning.png"(
            required_upgrades=lightningII
            required_bosses=donovan
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST lightning_chainII _"Chain Lightning II" _"Chain lightning now keeps 66% of the damage with each bounce instead of 50%" "attacks/lightning.png~BLIT(icons/overlay_II.png)"(
            required_upgrades=lightning_chain
            required_bosses=duo
            required_classes=sorcerer
        )}

        {ADD_FORGE_UPGRADE_TO_LIST spell_sandstorm _"Sandstorm" _"New Targeted Spell: summon a Dust Devil ally
        on an empty tile in a 3-tile radius
        If you already have a summoned Dust Devil, it is destroyed before the new one is spawned
        costs 75 energy
    (targeted spells can be used via rightclick menu on the map)" attacks/twister.png (
            required_classes=sorcerer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST sandstormII _"Sandstorm II" _"Summoned Dust Devil gains +10 hitpoints
        Sandstorm spell's range is increased from 3 to 4" "attacks/twister.png~BLIT(icons/overlay_II.png)" (
            required_classes=sorcerer
            required_upgrades=spell_sandstorm
            required_bosses=spiderqueen
        )}
        {ADD_FORGE_UPGRADE_TO_LIST sandstormIII _"Sandstorm III" _"Sandstorm spell now summons a Sand Tornado instead of Dust Devil
        Sandstorm spell's range is increased from 4 to 5
        (unaffected by the HP bonus from Sandstorm II 
        since the Sand Tornado still has more HP without it)" "attacks/twister.png~BLIT(icons/overlay_III.png)" (
            required_classes=sorcerer
            required_upgrades=sandstormII
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST sandstormIV _"Sandstorm IV" _"Summoned Sand Tornado gains +10 hitpoints" "attacks/twister.png~BLIT(icons/overlay_IV.png)" (
            required_classes=sorcerer
            required_upgrades=sandstormIII
            required_bosses=scylla
        )}

        {ADD_FORGE_UPGRADE_TO_LIST sandstorm_damage _"Deadly Storm" _"Summoned Sand Tornado's pull attack now deals 5 damage instead of 0." "attacks/twister.png" (
            required_classes=sorcerer
            required_upgrades=sandstormIII
            required_bosses=duo
        )}

        {ADD_FORGE_UPGRADE_TO_LIST spell_curse_fear _"Curse of Fear" _"New Targeted Spell: target enemy gains the 'terrified' ability
    (runs away when near player or allies)
    Effect lasts 1 turn
    spell has 2 range
    every 3 turns you gain 1 charge for this spell
    spell costs 1 charge (2 for bosses)
    you can hold up to 2 charges max
    (targeted spells can be used via rightclick menu on the map)" icons/horror-eerie-1.png (
            required_classes=sorcerer
        )}

        {ADD_FORGE_UPGRADE_TO_LIST curse_fearII _"Curse of Fear II" _"Curse of fear range is increased from 2 to 3 
        and can hold 3 charges instead of 2" "icons/horror-eerie-2.png~BLIT(icons/overlay_II.png)" (
            required_classes=sorcerer
            required_upgrades=spell_curse_fear
            required_bosses=spiderqueen
        )}

        {ADD_FORGE_UPGRADE_TO_LIST curse_fearIII _"Curse of Fear III" _"Curse of fear range is increased from 3 to 4 
        gain 1 charge every 2 turns instead of 3
        and can hold 4 charges instead of 3" "icons/horror-eerie-3.png~BLIT(icons/overlay_III.png)" (
            required_classes=sorcerer
            required_upgrades=curse_fearII
            required_bosses=ares
        )}

        {ADD_FORGE_UPGRADE_TO_LIST curse_fearIV _"Curse of Fear IV" _"Gain 1 charge every turn instead of every 2 turns" "icons/horror-eerie-3.png~BLIT(icons/overlay_IV.png)" (
            required_classes=sorcerer
            required_upgrades=curse_fearIII
            required_bosses=scylla
        )}

        {ADD_FORGE_UPGRADE_TO_LIST curse_fearV _"Curse of Fear V" _"Can hold 6 charges instead of 4" "icons/horror-eerie-3.png~BLIT(icons/overlay_V.png)" (
            required_classes=sorcerer
            required_upgrades=curse_fearIV
            required_bosses=reaper
        )}

        {ADD_FORGE_UPGRADE_TO_LIST axe _"Axe" _"new powerful melee attack (14 damage)
   but which can only be used when you start your turn next to the target." attacks/axe.png ()}
        {ADD_FORGE_UPGRADE_TO_LIST axeII _"Axe II" _"axe deals 3 more damage." "attacks/axe.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=axe
        )}
        {ADD_FORGE_UPGRADE_TO_LIST axeIII _"Axe III" _"axe deals 4 more damage." "attacks/battleaxe.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=axeII
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST axeIV _"Axe IV" _"axe deals 4 more damage." "attacks/battleaxe.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=axeIII
            required_bosses=donovan
        )}
        {ADD_FORGE_UPGRADE_TO_LIST axeV _"Axe V" _"axe deals 5 more damage." "attacks/battleaxe.png~BLIT(icons/overlay_V.png)" (
            required_upgrades=axeIV
            required_bosses=duo
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST skill_execution _"Execution" _"New Skill: axe gains damage equal to 20% of your current energy
   until the end of the turn
   costs all of your energy, requires at least 25 energy
   (skills can be used via rightclick menu on the hero)" attacks/frenzy.png (
            required_upgrades=axeII
            required_bosses=spiderqueen
        )}
        {ADD_FORGE_UPGRADE_TO_LIST axe_cleave _"Axe Cleave" _"When you hit an enemy with an axe
   deal 50% of the base damage to enemies that are adjacent to both you and the target" attacks/axe-cleave.png (
            required_upgrades=axe
        )}
        {ADD_FORGE_UPGRADE_TO_LIST axe_spin _"Axe Spin" _"Axe Cleave now hits all enemies adjacent to you" "attacks/axe-cleave.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=axe_cleave
            required_bosses=ares
        )}
        #works with direct kills and works with cleave properly too
        {ADD_FORGE_UPGRADE_TO_LIST axe_overkill _"Overkill" _"when killing an enemy with the axe
   excess damage is converted into energy 
   (for example, killing a 5/10hp enemy with a
   17-damage axe attack gives you 12 energy)
   (Works with Axe Cleave kills too)" attacks/axe-yellow-aura.png (
            required_upgrades=axe
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST mightybash _"Mighty Bash" _"The shield now knocks back further
   and can also push an enemy standing behind the target. 
   Additionally, bashing enemies into walls deals more damage 
   if the enemy is already close to a wall" icons/protect-red-2.png (
            required_weapon=shield#only classes with this weapon can get this upgrade. only necessary for first upgrades in a branch
        )}
        {ADD_FORGE_UPGRADE_TO_LIST herculeanbash _"Herculean Bash" _"The shield now knocks back even further
   (and bashing enemies into walls deals even more damage 
   if the enemy is already close to a wall)" "icons/protect-red-3.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=mightybash
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST spikedshield _"Spiked Shield" _"now the shield bash deals 5 damage on hit." icons/shield-spiked.png (
            required_upgrades=mightybash
        )}
        {ADD_FORGE_UPGRADE_TO_LIST shieldup _"Shield Up" _"your resistances increase by 33% for a turn after shield bashing.
   (up to a max. of 60%)" icons/protect-sky-1.png (
            required_weapon=shield#only classes with this weapon can get this upgrade. only necessary for first upgrades in a branch
        )}
        {ADD_FORGE_UPGRADE_TO_LIST shieldupII _"Shield Up II" _"the resistance bonus is now 50% instead of 33%.
   (up to a max. of 70%)" "icons/protect-sky-2.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=shieldup
            required_bosses=archmage
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST shieldwall _"Shield Wall" _"the shield up effect is also activated when you skip your turn." icons/protect-sky-3.png (
            required_upgrades=shieldup,patience
            required_weapon=shield#only classes with this weapon can get this upgrade. only necessary for first upgrades in a branch
        )}
        {ADD_FORGE_UPGRADE_TO_LIST deployshield _"Deploy Shield" _"You can rightclick on an adjacent empty tile to deploy a Shield unit
   the shield acts as a temporary barricade, and disppears on next turn
   this has a 3-turn cooldown" "icons/protect-orange-1.png" (
            required_upgrades=shieldup
            required_bosses=spiderqueen
        )}
        {ADD_FORGE_UPGRADE_TO_LIST deployshieldII _"Deploy Shield II" _"Deployed shield has 15 hitpoints
   and adjacent players/allies gain 10% resistances (up to 40%)" "icons/protect-orange-2.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=deployshield
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST deployshieldIII _"Deploy Shield III" _"Deployed shield has 20 hitpoints
   and adjacent players/allies gain 20% resistances (up to 60%)" "icons/protect-orange-3.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=deployshieldII
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST deployshieldIV _"Deploy Shield IV" _"Deployed shield has 25 hitpoints
   Cooldown is reduced from 3 to 2 turns" "icons/protect-orange-3.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=deployshieldIII
            required_bosses=donovan
        )}
        {ADD_FORGE_UPGRADE_TO_LIST deployshieldV _"Deploy Shield V" _"Deployed shield has 30 hitpoints
   and adjacent players/allies gain 30% resistances (up to 70%)" "icons/protect-orange-3.png~BLIT(icons/overlay_V.png)" (
            required_upgrades=deployshieldIV
            required_bosses=duo
        )}
        {ADD_FORGE_UPGRADE_TO_LIST sweepingbash _"Sweeping Bash" _"The shield can now knock back several enemies at once
   (knocks back enemies that are adjacent to both you and the target)" icons/protect-jade-2.png (
            required_weapon=shield#only classes with this weapon can get this upgrade. only necessary for first upgrades in a branch
        )}
        {ADD_FORGE_UPGRADE_TO_LIST spinningbash _"Spinning Bash" _"The shield now knocks back all adjacent enemies" "icons/protect-jade-3.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=sweepingbash
            required_bosses=spiderqueen
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST skill_chargedbash _"Charged Bash" _"New Skill: +2 to shield knockback
   until the end of your turn, costs 50 energy
   (skills can be used via rightclick menu on the hero)" icons/protect-royal-3.png (
            required_upgrades=mightybash,shieldup,sweepingbash
            require_only_one_upgrade=yes#any shield upgrade unlocks this one
        )}
        {ADD_FORGE_UPGRADE_TO_LIST chargedbashII _"Charged Bash II" _"Charged Bash now also gives +10 damage" "icons/protect-royal-3.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=skill_chargedbash
            required_bosses=donovan
        )}
        {ADD_FORGE_UPGRADE_TO_LIST chargedbashIII _"Charged Bash III" _"Charged Bash now gives +15 damage instead of +10" "icons/protect-royal-3.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=chargedbashII
            required_bosses=duo
        )}

        #used to be called Shortbow and had 3 range, but changed to 4 for now, since 3 range with 1-turn aim is honestly too weak (and previously you had to get the second bow upgrade to make the weapon viable, which gave both damage AND range)
        {ADD_FORGE_UPGRADE_TO_LIST bow _"Bow" _"new ranged attack (10 damage)
  with a 4-tile range but a 1-tile blindspot. 
  Aiming the bow ends your turn.
  Can't shoot invisible enemies." attacks/bow.png ()}
        {ADD_FORGE_UPGRADE_TO_LIST bowII _"Longbow" _"bow has 1 more range." "attacks/bow-elven.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=bow
        )}
        {ADD_FORGE_UPGRADE_TO_LIST bowIII _"Enchanted Bow" _"bow deals 5 more damage." "attacks/bow-elven-magic.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=bowII
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST bowIV _"Bow Mastery" _"Shoot bow on the same turn as aiming
   (Quickdraw Mode is automatically enabled)
   New Skill: Overdraw Mode: +5 damage, return the bow to non-instant firing mode
   New Skill: Quickdraw Mode: shoow bow on the same turn as aiming again, removes damage buff from Overdraw Mode" "attacks/bow-elven-magic.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=bowIII
            required_bosses=donovan
        )}
        {ADD_FORGE_UPGRADE_TO_LIST bowV _"Bow Mastery II" _"bow deals 5 more damage.
    Overdraw mode gives +10 damage instead of +5" "attacks/bow-elven-magic.png~BLIT(icons/overlay_V.png)" (
            required_upgrades=bowIV
            required_bosses=orc_overlord
        )}
        {ADD_FORGE_UPGRADE_TO_LIST bow_eagle_eye _"Eagle Eye" _"bow has 1 more range and can hit invisible enemies." "attacks/gaze.png" (
            required_upgrades=bowII
            required_bosses=spiderqueen
        )}
        {ADD_FORGE_UPGRADE_TO_LIST bow_pointblank _"Point Blank Archery" _"bow no longer has a blindspot." "attacks/bow-short-reinforced.png" (
            required_upgrades=bowII
            required_bosses=spiderqueen
        )}
        {ADD_FORGE_UPGRADE_TO_LIST bow_knockback _"Heavy Arrow" _"bow now has 1-tile knockback." "attacks/spear-simple.png" (
            required_upgrades=bowII
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST bow_knockbackII _"Heavy Arrow II" _"bow now has 2-tile knockback." "attacks/spear-simple.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=bow_knockback
            required_bosses=duo
        )}
        {ADD_FORGE_UPGRADE_TO_LIST bow_burn _"Greek Fire Arrow" _"bow burns enemies
   burning enemies take 2 damage per turn until killed
   (this applies even to enemies in water)" "attacks/bow-elven-fire.png" (
            required_upgrades=bowII
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST bow_burnII _"Greek Fire Arrow II" _"Burn deals 4 damage per turn" "attacks/bow-elven-fire.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=bow_burn
            required_bosses=grandseer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST spearthrowrangeI _"Spear Throw I" _" Increased spear throw range by 1 tile." attacks/spear-thrown.png (
            required_weapon=spear2#only classes with this weapon can get this upgrade. only necessary for first upgrades in a branch
        )}
        {ADD_FORGE_UPGRADE_TO_LIST spearthrowrangeII _"Spear Throw II" _"Increased spear throw damage by 5
   and spear throw range by 1 tile." "attacks/spear-thrown.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=spearthrowrangeI
        )}
        {ADD_FORGE_UPGRADE_TO_LIST spearthrowrangeIII _"Spear Throw III" _"Increased spear throw range by 1 tile." "attacks/spear-thrown.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=spearthrowrangeII
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST spearthrowrangeIV _"Spear Throw IV" _"Increased spear throw range by 1 tile." "attacks/spear-thrown.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=spearthrowrangeIII
            required_bosses=donovan
        )}
        #from this point it's no longer really about range, but keeping the ids consistent for now
        {ADD_FORGE_UPGRADE_TO_LIST spearthrowrangeV _"Spear Throw V" _"Increased spear throw damage by 5" "attacks/spear-thrown.png~BLIT(icons/overlay_V.png)" (
            required_upgrades=spearthrowrangeIV
            required_bosses=duo
        )}

        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST spear_recall _"Recall" _"can recall your spear back to yourself
  via a rightclick menu on yourself or the spear. 
  This ends your turn" "icons/spear-recall.png" (
            required_upgrades=spearthrowrangeI
            required_bosses=spiderqueen
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST spear_follow _"Follow" _"can teleport to your spear
  via a rightclick menu on yourself or the spear. 
  Costs 50 energy and ends your turn" "icons/teleport.png" (
            required_upgrades=teleport
            required_bosses=archmage
            required_weapon=spear2#only classes with this weapon can get this upgrade. only necessary for first upgrades in a branch
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST spearthrowexplode _"Explosive Spear" _"New Skill: +10 damage until the end of the turn
   damages enemies adjacent to the target by 50% of the base damage
   Costs 75 energy
   (unlike direct hits, explosion damage does not slow enemies)
   (skills can be used via rightclick menu on the hero)" "attacks/fireball.png" (
            required_upgrades=spearthrowrangeI
            required_bosses=archmage
        )}

        {ADD_FORGE_UPGRADE_TO_LIST spearthrowexplodeII _"Explosive Spear II" _"Explosive Spear gives +15 damage instead of +10" "attacks/fireball.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=spearthrowexplode
            required_bosses=grandseer
        )}

        {ADD_FORGE_UPGRADE_TO_LIST wizardbeam _"Flame Blast" _"You gain an extra ranged attack along with spear throw,
   that is able hit multiple enemies at once. 
   (explained more in the 'Flame Blast' section of the information menu)" attacks/fire-blast.png (
            required_upgrades=spearthrowrangeI,bow
            require_only_one_upgrade=yes#you only need either bow or spear throw I to unlock flame blast
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST wizardbeamII _"Flame Blast II" _"Flame blast has longer reach." "attacks/fire-blast.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=wizardbeam
        )}
        {ADD_FORGE_UPGRADE_TO_LIST wizardbeamIII _"Flame Blast III" _"Flame blast deals 5 more damage
   and its cooldown is reduced by 1 turn." "attacks/fire-blast.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=wizardbeamII
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST wizardbeamIV _"Flame Blast Mastery" _"Flame blast deals 20 damage instead of 15
   and its range is increased from 4 to 5." "attacks/fire-blast.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=wizardbeamIII
            required_bosses=grandseer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST wizardbeam_burn _"Scorching Blast" _"Flame Blast burns enemies
   burning enemies take 2 damage per turn until killed
   (this applies even to enemies in water)" "attacks/fire-blast.png" (
            required_upgrades=wizardbeamIII
            required_bosses=donovan
        )}
        {ADD_FORGE_UPGRADE_TO_LIST energyI _"Energy I" _"Increased maximum energy (+25)" icons/boots_elven.png ()}
        {ADD_FORGE_UPGRADE_TO_LIST energyII _"Energy II" _"Increased maximum energy (+25)" "icons/boots_elven.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=energyI
        )}
        {ADD_FORGE_UPGRADE_TO_LIST energyIII _"Energy III" _"Increased maximum energy (+30)" "icons/boots_elven.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=energyII
            required_bosses=spiderqueen
        )}
        {ADD_FORGE_UPGRADE_TO_LIST energyIV _"Energy IV" _"Increased maximum energy (+30)" "icons/boots_elven.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=energyIII
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST energyV _"Energy V" _"Increased maximum energy (+40)" "icons/boots_elven.png~BLIT(icons/overlay_V.png)" (
            required_upgrades=energyIV
            required_bosses=scylla
        )}
        {ADD_FORGE_UPGRADE_TO_LIST energyVI _"Energy VI" _"Increased maximum energy (+50)" "icons/boots_elven.png~BLIT(icons/overlay_VI.png)" (
            required_upgrades=energyV
            required_bosses=grandseer
        )}
        {ADD_FORGE_UPGRADE_TO_LIST adrenaline _"Adrenaline Rush" _"If your hitpoints fall below half the maximum, regain 75% your maximum energy.
   Additionally, if you have Bloodlust III, you also become enraged. 
   The effect is only activated once per depth." "icons/adrenaline.png" (
            required_upgrades=energyI
        )}
        {ADD_FORGE_UPGRADE_TO_LIST adrenalineII _"Adrenaline Rush II" _"While your hitpoints are at/below 50%, recover 10% of energy each turn
   While your hitpoints are at/below 20%, recover 20% of energy each turn" "icons/adrenalineII.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=adrenaline
            required_bosses=archmage
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST teleport _"Teleport" _"Leap is replaced by short-ranged teleportation
   allowing you to move to the other side of walls." icons/teleport.png (
            required_upgrades=energyI
        )}
        {ADD_FORGE_UPGRADE_TO_LIST teleportII _"Teleport II" _"The teleport radius is increased from 2 hexes to 3." "icons/teleport.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=teleport
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST teleportIII _"Teleport III" _"The teleport radius is increased from 3 hexes to 4." "icons/teleport.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=teleportII
            required_bosses=duo
        )}
        {ADD_FORGE_UPGRADE_TO_LIST teleportaway _"Teleport Away" _"when you're attacked, you teleport away to a nearby location
   negating damage taken and slowing nearby enemies. 
   However, this drains 75 energy per 10 damage you would receive from the attack. 
   Can be disabled via rightclick menu" "icons/teleport.png" (
            required_upgrades=teleport
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST lantern _"Lantern" _"see invisible ghostly enemies in a 3-tile radius instead of 2-tile radius.
   see invisible enemies with 'ambush' ability in a 2-tile radius
   Your vision radius in fog/shroud is also increased by 1." icons/lantern.png (
            required_upgrades=energyI
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST lanternII _"Lantern II" _"see invisible ghostly enemies in a 4-tile radius instead of 3-tile radius.
   see invisible enemies with 'ambush' ability in a 3-tile radius
   Your vision radius in fog/shroud is also increased by 1." "icons/lantern.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=lantern
            required_bosses=scylla
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST bloodlust _"Bloodlust" _"Killing enemies gives 5 extra energy." icons/bloodlust.png ()}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST bloodlustII _"Bloodlust II" _"While you are below 50% hitpoints
   Whenever you kill a unit, you recover an amount of hitpoints equal to 
   twice the level of the target.
   (This cannot heal you past 50% hitpoints)" "icons/bloodlustII.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=bloodlust
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST bloodlustIII _"Bloodlust III" _"Killing 3 enemies in a row activates rage.
   While enraged, you deal 5 more damage with all attacks.
   (you can check your killstreak in the top of the interface)" "icons/bloodlustIII.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=bloodlustII
            required_bosses=spiderqueen
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST bloodlustIV _"Bloodlust IV" _"killing enemies gives you additional energy equal to double your killstreak
   (for example, killing the 7th enemy in a row, you gain 14 energy on top of the energy bonus from Bloodlust I)
   (energy bonus is capped at 15% of your max energy)" "icons/bloodlustIII.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=bloodlustIII
            required_bosses=archmage
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST persistent_wrath _"Persistent Wrath" _"if you have 6 or more killstreak
   then on your turn if you don't continue the killstreak
   instead of completely resetting killstreak/rage
   you keep your rage buff, and your killstreak is halved (rounded down)" "icons/bloodlustIII.png" (
            required_upgrades=bloodlustIII
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST ratsI _"Rat tamer" _"when entering a depth, spawn 3 allied AI-controlled giant rats
    at random coordinates to fight for you. 
    They are pretty good at distracting foes, as well as hunting down archers." icons/rats.png ()}
        {ADD_FORGE_UPGRADE_TO_LIST ratsII _"Rat trainer" _"the amount of rats spawned is increased from 3 to 5." "icons/rats.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=ratsI
        )}
        {ADD_FORGE_UPGRADE_TO_LIST ratsIII _"Rat master" _"the amount of rats spawned is increased from 5 to 7." "icons/rats.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=ratsII
            required_bosses=spiderqueen
        )}
        {ADD_FORGE_UPGRADE_TO_LIST ratsIV _"Rat army" _"the amount of rats spawned is increased from 7 to 9." "icons/rats.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=ratsIII
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST ratsV _"Rat overlord" _"the amount of rats spawned is increased from 9 to 11." "icons/rats.png~BLIT(icons/overlay_V.png)"(
            required_upgrades=ratsIV
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST rat_legion _"Rat legion" _"every 4 turns,
   a rat will spawn at a random location." "icons/rats.png~BLIT(icons/overlay_VI.png)" (
            required_upgrades=ratsV
            required_bosses=donovan
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST rat_power _"Frenzied rats" _"Rats gain +2 damage and +5 hitpoints." attacks/fangs-rodent.png (
            required_upgrades=ratsI
        )}
        {ADD_FORGE_UPGRADE_TO_LIST rat_powerII _"Colossal rats" _"Every 3rd rat spawned becomes a Colossal Rat
        Colossal Rats have +3 damage and +5 hitpoints." "attacks/fangs-rodent.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=rat_power
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST rat_powerIII _"Rodent Rage" _"Colossal Rats gain +2 damage and +5 hitpoints." "attacks/fangs-rodent.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=rat_powerII
            required_bosses=duo
        )}
        {ADD_FORGE_UPGRADE_TO_LIST rat_wellfed _"Well-fed rats" _"Every 2nd rat becomes a Colossal Rat instead of every 3rd" "attacks/fangs-rodent.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=rat_powerII
            required_bosses=scylla
        )}
        #TODO: maybe add a higher tier version of well-fed rats that makes all rats colossal (maybe post-depth 35 or even later? but might need to be careful when balancing so it doesn't trivialize the Galatea fight)
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST bear _"Cave Bear" _"at the start of each depth, spawn a mighty Cave Bear." "icons/bear.png" (
            required_upgrades=rat_power
            required_bosses=ares
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST bearII _"Cave Bear II" _"+10 bear hitpoints." "icons/bear.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=bear
            required_bosses=donovan
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST bearIII _"Cave Bear III" _"Bear has +3 fangs damage and +2 claw damage" "icons/bear.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=bearII
            required_bosses=scylla
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST bearIV _"Cave Bear IV" _"+10 bear hitpoints." "icons/bear.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=bearIII
            required_bosses=duo
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST bearV _"Cave Bear V" _"+10 bear hitpoints, bear regenerates 2hp per turn." "icons/bear.png~BLIT(icons/overlay_V.png)" (
            required_upgrades=bearIV
            required_bosses=grandseer
        )}
        #Ambush is removed for now due to ally sides now going before enemy sides
        #   #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        #   {ADD_FORGE_UPGRADE_TO_LIST ambush _"Ambush" _"Allies aren't targeted by enemies on the first turn of entering a depth." icons/cloak_leather_brown.png (
        #      is_shared=yes
        #   )}

        #TODO: add different versions of Shadow Clone for Sorcerer and other classes (still keep the Shadow Clone name, but with different effects)

        {ADD_FORGE_UPGRADE_TO_LIST shadowclone _"Shadow Clone" _"New Skill: summon an allied shadow clone of yourself
   Costs 100 energy, and has a cooldown of 2 depths.
   (While the clone lacks most of your abilities, it is still quite strong).
   (skills can be used via rightclick menu on the hero)" icons/shadowclone.png (
            required_upgrades=ratsI
            required_bosses=spiderqueen
            required_classes=hoplite
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST shadowcloneII _"Shadow Clone II" _"the clone gains +10 hitpoints, and can leap every 3 turns.
   The effect does not apply to existing clones." "icons/shadowclone.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=shadowclone
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST shadowcloneIII _"Shadow Clone III" _"the clone gains +5 hitpoints, 15% resistances
   and the impale special on its melee attack. 
   The effect does not apply to existing clones." "icons/shadowclone.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=shadowcloneII
            required_bosses=ares
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST shadowcloneIV _"Shadow Clone IV" _"the clone gains +10 hitpoints, and can leap every 2 turns
   The effect does not apply to existing clones." "icons/shadowclone.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=shadowcloneIII
            required_bosses=scylla
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST shadowcloneIIIb _"Spectral Spear" _"the clone deals 5 more damage." "attacks/blank-attack.png~BLIT(attacks/spear.png~CROP(5,5,49,49)~O(70%)~GS()~CS(-200,-40,-0),5,5)" (
            required_upgrades=shadowcloneII
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST shadowcloneIIb _"Cloning Proficiency" _"you can now summon a clone once per depth, instead of every 2 depths." icons/shadowclone.png (
            required_upgrades=shadowclone
        )}
        {ADD_FORGE_UPGRADE_TO_LIST summonedarcher _"Spirit Archer" _"New Skill: summon a Spirit Archer
   Costs 100 energy, can be used once per depth.
   (skills can be used via rightclick menu on the hero)" "attacks/blank-attack.png~BLIT(attacks/bow-elven.png~CROP(5,5,49,49)~O(70%)~GS()~CS(-200,-40,-0),5,5)" (
            required_upgrades=shadowcloneIIb
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST summonedarcherII _"Spirit Archer II" _"+5 max hitpoints for spirit archer
   bow range is increased by 1
   bow blindspot is removed
   The effect does not apply to existing archers." "attacks/blank-attack.png~BLIT(attacks/bow-elven.png~CROP(5,5,49,49)~O(70%)~GS()~CS(-200,-40,-0),5,5)~BLIT(icons/overlay_II.png)" (
            required_upgrades=summonedarcher
            required_bosses=archmage
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST summonedarcherIII _"Spirit Archer III" _"+5 bow damage for spirit archer
   +3 sword damage for spirit archer
   The effect does not apply to existing archers." "attacks/blank-attack.png~BLIT(attacks/bow-elven.png~CROP(5,5,49,49)~O(70%)~GS()~CS(-200,-40,-0),5,5)~BLIT(icons/overlay_III.png)" (
            required_upgrades=summonedarcherII
            required_bosses=ares
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST summonedarcherIV _"Spirit Archer IV" _"+5 max hitpoints for spirit archer
    spirit archer can leap every 3 turns
    bow range is increased by 1    
    The effect does not apply to existing archers." "attacks/blank-attack.png~BLIT(attacks/bow-elven.png~CROP(5,5,49,49)~O(70%)~GS()~CS(-200,-40,-0),5,5)~BLIT(icons/overlay_III.png)" (
            required_upgrades=summonedarcherIII
            required_bosses=scylla
        )}
        #not included in spartan_forge_effect_event since effect is triggered via a variable check instead of an immediate effect:
        {ADD_FORGE_UPGRADE_TO_LIST enthrall _"Enthrall" _"you may turn adjacent enemies (except bosses)
   to your side via a rightclick option on them
   this costs 75 energy per enemy level (35 if the enemy is lvl0) and ends your turn. 
   Enthralling enemies fully heals them and cures poison/burn." "attacks/gaze.png" (
            required_upgrades=ratsI
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST enthrallII _"Enthrall II" _"enthralled enemies now gain 5 more max hitpoints
   deal 2 more damage, and regenerate 2 hitpoints per turn 
   (includes existing thralls)." "attacks/gaze.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=enthrall
        )}
        {ADD_FORGE_UPGRADE_TO_LIST enthrallIII _"Enthrall III" _"enthralled enemies now gain 1 more movement and 5 more max hitpoints
   (includes existing thralls)." "attacks/gaze.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=enthrallII
            required_bosses=donovan
        )}
#commented out for now, enthrall builds already get an advantage in depth 31+ from the fact that powerful lvl3 enemies start to spawn, and they are enthrallable, so if I re-add this it might have to be even later than depth 40. when lvl3s are less rare so the stat bonuses become necessary again
#        {ADD_FORGE_UPGRADE_TO_LIST enthrallIV _"Enthrall IV" _"enthralled enemies now deal 3 more damage and gain 5 more max hitpoints
#   (includes existing thralls)." "attacks/gaze.png~BLIT(icons/overlay_IV.png)" (
#            required_upgrades=enthrallIII
#            required_bosses=grandseer
#        )}
        {ADD_FORGE_UPGRADE_TO_LIST enthrall_loyal _"Loyal Thrall" _"allows you to bring one thrall between depths
   (select a thrall via the rightclick menu to make it loyal
   you can only have one loyal thrall at a time.)

   New Skill: Auto-Loyal: if enabled, enthralled enemies instantly become loyal 
   if you are below the loyal thrall limit" "attacks/gaze.png" (
            required_upgrades=enthrall
        )}
        {ADD_FORGE_UPGRADE_TO_LIST enthrall_loyalII _"Loyal Thrall II" _"can have 2 loyal thralls at a time" "attacks/gaze.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=enthrall_loyal
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST enthrall_loyalIII _"Loyal Thrall III" _"can have 3 loyal thralls at a time" "attacks/gaze.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=enthrall_loyalII
            required_bosses=scylla
        )}
        {ADD_FORGE_UPGRADE_TO_LIST enthrall_range _"Enthrall Range" _"Can enthrall enemies in a 2-tile range instead of 1." "attacks/gaze.png" (
            required_upgrades=enthrall
            required_bosses=scylla
        )}
        {ADD_FORGE_UPGRADE_TO_LIST patience _"Patience" _"You can now end your turn without moving.
   Recover 10 energy each time you skip your turn 
   (end turn without moving or attacking)
   Your turn is also no longer skipped when slowed and not next to enemy" attacks/blank-attack.png ()}
        {ADD_FORGE_UPGRADE_TO_LIST footwork _"Footwork" _"no longer automatically end your turn
   when moving onto a tile that isn't adjacent to enemies 
   (can be toggled via rightclick menu)" attacks/foot-boot.png (
            required_upgrades=patience
        )}
        {ADD_FORGE_UPGRADE_TO_LIST rest _"Rest" _"Recover 25 energy each time you skip your turn" icons/rest.png (
            required_upgrades=patience
        )}
        {ADD_FORGE_UPGRADE_TO_LIST restII _"Rest II" _"Recover 35 energy
   and heal 2 hitpoints when skipping your turn." "icons/rest.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=rest
            required_bosses=spiderqueen
        )}
        {ADD_FORGE_UPGRADE_TO_LIST restIII _"Rest III" _"Recover 50 energy
   and heal 3 hitpoints when skipping your turn." "icons/rest.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=restII
            required_bosses=ares
        )}
        {ADD_FORGE_UPGRADE_TO_LIST restIV _"Rest IV" _"Recover 75 energy
   and heal 4 hitpoints when skipping your turn." "icons/rest.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=restIII
            required_bosses=scylla
        )}
        {ADD_FORGE_UPGRADE_TO_LIST chameleon _"Chameleon" _"You become invisible if you skip your turn.
   The invisibility wears off if you move or attack" icons/chameleon.png (
            required_upgrades=patience
            required_bosses=archmage
        )}
        {ADD_FORGE_UPGRADE_TO_LIST swimming _"Swimming" _"can move in shallow water and swamp
   you no longer take damage when knocked into shallow water/swamp
   (also applies to newly-summoned Shadow Clones/Spirit Archers)" attacks/waterspray.png ()}
        {ADD_FORGE_UPGRADE_TO_LIST levitation _"Levitation" _"can fly over most terrain
   you no longer take damage when knocked into lava/chasms/deep water
   (also applies to newly-summoned Shadow Clones/Spirit Archers)" icons/levitation.png (
            required_upgrades=swimming
            required_bosses=donovan
        )}
        {ADD_FORGE_UPGRADE_TO_LIST artifacts _"Artifacts" _"All resistances are increased by 20%
   Spear/Spear Throw damage is increased by 5
   Shortsword damage is increased by 3" icons/artifact-helmet.png (
            not_obtainable_by_forge=yes
        )}
        #obtained from orb shop
        #TODO: when making multiple playable characters, one of them could have book of pacts as a starting upgrade
        {ADD_FORGE_UPGRADE_TO_LIST book_of_pacts _"Book of Pacts" _"New Skill: choose a pact
   has a 5-depth cooldown" icons/book2.png (
            not_obtainable_by_forge=yes
        )}
        {ADD_FORGE_UPGRADE_TO_LIST book_of_pactsII _"Book of Pacts II" _"Cooldown is reduced to 4 depths." "icons/book2.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=book_of_pacts
            required_bosses=donovan
        )}
        {ADD_FORGE_UPGRADE_TO_LIST book_of_pactsIII _"Book of Pacts III" _"Cooldown is reduced to 3 depths." "icons/book2.png~BLIT(icons/overlay_III.png)" (
            required_upgrades=book_of_pactsII
            required_bosses=duo
        )}
        #obtained from reaper rematch:
        {ADD_FORGE_UPGRADE_TO_LIST reaper_favorI _"Reaper's Favor" _"+10 max hp, +50 max energy." icons/protect-magenta-2.png (
            not_obtainable_by_forge=yes
        )}

        {ADD_FORGE_UPGRADE_TO_LIST reaper_favorII _"Reaper's Favor II" _"+10 max hp, +50 max energy." "icons/protect-magenta-3.png~BLIT(icons/overlay_II.png)" (
            not_obtainable_by_forge=yes
        )}

        {ADD_FORGE_UPGRADE_TO_LIST reaper_harvest _"Reaper's Harvest" _"Every 5 levels worth of killed enemies, spawn an allied Poltergeist
        (for example, killing 5 level 1 enemies, or one level 3 and one level 2)
        (works even when enemies are killed by allies or another player)" "attacks/claws-shadow.png" (
            required_upgrades=reaper_favorI
            #not really needed since you get reaper_favorI from reaper2 either way, but adding this so the variable is used
            required_bosses=reaper2
            is_shared=yes
        )}

        {ADD_FORGE_UPGRADE_TO_LIST reaper_harvestII _"Reaper's Harvest II" _"Besides spawning poltergeists as usual
    Every 20 levels worth of killed enemies, spawn an allied Nightgaunt
        (works even when enemies are killed by allies or another player)" "attacks/claws-shadow.png~BLIT(icons/overlay_II.png)" (
            required_upgrades=reaper_harvest
            required_bosses=reaper2
            is_shared=yes
        )}

        {ADD_FORGE_UPGRADE_TO_LIST reaper_harvestIII _"Reaper's Harvest III" _"Poltergeists now spawn every 4 levels worth of kills instead of 5
    Nightgaunts now spawn every 16 levels worth of kills instead of 20" "attacks/claws-shadow.png~BLIT(icons/overlay_III.png)" (
            #doing it this way instead of required bosses, so it's clearer for players that they have to return to the underworld if they want to keep leveling up this branch
            required_upgrades=reaper_favorII,reaper_harvestII
#            required_bosses=reaper3
            is_shared=yes
        )}
        {ADD_FORGE_UPGRADE_TO_LIST reaper_harvestIV _"Reaper's Harvest IV" _"Poltergeists now spawn every 3 levels worth of kills instead of 4
    Nightgaunts now spawn every 12 levels worth of kills instead of 16" "attacks/claws-shadow.png~BLIT(icons/overlay_IV.png)" (
            required_upgrades=reaper_harvestIII
#            required_bosses=reaper3
            is_shared=yes
        )}


        #this has been commented out for now, as the artifact is no longer in the story
        #{ADD_FORGE_UPGRADE_TO_LIST prometheus_heart _"Prometheus' Heart" _"Increased maximum energy (+50)" icons/light-royal-3.png (
        #    not_obtainable_by_forge=yes
        #)}
    [/event]
    #this event will be responsible for immediate upgrade effects (like improved armor giving hp)
    [event]
        id=spartan_forge_effect_event
        first_time_only=no
        {FORGE_EFFECT_START $tmp_forge_upgrade_id|}
        [switch]
            variable=tmp_forge_upgrade_id
            [case]
                value=algadurI
                {FORGE_COMPANION_OBJECT Algadur (
                    [effect]
                        apply_to=attack
                        name=battle axe
                        increase_damage=2
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=hammer
                        increase_damage=3
                    [/effect]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                )}
            [/case]
            [case]
                value=algadurII
                {FORGE_COMPANION_OBJECT Algadur (
                    [effect]
                        apply_to=attack
                        name=battle axe
                        increase_damage=2
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=hammer
                        increase_damage=3
                    [/effect]
                    [effect]
                        apply_to=resistance
                        replace=no
                        [resistance]
                            blade=-10
                            pierce=-10
                            impact=-10
                            arcane=-10
                            fire=-10
                            cold=-10
                        [/resistance]
                    [/effect]
                )}
            [/case]
            [case]
                value=algadurIII
                {FORGE_COMPANION_OBJECT Algadur (
                    [effect]
                        apply_to=attack
                        name=battle axe
                        increase_damage=3
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=hammer
                        increase_damage=4
                    [/effect]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                )}
            [/case]
            [case]
                value=algadur_tough
                {FORGE_COMPANION_OBJECT Algadur (
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_HOPLITE_KNOCKBACKRESIST 1}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=hitpoints
                        increase=8
                        increase_total=8
                    [/effect]
                )}
            [/case]
            [case]
                value=algadur_toughII
                {FORGE_COMPANION_OBJECT Algadur (
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {SPARTAN_REGENERATES_LESSER 2}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                )}
            [/case]
            [case]
                value=algadur_toughIII
                {FORGE_COMPANION_OBJECT Algadur (
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            {ABILITY_HOPLITE_KNOCKBACKRESIST 1}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_HOPLITE_KNOCKBACKRESIST 2}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            {SPARTAN_REGENERATES_LESSER 2}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {SPARTAN_REGENERATES_LESSER 3}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                )}
            [/case]
            [case]
                value=algadur_leap
                {FORGE_COMPANION_OBJECT Algadur (
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_HOPLITE_LEAP_NONPLAYER 3}
                        [/abilities]
                    [/effect]
                )}
            [/case]
            [case]
                value=algadur_frenzy
                {FORGE_COMPANION_OBJECT Algadur (
                    [effect]
                        apply_to=attack
                        range=melee
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_SPARTAN_COMBO 1}
                        [/set_specials]
                    [/effect]
                )}
            [/case]
            [case]
                value=elizabethI
                {FORGE_COMPANION_OBJECT Elizabeth (
                    [effect]
                        apply_to=attack
                        increase_damage=2
                    [/effect]
                    [effect]
                        apply_to=hitpoints
                        increase=5
                        increase_total=5
                    [/effect]
                    [effect]
                        apply_to=resistance
                        replace=no
                        [resistance]
                            arcane=-10
                            fire=-10
                            cold=-10
                        [/resistance]
                    [/effect]
                )}
            [/case]
            [case]
                value=elizabethII
                {FORGE_COMPANION_OBJECT Elizabeth (
                    [effect]
                        apply_to=hitpoints
                        increase=5
                        increase_total=5
                    [/effect]
                    [effect]
                        apply_to=resistance
                        replace=no
                        [resistance]
                            arcane=-10
                            fire=-10
                            cold=-10
                        [/resistance]
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=fireball
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_SPARTAN_BURN 2}#mostly visual, but the id is used for filtering
                        [/set_specials]
                    [/effect]
                )}
            [/case]
            [case]
                value=elizabethIII
                {FORGE_COMPANION_OBJECT Elizabeth (
                    [effect]
                        apply_to=attack
                        increase_damage=2
                    [/effect]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            {ABILITY_SPARTAN_SEMIRANGED 4}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_SPARTAN_SEMIRANGED 5}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=fireball
                        remove_specials=hoplite_ranged,spartan_elizabeth_fireball_anim4
                        [set_specials]
                            mode=append
                            {HOPLITE_RANGED_MACRO_SHARED elizabeth_upgraded 5 0 "misc/targethex.png" aoe ()}
                            #for filtering which anim to use based on her range:
                            [dummy]
                                id=spartan_elizabeth_fireball_anim5
                            [/dummy]
                        [/set_specials]
                    [/effect]
                )}
            [/case]
            [case]
                value=elizabethIV
                {FORGE_COMPANION_OBJECT Elizabeth (
                    [effect]
                        apply_to=attack
                        name=fireball
                        increase_damage=4
                    [/effect]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            {ABILITY_HOPLITE_TELEPORT 3}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_HOPLITE_TELEPORT_FOR_EFFECT 4}
                        [/abilities]
                    [/effect]
                )}
            [/case]
            [case]
                value=elizabeth_summoner
                {VARIABLE elizabeth_fire_guardians_each_depth 2}
                {FORGE_COMPANION_OBJECT Elizabeth (
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            {ABILITY_HOPLITE_SUMMON elizabeth _"summon fire guardians" _"This unit spawns a fire guardian next to itself every 5 turns. Can only have up to 2 summoned units on the map at a time per summoner." Hoplite_Fireguardian 5 2}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_HOPLITE_SUMMON elizabeth _"summon fire guardians" _"This unit spawns a fire guardian next to itself every 4 turns. Can only have up to 3 summoned units on the map at a time per summoner." Hoplite_Fireguardian 4 3}
                        [/abilities]
                    [/effect]
                )}
            [/case]
            [case]
                value=elizabeth_summonerII
                {VARIABLE elizabeth_fire_guardians_each_depth 3}
                {FORGE_COMPANION_OBJECT Elizabeth (
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            {ABILITY_HOPLITE_SUMMON elizabeth _"summon fire guardians" _"This unit spawns a fire guardian next to itself every 4 turns. Can only have up to 3 summoned units on the map at a time per summoner." Hoplite_Fireguardian 4 3}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_HOPLITE_SUMMON elizabeth _"summon fire guardians" _"This unit spawns a fire guardian next to itself every 3 turns. Can only have up to 4 summoned units on the map at a time per summoner." Hoplite_Fireguardian 3 4}
                        [/abilities]
                    [/effect]
                )}
            [/case]
            [case]
                value=elizabeth_summonerIII
                {VARIABLE elizabeth_fire_guardians_each_depth 4}
                {FORGE_COMPANION_OBJECT Elizabeth (
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            {ABILITY_HOPLITE_SUMMON elizabeth _"summon fire guardians" _"This unit spawns a fire guardian next to itself every 3 turns. Can only have up to 4 summoned units on the map at a time per summoner." Hoplite_Fireguardian 3 4}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_HOPLITE_SUMMON elizabeth _"summon fire guardians" _"This unit spawns a fire guardian next to itself every 2 turns. Can only have up to 5 summoned units on the map at a time per summoner." Hoplite_Fireguardian 2 5}
                        [/abilities]
                    [/effect]
                )}
            [/case]
            {SPARTAN_TRUE_ENDING_COMPANION_UPGRADE_EFFECTS}
            [case]
                value=companion_recovery
                {VARIABLE_OP algadur_cooldown sub 1}
                {VARIABLE_OP elizabeth_cooldown sub 1}
            [/case]
            [case]
                value=companion_recoveryII
                {VARIABLE_OP algadur_cooldown sub 1}
                {VARIABLE_OP elizabeth_cooldown sub 1}
            [/case]
            [case]
                value=armorI
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                [/object]
            [/case]
            [case]
                value=armorII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                [/object]
            [/case]
            [case]
                value=armorIII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                [/object]
            [/case]
            [case]
                value=armorIV
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                [/object]
            [/case]
            [case]
                value=armorV
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                [/object]
            [/case]
            [case]
                value=armorVI
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                [/object]
            [/case]
            [case]
                value=armorVII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                [/object]
            [/case]
            [case]
                value=sorcerer_robeI
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                [/object]
            [/case]
            [case]
                value=sorcerer_robeII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                [/object]
            [/case]
            [case]
                value=sorcerer_robeIII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                [/object]
            [/case]
            [case]
                value=sorcerer_robeIV
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                [/object]
            [/case]
            [case]
                value=regeneration
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {SPARTAN_REGENERATES_LESSER 2}
                        [/abilities]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=regenerationII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            {SPARTAN_REGENERATES_LESSER 2}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {SPARTAN_REGENERATES_LESSER 4}
                        [/abilities]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=firmstance
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_HOPLITE_KNOCKBACKRESIST 1}
                        [/abilities]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=firmstanceII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            {ABILITY_HOPLITE_KNOCKBACKRESIST 1}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_HOPLITE_KNOCKBACKRESIST 2}
                        [/abilities]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=healpotionI
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE healpotion_restore1 10}
                    {VARIABLE healpotion_capacity1 1}
                    {VARIABLE healpotions_in_inventory1 1}
                    {VARIABLE healpotions_per_depth1 1}
                ) (
                    {VARIABLE healpotion_restore2 10}
                    {VARIABLE healpotion_capacity2 1}
                    {VARIABLE healpotions_in_inventory2 1}
                    {VARIABLE healpotions_per_depth2 1}
                )}
            [/case]
            [case]
                value=healpotionII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP healpotion_restore1 add 5}
                ) (
                    {VARIABLE_OP healpotion_restore2 add 5}
                )}
            [/case]
            [case]
                value=healpotionIII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP healpotion_restore1 add 7}
                ) (
                    {VARIABLE_OP healpotion_restore2 add 7}
                )}
            [/case]
            [case]
                value=healpotionIV
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP healpotion_restore1 add 8}
                ) (
                    {VARIABLE_OP healpotion_restore2 add 8}
                )}
            [/case]
            [case]
                value=healpotionV
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP healpotion_restore1 add 10}
                ) (
                    {VARIABLE_OP healpotion_restore2 add 10}
                )}
            [/case]
            [case]
                value=healpotionVI
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP healpotion_restore1 add 5}
                ) (
                    {VARIABLE_OP healpotion_restore2 add 5}
                )}
            [/case]
            [case]
                value=healpotion_bag
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP healpotion_capacity1 add 1}
                ) (
                    {VARIABLE_OP healpotion_capacity2 add 1}
                )}
            [/case]
            [case]
                value=healpotion_bagII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP healpotion_capacity1 add 1}
                ) (
                    {VARIABLE_OP healpotion_capacity2 add 1}
                )}
            [/case]
            [case]
                value=healpotion_production
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP healpotions_per_depth1 add 1}
                ) (
                    {VARIABLE_OP healpotions_per_depth2 add 1}
                )}
            [/case]
            [case]
                value=phoenixamulet
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_phoenix_recharge2 3}
                        {VARIABLE hoplite_revive_cooldown2 0}
                        #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                    [/then]
                    [else]
                        {VARIABLE hoplite_phoenix_recharge1 3}
                        {VARIABLE hoplite_revive_cooldown1 0}
                        #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                    [/else]
                )}
            [/case]
            [case]
                value=amuletcharge
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_phoenix_recharge2 2}
                        {VARIABLE_OP hoplite_revive_cooldown2 sub 1}
                    [/then]
                    [else]
                        {VARIABLE hoplite_phoenix_recharge1 2}
                        {VARIABLE_OP hoplite_revive_cooldown1 sub 1}
                    [/else]
                )}
            [/case]
            [case]
                value=amuletchargeII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_phoenix_recharge2 1}
                        {VARIABLE_OP hoplite_revive_cooldown2 sub 1}
                    [/then]
                    [else]
                        {VARIABLE hoplite_phoenix_recharge1 1}
                        {VARIABLE_OP hoplite_revive_cooldown1 sub 1}
                    [/else]
                )}
            [/case]
            [case]
                value=impale
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=spear
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_IMPALE}
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=impaleII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=spear
                        remove_specials=hoplite_impale
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_IMPALEII}
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=impaleIII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=spear
                        remove_specials=hoplite_impaleII
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_IMPALEIII}
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=speardmg
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=spear
                        increase_damage=5
                    [/effect]
                [/object]
            [/case]
            [case]
                value=skill_spear
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE precisestab_damage1 10}
                ) (
                    {VARIABLE precisestab_damage2 10}
                )}
            [/case]
            [case]
                value=precisestabII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP precisestab_damage1 add 5}
                ) (
                    {VARIABLE_OP precisestab_damage2 add 5}
                )}
            [/case]
            [case]
                value=precisestabIII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP precisestab_damage1 add 5}
                ) (
                    {VARIABLE_OP precisestab_damage2 add 5}
                )}
            [/case]
            [case]
                value=swordhitandrun
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=sword
                        [set_specials]
                            mode=append
                            [dummy]
                                id=hoplite_hitandrun
                                name= _ "hit and run"
                                description=_"This unit gains 1 movepoint back after attacking when using this attack, but cannot attack again on the same turn."
                            [/dummy]
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=swordcombo
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=sword
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_SPARTAN_COMBO 1}
                        [/set_specials]
                    [/effect]
                [/object]
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_combo_amount2 1}
                    [/then]
                    [else]
                        {VARIABLE hoplite_combo_amount1 1}
                    [/else]
                )}
            [/case]
            [case]
                value=swordcomboII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=sword
                        remove_specials=spartan_combo
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_SPARTAN_COMBO 2}
                        [/set_specials]
                    [/effect]
                [/object]
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_combo_amount2 2}
                    [/then]
                    [else]
                        {VARIABLE hoplite_combo_amount1 2}
                    [/else]
                )}
            [/case]
            [case]
                value=swordcounterattack
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=sword
                        defense_weight=1.0
                        [set_specials]
                            mode=append
                            {SPECIAL_HOPLITE_COUNTERATTACK}
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=staffhitandrun
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=staff
                        [set_specials]
                            mode=append
                            [dummy]
                                id=hoplite_hitandrun
                                name= _ "hit and run"
                                description=_"This unit gains 1 movepoint back after attacking when using this attack, but cannot attack again on the same turn."
                            [/dummy]
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=staffcounterattack
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=staff
                        defense_weight=1.0
                        [set_specials]
                            mode=append
                            {SPECIAL_HOPLITE_COUNTERATTACK}
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=staff_energy
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=staff
                        [set_specials]
                            mode=append
                            [dummy]
                                id=spartan_energy_siphon
                                name= _ "energy siphon"
                                description=_"Hitting an enemy with this attack gives 5 energy per enemy level. Only works in offense."
                            [/dummy]
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=staff_energyII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=staff
                        remove_specials=spartan_energy_siphon
                        [set_specials]
                            mode=append
                            [dummy]
                                id=spartan_energy_siphonII
                                name= _ "energy siphon II"
                                description=_"Hitting an enemy with this attack gives 10 energy per enemy level. Only works in offense."
                            [/dummy]
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=skill_staff_enchantment
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE staff_arcane_damage1 5}
                    {VARIABLE staff_fire_burn1 2}
                    {VARIABLE staff_arcane_cooldown1 0}
                    {VARIABLE staff_arcane_max_cooldown1 5}
                    {VARIABLE staff_fire_cooldown1 0}
                    {VARIABLE staff_fire_max_cooldown1 5}
                    #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                    #melee anim uses shrunk lightbeam:
                    {VARIABLE staff_arcane_anim_size1 small}
                ) (
                    {VARIABLE staff_arcane_damage2 10}
                    {VARIABLE staff_fire_burn2 2}
                    {VARIABLE staff_arcane_cooldown2 0}
                    {VARIABLE staff_arcane_max_cooldown2 5}
                    {VARIABLE staff_fire_cooldown2 0}
                    {VARIABLE staff_fire_max_cooldown2 5}
                    #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                    #melee anim uses shrunk lightbeam:
                    {VARIABLE staff_arcane_anim_size2 small}
                )}
            [/case]
            [case]
                value=staff_enchantmentII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE staff_arcane_cooldown1 0}
                    {VARIABLE_OP staff_arcane_max_cooldown1 sub 1}
                    {VARIABLE staff_fire_cooldown1 0}
                    {VARIABLE_OP staff_fire_max_cooldown1 sub 1}
                    {VARIABLE staff_cold_cooldown1 0}
                    {VARIABLE staff_cold_max_cooldown1 6}
                    #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                ) (
                    {VARIABLE staff_arcane_cooldown2 0}
                    {VARIABLE_OP staff_arcane_max_cooldown2 sub 1}
                    {VARIABLE staff_fire_cooldown2 0}
                    {VARIABLE_OP staff_fire_max_cooldown2 sub 1}
                    {VARIABLE staff_cold_cooldown2 0}
                    {VARIABLE staff_cold_max_cooldown2 6}
                    #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                )}
            [/case]
            [case]
                value=staff_enchantmentIII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE staff_arcane_cooldown1 0}
                    {VARIABLE staff_fire_cooldown1 0}

                    {VARIABLE staff_cold_cooldown1 0}
                    {VARIABLE_OP staff_cold_max_cooldown1 sub 1}
                    {VARIABLE staff_fire_burn1 3}
                    {VARIABLE staff_arcane_damage_holy1 5}
                    {VARIABLE staff_arcane_text1 _"
    deals an additional +$staff_arcane_damage_holy1| damage against undead/demons"}
                ) (
                    {VARIABLE staff_arcane_cooldown2 0}
                    {VARIABLE staff_fire_cooldown2 0}

                    {VARIABLE staff_cold_cooldown2 0}
                    {VARIABLE_OP staff_cold_max_cooldown2 sub 1}
                    {VARIABLE staff_fire_burn2 3}
                    {VARIABLE staff_arcane_damage_holy2 5}
                    {VARIABLE staff_arcane_text2 _"
    deals an additional +$staff_arcane_damage_holy1| damage against undead/demons"}
                )}
            [/case]
            [case]
                value=staff_enchantmentIV
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE staff_fire_cooldown1 0}

                    {VARIABLE staff_arcane_cooldown1 0}
                    {VARIABLE_OP staff_arcane_max_cooldown1 sub 1}
                    {VARIABLE staff_cold_cooldown1 0}
                    {VARIABLE_OP staff_cold_max_cooldown1 sub 1}
                    {VARIABLE staff_arcane_damage1 7}
                    {VARIABLE staff_fire_burn1 4}
                    #melee anim now uses slightly less shrunk lightbeam:
                    {VARIABLE staff_arcane_anim_size1 medium}
                ) (
                    {VARIABLE staff_fire_cooldown2 0}

                    {VARIABLE staff_arcane_cooldown2 0}
                    {VARIABLE_OP staff_arcane_max_cooldown2 sub 1}
                    {VARIABLE staff_cold_cooldown2 0}
                    {VARIABLE_OP staff_cold_max_cooldown2 sub 1}
                    {VARIABLE staff_arcane_damage2 7}
                    {VARIABLE staff_fire_burn2 4}
                    #melee anim now uses slightly less shrunk lightbeam:
                    {VARIABLE staff_arcane_anim_size2 medium}
                )}
            [/case]
            [case]
                value=staff_enchantmentV
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE staff_arcane_cooldown1 0}
                    {VARIABLE_OP staff_arcane_max_cooldown1 sub 1}

                    {VARIABLE staff_fire_cooldown1 0}

                    {VARIABLE staff_cold_cooldown1 0}
                    {VARIABLE_OP staff_cold_max_cooldown1 sub 1}
                    {VARIABLE staff_fire_burn1 5}
                    {VARIABLE staff_arcane_damage_holy1 10}
                    {VARIABLE staff_arcane_text1 _"
    deals an additional +$staff_arcane_damage_holy1| damage against undead/demons"}
                ) (
                    {VARIABLE staff_arcane_cooldown2 0}
                    {VARIABLE_OP staff_arcane_max_cooldown1 sub 1}

                    {VARIABLE staff_fire_cooldown2 0}

                    {VARIABLE staff_cold_cooldown2 0}
                    {VARIABLE_OP staff_cold_max_cooldown2 sub 1}
                    {VARIABLE staff_fire_burn2 5}
                    {VARIABLE staff_arcane_damage_holy2 10}
                    {VARIABLE staff_arcane_text2 _"
    deals an additional +$staff_arcane_damage_holy1| damage against undead/demons"}
                )}
            [/case]
            [case]
                value=staff_enchantmentVI
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE staff_arcane_cooldown1 0}
                    {VARIABLE staff_fire_cooldown1 0}
                    {VARIABLE staff_cold_cooldown1 0}

                    {VARIABLE_OP staff_fire_max_cooldown1 sub 1}
                    {VARIABLE staff_fire_burn1 6}
                    {VARIABLE staff_arcane_damage_holy1 15}
                    {VARIABLE staff_arcane_text1 _"
    deals an additional +$staff_arcane_damage_holy1| damage against undead/demons"}
                    {VARIABLE staff_cold_text1 _"
    also slows enemies that are adjacent to both you and the target (like cleave)"}
                ) (
                    {VARIABLE staff_arcane_cooldown2 0}
                    {VARIABLE staff_fire_cooldown2 0}
                    {VARIABLE staff_cold_cooldown2 0}

                    {VARIABLE_OP staff_fire_max_cooldown2 sub 1}
                    {VARIABLE staff_fire_burn2 6}
                    {VARIABLE staff_arcane_damage_holy2 15}
                    {VARIABLE staff_arcane_text2 _"
    deals an additional +$staff_arcane_damage_holy1| damage against undead/demons"}
                    {VARIABLE staff_cold_text2 _"
    also slows enemies that are adjacent to both you and the target (like cleave)"}
                )}
            [/case]
            [case]
                value=staff_enchantmentVII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE staff_fire_cooldown1 0}
                    {VARIABLE staff_arcane_cooldown1 0}
                    {VARIABLE staff_cold_cooldown1 0}

                    {VARIABLE staff_arcane_damage1 12}
                    {VARIABLE staff_fire_burn1 7}
                    {VARIABLE staff_cold_text1 _"
    also slows enemies that are adjacent to both you and the target (like cleave)
    and gives +30% fire resistance until the start of your next turn"}
                    #melee anim now uses full-size lightbeam instead of shrunk lightbeam:
                    {VARIABLE staff_arcane_anim_size1 big}
                ) (
                    {VARIABLE staff_fire_cooldown2 0}
                    {VARIABLE staff_arcane_cooldown2 0}
                    {VARIABLE staff_cold_cooldown2 0}

                    {VARIABLE staff_arcane_damage2 12}
                    {VARIABLE staff_fire_burn2 7}
                    {VARIABLE staff_cold_text2 _"
    also slows enemies that are adjacent to both you and the target (like cleave)
    and gives +30% fire resistance until the start of your next turn"}
                    #melee anim now uses full-size lightbeam instead of shrunk lightbeam:
                    {VARIABLE staff_arcane_anim_size2 big}
                )}
            [/case]
            [case]
                value=axe
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name="axe"
                        description= _ "axe"
                        icon=attacks/axe.png
                        type=blade
                        range=melee
                        [specials]
                            [dummy]
                                id=shortranged2
                                name= _ "short-ranged"
                                description=_ "This attack can only used if the unit is standing next to the target at the start of the unit's turn."
                            [/dummy]
                        [/specials]
                        damage=14
                        number=1
                        defense_weight=0.0
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=axe
                            [/filter_attack]
                            start_time=-200

                            [frame]
                                duration=300
                            [/frame]

                            {SOUND:HIT_AND_MISS axe.ogg {SOUND_LIST:MISS} -100}
                        [/attack_anim]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=axeII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=axe
                        increase_damage=3
                    [/effect]
                [/object]
            [/case]
            [case]
                value=axeIII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=axe
                        increase_damage=4
                        set_icon="attacks/battleaxe.png"
                    [/effect]
                [/object]
            [/case]
            [case]
                value=axeIV
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=axe
                        increase_damage=4
                    [/effect]
                [/object]
            [/case]
            [case]
                value=axeV
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=axe
                        increase_damage=5
                    [/effect]
                [/object]
            [/case]
            [case]
                value=axe_overkill
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=axe
                        [set_specials]
                            mode=append
                            [dummy]
                                id=spartan_overkill
                                name=_"overkill"
                                description=_"When killing an enemy with this attack, excess damage is converted into energy. (for example, killing a 5/10hp enemy with a 17-damage attack gives you 12 energy)"
                            [/dummy]
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=axe_cleave
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=axe
                        [set_specials]
                            mode=append
                            [dummy]
                                id=spartan_axe_cleave
                                name=_"cleave"
                                description=_"When hitting an enemy with this attack, deal 50% of the attack's base damage to enemies that are adjacent to both you and the target."
                            [/dummy]
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=axe_cleave
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=axe
                        remove_specials=spartan_axe_cleave
                        [set_specials]
                            mode=append
                            [dummy]
                                id=spartan_axe_spin
                                name=_"spinning strike"
                                description=_"When hitting an enemy with this attack, deal 50% of the attack's base damage to enemies that are adjacent to you."
                            [/dummy]
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=mightybash
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=shield
                        remove_specials=knockback
                        [set_specials]
                            mode=append
                            {SPARTAN_KNOCKBACKSPECIAL 2}
                        [/set_specials]
                    [/effect]
                [/object]
                #used for Charged Bash skill
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP charged_shieldbash_knockback_bonus2 add 1}
                    [/then]
                    [else]
                        {VARIABLE_OP charged_shieldbash_knockback_bonus1 add 1}
                    [/else]
                )}
            [/case]
            [case]
                value=herculeanbash
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=shield
                        remove_specials=knockback
                        [set_specials]
                            mode=append
                            {SPARTAN_KNOCKBACKSPECIAL 3}
                        [/set_specials]
                    [/effect]
                [/object]
                #used for Charged Bash skill
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP charged_shieldbash_knockback_bonus2 add 1}
                    [/then]
                    [else]
                        {VARIABLE_OP charged_shieldbash_knockback_bonus1 add 1}
                    [/else]
                )}
            [/case]
            [case]
                value=spikedshield
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=shield
                        increase_damage=5#now 5 instead of 4 since base damage is now 0
                    [/effect]
                [/object]
            [/case]
            [case]
                value=shieldup
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=shield
                        [set_specials]
                            mode=append
                            [dummy]
                                id=shieldup_dummy
                                name=_"shield up"
                                description=_"After using this attack, you gain a bonus to resistances until the start of your next turn."
                            [/dummy]
                        [/set_specials]
                    [/effect]
                [/object]
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE shieldup_resistance2 33}
                        {VARIABLE shieldup_resistance_cap2 60}
                    [/then]
                    [else]
                        {VARIABLE shieldup_resistance1 33}
                        {VARIABLE shieldup_resistance_cap1 60}
                    [/else]
                )}
            [/case]
            [case]
                value=shieldupII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE shieldup_resistance2 50}
                        {VARIABLE shieldup_resistance_cap2 70}
                    [/then]
                    [else]
                        {VARIABLE shieldup_resistance1 50}
                        {VARIABLE shieldup_resistance_cap1 70}
                    [/else]
                )}
            [/case]
            [case]
                value=deployshield
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE hoplite_deployshield_cooldown1 0}
                    {VARIABLE hoplite_deployshield_max_cooldown1 3}
                    #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                ) (
                    {VARIABLE hoplite_deployshield_cooldown2 0}
                    {VARIABLE hoplite_deployshield_max_cooldown2 3}
                    #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                )}
            [/case]
            [case]
                value=deployshieldII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE deployshield_hpbonus2 5}
                        {VARIABLE deployshield_resistance2 10}
                        {VARIABLE deployshield_resistance_cap2 40}
                    [/then]
                    [else]
                        {VARIABLE deployshield_hpbonus1 5}
                        {VARIABLE deployshield_resistance1 10}
                        {VARIABLE deployshield_resistance_cap1 40}
                    [/else]
                )}
            [/case]
            [case]
                value=deployshieldIII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE deployshield_hpbonus2 10}
                        {VARIABLE deployshield_resistance2 20}
                        {VARIABLE deployshield_resistance_cap2 60}
                    [/then]
                    [else]
                        {VARIABLE deployshield_hpbonus1 10}
                        {VARIABLE deployshield_resistance1 20}
                        {VARIABLE deployshield_resistance_cap1 60}
                    [/else]
                )}
            [/case]
            [case]
                value=deployshieldIV
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE deployshield_hpbonus2 15}
                        {VARIABLE hoplite_deployshield_cooldown2 0}
                        {VARIABLE hoplite_deployshield_max_cooldown2 2}
                    [/then]
                    [else]
                        {VARIABLE deployshield_hpbonus1 15}
                        {VARIABLE hoplite_deployshield_cooldown1 0}
                        {VARIABLE hoplite_deployshield_max_cooldown1 2}
                    [/else]
                )}
            [/case]
            [case]
                value=deployshieldV
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE deployshield_hpbonus2 20}
                        {VARIABLE deployshield_resistance2 30}
                        {VARIABLE deployshield_resistance_cap2 70}
                    [/then]
                    [else]
                        {VARIABLE deployshield_hpbonus1 20}
                        {VARIABLE deployshield_resistance1 30}
                        {VARIABLE deployshield_resistance_cap1 70}
                    [/else]
                )}
            [/case]
            [case]
                value=sweepingbash
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=shield
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_SPARTAN_SWEEPINGBASH}
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=spinningbash
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=shield
                        remove_specials=spartan_sweepingbash
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_SPARTAN_SPINNINGBASH}
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=skill_chargedbash
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE chargedbash_damage1 0}
                ) (
                    {VARIABLE chargedbash_damage2 0}
                )}
            [/case]
            [case]
                value=chargedbashII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP chargedbash_damage1 add 10}
                    {VARIABLE chargedbash_text1 _" and +$chargedbash_damage1| damage"}
                ) (
                    {VARIABLE_OP chargedbash_damage2 add 10}
                    {VARIABLE chargedbash_text2 _" and +$chargedbash_damage2| damage"}
                )}
            [/case]
            [case]
                value=chargedbashIII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP chargedbash_damage1 add 5}
                    {VARIABLE chargedbash_text1 _" and +$chargedbash_damage1| damage"}
                ) (
                    {VARIABLE_OP chargedbash_damage2 add 5}
                    {VARIABLE chargedbash_text2 _" and +$chargedbash_damage2| damage"}
                )}
            [/case]
            [case]
                value=bow
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=bow
                        description= _ "bow"
                        #            icon=attacks/bow-short.png
                        icon=attacks/bow.png
                        type=pierce
                        range=melee
                        [specials]
                            [dummy]
                                id=hoplite_bow
                                name= _ "bow"
                                description=_ "This attack can attack units in the direction that you select via right-click menu on an adjacent hex. It has a 3-tile range (can be increased by upgrades) but a 1 tile blindspot. To shoot the bow you must first aim it in a direction, then it will be shot at the start of the next turn."
                            [/dummy]
                        [/specials]
                        damage=10
                        number=1
                        attack_weight=0.0
                        defense_weight=0.0
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=bow
                            [/filter_attack]
                            missile_start_time=-150
                            [missile_frame]
                                duration=150
                                image="projectiles/missile-n.png"
                                image_diagonal="projectiles/missile-ne.png"
                            [/missile_frame]
                            start_time=-380
                            [frame]
                                duration=400
                            [/frame]
                            {SOUND:HIT_AND_MISS bow.ogg bow-miss.ogg -380}
                        [/attack_anim]
                    [/effect]
                [/object]
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE hoplite_bow_range1 4}
                    {VARIABLE hoplite_bow_blindspot1 1}
                ) (
                    {VARIABLE hoplite_bow_range2 4}
                    {VARIABLE hoplite_bow_blindspot2 1}
                )}
            [/case]
            [case]
                value=bowII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=bow
                        set_icon="attacks/bow-elven.png"
                    [/effect]
                [/object]
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP hoplite_bow_range1 add 1}
                ) (
                    {VARIABLE_OP hoplite_bow_range2 add 1}
                )}
            [/case]
            [case]
                value=bowIII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=bow
                        increase_damage=5
                        set_icon="attacks/bow-elven-magic.png"
                    [/effect]
                [/object]
            [/case]
            [case]
                value=bowIV
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE spartan_bow_mode1 quickdraw}
                    {VARIABLE spartan_bow_overdraw_damagebonus1 5}
                ) (
                    {VARIABLE spartan_bow_mode2 quickdraw}
                    {VARIABLE spartan_bow_overdraw_damagebonus2 5}
                )}
            [/case]
            [case]
                value=bowV
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=bow
                        increase_damage=5
                    [/effect]
                [/object]
                #if overdraw mode is enabled, reset the overdraw damage:
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE spartan_bow_overdraw_damagebonus1 10}

                    {IF_VAR spartan_bow_mode1 equals overdraw (
                    [then]
                        [remove_object]
                            id=$hoplite_upgradeid
                            object_id=bow_overdraw_bonus
                        [/remove_object]
                        [object]
                            silent=yes
                            duration=forever
                            id=bow_overdraw_bonus
                            take_only_once=no
                            [filter]
                                id=$hoplite_upgradeid
                            [/filter]
                            [effect]
                                apply_to=attack
                                name=bow
                                increase_damage=$spartan_bow_overdraw_damagebonus1
                            [/effect]
                        [/object]
                    [/then]
                    )}
                ) (
                    {VARIABLE spartan_bow_overdraw_damagebonus2 10}
                    {IF_VAR spartan_bow_mode2 equals overdraw (
                    [then]
                        [remove_object]
                            id=$hoplite_upgradeid
                            object_id=bow_overdraw_bonus
                        [/remove_object]
                        [object]
                            silent=yes
                            duration=forever
                            id=bow_overdraw_bonus
                            take_only_once=no
                            [filter]
                                id=$hoplite_upgradeid
                            [/filter]
                            [effect]
                                apply_to=attack
                                name=bow
                                increase_damage=$spartan_bow_overdraw_damagebonus2
                            [/effect]
                        [/object]
                    [/then]
                    )}
                )}
            [/case]
            [case]
                value=bow_eagle_eye
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP hoplite_bow_range1 add 1}
                ) (
                    {VARIABLE_OP hoplite_bow_range2 add 1}
                )}
            [/case]
            [case]
                value=bow_pointblank
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE hoplite_bow_blindspot1 0}
                ) (
                    {VARIABLE hoplite_bow_blinspot2 0}
                )}
            [/case]
            [case]
                value=bow_knockback
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=bow
                        remove_specials=knockback
                        [set_specials]
                            mode=append
                            {SPARTAN_KNOCKBACKSPECIAL 1}#in this case it's purely visual
                        [/set_specials]
                    [/effect]
                [/object]
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_bow_knockback_distance2 1}
                    [/then]
                    [else]
                        {VARIABLE hoplite_bow_knockback_distance1 1}
                    [/else]
                )}
            [/case]
            [case]
                value=bow_knockbackII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=bow
                        remove_specials=knockback
                        [set_specials]
                            mode=append
                            {SPARTAN_KNOCKBACKSPECIAL 2}#in this case it's purely visual
                        [/set_specials]
                    [/effect]
                [/object]
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_bow_knockback_distance2 2}
                    [/then]
                    [else]
                        {VARIABLE hoplite_bow_knockback_distance1 2}
                    [/else]
                )}
            [/case]
            [case]
                value=bow_burn
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_bow_burn2 2}
                    [/then]
                    [else]
                        {VARIABLE hoplite_bow_burn1 2}
                    [/else]
                )}
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=bow
                        remove_specials=spartan_burn
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_SPARTAN_BURN 2}#in this case it's purely visual
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=bow_burnII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_bow_burn2 4}
                    [/then]
                    [else]
                        {VARIABLE hoplite_bow_burn1 4}
                    [/else]
                )}
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=bow
                        remove_specials=spartan_burn
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_SPARTAN_BURN 4}#in this case it's purely visual
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=spearthrowrangeI
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_spearthrow_radius2 add 1}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_spearthrow_radius1 add 1}
                    [/else]
                )}
            [/case]
            [case]
                value=spearthrowrangeII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=spear2
                        increase_damage=5
                    [/effect]
                [/object]
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_spearthrow_radius2 add 1}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_spearthrow_radius1 add 1}
                    [/else]
                )}
            [/case]
            [case]
                value=spearthrowrangeIII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_spearthrow_radius2 add 1}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_spearthrow_radius1 add 1}
                    [/else]
                )}
            [/case]
            [case]
                value=spearthrowrangeIV
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_spearthrow_radius2 add 1}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_spearthrow_radius1 add 1}
                    [/else]
                )}
            [/case]
            [case]
                value=spearthrowrangeV
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=spear2
                        increase_damage=5
                    [/effect]
                [/object]
            [/case]
            [case]
                value=spearthrowexplode
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_spearthrow_explosive_damage_bonus2 10}
                    [/then]
                    [else]
                        {VARIABLE hoplite_spearthrow_explosive_damage_bonus1 10}
                    [/else]
                )}
            [/case]
            [case]
                value=spearthrowexplodeII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_spearthrow_explosive_damage_bonus2 add 5}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_spearthrow_explosive_damage_bonus1 add 5}
                    [/else]
                )}
            [/case]
            [case]
                value=wizardbeam
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=wizardbeam
                        description=_"flame blast"
                        type=fire
                        [specials]
                            [dummy]
                                id=hoplite_wizardbeam
                                name= _ "flame blast"
                                description=_ "This attack can attack units in a line, in the direction that you select via right-click menu on an adjacent hex. It has a 3-tile range (can be increased by upgrades) 3-turn cooldown by default (can be decreased with upgrades). If there are no enemies in range, nothing happens and you the action isn't wasted."
                            [/dummy]
                        [/specials]
                        range=ranged
                        damage=10
                        number=1
                        icon=attacks/fire-blast.png
                        attack_weight=0.0
                        defense_weight=0.0
                    [/effect]
                [/object]
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE hoplite_wizardbeam_cooldown1 0}
                    {VARIABLE hoplite_wizardbeam_max_cooldown1 4}
                    {VARIABLE hoplite_wizardbeam_range1 3}
                    #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                ) (
                    {VARIABLE hoplite_wizardbeam_cooldown2 0}
                    {VARIABLE hoplite_wizardbeam_max_cooldown2 4}
                    {VARIABLE hoplite_wizardbeam_range2 3}
                    #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                )}
            [/case]
            [case]
                value=wizardbeamII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE hoplite_wizardbeam_range1 4}
                ) (
                    {VARIABLE hoplite_wizardbeam_range2 4}
                )}
            [/case]
            [case]
                value=wizardbeamIII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=wizardbeam
                        increase_damage=5
                    [/effect]
                [/object]
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP hoplite_wizardbeam_max_cooldown1 sub 1}
                ) (
                    {VARIABLE_OP hoplite_wizardbeam_max_cooldown2 sub 1}
                )}
            [/case]
            [case]
                value=wizardbeamIV
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=wizardbeam
                        increase_damage=5
                    [/effect]
                [/object]
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE hoplite_wizardbeam_range1 5}
                ) (
                    {VARIABLE hoplite_wizardbeam_range2 5}
                )}
            [/case]
            [case]
                value=wizardbeam_burn
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_wizardbeam_burn2 2}
                    [/then]
                    [else]
                        {VARIABLE hoplite_wizardbeam_burn1 2}
                    [/else]
                )}
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=wizardbeam
                        remove_specials=spartan_burn
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_SPARTAN_BURN 2}#in this case it's purely visual
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=energyI
                {SPARTAN_INCREASE_MAX_ENERGY_IN_UPGRADE 25}
            [/case]
            [case]
                value=energyII
                {SPARTAN_INCREASE_MAX_ENERGY_IN_UPGRADE 25}
            [/case]
            [case]
                value=energyIII
                {SPARTAN_INCREASE_MAX_ENERGY_IN_UPGRADE 30}
            [/case]
            [case]
                value=energyIV
                {SPARTAN_INCREASE_MAX_ENERGY_IN_UPGRADE 30}
            [/case]
            [case]
                value=energyV
                {SPARTAN_INCREASE_MAX_ENERGY_IN_UPGRADE 40}
            [/case]
            [case]
                value=energyVI
                {SPARTAN_INCREASE_MAX_ENERGY_IN_UPGRADE 50}
            [/case]
            [case]
                value=prometheus_heart
                {SPARTAN_INCREASE_MAX_ENERGY_IN_UPGRADE 50}
            [/case]
            [case]
                value=adrenaline
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [dummy]
                                id=hoplite_adrenaline
                            [/dummy]
                        [/abilities]
                    [/effect]
                [/object]
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_adrenalinerush_cooldown2 0}
                        #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                    [/then]
                    [else]
                        {VARIABLE hoplite_adrenalinerush_cooldown1 0}
                        #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                    [/else]
                )}
            [/case]
            [case]
                value=teleportII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_teleport_radius2 add 1}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_teleport_radius1 add 1}
                    [/else]
                )}
            [/case]
            [case]
                value=teleportIII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_teleport_radius2 add 1}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_teleport_radius1 add 1}
                    [/else]
                )}
            [/case]
            [case]
                value=teleportaway
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [dummy]
                                id=hoplite_teleportaway
                                name= _ "teleport away"
                                description=_ "This unit teleports to a random location after being attacked, negating damage. However, this drains 75 energy per 10 damage you would receive from the attack."
                            [/dummy]
                        [/abilities]
                    [/effect]
                [/object]
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE teleportaway_enabled1 yes}
                ) (
                    {VARIABLE teleportaway_enabled2 yes}
                )}
            [/case]
            [case]
                value=lantern
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [dummy]
                                id=hoplite_lantern
                            [/dummy]
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=vision
                        increase=1
                    [/effect]
                [/object]
            [/case]
            [case]
                value=lanternII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [dummy]
                                id=hoplite_lantern
                            [/dummy]
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [dummy]
                                id=hoplite_lantern2
                            [/dummy]
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=vision
                        increase=1
                    [/effect]
                [/object]
            [/case]
            [case]
                value=ratsI
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_rats2 3}
                    [/then]
                    [else]
                        {VARIABLE hoplite_rats1 3}
                    [/else]
                )}
            [/case]
            [case]
                value=ratsII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_rats2 add 2}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_rats1 add 2}
                    [/else]
                )}
            [/case]
            [case]
                value=ratsIII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_rats2 add 2}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_rats1 add 2}
                    [/else]
                )}
            [/case]
            [case]
                value=ratsIV
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_rats2 add 2}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_rats1 add 2}
                    [/else]
                )}
            [/case]
            [case]
                value=ratsV
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_rats2 add 2}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_rats1 add 2}
                    [/else]
                )}
            [/case]
            [case]
                value=rat_legion
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE rat_cooldown2 0}
                        #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                    [/then]
                    [else]
                        {VARIABLE rat_cooldown1 0}
                        #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                    [/else]
                )}
            [/case]
            [case]
                value=rat_powerII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE rats_one_colosssal_rat_per_number2 3}
                        {VARIABLE rats_spawned_counter2 0}
                    [/then]
                    [else]
                        {VARIABLE rats_one_colosssal_rat_per_number1 3}
                        {VARIABLE rats_spawned_counter1 0}
                    [/else]
                )}
            [/case]
            [case]
                value=rat_wellfed
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE rats_one_colosssal_rat_per_number2 2}
                        {VARIABLE rats_spawned_counter2 0}
                    [/then]
                    [else]
                        {VARIABLE rats_one_colosssal_rat_per_number1 2}
                        {VARIABLE rats_spawned_counter1 0}
                    [/else]
                )}
            [/case]
            [case]
                value=shadowclone
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_shadowclone_cooldown2 0}
                        {VARIABLE hoplite_shadowclone_cooldown_max2 2}
                        #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                    [/then]
                    [else]
                        {VARIABLE hoplite_shadowclone_cooldown1 0}
                        {VARIABLE hoplite_shadowclone_cooldown_max1 2}
                        #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                    [/else]
                )}
            [/case]
            [case]
                value=shadowcloneIIb
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_shadowclone_cooldown_max2 1}
                        {VARIABLE_OP hoplite_shadowclone_cooldown2 sub 1}
                    [/then]
                    [else]
                        {VARIABLE hoplite_shadowclone_cooldown_max1 1}
                        {VARIABLE_OP hoplite_shadowclone_cooldown1 sub 1}
                    [/else]
                )}
            [/case]
            [case]
                value=summonedarcher
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_summonedarcher_cooldown2 0}
                        #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                    [/then]
                    [else]
                        {VARIABLE hoplite_summonedarcher_cooldown1 0}
                        #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                    [/else]
                )}
            [/case]
            [case]
                value=enthrall
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE spartan_enthrall_range2 1}
                    [/then]
                    [else]
                        {VARIABLE spartan_enthrall_range1 1}
                    [/else]
                )}
            [/case]
            [case]
                value=enthrallII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        #using this hacky workaround with variables, since the upgrade is only actually set as unlocked AFTER upgrade effects are triggered, and therefore I cannot use a normal 'upgrade is unlocked' check
                        {VARIABLE spartan_thrallbuff_enthrallII_2 yes}
                        {SPARTAN_APPLY_ENTHRALL_BUFFS_RETROACTIVELY 2}
                    [/then]
                    [else]
                        #using this hacky workaround with variables, since the upgrade is only actually set as unlocked AFTER upgrade effects are triggered, and therefore I cannot use a normal 'upgrade is unlocked' check
                        {VARIABLE spartan_thrallbuff_enthrallII_1 yes}
                        {SPARTAN_APPLY_ENTHRALL_BUFFS_RETROACTIVELY 1}
                    [/else]
                )}
            [/case]
            [case]
                value=enthrallIII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        #using this hacky workaround with variables, since the upgrade is only actually set as unlocked AFTER upgrade effects are triggered, and therefore I cannot use a normal 'upgrade is unlocked' check
                        {VARIABLE spartan_thrallbuff_enthrallIII_2 yes}
                        {SPARTAN_APPLY_ENTHRALL_BUFFS_RETROACTIVELY 2}
                    [/then]
                    [else]
                        #using this hacky workaround with variables, since the upgrade is only actually set as unlocked AFTER upgrade effects are triggered, and therefore I cannot use a normal 'upgrade is unlocked' check
                        {VARIABLE spartan_thrallbuff_enthrallIII_1 yes}
                        {SPARTAN_APPLY_ENTHRALL_BUFFS_RETROACTIVELY 1}
                    [/else]
                )}
            [/case]
            [case]
                value=enthrallIV
                {IF_VAR current_side_2 equals yes (
                    [then]
                        #using this hacky workaround with variables, since the upgrade is only actually set as unlocked AFTER upgrade effects are triggered, and therefore I cannot use a normal 'upgrade is unlocked' check
                        {VARIABLE spartan_thrallbuff_enthrallIV_2 yes}
                        {SPARTAN_APPLY_ENTHRALL_BUFFS_RETROACTIVELY 2}
                    [/then]
                    [else]
                        #using this hacky workaround with variables, since the upgrade is only actually set as unlocked AFTER upgrade effects are triggered, and therefore I cannot use a normal 'upgrade is unlocked' check
                        {VARIABLE spartan_thrallbuff_enthrallIV_1 yes}
                        {SPARTAN_APPLY_ENTHRALL_BUFFS_RETROACTIVELY 1}
                    [/else]
                )}
            [/case]
            #note: it is important that this ADDS to the limit instead of setting it, since Pact of Overlord increases the limit
            [case]
                value=enthrall_loyal
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_thrall_limit2 add 1}
                        {VARIABLE spartan_thrall_auto_loyal2 no}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_thrall_limit1 add 1}
                        {VARIABLE spartan_thrall_auto_loyal1 no}
                    [/else]
                )}
            [/case]
            [case]
                value=enthrall_loyalII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_thrall_limit2 add 1}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_thrall_limit1 add 1}
                    [/else]
                )}
            [/case]
            [case]
                value=enthrall_loyalIII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_thrall_limit2 add 1}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_thrall_limit1 add 1}
                    [/else]
                )}
            [/case]
            [case]
                value=enthrall_range
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE spartan_enthrall_range2 2}
                    [/then]
                    [else]
                        {VARIABLE spartan_enthrall_range1 2}
                    [/else]
                )}
            [/case]
            [case]
                value=patience
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_rest_energybonus2 10}

                        {IF_VAR side_number equals 2 (
                            [then]
                                [allow_end_turn]
                                [/allow_end_turn]
                            [/then]
                        )}
                    [/then]
                    [else]
                        {VARIABLE hoplite_rest_energybonus1 10}

                        {IF_VAR side_number equals 1 (
                            [then]
                                [allow_end_turn]
                                [/allow_end_turn]
                            [/then]
                        )}
                    [/else]
                )}
            [/case]
            [case]
                value=footwork
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_footwork_enabled2 yes}
                    [/then]
                    [else]
                        {VARIABLE hoplite_footwork_enabled1 yes}
                    [/else]
                )}
            [/case]
            [case]
                value=rest
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_rest_energybonus2 25}
                    [/then]
                    [else]
                        {VARIABLE hoplite_rest_energybonus1 25}
                    [/else]
                )}
            [/case]
            [case]
                value=restII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_rest_energybonus2 35}
                        {VARIABLE hoplite_rest_heal2 2}
                    [/then]
                    [else]
                        {VARIABLE hoplite_rest_energybonus1 35}
                        {VARIABLE hoplite_rest_heal1 2}
                    [/else]
                )}
            [/case]
            [case]
                value=restIII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_rest_energybonus2 50}
                        {VARIABLE hoplite_rest_heal2 3}
                    [/then]
                    [else]
                        {VARIABLE hoplite_rest_energybonus1 50}
                        {VARIABLE hoplite_rest_heal1 3}
                    [/else]
                )}
            [/case]
            [case]
                value=restIV
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_rest_energybonus2 75}
                        {VARIABLE hoplite_rest_heal2 4}
                    [/then]
                    [else]
                        {VARIABLE hoplite_rest_energybonus1 75}
                        {VARIABLE hoplite_rest_heal1 4}
                    [/else]
                )}
            [/case]
            [case]
                value=chameleon
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            #using $| instead of $ for variable substitution here, so it's not substituted instantly
                            [hides]
                                id=spartan_chameleon
                                name=_"chameleon"
                                female_name=_"female^chameleon"
                                description=_"This unit is invisible as long as it is not moving.

Enemy units cannot see this unit when it's standing on place, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
                                affect_self=yes
                                [filter]
                                    [filter_wml]
                                        moves=$|this_unit.max_moves
                                    [/filter_wml]
                                    [or]
                                        [not]
                                            side=$|hoplite_playerside
                                        [/not]
                                    [/or]
                                [/filter]
                            [/hides]
                        [/abilities]
                    [/effect]
                [/object]
                [redraw][/redraw]
            [/case]
            [case]
                value=swimming
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=movement_costs
                        replace=yes
                        [movement_costs]
                            shallow_water=1
                            swamp_water=1
                        [/movement_costs]
                    [/effect]
                    #commented out, since it is no longer necessary
                    #            [effect]
                    #               apply_to=new_ability
                    #               [abilities]
                    #                   {ABILITY_HOPLITE_SWIMMER}
                    #               [/abilities]
                    #            [/effect]
                [/object]
            [/case]
            [case]
                value=levitation
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=movement_costs
                        replace=yes
                        {SPARTAN_FLY_MOVESCOSTS}
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [standing_anim]
                            submerge=0.01
                            [frame]
                                duration=705
                                y=1:255,0:150,-1:150,0:150
                            [/frame]
                        [/standing_anim]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=artifacts

                [if]
                    [have_unit]
                        id=$hoplite_upgradeid
                        type=$spartan_artifact_unit_type1
                        [or]
                            id=$hoplite_upgradeid
                            type=$spartan_artifact_unit_type2
                        [/or]
                    [/have_unit]
                    [else]
                        [sound]
                            name=fanfare-short.wav
                        [/sound]
                        {IF_VAR current_side_2 equals yes (
                            [then]
                                [object]
                                    silent=yes
                                    duration=forever
                                    [filter]
                                        id=$hoplite_upgradeid
                                    [/filter]
                                    [effect]
                                        apply_to=type
                                        name=$spartan_artifact_unit_type2
                                    [/effect]
                                [/object]
                            [/then]
                            [else]
                                [object]
                                    silent=yes
                                    duration=forever
                                    [filter]
                                        id=$hoplite_upgradeid
                                    [/filter]
                                    [effect]
                                        apply_to=type
                                        name=$spartan_artifact_unit_type1
                                    [/effect]
                                [/object]
                            [/else]
                        )}
                        [object]
                            #            name="Spear of Ares"
                            name="Athena's Spear"
                            image=attacks/spear-ares.png
                            duration=forever
                            description= _ "Spear/Spear throw damage is increased by 5."
                            [filter]
                                id=$hoplite_upgradeid
                                #only show this if the unit has the right weapon
                                [has_attack]
                                    name=spear
                                [/has_attack]
                            [/filter]
                        [/object]
                        [object]
                            name="Ares' Blade"
                            image=attacks/shortsword-artemis.png
                            duration=forever
                            description= _ "Shortsword damage is increased by 3."
                            [filter]
                                id=$hoplite_upgradeid
                                #only show this if the unit has the right weapon
                                [has_attack]
                                    name=sword
                                [/has_attack]
                            [/filter]
                        [/object]
                        [object]
                            name="Hermes' Staff"
                            image=attacks/staff-hermes.png
                            duration=forever
                            description= _ "Staff damage is increased by 3."
                            [filter]
                                id=$hoplite_upgradeid
                                #only show this if the unit has the right weapon
                                [has_attack]
                                    name=staff
                                [/has_attack]
                            [/filter]
                        [/object]
                        [object]
                            name="Hephaestus' Platemail"
                            image=items/armor-golden.png
                            duration=forever
                            description= _ "Gain 20% to all resistances."
                            [filter]
                                id=$hoplite_upgradeid
                            [/filter]
                        [/object]
                    [/else]
                [/if]
            [/case]
            [case]
                value=book_of_pacts
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE hoplite_book_of_pacts_cooldown2 0}
                        {VARIABLE hoplite_book_of_pacts_cooldown_max2 5}
                        #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                    [/then]
                    [else]
                        {VARIABLE hoplite_book_of_pacts_cooldown1 0}
                        {VARIABLE hoplite_book_of_pacts_cooldown_max1 5}
                        #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                    [/else]
                )}
            [/case]
            [case]
                value=book_of_pactsII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_book_of_pacts_cooldown2 sub 1}
                        {VARIABLE hoplite_book_of_pacts_cooldown_max2 4}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_book_of_pacts_cooldown1 sub 1}
                        {VARIABLE hoplite_book_of_pacts_cooldown_max1 4}
                    [/else]
                )}
            [/case]
            [case]
                value=book_of_pactsIII
                {IF_VAR current_side_2 equals yes (
                    [then]
                        {VARIABLE_OP hoplite_book_of_pacts_cooldown2 sub 1}
                        {VARIABLE hoplite_book_of_pacts_cooldown_max2 3}
                    [/then]
                    [else]
                        {VARIABLE_OP hoplite_book_of_pacts_cooldown1 sub 1}
                        {VARIABLE hoplite_book_of_pacts_cooldown_max1 3}
                    [/else]
                )}
            [/case]
            [case]
                value=skill_ringfrost
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE ringfrost_damage1 10}
                ) (
                    {VARIABLE ringfrost_damage2 10}
                )}
            [/case]
            [case]
                value=ringfrostII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP ringfrost_damage1 add 5}
                ) (
                    {VARIABLE_OP ringfrost_damage2 add 5}
                )}
            [/case]
            [case]
                value=ringfrostIII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP ringfrost_damage1 add 5}
                ) (
                    {VARIABLE_OP ringfrost_damage2 add 5}
                )}
            [/case]
            [case]
                value=ringfrostIV
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP ringfrost_damage1 add 5}
                ) (
                    {VARIABLE_OP ringfrost_damage2 add 5}
                )}
            [/case]
            [case]
                value=spell_lightning
                #now this variable is set inside the targeted spell menu code
                #{HOPLITE_PLAYERFILTER1b (
                #    {VARIABLE lightning_bolt_damage1 10}
                #) (
                #    {VARIABLE lightning_bolt_damage2 10}
                #)}
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=new_attack
                        name=lightningbolt
                        description=_"lightning bolt"
                        type=fire
                        [specials]
                            [dummy]
                                id=hoplite_targeted_spell
                                name= _ "targeted spell"
                                description=_ "This attack is used via the targeted spells menu."
                            [/dummy]
                        [/specials]
                        range=ranged
                        damage=10
                        number=1
                        icon=attacks/lightning.png
                        attack_weight=0.0
                        defense_weight=0.0
                    [/effect]
                [/object]
            [/case]
            [case]
                value=lightningII
                #now this variable is set inside the targeted spell menu code
                #{HOPLITE_PLAYERFILTER1b (
                #    {VARIABLE_OP lightning_bolt_damage1 add 5}
                #) (
                #    {VARIABLE_OP lightning_bolt_damage2 add 5}
                #)}
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=lightningbolt
                        increase_damage=5
                    [/effect]
                [/object]
            [/case]
            [case]
                value=lightningIII
                #now this variable is set inside the targeted spell menu code
                #{HOPLITE_PLAYERFILTER1b (
                #    {VARIABLE_OP lightning_bolt_damage1 add 5}
                #) (
                #    {VARIABLE_OP lightning_bolt_damage2 add 5}
                #)}
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=lightningbolt
                        increase_damage=5
                    [/effect]
                [/object]
            [/case]
            [case]
                value=lightningIV
                #now this variable is set inside the targeted spell menu code
                #{HOPLITE_PLAYERFILTER1b (
                #    {VARIABLE_OP lightning_bolt_damage1 add 5}
                #) (
                #    {VARIABLE_OP lightning_bolt_damage2 add 5}
                #)}
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=lightningbolt
                        increase_damage=5
                    [/effect]
                [/object]
            [/case]
            [case]
                value=lightning_slow
                #this is for the spell menu:
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE lightning_bolt_extra_text1 _"and apply slow status to the target"}
                ) (
                    {VARIABLE lightning_bolt_extra_text2 _"and apply slow status to the target"}
                )}
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=lightningbolt
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_SLOW}
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=lightning_chain
                #this is for the spell menu:
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE lightning_bolt_chain_damagemult1 0.5}
                    {VARIABLE lightning_bolt_chain_text1 _"
    Chain lightning damages a random enemy adjacent to the target
    And keeps chaining as long as the chain damage would be at least 5"}
                ) (
                    {VARIABLE lightning_bolt_chain_damagemult2 0.5}
                    {VARIABLE lightning_bolt_chain_text2 _"
    Chain lightning damages a random enemy adjacent to the target
    And keeps chaining as long as the chain damage would be at least 5"}
                )}
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=lightningbolt
                        [set_specials]
                            mode=append
                            [dummy]
                                id=hoplite_chainlightning
                                name= _ "chain lightning"
                                description=_"Lightning Bolt now also hits a random enemy adjacent to the target. each bounce deals 50% of the previou damage. this effect keeps chaining as long as the chain attack would deal at least 5 damage."
                            [/dummy]
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=lightning_chainII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE lightning_bolt_chain_damagemult1 0.66}
                ) (
                    {VARIABLE lightning_bolt_chain_damagemult2 0.66}
                )}
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=lightningbolt
                        remove_specials=hoplite_chainlightning
                        [set_specials]
                            mode=append
                            [dummy]
                                id=hoplite_chainlightning2
                                name= _ "chain lightning II"
                                description=_"Lightning Bolt now also hits a random enemy adjacent to the target. each bounce deals 66% of the previou damage. this effect keeps chaining as long as the chain attack would deal at least 5 damage."
                            [/dummy]
                        [/set_specials]
                    [/effect]
                [/object]
            [/case]
            [case]
                value=spell_sandstorm
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE sandstorm_type1 Hoplite_Dust_Devil}
                    {VARIABLE sandstorm_type_text1 _"Dust Devil"}
                    {VARIABLE sandstorm_range1 3}
                ) (
                    {VARIABLE sandstorm_type2 Hoplite_Dust_Devil}
                    {VARIABLE sandstorm_type_text2 _"Dust Devil"}
                    {VARIABLE sandstorm_range2 3}
                )}
            [/case]
            [case]
                value=sandstormII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE_OP sandstorm_range1 add 1}
                ) (
                    {VARIABLE_OP sandstorm_range2 add 1}
                )}
            [/case]
            [case]
                value=sandstormIII
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE sandstorm_type1 Hoplite_Sand_Tornado}
                    {VARIABLE sandstorm_type_text1 _"Sand Tornado"}
                    {VARIABLE_OP sandstorm_range1 add 1}
                ) (
                    {VARIABLE sandstorm_type2 Hoplite_Sand_Tornado}
                    {VARIABLE sandstorm_type_text2 _"Sand Tornado"}
                    {VARIABLE_OP sandstorm_range2 add 1}
                )}
            [/case]
            #each Curse of Fear upgrade also fully-resets the cooldown, to avoid any weird edge cases for the UI if it didn't
            [case]
                value=spell_curse_fear
                #old code:
                #{HOPLITE_PLAYERFILTER1b (
                #    {VARIABLE curse_fear_cooldown1 0}
                #    {VARIABLE curse_fear_cooldown_text1 _"Ready"}
                #    {VARIABLE curse_fear_max_cooldown1 4}
                #    {VARIABLE curse_fear_range1 2}
                #    {VARIABLE curse_fear_icon_number1 1}#to show which horror-eerie icon to use
                #) (
                #    {VARIABLE curse_fear_cooldown2 0}
                #    {VARIABLE curse_fear_cooldown_text2 _"Ready"}
                #    {VARIABLE curse_fear_max_cooldown2 4}
                #    {VARIABLE curse_fear_range2 2}
                #    {VARIABLE curse_fear_icon_number2 1}#to show which horror-eerie icon to use
                #)}
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE curse_fear_cooldown1 0}
                    {VARIABLE curse_fear_max_cooldown1 3}
                    {VARIABLE curse_fear_max_charges1 2}
                    {VARIABLE curse_fear_charges1 $curse_fear_max_charges1}
                    {VARIABLE curse_fear_range1 2}
                    {VARIABLE curse_fear_icon_number1 1}#to show which horror-eerie icon to use
                    #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                ) (
                    {VARIABLE curse_fear_cooldown2 0}
                    {VARIABLE curse_fear_max_cooldown2 3}
                    {VARIABLE curse_fear_max_charges2 2}
                    {VARIABLE curse_fear_charges2 $curse_fear_max_charges2}
                    {VARIABLE curse_fear_range2 2}
                    {VARIABLE curse_fear_icon_number2 1}#to show which horror-eerie icon to use
                    #cooldown variable is added to the array in utils.cfg make sure to do the same for any newly-added cooldowns!
                )}
            [/case]
            [case]
                value=curse_fearII
                #{HOPLITE_PLAYERFILTER1b (
                #    {VARIABLE curse_fear_cooldown1 0}
                #    {VARIABLE curse_fear_cooldown_text1 _"Ready"}
                #    {VARIABLE curse_fear_max_cooldown1 3}
                #    {VARIABLE curse_fear_range1 3}
                #    {VARIABLE curse_fear_icon_number1 2}#to show which horror-eerie icon to use
                #) (
                #    {VARIABLE curse_fear_cooldown2 0}
                #    {VARIABLE curse_fear_cooldown_text2 _"Ready"}
                #    {VARIABLE curse_fear_max_cooldown2 3}
                #    {VARIABLE curse_fear_range2 3}
                #    {VARIABLE curse_fear_icon_number2 2}#to show which horror-eerie icon to use
                #)}
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE curse_fear_cooldown1 0}
                    {VARIABLE curse_fear_max_charges1 3}
                    {VARIABLE curse_fear_charges1 $curse_fear_max_charges1}
                    {VARIABLE curse_fear_range1 3}
                    {VARIABLE curse_fear_icon_number1 2}#to show which horror-eerie icon to use
                ) (
                    {VARIABLE curse_fear_cooldown2 0}
                    {VARIABLE curse_fear_max_charges2 3}
                    {VARIABLE curse_fear_charges2 $curse_fear_max_charges1}
                    {VARIABLE curse_fear_range2 3}
                    {VARIABLE curse_fear_icon_number2 2}#to show which horror-eerie icon to use
                )}

            [/case]
            [case]
                value=curse_fearIII
                #{HOPLITE_PLAYERFILTER1b (
                #    {VARIABLE curse_fear_cooldown1 0}
                #    {VARIABLE curse_fear_cooldown_text1 _"Ready"}
                #    {VARIABLE curse_fear_max_cooldown1 2}
                #    {VARIABLE curse_fear_range1 4}
                #    {VARIABLE curse_fear_icon_number1 3}#to show which horror-eerie icon to use
                #) (
                #    {VARIABLE curse_fear_cooldown2 0}
                #    {VARIABLE curse_fear_cooldown_text2 _"Ready"}
                #    {VARIABLE curse_fear_max_cooldown2 2}
                #    {VARIABLE curse_fear_range2 4}
                #    {VARIABLE curse_fear_icon_number2 3}#to show which horror-eerie icon to use
                #)}
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE curse_fear_cooldown1 0}
                    {VARIABLE curse_fear_max_charges1 4}
                    {VARIABLE curse_fear_charges1 $curse_fear_max_charges1}
                    {VARIABLE curse_fear_max_cooldown1 2}
                    {VARIABLE curse_fear_range1 4}
                    {VARIABLE curse_fear_icon_number1 3}#to show which horror-eerie icon to use
                ) (
                    {VARIABLE curse_fear_cooldown2 0}
                    {VARIABLE curse_fear_max_charges1 4}
                    {VARIABLE curse_fear_charges1 $curse_fear_max_charges1}
                    {VARIABLE curse_fear_max_cooldown2 2}
                    {VARIABLE curse_fear_range2 4}
                    {VARIABLE curse_fear_icon_number2 3}#to show which horror-eerie icon to use
                )}
            [/case]
            [case]
                value=curse_fearIV
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE curse_fear_cooldown1 0}
                    {VARIABLE curse_fear_charges1 $curse_fear_max_charges1}
                    {VARIABLE curse_fear_max_cooldown1 1}
                ) (
                    {VARIABLE curse_fear_cooldown2 0}
                    {VARIABLE curse_fear_charges1 $curse_fear_max_charges1}
                    {VARIABLE curse_fear_max_cooldown2 1}
                )}
            [/case]
            [case]
                value=curse_fearV
                {HOPLITE_PLAYERFILTER1b (
                    {VARIABLE curse_fear_cooldown1 0}
                    {VARIABLE curse_fear_max_charges1 6}
                    {VARIABLE curse_fear_charges1 $curse_fear_max_charges1}
                ) (
                    {VARIABLE curse_fear_cooldown2 0}
                    {VARIABLE curse_fear_max_charges2 6}
                    {VARIABLE curse_fear_charges1 $curse_fear_max_charges1}
                )}
            [/case]
            [case]
                value=reaper_favorI
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                [/object]
                {SPARTAN_INCREASE_MAX_ENERGY_IN_UPGRADE 50}
                [object]
                    name="Reaper's Favor"
                    image=icons/protect-magenta-2.png
                    duration=forever
                    description= _ "+10 max hitpoints, +50 max energy, unlocks new upgrades"
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                [/object]
            [/case]
            [case]
                value=reaper_favorII
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                    [effect]
                        apply_to=hitpoints
                        increase=10
                        increase_total=10
                    [/effect]
                [/object]
                {SPARTAN_INCREASE_MAX_ENERGY_IN_UPGRADE 50}
                [object]
                    name="Reaper's Favor II"
                    image=icons/protect-magenta-3.png
                    duration=forever
                    description= _ "+10 max hitpoints, +50 max energy, unlocks new upgrades"
                    [filter]
                        id=$hoplite_upgradeid
                    [/filter]
                [/object]
            [/case]
            [case]
                value=reaper_harvest
                #this is a shared upgrade
                {VARIABLE reaper_harvest_counter 0}
                {VARIABLE reaper_harvest_levels_requirement 5}
            [/case]
            [case]
                value=reaper_harvestII
                #this is a shared upgrade
                {VARIABLE reaper_harvest_nightgaunt_counter 0}
                {VARIABLE reaper_harvest_nightgaunt_levels_requirement 20}
            [/case]
            [case]
                value=reaper_harvestIII
                #this is a shared upgrade
                {VARIABLE reaper_harvest_levels_requirement 4}
                {VARIABLE reaper_harvest_nightgaunt_levels_requirement 16}
            [/case]
            [case]
                value=reaper_harvestIV
                #this is a shared upgrade
                {VARIABLE reaper_harvest_levels_requirement 3}
                {VARIABLE reaper_harvest_nightgaunt_levels_requirement 12}
            [/case]
        [/switch]

        {FORGE_EFFECT_END $tmp_forge_upgrade_id|}

        {CLEAR_VARIABLE tmp_forge_upgrade_id}
    [/event]
#enddef

#TODO: make this macro support shared upgrades later
#define SPARTAN_ADD_UPGRADES_MANUALLY_NON_SHARED SIDE UPGRADES
    {VARIABLE tmp_manualupgrade_test_side {SIDE}}

    {IF_VAR tmp_manualupgrade_test_side equals 2 (
        [then]
            {VARIABLE current_side_2 yes}
        [/then]
    )}

    {CLEAR_VARIABLE tmp_manualupgrade_test_side}

    [set_variables]
        name=tmp_added_upgrades_list
        [split]
            list={UPGRADES}
            key=id
            separator=,
        [/split]
    [/set_variables]
    {VARIABLE tmp_spartan_no_upgrade_sound_or_delay yes}
    {VARIABLE spartan_upgrade_without_forge yes}#normal forge can still be used after this
    [foreach]
        array=tmp_added_upgrades_list
        index_var=i
        [do]
            {VARIABLE tmp_forge_upgrade_id $this_item.id}
            #SHARED UPGRADES NOT YET SUPPORTED!!!
            #            {VARIABLE tmp_forge_upgrade_is_shared yes}
            [fire_event]
                id=spartan_forge_effect_event
            [/fire_event]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE tmp_added_upgrades_list,tmp_spartan_no_upgrade_sound_or_delay,spartan_upgrade_without_forge}
    {CLEAR_VARIABLE current_side_2}
#enddef
