#textdomain wesnoth-Hoplite

#define ORBSHOP_OPTION_PER_PLAYER ID TEXT IMAGE COST EXTRA_CONDITIONS EFFECT
    [option]
        image={IMAGE}
        description={TEXT}
        [show_if]
            {VARIABLE_CONDITIONAL {ID}_taken$side_number not_equals yes}#can only take it once per shop depth per player
            [and]
                {EXTRA_CONDITIONS}
            [/and]
        [/show_if]
        [command]
            {IF_VAR spartan_orbs_of_insight$side_number| greater_than_equal_to {COST} (
                [then]
                    {VARIABLE_OP spartan_orbs_of_insight$side_number| sub {COST}}
                    {VARIABLE_OP spartan_orbshop_data$side_number|.orbs_spent add {COST}}
                    {SPARTAN_SYNC_ORBSHOP_DATA}
                    {EFFECT}
                    {VARIABLE {ID}_taken$side_number yes}
                    [set_variables]
                        name=spartan_taken_shop_items
                        mode=append
                        [value]
                            var={ID}_taken$side_number#for mentioning duration in info menu, use something like $$array[0].var||
                        [/value]
                    [/set_variables]
                    {VARIABLE favorite_customer_progress$side_number $spartan_orbshop_data$side_number|.orbs_spent}
                    {IF_VAR favorite_customer_progress$side_number greater_than_equal_to 10 (
                        [then]
                            {ACHIEVEMENT_MESSAGE_LONE favorite_customer $side_number}
                        [/then]
                    )}
                [/then]
                [else]
                    [message]
                        speaker=merchant
                        message=_"Unfortunately you do not have enough orbs to buy this."
                    [/message]
                [/else]
            )}
        [/command]
    [/option]
#enddef

#define ORBSHOP_OPTION_SHARED ID TEXT IMAGE COST EXTRA_CONDITIONS EFFECT
    [option]
        image={IMAGE}
        description={TEXT}
        [show_if]
            {VARIABLE_CONDITIONAL {ID}_taken not_equals yes}#can only take it once per shop depth
            [and]
                {EXTRA_CONDITIONS}
            [/and]
        [/show_if]
        [command]
            {IF_VAR spartan_orbs_of_insight$side_number| greater_than_equal_to {COST} (
                [then]
                    {VARIABLE_OP spartan_orbs_of_insight$side_number| sub {COST}}
                    {VARIABLE_OP spartan_orbshop_data$side_number|.orbs_spent add {COST}}
                    {SPARTAN_SYNC_ORBSHOP_DATA}
                    {EFFECT}
                    {VARIABLE {ID}_taken yes}
                    [set_variables]
                        name=spartan_taken_shop_items
                        mode=append
                        [value]
                            var={ID}_taken#for mentioning duration in info menu, use something like $$array[0].var||
                        [/value]
                    [/set_variables]
                    {VARIABLE favorite_customer_progress$side_number $spartan_orbshop_data$side_number|.orbs_spent}
                    {IF_VAR favorite_customer_progress$side_number greater_than_equal_to 10 (
                        [then]
                            {ACHIEVEMENT_MESSAGE_LONE favorite_customer $side_number}
                        [/then]
                    )}
                [/then]
                [else]
                    [message]
                        speaker=merchant
                        message=_"Unfortunately you do not have enough orbs to buy this."
                    [/message]
                [/else]
            )}
        [/command]
    [/option]
#enddef

#define SPARTAN_PACT_OPTION ID DURATION NAME IMAGE DETAILED_DESCRIPTION EXTRA_CONDITIONS EFFECT
    [option]
        image={IMAGE}
        description={NAME}
        [show_if]
            [not]
                {VARIABLE_CONDITIONAL {ID} greater_than 0}#cannot re-apply a pact you already have
            [/not]
            [and]
                {EXTRA_CONDITIONS}
            [/and]
        [/show_if]
        [command]
            {IF_VAR tmp_book_of_pacts_menu equals yes (
                [then]
                    {VARIABLE tmp_pact_speaker narrator}
                [/then]
                [else]
                    {VARIABLE tmp_pact_speaker merchant}
                [/else]
            )}

            [message]
                speaker=$tmp_pact_speaker
#ifdef MULTIPLAYER
                message={DETAILED_DESCRIPTION}_"

Do you want to pick this pact? (The pact's effects apply to both hoplites, and the other player has to agree to taking the pact too.)"
#else
                message={DETAILED_DESCRIPTION}_"

Do you want to pick this pact?"
#endif
                [option]
                    description=_"No"
                    image=attacks/blank-attack.png
                    [command]
                    [/command]
                [/option]
                [option]
                    description=_"Yes"
                    image=attacks/blank-attack.png
                    [command]
                        {VARIABLE tmp_orbshop_pact_confirmed yes}
                    [/command]
                [/option]
            [/message]
#ifdef MULTIPLAYER
            [if]
                {VARIABLE_CONDITIONAL tmp_orbshop_pact_confirmed equals yes}
                [then]
                    [store_unit]
                        [filter]
                            side=$hoplite_playerside
                            [not]
                                side=$side_number
                            [/not]
                        [/filter]
                        variable=tmp_spartan_otherplayer
                        kill=no
                    [/store_unit]
                    [message]
                        speaker=$tmp_pact_speaker
                        side_for=$tmp_spartan_otherplayer.side
                        message={DETAILED_DESCRIPTION}_"

The other hoplite wants to take this pact, do you agree to taking it too? (The effects apply to both of you)"
                        [option]
                            description=_"No"
                            image=attacks/blank-attack.png
                            [command]
                                {VARIABLE tmp_orbshop_pact_confirmed no}
                            [/command]
                        [/option]
                        [option]
                            description=_"Yes"
                            image=attacks/blank-attack.png
                            [command]
                                {VARIABLE tmp_orbshop_pact_confirmed yes}
                            [/command]
                        [/option]
                    [/message]
                    {CLEAR_VARIABLE tmp_spartan_otherplayer}
                [/then]
            [/if]
#endif
            [if]
                {VARIABLE_CONDITIONAL tmp_orbshop_pact_confirmed equals yes}
                [then]
                    {EFFECT}
                    {VARIABLE {ID} {DURATION}}
                    {IF_VAR tmp_book_of_pacts_menu equals yes (
                        [then]
                            {VARIABLE tmp_spartan_pact_taken_from_book yes}
                        [/then]
                        [else]
                            #variable to prevent taking multiple pacts per shop
                            {VARIABLE spartan_pact_taken yes}
                        [/else]
                    )}
                    [set_variables]
                        name=spartan_activepacts
                        mode=append
                        [value]
                            var={ID}#for mentioning duration in info menu, use something like $$spartan_activepacts[0].var||
                            name={NAME}
                            image={IMAGE}
                            descr={DETAILED_DESCRIPTION}
                        [/value]
                    [/set_variables]
                    {CLEAR_VARIABLE spartan_orbshop_menu}
                    [print]
                        text= _ "Pact taken"
                        size=30
                        red=150
                        blue=200
                        duration=2000
                    [/print]
                    {ACHIEVEMENT_MESSAGE_LONE pactI $side_number}
                [/then]
                [elseif]
                    {VARIABLE_CONDITIONAL tmp_orbshop_pact_confirmed equals no}
                    [then]
                        [message]
                            id=Hoplite,Hoplite2
                            [not]
                                side=$side_number
                            [/not]
                            message=_"I don't think we should take this pact."
                        [/message]
                        {IF_VAR tmp_book_of_pacts_menu equals yes (
                            [else]
                                [message]
                                    speaker=merchant
                                    message=_"Alright, perhaps a different one would be of interest to you?"
                                [/message]
                            [/else]
                        )}
                    [/then]
                [/elseif]
                [else]
                [/else]
            [/if]
            {CLEAR_VARIABLE tmp_orbshop_pact_confirmed}
        [/command]
    [/option]
#enddef

#used for both orb shop, and Book of Pacts

# wmlindent: start ignoring
#define SPARTAN_PACT_OPTIONS
    #NOTE: ID matches pact variable here
    {SPARTAN_PACT_OPTION spartan_pact_forbidden_knowledge 3 _"Forbidden Knowledge" icons/book2.png _"Forbidden Knowledge:
<span color='#99ff66'>-gain 1 orb of insight</span>
<span color='#ff6666'>-some ghost enemies will spawn on the next 3 depths</span>" () (
    [sound]
        name=magic-dark-big.ogg
    [/sound]
    [sound]
        name={SOUND_LIST:LICH_HIT}
    [/sound]
    {SPARTAN_ADD_INSIGHT_ORB_WITH_POPUP}
)}
#TODO: add different icon for pact of patience
{SPARTAN_PACT_OPTION spartan_pact_patience 3 _"Pact of Patience" icons/book2.png _"Pact of Patience:
<span color='#99ff66'>-after 3 depths, instantly gain 4 forge upgrades</span>
<span color='#ff6666'>-the next 3 depths have no forges</span>
(Golden Forges are downgraded by 1 instead of being removed
So a forge that would give 2 upgrades just gives 1 instead, becoming a normal forge)" () (
[sound]
    name=magic-dark-big.ogg
[/sound]
[sound]
    name={SOUND_LIST:LICH_HIT}
[/sound]
#no longer used, the pact now reduces forge_value in level_generation.cfg instead
#{VARIABLE_OP forge_delay sub 3}

)}

#TODO: add different icon:
{SPARTAN_PACT_OPTION spartan_pact_wrath 5 _"Pact of Wrath" icons/book2.png _"Pact of Wrath:
<span color='#99ff66'>-damage of your attacks is increased by 66% (refreshes each turn)</span>
<span color='#ff6666'>-your resistances to all damage types are reduced by 50%</span>
-the pact lasts for the next 5 depths" () (
    [sound]
        name=magic-dark-big.ogg
    [/sound]
    [sound]
        name={SOUND_LIST:LICH_HIT}
    [/sound]
    {VARIABLE pact_wrath_active_thisdepth yes}
    [fire_event]
        id=spartan_pact_wrath_effect
    [/fire_event]
)}

#TODO: add different icon:
{SPARTAN_PACT_OPTION spartan_pact_pacifist 5 _"Persuasive Pacifist" icons/book2.png _"Persuasive Pacifist:
<span color='#99ff66'>-at the start of each depth, 33% (rounded up) of enemies become your allies</span>
<span color='#ff6666'>-you are unable to attack</span>
-the pact lasts for the next 5 depths
-pact has no effect in boss depths" () (
    [sound]
        name=magic-dark-big.ogg
    [/sound]
    [sound]
        name={SOUND_LIST:LICH_HIT}
    [/sound]
)}

#TODO: add different icon:
#TODO: maybe rework lightweight's energy from flat 20 to 15% of max, so it scales better in late-game (might need to nerf to 15 flat or 10% later tho)
{SPARTAN_PACT_OPTION spartan_pact_lightweight 5 _"Lightweight" icons/book2.png _"Lightweight:
<span color='#99ff66'>-you gain 1 more movement</span>
<span color='#99ff66'>-recover 20 energy each turn</span>
<span color='#ff6666'>-your max hp is reduced by 40%</span>
-the pact lasts for the next 5 depths" () (
    [sound]
        name=magic-dark-big.ogg
    [/sound]
    [sound]
        name={SOUND_LIST:LICH_HIT}
    [/sound]
    [object]
        silent=yes
        duration=forever
        id=pact_lightweight
        take_only_once=no
        [filter]
            id=Hoplite
        [/filter]
        [effect]
            apply_to=movement
            increase=1
        [/effect]
        [effect]
            apply_to=hitpoints
            increase=-40%
            increase_total=-40%
        [/effect]
    [/object]
#ifdef MULTIPLAYER
    [object]
        silent=yes
        duration=forever
        id=pact_lightweight
        take_only_once=no
        [filter]
            id=Hoplite2
        [/filter]
        [effect]
            apply_to=movement
            increase=1
        [/effect]
        [effect]
            apply_to=hitpoints
            increase=-40%
            increase_total=-40%
        [/effect]
    [/object]
#endif
)}

{SPARTAN_PACT_OPTION spartan_pact_storm 3 _"Pact of Storm" icons/book2.png _"Pact of Storm:
<span color='#99ff66'>-every turn, all enemies get pushed (like lesser knockback) 1 tile up</span>
<span color='#ff6666'>-you and all allies are pushed too</span>
-the pact lasts for the next 3 depths" () (
[sound]
    name=magic-dark-big.ogg
[/sound]
[sound]
    name={SOUND_LIST:LICH_HIT}
[/sound]
{VARIABLE pact_storm_active_thisdepth yes}
)}

#the "???" downside means "cannot get true ending due to becoming the Merchant's puppet" and also some changes to the main ending
#TODO: make sure to actually code the true ending restriction later!!!
 #though on second thought, sparing Galatea will be needed for the ending, while the bad ending auto-kills her, so the code might be fine as is

{SPARTAN_PACT_OPTION spartan_pact_overlord 9999 _"<span color='#a456ff'>Pact of Overlord</span>" icons/book2.png _"Pact of Overlord:
<span color='#99ff66'>-damage of your attacks is increased by 66% (refreshes each turn, DOES stack with Pact of Wrath)</span>
<span color='#99ff66'>-your max hp is increased by 100</span>
<span color='#99ff66'>-your max energy is increased by 200</span>
<span color='#99ff66'>-at the start of each non-boss depth, 33% (rounded up) of enemies become your allies (does NOT stack with Persuasive Pacifist)</span>
<span color='#99ff66'>-if you have the Loyal Thrall upgrade, increase loyal thrall limit by 3</span>
<span color='#ff6666'>-costs 40 orbs of insight (in multiplayer, only the person who selected the pact pays this cost)</span>
<span color='#ff6666'>-any orbs of insight taken while this pact is active are immediately taken by the Merchant</span>
<span color='#ff6666'>-???</span>
-the pact lasts for the whole playthrough" (
    {VARIABLE_CONDITIONAL spartan_orbs_of_insight$side_number| greater_than_equal_to 40}
    #only allow taking this pact if players already saw the main ending first, and this way they can't just grind early bosses for orbs over and over to get the pact first
    [and]
        {VARIABLE_CONDITIONAL victory_complete$side_number| equals yes}
    [/and]
    [and]
        {VARIABLE_CONDITIONAL bossfight not_equals yes}
    [/and]
) (
    {VARIABLE_OP spartan_orbs_of_insight$side_number| sub 40}
    {VARIABLE_OP spartan_orbshop_data$side_number|.orbs_spent add 40}
    {HOPLITE_SYNC_ORBS_OF_INSIGHT_TO_GLOBAL_VAR}
    {SPARTAN_SYNC_ORBSHOP_DATA}

[sound]
    name=magic-dark-big.ogg
[/sound]
[sound]
    name={SOUND_LIST:LICH_HIT}
[/sound]
    [object]
        silent=yes
        duration=forever
        id=pact_overlord
        take_only_once=no
        [filter]
            id=Hoplite
        [/filter]
        [effect]
            apply_to=hitpoints
            increase=100
            increase_total=100
        [/effect]
        #scrapped for now
        ##purple tint
        #[effect]
        #    apply_to=image_mod
        #    replace="BLEND(105,00,180,0.25)"
        #[/effect]
    [/object]
    {VARIABLE_OP hoplite_energy1 add 200}
    {VARIABLE_OP hoplite_maxenergy1 add 200}
    {VARIABLE_OP hoplite_thrall_limit1 add 3}
#ifdef MULTIPLAYER
    [object]
        silent=yes
        duration=forever
        id=pact_overlord
        take_only_once=no
        [filter]
            id=Hoplite2
        [/filter]
        [effect]
            apply_to=hitpoints
            increase=100
            increase_total=100
        [/effect]
        #scrapped for now
        ##purple tint
        #[effect]
        #    apply_to=image_mod
        #    replace="BLEND(105,00,180,0.25)"
        #[/effect]
    [/object]
    {VARIABLE_OP hoplite_energy2 add 200}
    {VARIABLE_OP hoplite_maxenergy2 add 200}
    {VARIABLE_OP hoplite_thrall_limit2 add 3}
#endif
    #setting it to 9999 here so that the variable is set before the event is triggered, then the macro sets it to 9999 again anyway due to the macro param
    {VARIABLE spartan_pact_overlord 9999}
    [fire_event]
        id=spartan_pact_overlord_damage_effect
    [/fire_event]
    {ACHIEVEMENT_MESSAGE pact_overlord}

)}
#added this restrictions to prevent Pact of Overlord being taken during the Galatea bossfight, potentially skipping some overlord-exclusive dialog/ending in the process
    [option]
        image="icons/book2.png~SEPIA()~BLIT(icons/locked.png)"
        description=_"(cannot take this pact during boss fights)"
        [show_if]
            {VARIABLE_CONDITIONAL spartan_pact_overlord_taken$side_number not_equals yes}
            [and]
                {VARIABLE_CONDITIONAL victory_complete$side_number| equals yes}
            [/and]
            [and]
                {VARIABLE_CONDITIONAL bossfight equals yes}
            [/and]
        [/show_if]
        [command]
        [/command]
    [/option]

#TODO: add more pacts
#enddef
# wmlindent: stop ignoring

#define SPARTAN_GENERATE_ACTIVE_PACT_OPTIONS
    [foreach]
        array=spartan_activepacts
        index_var=i
        [do]
            [set_variables]
                name=spartan_activepact_options
                mode=append
                [value]
                    image=$this_item.image
                    description=$this_item.name|
                    #            [show_if]
                    #                {VARIABLE_CONDITIONAL $this_item.id|_hintunlocked$side_number equals yes}
                    #            [/show_if]
                    [command]
                        [message]
                            speaker=narrator
                            caption=$this_item.name
                            image="portraits/book.png~GS()~BLEND(0,0,0,0.4)"
                            message=$this_item.descr|+_"

This pact has $$this_item.var|| depths left"
                        [/message]
                    [/command]
                [/value]
            [/set_variables]
        [/do]
    [/foreach]
#enddef

#define SPARTAN_CLEAR_ACTIVEPACT VAR
    [foreach]
        array=spartan_activepacts
        index_var=i
        [do]
            {IF_VAR this_item.var equals {VAR} (
                [then]
                    {VARIABLE tmp_delectpact_index $i}
                    [break][/break]#no need to continue the loop after the pact is found
                    #commented out for now
                    #        {CLEAR_VARIABLE $this_item.var}#pact duration variable is no longer needed now
                [/then]
            )}
        [/do]
    [/foreach]
    {IF_VAR tmp_delectpact_index not_equals $emptyvar (
        [then]
            {CLEAR_VARIABLE spartan_activepacts[$tmp_delectpact_index]}
            {CLEAR_VARIABLE tmp_delectpact_index}
        [/then]
    )}
#enddef

#define HOPLITE_ORB_SHOP_EVENTS
    [event]
        name=moveto
        id=spartan_orbshop
        first_time_only=no
        [filter]
            side=$hoplite_playerside
            [filter_location]
                [filter]
                    id=merchant
                [/filter]
                radius=1
            [/filter_location]
        [/filter]
        {VARIABLE spartan_orbshop_menu yes}
        [while]
            {VARIABLE_CONDITIONAL spartan_orbshop_menu equals yes}
            [do]
                [message]
                    speaker=merchant
                    message=_"What do you want to buy?

(You currently have <span color='#a456ff'>$spartan_orbs_of_insight$side_number|| Orbs of Insight</span>, carries over between playthroughs)"
                    [option]
                        image="misc/red-x.png"
                        description=_"Return to the Game"
                        [command]
                            {CLEAR_VARIABLE spartan_orbshop_menu}
                        [/command]
                    [/option]
                    {ORBSHOP_OPTION_PER_PLAYER orbshop_energy _"+15 max energy - costs <span color='#a456ff'>1 orb of insight</span>" "icons/boots_elven.png" 1 () (
                    [sound]
                        name=magic-faeriefire.ogg
                    [/sound]
                    #            {SPARTAN_INCREASE_MAX_ENERGY_IN_UPGRADE 15}
                    {VARIABLE_OP hoplite_energy$side_number add 15}
                    {VARIABLE_OP hoplite_maxenergy$side_number add 15}
                )}
                #TODO: maybe add some custom summons too, instead of just reusing powerful enemies
                {ORBSHOP_OPTION_SHARED summon_stormtide _"Summon a loyal Stormtide Demon - costs <span color='#a456ff'>1 orb of insight</span>
    (stays with you in later depths until killed)" "units/demons/storm.png~RC(magenta>green)" 1 () (
                [sound]
                    name=magic-faeriefire.ogg
                [/sound]
                {UNIT $hoplite_allyside (Hoplite_Demonstorm) 4 5 (
                    placement=map
                    passable=yes
                    generate_name=yes
                    random_gender=yes
                    [modifications]
                        {TRAIT_LOYAL}
                    [/modifications]
                )}
            )}
            {ORBSHOP_OPTION_SHARED summon_lich _"Summon a loyal Lich - costs <span color='#a456ff'>2 orbs of insight</span>
    (stays with you in later depths until killed)" "units/undead-necromancers/lich.png~RC(magenta>green)" 2 (
            {VARIABLE_CONDITIONAL hoplite_depth greater_than_equal_to 15}
            [or]
                {VARIABLE_CONDITIONAL hoplite_depth less_than_equal_to 0}
            [/or]
        ) (
            [sound]
                name=magic-faeriefire.ogg
            [/sound]
            {UNIT $hoplite_allyside (Hoplite_Lich) 4 5 (
                placement=map
                passable=yes
                generate_name=yes
                random_gender=yes
                [modifications]
                    {TRAIT_LOYAL}
                [/modifications]
            )}
        )}
        {ORBSHOP_OPTION_SHARED summon_ferrous_titan _"Summon a loyal Ferrous Titan - costs <span color='#a456ff'>2 orbs of insight</span>
    (stays with you in later depths until killed)" "units/human-loyalists/siegetrooper.png~BLEND(160,82,45,0.3)~CS(-35,-35,-35)~RC(magenta>green)" 2 (
        {VARIABLE_CONDITIONAL hoplite_depth greater_than_equal_to 20}
        [or]
            {VARIABLE_CONDITIONAL hoplite_depth less_than_equal_to 0}
        [/or]
    ) (
        [sound]
            name=magic-faeriefire.ogg
        [/sound]
        {UNIT $hoplite_allyside (Hoplite_Ferrous_Titan) 4 5 (
            placement=map
            passable=yes
            generate_name=yes
            random_gender=yes
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        )}
    )}
    {ORBSHOP_OPTION_PER_PLAYER book_of_pacts _"Book of Pacts - gain a skill to choose a pact anywhere. has a 5-depth cooldown
Can be upgraded at the forge
costs <span color='#a456ff'>7 orbs of insight</span>" "icons/book2.png" 7 (
    {VARIABLE_CONDITIONAL book_of_pacts_unlocked$side_number not_equals yes}#can only take it once per shop depth per player
    [and]
        {VARIABLE_CONDITIONAL hoplite_depth greater_than_equal_to 10}
        [or]
            {VARIABLE_CONDITIONAL hoplite_depth less_than_equal_to 0}
        [/or]
    [/and]
) (
    [sound]
        name=magic-faeriefire.ogg
    [/sound]
    {SPARTAN_ADD_UPGRADES_MANUALLY_NON_SHARED $side_number book_of_pacts}
)}

#shop ideas:
#maybe some very expensive permanent upgrades that carry over between playthroughs, for example:
# Chronos Forge: each new playthrough, start with 1 extra forge upgrade - costs 10 orbs (in multiplayer, only affects the specific player that bought it)
# consider changing starting depths so that they (except sandbox start) need to be bought in the orb shop, maybe like this:
#depth 11 start: costs 2 orbs, requires being at depth 11 or above in the shop
#depth 21 start: costs 3 orbs, requires being at depth 21 or above in the shop, and buying the previous start
#underworld start: costs 4 orbs, requires being at depth 31 or above or in underworld in the shop, and buying the previous start
#depth 31 start: costs 5 orbs, requires being at depth 31 or above in the shop, and buying the previous start
#depth 41 start: costs 7 orbs, requires being at depth 41 or above in the shop, and buying the previous start
#maybe a single-use consumable healing item
#Zeus Lightning in orb shop (exact stats decided by me): -"use rightclick menu to select a tile anywhere on the map, deals 30 damage and slows enemies in a 1-tile radius from that tile, costs 1 orb"
#-note: for animation I could use the lvl3 thunder shaman aoe attack from GSE, just remove purple color from lightning

[option]
    image=icons/book2.png
    description=_"Pacts"
    [command]
        [if]
            {VARIABLE_CONDITIONAL spartan_pact_taken equals yes}
            [then]
                [message]
                    #        speaker=pact_dealer
                    speaker=merchant
                    message=_"I can't offer you another pact yet... If we meet again you can have another one."
                [/message]
            [/then]
            [else]
                #TODO: maybe instead of all pacts being available at once, maybe make the dealer choose 3-5 pacts at random

                [message]
                    #        speaker=pact_dealer
                    speaker=merchant
                    message=_"Choose a pact..."
                    [option]
                        image="misc/red-x.png"
                        description=_"Return to the shop"
                        [command]
                        [/command]
                    [/option]
                    {SPARTAN_PACT_OPTIONS}
                [/message]
            [/else]
        [/if]
    [/command]
[/option]
[/message]
[/do]
[/while]
[/event]
#pact dealer got removed for now, since it was difficult to fit him into dialog
#[event]
#    name=moveto
#    id=spartan_pacts
#    first_time_only=no
#    [filter]
#        side=$hoplite_playerside
#        [filter_location]
#            [filter]
#                id=pact_dealer
#            [/filter]
#            radius=1
#        [/filter_location]
#    [/filter]
#[/event]
[event]
    id=hoplite_depthdescent_pacteffects
    first_time_only=no
    [foreach]
        array=spartan_taken_shop_items
        index_var=i
        [do]
            {CLEAR_VARIABLE $this_item.var}
        [/do]
    [/foreach]
    {CLEAR_VARIABLE spartan_taken_shop_items}

    #to avoid running more code than necessary if there are no pacts taken whatsoever

    {CLEAR_VARIABLE spartan_pact_taken}
    {CLEAR_VARIABLE pacifist_debuff_active_thisdepth}
    {CLEAR_VARIABLE pact_wrath_active_thisdepth}
    {CLEAR_VARIABLE pact_storm_active_thisdepth}

    [if]
        {VARIABLE_CONDITIONAL spartan_activepacts.length greater_than 0}
        [then]
            #important: this must go into negative values, otherwise the patience effect will trigger over and over sometimes
            {IF_VAR spartan_pact_patience greater_than -1 (
                [then]
                    {VARIABLE_OP spartan_pact_patience sub 1}
                [/then]
            )}

            {IF_VAR spartan_pact_patience equals 0 (
                [then]
                    [message]
                        speaker=narrator
                        caption=_"???"
                        message=_"Now, as agreed in our pact, here are your upgrades..."
                        image="portraits/cloaked2.png~BLEND(0,0,0,1)~O(50%)"
                    [/message]

                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                            {VARIABLE hoplite_upgradesleft1 4}
                            {VARIABLE hoplite_upgradesleft2 4}
                        [/then]
                        [else]
                            {VARIABLE hoplite_upgradesleft 4}
                        [/else]
                    [/if]

                    {VARIABLE spartan_upgrade_without_forge yes}#normal forge can still be used after pact upgrade
                    {IF_VAR bossfight equals yes (
                        [then]
                            #workaround to make sure upgrades can still be taken at the start of a boss fight with the pact
                            {VARIABLE bossfight no}
                            [fire_event]
                                id=forge_dialog
                            [/fire_event]
                            {VARIABLE bossfight yes}
                        [/then]
                        [else]
                            [fire_event]
                                id=forge_dialog
                            [/fire_event]
                        [/else]
                    )}
                    {CLEAR_VARIABLE spartan_upgrade_without_forge}
                    {SPARTAN_CLEAR_ACTIVEPACT spartan_pact_patience}
                [/then]
            )}
            #no effect in in shop depths
            {IF_VAR spartan_pact_forbidden_knowledge greater_than 0 (
                [then]
                    [if]
                        {VARIABLE_CONDITIONAL hoplite_biome not_equals rarebiome_mysterious_shop}
                        [then]
                            #for scatter units, the unit list is in order instead of random, so later depths will slowly start adding lvl2 shadows
                            {SCATTER_UNITS "$(1 + $hoplite_depth / 6)" Hoplite_Poltergeist,Hoplite_Poltergeist,Hoplite_Poltergeist,Hoplite_Shadow,Hoplite_Poltergeist,Hoplite_Shadow 0 (
                                terrain=!,{SPARTAN_WALL_TERRAIN}
                                [not]
                                    [filter]
                                    [/filter]
                                    [or]
                                        x=4-8
                                        y=8-10
                                    [/or]
                                [/not]
                            ) (
                                side=$hoplite_enemyside
                            )}
                            [sound]
                                name=wail.wav
                            [/sound]
                        [/then]
                    [/if]
                    {VARIABLE_OP spartan_pact_forbidden_knowledge sub 1}
                [/then]
                [else]
                [/else]
            )}
            {IF_VAR spartan_pact_forbidden_knowledge equals 0 (
                [then]
                    {SPARTAN_CLEAR_ACTIVEPACT spartan_pact_forbidden_knowledge}
                [/then]
            )}

            {IF_VAR spartan_pact_wrath greater_than 0 (
                [then]
                    {VARIABLE pact_wrath_active_thisdepth yes}
                    {VARIABLE_OP spartan_pact_wrath sub 1}
                [/then]
            )}
            {IF_VAR spartan_pact_wrath equals 0 (
                [then]
                    [remove_object]
                        id=Hoplite
                        object_id=pact_wrath
                    [/remove_object]
#ifdef MULTIPLAYER
                    [remove_object]
                        id=Hoplite2
                        object_id=pact_wrath
                    [/remove_object]
#endif
                    {SPARTAN_CLEAR_ACTIVEPACT spartan_pact_wrath}
                [/then]
            )}

            #pacifist/overlord pacts give the same enemy-converting effect and do not stack

            {IF_VAR spartan_pact_pacifist greater_than 0 (
            [or]
                {VARIABLE_CONDITIONAL spartan_pact_overlord greater_than 0}
            [/or]
                [then]
                    #no effect on boss or shop levels:
                    [if]
                        {VARIABLE_CONDITIONAL hoplite_biome not_equals rarebiome_mysterious_shop}
                        [not]
                            [have_unit]
                                ability=hoplite_boss
                                side=$hoplite_enemyside
                            [/have_unit]
                        [/not]
                        [then]
                            [store_unit]
                                [filter]
                                    side=$hoplite_enemyside
                                    [not]
                                        ability=hoplite_boss_immunities
                                    [/not]
                                [/filter]
                                variable=hoplite_converted_enemies
                                kill=no
                            [/store_unit]
                            #        {VARIABLE tmp_enemies_to_convert $hoplite_converted_enemies.length}
                            #        {VARIABLE_OP tmp_enemies_to_convert divide 3}
                            #        {VARIABLE tmp_enemies_to_convert divide 3}

                            #choosing a third of enemies (rounded up) from the end of the list, since the strongest enemies are usually there
                             #UPD: the enemy spawn order loops back around, so it might not actually matter here

                            {VARIABLE tmp_pacifist_startindex $hoplite_converted_enemies.length}
                            {VARIABLE_OP tmp_pacifist_startindex divide 3}
                            {VARIABLE_OP tmp_pacifist_startindex multiply 2}
                            {VARIABLE_OP tmp_pacifist_startindex round floor}#rounding down the start index, so the player gets more converted enemies

                            [while]
                                {VARIABLE_CONDITIONAL tmp_pacifist_startindex less_than $hoplite_converted_enemies.length}
                                [do]
                                    {MODIFY_UNIT id=$hoplite_converted_enemies[$tmp_pacifist_startindex].id side $hoplite_allyside}
                                    [floating_text]
                                        x,y=$hoplite_converted_enemies[$tmp_pacifist_startindex].x,$hoplite_converted_enemies[$tmp_pacifist_startindex].y
                                        text="<span color='#00ff00'>" + _ "persuaded!" + "</span>"
                                    [/floating_text]
                                    {VARIABLE_OP tmp_pacifist_startindex add 1}
                                [/do]
                            [/while]

                            #scrapped code:
                            #        [foreach]
                            #            array=hoplite_converted_enemies
                            #            index_var=i
                            #            [do]
                            #                {RANDOM 1..3}
                            #                {IF_VAR random equals 1 (
                            #                [then]
                            #                    {MODIFY_UNIT id=$this_item.id side $hoplite_allyside}
                            #                    [floating_text]
                            #                       x,y=$this_item.x,$this_item.y
                            #                       text="<span color='#00ff00'>" + _ "persuaded!" + "</span>"
                            #                    [/floating_text]
                            #                [/then]
                            #                )}
                            #            [/do]
                            #        [/foreach]
                            [sound]
                                name={SOUND_LIST:HOLY}
                            [/sound]
                            #pacifism debuff does not apply for Pact of Overlord
                            {IF_VAR spartan_pact_pacifist greater_than 0 (
                            [then]
                                {VARIABLE pacifist_debuff_active_thisdepth yes}
                            [/then]
                            )}
                            {CLEAR_VARIABLE hoplite_converted_enemies}
                        [/then]
                    [/if]
                    {VARIABLE_OP spartan_pact_pacifist sub 1}
                [/then]
            )}

            {IF_VAR pacifist_debuff_active_thisdepth not_equals yes (
                #to prevent the pact being deleted on shop/boss levels
                [not]
                    {VARIABLE_CONDITIONAL spartan_pact_pacifist greater_than 0}
                [/not]
                [then]
                    {SPARTAN_CLEAR_ACTIVEPACT spartan_pact_pacifist}
                [/then]
            )}

            {IF_VAR spartan_pact_lightweight equals 0 (
                [then]
                    [remove_object]
                        id=Hoplite
                        object_id=pact_lightweight
                    [/remove_object]
#ifdef MULTIPLAYER
                    [remove_object]
                        id=Hoplite2
                        object_id=pact_lightweight
                    [/remove_object]
#endif

                    {SPARTAN_CLEAR_ACTIVEPACT spartan_pact_lightweight}
                [/then]
            )}
            #important: this must go into negative values, otherwise the patience effect will trigger over and over sometimes
            {IF_VAR spartan_pact_lightweight greater_than -1 (
                [then]
                    {VARIABLE_OP spartan_pact_lightweight sub 1}
                [/then]
            )}

            {IF_VAR spartan_pact_storm greater_than 0 (
                [then]
                    {VARIABLE pact_storm_active_thisdepth yes}
                    {VARIABLE_OP spartan_pact_storm sub 1}
                [/then]
            )}
        [/then]
    [/if]
[/event]
[event]
    name=turn refresh
    id=spartan_pact_pacifist_debuff
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL pacifist_debuff_active_thisdepth equals yes}
    [/filter_condition]
    {MODIFY_UNIT side=$hoplite_playerside attacks_left 0}
[/event]
#refreshing each turn, so that new attacks/flat damage buffs are accounted for
[event]
    name=turn refresh
    id=spartan_pact_wrath_effect
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL pact_wrath_active_thisdepth equals yes}
    [/filter_condition]
    [remove_object]
        id=Hoplite,Hoplite2
        side=$side_number
        object_id=pact_wrath
    [/remove_object]
    [object]
        silent=yes
        duration=forever
        id=pact_wrath
        take_only_once=no
        [filter]
            id=Hoplite,Hoplite2
            side=$side_number
        [/filter]
        [effect]
            apply_to=attack
            increase_damage=66%
        [/effect]
        [effect]
            apply_to=resistance
            replace=no
            [resistance]
                blade=50
                pierce=50
                impact=50
                arcane=50
                fire=50
                cold=50
            [/resistance]
        [/effect]
    [/object]
    #    {MODIFY_UNIT side=$hoplite_playerside attacks_left 0}
[/event]
[event]
    name=turn refresh
    id=spartan_pact_lightweight_energyrestore
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL spartan_pact_lightweight greater_than 0}
        [and]
            [have_unit]
                side=$hoplite_playerside
                [and]
                    side=$side_number
                [/and]
            [/have_unit]
        [/and]
    [/filter_condition]
    {HOPLITE_ADD_ENERGY_BY_SIDE $side_number 20}
[/event]
[event]
    name=new turn
    id=spartan_pact_storm
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL pact_storm_active_thisdepth equals yes}
    [/filter_condition]
    [sound]
        name=magic-faeriefire.ogg
    [/sound]
    #try to push every single unit up 1 tile
    #note: works weirdly when there are units next to eachother due to order of pushing, not sure if I can fix that
    #TODO: idea: I could make it so "units that don't have another unit above them" are pushed first, maybe in a [while] loop
    #the while loop can also apply a temporary ability for 1`turn before trying to push, then keep checking for units that don't have the ability
    [store_unit]
        [filter]
            side=1
            canrecruit=yes
        [/filter]
        variable=pactstorm_hoplite
        kill=no
    [/store_unit]
    {VARIABLE tmp_current_knockback_lesser yes}
    [store_unit]
        [filter]
            side=$hoplite_enemyside
            [not]
                ability=knockback_immune
            [/not]
        [/filter]
        variable=bystander
        kill=no
    [/store_unit]
    [foreach]
        array=bystander
        index_var=a
        [do]
            [if]
                [variable]
                    name=this_item.hitpoints
                    greater_than=0
                [/variable]
                [then]
                    #push enemies north (using -n is intentional since it is reversed)
                    {HOPLITE_KNOCKBACK_CODE_REPEATED 1 this_item pactstorm_hoplite -n}
                [/then]
            [/if]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE bystander}
    {UNIT $hoplite_enemyside (Hoplite_Dummy_Unit) 1 1 (id=pactstorm_dummyunit)}
    [hide_unit]
        id=pactstorm_dummyunit
    [/hide_unit]
    [store_unit]
        [filter]
            id=pactstorm_dummyunit
        [/filter]
        variable=pactstorm_dummy
        kill=no
    [/store_unit]
    {VARIABLE tmp_current_knockback_lesser yes}
    [store_unit]
        [filter]
            side=$hoplite_playerside,$hoplite_allyside
            [not]
                ability=knockback_immune
            [/not]
        [/filter]
        variable=bystander
        kill=no
    [/store_unit]
    [foreach]
        array=bystander
        index_var=a
        [do]
            [if]
                [variable]
                    name=this_item.hitpoints
                    greater_than=0
                [/variable]
                [then]
                    #push enemies north (using -n is intentional since it is reversed)
                    {HOPLITE_KNOCKBACK_CODE_REPEATED 1 this_item pactstorm_dummy -n}
                [/then]
            [/if]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE bystander}
    [kill]
        id=pactstorm_dummyunit
        animate=no
        fire_event=no
    [/kill]

    {CLEAR_VARIABLE tmp_current_knockback_lesser}
    {CLEAR_VARIABLE pactstorm_hoplite}
    {CLEAR_VARIABLE pactstorm_dummy}

    [if]
        {SPARTAN_AUTOMOVE_CONDITIONS}
        [then]
            {VARIABLE spartan_automove_skipturns yes}
            #workarround to skip turns if enemies are killed by automove
            [fire_event]
                id=hoplite_skip_turns_before_automove
            [/fire_event]
        [/then]
    [/if]
[/event]
[event]
    name=turn 1
    id=spartan_load_shop_achievement
    {VARIABLE favorite_customer_progress1 $spartan_orbshop_data1.orbs_spent}
    {IF_VAR favorite_customer_progress1 greater_than_equal_to 10 (
        [then]
            {ACHIEVEMENT_MESSAGE_LONE favorite_customer 1}
        [/then]
    )}
#ifdef MULTIPLAYER
    {VARIABLE favorite_customer_progress2 $spartan_orbshop_data2.orbs_spent}
    {IF_VAR favorite_customer_progress2 greater_than_equal_to 10 (
        [then]
            {ACHIEVEMENT_MESSAGE_LONE favorite_customer 2}
        [/then]
    )}
#endif
[/event]
#refreshing each turn, so that new attacks/flat damage buffs are accounted for
[event]
    name=turn refresh
    id=spartan_pact_overlord_damage_effect
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL spartan_pact_overlord greater_than 0}
    [/filter_condition]
    [remove_object]
        id=Hoplite,Hoplite2
        side=$side_number
        object_id=pact_overlord_damagebuff
    [/remove_object]
    [object]
        silent=yes
        duration=forever
        id=pact_overlord_damagebuff
        take_only_once=no
        [filter]
            id=Hoplite,Hoplite2
            side=$side_number
        [/filter]
        [effect]
            apply_to=attack
            increase_damage=66%
        [/effect]
    [/object]
[/event]
#enddef


#some repeated lines in the merchant dialog are now macros

#define SPARTAN_MERCHANT_PLAYER_ORB_COMMENTS
    [if]
        {VARIABLE_CONDITIONAL spartan_orbs_of_insight1 greater_than 0}
        [and]
            {VARIABLE_CONDITIONAL spartan_orbs_of_insight2 greater_than 0}
        [/and]
        [then]
            [message]
                id=Hoplite,Hoplite2
                message=_"(Checks pockets, takes out an <span color='#a456ff'>Orb of Insight</span>) Alright, we do have such orbs with us. Might as well see what you got."
            [/message]
            [message]
                speaker=merchant
                message=_"Excellent. Besides my wares, I can also offer you pacts."
            [/message]
            #pact dealer got removed for now, since it was difficult to fit him into dialog
            #            [message]
            #               speaker=pact_dealer
            #               message=_"Besides my brother's wares, perhaps my pacts could interest you too?"
            #            [/message]
        [/then]
        [elseif]
            {VARIABLE_CONDITIONAL spartan_orbs_of_insight1 greater_than 0}
            [then]
                [message]
                    id=Hoplite
                    message=_"(Checks pockets, takes out an <span color='#a456ff'>Orb of Insight</span>) Alright, I do have such orbs with me. Might as well see what you got."
                [/message]
                [message]
                    speaker=merchant
                    message=_"Excellent. Besides my wares, I can also offer you pacts."
                [/message]
            [/then]
        [/elseif]
        [elseif]
            {VARIABLE_CONDITIONAL spartan_orbs_of_insight2 greater_than 0}
            [then]
                [message]
                    id=Hoplite2
                    message=_"(Checks pockets, takes out an <span color='#a456ff'>Orb of Insight</span>) Alright, I do have such orbs with me. Might as well see what you got."
                [/message]
                [message]
                    speaker=merchant
                    message=_"Excellent. Besides my wares, I can also offer you pacts."
                [/message]
            [/then]
        [/elseif]
        [else]
            [message]
                id=Hoplite,Hoplite2
#ifdef MULTIPLAYER
                message=_"Alas it seems neither of us have such orbs at the moment."
#else
                message=_"Alas it seems I have no orbs with me at the moment."
#endif
            [/message]
            [message]
                speaker=merchant
                message=_"Perhaps we can cross paths another time then. In the meantime, perhaps my pacts could interest you?"
            [/message]
        [/else]
    [/if]
    [message]
        id=Hoplite,Hoplite2
        message=_"Pacts?"
    [/message]
    [message]
        speaker=merchant
        message=_"I offer powerful boons... but each comes with a cost. Best read the fine print carefully."
    [/message]
#enddef

#define SPARTAN_MERCHANT_DIALOG
                {VARIABLE_OP spartan_merchant_lines add 1}
                #TODO: add a switch case for different dialog

                {SPARTAN_GET_SHOP_DATA_GLOBAL_VARS}

                [if]
                    {VARIABLE_CONDITIONAL spartan_met_merchants_this_playthrough equals yes}
                    [then]
                        [if]
                            {VARIABLE_CONDITIONAL hoplite_depth less_than_equal_to 0}
                            [and]
                                {VARIABLE_CONDITIONAL hoplite_underworld_line not_equals yes}
                            [/and]
                            [then]
                                {VARIABLE hoplite_underworld_line yes}
                                {HOPLITE_UNSTORE_COMPANIONS}
                                [message]
                                    id=Hoplite,Hoplite2
                                    message=_"Wait, you're here too?"
                                [/message]
                                [if]
                                    [have_unit]
                                        id=Elizabeth
                                    [/have_unit]
                                    [then]
                                        [message]
                                            id=Elizabeth
                                            message=_"Wait you know him? Who is he?"
                                        [/message]
                                        [message]
                                            speaker=merchant
#ifdef MULTIPLAYER
                                            message=_"No one to be concerned about, Miss Elizabeth. I'm just a merchant, interested in the journey of $protagonist_name1| and $protagonist_name2|. A good merchant must know where to find customers, and so far those two are my main customers, so I moved here for now."
#else
                                            message=_"No one to be concerned about, Miss Elizabeth. I'm just a merchant, interested in $protagonist_name1|'s journey. A good merchant must know where to find customers, and so far he is my main customer, so I moved here for now."
#endif
                                        [/message]
                                        [message]
                                            id=Elizabeth
                                            message=_"H-how do you know my name?! Also, why should I trust some suspicious-looking cloaked merchant that doesn't even show his face?"
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"Believe me, Miss Elizabeth, if I meant either of you any harm..."
                                        [/message]
                                        [delay]
                                            time=500
                                        [/delay]
                                        [message]
                                            speaker=merchant
                                            message=_"<i><b>...You would already be dead.</b></i>"
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"<i>*gulp*</i>"
                                        [/message]
                                        [message]
                                            id=Elizabeth
                                            message=_"A-alright, p-point taken!"
                                        [/message]
                                        [message]
                                            speaker=merchant
#ifdef MULTIPLAYER
                                            message=_"(looks at Elizabeth's, $protagonist_name1|'s and $protagonist_name2|'s expressions) Ah, my sincere apologies, didn't mean to frighten you like that."
#else
                                            message=_"(looks at Elizabeth's and $protagonist_name1|'s expressions) Ah, my sincere apologies, didn't mean to frighten you like that."
#endif
                                        [/message]
                                    [/then]
                                    [else]
                                        [message]
                                            speaker=merchant
                                            message=_"A good merchant must know where to find customers, and so far my main customer is you, $protagonist_name1|, so I moved here for now."
                                        [/message]
                                    [/else]
                                [/if]
                                [message]
                                    id=Hoplite,Hoplite2
                                    message=_"Alright... Do you happen to know a way out of here?"
                                [/message]
                                [message]
                                    speaker=merchant
                                    message=_"My methods of travel... would not work for you. My advice to be to find a stable portal to Irdya. The spirits wandering this place cannot use them, but a mortal like yourself can."
                                [/message]
                                [if]
                                    [have_unit]
                                        id=Elizabeth
                                    [/have_unit]
                                    [then]
                                        [message]
                                            speaker=Elizabeth
                                            message=_"Your 'methods of travel'? 'mortal like yourself'? So you didn't use a portal, and can just freely travel between worlds?!"
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"Perhaps."
                                        [/message]
                                        [message]
                                            speaker=Elizabeth
                                            message=_"What sort of ability is that?! Only Death himself should be able to come and go as he pleases... what really are you?"
                                        [/message]
                                        [message]
                                            speaker=merchant
#ifdef MULTIPLAYER
                                            message=_"Some questions are best left unanswered, Miss Elizabeth. I offer my services and $protagonist_name1| or $protagonist_name2| can choose to partake. That is all."
#else
                                            message=_"Some questions are best left unanswered, Miss Elizabeth. I offer my services and $protagonist_name1| can choose to partake. That is all."
#endif
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"(to Elizabeth) I suppose he's right, we should focus more on trying to leave this place. What matters now is that this merchant is one of the few beings here that isn't actively trying to kill us."
                                        [/message]
                                        [message]
                                            speaker=Elizabeth
                                            message=_"I suppose so..."
                                        [/message]
                                    [/then]
                                    [else]
                                        [message]
                                            id=Hoplite
                                            message=_"What are you then? You imply you aren't a mortal, yet somehow you don't quite seem like a wandering spirit either..."
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"Some questions are best left unanswered, $protagonist_name1|. What matters is that I offer you goods and pacts to help in your quest against Galatea, and you pay <span color='#a456ff'>Orbs of Insight</span> in return."
                                        [/message]
                                    [/else]
                                [/if]
                            [/then]
                            [else]
                                #TODO: add more randomly-chosen lines here and also some random lines after the intro (besides the ash line)

                                {VARIABLE_OP spartan_merchant_randline_intro rand 1..3}

                                [switch]
                                    variable=spartan_merchant_randline_intro
                                    [case]
                                        value=1
                                        [message]
                                            speaker=merchant
#ifdef MULTIPLAYER
                                            message=_"Welcome back, $protagonist_name1| and $protagonist_name2|! I hope you two brought some <span color='#a456ff'>Orbs of Insight</span>. If not, you can have a look at my pacts again instead."
#else
                                            message=_"Welcome back, $protagonist_name1|! I hope you brought some <span color='#a456ff'>Orbs of Insight</span>. If not, you can have a look at my pacts again instead."
#endif
                                        [/message]
                                    [/case]
                                    [case]
                                        value=2
                                        [message]
                                            speaker=merchant
#ifdef MULTIPLAYER
                                            message=_"We meet yet again, $protagonist_name1| and $protagonist_name2|, as expected. Have a look at my wares once more, for a fair price of <span color='#a456ff'>Orbs of Insight</span>."
#else
                                            message=_"We meet yet again, $protagonist_name1|, as expected. Have a look at my wares once more, for a fair price of <span color='#a456ff'>Orbs of Insight</span>."
#endif
                                        [/message]
                                    [/case]
                                    [case]
                                        value=3
                                        [message]
                                            speaker=merchant
#ifdef MULTIPLAYER
                                            message=_"Ah, $protagonist_name1| and $protagonist_name2|, good to see you two again! Did you find any more <span color='#a456ff'>Orbs of Insight</span> to trade?"
#else
                                            message=_"Ah, $protagonist_name1|, good to see you again! Did you find any more <span color='#a456ff'>Orbs of Insight</span> to trade?"
#endif
                                        [/message]
                                    [/case]
                                [/switch]

                                {CLEAR_VARIABLE spartan_merchant_randline_intro}

                                #pact dealer got removed for now, since it was difficult to fit him into dialog
                                #       [message]
                                #           speaker=pact_dealer
                                #           message=_"If not, you can have a look at my pacts again instead..."
                                #       [/message]

                                #ash dialog is now no longer guaranteed to trigger on every second merchant visit, to make it a bit more varied

                                {VARIABLE_OP spartan_merchant_randline_ash rand 1..3}

                                {IF_VAR merchant_line_ashpile not_equals yes (
                                [and]
                                    {VARIABLE_CONDITIONAL spartan_merchant_randline_ash equals 1}
                                [/and]
                                    [then]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"By the way, I've been wondering - this cave is swarming will all kinds of foes, yet your shops are some of the safest and quietest places I've seen here. How is that possible in such a dangerous location for business?"
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"Let me tell you a little story. A large squad of orcs was once passing by near my shop. When seeing a lone, wandering, seemingly unarmed merchant, they assumed I would be an easy target and tried to rob me. That was their biggest and final mistake."
                                        [/message]
                                        [sound]
                                            name=magic-faeriefire.ogg
                                        [/sound]
                                        {SCATTER_UNITS 1 "Hoplite_Dummy_Unit" 1 (
                                            terrain={SPARTAN_UNITSPAWN_TERRAIN}
                                            [not]
                                                x,y=$forge_x,$forge_y
                                            [/not]
                                            [and]
                                                [filter]
                                                    id=merchant
                                                    radius=2
                                                [/filter]
                                            [/and]
                                        ) (
                                            side=$hoplite_enemyside
                                        )}
                                        [store_unit]
                                            [filter]
                                                type=Hoplite_Dummy_Unit
                                            [/filter]
                                            variable=ash_pile_loc
                                            kill=yes
                                        [/store_unit]
                                        [item]
                                            image="items/ashpile.png"
                                            name=merchant_ashpile
                                            x,y=$ash_pile_loc.x,$ash_pile_loc.y
                                        [/item]
                                        {CLEAR_VARIABLE ash_pile_loc}
                                        [delay]
                                            time=1000
                                        [/delay]
                                        [message]
                                            speaker=merchant
                                            message=_"(points at the large ash pile) Behold, this is what is left of that orc squad. I spared exactly one of them, however, and told him that anyone who tries to rob my shops will meet the same fate. He fled as fast as his legs could carry him. After that, nobody in this place ever dared to disturb my business anymore."
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"<i>*gulp*</i> I see..."
                                        [/message]
                                        [sound]
                                            name=magic-faeriefire.ogg
                                        [/sound]
                                        [remove_item]
                                            image=merchant_ashpile
                                        [/remove_item]
                                        {VARIABLE merchant_line_ashpile yes}
                                    [/then]
                                )}
                                {CLEAR_VARIABLE spartan_merchant_randline_ash}
                            [/else]
                        [/if]
                    [/then]
                    [else]
                        #lines for meeting merchants first time each playthrough
                        {VARIABLE spartan_met_merchants_this_playthrough yes}

                        {VARIABLE_OP spartan_orbshop_data1.visited_across_playthroughs add 1}
#ifdef MULTIPLAYER
#ifndef LOCALMP
                        {VARIABLE_OP spartan_orbshop_data2.visited_across_playthroughs add 1}
#endif
#endif
                        {SPARTAN_SYNC_ORBSHOP_DATA}

                        #in MP, only host data for merchants is checked, for now
                        [switch]
                            variable=spartan_orbshop_data1.visited_across_playthroughs
                            [case]
                                value=1
#ifdef MULTIPLAYER
                                [message]
                                    id=Hoplite,Hoplite2
                                    message=_"What is this place..."
                                [/message]
                                [message]
                                    speaker=merchant
                                    message=_"Ah, greetings, $protagonist_name1| and $protagonist_name2| from Sparta."
                                [/message]
                                [message]
                                    id=Hoplite,Hoplite2
                                    message=_"(draws weapons) Who are you? What are you? How do you know us?"
                                [/message]
#else
                                [message]
                                    id=Hoplite,Hoplite2
                                    message=_"What is this place..."
                                [/message]
                                [message]
                                    speaker=merchant
                                    message=_"Ah, greetings, $protagonist_name1|, $spartan_classname_lowercase1| from Sparta."
                                [/message]
                                [message]
                                    id=Hoplite,Hoplite2
                                    message=_"(draws weapons) Who are you? What are you? How do you know me?"
                                [/message]
#endif
                                [message]
                                    speaker=merchant
                                    message=_"I assure you, I mean you no harm. I am a wandering merchant, seller of magical goods and arcane mysteries. Most in the caves simply call me 'The Merchant'."
                                [/message]
                                [message]
                                    id=Hoplite,Hoplite2
#ifdef MULTIPLAYER
                                    message=_"(lowers weapons) Well, we do have some silver coins from my world. What do you sell?"
#else
                                    message=_"(lowers weapons) Well, I do have some silver coins from my world. What do you sell?"
#endif
                                [/message]
                                [message]
                                    speaker=merchant
                                    message=_"Ah, but unlike most I do not deal in silver or gold, or other petty mortal things."
                                [/message]
                                [message]
                                    speaker=merchant
                                    #he tries to hide his involvement in the appearance of orb of insight in the caves
                                    message=_"I seek <span color='#a456ff'>Orbs of Insight</span>, easily recognizable by their purple glow, these curious objects started... appearing here in Irdya recently. As for my wares, come here and have a look for yourself, perhaps something will catch your eye."
                                [/message]
                                {SPARTAN_MERCHANT_PLAYER_ORB_COMMENTS}
                                #pact dealer got removed for now, since it was difficult to fit him into dialog
                                #            [message]
                                #               speaker=pact_dealer
                                #               message=_"I offer powerful boons... but each comes with a curse. Best read the fine print carefully."
                                #            [/message]
                                [if]
                                    [have_unit]
                                        id=Algadur
                                    [/have_unit]
                                    [then]
                                        [message]
                                            speaker=Algadur
                                            # wmllint: local spelling Somethin
                                            message=_"(whispers) <i>Somethin' feels very off 'bout him, gives me goosebumps...</i>"
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"(whispers) <i>Looks unusual, yes, but he's one of the few beings in this place that aren't actively trying to kill us at least. We should be careful, but might as well have a look at his wares.</i>"
                                        [/message]
                                        [message]
                                            speaker=Algadur
                                            message=_"<i>Alright, if you say so...</i>"
                                        [/message]
                                    [/then]
                                [/if]
                            [/case]
                            #lines for visiting the shop after the first playthrough
                            [else]
                                #add more lines here
                                {IF_VAR spartan_orbshop_data1.visited_across_playthroughs greater_than 5 (
                                    [then]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            #               message=_"This place... feels foreign, yet somehow disturbingly familiar... I cannot shake this strange feeling of deja vu, that I somehow already been here, over and over..."
                                            message=_"This place... feels foreign, yet somehow disturbingly familiar... I cannot shake this strange feeling of deja vu, that I somehow already been here, maybe even more than once..."
                                        [/message]
                                    [/then]
                                    [else]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"Something feels... off about this place, I can't quite put my finger on it, but it's nothing like the rest of the cave..."
                                        [/message]
                                    [/else]
                                )}
                                {IF_VAR spartan_orbshop_data1.orbs_spent greater_than_equal_to 10 (
                                    [then]
                                        [message]
                                            speaker=merchant
                                            message=_"Ah, welcome back, $protagonist_name1|, my favorite customer! Pleasure to see you again."
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"Favorite customer?! But... we haven't met... have we?"
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            #               message=_"It's hard to explain to most mortals, but let's just say we both did, and we did not..."
                                            message=_"Ah, pardon me, just a slip of the tongue, I assure you. What I meant to say was you look like the type of person that could become my next favorite customer."
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"You see, I am a wandering merchant, but not just an ordinary one. My currency is <span color='#a456ff'>Orbs of Insight</span>. With my collection of these <span size='small'><i>and my own powers</i></span>, it was easy to see your arrival in advance and learn your name."
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"Who are you really?"
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"You may simply call me 'The Merchant'. You exchange your <span color='#a456ff'>Orbs of Insight</span>, my wares help you defeat Galatea, that is what matters."
                                        [/message]
                                    [/then]
                                    [else]
#ifdef MULTIPLAYER
                                        [message]
                                            speaker=merchant
                                            message=_"Ah, greetings again, $protagonist_name1| and $protagonist_name2| from Sparta."
                                        [/message]
#else
                                        [message]
                                            speaker=merchant
                                            message=_"Ah, greetings again, $protagonist_name1|, $spartan_classname_lowercase1| from Sparta."
                                        [/message]
#endif
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"(draws weapons) Who are you? What are you? How do you know me? What do you mean about 'again'?"
                                        [/message]
                                        [message]
                                            speaker=merchant
                                            message=_"You see, I am a wandering merchant, but not just an ordinary one. My currency is <span color='#a456ff'>Orbs of Insight</span>. With my collection of these <span size='small'><i>and my own powers</i></span>, it was easy to see your arrival in advance and learn your name."
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"(lowers weapons) I see..."
                                        [/message]
                                    [/else]
                                )}
                                {SPARTAN_MERCHANT_PLAYER_ORB_COMMENTS}
                                #pact dealer got removed for now, since it was difficult to fit him into dialog
                                #           [message]
                                #               speaker=pact_dealer
                                #               message=_"I offer powerful boons... but each comes with a curse. Best read the fine print carefully."
                                #            [/message]
                                [if]
                                    [have_unit]
                                        id=Algadur
                                    [/have_unit]
                                    [then]
                                        [message]
                                            speaker=Algadur
                                            message=_"(whispers) <i>Somethin' feels very off 'bout him, gives me goosebumps...</i>"
                                        [/message]
                                        [message]
                                            id=Hoplite,Hoplite2
                                            message=_"(whispers) <i>Looks unusual, yes, but he's one of the few beings in this place that aren't actively trying to kill us at least. We should be careful, but might as well have a look at his wares.</i>"
                                        [/message]
                                        [message]
                                            speaker=Algadur
                                            message=_"<i>Alright, if you say so...</i>"
                                        [/message]
                                    [/then]
                                [/if]
                            [/else]
                        [/switch]
                    [/else]
                [/if]
#enddef