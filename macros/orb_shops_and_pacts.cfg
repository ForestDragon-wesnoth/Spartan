#textdomain wesnoth-Hoplite

#define ORBSHOP_OPTION_PER_PLAYER ID TEXT IMAGE COST EXTRA_CONDITIONS EFFECT
    [option]
        image={IMAGE}
        description={TEXT}
        [show_if]
            {VARIABLE_CONDITIONAL {ID}_taken$side_number not_equals yes}#can only take it once per shop depth per player
            [and]
                {EXTRA_CONDITIONS}
            [/and]
        [/show_if]
        [command]
            {IF_VAR spartan_orbs_of_insight$side_number| greater_than_equal_to {COST} (
                [then]
                    {VARIABLE_OP spartan_orbs_of_insight$side_number| sub {COST}}
                    {VARIABLE_OP spartan_orbshop_data$side_number|.orbs_spent add {COST}}
                    {SPARTAN_SYNC_ORBSHOP_DATA}
                    {EFFECT}
                    {VARIABLE {ID}_taken$side_number yes}
                    [set_variables]
                        name=spartan_taken_shop_items
                        mode=append
                        [value]
                            var={ID}_taken$side_number#for mentioning duration in info menu, use something like $$array[0].var||
                        [/value]
                    [/set_variables]
                    {VARIABLE favorite_customer_progress$side_number $spartan_orbshop_data$side_number|.orbs_spent}
                    {IF_VAR favorite_customer_progress$side_number greater_than_equal_to 10 (
                        [then]
                            {ACHIEVEMENT_MESSAGE_LONE favorite_customer $side_number}
                        [/then]
                    )}
                [/then]
                [else]
                    [message]
                        speaker=merchant
                        message=_"Unfortunately you do not have enough orbs to buy this."
                    [/message]
                [/else]
            )}
        [/command]
    [/option]
#enddef

#define ORBSHOP_OPTION_SHARED ID TEXT IMAGE COST EXTRA_CONDITIONS EFFECT
    [option]
        image={IMAGE}
        description={TEXT}
        [show_if]
            {VARIABLE_CONDITIONAL {ID}_taken not_equals yes}#can only take it once per shop depth
            [and]
                {EXTRA_CONDITIONS}
            [/and]
        [/show_if]
        [command]
            {IF_VAR spartan_orbs_of_insight$side_number| greater_than_equal_to {COST} (
                [then]
                    {VARIABLE_OP spartan_orbs_of_insight$side_number| sub {COST}}
                    {VARIABLE_OP spartan_orbshop_data$side_number|.orbs_spent add {COST}}
                    {SPARTAN_SYNC_ORBSHOP_DATA}
                    {EFFECT}
                    {VARIABLE {ID}_taken yes}
                    [set_variables]
                        name=spartan_taken_shop_items
                        mode=append
                        [value]
                            var={ID}_taken#for mentioning duration in info menu, use something like $$array[0].var||
                        [/value]
                    [/set_variables]
                    {VARIABLE favorite_customer_progress$side_number $spartan_orbshop_data$side_number|.orbs_spent}
                    {IF_VAR favorite_customer_progress$side_number greater_than_equal_to 10 (
                        [then]
                            {ACHIEVEMENT_MESSAGE_LONE favorite_customer $side_number}
                        [/then]
                    )}
                [/then]
                [else]
                    [message]
                        speaker=merchant
                        message=_"Unfortunately you do not have enough orbs to buy this."
                    [/message]
                [/else]
            )}
        [/command]
    [/option]
#enddef

#define SPARTAN_PACT_OPTION ID DURATION NAME IMAGE DETAILED_DESCRIPTION EFFECT
    [option]
        image={IMAGE}
        description={NAME}
        [show_if]
            [not]
                {VARIABLE_CONDITIONAL {ID} greater_than 0}#cannot re-apply a pact you already have
            [/not]
        [/show_if]
        [command]
            {IF_VAR tmp_book_of_pacts_menu equals yes (
                [then]
                    {VARIABLE tmp_pact_speaker narrator}
                [/then]
                [else]
                    {VARIABLE tmp_pact_speaker merchant}
                [/else]
            )}

            [message]
                speaker=$tmp_pact_speaker
#ifdef MULTIPLAYER
                message={DETAILED_DESCRIPTION}_"

Do you want to pick this pact? (The pact's effects apply to both hoplites, and the other player has to agree to taking the pact too.)"
#else
                message={DETAILED_DESCRIPTION}_"

Do you want to pick this pact?"
#endif
                [option]
                    description=_"No"
                    image=attacks/blank-attack.png
                    [command]
                    [/command]
                [/option]
                [option]
                    description=_"Yes"
                    image=attacks/blank-attack.png
                    [command]
                        {VARIABLE tmp_orbshop_pact_confirmed yes}
                    [/command]
                [/option]
            [/message]
#ifdef MULTIPLAYER
            [if]
                {VARIABLE_CONDITIONAL tmp_orbshop_pact_confirmed equals yes}
                [then]
                    [store_unit]
                        [filter]
                            side=$hoplite_playerside
                            [not]
                                side=$side_number
                            [/not]
                        [/filter]
                        variable=tmp_spartan_otherplayer
                        kill=no
                    [/store_unit]
                    [message]
                        speaker=$tmp_pact_speaker
                        side_for=$tmp_spartan_otherplayer.side
                        message={DETAILED_DESCRIPTION}_"

The other hoplite wants to take this pact, do you agree to taking it too? (The effects apply to both of you)"
                        [option]
                            description=_"No"
                            image=attacks/blank-attack.png
                            [command]
                                {VARIABLE tmp_orbshop_pact_confirmed no}
                            [/command]
                        [/option]
                        [option]
                            description=_"Yes"
                            image=attacks/blank-attack.png
                            [command]
                                {VARIABLE tmp_orbshop_pact_confirmed yes}
                            [/command]
                        [/option]
                    [/message]
                    {CLEAR_VARIABLE tmp_spartan_otherplayer}
                [/then]
            [/if]
#endif
            [if]
                {VARIABLE_CONDITIONAL tmp_orbshop_pact_confirmed equals yes}
                [then]
                    {EFFECT}
                    {VARIABLE {ID} {DURATION}}
                    {VARIABLE spartan_pact_taken yes}
                    [set_variables]
                        name=spartan_activepacts
                        mode=append
                        [value]
                            var={ID}#for mentioning duration in info menu, use something like $$spartan_activepacts[0].var||
                            name={NAME}
                            image={IMAGE}
                            descr={DETAILED_DESCRIPTION}
                        [/value]
                    [/set_variables]
                    {CLEAR_VARIABLE spartan_orbshop_menu}
                    [print]
                        text= _ "Pact taken"
                        size=30
                        red=150
                        blue=200
                        duration=2000
                    [/print]
                    {ACHIEVEMENT_MESSAGE_LONE pactI $side_number}
                [/then]
                [elseif]
                    {VARIABLE_CONDITIONAL tmp_orbshop_pact_confirmed equals no}
                    [then]
                        [message]
                            id=Hoplite,Hoplite2
                            [not]
                                side=$side_number
                            [/not]
                            message=_"I don't think we should take this pact."
                        [/message]
                        {IF_VAR tmp_book_of_pacts_menu equals yes (
                            [else]
                                [message]
                                    speaker=merchant
                                    message=_"Alright, perhaps a different one would be of interest to you?"
                                [/message]
                            [/else]
                        )}
                    [/then]
                [/elseif]
                [else]
                [/else]
            [/if]
            {CLEAR_VARIABLE tmp_orbshop_pact_confirmed}
        [/command]
    [/option]
#enddef

#used for both orb shop, and Book of Pacts

# wmlindent: start ignoring
#define SPARTAN_PACT_OPTIONS
    #NOTE: ID matches pact variable here
    {SPARTAN_PACT_OPTION spartan_pact_forbidden_knowledge 3 _"Forbidden Knowledge" icons/book2.png _"Forbidden Knowledge:
<span color='#99ff66'>-gain 1 orb of insight</span>
<span color='#ff6666'>-some ghost enemies will spawn on the next 3 depths</span>" (
    [sound]
        name=magic-dark-big.ogg
    [/sound]
    [sound]
        name={SOUND_LIST:LICH_HIT}
    [/sound]
    {SPARTAN_ADD_INSIGHT_ORB_WITH_POPUP}
)}
#TODO: add different icon for pact of patience
{SPARTAN_PACT_OPTION spartan_pact_patience 3 _"Pact of Patience" icons/book2.png _"Pact of Patience:
<span color='#99ff66'>-after 3 depths, instantly gain 4 forge upgrades</span>
<span color='#ff6666'>-the next 3 depths have no forges</span>" (
[sound]
    name=magic-dark-big.ogg
[/sound]
[sound]
    name={SOUND_LIST:LICH_HIT}
[/sound]
{VARIABLE_OP forge_delay sub 3}
)}

#TODO: add different icon:
{SPARTAN_PACT_OPTION spartan_pact_wrath 5 _"Pact of Wrath" icons/book2.png _"Pact of Wrath:
<span color='#99ff66'>-damage of your attacks is increased by 66% (refreshes each turn)</span>
<span color='#ff6666'>-your resistances to all damage types are reduced by 50%</span>
-the pact lasts for the next 5 depths" (
    [sound]
        name=magic-dark-big.ogg
    [/sound]
    [sound]
        name={SOUND_LIST:LICH_HIT}
    [/sound]
    {VARIABLE pact_wrath_active_thisdepth yes}
    [fire_event]
        id=spartan_pact_wrath_effect
    [/fire_event]
)}

#TODO: add different icon:
{SPARTAN_PACT_OPTION spartan_pact_pacifist 5 _"Persuasive Pacifist" icons/book2.png _"Persuasive Pacifist:
<span color='#99ff66'>-at the start of each depth, 33% (rounded up) of enemies becoming your allies, with stronger enemies being more likely to be converted</span>
<span color='#ff6666'>-you are unable to attack</span>
-the pact lasts for the next 5 depths
-pact has no effect in boss depths" (
    [sound]
        name=magic-dark-big.ogg
    [/sound]
    [sound]
        name={SOUND_LIST:LICH_HIT}
    [/sound]
)}

#TODO: add different icon:
#TODO: maybe rework lightweight's energy from flat 20 to 15% of max, so it scales better in late-game (might need to nerf to 15 flat or 10% later tho)
{SPARTAN_PACT_OPTION spartan_pact_lightweight 5 _"Lightweight" icons/book2.png _"Lightweight:
<span color='#99ff66'>-you gain 1 more movement</span>
<span color='#99ff66'>-recover 20 energy each turn</span>
<span color='#ff6666'>-your max hp is reduced by 40%</span>
-the pact lasts for the next 5 depths" (
    [sound]
        name=magic-dark-big.ogg
    [/sound]
    [sound]
        name={SOUND_LIST:LICH_HIT}
    [/sound]
    [object]
        silent=yes
        duration=forever
        id=pact_lightweight
        take_only_once=no
        [filter]
            id=Hoplite
        [/filter]
        [effect]
            apply_to=movement
            increase=1
        [/effect]
        [effect]
            apply_to=hitpoints
            increase=-40%
            increase_total=-40%
        [/effect]
    [/object]
#ifdef MULTIPLAYER
    [object]
        silent=yes
        duration=forever
        id=pact_lightweight
        take_only_once=no
        [filter]
            id=Hoplite2
        [/filter]
        [effect]
            apply_to=movement
            increase=1
        [/effect]
        [effect]
            apply_to=hitpoints
            increase=-40%
            increase_total=-40%
        [/effect]
    [/object]
#endif
)}

#TODO: add more pacts
#enddef
# wmlindent: stop ignoring

#define SPARTAN_GENERATE_ACTIVE_PACT_OPTIONS
    [foreach]
        array=spartan_activepacts
        index_var=i
        [do]
            [set_variables]
                name=spartan_activepact_options
                mode=append
                [value]
                    image=$this_item.image
                    description=$this_item.name|
                    #            [show_if]
                    #                {VARIABLE_CONDITIONAL $this_item.id|_hintunlocked$side_number equals yes}
                    #            [/show_if]
                    [command]
                        [message]
                            speaker=narrator
                            caption=$this_item.name
                            image="portraits/book.png~GS()~BLEND(0,0,0,0.4)"
                            message=$this_item.descr|+_"

This pact has $$this_item.var|| depths left"
                        [/message]
                    [/command]
                [/value]
            [/set_variables]
        [/do]
    [/foreach]
#enddef

#define SPARTAN_CLEAR_ACTIVEPACT VAR
    [foreach]
        array=spartan_activepacts
        index_var=i
        [do]
            {IF_VAR this_item.var equals {VAR} (
                [then]
                    {VARIABLE tmp_delectpact_index $i}
                    [break][/break]#no need to continue the loop after the pact is found
                    #commented out for now
                    #        {CLEAR_VARIABLE $this_item.var}#pact duration variable is no longer needed now
                [/then]
            )}
        [/do]
    [/foreach]
    {IF_VAR tmp_delectpact_index not_equals $emptyvar (
        [then]
            {CLEAR_VARIABLE spartan_activepacts[$tmp_delectpact_index]}
            {CLEAR_VARIABLE tmp_delectpact_index}
        [/then]
    )}
#enddef

#define HOPLITE_ORB_SHOP_EVENTS
    [event]
        name=moveto
        id=spartan_orbshop
        first_time_only=no
        [filter]
            side=$hoplite_playerside
            [filter_location]
                [filter]
                    id=merchant
                [/filter]
                radius=1
            [/filter_location]
        [/filter]
        {VARIABLE spartan_orbshop_menu yes}
        [while]
            {VARIABLE_CONDITIONAL spartan_orbshop_menu equals yes}
            [do]
                [message]
                    speaker=merchant
                    message=_"What do you want to buy?

(You currently have <span color='#a456ff'>$spartan_orbs_of_insight$side_number|| Orbs of Insight</span>, carries over between playthroughs)"
                    [option]
                        image="misc/red-x.png"
                        description=_"Return to the Game"
                        [command]
                            {CLEAR_VARIABLE spartan_orbshop_menu}
                        [/command]
                    [/option]
                    {ORBSHOP_OPTION_PER_PLAYER orbshop_energy _"+15 max energy - costs <span color='#a456ff'>1 orb of insight</span>" "icons/boots_elven.png" 1 () (
                    [sound]
                        name=magic-faeriefire.ogg
                    [/sound]
                    #            {SPARTAN_INCREASE_MAX_ENERGY_IN_UPGRADE 15}
                    {VARIABLE_OP hoplite_energy$side_number add 15}
                    {VARIABLE_OP hoplite_maxenergy$side_number add 15}
                )}
                #TODO: maybe add some custom summons too, instead of just reusing powerful enemies
                {ORBSHOP_OPTION_SHARED summon_stormtide _"Summon a loyal Stormtide Demon - costs <span color='#a456ff'>1 orb of insight</span>" "units/demons/storm.png~RC(magenta>green)" 1 () (
                [sound]
                    name=magic-faeriefire.ogg
                [/sound]
                {UNIT $hoplite_allyside (Hoplite_Demonstorm) 4 5 (
                    placement=map
                    passable=yes
                    generate_name=yes
                    random_gender=yes
                    [modifications]
                        {TRAIT_LOYAL}
                    [/modifications]
                )}
            )}
            {ORBSHOP_OPTION_SHARED summon_lich _"Summon a loyal Lich - costs <span color='#a456ff'>2 orbs of insight</span>" "units/undead-necromancers/lich.png~RC(magenta>green)" 2 (
            {VARIABLE_CONDITIONAL hoplite_depth greater_than_equal_to 15}
            [or]
                {VARIABLE_CONDITIONAL hoplite_depth less_than_equal_to 0}
            [/or]
        ) (
            [sound]
                name=magic-faeriefire.ogg
            [/sound]
            {UNIT $hoplite_allyside (Hoplite_Lich) 4 5 (
                placement=map
                passable=yes
                generate_name=yes
                random_gender=yes
                [modifications]
                    {TRAIT_LOYAL}
                [/modifications]
            )}
        )}
        {ORBSHOP_OPTION_SHARED summon_ferrous_titan _"Summon a loyal Ferrous Titan - costs <span color='#a456ff'>2 orbs of insight</span>" "units/human-loyalists/siegetrooper.png~BLEND(160,82,45,0.3)~CS(-35,-35,-35)~RC(magenta>green)" 2 (
        {VARIABLE_CONDITIONAL hoplite_depth greater_than_equal_to 20}
        [or]
            {VARIABLE_CONDITIONAL hoplite_depth less_than_equal_to 0}
        [/or]
    ) (
        [sound]
            name=magic-faeriefire.ogg
        [/sound]
        {UNIT $hoplite_allyside (Hoplite_Ferrous_Titan) 4 5 (
            placement=map
            passable=yes
            generate_name=yes
            random_gender=yes
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        )}
    )}
    {ORBSHOP_OPTION_PER_PLAYER book_of_pacts _"Book of Pacts - gain a skill to choose a pact anywhere. has a 5-depth cooldown
Can be upgraded at the forge
costs <span color='#a456ff'>7 orbs of insight</span>" "icons/book2.png" 7 (
    {VARIABLE_CONDITIONAL book_of_pacts_unlocked$side_number not_equals yes}#can only take it once per shop depth per player
    [and]
        {VARIABLE_CONDITIONAL hoplite_depth greater_than_equal_to 10}
        [or]
            {VARIABLE_CONDITIONAL hoplite_depth less_than_equal_to 0}
        [/or]
    [/and]
) (
    [sound]
        name=magic-faeriefire.ogg
    [/sound]
    {SPARTAN_ADD_UPGRADES_MANUALLY_NON_SHARED $side_number book_of_pacts}
)}

#shop ideas:
#maybe some very expensive permanent upgrades that carry over between playthroughs, for example:
# Chronos Forge: each new playthrough, start with 1 extra forge upgrade - costs 10 orbs (in multiplayer, only affects the specific player that bought it)
# consider changing starting depths so that they (except sandbox start) need to be bought in the orb shop, maybe like this:
#depth 11 start: costs 2 orbs, requires being at depth 11 or above in the shop
#depth 21 start: costs 3 orbs, requires being at depth 21 or above in the shop, and buying the previous start
#underworld start: costs 4 orbs, requires being at depth 31 or above or in underworld in the shop, and buying the previous start
#depth 31 start: costs 5 orbs, requires being at depth 31 or above in the shop, and buying the previous start
#depth 41 start: costs 7 orbs, requires being at depth 41 or above in the shop, and buying the previous start
#maybe a single-use consumable healing item
#Zeus Lightning in orb shop (exact stats decided by me): -"use rightclick menu to select a tile anywhere on the map, deals 30 damage and slows enemies in a 1-tile radius from that tile, costs 1 orb"
#-note: for animation I could use the lvl3 thunder shaman aoe attack from GSE, just remove purple color from lightning

[option]
    image=icons/book2.png
    description=_"Pacts"
    [command]
        [if]
            {VARIABLE_CONDITIONAL spartan_pact_taken equals yes}
            [then]
                [message]
                    #        speaker=pact_dealer
                    speaker=merchant
                    message=_"I can't offer you another pact yet... If we meet again you can have another one."
                [/message]
            [/then]
            [else]
                #TODO: maybe instead of all pacts being available at once, maybe make the dealer choose 3-5 pacts at random

                [message]
                    #        speaker=pact_dealer
                    speaker=merchant
                    message=_"Choose a pact..."
                    [option]
                        image="misc/red-x.png"
                        description=_"Return to the shop"
                        [command]
                        [/command]
                    [/option]
                    {SPARTAN_PACT_OPTIONS}
                [/message]
            [/else]
        [/if]
    [/command]
[/option]
[/message]
[/do]
[/while]
[/event]
#pact dealer got removed for now, since it was difficult to fit him into dialog
#[event]
#    name=moveto
#    id=spartan_pacts
#    first_time_only=no
#    [filter]
#        side=$hoplite_playerside
#        [filter_location]
#            [filter]
#                id=pact_dealer
#            [/filter]
#            radius=1
#        [/filter_location]
#    [/filter]
#[/event]
[event]
    id=hoplite_depthdescent_pacteffects
    first_time_only=no
    [foreach]
        array=spartan_taken_shop_items
        index_var=i
        [do]
            {CLEAR_VARIABLE $this_item.var}
        [/do]
    [/foreach]
    {CLEAR_VARIABLE spartan_taken_shop_items}

    #to avoid running more code than necessary if there are no pacts taken whatsoever

    {CLEAR_VARIABLE spartan_pact_taken}
    {CLEAR_VARIABLE pacifist_debuff_active_thisdepth}
    {CLEAR_VARIABLE pact_wrath_active_thisdepth}

    [if]
        {VARIABLE_CONDITIONAL spartan_activepacts.length greater_than 0}
        [then]
            #important: this must go into negative values, otherwise the patience effect will trigger over and over sometimes
            {IF_VAR spartan_pact_patience greater_than -1 (
                [then]
                    {VARIABLE_OP spartan_pact_patience sub 1}
                [/then]
            )}

            {IF_VAR spartan_pact_patience equals 0 (
                [then]
                    [message]
                        speaker=narrator
                        caption=_"???"
                        message=_"Now, as agreed in our pact, here are your upgrades..."
                        image=wesnoth-icon.png
                    [/message]

                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                            {VARIABLE hoplite_upgradesleft1 4}
                            {VARIABLE hoplite_upgradesleft2 4}
                        [/then]
                        [else]
                            {VARIABLE hoplite_upgradesleft 4}
                        [/else]
                    [/if]

                    {VARIABLE spartan_upgrade_without_forge yes}#normal forge can still be used after pact upgrade
                    {IF_VAR bossfight equals yes (
                        [then]
                            #workaround to make sure upgrades can still be taken at the start of a boss fight with the pact
                            {VARIABLE bossfight no}
                            [fire_event]
                                id=forge_dialog
                            [/fire_event]
                            {VARIABLE bossfight yes}
                        [/then]
                        [else]
                            [fire_event]
                                id=forge_dialog
                            [/fire_event]
                        [/else]
                    )}
                    {CLEAR_VARIABLE spartan_upgrade_without_forge}
                    {SPARTAN_CLEAR_ACTIVEPACT spartan_pact_patience}
                [/then]
            )}
            #no effect in in shop depths
            {IF_VAR spartan_pact_forbidden_knowledge greater_than 0 (
                [then]
                    [if]
                        {VARIABLE_CONDITIONAL hoplite_biome not_equals rarebiome_mysterious_shop}
                        [then]
                            #for scatter units, the unit list is in order instead of random, so later depths will slowly start adding lvl2 shadows
                            {SCATTER_UNITS "$(1 + $hoplite_depth / 6)" Hoplite_Poltergeist,Hoplite_Poltergeist,Hoplite_Poltergeist,Hoplite_Shadow,Hoplite_Poltergeist,Hoplite_Shadow 0 (
                                terrain=!,{SPARTAN_WALL_TERRAIN}
                                [not]
                                    [filter]
                                    [/filter]
                                    [or]
                                        x=4-8
                                        y=8-10
                                    [/or]
                                [/not]
                            ) (
                                side=$hoplite_enemyside
                            )}
                            [sound]
                                name=wail.wav
                            [/sound]
                        [/then]
                    [/if]
                    {VARIABLE_OP spartan_pact_forbidden_knowledge sub 1}
                [/then]
                [else]
                [/else]
            )}
            {IF_VAR spartan_pact_forbidden_knowledge equals 0 (
                [then]
                    {SPARTAN_CLEAR_ACTIVEPACT spartan_pact_forbidden_knowledge}
                [/then]
            )}

            {IF_VAR spartan_pact_wrath greater_than 0 (
                [then]
                    {VARIABLE pact_wrath_active_thisdepth yes}
                    {VARIABLE_OP spartan_pact_wrath sub 1}
                [/then]
            )}
            {IF_VAR spartan_pact_wrath equals 0 (
                [then]
                    [remove_object]
                        id=Hoplite
                        object_id=pact_wrath
                    [/remove_object]
#ifdef MULTIPLAYER
                    [remove_object]
                        id=Hoplite2
                        object_id=pact_wrath
                    [/remove_object]
#endif
                    {SPARTAN_CLEAR_ACTIVEPACT spartan_pact_wrath}
                [/then]
            )}

            {IF_VAR spartan_pact_pacifist greater_than 0 (
                [then]
                    #no effect on boss or shop levels:
                    [if]
                        {VARIABLE_CONDITIONAL hoplite_biome not_equals rarebiome_mysterious_shop}
                        [not]
                            [have_unit]
                                ability=hoplite_boss
                                side=$hoplite_enemyside
                            [/have_unit]
                        [/not]
                        [then]
                            [store_unit]
                                [filter]
                                    side=$hoplite_enemyside
                                    [not]
                                        ability=hoplite_boss
                                    [/not]
                                [/filter]
                                variable=hoplite_converted_enemies
                                kill=no
                            [/store_unit]
                            #        {VARIABLE tmp_enemies_to_convert $hoplite_converted_enemies.length}
                            #        {VARIABLE_OP tmp_enemies_to_convert divide 3}
                            #        {VARIABLE tmp_enemies_to_convert divide 3}

                            #choosing a third of enemies (rounded up) from the end of the list, since the strongest enemies are usually there

                            {VARIABLE tmp_pacifist_startindex $hoplite_converted_enemies.length}
                            {VARIABLE_OP tmp_pacifist_startindex divide 3}
                            {VARIABLE_OP tmp_pacifist_startindex multiply 2}
                            {VARIABLE_OP tmp_pacifist_startindex round floor}#rounding down the start index, so the player gets more converted enemies

                            [while]
                                {VARIABLE_CONDITIONAL tmp_pacifist_startindex less_than $hoplite_converted_enemies.length}
                                [do]
                                    {MODIFY_UNIT id=$hoplite_converted_enemies[$tmp_pacifist_startindex].id side $hoplite_allyside}
                                    [floating_text]
                                        x,y=$hoplite_converted_enemies[$tmp_pacifist_startindex].x,$hoplite_converted_enemies[$tmp_pacifist_startindex].y
                                        text="<span color='#00ff00'>" + _ "persuaded!" + "</span>"
                                    [/floating_text]
                                    {VARIABLE_OP tmp_pacifist_startindex add 1}
                                [/do]
                            [/while]

                            #scrapped code:
                            #        [foreach]
                            #            array=hoplite_converted_enemies
                            #            index_var=i
                            #            [do]
                            #                {RANDOM 1..3}
                            #                {IF_VAR random equals 1 (
                            #                [then]
                            #                    {MODIFY_UNIT id=$this_item.id side $hoplite_allyside}
                            #                    [floating_text]
                            #                       x,y=$this_item.x,$this_item.y
                            #                       text="<span color='#00ff00'>" + _ "persuaded!" + "</span>"
                            #                    [/floating_text]
                            #                [/then]
                            #                )}
                            #            [/do]
                            #        [/foreach]
                            [sound]
                                name={SOUND_LIST:HOLY}
                            [/sound]
                            {VARIABLE pacifist_debuff_active_thisdepth yes}
                            {CLEAR_VARIABLE hoplite_converted_enemies}
                        [/then]
                    [/if]
                    {VARIABLE_OP spartan_pact_pacifist sub 1}
                [/then]
            )}

            {IF_VAR pacifist_debuff_active_thisdepth not_equals yes (
                #to prevent the pact being deleted on shop/boss levels
                [not]
                    {VARIABLE_CONDITIONAL spartan_pact_pacifist greater_than 0}
                [/not]
                [then]
                    {SPARTAN_CLEAR_ACTIVEPACT spartan_pact_pacifist}
                [/then]
            )}

            {IF_VAR spartan_pact_lightweight equals 0 (
                [then]
                    [remove_object]
                        id=Hoplite
                        object_id=pact_lightweight
                    [/remove_object]
#ifdef MULTIPLAYER
                    [remove_object]
                        id=Hoplite2
                        object_id=pact_lightweight
                    [/remove_object]
#endif

                    {SPARTAN_CLEAR_ACTIVEPACT spartan_pact_lightweight}
                [/then]
            )}
            #important: this must go into negative values, otherwise the patience effect will trigger over and over sometimes
            {IF_VAR spartan_pact_lightweight greater_than -1 (
                [then]
                    {VARIABLE_OP spartan_pact_lightweight sub 1}
                [/then]
            )}
        [/then]
    [/if]
[/event]
[event]
    name=turn refresh
    id=spartan_pact_pacifist_debuff
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL pacifist_debuff_active_thisdepth equals yes}
    [/filter_condition]
    {MODIFY_UNIT side=$hoplite_playerside attacks_left 0}
[/event]
#refreshing each turn, so that new attacks/flat damage buffs are accounted for
[event]
    name=turn refresh
    id=spartan_pact_wrath_effect
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL pact_wrath_active_thisdepth equals yes}
    [/filter_condition]
    [remove_object]
        id=Hoplite,Hoplite2
        side=$side_number
        object_id=pact_wrath
    [/remove_object]
    [object]
        silent=yes
        duration=forever
        id=pact_wrath
        take_only_once=no
        [filter]
            id=Hoplite,Hoplite2
            side=$side_number
        [/filter]
        [effect]
            apply_to=attack
            increase_damage=66%
        [/effect]
        [effect]
            apply_to=resistance
            replace=no
            [resistance]
                blade=50
                pierce=50
                impact=50
                arcane=50
                fire=50
                cold=50
            [/resistance]
        [/effect]
    [/object]
    #    {MODIFY_UNIT side=$hoplite_playerside attacks_left 0}
[/event]
[event]
    name=turn refresh
    id=spartan_pact_lightweight_energyrestore
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL spartan_pact_lightweight greater_than 0}
        [and]
            [have_unit]
                side=$hoplite_playerside
                [and]
                    side=$side_number
                [/and]
            [/have_unit]
        [/and]
    [/filter_condition]
    {HOPLITE_ADD_ENERGY_BY_SIDE $side_number 20}
[/event]
[event]
    name=turn 1
    id=spartan_load_shop_achievement
    {VARIABLE favorite_customer_progress1 $spartan_orbshop_data1.orbs_spent}
    {IF_VAR favorite_customer_progress1 greater_than_equal_to 10 (
        [then]
            {ACHIEVEMENT_MESSAGE_LONE favorite_customer 1}
        [/then]
    )}
#ifdef MULTIPLAYER
    {VARIABLE favorite_customer_progress2 $spartan_orbshop_data2.orbs_spent}
    {IF_VAR favorite_customer_progress2 greater_than_equal_to 10 (
        [then]
            {ACHIEVEMENT_MESSAGE_LONE favorite_customer 2}
        [/then]
    )}
#endif
[/event]
#enddef
