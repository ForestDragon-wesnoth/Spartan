#textdomain wesnoth-Hoplite

#define HOPLITE_IFHAVELOC LOC1 DIR STORELOC
    [store_locations]
        [filter_adjacent_location]
            x,y={LOC1}
            adjacent={DIR}
        [/filter_adjacent_location]
        variable=targethex_test
        include_borders=no
    [/store_locations]
    [if]
        [have_location]
            x=$targethex_test.x
            y=$targethex_test.y
	    [not]
            terrain=Xu*,Xo*
	    [/not]
	    [filter_adjacent_location]
                x,y={LOC1}
	    [/filter_adjacent_location]
#            [and]
#                x,y={LOC1}
#                radius=1
#            [/and]
        [/have_location]
	[and]
        [have_location]
            x=$targethex_test.x
            y=$targethex_test.y
        [/have_location]
	[/and]
	[and]
        [have_location]
            x,y={LOC1}
	    terrain=!,Xu*,Xo*
        [/have_location]
	[/and]
        [then]
            {STORELOC}
        [/then]
        [else]
        [/else]
    [/if]
    {CLEAR_VARIABLE targethex_test}
#enddef

#define STORE_TARGETLOCS_PART VAR DIR
    [store_locations]
        terrain=!,Xu*,Xo*
        [filter_adjacent_location]
            x,y=${VAR}[$a].x,${VAR}[$a].y
            adjacent={DIR}
        [/filter_adjacent_location]
        variable=targethex_{VAR}1[$a]{DIR}
        include_borders=no
    [/store_locations]
    {HOPLITE_IFHAVELOC $targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y {DIR} (
        [store_locations]
            terrain=!,Xu*,Xo*
            [filter_adjacent_location]
                x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                adjacent={DIR}
            [/filter_adjacent_location]
            variable=targethex_{VAR}2[$a]{DIR}
            include_borders=no
    [/store_locations]
    )}
    {HOPLITE_IFHAVELOC $targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y {DIR} (
        [store_locations]
            terrain=!,Xu*,Xo*
            [filter_adjacent_location]
                x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                adjacent={DIR}
            [/filter_adjacent_location]
            variable=targethex_{VAR}3[$a]{DIR}
            include_borders=no
    [/store_locations]
    )}
    {IF_VAR linelength3 not_equals yes (
        [then]
            {HOPLITE_IFHAVELOC $targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y {DIR} (
                [store_locations]
                    terrain=!,Xu*,Xo*
                    [filter_adjacent_location]
                        x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                        adjacent={DIR}
                    [/filter_adjacent_location]
                    variable=targethex_{VAR}4[$a]{DIR}
                    include_borders=no
    [/store_locations]
            )}
        [/then]
    )}
    {IF_VAR linelength5 equals yes (
        [then]
            {HOPLITE_IFHAVELOC $targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y {DIR} (
                [store_locations]
                    terrain=!,Xu*,Xo*
                    [filter_adjacent_location]
                        x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                        adjacent={DIR}
                    [/filter_adjacent_location]
                    variable=targethex_{VAR}5[$a]{DIR}
                    include_borders=no
    [/store_locations]
            )}
        [/then]
    )}
#enddef

#define STORE_TARGETHEX_LOC VAR
    {STORE_TARGETLOCS_PART {VAR} n}
    {STORE_TARGETLOCS_PART {VAR} ne}
    {STORE_TARGETLOCS_PART {VAR} nw}
    {STORE_TARGETLOCS_PART {VAR} s}
    {STORE_TARGETLOCS_PART {VAR} se}
    {STORE_TARGETLOCS_PART {VAR} sw}
#enddef

#define TARGETUNITS_FILTER_PART VAR DIR
    [or]
        side=$hoplite_playerside,$hoplite_allyside
        x,y=$targethex_{VAR}1[$a]{DIR}.x,$targethex_{VAR}1[$a]{DIR}.y
        [not]
            ability_type_active=hides
        [/not]
    [/or]
    [or]
        side=$hoplite_playerside,$hoplite_allyside
        x,y=$targethex_{VAR}2[$a]{DIR}.x,$targethex_{VAR}2[$a]{DIR}.y
        [not]
            ability_type_active=hides
        [/not]
    [/or]
    [or]
        side=$hoplite_playerside,$hoplite_allyside
        x,y=$targethex_{VAR}3[$a]{DIR}.x,$targethex_{VAR}3[$a]{DIR}.y
        [not]
            ability_type_active=hides
        [/not]
    [/or]
    [or]
        side=$hoplite_playerside,$hoplite_allyside
        x,y=$targethex_{VAR}4[$a]{DIR}.x,$targethex_{VAR}4[$a]{DIR}.y
        [not]
            ability_type_active=hides
        [/not]
    [/or]
#enddef

#define TARGETUNITS_FILTER_PART2 VAR DIR
    [or]
        side=$hoplite_playerside,$hoplite_allyside
        x,y=$targethex_{VAR}1[$a]{DIR}.x,$targethex_{VAR}1[$a]{DIR}.y
        [not]
            ability_type_active=hides
        [/not]
    [/or]
    [or]
        side=$hoplite_playerside,$hoplite_allyside
        x,y=$targethex_{VAR}2[$a]{DIR}.x,$targethex_{VAR}2[$a]{DIR}.y
        [not]
            ability_type_active=hides
        [/not]
    [/or]
    [or]
        side=$hoplite_playerside,$hoplite_allyside
        x,y=$targethex_{VAR}3[$a]{DIR}.x,$targethex_{VAR}3[$a]{DIR}.y
        [not]
            ability_type_active=hides
        [/not]
    [/or]
    [or]
        side=$hoplite_playerside,$hoplite_allyside
        x,y=$targethex_{VAR}4[$a]{DIR}.x,$targethex_{VAR}4[$a]{DIR}.y
        [not]
            ability_type_active=hides
        [/not]
    [/or]
    [or]
        side=$hoplite_playerside,$hoplite_allyside
        x,y=$targethex_{VAR}5[$a]{DIR}.x,$targethex_{VAR}5[$a]{DIR}.y
        [not]
            ability_type_active=hides
        [/not]
    [/or]
#enddef

#define TARGETUNITS_FILTER VAR
    {TARGETUNITS_FILTER_PART {VAR} n}
    {TARGETUNITS_FILTER_PART {VAR} ne}
    {TARGETUNITS_FILTER_PART {VAR} nw}
    {TARGETUNITS_FILTER_PART {VAR} s}
    {TARGETUNITS_FILTER_PART {VAR} se}
    {TARGETUNITS_FILTER_PART {VAR} sw}
#enddef

##define SHORTRANGED_MACRO TYPE VAR WEAPON WEAPONTYPE
##    [event]
##        name=side turn
##       first_time_only=no
##		{CHATMSG "shortranged macro {TYPE}"}
#	[if]
#	[have_unit]
#	  type={TYPE}
#	  side=$side_number
#	[/have_unit]
#	[then]
#        [store_unit]
#            [filter]
#                type={TYPE}
#                side=$side_number
#                [filter_adjacent]
#                    [filter_side]
#                        [enemy_of]
#                            side=$side_number
#                        [/enemy_of]
#                    [/filter_side]
#                [/filter_adjacent]
#                [not]
#                    [filter_wml]
#                        [status]
#                            slowed=yes
#                        [/status]
#                    [/filter_wml]
#                [/not]
#            [/filter]
#            variable={VAR}
#        [/store_unit]
##		{IF_VAR {VAR}.length greater_than 0 (
##		[then]
#        {FOREACH {VAR} a}
#            [store_unit]
#                [filter]
#                    [not]
#                        ability_type_active=hides
#                    [/not]
#                    [filter_side]
#                        [enemy_of]
#                            side=$side_number
#                        [/enemy_of]
#                    [/filter_side]
#                    [filter_adjacent]
#                        id=${VAR}[$a].id
#                    [/filter_adjacent]
#                [/filter]
#                variable={VAR}_target
#            [/store_unit]
#            {IF_VAR {VAR}_target.length greater_than 0 (
#                [then]
#                    {IF_VAR {VAR}_target.length greater_than 1 (
#                        [then]
#                            {RANDOM 0..${VAR}_target.length}
#                            [if]
#                                [have_unit]
#                                    id=${VAR}_target[$random].id
#                                    [filter_adjacent]
#                                        id=${VAR}[$a].id
#                                        is_enemy=yes
#                                    [/filter_adjacent]
#                                [/have_unit]
#                                [else]
#                                    {VARIABLE random 0}
#                                [/else]
#                            [/if]
#                        [/then]
#                        [else]
#                            {VARIABLE random 0}
#                        [/else]
#                    )}
#                    {VARIABLE {VAR}[$a].attacks_left 0}
#                    {VARIABLE {VAR}[$a].moves 0}
#                    [unstore_unit]
#                        variable={VAR}[$a]
#                    [/unstore_unit]
#                    {VARIABLE teleportaway_cost ${VAR}[$a].attack[0].damage}
#                    {VARIABLE_OP teleportaway_cost divide 10}
#                    {VARIABLE_OP teleportaway_cost multiply 75}
#                    {VARIABLE_OP teleportaway_cost round floor}
#                    {HOPLITE_TELEPORTAWAY_EVENT $teleportaway_cost (
#                        [filter]
#                            x,y=${VAR}_target[$random].x,${VAR}_target[$random].y
#                            [filter_adjacent]
#                                type={TYPE}
#                                side=$hoplite_enemyside
#                            [/filter_adjacent]
#                        [/filter]
#                    )}
#                    {CLEAR_VARIABLE teleportaway_cost}
#                    [if]
#                        [have_unit]
#                            id=${VAR}[$a].id
#                            ability=impaled
#                        [/have_unit]
#                        [then]
#                            {VARIABLE impaleddmg ${VAR}[$a].attack[0].damage}
#                            {VARIABLE_OP impaleddmg multiply 0.66}
#                            {VARIABLE_OP impaleddmg round floor}
#                            [harm_unit]
#                                [filter]
#                                    id=${VAR}_target[$random].id
#                                    [filter_adjacent]
#                                        id=${VAR}[$a].id
#                                        ability=impaled
#                                        is_enemy=yes
#                                    [/filter_adjacent]
#                                [/filter]
#                                [filter_second]
#                                    id=${VAR}[$a].id
#                                [/filter_second]
#                                [primary_attack]
#                                    name={WEAPON}
#                                [/primary_attack]
#                                amount=$impaleddmg
#                                damage_type={WEAPONTYPE}
#                                alignment=${VAR}[$a].alignment
#                                fire_event=yes
#                                animate=yes
#                                delay=0
#                                experience=no
#                            [/harm_unit]
#                        [/then]
#                        [else]
#                            [harm_unit]
#                                [filter]
#                                    id=${VAR}_target[$random].id
#                                    [filter_adjacent]
#                                        id=${VAR}[$a].id
#                                        is_enemy=yes
#                                        [not]
#                                            ability=impaled
#                                        [/not]
#                                    [/filter_adjacent]
#                                [/filter]
#                                [filter_second]
#                                    id=${VAR}[$a].id
#                                [/filter_second]
#                                [primary_attack]
#                                    name={WEAPON}
#                                [/primary_attack]
#                                amount=${VAR}[$a].attack[0].damage
#                                damage_type={WEAPONTYPE}
#                                alignment=${VAR}[$a].alignment
#                                fire_event=yes
#                                animate=yes
#                                delay=0
#                                experience=no
#                            [/harm_unit]
#                        [/else]
#                    [/if]
#                    {CLEAR_VARIABLE {VAR}[$a]}
#                    {CLEAR_VARIABLE {VAR}_target}
#                    {CLEAR_VARIABLE impaleddmg}
#                [/then]
#            )}
#        {NEXT a}
##		[/then]
##		)}
#        [fire_event]
#	    id=hoplite_adrenaline
#	[/fire_event]
#	[/then]
#	[/if]
##    [/event]
##enddef
#
##define SHORTRANGED_MACRO_ALLY TYPE VAR WEAPON WEAPONTYPE
#	[if]
#	[have_unit]
#	  type={TYPE}
#	  side=$hoplite_allyside
#	[/have_unit]
#	[then]
#        [store_unit]
#            [filter]
#                type={TYPE}
#                side=$hoplite_allyside
#                [filter_adjacent]
#		    side=$hoplite_enemyside
#                [/filter_adjacent]
#                [not]
#                    [filter_wml]
#                        [status]
#                            slowed=yes
#                        [/status]
#                    [/filter_wml]
#                [/not]
#            [/filter]
#            variable={VAR}
#        [/store_unit]
#        {FOREACH {VAR} a}
#            [store_unit]
#                [filter]
#		    side=$hoplite_enemyside
#                    [not]
#                        ability_type_active=hides
#                    [/not]
#                    [filter_adjacent]
#                        id=${VAR}[$a].id
#                    [/filter_adjacent]
#                [/filter]
#                variable={VAR}_target
#            [/store_unit]
#            {IF_VAR {VAR}_target.length greater_than 0 (
#                [then]
#                    {IF_VAR {VAR}_target.length greater_than 1 (
#                        [then]
#                            {RANDOM 0..${VAR}_target.length}
#                            [if]
#                                [have_unit]
#                                    id=${VAR}_target[$random].id
#                                    [filter_adjacent]
#                                        id=${VAR}[$a].id
#                                        is_enemy=yes
#                                    [/filter_adjacent]
#                                [/have_unit]
#                                [else]
#                                    {VARIABLE random 0}
#                                [/else]
#                            [/if]
#                        [/then]
#                        [else]
#                            {VARIABLE random 0}
#                        [/else]
#                    )}
#                    {VARIABLE {VAR}[$a].attacks_left 0}
#                    {VARIABLE {VAR}[$a].moves 0}
#                    [unstore_unit]
#                        variable={VAR}[$a]
#                    [/unstore_unit]
#                            [harm_unit]
#                                [filter]
#                                    id=${VAR}_target[$random].id
#                                    [filter_adjacent]
#                                        id=${VAR}[$a].id
#                                        is_enemy=yes
#                                        [not]
#                                            ability=impaled
#                                        [/not]
#                                    [/filter_adjacent]
#                                [/filter]
#                                [filter_second]
#                                    id=${VAR}[$a].id
#                                [/filter_second]
#                                [primary_attack]
#                                    name={WEAPON}
#                                [/primary_attack]
#                                amount=${VAR}[$a].attack[0].damage
#                                damage_type={WEAPONTYPE}
#                                alignment=${VAR}[$a].alignment
#                                fire_event=yes
#                                animate=yes
#                                delay=0
#                                experience=no
#                            [/harm_unit]
#                    {CLEAR_VARIABLE {VAR}[$a]}
#                    {CLEAR_VARIABLE {VAR}_target}
#                    {CLEAR_VARIABLE impaleddmg}
#                [/then]
#            )}
#        {NEXT a}
#        [fire_event]
#	    id=hoplite_adrenaline
#	[/fire_event]
#	[/then]
#	[/if]
##    [/event]
##enddef

#define ARCHERY_MACRO TYPE VAR WEAPON WEAPONTYPE ENERGY
    [if]
    [have_unit]
       type={TYPE}
    [/have_unit]
    [then]
    [store_unit]
        [filter]
            type={TYPE}
            side=$side_number
            [not]
                [filter_wml]
                    [status]
                        slowed=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]
        variable={VAR}
        kill=no
    [/store_unit]
#	{IF_VAR {VAR}.length greater_than 0 (
#	[then]
    {FOREACH {VAR} a}
        [if]
            [have_unit]
                id=${VAR}[$a].id
                ability=hoplite_charging
            [/have_unit]
            [then]
                [animate_unit]
                    flag=idle
                    [facing]
                        [filter]
                            id=Hoplite
                        [/filter]
                    [/facing]
                    [filter]
                        x=${VAR}[$a].x
                        y=${VAR}[$a].y
                    [/filter]
                [/animate_unit]
                [remove_item]
                    image=misc/targethex-archer.png
                    x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                [/remove_item]
                [remove_item]
                    image=misc/targethex-archer.png
                    x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                [/remove_item]
                [remove_item]
                    image=misc/targethex-archer.png
                    x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                [/remove_item]
                [store_unit]
                    [filter]
                        side=$hoplite_playerside,$hoplite_allyside
                        x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                        [not]
                            ability_type_active=hides
                        [/not]
                        [or]
                            side=$hoplite_playerside,$hoplite_allyside
                            x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                            [not]
                                ability_type_active=hides
                            [/not]
                        [/or]
                        [or]
                            side=$hoplite_playerside,$hoplite_allyside
                            x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                            [not]
                                ability_type_active=hides
                            [/not]
                        [/or]
                    [/filter]
                    variable={VAR}_target
                [/store_unit]
                {IF_VAR {VAR}_target.length greater_than 0 (
                    [then]
                        [fire_event]
                            name=attack#to trigger teleportaway event
                            [primary_unit]
                                id=${VAR}[$a].id
                            [/primary_unit]
                            [secondary_unit]
                                x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                                [not]
                                    ability_type_active=hides
                                [/not]
                                [or]
                                    x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                                    [not]
                                        ability_type_active=hides
                                    [/not]
                                [/or]
                                [or]
                                    x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                                    [not]
                                        ability_type_active=hides
                                    [/not]
                                [/or]                                
                            [/secondary_unit]
                            [primary_attack]
                                name={WEAPON}
                            [/primary_attack]
                        [/fire_event]
                        [harm_unit]
                            [filter]
                                id=${VAR}_target[0].id
                                x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                                [not]
                                    ability_type_active=hides
                                [/not]
                                [or]
                                    id=${VAR}_target[0].id
                                    x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                                    [not]
                                        ability_type_active=hides
                                    [/not]
                                [/or]
                                [or]
                                    id=${VAR}_target[0].id
                                    x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                                    [not]
                                        ability_type_active=hides
                                    [/not]
                                [/or]
                            [/filter]
                            [filter_second]
                                id=${VAR}[$a].id
                            [/filter_second]
                            [primary_attack]
                                name={WEAPON}
                            [/primary_attack]
                            amount=${VAR}[$a].attack.damage
                            damage_type={WEAPONTYPE}
                            alignment=$unit.alignment
                            fire_event=yes
                            animate=yes
                            delay=0
                            experience=no
                        [/harm_unit]
                        [fire_event]
                 	    id=hoplite_adrenaline
                 	[/fire_event]
                    [/then]
                )}
                {MODIFY_UNIT id=${VAR}[$a].id max_moves 1}
                {MODIFY_UNIT id=${VAR}[$a].id moves 1}
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        find_in={VAR}[$a]
                    [/filter]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [dummy]
                                id=hoplite_charging
                            [/dummy]
                        [/abilities]
                    [/effect]
                [/object]
                {CLEAR_VARIABLE {VAR}[$a]}
                {CLEAR_VARIABLE {VAR}_target}
                {CLEAR_VARIABLE targethex_{VAR}1[$a]}
                {CLEAR_VARIABLE targethex_{VAR}2[$a]}
                {CLEAR_VARIABLE targethex_{VAR}3[$a]}
                {CLEAR_VARIABLE targethex_{VAR}4[$a]}
            [/then]
	    [/if]
            [if]
            [have_unit]
                id=${VAR}[$a].id
                ability=hoplite_charging
            [/have_unit]
            [else]
                {STORE_TARGETHEX_LOC {VAR}}
                [store_unit]
                    [filter]
                        side=$hoplite_playerside,$hoplite_allyside
                        {TARGETUNITS_FILTER {VAR}}
                        [not]
                            ability_type_active=hides
                        [/not]
                    [/filter]
                    variable=hoplite_loc
                    kill=no
                [/store_unit]
                {RANDOM 0..$hoplite_loc.length}
                {VARIABLE {VAR}_hopliteloc_x $hoplite_loc[$random].x}
                {VARIABLE {VAR}_hopliteloc_y $hoplite_loc[$random].y}
                [animate_unit]
                    flag=standing
                    [facing]
                        [filter]
                            x=${VAR}_hopliteloc_x
                            y=${VAR}_hopliteloc_y
                        [/filter]
                    [/facing]
                    [filter]
                        x=${VAR}[$a].x
                        y=${VAR}[$a].y
                    [/filter]
                [/animate_unit]
                [store_locations]
                    terrain=!,Xu*,Xo*
                    [filter_adjacent_location]
                        x,y=${VAR}[$a].x,${VAR}[$a].y
                        adjacent=-${VAR}[$a].facing
                    [/filter_adjacent_location]
                    variable=targethex_{VAR}1[$a]
                    include_borders=no
                [/store_locations]
                {HOPLITE_IFHAVELOC $targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y -${VAR}[$a].facing (
                    [store_locations]
                        terrain=!,Xu*,Xo*
                        [filter_adjacent_location]
                            x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                            adjacent=-${VAR}[$a].facing
                        [/filter_adjacent_location]
                        variable=targethex_{VAR}2[$a]
                        include_borders=no
                   [/store_locations]                
                )}
                {HOPLITE_IFHAVELOC $targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y -${VAR}[$a].facing (
                    [store_locations]
                        terrain=!,Xu*,Xo*
                        [filter_adjacent_location]
                            x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                            adjacent=-${VAR}[$a].facing
                        [/filter_adjacent_location]
                        variable=targethex_{VAR}3[$a]
                        include_borders=no
                   [/store_locations]
                )}
                {HOPLITE_IFHAVELOC $targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y -${VAR}[$a].facing (
                    [store_locations]
                        terrain=!,Xu*,Xo*
                        [filter_adjacent_location]
                            x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                            adjacent=-${VAR}[$a].facing
                        [/filter_adjacent_location]
                        variable=targethex_{VAR}4[$a]
                        include_borders=no
                   [/store_locations]
                )}
                [if]
                    [have_unit]
                        side=$hoplite_playerside,$hoplite_allyside
                        x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                        [not]
                            ability_type_active=hides
                        [/not]
                        [or]
                            side=$hoplite_playerside,$hoplite_allyside
                            x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                            [not]
                                ability_type_active=hides
                            [/not]
                        [/or]
                        [or]
                            side=$hoplite_playerside,$hoplite_allyside
                            x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                            [not]
                                ability_type_active=hides
                            [/not]
                        [/or]
                    [/have_unit]
                    [then]
                        [item]
                            x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                            image="misc/targethex-archer.png"
                        [/item]
                        [item]
                            x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                            image="misc/targethex-archer.png"
                        [/item]
                        [item]
                            x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                            image="misc/targethex-archer.png"
                        [/item]
                        [sound]
                            name=magic-dark-big-miss.ogg
                        [/sound]
                        [object]
                            silent=yes
                            [filter]
                                find_in={VAR}[$a]
                            [/filter]
                            [effect]
                                apply_to=new_ability
                                duration=scenario
                                [abilities]
                                    [dummy]
                                        id=hoplite_charging
                                    [/dummy]
                                [/abilities]
                            [/effect]
                        [/object]
                        {MODIFY_UNIT id=${VAR}[$a].id moves 0}
                        {MODIFY_UNIT id=${VAR}[$a].id max_moves 0}
                    [/then]
                [/if]
            [/else]
        [/if]
    {NEXT a}
    [/then]
    [/if]
#	[/then]
#	)}
    {CLEAR_VARIABLE hoplite_loc}
#enddef

#define WIZARDBEAM4_MACRO TYPE VAR WEAPON WEAPONTYPE ENERGY
    [if]
    [have_unit]
       type={TYPE}
       side=$side_number
    [/have_unit]
    [then]
    [store_unit]
        [filter]
            type={TYPE}
            side=$side_number
            [not]
                [filter_wml]
                    [status]
                        slowed=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]
        variable={VAR}
        kill=no
    [/store_unit]
#	{IF_VAR {VAR}.length greater_than 0 (
#	[then]
    {FOREACH {VAR} a}
        [if]
            [have_unit]
                id=${VAR}[$a].id
                ability=hoplite_charging
            [/have_unit]
            [then]
                [object]
                    silent=yes
                    duration=turn
                    [filter]
                        find_in={VAR}[$a]
                    [/filter]
                    [effect]
                        apply_to=status
                        add=uncovered
                    [/effect]
                [/object]
                [redraw]
                [/redraw]
                [animate_unit]
                    flag=idle
                    [facing]
                        [filter]
                            id=Hoplite
                        [/filter]
                    [/facing]
                    [filter]
                        x=${VAR}[$a].x
                        y=${VAR}[$a].y
                    [/filter]
                [/animate_unit]
                [remove_item]
                    image=misc/targethex.png
                    x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                [/remove_item]
                [remove_item]
                    image=misc/targethex.png
                    x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                [/remove_item]
                [remove_item]
                    image=misc/targethex.png
                    x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                [/remove_item]
                [remove_item]
                    image=misc/targethex.png
                    x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                [/remove_item]
                [store_unit]
                    [filter]
                        side=$hoplite_playerside,$hoplite_allyside
                        x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                        [not]
                            ability_type_active=hides
                        [/not]
                        [or]
                            side=$hoplite_playerside,$hoplite_allyside
                            x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                            [not]
                                ability_type_active=hides
                            [/not]
                        [/or]
                        [or]
                            side=$hoplite_playerside,$hoplite_allyside
                            x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                            [not]
                                ability_type_active=hides
                            [/not]
                        [/or]
                        [or]
                            side=$hoplite_playerside,$hoplite_allyside
                            x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                            [not]
                                ability_type_active=hides
                            [/not]
                        [/or]
                    [/filter]
                    variable={VAR}_target
                [/store_unit]
                {IF_VAR {VAR}_target.length greater_than 0 (
                    [then]
                        [fire_event]
                            name=attack#to trigger teleportaway event
                            [primary_unit]
                                id=${VAR}[$a].id
                            [/primary_unit]
                            [secondary_unit]
                                x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                                [not]
                                    ability_type_active=hides
                                [/not]
                                [or]
                                    x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                                    [not]
                                        ability_type_active=hides
                                    [/not]
                                [/or]
                                [or]
                                    x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                                    [not]
                                        ability_type_active=hides
                                    [/not]
                                [/or]
                                [or]
                                    x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                                    [not]
                                        ability_type_active=hides
                                    [/not]
                                [/or]
                            [/secondary_unit]
                            [primary_attack]
                                name={WEAPON}
                            [/primary_attack]
                        [/fire_event]
                        {IF_VAR {VAR}_target.length greater_than 1 (
                            [then]
                                [animate_unit]
                                    flag=attack
                                    [filter]
                                        id=${VAR}[$a].id
                                    [/filter]
                                    [primary_attack]
                                        name={WEAPON}
                                    [/primary_attack]
                                    hits=yes
                                    [facing]
                                        x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                                    [/facing]
                                [/animate_unit]
                                [fire_event]
                                    name=attack#to trigger teleportaway event
                                    [primary_unit]
                                        id=${VAR}[$a].id
                                    [/primary_unit]
                                    [secondary_unit]
                                        x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                                        [not]
                                            ability_type_active=hides
                                        [/not]
                                        [or]
                                            x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                                            [not]
                                                ability_type_active=hides
                                            [/not]
                                        [/or]
                                        [or]
                                            x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                                            [not]
                                                ability_type_active=hides
                                            [/not]
                                        [/or]
                                        [or]
                                            x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                                            [not]
                                                ability_type_active=hides
                                            [/not]
                                        [/or]
                                    [/secondary_unit]
                                    [primary_attack]
                                        name={WEAPON}
                                    [/primary_attack]
                                [/fire_event]
                                [harm_unit]
                                    [filter]
                                        side=$hoplite_playerside,$hoplite_allyside
                                        x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                                        [or]
                                            side=$hoplite_playerside,$hoplite_allyside
                                            x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                                        [/or]
                                        [or]
                                            side=$hoplite_playerside,$hoplite_allyside
                                            x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                                        [/or]
                                        [or]
                                            side=$hoplite_playerside,$hoplite_allyside
                                            x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                                        [/or]
                                    [/filter]
                                    [filter_second]
                                        id=${VAR}[$a].id
                                    [/filter_second]
                                    [primary_attack]
                                        name={WEAPON}
                                    [/primary_attack]
                                    amount=${VAR}[$a].attack.damage
                                    damage_type={WEAPONTYPE}
                                    alignment=$unit.alignment
                                    fire_event=yes
                                    animate=defender
                                    delay=0
                                    experience=no
                                [/harm_unit]
                            [/then]
                            [else]
                                [harm_unit]
                                    [filter]
                                        side=$hoplite_playerside,$hoplite_allyside
                                        x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                                        [or]
                                            side=$hoplite_playerside,$hoplite_allyside
                                            x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                                        [/or]
                                        [or]
                                            side=$hoplite_playerside,$hoplite_allyside
                                            x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                                        [/or]
                                        [or]
                                            side=$hoplite_playerside,$hoplite_allyside
                                            x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                                        [/or]
                                    [/filter]
                                    [filter_second]
                                        id=${VAR}[$a].id
                                    [/filter_second]
                                    [primary_attack]
                                        name={WEAPON}
                                    [/primary_attack]
                                    amount=${VAR}[$a].attack.damage
                                    damage_type={WEAPONTYPE}
                                    alignment=$unit.alignment
                                    fire_event=yes
                                    animate=yes
                                    delay=0
                                    experience=no
                                [/harm_unit]
                            [/else]
                        )}
                    [/then]
                )}
                [fire_event]
                     id=hoplite_adrenaline
                [/fire_event]
                {MODIFY_UNIT id=${VAR}[$a].id max_moves 1}
                {MODIFY_UNIT id=${VAR}[$a].id moves 1}
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        find_in={VAR}[$a]
                    [/filter]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [dummy]
                                id=hoplite_charging
                            [/dummy]
                        [/abilities]
                    [/effect]
                [/object]
                {CLEAR_VARIABLE {VAR}[$a]}
                {CLEAR_VARIABLE {VAR}_target}
                {CLEAR_VARIABLE targethex_{VAR}1[$a]}
                {CLEAR_VARIABLE targethex_{VAR}2[$a]}
                {CLEAR_VARIABLE targethex_{VAR}3[$a]}
                {CLEAR_VARIABLE targethex_{VAR}4[$a]}
            [/then]
	    [/if]
            [if]
            [have_unit]
                id=${VAR}[$a].id
                ability=hoplite_charging
            [/have_unit]
            [else]
                {STORE_TARGETHEX_LOC {VAR}}
                [store_unit]
                    [filter]
                        side=$hoplite_playerside,$hoplite_allyside
                        {TARGETUNITS_FILTER {VAR}}
                        [not]
                            ability_type_active=hides
                        [/not]
                    [/filter]
                    variable=hoplite_loc
                    kill=no
                [/store_unit]
                {RANDOM 0..$hoplite_loc.length}
                {VARIABLE {VAR}_hopliteloc_x $hoplite_loc[$random].x}
                {VARIABLE {VAR}_hopliteloc_y $hoplite_loc[$random].y}
                [animate_unit]
                    flag=standing
                    [facing]
                        [filter]
                            x=${VAR}_hopliteloc_x
                            y=${VAR}_hopliteloc_y
                        [/filter]
                    [/facing]
                    [filter]
                        x=${VAR}[$a].x
                        y=${VAR}[$a].y
                    [/filter]
                [/animate_unit]
                {HOPLITE_IFHAVELOC ${VAR}[$a].x,${VAR}[$a].y -${VAR}[$a].facing (
                    [store_locations]
                        terrain=!,Xu*,Xo*
                        [filter_adjacent_location]
                            x,y=${VAR}[$a].x,${VAR}[$a].y
                            adjacent=-${VAR}[$a].facing
                        [/filter_adjacent_location]
                        variable=targethex_{VAR}1[$a]
                        include_borders=no
                   [/store_locations]
                )}
                {HOPLITE_IFHAVELOC $targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y -${VAR}[$a].facing (
                    [store_locations]
                        terrain=!,Xu*,Xo*
                        [filter_adjacent_location]
                            x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                            adjacent=-${VAR}[$a].facing
                        [/filter_adjacent_location]
                        variable=targethex_{VAR}2[$a]
                        include_borders=no
                   [/store_locations]
                )}
                {HOPLITE_IFHAVELOC $targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y -${VAR}[$a].facing (
                    [store_locations]
                        terrain=!,Xu*,Xo*
                        [filter_adjacent_location]
                            x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                            adjacent=-${VAR}[$a].facing
                        [/filter_adjacent_location]
                        variable=targethex_{VAR}3[$a]
                        include_borders=no
                   [/store_locations]
                )}
                {HOPLITE_IFHAVELOC $targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y -${VAR}[$a].facing (
                    [store_locations]
                        terrain=!,Xu*,Xo*
                        [filter_adjacent_location]
                            x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                            adjacent=-${VAR}[$a].facing
                        [/filter_adjacent_location]
                        variable=targethex_{VAR}4[$a]
                        include_borders=no
                   [/store_locations]
                )}
                [if]
                    [have_unit]
                        side=$hoplite_playerside,$hoplite_allyside
                        x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                        [not]
                            ability_type_active=hides
                        [/not]
                        [or]
                            side=$hoplite_playerside,$hoplite_allyside
                            x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                            [not]
                                ability_type_active=hides
                            [/not]
                        [/or]
                        [or]
                            side=$hoplite_playerside,$hoplite_allyside
                            x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                            [not]
                                ability_type_active=hides
                            [/not]
                        [/or]
                    [/have_unit]
                    [then]
                        [item]
                            x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                            image="misc/targethex.png"
                        [/item]
                        [item]
                            x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                            image="misc/targethex.png"
                        [/item]
                        [item]
                            x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                            image="misc/targethex.png"
                        [/item]
                        [item]
                            x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                            image="misc/targethex.png"
                        [/item]
                        [sound]
                            name=magic-dark-big-miss.ogg
                        [/sound]
                        [object]
                            silent=yes
                            duration=scenario
                            [filter]
                                find_in={VAR}[$a]
                            [/filter]
                            [effect]
                                apply_to=new_ability
                                [abilities]
                                    [dummy]
                                        id=hoplite_charging
                                    [/dummy]
                                [/abilities]
                            [/effect]
                        [/object]
                        {MODIFY_UNIT id=${VAR}[$a].id moves 0}
                        {MODIFY_UNIT id=${VAR}[$a].id max_moves 0}
                    [/then]
                [/if]
            [/else]
        [/if]
    {NEXT a}
#	[/then]
#	)}
    [/then]
    [/if]
    {CLEAR_VARIABLE hoplite_loc}
#enddef

#define SLOWATTACK TYPE VAR WEAPON WEAPONTYPE ENERGY LINEVAR IMG
    [if]
    [have_unit]
       type={TYPE}
       side=$side_number
    [/have_unit]
    [then]
    [store_unit]
        [filter]
            type={TYPE}
            side=$side_number
            [not]
                [filter_wml]
                    [status]
                        slowed=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter]
        variable={VAR}
        kill=no
    [/store_unit]
#	{IF_VAR {VAR}.length greater_than 0 (
#	[then]
    {FOREACH {VAR} a}
        [if]
            [have_unit]
                id=${VAR}[$a].id
                ability=hoplite_charging
            [/have_unit]
            [then]
                {VARIABLE {LINEVAR} yes}
                [remove_item]
                    image=misc/{IMG}.png
                    x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                [/remove_item]
                [remove_item]
                    image=misc/{IMG}.png
                    x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                [/remove_item]
                [remove_item]
                    image=misc/{IMG}.png
                    x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                [/remove_item]
                [store_unit]
                    [filter]
                        side=$hoplite_playerside,$hoplite_allyside
                        x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                        [not]
                            ability_type_active=hides
                        [/not]
                        [or]
                            side=$hoplite_playerside,$hoplite_allyside
                            x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                            [not]
                                ability_type_active=hides
                            [/not]
                        [/or]
                        [or]
                            side=$hoplite_playerside,$hoplite_allyside
                            x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                            [not]
                                ability_type_active=hides
                            [/not]
                        [/or]
                    [/filter]
                    variable={VAR}_target
                [/store_unit]
                {IF_VAR {VAR}_target.length greater_than 0 (
                    [then]
                        [fire_event]
                            name=attack#to trigger teleportaway event
                            [primary_unit]
                                id=${VAR}[$a].id
                            [/primary_unit]
                            [secondary_unit]
                                x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                                [not]
                                    ability_type_active=hides
                                [/not]
                                [or]
                                    x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                                    [not]
                                        ability_type_active=hides
                                    [/not]
                                [/or]
                                [or]
                                    x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                                    [not]
                                        ability_type_active=hides
                                    [/not]
                                [/or]
                            [/secondary_unit]
                            [primary_attack]
                                name={WEAPON}
                            [/primary_attack]
                        [/fire_event]

                        [harm_unit]
                            [filter]
                                id=${VAR}_target[0].id
                                x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                                [or]
                                    id=${VAR}_target[0].id
                                    x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                                [/or]
                                [or]
                                    id=${VAR}_target[0].id
                                    x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                                [/or]
                            [/filter]
                            [filter_second]
                                id=${VAR}[$a].id
                            [/filter_second]
                            [primary_attack]
                                name={WEAPON}
                            [/primary_attack]
                            amount=${VAR}[$a].attack[1].damage
                            damage_type={WEAPONTYPE}
                            alignment=$unit.alignment
                            fire_event=yes
                            animate=yes
                            delay=0
                            experience=no
                            slowed=yes
                        [/harm_unit]
                        [fire_event]
                 	    id=hoplite_adrenaline
                 	[/fire_event]
                    [/then]
                )}
                {MODIFY_UNIT id=${VAR}[$a].id max_moves 1}
                {MODIFY_UNIT id=${VAR}[$a].id moves 1}
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        find_in={VAR}[$a]
                    [/filter]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [dummy]
                                id=hoplite_charging
                            [/dummy]
                        [/abilities]
                    [/effect]
                [/object]
                {CLEAR_VARIABLE {VAR}[$a]}
                {CLEAR_VARIABLE {VAR}_target}
                {CLEAR_VARIABLE targethex_{VAR}1[$a]}
                {CLEAR_VARIABLE targethex_{VAR}2[$a]}
                {CLEAR_VARIABLE targethex_{VAR}3[$a]}
                {CLEAR_VARIABLE targethex_{VAR}4[$a]}
                {CLEAR_VARIABLE {LINEVAR}}
            [/then]
            [else]
                {VARIABLE {LINEVAR} yes}
                {STORE_TARGETHEX_LOC {VAR}}
                {CLEAR_VARIABLE {LINEVAR}}
                [store_unit]
                    [filter]
                        side=$hoplite_playerside,$hoplite_allyside
                        {TARGETUNITS_FILTER {VAR}}
                        [not]
                            ability_type_active=hides
                        [/not]
                    [/filter]
                    variable=hoplite_loc
                    kill=no
                [/store_unit]
                {RANDOM 0..$hoplite_loc.length}
                {VARIABLE {VAR}_hopliteloc_x $hoplite_loc[$random].x}
                {VARIABLE {VAR}_hopliteloc_y $hoplite_loc[$random].y}
                [animate_unit]
                    flag=standing
                    [facing]
                        [filter]
                            x=${VAR}_hopliteloc_x
                            y=${VAR}_hopliteloc_y
                        [/filter]
                    [/facing]
                    [filter]
                        x=${VAR}[$a].x
                        y=${VAR}[$a].y
                    [/filter]
                [/animate_unit]
                {HOPLITE_IFHAVELOC ${VAR}[$a].x,${VAR}[$a].y -${VAR}[$a].facing (
                    [store_locations]
                        terrain=!,Xu*,Xo*
                        [filter_adjacent_location]
                            x,y=${VAR}[$a].x,${VAR}[$a].y
                            adjacent=-${VAR}[$a].facing
                        [/filter_adjacent_location]
                        variable=targethex_{VAR}1[$a]
                        include_borders=no
                   [/store_locations]
                )}
                {HOPLITE_IFHAVELOC $targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y -${VAR}[$a].facing (
                    [store_locations]
                        terrain=!,Xu*,Xo*
                        [filter_adjacent_location]
                            x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                            adjacent=-${VAR}[$a].facing
                        [/filter_adjacent_location]
                        variable=targethex_{VAR}2[$a]
                        include_borders=no
                   [/store_locations]
                )}
                {HOPLITE_IFHAVELOC $targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y -${VAR}[$a].facing (
                    [store_locations]
                        terrain=!,Xu*,Xo*
                        [filter_adjacent_location]
                            x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                            adjacent=-${VAR}[$a].facing
                        [/filter_adjacent_location]
                        variable=targethex_{VAR}3[$a]
                        include_borders=no
                   [/store_locations]
                )}
                [if]
                    [have_unit]
                        side=$hoplite_playerside,$hoplite_allyside
                        x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                        [not]
                            ability_type_active=hides
                        [/not]
                        [or]
                            side=$hoplite_playerside,$hoplite_allyside
                            x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                            [not]
                                ability_type_active=hides
                            [/not]
                        [/or]
                        [or]
                            side=$hoplite_playerside,$hoplite_allyside
                            x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                            [not]
                                ability_type_active=hides
                            [/not]
                        [/or]
                    [/have_unit]
                    [then]
                        [item]
                            x,y=$targethex_{VAR}1[$a].x,$targethex_{VAR}1[$a].y
                            image="misc/{IMG}.png"
                        [/item]
                        [item]
                            x,y=$targethex_{VAR}2[$a].x,$targethex_{VAR}2[$a].y
                            image="misc/{IMG}.png"
                        [/item]
                        [item]
                            x,y=$targethex_{VAR}3[$a].x,$targethex_{VAR}3[$a].y
                            image="misc/{IMG}.png"
                        [/item]
                        {IF_VAR linelength4 equals yes (
                            [then]
                                [item]
                                    x,y=$targethex_{VAR}4[$a].x,$targethex_{VAR}4[$a].y
                                    image="misc/{IMG}.png"
                                [/item]
                            [/then]
                        )}
                        [sound]
                            name=magic-dark-big-miss.ogg
                        [/sound]
                        [object]
                            silent=yes
                            [filter]
                                find_in={VAR}[$a]
                            [/filter]
                            [effect]
                                apply_to=new_ability
                                duration=scenario
                                [abilities]
                                    [dummy]
                                        id=hoplite_charging
                                    [/dummy]
                                [/abilities]
                            [/effect]
                        [/object]
                        {MODIFY_UNIT id=${VAR}[$a].id moves 0}
                        {MODIFY_UNIT id=${VAR}[$a].id max_moves 0}
                    [/then]
                [/if]
            [/else]
        [/if]
    {NEXT a}
#	[/then]
#	)}
    [/then]
    [/if]
    {CLEAR_VARIABLE hoplite_loc}
#enddef