#textdomain wesnoth-Hoplite

#define HOPLITE_SHADOWCLONE_EVENT ID UNLOCKVAR
    [store_locations]
        [and]
            [filter]
                id={ID}
            [/filter]
            radius=1
        [/and]
        [not]
            [filter]
            [/filter]
            [or]
                terrain=Xu*^*,Xo*^*,Q*^*,W*^*,S*^*
            [/or]
        [/not]
        variable=cloneloc
    [/store_locations]
    {IF_VAR cloneloc.length greater_than 0 (
        [then]
            [sound]
                name=magic-dark.ogg
            [/sound]
            [unit]
                side=$hoplite_allyside
                type=Hoplite_Shadowclone_ally
                name=_"Shadow Clone"
                x,y=$cloneloc.x,$cloneloc.y
                animate=yes
                placement=map
                passable=yes
            [/unit]
            [if]
                [have_unit]
                    id=Hoplite
                    side=$side_number
                [/have_unit]
                [and]
                    [variable]
                        name=shadowcloneII_unlocked1
                        equals=yes
                    [/variable]
                    [or]
                        [variable]
                            name=shadowcloneII_unlocked
                            equals=yes
                        [/variable]
                    [/or]
                [/and]
                [or]
                    [variable]
                        name=shadowcloneII_unlocked2
                        equals=yes
                    [/variable]
                    [and]
                        [have_unit]
                            id=Hoplite2
                            side=$side_number
                        [/have_unit]
                    [/and]
                [/or]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            type=Hoplite_Shadowclone_ally
                            x,y=$cloneloc.x,$cloneloc.y
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=10
                            increase_total=10
                        [/effect]
                        [effect]
                            apply_to=variation
                            name=can_leap
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [have_unit]
                    id=Hoplite
                    side=$side_number
                [/have_unit]
                [and]
                    [variable]
                        name=shadowcloneIII_unlocked1
                        equals=yes
                    [/variable]
                    [or]
                        [variable]
                            name=shadowcloneIII_unlocked
                            equals=yes
                        [/variable]
                    [/or]
                [/and]
                [or]
                    [variable]
                        name=shadowcloneIII_unlocked2
                        equals=yes
                    [/variable]
                    [and]
                        [have_unit]
                            id=Hoplite2
                            side=$side_number
                        [/have_unit]
                    [/and]
                [/or]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            type=Hoplite_Shadowclone_ally
                            x,y=$cloneloc.x,$cloneloc.y
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=5
                            increase_total=5
                        [/effect]
                        [effect]
                           apply_to=resistance
                           replace=no
                           [resistance]
                              blade=-15
                              pierce=-15
                              impact=-15
                              arcane=-15
                              fire=-15
                              cold=-15
                           [/resistance]
                        [/effect]
                        [effect]
                           apply_to=attack
                           name=spear
                           [set_specials]
                              mode=append
                              {WEAPON_SPECIAL_IMPALE}
                           [/set_specials]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [have_unit]
                    id=Hoplite
                    side=$side_number
                [/have_unit]
                [and]
                    [variable]
                        name=shadowcloneIIIb_unlocked1
                        equals=yes
                    [/variable]
                    [or]
                        [variable]
                            name=shadowcloneIIIb_unlocked
                            equals=yes
                        [/variable]
                    [/or]
                [/and]
                [or]
                    [variable]
                        name=shadowcloneIIIb_unlocked2
                        equals=yes
                    [/variable]
                    [and]
                        [have_unit]
                            id=Hoplite2
                            side=$side_number
                        [/have_unit]
                    [/and]
                [/or]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            type=Hoplite_Shadowclone_ally
                            x,y=$cloneloc.x,$cloneloc.y
                        [/filter]
                        [effect]
                           apply_to=attack
                           name=spear
                           increase_damage=5
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [set_variable]
                name=clonesuccess
                value=yes
            [/set_variable]
        [/then]
        [else]
            [print]
                text= _ "All adjacent hexes are occupied!"
                size=20
                red=255
                duration=2000
            [/print]
        [/else]
    )}
#enddef

[event]
    name=attack_end
    id=hoplite_hitandrun_event
    first_time_only=no
    [filter]
        side=$hoplite_playerside
    [/filter]
    [filter_attack]
        special_id=hoplite_hitandrun
    [/filter_attack]
    #removes leaping/teleporting, to prevent it being usable for free with hit-and-run
    [if]
    [have_unit]
        x,y=$x1,$y1
        ability=hoplite_leap
        [or]
        x,y=$x1,$y1
        ability=hoplite_teleport
        [/or]
    [/have_unit]
    [then]
    [object]
        silent=yes
        duration=turn end
        [filter]
            x,y=$x1,$y1
        [/filter]
        [effect]
            apply_to=remove_ability
            [abilities]
               {ABILITY_LEAPING2}
               {ABILITY_HOPLITE_TELEPORTING}
            [/abilities]
        [/effect]
    [/object]
    [/then]
    [/if]
    {MODIFY_UNIT id=$unit.id moves 1}
[/event]
[event]
    name=die
    id=hoplite_swordcombo_event
    first_time_only=no
    [filter_second]
        side=$hoplite_playerside
        [not]
            ability=hoplite_combo_triggered
        [/not]
    [/filter_second]
    [filter_second_attack]
        special_id=hoplite_combo
    [/filter_second_attack]
    [object]
        silent=yes
        duration=turn end
        [filter]
            x,y=$x2,$y2
        [/filter]
        [effect]
            apply_to=new_ability
            [abilities]
                [dummy]
                    id=hoplite_combo_triggered
                [/dummy]
            [/abilities]
        [/effect]
    [/object]
    {MODIFY_UNIT id=$second_unit.id attacks_left "$($second_unit.attacks_left + 1)"}
    [floating_text]
       x,y=$x2,$y2
       text=_"combo"
    [/floating_text]
[/event]
[event]
    name=side 1 turn end
    first_time_only=no
	{CHATMSG "rest event"}
#    {IF_VAR rest_unlocked equals yes (
#    [or]
#    [variable]
#      name=rest_unlocked1
#      equals=yes
#    [/variable]
#    [/or]
#        [then]
            [store_unit]
                [filter]
                    id=Hoplite
                    side=$side_number
                [/filter]
                variable=hoplite_rest
                kill=no
            [/store_unit]
            [if]
                [variable]
                    name=hoplite_rest.moves
                    greater_than=0
                [/variable]
                [and]
                    [variable]
                        name=hoplite_rest.attacks_left
                        greater_than=0
                    [/variable]
                [/and]
                [then]
                    {VARIABLE hoplite_still yes}
		    {IF_VAR shieldwall_unlocked equals yes (
		    [or]
		    {VARIABLE_CONDITIONAL shieldwall_unlocked1 equals yes}
		    [/or]
		    [then]
                    {VARIABLE shieldup_id Hoplite}
                    [fire_event]
                       id=hoplite_shieldup
                    [/fire_event]
                    {CLEAR_VARIABLE shieldup_id}
		    [/then])}
                [/then]
            [/if]
#        [/then]
#    )}
    {CLEAR_VARIABLE hoplite_usedportal}
    {CLEAR_VARIABLE hoplite_rest}
[/event]
#ifdef MULTIPLAYER
[event]
    name=side 2 turn end
    first_time_only=no
	{CHATMSG "rest event 2"}
#    {IF_VAR rest_unlocked equals yes (
#    [or]
#    [variable]
#      name=rest_unlocked2
#      equals=yes
#    [/variable]
#    [/or]
#        [then]
            [store_unit]
                [filter]
                    id=Hoplite2
                    side=$side_number
                [/filter]
                variable=hoplite_rest2
                kill=no
            [/store_unit]
            [if]
                [variable]
                    name=hoplite_rest2.moves
                    greater_than=0
                [/variable]
                [and]
                    [variable]
                        name=hoplite_rest2.attacks_left
                        greater_than=0
                    [/variable]
                [/and]
                [then]
                    {VARIABLE hoplite_still2 yes}
		    {IF_VAR shieldwall_unlocked2 equals yes (
		    [then]
                    {VARIABLE shieldup_id Hoplite2}
                    [fire_event]
                       id=hoplite_shieldup
                    [/fire_event]
                    {CLEAR_VARIABLE shieldup_id}
		    [/then])}
                [/then]
            [/if]
#        [/then]
#    )}
    {CLEAR_VARIABLE hoplite_rest2}
[/event]
#endif
[event]
#ifdef MULTIPLAYER
    name=side 4 turn
#else
    name=side 3 turn
#endif
    first_time_only=no
	{CHATMSG "rat_legion event"}
            {VARIABLE_OP rat_cooldown sub 1}
    [if]
        [have_unit]
            id=Hoplite2
        [/have_unit]
        [then]
            {VARIABLE_OP rat_cooldown2 sub 1}
        [/then]
    [/if]
    {IF_VAR rat_legion_unlocked equals yes (
        [and]
            [variable]
                name=rat_cooldown
                less_than=1
            [/variable]
        [/and]
       [or]
            [variable]
                name=rat_legion_unlocked1
                equals=yes
            [/variable]
        [and]
            [variable]
                name=rat_cooldown1
                less_than=1
            [/variable]
        [/and]
       [/or]
       [then]
       [sound]
         name={SOUND_LIST:BAT_HIT}
       [/sound]
       
		{SCATTER_UNITS 1 Hoplite_Giantrat_ally 1 (
            terrain={SPARTAN_UNITSPAWN_TERRAIN}
            [not]
                [filter]
                [/filter]
		radius=1
            [/not]
        ) (
            side=$hoplite_allyside
        )}
	
	{IF_VAR rat_power_unlocked equals yes (
	[or]
            [variable]
                name=rat_powerII_unlocked1
                equals=yes
            [/variable]
	[/or]
	[then]
        [set_variable]
          name=rat_cooldown
          value=6
        [/set_variable]
	[/then]
	[else]
        [set_variable]
          name=rat_cooldown
          value=4
        [/set_variable]
	[/else])}
        [/then]
    )}
    {IF_VAR rat_legion_unlocked2 equals yes (
        [and]
            [variable]
                name=rat_cooldown2
                less_than=1
            [/variable]
        [/and]
       [then]
       [sound]
         name={SOUND_LIST:BAT_HIT}
       [/sound]
       
		{SCATTER_UNITS 1 Hoplite_Giantrat_ally2 1 (
            terrain={SPARTAN_UNITSPAWN_TERRAIN}
            [not]
                [filter]
                [/filter]
		radius=1
            [/not]
        ) (
            side=$hoplite_allyside
        )}
	
	{IF_VAR rat_powerII_unlocked2 equals yes (
	[then]
        [set_variable]
          name=rat_cooldown2
          value=6
        [/set_variable]
	[/then]
	[else]
        [set_variable]
          name=rat_cooldown2
          value=4
        [/set_variable]
	[/else])}
        [/then]
    )}
    #matters with the ambush upgrade:
    [modify_side]
        side=$hoplite_allyside
        team_name=hoplite
        user_team_name=_"Allies"
    [/modify_side]
[/event]

[event]
    name=start
    [set_menu_item]
        id=hoplite_shadowclone
        description= _ "Summon a Shadow Clone. Costs <span color='#2c9fed'>100</span> energy."
        image="misc/icon_shadowclone.png"
        [show_if]
            [have_unit]
                id=Hoplite,Hoplite2
                x,y=$x1,$y1
                side=$side_number
            [/have_unit]
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    {VARIABLE_CONDITIONAL shadowclone_unlocked1 equals yes}
                    {VARIABLE_CONDITIONAL hoplite_shadowclone_cooldown1 less_than 1}
                ) (
                    {VARIABLE_CONDITIONAL shadowclone_unlocked2 equals yes}
                    {VARIABLE_CONDITIONAL hoplite_shadowclone_cooldown2 less_than 1}
                )}
                [or]
                    {VARIABLE_CONDITIONAL shadowclone_unlocked equals yes}
                    [and]
                        {VARIABLE_CONDITIONAL hoplite_shadowclone_cooldown less_than 1}
                    [/and]
                [/or]
            [/and]
        [/show_if]
        [command]
            [if]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    {VARIABLE_CONDITIONAL hoplite_energy1 greater_than_equal_to 100}
                ) (
                    {VARIABLE_CONDITIONAL hoplite_energy2 greater_than_equal_to 100}
                )}
                [or]
                    {VARIABLE_CONDITIONAL hoplite_energy greater_than_equal_to 100}
                [/or]
                [then]
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                            {HOPLITE_PLAYERFILTER (
                                {VARIABLE shadowclone_id Hoplite}
                                {VARIABLE shadowclone_unlockvar unlocked1}
                                {VARIABLE shadowclone_type mp1}
                            ) (
                                {VARIABLE shadowclone_id Hoplite2}
                                {VARIABLE shadowclone_unlockvar unlocked2}
                                {VARIABLE shadowclone_type mp2}
                            )}
                        [/then]
                        [else]
                            {VARIABLE shadowclone_id Hoplite}
                            {VARIABLE shadowclone_unlockvar unlocked}
                            {VARIABLE shadowclone_type sp}
                        [/else]
                    [/if]
                    {HOPLITE_SHADOWCLONE_EVENT $shadowclone_id $shadowclone_unlocked}
                    [if]
                        [variable]
                            name=clonesuccess
                            equals=yes
                        [/variable]
                        [then]
                            [if]
                                [variable]
                                    name=shadowclone_type
                                    equals=mp1
                                [/variable]
                                [then]
                                    {VARIABLE_OP hoplite_energy1 sub 100}
                                    {SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
                                    {IF_VAR shadowcloneIIb_unlocked1 equals yes (
                                    [then]
                                        {VARIABLE hoplite_shadowclone_cooldown1 1}
                                    [/then]
                                    [else]
                                        {VARIABLE hoplite_shadowclone_cooldown1 2}
                                    [/else]
                                    )}
                                [/then]
                                [elseif]
                                    [variable]
                                        name=shadowclone_type
                                        equals=mp2
                                    [/variable]
                                    [then]
                                        {VARIABLE_OP hoplite_energy2 sub 100}
                                        {SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
                                        {IF_VAR shadowcloneIIb_unlocked2 equals yes (
                                        [then]
                                            {VARIABLE hoplite_shadowclone_cooldown2 1}
                                        [/then]
                                        [else]
                                            {VARIABLE hoplite_shadowclone_cooldown2 2}
                                        [/else]
                                        )}
                                    [/then]
                                [/elseif]
                                [else]
                                    {VARIABLE_OP hoplite_energy sub 100}
                                    {SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
                                    {IF_VAR shadowcloneIIb_unlocked equals yes (
                                    [then]
                                        {VARIABLE hoplite_shadowclone_cooldown 1}
                                    [/then]
                                    [else]
                                        {VARIABLE hoplite_shadowclone_cooldown 2}
                                    [/else]
                                    )}
                                [/else]
                            [/if]
                        [/then]
                    [/if]
                [/then]
                [else]
                    [print]
                        text= _ "Not enough energy!"
                        size=20
                        red=255
                        duration=2000
                    [/print]
                [/else]
            [/if]
            {CLEAR_VARIABLE shadowclone_id}
            {CLEAR_VARIABLE shadowclone_unlockvar}
            {CLEAR_VARIABLE shadowclone_type}
        [/command]
    [/set_menu_item]
[/event]
#explosive spear animation event:
[event]
    id=spearexplode
    first_time_only=no
    {CHATMSG "exploding spear anim"}
    {IF_VAR spearthrowexplode_unlocked equals yes (
        [and]
            {VARIABLE_CONDITIONAL isspearthrowing equals yes}
        [/and]
        [or]
            {HOPLITE_PLAYERFILTER_VAR2 (
                {VARIABLE_CONDITIONAL spearthrowexplode_unlocked1 equals yes}
            ) (
                {VARIABLE_CONDITIONAL spearthrowexplode_unlocked2 equals yes}
            )}
            [and]
                {VARIABLE_CONDITIONAL isspearthrowing equals yes}
            [/and]
        [/or]
        [then]
            [object]
                silent=yes
                duration=forever
                [filter]
                    x,y=$x1,$y1
                [/filter]
                [effect]
                    apply_to=new_animation
                    [extra_anim]
                        flag=explode2
                        [missile_frame]
                            halo="projectiles/fireball-impact-[1~16].png~SCALE(300,300):60"
                            offset=0.0
                            auto_vflip=no
                        [/missile_frame]
                        [frame]
                            sound=explosion.ogg
                        [/frame]
                    [/extra_anim]
                [/effect]
            [/object]
            [animate_unit]
                flag=explode2
                [filter]
                    x,y=$x1,$y1
                [/filter]
            [/animate_unit]
        [/then]
    )}
[/event]
[event]
    name=start
    id=hoplite_upgrade_ability_menus
    first_time_only=no
    [set_menu_item]
        id=hoplite_wizardbeam
        description=_"Cast the flame blast spell in this direction."
        image="misc/icon_fire.png"
        [show_if]
            [have_location]
                [filter_adjacent_location]
                    [filter]
                        id=Hoplite,Hoplite2
                        side=$side_number
                    [/filter]
                [/filter_adjacent_location]
                x,y=$x1,$y1
            [/have_location]
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    [variable]
                        name=wizardbeam_unlocked1
                        equals=yes
                    [/variable]
                    [and]
                        [variable]
                            name=hoplite_wizardbeam_cooldown1
                            less_than=1
                        [/variable]
                    [/and]
                ) (
                    [variable]
                        name=wizardbeam_unlocked2
                        equals=yes
                    [/variable]
                    [and]
                        [variable]
                            name=hoplite_wizardbeam_cooldown2
                            less_than=1
                        [/variable]
                    [/and]
                )}
                [or]
                    [variable]
                        name=wizardbeam_unlocked
                        equals=yes
                    [/variable]
                    [and]
                        [variable]
                            name=hoplite_wizardbeam_cooldown1
                            less_than=1
                        [/variable]
                    [/and]
                [/or]
            [/and]
        [/show_if]
        [command]
            [animate_unit]
                flag=standing
                [facing]
                    x,y=$x1,$y1
                [/facing]
                [filter]
                    id=Hoplite,Hoplite2
                    side=$side_number
                [/filter]
            [/animate_unit]
            [store_unit]
                [filter]
                    id=Hoplite,Hoplite2
                    side=$side_number
                [/filter]
                variable=hoplitebeam
                kill=no
            [/store_unit]

            {SPARTAN_GETDIR_REVERSED $hoplitebeam.x $hoplitebeam.y $x1 $y1 tmp_beam_dir}
#            {STORE_TARGETLOCS_PART hoplitebeam $tmp_beam_dir 5 0}
            {STORE_TARGETHEX_LOC hoplitebeam $hoplite_wizardbeam_range$side_number| 0}

            [foreach]
                array=ranged_targetlocs$tmp_beam_dir
                variable=this_item2
                index_var=e
                [do]

                [set_variables]
                    name=tmp_item_tag_container
                    [value]
                        x=$this_item2.x
                        y=$this_item2.y
                        image="misc/targethex.png"
                        name=hoplite_player_wizardbeamtargethex
                    [/value]
                [/set_variables]

                #am using [insert_tag] instead of just item, otherwise the game doesn't substitute the id variable for some reason

                [insert_tag]
                    name=item
                    variable=tmp_item_tag_container
                [/insert_tag]

                {CLEAR_VARIABLE tmp_item_tag_container}

                [/do]
            [/foreach]

            [sound]
                name=magic-dark-big-miss.ogg
            [/sound]
            [delay]
                time=500
            [/delay]
            [remove_item]
                image=hoplite_player_wizardbeamtargethex
                x,y=0-99
            [/remove_item]
            [redraw][/redraw]

            [if]
                [have_unit]
                    side=$hoplite_enemyside
                    [filter_location]
                        find_in=ranged_targetlocs$tmp_beam_dir
                    [/filter_location]
                [/have_unit]
                [then]
                    [animate_unit]
                        flag=wizardbeam$hoplite_wizardbeam_range$side_number|
                        [filter]
                            id=$hoplitebeam.id
                        [/filter]
                        [facing]
                            x,y=$x1,$y1
                        [/facing]
                    [/animate_unit]
                    {VARIABLE wizardbeam_targets yes}
                [/then]
            [/if]

            {SPARTAN_RETURN_ATTACK_INDEX_BY_NAME hoplitebeam wizardbeam}

#using foreach instead of just find_in filter, so that enemies are hit in the right order
            [foreach]
                array=ranged_targetlocs$tmp_beam_dir
                variable=this_item2
                index_var=e
                [do]
                [harm_unit]
                    [filter]
                        side=$hoplite_enemyside
                        x,y=$this_item2.x,$this_item2.y
                    [/filter]
                    [filter_second]
                        id=$hoplitebeam.id
                    [/filter_second]
                    [primary_attack]
                        name=wizardbeam
                    [/primary_attack]
                    amount=$hoplitebeam.attack[$tmp_index_return].damage
                    damage_type=$hoplitebeam.attack[$tmp_index_return].type
                    fire_event=yes
                    animate=defender
                    delay=0
                    experience=yes
                [/harm_unit]
                [/do]
            [/foreach]
            {CLEAR_VARIABLE tmp_index_return}

            {CLEAR_VARIABLE hoplitebeam}
            {IF_VAR wizardbeam_targets equals yes (
            [then]
                            {HOPLITE_PLAYERFILTER (
                                {VARIABLE hoplite_wizardbeam_cooldown1 $hoplite_wizardbeam_max_cooldown1}
#not needed due to [end_turn]               
#                                {MODIFY_UNIT id=Hoplite attacks_left 0}
#                                {MODIFY_UNIT id=Hoplite moves 0}
                            ) (
                                {VARIABLE hoplite_wizardbeam_cooldown2 $hoplite_wizardbeam_max_cooldown2}
#                                {MODIFY_UNIT id=Hoplite2 attacks_left 0}
#                                {MODIFY_UNIT id=Hoplite2 moves 0}
                            )}
                    {IF_VAR elizabeth_line_flame not_equals yes (
                    [and]
                    [have_unit]
                        id=Elizabeth
                    [/have_unit]
                    [/and]
                    [then]
                [message]
                   speaker=Elizabeth
                   message=_"You're a spellcaster too? Wouldn't have guessed from your appearance..."
                [/message]
                    {IF_VAR ratsI_unlocked equals yes (
            [or]
            {VARIABLE_CONDITIONAL ratsI_unlocked1 equals yes}
            [/or]
            [or]
            {VARIABLE_CONDITIONAL ratsI_unlocked2 equals yes}
            [/or]
                    [then]
                [message]
                   speaker=Elizabeth
                   message=_"...But then again, mind-controlling rats isn't very typical of a warrior either."
                [/message]
            [/then])}
            {VARIABLE elizabeth_line_flame yes}
                [message]
                   side=$side_number
                   canrecruit=yes
                   message=_"Heh, what can I say, I'm a man of many talents."
                [/message]
            [/then])}

                    [end_turn]
                    [/end_turn]
                    {CLEAR_VARIABLE wizardbeam_targets}
                [/then]
            )}
            {HOPLITE_CLEAR_TMP_TARGETHEXES}
            {CLEAR_VARIABLE tmp_beam_dir}
        [/command]
    [/set_menu_item]

    [set_menu_item]
        id=hoplite_enthrall
        description=_"Enthrall this enemy (costs <span color='#2c9fed'>75</span> energy per enemy level)"
        image="misc/eye-icon.png"
        [show_if]
            [have_unit]
            side=$hoplite_enemyside
#       level=0,1,2
                x,y=$x1,$y1
                [not]
                    ability=hoplite_boss
                [/not]
                [filter_location]
                    [filter]
                        id=Hoplite,Hoplite2
                        side=$side_number
                    [/filter]
            radius=1
                [/filter_location]
            [/have_unit]
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    [variable]
                        name=enthrall_unlocked1
                        equals=yes
                    [/variable]
        [and]
                [have_unit]
        id=Hoplite
                [filter_adjacent]
          x,y=$x1,$y1
                [/filter_adjacent]
                [/have_unit]
        [/and]
                    [and]
                        [variable]
                            name=hoplite_enthrall_cooldown1
                            less_than=1
                        [/variable]
                    [/and]
                ) (
                    [variable]
                        name=enthrall_unlocked2
                        equals=yes
                    [/variable]
        [and]
                [have_unit]
        id=Hoplite2
                [filter_adjacent]
          x,y=$x1,$y1
                [/filter_adjacent]
                [/have_unit]
        [/and]
                    [and]
                        [variable]
                            name=hoplite_enthrall_cooldown2
                            less_than=1
                        [/variable]
                    [/and]
                )}
                [or]
                    [variable]
                        name=enthrall_unlocked
                        equals=yes
                    [/variable]
                    [and]
                        [variable]
                            name=hoplite_enthrall_cooldown
                            less_than=1
                        [/variable]
                    [/and]
                [/or]
            [/and]
        [/show_if]
        [command]
    [store_unit]
     [filter]
       x,y=$x1,$y1
     [/filter]
     variable=enthrallenemy
     kill=no
    [/store_unit]
#   [if]
#   [have_unit]
#     x,y=$x1,$y1
#      ability=summonerfilter
#   [/have_unit]
#   [then]
#        [print]
#           text= _ "Can't enthrall summoners!"
#           size=22
#           red=255
#      duration=2000
#        [/print]
#   [/then]
#    [elseif]
#    [have_unit]
#      x,y=$x1,$y1
#      ability=hoplite_boss
#    [/have_unit]
#    [then]
#        [print]
#           text= _ "Can't enthrall bosses!"
#           size=22
#           red=255
#       duration=100
#        [/print]
#    [/then]
#    [/elseif]
#   [else]
    {VARIABLE enthrallenergy $enthrallenemy.level}
    {VARIABLE_OP enthrallenergy multiply 75}
        {IF_VAR enthrallenergy less_than 35 (
        [then]
    {VARIABLE enthrallenergy 35}
        [/then])}
            [if]
#ifdef MULTIPLAYER
                [have_unit]
                    id=Hoplite
                    side=$side_number
                [/have_unit]
                [and]
                    [variable]
                        name=hoplite_energy1
                        greater_than_equal_to=$enthrallenergy
                    [/variable]
                [/and]
                [or]
                    [have_unit]
                        id=Hoplite2
                        side=$side_number
                    [/have_unit]
                    [and]
                        [variable]
                            name=hoplite_energy2
                            greater_than_equal_to=$enthrallenergy
                        [/variable]
                    [/and]
                [/or]
#endif
#ifndef MULTIPLAYER
                    [variable]
                        name=hoplite_energy
                        greater_than_equal_to=$enthrallenergy
                    [/variable]
#endif
        [then]
#ifdef MULTIPLAYER
                    [if]
                        [have_unit]
                            id=Hoplite
                            side=$side_number
                        [/have_unit]
                        [then]
                            {VARIABLE_OP hoplite_energy1 sub $enthrallenergy}
                            {SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
                        [/then]
                        [else]
                            {VARIABLE_OP hoplite_energy2 sub $enthrallenergy}
                            {SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
                        [/else]
                    [/if]
#endif
#ifndef MULTIPLAYER
        {VARIABLE_OP hoplite_energy sub $enthrallenergy}
        {SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
#endif
    [sound]
      name=magic-dark-big.ogg
    [/sound]
    [modify_unit]
      [filter]
         x,y=$x1,$y1
      [/filter]
      side=$hoplite_allyside
    [/modify_unit]
    [object]
        silent=yes
        duration=forever
        [filter]
          x,y=$x1,$y1
        [/filter]
        [effect]
          apply_to=halo
          halo="halo/elven/shyde-stationary-halo[1~6].png:150"
        [/effect]
        [effect]
          apply_to=new_ability
          [abilities]
            [dummy]
                id=hoplite_thrall#for filtering
            [/dummy]
          [/abilities]
        [/effect]
    [/object]

            [if]
                [have_unit]
                    id=Hoplite2
                [/have_unit]
                [then]
                {HOPLITE_PLAYERFILTER (
        {IF_VAR enthrallII_unlocked1 equals yes (
        [then]
            {VARIABLE tmp_enthrallII_buff yes}
        [/then])}
        ) (
        {IF_VAR enthrallII_unlocked2 equals yes (
        [then]
            {VARIABLE tmp_enthrallII_buff yes}
        [/then])}
        )}

                {HOPLITE_PLAYERFILTER (
        {IF_VAR enthrallIII_unlocked1 equals yes (
        [then]
            {VARIABLE tmp_enthrallIII_buff yes}
        [/then])}
        ) (
        {IF_VAR enthrallIII_unlocked2 equals yes (
        [then]
            {VARIABLE tmp_enthrallIII_buff yes}
        [/then])}
        )}

        [/then]
        [else]
        {IF_VAR enthrallII_unlocked equals yes (
        [then]
            {VARIABLE tmp_enthrallII_buff yes}
        [/then])}
        {IF_VAR enthrallIII_unlocked equals yes (
        [then]
            {VARIABLE tmp_enthrallIII_buff yes}
        [/then])}
        [/else]
            [/if]
    {IF_VAR tmp_enthrallII_buff equals yes (
    [then]
        [object]
        silent=yes
        duration=forever
        [filter]
          x,y=$x1,$y1
        [/filter]
        [effect]
          apply_to=hitpoints
          increase_total=5
            [/effect]
        [effect]
            apply_to=attack
            increase_damage=2
        [/effect]
        [effect]
          apply_to=new_ability
          [abilities]
                  [regenerate]
                     value=2
                     id=hoplite_regenerates2
                     name= _ "regenerates +2"
                     female_name= _ "female^regenerates +2"
                     description= _ "The unit will heal itself 2 HP per turn."
                     affect_self=yes
                     poison=slowed
                  [/regenerate]
          [/abilities]
        [/effect]
        [/object]
    [/then]
    )}
    {IF_VAR tmp_enthrallIII_buff equals yes (
    [then]
        [object]
        silent=yes
        duration=forever
        [filter]
          x,y=$x1,$y1
        [/filter]
        [effect]
          apply_to=hitpoints
          increase_total=5
            [/effect]
        [effect]
            apply_to=movement
            increase=1
        [/effect]
        [/object]
    [/then]
    )}

    {CLEAR_VARIABLE tmp_enthrallII_buff}
    {CLEAR_VARIABLE tmp_enthrallIII_buff}
    [heal_unit]
      [filter]
         x,y=$x1,$y1
      [/filter]
      amount=full
      animate=no
    [/heal_unit]
        [modify_side]
          side=$hoplite_allyside
          controller=ai
          hidden=no
        [/modify_side]
#removed cooldown for now, as I bumped up the energy cost instead
#        [if]
#            [have_unit]
#                id=Hoplite2
#            [/have_unit]
#            [then]
#                {HOPLITE_PLAYERFILTER (
#                    {VARIABLE hoplite_enthrall_cooldown1 3}
#                ) (
#                    {VARIABLE hoplite_enthrall_cooldown2 3}
#                )}
#            [/then]
#            [else]
#                {VARIABLE hoplite_enthrall_cooldown 3}
#            [/else]
#        [/if]
        [if]
        [have_unit]
            x,y=$x1,$y1
            level=3
        [/have_unit]
        [then]
        {ACHIEVEMENT_MESSAGE_LONE enthrall_master $side_number}
        [/then]
        [/if]

        [end_turn]
        [/end_turn]
    [/then]
    [else]
        [print]
           text= _ "Not enough energy!"
           size=22
           red=255
       duration=100
        [/print]
    [/else]
    [/if]
#   [/else]
#   [/if]
    {CLEAR_VARIABLE enthrallenemy}
    {CLEAR_VARIABLE enthrallenergy}
    [/command]
        [/set_menu_item]
    [set_menu_item]
        id=hoplite_loyal_thrall
        description=_"Turn this thrall into a loyal thrall (if you are below thrall limit)"
        [show_if]
            [have_unit]
            side=$hoplite_allyside
            ability=hoplite_thrall
            x,y=$x1,$y1
            [not]
                ability=hoplite_loyalthrall$side_number
            [/not]
            [/have_unit]
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    [variable]
                        name=enthrall_loyal_unlocked1
                        equals=yes
                    [/variable]
        [and]
                [have_unit]
        id=Hoplite
                [filter_adjacent]
          x,y=$x1,$y1
                [/filter_adjacent]
                [/have_unit]
        [/and]
                ) (
                    [variable]
                        name=enthrall_loyal_unlocked2
                        equals=yes
                    [/variable]
        [and]
                [have_unit]
        id=Hoplite2
                [filter_adjacent]
          x,y=$x1,$y1
                [/filter_adjacent]
                [/have_unit]
        [/and]
                )}
                [or]
                    [variable]
                        name=enthrall_loyal_unlocked
                        equals=yes
                    [/variable]
                [/or]
            [/and]
        [/show_if]
        [command]

        [store_unit]
            [filter]
                ability=hoplite_loyalthrall$side_number
            [/filter]
            variable=tmp_current_thralls
        [/store_unit]

        [if]
            {VARIABLE_CONDITIONAL tmp_current_thralls.length greater_than_equal_to $hoplite_thrall_limit$side_number}
            [then]
            [print]
               text= _ "Can't go above the loyal thrall limit!"
               size=22
               red=255
               duration=1500
            [/print]
            [/then]
            [else]
            [object]
                silent=yes
                duration=forever
                [filter]
                    x,y=$x1,$y1
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=hoplite_loyalthrall$side_number
                        [/dummy]
                        [dummy]
                            id=hoplite_loyalthrall_filter
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
    
            [modify_unit]
                [filter]
                    x,y=$x1,$y1
                [/filter]
                {TRAIT_LOYAL}
            [/modify_unit]
            [/else]
        [/if]

        [/command]
    [/set_menu_item]

    [set_menu_item]
        id=hoplite_loyal_thrall_remove
        description=_"Remove loyal trait from this thrall (so you can make a different thrall loyal)"
        [show_if]
            [have_unit]
            side=$hoplite_allyside
            ability=hoplite_thrall
            x,y=$x1,$y1
            ability=hoplite_loyalthrall$side_number
            [/have_unit]
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    [variable]
                        name=enthrall_loyal_unlocked1
                        equals=yes
                    [/variable]
        [and]
                [have_unit]
        id=Hoplite
                [filter_adjacent]
          x,y=$x1,$y1
                [/filter_adjacent]
                [/have_unit]
        [/and]
                ) (
                    [variable]
                        name=enthrall_loyal_unlocked2
                        equals=yes
                    [/variable]
        [and]
                [have_unit]
        id=Hoplite2
                [filter_adjacent]
          x,y=$x1,$y1
                [/filter_adjacent]
                [/have_unit]
        [/and]
                )}
                [or]
                    [variable]
                        name=enthrall_loyal_unlocked
                        equals=yes
                    [/variable]
                [/or]
            [/and]
        [/show_if]
        [command]

        [remove_trait]
            x,y=$x1,$y1
            trait_id=loyal
        [/remove_trait]

        [object]
            silent=yes
            duration=forever
            [filter]
                x,y=$x1,$y1
            [/filter]
            [effect]
                apply_to=remove_ability
                [abilities]
                    [dummy]
                        id=hoplite_loyalthrall$side_number
                    [/dummy]
                    [dummy]
                        id=hoplite_loyalthrall_filter
                    [/dummy]
                [/abilities]
            [/effect]
        [/object]
        [/command]
    [/set_menu_item]

    [set_menu_item]
        id=hoplite_bow
        description=_"Aim your bow in this direction (will shoot next turn)"
        image="misc/icon_bow.png"
        [show_if]
            [have_location]
                [filter_adjacent_location]
                    [filter]
                        id=Hoplite,Hoplite2
                        side=$side_number
                    [/filter]
                [/filter_adjacent_location]
                x,y=$x1,$y1
            [/have_location]
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    [variable]
                        name=bow_unlocked1
                        equals=yes
                    [/variable]
                    [and]
                    [variable]
                        name=bowIV_unlocked1
                        not_equals=yes
                    [/variable]
                    [/and]
                ) (
                    [variable]
                        name=bow_unlocked2
                        equals=yes
                    [/variable]
                    [and]
                    [variable]
                        name=bowIV_unlocked2
                        not_equals=yes
                    [/variable]
                    [/and]
                )}
                [or]
                    [variable]
                        name=bow_unlocked
                        equals=yes
                    [/variable]
                    [and]
                    [variable]
                        name=bowIV_unlocked
                        not_equals=yes
                    [/variable]
                    [/and]
                [/or]
            [/and]
        [/show_if]
        [command]
            [animate_unit]
                flag=standing
                [facing]
                    x,y=$x1,$y1
                [/facing]
                [filter]
                    id=Hoplite,Hoplite2
                    side=$side_number
                [/filter]
            [/animate_unit]
            [store_unit]
                [filter]
                    id=Hoplite,Hoplite2
                    side=$side_number
                [/filter]
                variable=hoplitebow
                kill=no
            [/store_unit]

            {SPARTAN_GETDIR_REVERSED $hoplitebow.x $hoplitebow.y $x1 $y1 tmp_ranged_dir}

            {STORE_TARGETHEX_LOC hoplitebow $hoplite_bow_range$hoplitebow.side $hoplite_bow_blindspot$hoplitebow.side}

            {SPARTAN_PLACE_TARGETHEXES hoplitebow $hoplite_bow_range$hoplitebow.side $hoplite_bow_blindspot$hoplitebow.side "misc/targethex-archer.png"}

            {IF_VAR ranged_targetlocs$tmp_ranged_dir|.length greater_than 0 (
            [then]
            [sound]
                name=magic-dark-big-miss.ogg
            [/sound]
            {VARIABLE hoplite_bow_aiming$side_number yes}
            [end_turn]
            [/end_turn]
            [/then]
            [else]
            [print]
               text= _ "Can't aim in this direction!"
               size=22
               red=255
               duration=1500
            [/print]
            [/else]
            )}

            {CLEAR_VARIABLE hoplitebow}
            {HOPLITE_CLEAR_TMP_TARGETHEXES}
            {CLEAR_VARIABLE tmp_ranged_dir}
        [/command]
    [/set_menu_item]

    [set_menu_item]
        id=hoplite_bow2
        description=_"Shoot your bow in this direction"
        image="misc/icon_bow.png"
        [show_if]
            [have_location]
                [filter_adjacent_location]
                    [filter]
                        id=Hoplite,Hoplite2
                        side=$side_number
                    [/filter]
                [/filter_adjacent_location]
                x,y=$x1,$y1
            [/have_location]
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    [variable]
                        name=bowIV_unlocked1
                        equals=yes
                    [/variable]
                ) (
                    [variable]
                        name=bowIV_unlocked2
                        equals=yes
                    [/variable]
                )}
                [or]
                    [variable]
                        name=bowIV_unlocked
                        equals=yes
                    [/variable]
                [/or]
            [/and]
        [/show_if]
        [command]
            [animate_unit]
                flag=standing
                [facing]
                    x,y=$x1,$y1
                [/facing]
                [filter]
                    id=Hoplite,Hoplite2
                    side=$side_number
                [/filter]
            [/animate_unit]
            [store_unit]
                [filter]
                    id=Hoplite,Hoplite2
                    side=$side_number
                [/filter]
                variable=hoplitebow
                kill=no
            [/store_unit]

            {SPARTAN_GETDIR_REVERSED $hoplitebow.x $hoplitebow.y $x1 $y1 tmp_bow_dir}

            {STORE_TARGETHEX_LOC hoplitebow $hoplite_bow_range$hoplitebow.side $hoplite_bow_blindspot$hoplitebow.side}

            [foreach]
                array=ranged_targetlocs$tmp_bow_dir
                variable=this_item2
                index_var=e
                [do]

                [set_variables]
                    name=tmp_item_tag_container
                    [value]
                        x=$this_item2.x
                        y=$this_item2.y
                        image="misc/targethex-archer.png"
                        name=hoplite_targethex$hoplitebow.id
                    [/value]
                [/set_variables]

                #am using [insert_tag] instead of just item, otherwise the game doesn't substitute the id variable for some reason

                [insert_tag]
                    name=item
                    variable=tmp_item_tag_container
                [/insert_tag]

                {CLEAR_VARIABLE tmp_item_tag_container}

                [set_variables]
                    name=hoplite_targethexes
                    mode=append
                    [value]
                        unit_id=$hoplitebow.id
                        x=$this_item2.x
                        y=$this_item2.y
                        name=hoplite_targethex$hoplitebow.id
                    [/value]
                [/set_variables]

                [/do]
            [/foreach]

            {IF_VAR ranged_targetlocs$tmp_bow_dir|.length greater_than 0 (
            [then]
            [sound]
                name=magic-dark-big-miss.ogg
            [/sound]
            {VARIABLE hoplite_bow_aiming$side_number yes}
            [delay]
                time=500
            [/delay]
            [fire_event]
                id=hoplite_bow_shoot
            [/fire_event]
            [end_turn]
            [/end_turn]
            [/then]
            [else]
            [print]
               text= _ "Can't shoot in this direction!"
               size=22
               red=255
               duration=1500
            [/print]
            [/else]
            )}

            {CLEAR_VARIABLE hoplitebow}
            {HOPLITE_CLEAR_TMP_TARGETHEXES}
            {CLEAR_VARIABLE tmp_bow_dir}
        [/command]
    [/set_menu_item]

    [set_menu_item]
        id=hoplite_recall_spear
#        description=_"Recall your spear, costs <span color='#2c9fed'>50</span> energy (ends turn)"
        description=_"Recall your spear (ends turn)"
        image="misc/icon_spear.png"
        [show_if]
            [have_unit]
                id=Hoplite,Hoplite2
                side=$side_number
                x,y=$x1,$y1
                variation=spearless
            [/have_unit]
            [or]
            [have_location]
                x,y=$x1,$y1
                find_in=hoplite_spearloc$side_number
            [/have_location]
            [/or]
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    [variable]
                        name=spear_recall_unlocked1
                        equals=yes
                    [/variable]
                ) (
                    [variable]
                        name=spear_recall_unlocked2
                        equals=yes
                    [/variable]
                )}
                [or]
                    [variable]
                        name=spear_recall_unlocked
                        equals=yes
                    [/variable]
                [/or]
            [/and]
        [/show_if]
        [command]
#recall is now free
#            [if]
##ifdef MULTIPLAYER
#                [have_unit]
#                    id=Hoplite
#                    side=$side_number
#                [/have_unit]
#                [and]
#                    [variable]
#                        name=hoplite_energy1
#                        greater_than_equal_to=50
#                    [/variable]
#                [/and]
#                [or]
#                    [have_unit]
#                        id=Hoplite2
#                        side=$side_number
#                    [/have_unit]
#                    [and]
#                        [variable]
#                            name=hoplite_energy2
#                            greater_than_equal_to=50
#                        [/variable]
#                    [/and]
#                [/or]
##endif
##ifndef MULTIPLAYER
#                    [variable]
#                        name=hoplite_energy
#                        greater_than_equal_to=50
#                    [/variable]
##endif
#        [then]
##ifdef MULTIPLAYER
#                    [if]
#                        [have_unit]
#                            id=Hoplite
#                            side=$side_number
#                        [/have_unit]
#                        [then]
#                            {VARIABLE_OP hoplite_energy1 sub 50}
#                            {SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
#                        [/then]
#                        [else]
#                            {VARIABLE_OP hoplite_energy2 sub 50}
#                            {SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
#                        [/else]
#                    [/if]
##endif
##ifndef MULTIPLAYER
#        {VARIABLE_OP hoplite_energy sub 50}
#        {SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
##endif

            [sound]
                name=magic-faeriefire.ogg
            [/sound]

            {SPARTAN_CHANGE_VARIATION_PRESERVING_HP_EXACT (
            side=$side_number
            canrecruit=yes
            ) none}
        
            [remove_item]
                image=hoplite_spear$side_number
                x=0-99
                y=0-99
            [/remove_item]
        
            {VARIABLE hoplite_spear_on_ground$side_number no}
            {CLEAR_VARIABLE hoplite_spearloc$side_number}
            [end_turn]
            [/end_turn]
#        [/then]
#        [else]
#            [print]
#               text= _ "Not enough energy!"
#               size=22
#               red=255
#           duration=100
#            [/print]
#        [/else]
#        [/if]
        [/command]
    [/set_menu_item]
    [set_menu_item]
        id=hoplite_follow_spear
        description=_"Follow your spear, costs <span color='#2c9fed'>50</span> energy (ends turn)"
        image="misc/icon_spear.png"
        [show_if]
            [have_unit]
                id=Hoplite,Hoplite2
                side=$side_number
                x,y=$x1,$y1
                variation=spearless
            [/have_unit]
            [or]
            [have_location]
                x,y=$x1,$y1
                find_in=hoplite_spearloc$side_number
            [/have_location]
            [/or]
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    [variable]
                        name=spear_follow_unlocked1
                        equals=yes
                    [/variable]
                ) (
                    [variable]
                        name=spear_follow_unlocked2
                        equals=yes
                    [/variable]
                )}
                [or]
                    [variable]
                        name=spear_follow_unlocked
                        equals=yes
                    [/variable]
                [/or]
            [/and]
            [and]
            [have_location]
                [not]
                    [filter]
                    [/filter]
                [/not]
                find_in=hoplite_spearloc$side_number
            [/have_location]
            [/and]
        [/show_if]
        [command]
            [if]
#ifdef MULTIPLAYER
                [have_unit]
                    id=Hoplite
                    side=$side_number
                [/have_unit]
                [and]
                    [variable]
                        name=hoplite_energy1
                        greater_than_equal_to=50
                    [/variable]
                [/and]
                [or]
                    [have_unit]
                        id=Hoplite2
                        side=$side_number
                    [/have_unit]
                    [and]
                        [variable]
                            name=hoplite_energy2
                            greater_than_equal_to=50
                        [/variable]
                    [/and]
                [/or]
#endif
#ifndef MULTIPLAYER
                    [variable]
                        name=hoplite_energy
                        greater_than_equal_to=50
                    [/variable]
#endif
        [then]
#ifdef MULTIPLAYER
                    [if]
                        [have_unit]
                            id=Hoplite
                            side=$side_number
                        [/have_unit]
                        [then]
                            {VARIABLE_OP hoplite_energy1 sub 50}
                            {SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
                        [/then]
                        [else]
                            {VARIABLE_OP hoplite_energy2 sub 50}
                            {SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
                        [/else]
                    [/if]
#endif
#ifndef MULTIPLAYER
        {VARIABLE_OP hoplite_energy sub 50}
        {SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
#endif

             [object]
                 silent=yes
                 duration=turn end
                 [filter]
                     side=$side_number
                     canrecruit=yes
                 [/filter]
                 [effect]
                     apply_to=new_animation
                     {HOPLITE_TELEPORTANIM}
                 [/effect]
             [/object]

            [sound]
                name=magic-faeriefire.ogg
            [/sound]
            [store_locations]
                find_in=hoplite_spearloc$side_number
                variable=tmp_follow_loc
            [/store_locations]
            [animate_unit]
                flag=pre_teleport
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/animate_unit]
            [hide_unit]
                side=$side_number
                canrecruit=yes
            [/hide_unit]
            {TELEPORT_UNIT side,canrecruit=$side_number,yes $tmp_follow_loc.x $tmp_follow_loc.y}
            {CLEAR_VARIABLE tmp_follow_loc}
            [unhide_unit]
                side=$side_number
                canrecruit=yes
            [/unhide_unit]
            [animate_unit]
                flag=post_teleport
                [filter]
                    side=$side_number
                    canrecruit=yes
                [/filter]
            [/animate_unit]
            {SPARTAN_CHANGE_VARIATION_PRESERVING_HP_EXACT (
            side=$side_number
            canrecruit=yes
            ) none}
        
            [remove_item]
                image=hoplite_spear$side_number
                x=0-99
                y=0-99
            [/remove_item]
        
            {VARIABLE hoplite_spear_on_ground$side_number no}
            {CLEAR_VARIABLE hoplite_spearloc$side_number}
            [end_turn]
            [/end_turn]
        [/then]
        [else]
            [print]
               text= _ "Not enough energy!"
               size=22
               red=255
           duration=100
            [/print]
        [/else]
        [/if]
        [/command]
    [/set_menu_item]
[/event]
[event]
    name=turn refresh
    id=hoplite_bow_shoot
    first_time_only=no
    [filter_condition]
        {VARIABLE_CONDITIONAL hoplite_bow_aiming$side_number equals yes}
    [/filter_condition]

    [store_unit]
        [filter]
            id=Hoplite,Hoplite2
            side=$side_number
        [/filter]
        variable=hoplitebow
        kill=no
    [/store_unit]

    {STORE_TARGETHEXES_OF_ID $hoplitebow.id hoplite_bow_targethexes}

    {HOPLITE_CLEAR_TARGETHEXES_BY_ID $hoplitebow.id}

    [foreach]
        array=hoplite_bow_targethexes
        variable=this_targethex
        index_var=e
        [do]
#            [chat]
#                message=$this_targethex.x,$this_targethex.y
#            [/chat]
            [if]
            [have_unit]
                x,y=$this_targethex.x,$this_targethex.y
            [filter_side]
                [enemy_of]
                    side=$hoplitebow.side
                [/enemy_of]
            [/filter_side]
            [not]
                ability_type_active=hides
            [/not]
            [/have_unit]
            [and]
                {VARIABLE_CONDITIONAL tmp_rangedtarget_found not_equals yes}
            [/and]
            [or]
            [have_unit]
                x,y=$this_targethex.x,$this_targethex.y
            [filter_side]
                [enemy_of]
                    side=$hoplitebow.side
                [/enemy_of]
            [/filter_side]
            ability_type_active=hides
            [/have_unit]
            [and]
                {VARIABLE_CONDITIONAL tmp_rangedtarget_found not_equals yes}
            [/and]
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    [variable]
                        name=bow_eagle_eye_unlocked1
                        equals=yes
                    [/variable]
                ) (
                    [variable]
                        name=bow_eagle_eye_unlocked2
                        equals=yes
                    [/variable]
                )}
                [or]
                    [variable]
                        name=bow_eagle_eye_unlocked
                        equals=yes
                    [/variable]
                [/or]
            [/and]
            [/or]
            [then]
                {VARIABLE tmp_rangedtarget_found yes}
                [store_unit]
                    [filter]
                        x,y=$this_targethex.x,$this_targethex.y
                    [/filter]
                    variable=hoplitebow_target
                [/store_unit]
            [/then]
            [/if]
        [/do]
    [/foreach]
    {CLEAR_VARIABLE tmp_rangedtarget_found}

    [if]
    [have_unit]
        id=$hoplitebow_target.id
    [/have_unit]
    [then]
        {SPARTAN_RETURN_ATTACK_INDEX_BY_NAME hoplitebow bow}

        {VARIABLE tmp_targetloc.x $hoplitebow_target.x}
        {VARIABLE tmp_targetloc.y $hoplitebow_target.y}
        [fire_event]
            name=attack#to trigger teleportaway event
            [primary_unit]
                id=$hoplitebow.id
            [/primary_unit]
            [secondary_unit]
                id=$hoplitebow_target.id
            [/secondary_unit]
            [primary_attack]
                name=$hoplitebow.attack[$tmp_index_return].name
                damage=$hoplitebow.attack[$tmp_index_return].damage
                type=$hoplitebow.attack[$tmp_index_return].type
            [/primary_attack]
        [/fire_event]
        [if]
        [have_unit]
            id=$hoplitebow_target.id
            x,y=$tmp_targetloc.x,$tmp_targetloc.y#only attack the target if the target hasn't teleported before being attacked
            [not]
                ability_type_active=hides
            [/not]
        [/have_unit]
        [or]
        [have_unit]
            id=$hoplitebow_target.id
            x,y=$tmp_targetloc.x,$tmp_targetloc.y#only attack the target if the target hasn't teleported before being attacked
        [/have_unit]
        [and]
            {HOPLITE_PLAYERFILTER_VAR2 (
                [variable]
                    name=bow_eagle_eye_unlocked1
                    equals=yes
                [/variable]
            ) (
                [variable]
                    name=bow_eagle_eye_unlocked2
                    equals=yes
                [/variable]
            )}
            [or]
                [variable]
                    name=bow_eagle_eye_unlocked
                    equals=yes
                [/variable]
            [/or]
        [/and]
        [/or]
        [then]
            [harm_unit]
                [filter]
                    id=$hoplitebow_target.id
                [/filter]
                [filter_second]
                    id=$hoplitebow.id
                [/filter_second]
                [primary_attack]
                    name=$hoplitebow.attack[$tmp_index_return].name
                [/primary_attack]
                amount=$hoplitebow.attack[$tmp_index_return].damage
                damage_type=$hoplitebow.attack[$tmp_index_return].type
                alignment=$hoplitebow.alignment
                fire_event=yes
                animate=yes
                delay=0
                experience=no
            [/harm_unit]
            [if]
            {HOPLITE_PLAYERFILTER_VAR2 (
                [variable]
                    name=bow_knockback_unlocked1
                    equals=yes
                [/variable]
            ) (
                [variable]
                    name=bow_knockback_unlocked2
                    equals=yes
                [/variable]
            )}
            [or]
                [variable]
                    name=bow_knockback_unlocked
                    equals=yes
                [/variable]
            [/or]
            [then]
                #source and destination is intentionally reversed
                [store_relative_direction]
                    [source]
                        x,y=$hoplitebow_target.x,$hoplitebow_target.y
                    [/source]
                    [destination]
                        x,y=$hoplitebow.x,$hoplitebow.y
                    [/destination]
                    variable=hoplitebow_aimdir
                [/store_relative_direction]
                {HOPLITE_KNOCKBACK_CODE_REPEATED 1 hoplitebow_target hoplitebow $hoplitebow_aimdir}
                {CLEAR_VARIABLE hoplitebow_aimdir}
            [/then]
            [/if]
        [/then]
        [/if]
        {CLEAR_VARIABLE tmp_targetloc}
        {CLEAR_VARIABLE tmp_index_return}
    [/then]
    [/if]

    {CLEAR_VARIABLE hoplitebow}
    {CLEAR_VARIABLE hoplitebow_target}
    {CLEAR_VARIABLE hoplite_bow_targethexes}
    {CLEAR_VARIABLE hoplite_bow_aiming$side_number}
[/event]
[event]
    name=start
    [set_menu_item]
        id=hoplite_healpotion
        description=_"Drink a healing potion to restore some hitpoints."
        image="misc/icon_healpotion.png"
        [show_if]
            [have_unit]
                id=Hoplite,Hoplite2
                side=$side_number
                x,y=$x1,$y1
                [not]
                    [filter_wml]
                        [status]
                            unhealable=yes
                        [/status]
                    [/filter_wml]
                [/not]
            [/have_unit]
            {VARIABLE_CONDITIONAL hoplite_multiplayer equals yes}
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    {VARIABLE_CONDITIONAL healpotionI_unlocked1 equals yes}
                    [and]
                        {VARIABLE_CONDITIONAL hoplite_healpotion_cooldown1 less_than 1}
                    [/and]
                ) (
                    {VARIABLE_CONDITIONAL healpotionI_unlocked2 equals yes}
                    [and]
                        {VARIABLE_CONDITIONAL hoplite_healpotion_cooldown2 less_than 1}
                    [/and]
                )}
            [/and]
            [or]
                [have_unit]
                    id=Hoplite
                    side=$side_number
                    x,y=$x1,$y1
                [/have_unit]
                [and]
                    {VARIABLE_CONDITIONAL hoplite_multiplayer not_equals yes}
                    {VARIABLE_CONDITIONAL healpotionI_unlocked equals yes}
                    {VARIABLE_CONDITIONAL hoplite_healpotion_cooldown less_than 1}
                [/and]
            [/or]
        [/show_if]
        [command]
            [store_unit]
                [filter]
                    id=Hoplite,Hoplite2
                    side=$side_number
                [/filter]
                variable=hoplite_healpotion
                kill=no
            [/store_unit]
            [if]
                [variable]
                    name=hoplite_healpotion.hitpoints
                    less_than=$hoplite_healpotion.max_hitpoints
                [/variable]
                [then]
                    [unstore_unit]
                        variable=hoplite_healpotion
                    [/unstore_unit]
                    [sound]
                        name=potion.ogg
                    [/sound]
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                            {HOPLITE_PLAYERFILTER (
                                [heal_unit]
                                    [filter]
                                        id=Hoplite
                                    [/filter]
                                    amount=$healpotion_restore1
                                    animate=yes
                                    restore_statuses=no
                                [/heal_unit]
                                [modify_unit]
                                    [filter]
                                        id=Hoplite
                                    [/filter]
                                    [status]
                                        poisoned=no
                                    [/status]
                                [/modify_unit]
#now potions are once per depth
#                                {IF_VAR healpotionbag_unlocked1 equals yes (
#                                    [then]
                                        {VARIABLE hoplite_healpotion_cooldown1 1}
#                                    [/then]
#                                    [else]
#                                        {VARIABLE hoplite_healpotion_cooldown1 2}
#                                    [/else]
#                                )}
                                {IF_VAR healpotionenergy_unlocked1 equals yes (
                                    [then]
                                        [delay]
                                            time=500
                                        [/delay]
                                        [sound]
                                            name=magic-faeriefire.ogg
                                        [/sound]
                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number 75}
                                    [/then]
                                )}
                                #energy is added a second time
                                {IF_VAR healpotionenergyII_unlocked1 equals yes (
                                    [then]
                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number 75}
                                        [object]
                                            silent=yes
                                            duration=turn
                                            [filter]
                                                id=Hoplite
                                            [/filter]
                                            [effect]
                                                apply_to=attack
                                                increase_damage=50%
                                            [/effect]
                                        [/object]
                                        [floating_text]
                                            [filter]
                                                id=Hoplite
                                            [/filter]
                                            text="<span color='#ffc800'>" + _ "+50% damage!" + "</span>"
                                        [/floating_text]
                                    [/then]
                                )}
                            ) (
                                [heal_unit]
                                    [filter]
                                        id=Hoplite2
                                    [/filter]
                                    amount=$healpotion_restore2
                                    animate=yes
                                    restore_statuses=no
                                [/heal_unit]
                                [modify_unit]
                                    [filter]
                                        id=Hoplite2
                                    [/filter]
                                    [status]
                                        poisoned=no
                                    [/status]
                                [/modify_unit]
#now potions are once per depth
#                                {IF_VAR healpotionbag_unlocked2 equals yes (
#                                    [then]
                                        {VARIABLE hoplite_healpotion_cooldown2 1}
#                                    [/then]
#                                    [else]
#                                        {VARIABLE hoplite_healpotion_cooldown2 2}
#                                    [/else]
#                                )}
                                {IF_VAR healpotionenergy_unlocked2 equals yes (
                                    [then]
                                        [delay]
                                            time=500
                                        [/delay]
                                        [sound]
                                            name=magic-faeriefire.ogg
                                        [/sound]
                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number 75}
                                    [/then]
                                )}
                                #energy is added a second time
                                {IF_VAR healpotionenergyII_unlocked2 equals yes (
                                    [then]
                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number 75}
                                        [object]
                                            silent=yes
                                            duration=turn
                                            [filter]
                                                id=Hoplite2
                                            [/filter]
                                            [effect]
                                                apply_to=attack
                                                increase_damage=50%
                                            [/effect]
                                        [/object]
                                        [floating_text]
                                            [filter]
                                                id=Hoplite2
                                            [/filter]
                                            text="<span color='#ffc800'>" + _ "+50% damage!" + "</span>"
                                        [/floating_text]
                                    [/then]
                                )}
                            )}
                        [/then]
                        [else]
                            [heal_unit]
                                [filter]
                                    id=Hoplite
                                [/filter]
                                amount=$healpotion_restore
                                animate=yes
                                restore_statuses=no
                            [/heal_unit]
                            [modify_unit]
                                [filter]
                                    id=Hoplite
                                [/filter]
                                [status]
                                    poisoned=no
                                [/status]
                            [/modify_unit]
#now potions are once per depth
#                            {IF_VAR healpotionbag_unlocked equals yes (
#                                [then]
                                    {VARIABLE hoplite_healpotion_cooldown 1}
#                                [/then]
#                                [else]
#                                    {VARIABLE hoplite_healpotion_cooldown 2}
#                                [/else]
#                            )}
                            {IF_VAR healpotionenergy_unlocked equals yes (
                                [then]
                                    [delay]
                                        time=500
                                    [/delay]
                                    [sound]
                                        name=magic-faeriefire.ogg
                                    [/sound]
                                    {VARIABLE_OP hoplite_energy add 75}
                                    {IF_VAR hoplite_energy greater_than $hoplite_maxenergy (
                                        [then]
                                            {VARIABLE hoplite_energy $hoplite_maxenergy}
                                        [/then]
                                    )}
                                    {SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
                                [/then]
                            )}
                            #energy is added a second time
                            {IF_VAR healpotionenergyII_unlocked equals yes (
                                [then]
                                    {VARIABLE_OP hoplite_energy add 75}
                                    {IF_VAR hoplite_energy1 greater_than $hoplite_maxenergy (
                                        [then]
                                            {VARIABLE hoplite_energy $hoplite_maxenergy}
                                        [/then]
                                    )}
                                    {SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
                                    [object]
                                        silent=yes
                                        duration=turn
                                        [filter]
                                            id=Hoplite
                                        [/filter]
                                        [effect]
                                            apply_to=attack
                                            increase_damage=50%
                                        [/effect]
                                    [/object]
                                    [floating_text]
                                        [filter]
                                            id=Hoplite
                                        [/filter]
                                        text="<span color='#ffc800'>" + _ "+50% damage!" + "</span>"
                                    [/floating_text]
                                [/then]
                            )}
                        [/else]
                    [/if]
                [/then]
                [else]
                    [print]
                        text= _ "Hitpoints are already full!"
                        size=20
                        red=255
                        duration=2000
                    [/print]
                [/else]
            [/if]
        [/command]
    [/set_menu_item]
    [set_menu_item]
        id=hoplite_teleportaway
        description=_"Toggle the 'Teleport Away' upgrade (if you want to save energy)."
        [show_if]
            [have_unit]
                id=Hoplite,Hoplite2
                side=$side_number
                x,y=$x1,$y1
            [/have_unit]
            {VARIABLE_CONDITIONAL hoplite_multiplayer equals yes}
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    {VARIABLE_CONDITIONAL teleportaway_unlocked1 equals yes}
                ) (
                    {VARIABLE_CONDITIONAL teleportaway_unlocked2 equals yes}
                )}
            [/and]
            [or]
                [have_unit]
                    id=Hoplite
                    side=$side_number
                    x,y=$x1,$y1
                [/have_unit]
                [and]
                    {VARIABLE_CONDITIONAL hoplite_multiplayer not_equals yes}
                    {VARIABLE_CONDITIONAL teleportaway_unlocked equals yes}
                [/and]
            [/or]
        [/show_if]
        [command]
            [if]
                [have_unit]
                    id=Hoplite2
                [/have_unit]
                [then]
                    {HOPLITE_PLAYERFILTER (
                        {IF_VAR teleportaway_enabled1 not_equals yes (
                            [then]
                                {VARIABLE teleportaway_enabled1 yes}
                            [/then]
                            [else]
                                {VARIABLE teleportaway_enabled1 no}
                            [/else]
                        )}
                        [print]
                            text= _ "Teleport Away set to <b>$teleportaway_enabled1|</b> for side 1"
                            size=20
                            blue=255
                            duration=3000
                        [/print]
                    ) (
                        {IF_VAR teleportaway_enabled2 not_equals yes (
                            [then]
                                {VARIABLE teleportaway_enabled2 yes}
                            [/then]
                            [else]
                                {VARIABLE teleportaway_enabled2 no}
                            [/else]
                        )}
                        [print]
                            text= _ "Teleport Away set to <b>$teleportaway_enabled2|</b> for side 2"
                            size=20
                            blue=255
                            duration=3000
                        [/print]
                    )}
                [/then]
                [else]
                    {IF_VAR teleportaway_enabled not_equals yes (
                        [then]
                            {VARIABLE teleportaway_enabled yes}
                        [/then]
                        [else]
                            {VARIABLE teleportaway_enabled no}
                        [/else]
                    )}
                    [print]
                        text= _ "Teleport Away set to <b>$teleportaway_enabled|</b>"
                        size=20
                        blue=255
                        duration=3000
                    [/print]
                [/else]
            [/if]
        [/command]
    [/set_menu_item]
[/event]
[event]
    name=last breath
    id=spartan_phoenixamulet_event
    first_time_only=no

    [filter]
        id=Hoplite,Hoplite2
        [not]
            [filter_wml]
                [status]
                    unhealable=yes
                [/status]
            [/filter_wml]
        [/not]
    [/filter]

    {IF_VAR phoenixamulet_unlocked equals yes (
        [and]
            {VARIABLE_CONDITIONAL hoplite_revive_cooldown less_than 1}
        [/and]
        [or]
            {VARIABLE_CONDITIONAL phoenixamulet_unlocked1 equals yes}
            [and]
                {VARIABLE_CONDITIONAL hoplite_revive_cooldown1 less_than 1}
            [/and]
            [and]
                {VARIABLE_CONDITIONAL unit.id equals Hoplite}
            [/and]
        [/or]
        [or]
            {VARIABLE_CONDITIONAL phoenixamulet_unlocked2 equals yes}
            [and]
                {VARIABLE_CONDITIONAL hoplite_revive_cooldown2 less_than 1}
            [/and]
            [and]
                {VARIABLE_CONDITIONAL unit.id equals Hoplite2}
            [/and]
        [/or]
        [then]
            [sound]
                name={SOUND_LIST:HOLY}
            [/sound]
            [store_unit]
                [filter]
                    x,y=$x1,$y1
                [/filter]
                variable=hoplite_reborn
                kill=yes#removing the unit briefly
            [/store_unit]
            {VARIABLE hoplite_reborn.hitpoints 0}
            [unstore_unit]
                variable=hoplite_reborn
                find_vacant=no
            [/unstore_unit]
            {FLASH_WHITE (
                {IF_VAR phoenixamuletII_unlocked equals yes (
                    [or]
                        {VARIABLE_CONDITIONAL phoenixamuletII_unlocked1 equals yes}
                        [and]
                            {VARIABLE_CONDITIONAL unit.id equals Hoplite}
                        [/and]
                    [/or]
                    [or]
                        {VARIABLE_CONDITIONAL phoenixamuletII_unlocked2 equals yes}
                        [and]
                            {VARIABLE_CONDITIONAL unit.id equals Hoplite2}
                        [/and]
                    [/or]
                    [then]
                        [heal_unit]
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            amount=$healpotion_restore
                            animate=yes
                            restore_statuses=no
                        [/heal_unit]
                        [modify_unit]
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            [status]
                                poisoned=no
                            [/status]
                        [/modify_unit]
                        [if]
                            [have_unit]
                                id=Hoplite2
                            [/have_unit]
                            [then]
                                {HOPLITE_PLAYERFILTER_X1_Y1 (
                                    {VARIABLE_OP hoplite_energy1 add 75}
                                    {IF_VAR hoplite_energy1 greater_than $hoplite_maxenergy1 (
                                        [then]
                                            {VARIABLE hoplite_energy1 $hoplite_maxenergy1}
                                        [/then]
                                    )}
                                    {SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
                                ) (
                                    {VARIABLE_OP hoplite_energy2 add 75}
                                    {IF_VAR hoplite_energy2 greater_than $hoplite_maxenergy2 (
                                        [then]
                                            {VARIABLE hoplite_energy2 $hoplite_maxenergy2}
                                        [/then]
                                    )}
                                    {SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
                                )}
                            [/then]
                            [else]
                                {VARIABLE_OP hoplite_energy add 75}
                                {IF_VAR hoplite_energy greater_than $hoplite_maxenergy (
                                    [then]
                                        {VARIABLE hoplite_energy $hoplite_maxenergy}
                                    [/then]
                                )}
                                {SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
                            [/else]
                        [/if]
                    [/then]
                    [else]
                        [heal_unit]
                            [filter]
                                x,y=$x1,$y1
                            [/filter]
                            amount=10
                            animate=yes
                            restore_statuses=yes
                        [/heal_unit]
                    [/else]
                )}
                #   [delay]
                #     time=500
                #   [/delay]
                [sound]
                    name=fire.wav
                [/sound]
                [harm_unit]
                    [filter]
                        side=$hoplite_enemyside
                        [filter_adjacent]
                            x,y=$x1,$y1
                        [/filter_adjacent]
                        [not]
                            ability=spartan_bombfilter#otherwise dying to a bomb causes an infinite loop
                        [/not]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]
                    amount=10
                    damage_type=fire
                    alignment=$unit.alignment
                    fire_event=yes
                    animate=no
                    delay=0
                    experience=no
                [/harm_unit]
                [store_unit]
                    [filter]
                        side=$hoplite_enemyside
                    [/filter]
                    kill=no
                    variable=slowed
                [/store_unit]

                [foreach]
                    array=slowed
                    index_var=a
                    [do]
                        {VARIABLE this_item.status.slowed yes}
                        [unstore_unit]
                            variable=this_item
                        [/unstore_unit]
                    [/do]
                [/foreach]
            )}
            [if]
                [have_unit]
                    id=Hoplite2
                [/have_unit]
                [then]
                    {HOPLITE_PLAYERFILTER_X1_Y1 (
                    {VARIABLE hoplite_revive_cooldown1 $hoplite_phoenix_recharge1}
                    ) (
                    {VARIABLE hoplite_revive_cooldown2 $hoplite_phoenix_recharge2}
                    )}
                [/then]
                [else]
                    {VARIABLE hoplite_revive_cooldown $hoplite_phoenix_recharge1}
                [/else]
            [/if]
            {VARIABLE_OP revive_progress$unit.side add 1}
            {IF_VAR revive_progress$unit.side equals 5 (
                [then]
                    {ACHIEVEMENT_MESSAGE_LONE revive $unit.side}
                [/then]
            )}
            {CLEAR_VARIABLE hoplite_reborn}
        [/then]
    )}
[/event]
[event]
    name=attack
    first_time_only=no
    [filter]
        side=$hoplite_enemyside
    [/filter]
    [filter_second]
        id=Hoplite,Hoplite2
        ability=hoplite_teleportaway
    [/filter_second]

    [store_unit]
        [filter]
            id=Hoplite,Hoplite2
            x,y=$x2,$y2
        [/filter]
        variable=hoplite_teleportloc
        kill=no
    [/store_unit]

    {VARIABLE x2 $hoplite_teleportloc.x}
    {VARIABLE y2 $hoplite_teleportloc.y}
    {VARIABLE teleportaway_cost $weapon.damage}
    {VARIABLE_OP teleportaway_cost divide 10}
    {VARIABLE_OP teleportaway_cost multiply 75}
    {HOPLITE_GET_RESIST_MULT $second_unit.id $weapon.type}
    {VARIABLE_OP teleportaway_cost multiply $tmp_resistmult}
    {VARIABLE_OP teleportaway_cost round floor}
    {CLEAR_VARIABLE hoplite_teleportloc}
    {HOPLITE_TELEPORTAWAY_EVENT $teleportaway_cost (
        x,y=$x2,$y2
    )}
    {CLEAR_VARIABLE teleportaway_cost}
[/event]
[event]
    name=attack end
    first_time_only=no
    [filter_second]
        id=Hoplite,Hoplite2
    [/filter_second]
    [fire_event]
        id=hoplite_adrenaline
    [/fire_event]
[/event]
