#textdomain wesnoth-Hoplite

#define HOPLITE_SHADOWCLONE_EVENT ID UNLOCKVAR
    [store_locations]
        [and]
            [filter]
                id={ID}
            [/filter]
            radius=1
        [/and]
        [not]
            [filter]
            [/filter]
            [or]
                terrain=Xu*,Xo*,Q***,W**
            [/or]
        [/not]
        variable=cloneloc
    [/store_locations]
    {IF_VAR cloneloc.length greater_than 0 (
        [then]
            [sound]
                name=magic-dark.ogg
            [/sound]
            [unit]
                side=$hoplite_allyside
                type=Hoplite_Shadowclone_ally
                name=_"Shadow Clone"
                x,y=$cloneloc.x,$cloneloc.y
                animate=yes
                placement=map
                passable=yes
            [/unit]
            [if]
                [have_unit]
                    id=Hoplite
                    side=$side_number
                [/have_unit]
                [and]
                    [variable]
                        name=shadowcloneII_unlocked1
                        equals=yes
                    [/variable]
                    [or]
                        [variable]
                            name=shadowcloneII_unlocked
                            equals=yes
                        [/variable]
                    [/or]
                [/and]
                [or]
                    [variable]
                        name=shadowcloneII_unlocked2
                        equals=yes
                    [/variable]
                    [and]
                        [have_unit]
                            id=Hoplite2
                            side=$side_number
                        [/have_unit]
                    [/and]
                [/or]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            type=Hoplite_Shadowclone_ally
                            x,y=$cloneloc.x,$cloneloc.y
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=10
                            increase_total=10
                        [/effect]
                        [effect]
                            apply_to=variation
                            name=can_leap
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [have_unit]
                    id=Hoplite
                    side=$side_number
                [/have_unit]
                [and]
                    [variable]
                        name=shadowcloneIII_unlocked1
                        equals=yes
                    [/variable]
                    [or]
                        [variable]
                            name=shadowcloneIII_unlocked
                            equals=yes
                        [/variable]
                    [/or]
                [/and]
                [or]
                    [variable]
                        name=shadowcloneIII_unlocked2
                        equals=yes
                    [/variable]
                    [and]
                        [have_unit]
                            id=Hoplite2
                            side=$side_number
                        [/have_unit]
                    [/and]
                [/or]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            type=Hoplite_Shadowclone_ally
                            x,y=$cloneloc.x,$cloneloc.y
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=5
                            increase_total=5
                        [/effect]
                        [effect]
                           apply_to=resistance
                           replace=no
                           [resistance]
                              blade=-15
                              pierce=-15
                              impact=-15
                              arcane=-15
                              fire=-15
                              cold=-15
                           [/resistance]
                        [/effect]
                        [effect]
                           apply_to=attack
                           name=spear
                           [set_specials]
                              mode=append
                              {WEAPON_SPECIAL_IMPALE}
                           [/set_specials]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [set_variable]
                name=clonesuccess
                value=yes
            [/set_variable]
        [/then]
        [else]
            [print]
                text= _ "All adjacent hexes are occupied!"
                size=20
                red=255
                duration=150
            [/print]
        [/else]
    )}
#enddef

[event]
    name=attack_end
    id=hoplite_hitandrun_event
    first_time_only=no
    [filter]
        side=$hoplite_playerside
    [/filter]
    [filter_attack]
        special=hoplite_hitandrun
    [/filter_attack]
    [fire_event]
        id=hoplite_varcheck
    [/fire_event]
    {MODIFY_UNIT id=$unit.id moves 1}
[/event]
[event]
    name=side 1 turn end
    first_time_only=no
	{CHATMSG "rest event"}
#    {IF_VAR rest_unlocked equals yes (
#    [or]
#    [variable]
#      name=rest_unlocked1
#      equals=yes
#    [/variable]
#    [/or]
#        [then]
            [store_unit]
                [filter]
                    id=Hoplite
                    side=$side_number
                [/filter]
                variable=hoplite_rest
                kill=no
            [/store_unit]
            [if]
                [variable]
                    name=hoplite_rest.moves
                    greater_than=0
                [/variable]
                [and]
                    [variable]
                        name=hoplite_rest.attacks_left
                        greater_than=0
                    [/variable]
                [/and]
                [then]
                    {VARIABLE hoplite_still yes}
		    {IF_VAR shieldwall_unlocked equals yes (
		    [or]
		    {VARIABLE_CONDITIONAL shieldwall_unlocked1 equals yes}
		    [/or]
		    [then]
                    {VARIABLE shieldup_id Hoplite}
                    [fire_event]
                       id=hoplite_shieldup
                    [/fire_event]
                    {CLEAR_VARIABLE shieldup_id}
		    [/then])}
                [/then]
            [/if]
#        [/then]
#    )}
    {CLEAR_VARIABLE hoplite_usedportal}
    {CLEAR_VARIABLE hoplite_rest}
[/event]
[event]
    name=side 2 turn end
    first_time_only=no
	{CHATMSG "rest event 2"}
#    {IF_VAR rest_unlocked equals yes (
#    [or]
#    [variable]
#      name=rest_unlocked2
#      equals=yes
#    [/variable]
#    [/or]
#        [then]
            [store_unit]
                [filter]
                    id=Hoplite2
                    side=$side_number
                [/filter]
                variable=hoplite_rest2
                kill=no
            [/store_unit]
            [if]
                [variable]
                    name=hoplite_rest2.moves
                    greater_than=0
                [/variable]
                [and]
                    [variable]
                        name=hoplite_rest2.attacks_left
                        greater_than=0
                    [/variable]
                [/and]
                [then]
                    {VARIABLE hoplite_still2 yes}
		    {IF_VAR shieldwall_unlocked2 equals yes (
		    [then]
                    {VARIABLE shieldup_id Hoplite2}
                    [fire_event]
                       id=hoplite_shieldup
                    [/fire_event]
                    {CLEAR_VARIABLE shieldup_id}
		    [/then])}
                [/then]
            [/if]
#        [/then]
#    )}
    {CLEAR_VARIABLE hoplite_rest2}
[/event]
[event]
#ifdef MULTIPLAYER
    name=side 4 turn
#else
    name=side 3 turn
#endif
    first_time_only=no
	{CHATMSG "ratsIV event"}
            {VARIABLE_OP rat_cooldown sub 1}
    [if]
        [have_unit]
            id=Hoplite2
        [/have_unit]
        [then]
            {VARIABLE_OP rat_cooldown2 sub 1}
        [/then]
    [/if]
    {IF_VAR ratsIV_unlocked equals yes (
        [and]
            [variable]
                name=rat_cooldown
                less_than=1
            [/variable]
        [/and]
       [or]
            [variable]
                name=ratsIV_unlocked1
                equals=yes
            [/variable]
        [and]
            [variable]
                name=rat_cooldown1
                less_than=1
            [/variable]
        [/and]
       [/or]
       [then]
       [sound]
         name={SOUND_LIST:BAT_HIT}
       [/sound]
       
		{SCATTER_UNITS 1 Hoplite_Giantrat_ally 1 (
            terrain=Ur*,R*,D*,Gll
            [not]
                [filter]
                [/filter]
		radius=1
            [/not]
        ) (
            side=$hoplite_allyside
        )}
	
	{IF_VAR rat_power_unlocked equals yes (
	[or]
            [variable]
                name=rat_power_unlocked1
                equals=yes
            [/variable]
	[/or]
	[then]
        [set_variable]
          name=rat_cooldown
          value=4
        [/set_variable]
	[/then]
	[else]
        [set_variable]
          name=rat_cooldown
          value=3
        [/set_variable]
	[/else])}
        [/then]
    )}
    {IF_VAR ratsIV_unlocked2 equals yes (
        [and]
            [variable]
                name=rat_cooldown2
                less_than=1
            [/variable]
        [/and]
       [then]
       [sound]
         name={SOUND_LIST:BAT_HIT}
       [/sound]
       
		{SCATTER_UNITS 1 Hoplite_Giantrat_ally2 1 (
            terrain=Ur*,R*,D*,Gll
            [not]
                [filter]
                [/filter]
		radius=1
            [/not]
        ) (
            side=$hoplite_allyside
        )}
	
	{IF_VAR rat_power_unlocked2 equals yes (
	[then]
        [set_variable]
          name=rat_cooldown2
          value=4
        [/set_variable]
	[/then]
	[else]
        [set_variable]
          name=rat_cooldown2
          value=3
        [/set_variable]
	[/else])}
        [/then]
    )}
    #matters with the ambush upgrade:
    [modify_side]
        side=$hoplite_allyside
        team_name=hoplite
        user_team_name=_"Allies"
    [/modify_side]
[/event]

[event]
    name=start
    [set_menu_item]
        id=hoplite_shadowclone
        description= _ "Summon a Shadow Clone. Costs 100 energy."
        [show_if]
            [have_unit]
                id=Hoplite,Hoplite2
                x,y=$x1,$y1
                side=$side_number
            [/have_unit]
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    {VARIABLE_CONDITIONAL shadowclone_unlocked1 equals yes}
                    {VARIABLE_CONDITIONAL shadowcloneIIb_unlocked1 not_equals yes}
                    {VARIABLE_CONDITIONAL hoplite_shadowclone_cooldown1 less_than 1}
                ) (
                    {VARIABLE_CONDITIONAL shadowclone_unlocked2 equals yes}
                    {VARIABLE_CONDITIONAL shadowcloneIIb_unlocked2 not_equals yes}
                    {VARIABLE_CONDITIONAL hoplite_shadowclone_cooldown2 less_than 1}
                )}
                [or]
                    {VARIABLE_CONDITIONAL shadowclone_unlocked equals yes}
                    [and]
                        {VARIABLE_CONDITIONAL shadowcloneIIb_unlocked not_equals yes}
                        {VARIABLE_CONDITIONAL hoplite_shadowclone_cooldown less_than 1}
                    [/and]
                [/or]
            [/and]
        [/show_if]
        [command]
            [if]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    {VARIABLE_CONDITIONAL hoplite_energy1 greater_than_equal_to 100}
                ) (
                    {VARIABLE_CONDITIONAL hoplite_energy2 greater_than_equal_to 100}
                )}
                [or]
                    {VARIABLE_CONDITIONAL hoplite_energy greater_than_equal_to 100}
                [/or]
                [then]
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                            {HOPLITE_PLAYERFILTER (
                                {VARIABLE shadowclone_id Hoplite}
                                {VARIABLE shadowclone_unlockvar unlocked1}
                                {VARIABLE shadowclone_type mp1}
                            ) (
                                {VARIABLE shadowclone_id Hoplite2}
                                {VARIABLE shadowclone_unlockvar unlocked2}
                                {VARIABLE shadowclone_type mp2}
                            )}
                        [/then]
                        [else]
                            {VARIABLE shadowclone_id Hoplite}
                            {VARIABLE shadowclone_unlockvar unlocked}
                            {VARIABLE shadowclone_type sp}
                        [/else]
                    [/if]
                    {HOPLITE_SHADOWCLONE_EVENT $shadowclone_id $shadowclone_unlocked}
                    [if]
                        [variable]
                            name=clonesuccess
                            equals=yes
                        [/variable]
                        [then]
                            [if]
                                [variable]
                                    name=shadowclone_type
                                    equals=mp1
                                [/variable]
                                [then]
                                    {VARIABLE_OP hoplite_energy1 sub 100}
                                    {SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
                                    {VARIABLE hoplite_shadowclone_cooldown1 2}
                                [/then]
                                [elseif]
                                    [variable]
                                        name=shadowclone_type
                                        equals=mp2
                                    [/variable]
                                    [then]
                                        {VARIABLE_OP hoplite_energy2 sub 100}
                                        {SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
                                        {VARIABLE hoplite_shadowclone_cooldown2 2}
                                    [/then]
                                [/elseif]
                                [else]
                                    {VARIABLE_OP hoplite_energy sub 100}
                                    {SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
                                    {VARIABLE hoplite_shadowclone_cooldown 2}
                                [/else]
                            [/if]
                        [/then]
                    [/if]
                [/then]
                [else]
                    [print]
                        text= _ "Not enough energy!"
                        size=20
                        red=255
                    [/print]
                [/else]
            [/if]
            {CLEAR_VARIABLE shadowclone_id}
            {CLEAR_VARIABLE shadowclone_unlockvar}
            {CLEAR_VARIABLE shadowclone_type}
        [/command]
    [/set_menu_item]
    [set_menu_item]
        id=hoplite_shadowclone2
        description= _ "Summon a Shadow Clone. Costs 80 energy."
        [show_if]
            [have_unit]
                id=Hoplite,Hoplite2
                x,y=$x1,$y1
                side=$side_number
            [/have_unit]
            [and]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    {VARIABLE_CONDITIONAL shadowcloneIIb_unlocked1 equals yes}
                    {VARIABLE_CONDITIONAL hoplite_shadowclone_cooldown1 less_than 1}
                ) (
                    {VARIABLE_CONDITIONAL shadowcloneIIb_unlocked2 equals yes}
                    {VARIABLE_CONDITIONAL hoplite_shadowclone_cooldown2 less_than 1}
                )}
                [or]
                    {VARIABLE_CONDITIONAL shadowcloneIIb_unlocked equals yes}
                    [and]
                        {VARIABLE_CONDITIONAL hoplite_shadowclone_cooldown less_than 1}
                    [/and]
                [/or]
            [/and]
        [/show_if]
        [command]
            [if]
                {HOPLITE_PLAYERFILTER_VAR2 (
                    {VARIABLE_CONDITIONAL hoplite_energy1 greater_than_equal_to 80}
                ) (
                    {VARIABLE_CONDITIONAL hoplite_energy2 greater_than_equal_to 80}
                )}
                [or]
                    {VARIABLE_CONDITIONAL hoplite_energy greater_than_equal_to 80}
                [/or]
                [then]
                    [if]
                        [have_unit]
                            id=Hoplite2
                        [/have_unit]
                        [then]
                            {HOPLITE_PLAYERFILTER (
                                {VARIABLE shadowclone_id Hoplite}
                                {VARIABLE shadowclone_unlockvar unlocked1}
                                {VARIABLE shadowclone_type mp1}
                            ) (
                                {VARIABLE shadowclone_id Hoplite2}
                                {VARIABLE shadowclone_unlockvar unlocked2}
                                {VARIABLE shadowclone_type mp2}
                            )}
                        [/then]
                        [else]
                            {VARIABLE shadowclone_id Hoplite}
                            {VARIABLE shadowclone_unlockvar unlocked}
                            {VARIABLE shadowclone_type sp}
                        [/else]
                    [/if]
                    {HOPLITE_SHADOWCLONE_EVENT $shadowclone_id $shadowclone_unlocked}
                    [if]
                        [variable]
                            name=clonesuccess
                            equals=yes
                        [/variable]
                        [then]
                            [if]
                                [variable]
                                    name=shadowclone_type
                                    equals=mp1
                                [/variable]
                                [then]
                                    {VARIABLE_OP hoplite_energy1 sub 80}
                                    {SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
                                    {VARIABLE hoplite_shadowclone_cooldown1 1}
                                [/then]
                                [elseif]
                                    [variable]
                                        name=shadowclone_type
                                        equals=mp2
                                    [/variable]
                                    [then]
                                        {VARIABLE_OP hoplite_energy2 sub 80}
                                        {SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
                                        {VARIABLE hoplite_shadowclone_cooldown2 1}
                                    [/then]
                                [/elseif]
                                [else]
                                    {VARIABLE_OP hoplite_energy sub 80}
                                    {SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
                                    {VARIABLE hoplite_shadowclone_cooldown 1}
                                [/else]
                            [/if]
                        [/then]
                    [/if]
                [/then]
                [else]
                    [print]
                        text= _ "Not enough energy!"
                        size=20
                        red=255
                    [/print]
                [/else]
            [/if]
            {CLEAR_VARIABLE shadowclone_id}
            {CLEAR_VARIABLE shadowclone_unlockvar}
            {CLEAR_VARIABLE shadowclone_type}
        [/command]
    [/set_menu_item]
[/event]
#explosive spear animation event:
[event]
    id=spearexplode
    first_time_only=no
    {CHATMSG "exploding spear anim"}
    {IF_VAR spearthrowexplode_unlocked equals yes (
        [and]
            {VARIABLE_CONDITIONAL isspearthrowing equals yes}
        [/and]
        [or]
            {HOPLITE_PLAYERFILTER_VAR2 (
                {VARIABLE_CONDITIONAL spearthrowexplode_unlocked1 equals yes}
            ) (
                {VARIABLE_CONDITIONAL spearthrowexplode_unlocked2 equals yes}
            )}
            [and]
                {VARIABLE_CONDITIONAL isspearthrowing equals yes}
            [/and]
        [/or]
        [then]
            [object]
                silent=yes
                duration=forever
                [filter]
                    x,y=$x1,$y1
                [/filter]
                [effect]
                    apply_to=new_animation
                    [extra_anim]
                        flag=explode2
                        [missile_frame]
                            halo="projectiles/fireball-impact-[1~16].png~SCALE(300,300):60"
                            offset=0.0
                            auto_vflip=no
                        [/missile_frame]
                        [frame]
                            sound=explosion.ogg
                        [/frame]
                    [/extra_anim]
                [/effect]
            [/object]
            [animate_unit]
                flag=explode2
                [filter]
                    x,y=$x1,$y1
                [/filter]
            [/animate_unit]
        [/then]
    )}
[/event]
