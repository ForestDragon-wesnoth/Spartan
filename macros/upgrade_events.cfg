#textdomain wesnoth-Hoplite

#define HOPLITE_SHADOWCLONE_EVENT ID
    [store_locations]
        [and]
            [filter]
                id={ID}
            [/filter]
            radius=1
        [/and]
        [and]
            terrain={SPARTAN_UNITSPAWN_TERRAIN}
        [/and]
        [not]
            [filter]
            [/filter]
            #[or]
            #    terrain=Xu*^*,Xo*^*,Q*^*,W*^*,S*^*
            #[/or]
        [/not]
        variable=cloneloc
    [/store_locations]
    {IF_VAR cloneloc.length greater_than 0 (
        [then]
            [sound]
                name=magic-dark.ogg
            [/sound]
            #the shadowclone archer code is no longer needed
            [if]
                [have_unit]
                    id=Hoplite
                    side=$side_number
                [/have_unit]
                [and]
                    [variable]
                        name=shadowclone_archer_unlocked1
                        equals=yes
                    [/variable]
                [/and]
                [or]
                    [variable]
                        name=shadowclone_archer_unlocked2
                        equals=yes
                    [/variable]
                    [and]
                        [have_unit]
                            id=Hoplite2
                            side=$side_number
                        [/have_unit]
                    [/and]
                [/or]
                [then]
                    {VARIABLE tmp_shadowclone_type Hoplite_Shadowclone_archer_ally}
                [/then]
                [else]
                    {VARIABLE tmp_shadowclone_type Hoplite_Shadowclone_ally}
                [/else]
            [/if]

            [unit]
                side=$hoplite_allyside
                type=$tmp_shadowclone_type
                name=_"Shadow Clone"
                x,y=$cloneloc.x,$cloneloc.y
                animate=yes
                placement=map
                passable=yes
                [modifications]
                    [object]
                        silent=yes
                        [effect]
                            apply_to=new_ability
                            [abilities]
                                [dummy]
                                    id=spartan_ally_owner_side$side_number
                                [/dummy]
                                [dummy]
                                    id=spartan_shadowclone_filter#replaces the cloneloc coordinate check
                                [/dummy]
                            [/abilities]
                        [/effect]
                    [/object]
                [/modifications]
            [/unit]
            {CLEAR_VARIABLE tmp_shadowclone_type}
            [if]
                [variable]
                    name=shadowcloneII_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_shadowclone_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=10
                            increase_total=10
                        [/effect]
                        [effect]
                            apply_to=new_ability
                            [abilities]
                                {ABILITY_HOPLITE_LEAP_NONPLAYER 3}
                            [/abilities]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [variable]
                    name=shadowcloneIII_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_shadowclone_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=5
                            increase_total=5
                        [/effect]
                        [effect]
                            apply_to=resistance
                            replace=no
                            [resistance]
                                blade=-15
                                pierce=-15
                                impact=-15
                                arcane=-15
                                fire=-15
                                cold=-15
                            [/resistance]
                        [/effect]
                        [effect]
                            apply_to=attack
                            name=spear
                            [set_specials]
                                mode=append
                                {WEAPON_SPECIAL_IMPALE}
                            [/set_specials]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [variable]
                    name=shadowcloneIIIb_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_shadowclone_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=attack
                            name=spear
                            increase_damage=5
                        [/effect]
                    [/object]
                [/then]
            [/if]
            #swimming upgrade applies to shadow clones/spirit archers
            [if]
                [variable]
                    name=swimming_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_shadowclone_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=movement_costs
                            replace=yes
                            [movement_costs]
                                shallow_water=1
                                swamp_water=1
                            [/movement_costs]
                        [/effect]
                        #commented out, since it is no longer necessary
                        #            [effect]
                        #               apply_to=new_ability
                        #               [abilities]
                        #                   {ABILITY_HOPLITE_SWIMMER}
                        #               [/abilities]
                        #            [/effect]
                    [/object]
                [/then]
            [/if]
            #levitation upgrade applies to shadow clones/spirit archers
            [if]
                [variable]
                    name=levitation_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_shadowclone_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=movement_costs
                            replace=yes
                            {SPARTAN_FLY_MOVESCOSTS}
                        [/effect]
                        [effect]
                            apply_to=new_animation
                            [standing_anim]
                                start_time=0
                                alpha=0.8~0.4:700,0.4~0.6:300,0.6~0.4:300,0.4~0.8:700
                                submerge=0.01
                                terrain_type=Q*^*,W*^*,S*^*
                                [frame]
                                    duration=2115
                                    image="units/player/protector.png:705"
                                    image_mod="~GS()~CS(-200,-40,-0)"
                                    y=1:255,0:150,-1:150,0:150,1:255,0:150,-1:150,0:150,1:255,0:150,-1:150,0:150
                                [/frame]
                            [/standing_anim]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [set_variable]
                name=clonesuccess
                value=yes
            [/set_variable]
            [fire_event]
                name=spartan_apply_leap_and_sluggish_manually
                [primary_unit]
                    x,y=$cloneloc.x,$cloneloc.y
                [/primary_unit]
            [/fire_event]
            {ELIZABETH_MAGIC_LINE clone_or_archer (
                [message]
                    speaker=Elizabeth
                    message=_"What sort of summoning magic is that, I've never seen it! Oh, you must absolutely show me how you do that later!"
                [/message]
            )}
            {ALGADUR_LINE clone_or_archer (
                [message]
                    speaker=Algadur
                    message=_"Havin' endless reinforcements would have made me battle against those orcs a whole lot different.."
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    side=$side_number
                    message=_"Alas, we cannot change the past, but we can avenge your fallen brothers!"
                [/message]
                [message]
                    speaker=Algadur
                    message=_"Hah, damn right, shield-brother! Let's show those foul creatures our combined might!"
                [/message]
            )}
        [/then]
        [else]
            [print]
                text= _ "All adjacent hexes are occupied!"
                size=20
                red=255
                duration=2000
            [/print]
        [/else]
    )}
    {CLEAR_VARIABLE cloneloc}
#enddef

#define HOPLITE_SUMMONEDARCHER_EVENT ID
    [store_locations]
        [and]
            [filter]
                id={ID}
            [/filter]
            radius=1
        [/and]
        [and]
            terrain={SPARTAN_UNITSPAWN_TERRAIN}
        [/and]
        [not]
            [filter]
            [/filter]
#            [or]
#                terrain=Xu*^*,Xo*^*,Q*^*,W*^*,S*^*
#            [/or]
        [/not]
        variable=cloneloc
    [/store_locations]
    {IF_VAR cloneloc.length greater_than 0 (
        [then]
            [sound]
                name=magic-dark.ogg
            [/sound]
            #scrapped for now
            #[switch]
            #    variable=spartan_summonedarcher_type$side_number
            #    [case]
            #        value=1
            #        {VARIABLE tmp_summonedarcher_type Hoplite_Summonedarcher_ally}
            #    [/case]
            #    [case]
            #        value=2
            #        {VARIABLE tmp_summonedarcher_type Hoplite_Summonedarcher_upgraded_ally}
            #    [/case]
            #    [else]
            #        {VARIABLE tmp_summonedarcher_type Hoplite_Summonedarcher_ally}
            #    [/else]
            #[/switch]

            {VARIABLE tmp_summonedarcher_type Hoplite_Summonedarcher_ally}

            [unit]
                side=$hoplite_allyside
                type=$tmp_summonedarcher_type
                name=_"Spirit Archer"
                x,y=$cloneloc.x,$cloneloc.y
                animate=yes
                placement=map
                passable=yes
                [modifications]
                    [object]
                        silent=yes
                        [effect]
                            apply_to=new_ability
                            [abilities]
                                [dummy]
                                    id=spartan_ally_owner_side$side_number
                                [/dummy]
                                [dummy]
                                    id=spartan_summonedarcher_filter#replaces the cloneloc coordinate check
                                [/dummy]
                            [/abilities]
                        [/effect]
                    [/object]
                [/modifications]
            [/unit]
            {CLEAR_VARIABLE tmp_summonedarcher_type}
            [if]
                [variable]
                    name=summonedarcherII_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_summonedarcher_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase_total=5
                        [/effect]
                        [effect]
                            apply_to=remove_ability
                            [abilities]
                                {ABILITY_SPARTAN_RANGED 4}
                            [/abilities]
                        [/effect]
                        [effect]
                            apply_to=new_ability
                            [abilities]
                                {ABILITY_SPARTAN_RANGED 5}
                            [/abilities]
                        [/effect]
                        [effect]
                            apply_to=attack
                            name=bow
                            remove_specials=hoplite_ranged
                            [set_specials]
                                mode=append
                                {HOPLITE_RANGED_MACRO_SHARED hoplite_summonedarcherII 5 0 "misc/targethex-archer.png" first ()}
                            [/set_specials]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [variable]
                    name=summonedarcherIII_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_summonedarcher_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=attack
                            name=bow
                            increase_damage=5
                        [/effect]
                        [effect]
                            apply_to=attack
                            name=sword
                            increase_damage=3
                        [/effect]
                    [/object]
                [/then]
            [/if]
            #swimming upgrade applies to shadow clones/spirit archers
            [if]
                [variable]
                    name=swimming_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_summonedarcher_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=movement_costs
                            replace=yes
                            [movement_costs]
                                shallow_water=1
                                swamp_water=1
                            [/movement_costs]
                        [/effect]
                        #commented out, since it is no longer necessary
                        #            [effect]
                        #               apply_to=new_ability
                        #               [abilities]
                        #                   {ABILITY_HOPLITE_SWIMMER}
                        #               [/abilities]
                        #            [/effect]
                    [/object]
                [/then]
            [/if]
            #levitation upgrade applies to shadow clones/spirit archers
            [if]
                [variable]
                    name=levitation_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_summonedarcher_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=movement_costs
                            replace=yes
                            {SPARTAN_FLY_MOVESCOSTS}
                        [/effect]
                        [effect]
                            apply_to=new_animation
                            [standing_anim]
                                start_time=0
                                alpha=0.8~0.4:700,0.4~0.6:300,0.6~0.4:300,0.4~0.8:700
                                submerge=0.01
                                terrain_type=Q*^*,W*^*,S*^*
                                [frame]
                                    duration=2115
                                    image="units/human-loyalists/longbowman.png:4000"
                                    image_mod="~GS()~CS(-200,-40,-0)"
                                    y=1:255,0:150,-1:150,0:150,1:255,0:150,-1:150,0:150,1:255,0:150,-1:150,0:150
                                [/frame]
                            [/standing_anim]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [set_variable]
                name=clonesuccess
                value=yes
            [/set_variable]
            [fire_event]
                name=spartan_apply_leap_and_sluggish_manually
                [primary_unit]
                    x,y=$cloneloc.x,$cloneloc.y
                [/primary_unit]
            [/fire_event]
            {ELIZABETH_MAGIC_LINE clone_or_archer (
                [message]
                    speaker=Elizabeth
                    message=_"What sort of summoning magic is that, I've never seen it! Oh, you must absolutely show me how you do that later!"
                [/message]
            )}
            {ALGADUR_LINE clone_or_archer (
                [message]
                    speaker=Algadur
                    message=_"Havin' endless reinforcements would have made me battle against those orcs a whole lot different.."
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    side=$side_number
                    message=_"Alas, we cannot change the past, but we can avenge your fallen brothers!"
                [/message]
                [message]
                    speaker=Algadur
                    message=_"Hah, damn right, shield-brother! Let's show those foul creatures our combined might!"
                [/message]
            )}
        [/then]
        [else]
            [print]
                text= _ "All adjacent hexes are occupied!"
                size=20
                red=255
                duration=2000
            [/print]
        [/else]
    )}
    {CLEAR_VARIABLE cloneloc}
#enddef

#define SPARTAN_APPLY_BURN DAMAGE FILTER ATTACKER_ID
    [store_unit]
        [filter]
            {FILTER}
        [/filter]
        variable=burn_store
        kill=no
    [/store_unit]

    [foreach]
        array=burn_store
        index_var=i
        [do]
            {IF_VAR this_item.variables.burn_damage greater_than_equal_to {DAMAGE} (
                [else]
                    [modify_unit]
                        [filter]
                            id=$this_item.id
                        [/filter]
                        {VARIABLE burn_damage {DAMAGE}}
                    [/modify_unit]
                [/else]
            )}

            [if]
                [have_unit]
                    id=$this_item.id
                    ability=spartan_burning
                [/have_unit]
                [else]
                    [object]
                        silent=yes
                        duration=scenario

                        [filter]
                            id=$this_item.id
                        [/filter]

                        [effect]
                            apply_to=new_ability
                            [abilities]
                                [dummy]
                                    id=spartan_burning
                                [/dummy]
                            [/abilities]
                        [/effect]
                    [/object]
                    [unit_overlay]
                        id=$this_item.id
                        image="misc/overlay-burning.png"
                    [/unit_overlay]
                [/else]
            [/if]
        [/do]
    [/foreach]

    {CLEAR_VARIABLE burn_store}
#enddef

#this is a macro so that it's usable both for the enthrall menu AND the "apply enthrall buffs rectroactively" mechanic. using ability checks to prevent the same object being repeated on units
#define SPARTAN_APPLY_ENTHRALL_BUFFS FILTER OWNER_SIDE
    [object]
        silent=yes
        duration=forever
        [filter]
            {FILTER}
            [not]
                ability=hoplite_thrall
            [/not]
        [/filter]
        [effect]
            apply_to=halo
            halo="halo/elven/shyde-stationary-halo[1~6].png:150"
        [/effect]
        [effect]
            apply_to=new_ability
            [abilities]
                [dummy]
                    id=hoplite_thrall#for filtering
                [/dummy]
            [/abilities]
        [/effect]
        [effect]
            apply_to=new_ability
            [abilities]
                [dummy]
                    id=spartan_ally_owner_side{OWNER_SIDE}
                [/dummy]
            [/abilities]
        [/effect]
    [/object]

#using this hacky workaround with variables, since the upgrade is only actually set as unlocked AFTER upgrade effects are triggered, and therefore I cannot use a normal 'upgrade is unlocked' check for rectroactively applying the buffs to existing thralls in upgrade code

#    {IF_VAR enthrallII_unlocked{OWNER_SIDE} equals yes (
    {IF_VAR spartan_thrallbuff_enthrallII_{OWNER_SIDE} equals yes (
        [then]
            [object]
                silent=yes
                duration=forever
                [filter]
                    {FILTER}
                    [not]
                        ability=spartan_enthrall_regen
                    [/not]
                [/filter]
                [effect]
                    apply_to=hitpoints
                    increase_total=5
                [/effect]
                [effect]
                    apply_to=attack
                    increase_damage=2
                [/effect]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=spartan_enthrall_regen
                            name= _ "thrall regeneration +2"
                            female_name= _ "female^thrall regeneration +2"
                            description= _ "The unit will heal itself 2 HP per turn. This stacks with normal regeneration/healing abilities."
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/then]
    )}

#using this hacky workaround with variables, since the upgrade is only actually set as unlocked AFTER upgrade effects are triggered, and therefore I cannot use a normal 'upgrade is unlocked' check for rectroactively applying the buffs to existing thralls in upgrade code

#    {IF_VAR enthrallIII_unlocked{OWNER_SIDE} equals yes (
    {IF_VAR spartan_thrallbuff_enthrallIII_{OWNER_SIDE} equals yes (

        [then]
            [object]
                silent=yes
                duration=forever
                [filter]
                    {FILTER}
                    [not]
                        ability=spartan_dummy_thrall_buff_hp_mp
                    [/not]
                [/filter]
                [effect]
                    apply_to=hitpoints
                    increase_total=5
                [/effect]
                [effect]
                    apply_to=movement
                    increase=1
                [/effect]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=spartan_dummy_thrall_buff_hp_mp#for filtering
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/then]
    )}
#enddef

#macro for forge_list.cfg

#define SPARTAN_APPLY_ENTHRALL_BUFFS_RETROACTIVELY OWNER_SIDE
    [store_unit]
        [filter]
            ability=hoplite_thrall
            [and]
                ability=spartan_ally_owner_side{OWNER_SIDE}
            [/and]
        [/filter]
        variable=tmp_hoplite_thralls_to_update
        kill=no
    [/store_unit]
    [foreach]
        array=tmp_hoplite_thralls_to_update
        index_var=i
        [do]
            {SPARTAN_APPLY_ENTHRALL_BUFFS (id=$this_item.id) {OWNER_SIDE}}
        [/do]
    [/foreach]
    {CLEAR_VARIABLE tmp_hoplite_thralls_to_update}
#enddef

#define SPARTAN_TARGET_SPELLS_MENU
                                    #storing the player to check spell radiuses
                                    [store_unit]
                                        [filter]
                                            id=Hoplite,Hoplite2
                                            side=$side_number
                                        [/filter]
                                        variable=tmp_casting_sorcerer
                                        kill=no
                                    [/store_unit]
                                    [message]
                                        speaker=narrator
                                        caption=_ "Hoplite spell menu"
                                        message=_ "Select a targeted spell to use:"
#ifdef MULTIPLAYER
                                        side_for=$side_number
#endif
                                        [option]
                                            image="attacks/blank-attack.png"
                                            description=_"Return to the Game"
                                            [command]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/lightning.png"
                                            description=_"<span color='#ffff99'>Lightning Bolt</span>: deal $lightning_bolt_damage$side_number|| damage to target enemy
    ends your turn
    Costs <span color='#ffff99'>75</span> energy
    Range: <span color='#ffff99'>unlimited</span>
    Target: <span color='#ffff99'>Enemy</span>"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL spell_lightning_unlocked$side_number equals yes}
                                            [/show_if]
                                            [command]
                                                [if]
                                                    [have_unit]
                                                        [filter_side]
                                                            [enemy_of]
                                                                side=$side_number
                                                            [/enemy_of]
                                                        [/filter_side]
                                                        x,y=$x1,$y1
                                                        #[and]
                                                        #    [filter_location]
                                                        #        x,y=$tmp_casting_sorcerer.x,$tmp_casting_sorcerer.y
                                                        #        radius=99
                                                        #    [/filter_location]
                                                        #[/and]
                                                    [/have_unit]
                                                    [then]
                                                        [if]
                                                        {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 75}
                                                        [then]
                                                        [floating_text]
                                                            x,y=$tmp_casting_sorcerer.x,$tmp_casting_sorcerer.y
                                                            text="<span color='#ffff99'>" + _ "Lightning Bolt" + "</span>"
                                                        [/floating_text]
                                                        #add lightning anims to the attacked unit
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$hoplite_enemyside
                                                                x,y=$x1,$y1
                                                            [/filter]
                                                            [effect]
                                                                apply_to=new_animation
                                                                [extra_anim]
                                                                    flag=hit_by_lightning
                                                                    start_time=-250
                                                                    missile_start_time=-250
                                                                    [missile_frame]
                                                                        halo=halo/lightning-bolt-1-[1~4].png:100
                                                                        halo_y=-125
                                                                        offset=0.0
                                                                        auto_vflip=no
                                                                    [/missile_frame]
                                                                    [frame]
                                                                        duration=400
                                                                        sound=lightning.ogg
                                                                    [/frame]
                                                                [/extra_anim]
                                                                [extra_anim]
                                                                    flag=hit_by_lightning
                                                                    start_time=-250
                                                                    missile_start_time=-250
                                                                    [missile_frame]
                                                                        halo=halo/lightning-bolt-2-[1~4].png:100
                                                                        halo_y=-125
                                                                        offset=0.0
                                                                        auto_vflip=no
                                                                    [/missile_frame]
                                                                    [frame]
                                                                        duration=400
                                                                        sound=lightning.ogg
                                                                    [/frame]
                                                                [/extra_anim]
                                                                [extra_anim]
                                                                    flag=hit_by_lightning
                                                                    start_time=-250
                                                                    missile_start_time=-250
                                                                    [missile_frame]
                                                                        halo=halo/lightning-bolt-3-[1~4].png:100
                                                                        halo_y=-125
                                                                        offset=0.0
                                                                        auto_vflip=no
                                                                    [/missile_frame]
                                                                    [frame]
                                                                        duration=400
                                                                        sound=lightning.ogg
                                                                    [/frame]
                                                                [/extra_anim]
                                                            [/effect]
                                                        [/object]

                                                        [animate_unit]
                                                            flag=hit_by_lightning
                                                            [filter]
                                                                side=$hoplite_enemyside
                                                                x,y=$x1,$y1
                                                            [/filter]
                                                        [/animate_unit]                                                        
                                                        {SPARTAN_CALCULATE_DAMAGE tmp_casting_sorcerer $lightning_bolt_damage$side_number||}
                                                        [spartan_harm_unit]
                                                            [filter]
                                                                side=$hoplite_enemyside
                                                                x,y=$x1,$y1
                                                            [/filter]
                                                            [filter_second]
                                                                id=$tmp_casting_sorcerer.id
                                                            [/filter_second]
                                                            amount=$tmp_spartan_calculated_damage
                                                            damage_type=fire
                                                            fire_event=yes
                                                            animate=defender
                                                            delay=0
                                                            experience=yes
                                                        [/spartan_harm_unit]
                                                        {CLEAR_VARIABLE tmp_spartan_calculated_damage}
                                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -75}
                                                        [end_turn]
                                                        [/end_turn]

                                                        [/then]
                                                        [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                        [/else]
                                                        [/if]

                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not a valid target!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/twister.png"
                                            description=_"<span color='#ffff99'>Sandstorm</span>: summon a $sandstorm_type_text$side_number||
    If you already have a summoned $sandstorm_type_text$side_number||, it is destroyed before the new one is spawned
    Costs <span color='#ffff99'>75</span> energy
    Range: <span color='#ffff99'>$sandstorm_range$side_number||</span>
    Target: <span color='#ffff99'>Empty tile</span>"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL spell_sandstorm_unlocked$side_number equals yes}
                                            [/show_if]
                                            [command]
                                                [if]
                                                    [have_location]
                                                        x,y=$x1,$y1
                                                        [not]
                                                            terrain={SPARTAN_WALL_TERRAIN}
                                                        [/not]
                                                    [/have_location]
                                                    #only empty tiles are valid targets for summoning
                                                    [and]
                                                        [not]
                                                            [have_unit]
                                                                x,y=$x1,$y1
                                                            [/have_unit]
                                                        [/not]
                                                    [/and]
                                                    [and]
                                                    [have_location]
                                                        x,y=$x1,$y1
                                                        [and]
                                                            x,y=$tmp_casting_sorcerer.x,$tmp_casting_sorcerer.y
                                                            radius=$sandstorm_range$side_number
                                                        [/and]
                                                    [/have_location]
                                                    [/and]
                                                    [then]
                                                        [if]
                                                        {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 75}
                                                        [then]
                                                                [floating_text]
                                                                    x,y=$tmp_casting_sorcerer.x,$tmp_casting_sorcerer.y
                                                                    text="<span color='#ffff99'>" + _ "Sandstorm" + "</span>"
                                                                [/floating_text]

                                                                #destroy existing sandstorm when summoning a new one (so you can only have one at a time but without a "only usable once per depth" limit)

                                                                [kill]
                                                                    ability=spartan_sandstorm_summon$side_number
                                                                    animate=yes
                                                                    fire_event=yes
                                                                [/kill]

                                                                [sound]
                                                                    name=windsweep.ogg
                                                                [/sound]
                                                                [unit]
                                                                    side=$hoplite_allyside
                                                                    type=$sandstorm_type$side_number
                                                                    x,y=$x1,$y1
                                                                    animate=yes
                                                                    placement=map
                                                                    passable=yes
                                                                    [modifications]
                                                                        [object]
                                                                            silent=yes
                                                                            [effect]
                                                                                apply_to=new_ability
                                                                                [abilities]
                                                                                    [dummy]
                                                                                        id=spartan_ally_owner_side$side_number
                                                                                    [/dummy]
                                                                                    #for despawning
                                                                                    [dummy]
                                                                                        id=spartan_sandstorm_summon$side_number
                                                                                    [/dummy]
                                                                                [/abilities]
                                                                            [/effect]
                                                                        [/object]
                                                                    [/modifications]
                                                                [/unit]
                                                                {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -75}
                                                        [/then]
                                                        [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                        [/else]
                                                        [/if]
                                                
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not a valid target!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                    [/message]
                                    {CLEAR_VARIABLE tmp_casting_sorcerer}
#enddef

#define SPARTAN_UPGRADE_EVENTS
    [event]
        name=attack_end
        id=hoplite_hitandrun_event
        first_time_only=no
        [filter]
            side=$hoplite_playerside
        [/filter]
        [filter_attack]
            special_id=hoplite_hitandrun
        [/filter_attack]
        #removes leaping/teleporting, to prevent it being usable for free with hit-and-run
        [if]
            [have_unit]
                x,y=$x1,$y1
                ability=hoplite_leap
                [or]
                    x,y=$x1,$y1
                    ability=hoplite_teleport
                [/or]
            [/have_unit]
            [then]
                [object]
                    silent=yes
                    duration=turn end
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            {ABILITY_LEAPING2}
                            {ABILITY_HOPLITE_TELEPORTING}
                        [/abilities]
                    [/effect]
                [/object]
            [/then]
        [/if]
        {MODIFY_UNIT id=$unit.id moves 1}
    [/event]
    [event]
        name=die
        id=hoplite_swordcombo_event
        first_time_only=no
        [filter_second]
            side=$hoplite_playerside
        [/filter_second]
        [filter_second_attack]
            special_id=hoplite_combo
            [or]
                special_id=hoplite_comboII
            [/or]
        [/filter_second_attack]
        #only triggers on offense
        [filter_condition]
            {VARIABLE_CONDITIONAL second_unit.side equals $side_number}
        [/filter_condition]

        [if]
            {VARIABLE_CONDITIONAL second_unit.abilities.spartan_combo_tracker.times greater_than_equal_to $hoplite_combo_amount$second_unit.side}
            [else]
                {VARIABLE tmp_combo_counter 0}
                {VARIABLE_OP tmp_combo_counter add $second_unit.abilities.spartan_combo_tracker.times}
                {VARIABLE_OP tmp_combo_counter add 1}
                [object]
                    silent=yes
                    duration=turn end
                    [filter]
                        x,y=$x2,$y2
                    [/filter]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            [spartan_combo_tracker]
                                id=hoplite_combo_triggered
                            [/spartan_combo_tracker]
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [spartan_combo_tracker]
                                id=hoplite_combo_triggered
                                times=$tmp_combo_counter
                            [/spartan_combo_tracker]
                        [/abilities]
                    [/effect]
                [/object]
                {MODIFY_UNIT id=$second_unit.id attacks_left "$($second_unit.attacks_left + 1)"}
                [floating_text]
                    x,y=$x2,$y2
                    text=_"combo"
                [/floating_text]
            [/else]
        [/if]
    [/event]
    [event]
        name=side 1 turn end
        first_time_only=no
        {CHATMSG "rest event"}
        #    {IF_VAR rest_unlocked equals yes (
        #    [or]
        #    [variable]
        #      name=rest_unlocked1
        #      equals=yes
        #    [/variable]
        #    [/or]
        #        [then]
        [store_unit]
            [filter]
                id=Hoplite
                side=$side_number
            [/filter]
            variable=hoplite_rest
            kill=no
        [/store_unit]
        [if]
            [variable]
                name=hoplite_rest.moves
                greater_than=0
            [/variable]
            [and]
                [variable]
                    name=hoplite_rest.attacks_left
                    greater_than=0
                [/variable]
            [/and]
            [then]
                {VARIABLE hoplite_still yes}
                {IF_VAR shieldwall_unlocked1 equals yes (
                    [then]
                        {VARIABLE shieldup_id Hoplite}
                        [fire_event]
                            id=hoplite_shieldup
                        [/fire_event]
                        {CLEAR_VARIABLE shieldup_id}
                    [/then])}

                    {IF_VAR spear_counter_unlocked$side_number equals yes (
                        [then]
                            [object]
                                silent=yes
                                duration=turn
                                [filter]
                                    id=Hoplite,Hoplite2
                                    side=$side_number
                                [/filter]
                                [effect]
                                    apply_to=attack
                                    name=spear
                                    defense_weight=1.0
                                    [set_specials]
                                        mode=append
                                        {SPECIAL_HOPLITE_COUNTERATTACK}
                                    [/set_specials]
                                [/effect]
                            [/object]
                        [/then]
                    )}
                [/then]
            [/if]
            #        [/then]
            #    )}
            {CLEAR_VARIABLE hoplite_usedportal}
            {CLEAR_VARIABLE hoplite_rest}
        [/event]
#ifdef MULTIPLAYER
        [event]
            name=side 2 turn end
            first_time_only=no
            {CHATMSG "rest event 2"}
            #    {IF_VAR rest_unlocked equals yes (
            #    [or]
            #    [variable]
            #      name=rest_unlocked2
            #      equals=yes
            #    [/variable]
            #    [/or]
            #        [then]
            [store_unit]
                [filter]
                    id=Hoplite2
                    side=$side_number
                [/filter]
                variable=hoplite_rest2
                kill=no
            [/store_unit]
            [if]
                [variable]
                    name=hoplite_rest2.moves
                    greater_than=0
                [/variable]
                [and]
                    [variable]
                        name=hoplite_rest2.attacks_left
                        greater_than=0
                    [/variable]
                [/and]
                [then]
                    {VARIABLE hoplite_still2 yes}
                    {IF_VAR shieldwall_unlocked2 equals yes (
                        [then]
                            {VARIABLE shieldup_id Hoplite2}
                            [fire_event]
                                id=hoplite_shieldup
                            [/fire_event]
                            {CLEAR_VARIABLE shieldup_id}
                        [/then])}

                        {IF_VAR spear_counter_unlocked$side_number equals yes (
                            [then]
                                [object]
                                    silent=yes
                                    duration=turn
                                    [filter]
                                        id=Hoplite,Hoplite2
                                        side=$side_number
                                    [/filter]
                                    [effect]
                                        apply_to=attack
                                        name=spear
                                        defense_weight=1.0
                                        [set_specials]
                                            mode=append
                                            {SPECIAL_HOPLITE_COUNTERATTACK}
                                        [/set_specials]
                                    [/effect]
                                [/object]
                            [/then]
                        )}
                    [/then]
                [/if]
                #        [/then]
                #    )}
                {CLEAR_VARIABLE hoplite_rest2}
            [/event]
#endif
            [event]
                name=side {SPARTAN_ALLY_SIDE} turn
                first_time_only=no
                {CHATMSG "rat_legion event"}
                {VARIABLE_OP rat_cooldown1 sub 1}
                [if]
                    [have_unit]
                        id=Hoplite2
                    [/have_unit]
                    [then]
                        {VARIABLE_OP rat_cooldown2 sub 1}
                    [/then]
                [/if]
                {IF_VAR rat_legion_unlocked1 equals yes (
                    [and]
                        [variable]
                            name=rat_cooldown1
                            less_than=1
                        [/variable]
                    [/and]
                    [then]
                        [sound]
                            name={SOUND_LIST:BAT_HIT}
                        [/sound]

                        {SCATTER_UNITS 1 Hoplite_Giantrat_ally 1 (
                            terrain={SPARTAN_UNITSPAWN_TERRAIN}
                            [not]
                                [filter]
                                [/filter]
                                radius=1
                            [/not]
                        ) (
                            side=$hoplite_allyside
                            [modifications]
                                [object]
                                    silent=yes
                                    [effect]
                                        apply_to=new_ability
                                        [abilities]
                                            [dummy]
                                                id=spartan_ally_owner_side1
                                            [/dummy]
                                        [/abilities]
                                    [/effect]
                                [/object]
                            [/modifications]
                        )}

                        {IF_VAR rat_power_unlocked equals yes (
                            [or]
                                [variable]
                                    name=rat_powerII_unlocked1
                                    equals=yes
                                [/variable]
                            [/or]
                            [then]
                                [set_variable]
                                    name=rat_cooldown1
                                    value=6
                                [/set_variable]
                            [/then]
                            [else]
                                [set_variable]
                                    name=rat_cooldown1
                                    value=4
                                [/set_variable]
                            [/else])}
                        [/then]
                    )}
                    {IF_VAR rat_legion_unlocked2 equals yes (
                        [and]
                            [variable]
                                name=rat_cooldown2
                                less_than=1
                            [/variable]
                        [/and]
                        [then]
                            [sound]
                                name={SOUND_LIST:BAT_HIT}
                            [/sound]

                            {SCATTER_UNITS 1 Hoplite_Giantrat_ally 1 (
                                terrain={SPARTAN_UNITSPAWN_TERRAIN}
                                [not]
                                    [filter]
                                    [/filter]
                                    radius=1
                                [/not]
                            ) (
                                side=$hoplite_allyside
                                [modifications]
                                    [object]
                                        silent=yes
                                        [effect]
                                            apply_to=new_ability
                                            [abilities]
                                                [dummy]
                                                    id=spartan_ally_owner_side2
                                                [/dummy]
                                            [/abilities]
                                        [/effect]
                                    [/object]
                                [/modifications]
                            )}

                            {IF_VAR rat_powerII_unlocked2 equals yes (
                                [then]
                                    [set_variable]
                                        name=rat_cooldown2
                                        value=6
                                    [/set_variable]
                                [/then]
                                [else]
                                    [set_variable]
                                        name=rat_cooldown2
                                        value=4
                                    [/set_variable]
                                [/else])}
                            [/then]
                        )}
                        #matters with the ambush upgrade:
                        [modify_side]
                            side=$hoplite_allyside
                            team_name=hoplite
                            user_team_name=_"Allies"
                        [/modify_side]
                    [/event]
                    [event]
                        name=start
                        [set_menu_item]
                            id=hoplite_skills
                            description= _ "Skills"
                            image="misc/skills.png"
                            [show_if]
                                [have_unit]
                                    id=Hoplite,Hoplite2
                                    x,y=$x1,$y1
                                    side=$side_number
                                [/have_unit]
                                #            [and]
                                #                {VARIABLE_CONDITIONAL shadowclone_unlocked$side_number equals yes}
                                #                [and]
                                #                    {VARIABLE_CONDITIONAL hoplite_shadowclone_cooldown$side_number less_than 1}
                                #                [/and]
                                #            [/and]
                            [/show_if]
                            [command]
                                [fire_event]
                                    id=spartan_skill_menu_event
                                    [primary_unit]
                                        x,y=$x1,$y1
                                    [/primary_unit]
                                [/fire_event]
                            [/command]
                        [/set_menu_item]
                        #Sorcerer class targeted spells
                        [set_menu_item]
                            id=hoplite_target_spells
                            description= _ "Targeted Spells"
                            image="misc/sorcerer_spells.png"
                            [show_if]
                                [have_unit]
                                    id=Hoplite,Hoplite2
                                    #x,y=$x1,$y1
                                    side=$side_number
                                [/have_unit]
                                [and]
                                    {VARIABLE_CONDITIONAL spartan_selected_character$side_number equals sorcerer}
                                [/and]
                            [/show_if]
                            [command]
                                #fire event does not work here since there isn't always a unit at x1 y1
                                #[fire_event]
                                #    id=spartan_targeted_spell_menu_event
                                #    [primary_unit]
                                #        x,y=$x1,$y1
                                #    [/primary_unit]
                                #[/fire_event]
                                {SPARTAN_TARGET_SPELLS_MENU}
                            [/command]
                        [/set_menu_item]
                    [/event]
                    #explosive spear animation event:
                    [event]
                        id=spearexplode
                        first_time_only=no
                        {CHATMSG "exploding spear anim"}
                        {IF_VAR spearthrowexplode_unlocked$side_number equals yes (
                            [and]
                                {VARIABLE_CONDITIONAL isspearthrowing equals yes}
                            [/and]
                            [and]
                                [have_unit]
                                    id=Hoplite,Hoplite2
                                    side=$side_number
                                    ability=spartan_skill_used_explosive_spear
                                [/have_unit]
                            [/and]
                            [then]
                                [object]
                                    silent=yes
                                    duration=forever
                                    [filter]
                                        x,y=$x1,$y1
                                    [/filter]
                                    [effect]
                                        apply_to=new_animation
                                        [extra_anim]
                                            flag=explode2
                                            [missile_frame]
                                                halo="projectiles/fireball-impact-[1~16].png~SCALE(300,300):60"
                                                offset=0.0
                                                auto_vflip=no
                                            [/missile_frame]
                                            [frame]
                                                sound=explosion.ogg
                                            [/frame]
                                        [/extra_anim]
                                    [/effect]
                                [/object]
                                [animate_unit]
                                    flag=explode2
                                    [filter]
                                        x,y=$x1,$y1
                                    [/filter]
                                [/animate_unit]
                            [/then]
                        )}
                    [/event]
                    [event]
                        name=start
                        id=hoplite_upgrade_ability_menus
                        first_time_only=no
                        [set_menu_item]
                            id=hoplite_wizardbeam
                            description=_"Cast the flame blast spell in this direction."
                            image="misc/icon_fire.png"
                            [show_if]
                                [have_location]
                                    [filter_adjacent_location]
                                        [filter]
                                            id=Hoplite,Hoplite2
                                            side=$side_number
                                            formula="attacks_left > 0"#to prevent flame blast being usable while having the Persuasive Pacifist pact
                                        [/filter]
                                    [/filter_adjacent_location]
                                    x,y=$x1,$y1
                                [/have_location]
                                [and]
                                    [variable]
                                        name=wizardbeam_unlocked$side_number
                                        equals=yes
                                    [/variable]
                                    [and]
                                        [variable]
                                            name=hoplite_wizardbeam_cooldown$side_number
                                            less_than=1
                                        [/variable]
                                    [/and]
                                [/and]
                            [/show_if]
                            [command]
                                [animate_unit]
                                    flag=standing
                                    [facing]
                                        x,y=$x1,$y1
                                    [/facing]
                                    [filter]
                                        id=Hoplite,Hoplite2
                                        side=$side_number
                                    [/filter]
                                [/animate_unit]
                                [store_unit]
                                    [filter]
                                        id=Hoplite,Hoplite2
                                        side=$side_number
                                    [/filter]
                                    variable=hoplitebeam
                                    kill=no
                                [/store_unit]

                                {SPARTAN_GETDIR_REVERSED $hoplitebeam.x $hoplitebeam.y $x1 $y1 tmp_beam_dir}
                                #            {STORE_TARGETLOCS_PART hoplitebeam $tmp_beam_dir 5 0}
                                {STORE_TARGETHEX_LOC hoplitebeam $hoplite_wizardbeam_range$side_number| 0}

                                [foreach]
                                    array=ranged_targetlocs$tmp_beam_dir
                                    variable=this_item2
                                    index_var=e
                                    [do]
                                        [set_variables]
                                            name=tmp_item_tag_container
                                            [value]
                                                x=$this_item2.x
                                                y=$this_item2.y
                                                image="misc/targethex.png"
                                                name=hoplite_player_wizardbeamtargethex
                                            [/value]
                                        [/set_variables]

                                        #am using [insert_tag] instead of just item, otherwise the game doesn't substitute the id variable for some reason

                                        [insert_tag]
                                            name=item
                                            variable=tmp_item_tag_container
                                        [/insert_tag]

                                        {CLEAR_VARIABLE tmp_item_tag_container}
                                    [/do]
                                [/foreach]

                                [sound]
                                    name=magic-dark-big-miss.ogg
                                [/sound]
                                [delay]
                                    time=500
                                [/delay]
                                [remove_item]
                                    image=hoplite_player_wizardbeamtargethex
                                    x,y=0-99
                                [/remove_item]
                                [redraw][/redraw]

                                [if]
                                    [have_unit]
                                        side=$hoplite_enemyside
                                        [filter_location]
                                            find_in=ranged_targetlocs$tmp_beam_dir
                                        [/filter_location]
                                    [/have_unit]
                                    [then]
                                        [animate_unit]
                                            flag=wizardbeam$hoplite_wizardbeam_range$side_number||
                                            [filter]
                                                id=$hoplitebeam.id
                                            [/filter]
                                            [facing]
                                                x,y=$x1,$y1
                                            [/facing]
                                        [/animate_unit]
                                        {VARIABLE wizardbeam_targets yes}
                                    [/then]
                                [/if]

                                {SPARTAN_RETURN_ATTACK_INDEX_BY_NAME hoplitebeam wizardbeam}

                                #using foreach instead of just find_in filter, so that enemies are hit in the right order
                                [foreach]
                                    array=ranged_targetlocs$tmp_beam_dir
                                    variable=this_item2
                                    index_var=e
                                    [do]
                                        {SPARTAN_CALCULATE_DAMAGE hoplitebeam $hoplitebeam.attack[$tmp_index_return].damage}
                                        [spartan_harm_unit]
                                            [filter]
                                                side=$hoplite_enemyside
                                                x,y=$this_item2.x,$this_item2.y
                                            [/filter]
                                            [filter_second]
                                                id=$hoplitebeam.id
                                            [/filter_second]
                                            [primary_attack]
                                                name=wizardbeam
                                            [/primary_attack]
                                            #amount=$hoplitebeam.attack[$tmp_index_return].damage
                                            amount=$tmp_spartan_calculated_damage
                                            damage_type=$hoplitebeam.attack[$tmp_index_return].type
                                            fire_event=yes
                                            animate=defender
                                            delay=0
                                            experience=yes
                                        [/spartan_harm_unit]
                                        {CLEAR_VARIABLE tmp_spartan_calculated_damage}
                                        [if]
                                            [variable]
                                                name=wizardbeam_burn_unlocked$side_number
                                                equals=yes
                                            [/variable]
                                            [then]
                                                {SPARTAN_APPLY_BURN $hoplite_wizardbeam_burn$side_number (
                                                    side=$hoplite_enemyside
                                                    x,y=$this_item2.x,$this_item2.y
                                                ) $hoplitebeam.id}
                                            [/then]
                                        [/if]
                                    [/do]
                                [/foreach]
                                {CLEAR_VARIABLE tmp_index_return}

                                {CLEAR_VARIABLE hoplitebeam}
                                {IF_VAR wizardbeam_targets equals yes (
                                    [then]
                                        {VARIABLE hoplite_wizardbeam_cooldown$side_number $hoplite_wizardbeam_max_cooldown$side_number}

                                        #using two seperate lines instead of an if statement inside the other line, in case there is 1 sorcerer and 1 non-sorcerer player in mp, so both lines can trigger

                                        {IF_VAR spartan_selected_character$side_number equals sorcerer (
                                        [then]

                                        {ALGADUR_LINE flame_blast_sorcerer (
                                             [message]
                                                 speaker=Algadur
                                                 message=_"So ye are a fire mage? Perfect, time to burn some orcs to a crisp!"
                                             [/message]
                                        )}

                                        [/then]
                                        [else]

                                        {ALGADUR_LINE flame_blast (

                                            {IF_VAR algadur_line_archmage equals yes (
                                                [then]
                                                    [message]
                                                        speaker=Algadur
                                                        # wmllint: local spelling spelltomes
                                                        message=_"Putting the old mage's spelltomes to good use already, eh? Ye're quite a quick learner!"
                                                    [/message]
                                                    [message]
                                                        id=Hoplite,Hoplite2
                                                        side=$side_number
                                                        message=_"It seems I have a rather unusually strong affinity for magic, even though I trained most of my life as a warrior."
                                                    [/message]
                                                [/then]
                                                [else]
                                                    [message]
                                                        speaker=Algadur
                                                        message=_"Did you just... cast fire magic?! Where did ye even learn that!?"
                                                    [/message]
                                                    [message]
                                                        id=Hoplite,Hoplite2
                                                        side=$side_number
                                                        message=_"From the secret spelltomes an old mage entrusted to me. It seems I have a rather unusually strong affinity for magic, even though I trained most of my life as a warrior."
                                                    [/message]
                                                [/else]
                                            )}
                                            [message]
                                                speaker=Algadur
                                                message=_"Talented warrior AND talented mage? Yer as rare as an arcanister!"
                                            [/message]
                                        )}

                                        [/else]
                                        )}

                                        #using two seperate lines instead of an if statement inside the other line, in case there is 1 sorcerer and 1 non-sorcerer player in mp, so both lines can trigger


                                        {IF_VAR elizabeth_line_flame_sorcerer not_equals yes (
                                            [and]
                                                [have_unit]
                                                    id=Elizabeth
                                                [/have_unit]
                                            [/and]
                                            [and]
                                                {VARIABLE_CONDITIONAL spartan_selected_character$side_number equals sorcerer}
                                            [/and]
                                            [then]
                                                [message]
                                                    speaker=Elizabeth
                                                    message=_"I see you're a fellow pyromancer, very good! One more thing we got in common."
                                                [/message]
                                                [message]
                                                    side=$side_number
                                                    canrecruit=yes
                                                    message=_"Indeed."
                                                [/message]
                                                {VARIABLE elizabeth_line_flame_sorcerer yes}
                                                {VARIABLE_OP elizabeth_magic_lines add 1}#so I can maybe later add a line about how the hoplite has become basically an archmage, if the value is high enough TODO: maybe make the values seperate in MP
                                            [/then]
                                        )}

                                        {IF_VAR elizabeth_line_flame not_equals yes (
                                            [and]
                                                [have_unit]
                                                    id=Elizabeth
                                                [/have_unit]
                                            [/and]
                                            [not]
                                                {VARIABLE_CONDITIONAL spartan_selected_character$side_number equals sorcerer}
                                            [/not]
                                            [then]
                                                [message]
                                                    speaker=Elizabeth
                                                    message=_"You're a spellcaster too? Wouldn't have guessed from your appearance..."
                                                [/message]
                                                {IF_VAR ratsI_unlocked equals yes (
                                                    [or]
                                                        {VARIABLE_CONDITIONAL ratsI_unlocked1 equals yes}
                                                    [/or]
                                                    [or]
                                                        {VARIABLE_CONDITIONAL ratsI_unlocked2 equals yes}
                                                    [/or]
                                                    [then]
                                                        [message]
                                                            speaker=Elizabeth
                                                            message=_"...But then again, mind-controlling rats isn't very typical of a warrior either."
                                                        [/message]
                                                    [/then])}
                                                    {VARIABLE elizabeth_line_flame yes}
                                                    {VARIABLE_OP elizabeth_magic_lines add 1}#so I can maybe later add a line about how the hoplite has become basically an archmage, if the value is high enough TODO: maybe make the values seperate in MP

                                                    [message]
                                                        side=$side_number
                                                        canrecruit=yes
                                                        message=_"Heh, what can I say, I'm a man of many talents."
                                                    [/message]
                                                [/then])}

                                                [end_turn]
                                                [/end_turn]
                                                {CLEAR_VARIABLE wizardbeam_targets}
                                            [/then]
                                        )}
                                        {HOPLITE_CLEAR_TMP_TARGETHEXES}
                                        {CLEAR_VARIABLE tmp_beam_dir}
                                    [/command]
                                [/set_menu_item]

                                [set_menu_item]
                                    id=hoplite_enthrall
                                    description=_"Enthrall this enemy (costs <span color='#2c9fed'>75</span> energy per enemy level)"
                                    image="misc/eye-icon.png"
                                    [show_if]
                                        [have_unit]
                                            side=$hoplite_enemyside
                                            #       level=0,1,2
                                            x,y=$x1,$y1
                                            [not]
                                                ability=hoplite_boss_immunities
                                                [or]
                                                    ability=spartan_bombfilter
                                                [/or]
                                            [/not]
                                            [filter_location]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                                radius=1
                                            [/filter_location]
                                        [/have_unit]
                                        [and]
                                            [variable]
                                                name=enthrall_unlocked$side_number
                                                equals=yes
                                            [/variable]
                                        [/and]
                                        [and]
                                            [have_unit]
                                                id=Hoplite,Hoplite2
                                                side=$side_number
                                                [filter_adjacent]
                                                    x,y=$x1,$y1
                                                [/filter_adjacent]
                                            [/have_unit]
                                        [/and]
                                    [/show_if]
                                    [command]
                                        [store_unit]
                                            [filter]
                                                x,y=$x1,$y1
                                            [/filter]
                                            variable=enthrallenemy
                                            kill=no
                                        [/store_unit]
                                        #   [if]
                                        #   [have_unit]
                                        #     x,y=$x1,$y1
                                        #      ability=summonerfilter
                                        #   [/have_unit]
                                        #   [then]
                                        #        [print]
                                        #           text= _ "Can't enthrall summoners!"
                                        #           size=22
                                        #           red=255
                                        #      duration=2000
                                        #        [/print]
                                        #   [/then]
                                        #    [elseif]
                                        #    [have_unit]
                                        #      x,y=$x1,$y1
                                        #      ability=hoplite_boss_immunities
                                        #    [/have_unit]
                                        #    [then]
                                        #        [print]
                                        #           text= _ "Can't enthrall bosses!"
                                        #           size=22
                                        #           red=255
                                        #       duration=100
                                        #        [/print]
                                        #    [/then]
                                        #    [/elseif]
                                        #   [else]
                                        {VARIABLE enthrallenergy $enthrallenemy.level}
                                        {VARIABLE_OP enthrallenergy multiply 75}
                                        {IF_VAR enthrallenergy less_than 35 (
                                            [then]
                                                {VARIABLE enthrallenergy 35}
                                            [/then])}
                                            [if]
                                                [variable]
                                                    name=hoplite_energy$side_number
                                                    greater_than_equal_to=$enthrallenergy
                                                [/variable]
                                                [then]
                                                    {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -$enthrallenergy}
                                                    [sound]
                                                        name=magic-dark-big.ogg
                                                    [/sound]
                                                    [modify_unit]
                                                        [filter]
                                                            x,y=$x1,$y1
                                                        [/filter]
                                                        side=$hoplite_allyside
                                                    [/modify_unit]
                                                    {SPARTAN_APPLY_ENTHRALL_BUFFS (x,y=$x1,$y1) $side_number}
                                                    [heal_unit]
                                                        [filter]
                                                            x,y=$x1,$y1
                                                        [/filter]
                                                        amount=full
                                                        animate=no
                                                    [/heal_unit]
                                                    [modify_side]
                                                        side=$hoplite_allyside
                                                        controller=ai
                                                        hidden=no
                                                    [/modify_side]

                                                    #if auto-loyal is enabled, make newly-enthralled enemies loyal instantly
                                                    [store_unit]
                                                        [filter]
                                                            ability=hoplite_loyalthrall$side_number
                                                        [/filter]
                                                        variable=tmp_current_thralls
                                                        kill=no
                                                    [/store_unit]
                                                    [if]
                                                        {VARIABLE_CONDITIONAL tmp_current_thralls.length less_than $hoplite_thrall_limit$side_number}
                                                        [and]
                                                            {VARIABLE_CONDITIONAL spartan_thrall_auto_loyal$side_number equals yes}
                                                        [/and]
                                                        [then]
                                                            [object]
                                                                silent=yes
                                                                duration=forever
                                                                [filter]
                                                                    x,y=$x1,$y1
                                                                [/filter]
                                                                [effect]
                                                                    apply_to=new_ability
                                                                    [abilities]
                                                                        [dummy]
                                                                            id=hoplite_loyalthrall$side_number
                                                                        [/dummy]
                                                                        [dummy]
                                                                            id=hoplite_loyalthrall_filter
                                                                        [/dummy]
                                                                    [/abilities]
                                                                [/effect]
                                                            [/object]

                                                            [modify_unit]
                                                                [filter]
                                                                    x,y=$x1,$y1
                                                                [/filter]
                                                                {TRAIT_LOYAL}
                                                            [/modify_unit]
                                                        [/then]
                                                    [/if]
                                                    {CLEAR_VARIABLE tmp_current_thralls}

                                                    #removed cooldown for now, as I bumped up the energy cost instead
                                                    #        [if]
                                                    #            [have_unit]
                                                    #                id=Hoplite2
                                                    #            [/have_unit]
                                                    #            [then]
                                                    #                {HOPLITE_PLAYERFILTER (
                                                    #                    {VARIABLE hoplite_enthrall_cooldown1 3}
                                                    #                ) (
                                                    #                    {VARIABLE hoplite_enthrall_cooldown2 3}
                                                    #                )}
                                                    #            [/then]
                                                    #            [else]
                                                    #                {VARIABLE hoplite_enthrall_cooldown 3}
                                                    #            [/else]
                                                    #        [/if]

                                                    #for stuff like enthrall dialog

                                                    [fire_event]
                                                        name=spartan_enthrall
                                                        [primary_unit]
                                                            x,y=$x1,$y1
                                                        [/primary_unit]
                                                        [secondary_unit]
                                                            id=Hoplite,Hoplite2
                                                            side=$side_number
                                                        [/secondary_unit]
                                                    [/fire_event]

                                                    [if]
                                                        [have_unit]
                                                            x,y=$x1,$y1
                                                            level=3
                                                        [/have_unit]
                                                        [then]
                                                            {ACHIEVEMENT_MESSAGE_LONE enthrall_master $side_number}
                                                        [/then]
                                                    [/if]

                                                    [if]
                                                        [have_unit]
                                                            x,y=$x1,$y1
                                                            ability=hoplite_patron_unit
                                                        [/have_unit]
                                                        [then]
                                                            {ACHIEVEMENT_MESSAGE_LONE enthrall_patron $side_number}
                                                        [/then]
                                                    [/if]

                                                    {ALGADUR_LINE enthrall (
                                                        [message]
                                                            speaker=Algadur
                                                            message=_"That feels all kinds of wrong, lad... But what wouldn't I give to make those filthy orcs slaughter each other!"
                                                        [/message]
                                                    )}
                                                    {ELIZABETH_MAGIC_LINE enthrall (
                                                        [message]
                                                            speaker=Elizabeth
                                                            message=_"I'm not about to say you shouldn't use that, but keep this kind of magic far away from me."
                                                        [/message]
                                                        [message]
                                                            side=$side_number
                                                            canrecruit=yes
                                                            message=_"<b><i>WHAT!?</i></b> By Athena, what sort of ideas are coursing through your mind, woman!? A true warrior of Sparta is a man of honor!"
                                                        [/message]
                                                        [message]
                                                            speaker=Elizabeth
                                                            message=_"Good to hear that."
                                                        [/message]
                                                    )}
                                                    [end_turn]
                                                    [/end_turn]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Not enough energy!"
                                                        size=22
                                                        red=255
                                                        duration=100
                                                    [/print]
                                                [/else]
                                            [/if]
                                            #   [/else]
                                            #   [/if]
                                            {CLEAR_VARIABLE enthrallenemy}
                                            {CLEAR_VARIABLE enthrallenergy}
                                        [/command]
                                    [/set_menu_item]
                                    [set_menu_item]
                                        id=hoplite_loyal_thrall
                                        description=_"Turn this thrall into a loyal thrall (if you are below thrall limit)"
                                        [show_if]
                                            [have_unit]
                                                side=$hoplite_allyside
                                                ability=hoplite_thrall
                                                x,y=$x1,$y1
                                                [not]
                                                    ability=hoplite_loyalthrall$side_number
                                                [/not]
                                            [/have_unit]
                                            [and]
                                                [variable]
                                                    name=enthrall_loyal_unlocked$side_number
                                                    equals=yes
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [store_unit]
                                                [filter]
                                                    ability=hoplite_loyalthrall$side_number
                                                [/filter]
                                                variable=tmp_current_thralls
                                                kill=no
                                            [/store_unit]

                                            [if]
                                                {VARIABLE_CONDITIONAL tmp_current_thralls.length greater_than_equal_to $hoplite_thrall_limit$side_number}
                                                [then]
                                                    [print]
                                                        text= _ "Can't go above the loyal thrall limit!"
                                                        size=22
                                                        red=255
                                                        duration=1500
                                                    [/print]
                                                [/then]
                                                [else]
                                                    [object]
                                                        silent=yes
                                                        duration=forever
                                                        [filter]
                                                            x,y=$x1,$y1
                                                        [/filter]
                                                        [effect]
                                                            apply_to=new_ability
                                                            [abilities]
                                                                [dummy]
                                                                    id=hoplite_loyalthrall$side_number
                                                                [/dummy]
                                                                [dummy]
                                                                    id=hoplite_loyalthrall_filter
                                                                [/dummy]
                                                            [/abilities]
                                                        [/effect]
                                                    [/object]

                                                    [modify_unit]
                                                        [filter]
                                                            x,y=$x1,$y1
                                                        [/filter]
                                                        {TRAIT_LOYAL}
                                                    [/modify_unit]
                                                [/else]
                                            [/if]
                                            {CLEAR_VARIABLE tmp_current_thralls}
                                        [/command]
                                    [/set_menu_item]

                                    [set_menu_item]
                                        id=hoplite_loyal_thrall_remove
                                        description=_"Remove loyal trait from this thrall (so you can make a different thrall loyal)"
                                        [show_if]
                                            [have_unit]
                                                side=$hoplite_allyside
                                                ability=hoplite_thrall
                                                x,y=$x1,$y1
                                                [and]
                                                    ability=hoplite_loyalthrall$side_number
                                                [/and]
                                            [/have_unit]
                                        [/show_if]
                                        [command]
                                            [remove_trait]
                                                x,y=$x1,$y1
                                                trait_id=loyal
                                            [/remove_trait]

                                            [object]
                                                silent=yes
                                                duration=forever
                                                [filter]
                                                    x,y=$x1,$y1
                                                [/filter]
                                                [effect]
                                                    apply_to=remove_ability
                                                    [abilities]
                                                        [dummy]
                                                            id=hoplite_loyalthrall$side_number
                                                        [/dummy]
                                                        [dummy]
                                                            id=hoplite_loyalthrall_filter
                                                        [/dummy]
                                                    [/abilities]
                                                [/effect]
                                            [/object]
                                        [/command]
                                    [/set_menu_item]

                                    [set_menu_item]
                                        id=hoplite_bow
                                        description=_"Aim your bow in this direction (will shoot next turn)"
                                        image="misc/icon_bow.png"
                                        [show_if]
                                            [have_location]
                                                [filter_adjacent_location]
                                                    [filter]
                                                        id=Hoplite,Hoplite2
                                                        side=$side_number
                                                        formula="attacks_left > 0"#to prevent the bow being usable while having the Persuasive Pacifist pact
                                                    [/filter]
                                                [/filter_adjacent_location]
                                                x,y=$x1,$y1
                                            [/have_location]
                                            [and]
                                                [variable]
                                                    name=bow_unlocked$side_number
                                                    equals=yes
                                                [/variable]
                                                [and]
                                                    #                [variable]
                                                    #                    name=bowIV_unlocked$side_number
                                                    #                    not_equals=yes
                                                    #                [/variable]
                                                    {VARIABLE_CONDITIONAL spartan_bow_mode$side_number not_equals quickdraw}
                                                [/and]
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [animate_unit]
                                                flag=standing
                                                [facing]
                                                    x,y=$x1,$y1
                                                [/facing]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                            [/animate_unit]
                                            [store_unit]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                                variable=hoplitebow
                                                kill=no
                                            [/store_unit]

                                            {SPARTAN_GETDIR_REVERSED $hoplitebow.x $hoplitebow.y $x1 $y1 tmp_ranged_dir}

                                            {STORE_TARGETHEX_LOC hoplitebow $hoplite_bow_range$hoplitebow.side $hoplite_bow_blindspot$hoplitebow.side}

                                            {SPARTAN_PLACE_TARGETHEXES ranged_targetlocs$tmp_ranged_dir hoplitebow "misc/targethex-archer.png" ()}

                                            {IF_VAR ranged_targetlocs$tmp_ranged_dir|.length greater_than 0 (
                                                [then]
                                                    [sound]
                                                        name=magic-dark-big-miss.ogg
                                                    [/sound]
                                                    {VARIABLE hoplite_bow_aiming$side_number yes}
                                                    [end_turn]
                                                    [/end_turn]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Can't aim in this direction!"
                                                        size=22
                                                        red=255
                                                        duration=1500
                                                    [/print]
                                                [/else]
                                            )}

                                            {CLEAR_VARIABLE hoplitebow}
                                            {HOPLITE_CLEAR_TMP_TARGETHEXES}
                                            {CLEAR_VARIABLE tmp_ranged_dir}
                                        [/command]
                                    [/set_menu_item]

                                    [set_menu_item]
                                        id=hoplite_bow2
                                        description=_"Shoot your bow in this direction"
                                        image="misc/icon_bow.png"
                                        [show_if]
                                            [have_location]
                                                [filter_adjacent_location]
                                                    [filter]
                                                        id=Hoplite,Hoplite2
                                                        side=$side_number
                                                        formula="attacks_left > 0"#to prevent the bow being usable while having the Persuasive Pacifist pact
                                                    [/filter]
                                                [/filter_adjacent_location]
                                                x,y=$x1,$y1
                                            [/have_location]
                                            [and]
                                                #                [variable]
                                                #                    name=bowIV_unlocked$side_number
                                                #                    equals=yes
                                                #                [/variable]
                                                {VARIABLE_CONDITIONAL spartan_bow_mode$side_number equals quickdraw}
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [animate_unit]
                                                flag=standing
                                                [facing]
                                                    x,y=$x1,$y1
                                                [/facing]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                            [/animate_unit]
                                            [store_unit]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                                variable=hoplitebow
                                                kill=no
                                            [/store_unit]

                                            {SPARTAN_GETDIR_REVERSED $hoplitebow.x $hoplitebow.y $x1 $y1 tmp_bow_dir}

                                            {STORE_TARGETHEX_LOC hoplitebow $hoplite_bow_range$hoplitebow.side $hoplite_bow_blindspot$hoplitebow.side}

                                            [foreach]
                                                array=ranged_targetlocs$tmp_bow_dir
                                                variable=this_item2
                                                index_var=e
                                                [do]
                                                    [set_variables]
                                                        name=tmp_item_tag_container
                                                        [value]
                                                            x=$this_item2.x
                                                            y=$this_item2.y
                                                            image="misc/targethex-archer.png"
                                                            name=hoplite_targethex$hoplitebow.id
                                                        [/value]
                                                    [/set_variables]

                                                    #am using [insert_tag] instead of just item, otherwise the game doesn't substitute the id variable for some reason

                                                    [insert_tag]
                                                        name=item
                                                        variable=tmp_item_tag_container
                                                    [/insert_tag]

                                                    {CLEAR_VARIABLE tmp_item_tag_container}

                                                    [set_variables]
                                                        name=hoplite_targethexes
                                                        mode=append
                                                        [value]
                                                            unit_id=$hoplitebow.id
                                                            x=$this_item2.x
                                                            y=$this_item2.y
                                                            name=hoplite_targethex$hoplitebow.id
                                                        [/value]
                                                    [/set_variables]
                                                [/do]
                                            [/foreach]

                                            {IF_VAR ranged_targetlocs$tmp_bow_dir|.length greater_than 0 (
                                                [then]
                                                    [sound]
                                                        name=magic-dark-big-miss.ogg
                                                    [/sound]
                                                    {VARIABLE hoplite_bow_aiming$side_number yes}
                                                    [delay]
                                                        time=500
                                                    [/delay]
                                                    [fire_event]
                                                        id=hoplite_bow_shoot
                                                    [/fire_event]
                                                    [end_turn]
                                                    [/end_turn]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Can't shoot in this direction!"
                                                        size=22
                                                        red=255
                                                        duration=1500
                                                    [/print]
                                                [/else]
                                            )}

                                            {CLEAR_VARIABLE hoplitebow}
                                            {HOPLITE_CLEAR_TMP_TARGETHEXES}
                                            {CLEAR_VARIABLE tmp_bow_dir}
                                        [/command]
                                    [/set_menu_item]

                                    [set_menu_item]
                                        id=hoplite_recall_spear
                                        #        description=_"Recall your spear, costs <span color='#2c9fed'>50</span> energy (ends turn)"
                                        description=_"Recall your spear (ends turn)"
                                        image="misc/icon_spear.png"
                                        [show_if]
                                            [variable]
                                                name=spear_recall_unlocked$side_number
                                                equals=yes
                                            [/variable]
                                            [and]
                                                [have_unit]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                    x,y=$x1,$y1
                                                    variation=spearless
                                                [/have_unit]
                                                [or]
                                                    [have_location]
                                                        x,y=$x1,$y1
                                                        find_in=hoplite_spearloc$side_number
                                                    [/have_location]
                                                [/or]
                                            [/and]
                                        [/show_if]
                                        [command]
                                            #recall is now free
                                            #            [if]
                                            ##ifdef MULTIPLAYER
                                            #                [have_unit]
                                            #                    id=Hoplite
                                            #                    side=$side_number
                                            #                [/have_unit]
                                            #                [and]
                                            #                    [variable]
                                            #                        name=hoplite_energy1
                                            #                        greater_than_equal_to=50
                                            #                    [/variable]
                                            #                [/and]
                                            #                [or]
                                            #                    [have_unit]
                                            #                        id=Hoplite2
                                            #                        side=$side_number
                                            #                    [/have_unit]
                                            #                    [and]
                                            #                        [variable]
                                            #                            name=hoplite_energy2
                                            #                            greater_than_equal_to=50
                                            #                        [/variable]
                                            #                    [/and]
                                            #                [/or]
                                            ##endif
                                            ##ifndef MULTIPLAYER
                                            #                    [variable]
                                            #                        name=hoplite_energy
                                            #                        greater_than_equal_to=50
                                            #                    [/variable]
                                            ##endif
                                            #        [then]
                                            ##ifdef MULTIPLAYER
                                            #                    [if]
                                            #                        [have_unit]
                                            #                            id=Hoplite
                                            #                            side=$side_number
                                            #                        [/have_unit]
                                            #                        [then]
                                            #                            {VARIABLE_OP hoplite_energy1 sub 50}
                                            #                            {SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
                                            #                        [/then]
                                            #                        [else]
                                            #                            {VARIABLE_OP hoplite_energy2 sub 50}
                                            #                            {SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
                                            #                        [/else]
                                            #                    [/if]
                                            ##endif
                                            ##ifndef MULTIPLAYER
                                            #        {VARIABLE_OP hoplite_energy sub 50}
                                            #        {SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
                                            ##endif

                                            [sound]
                                                name=magic-faeriefire.ogg
                                            [/sound]

                                            {SPARTAN_CHANGE_VARIATION_PRESERVING_HP_EXACT (
                                                side=$side_number
                                                canrecruit=yes
                                            ) none}

                                            [remove_item]
                                                image=hoplite_spear$side_number
                                                x=0-99
                                                y=0-99
                                            [/remove_item]

                                            {VARIABLE hoplite_spear_on_ground$side_number no}
                                            {CLEAR_VARIABLE hoplite_spearloc$side_number}
                                            [end_turn]
                                            [/end_turn]
                                            #        [/then]
                                            #        [else]
                                            #            [print]
                                            #               text= _ "Not enough energy!"
                                            #               size=22
                                            #               red=255
                                            #           duration=100
                                            #            [/print]
                                            #        [/else]
                                            #        [/if]
                                        [/command]
                                    [/set_menu_item]
                                    [set_menu_item]
                                        id=hoplite_follow_spear
                                        description=_"Follow your spear, costs <span color='#2c9fed'>50</span> energy (ends turn)"
                                        image="misc/icon_spear.png"
                                        [show_if]
                                            [have_unit]
                                                id=Hoplite,Hoplite2
                                                side=$side_number
                                                x,y=$x1,$y1
                                                variation=spearless
                                            [/have_unit]
                                            [or]
                                                [have_location]
                                                    x,y=$x1,$y1
                                                    find_in=hoplite_spearloc$side_number
                                                [/have_location]
                                            [/or]
                                            [and]
                                                [variable]
                                                    name=spear_follow_unlocked$side_number
                                                    equals=yes
                                                [/variable]
                                            [/and]
                                            [and]
                                                [have_location]
                                                    [not]
                                                        [filter]
                                                        [/filter]
                                                    [/not]
                                                    find_in=hoplite_spearloc$side_number
                                                [/have_location]
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [if]
                                                [variable]
                                                    name=hoplite_energy$side_number
                                                    greater_than_equal_to=50
                                                [/variable]
                                                [then]
                                                    {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -50}

                                                    [object]
                                                        silent=yes
                                                        duration=turn end
                                                        [filter]
                                                            side=$side_number
                                                            canrecruit=yes
                                                        [/filter]
                                                        [effect]
                                                            apply_to=new_animation
                                                            {HOPLITE_TELEPORTANIM}
                                                        [/effect]
                                                    [/object]

                                                    [sound]
                                                        name=magic-faeriefire.ogg
                                                    [/sound]
                                                    [store_locations]
                                                        find_in=hoplite_spearloc$side_number
                                                        variable=tmp_follow_loc
                                                    [/store_locations]
                                                    [animate_unit]
                                                        flag=pre_teleport
                                                        [filter]
                                                            side=$side_number
                                                            canrecruit=yes
                                                        [/filter]
                                                    [/animate_unit]
                                                    [hide_unit]
                                                        side=$side_number
                                                        canrecruit=yes
                                                    [/hide_unit]
                                                    {TELEPORT_UNIT side,canrecruit=$side_number,yes $tmp_follow_loc.x $tmp_follow_loc.y}
                                                    {CLEAR_VARIABLE tmp_follow_loc}
                                                    [unhide_unit]
                                                        side=$side_number
                                                        canrecruit=yes
                                                    [/unhide_unit]
                                                    [animate_unit]
                                                        flag=post_teleport
                                                        [filter]
                                                            side=$side_number
                                                            canrecruit=yes
                                                        [/filter]
                                                    [/animate_unit]
                                                    {SPARTAN_CHANGE_VARIATION_PRESERVING_HP_EXACT (
                                                        side=$side_number
                                                        canrecruit=yes
                                                    ) none}

                                                    [remove_item]
                                                        image=hoplite_spear$side_number
                                                        x=0-99
                                                        y=0-99
                                                    [/remove_item]

                                                    {VARIABLE hoplite_spear_on_ground$side_number no}
                                                    {CLEAR_VARIABLE hoplite_spearloc$side_number}
                                                    [end_turn]
                                                    [/end_turn]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Not enough energy!"
                                                        size=22
                                                        red=255
                                                        duration=100
                                                    [/print]
                                                [/else]
                                            [/if]
                                        [/command]
                                    [/set_menu_item]
                                [/event]
                                [event]
                                    name=turn refresh
                                    id=hoplite_bow_shoot
                                    first_time_only=no
                                    [filter_condition]
                                        {VARIABLE_CONDITIONAL hoplite_bow_aiming$side_number equals yes}
                                    [/filter_condition]
                                    {CHATMSG "player bow shoot event"}

                                    [store_unit]
                                        [filter]
                                            id=Hoplite,Hoplite2
                                            side=$side_number
                                        [/filter]
                                        variable=hoplitebow
                                        kill=no
                                    [/store_unit]

                                    {STORE_TARGETHEXES_OF_ID $hoplitebow.id hoplite_bow_targethexes}

                                    {HOPLITE_CLEAR_TARGETHEXES_BY_ID $hoplitebow.id}

                                    [foreach]
                                        array=hoplite_bow_targethexes
                                        variable=this_targethex
                                        index_var=e
                                        [do]
                                            #            [chat]
                                            #                message=$this_targethex.x,$this_targethex.y
                                            #            [/chat]
                                            [if]
                                                [have_unit]
                                                    x,y=$this_targethex.x,$this_targethex.y
                                                    [filter_side]
                                                        [enemy_of]
                                                            side=$hoplitebow.side
                                                        [/enemy_of]
                                                    [/filter_side]
                                                    [not]
                                                        ability_type_active=hides
                                                    [/not]
                                                [/have_unit]
                                                [and]
                                                    {VARIABLE_CONDITIONAL tmp_rangedtarget_found not_equals yes}
                                                [/and]
                                                [or]
                                                    [have_unit]
                                                        x,y=$this_targethex.x,$this_targethex.y
                                                        [filter_side]
                                                            [enemy_of]
                                                                side=$hoplitebow.side
                                                            [/enemy_of]
                                                        [/filter_side]
                                                        ability_type_active=hides
                                                    [/have_unit]
                                                    [and]
                                                        {VARIABLE_CONDITIONAL tmp_rangedtarget_found not_equals yes}
                                                    [/and]
                                                    [and]
                                                        [variable]
                                                            name=bow_eagle_eye_unlocked$side_number
                                                            equals=yes
                                                        [/variable]
                                                    [/and]
                                                [/or]
                                                [then]
                                                    {VARIABLE tmp_rangedtarget_found yes}
                                                    [store_unit]
                                                        [filter]
                                                            x,y=$this_targethex.x,$this_targethex.y
                                                        [/filter]
                                                        variable=hoplitebow_target
                                                    [/store_unit]
                                                [/then]
                                            [/if]
                                        [/do]
                                    [/foreach]
                                    {CLEAR_VARIABLE tmp_rangedtarget_found}

                                    [if]
                                        [have_unit]
                                            id=$hoplitebow_target.id
                                        [/have_unit]
                                        [then]
                                            {SPARTAN_RETURN_ATTACK_INDEX_BY_NAME hoplitebow bow}

                                            {VARIABLE tmp_targetloc.x $hoplitebow_target.x}
                                            {VARIABLE tmp_targetloc.y $hoplitebow_target.y}
                                            [fire_event]
                                                name=attack#to trigger teleportaway event
                                                [primary_unit]
                                                    id=$hoplitebow.id
                                                [/primary_unit]
                                                [secondary_unit]
                                                    id=$hoplitebow_target.id
                                                [/secondary_unit]
                                                [primary_attack]
                                                    name=$hoplitebow.attack[$tmp_index_return].name
                                                    damage=$hoplitebow.attack[$tmp_index_return].damage
                                                    type=$hoplitebow.attack[$tmp_index_return].type
                                                [/primary_attack]
                                            [/fire_event]
                                            [if]
                                                [have_unit]
                                                    id=$hoplitebow_target.id
                                                    x,y=$tmp_targetloc.x,$tmp_targetloc.y#only attack the target if the target hasn't teleported before being attacked
                                                    [not]
                                                        ability_type_active=hides
                                                    [/not]
                                                [/have_unit]
                                                [or]
                                                    [have_unit]
                                                        id=$hoplitebow_target.id
                                                        x,y=$tmp_targetloc.x,$tmp_targetloc.y#only attack the target if the target hasn't teleported before being attacked
                                                    [/have_unit]
                                                    [and]
                                                        [variable]
                                                            name=bow_eagle_eye_unlocked$side_number
                                                            equals=yes
                                                        [/variable]
                                                    [/and]
                                                [/or]
                                                [then]
                                                    {SPARTAN_CALCULATE_DAMAGE hoplitebow $hoplitebow.attack[$tmp_index_return].damage}
                                                    [spartan_harm_unit]
                                                        [filter]
                                                            id=$hoplitebow_target.id
                                                        [/filter]
                                                        [filter_second]
                                                            id=$hoplitebow.id
                                                        [/filter_second]
                                                        [primary_attack]
                                                            name=$hoplitebow.attack[$tmp_index_return].name
                                                        [/primary_attack]
                                                        amount=$tmp_spartan_calculated_damage
                                                        damage_type=$hoplitebow.attack[$tmp_index_return].type
                                                        alignment=$hoplitebow.alignment
                                                        fire_event=yes
                                                        animate=yes
                                                        delay=0
                                                        experience=no
                                                    [/spartan_harm_unit]
                                                    {CLEAR_VARIABLE tmp_spartan_calculated_damage}

                                                    [if]
                                                        [variable]
                                                            name=bow_burn_unlocked$side_number
                                                            equals=yes
                                                        [/variable]
                                                        [then]
                                                            {SPARTAN_APPLY_BURN $hoplite_bow_burn$side_number (id=$hoplitebow_target.id) $hoplitebow.id}
                                                        [/then]
                                                    [/if]

                                                    [if]
                                                        [variable]
                                                            name=bow_knockback_unlocked$side_number
                                                            equals=yes
                                                        [/variable]
                                                        [then]
                                                            #source and destination is intentionally reversed
                                                            [store_relative_direction]
                                                                [source]
                                                                    x,y=$hoplitebow_target.x,$hoplitebow_target.y
                                                                [/source]
                                                                [destination]
                                                                    x,y=$hoplitebow.x,$hoplitebow.y
                                                                [/destination]
                                                                variable=hoplitebow_aimdir
                                                            [/store_relative_direction]
                                                            {HOPLITE_KNOCKBACK_CODE_REPEATED $hoplite_bow_knockback_distance$side_number hoplitebow_target hoplitebow $hoplitebow_aimdir}
                                                            {CLEAR_VARIABLE hoplitebow_aimdir}
                                                        [/then]
                                                    [/if]
                                                [/then]
                                            [/if]
                                            {ALGADUR_LINE bow (
                                                [message]
                                                    speaker=Algadur
                                                    message=_"Eh, bows aren't really me thing, but the knife-ears' arrows hurt a lot, so I can't really knock yer tastes."
                                                [/message]
                                            )}
                                            {CLEAR_VARIABLE tmp_targetloc}
                                            {CLEAR_VARIABLE tmp_index_return}
                                        [/then]
                                    [/if]

                                    {CLEAR_VARIABLE hoplitebow}
                                    {CLEAR_VARIABLE hoplitebow_target}
                                    {CLEAR_VARIABLE hoplite_bow_targethexes}
                                    {CLEAR_VARIABLE hoplite_bow_aiming$side_number}
                                [/event]
                                [event]
                                    name=start
                                    [set_menu_item]
                                        id=hoplite_healpotion
                                        description=_"Drink a healing potion to restore some hitpoints."
                                        image="misc/icon_healpotion.png"
                                        [show_if]
                                            [have_unit]
                                                id=Hoplite,Hoplite2
                                                side=$side_number
                                                x,y=$x1,$y1
                                                [not]
                                                    [filter_wml]
                                                        [status]
                                                            unhealable=yes
                                                        [/status]
                                                    [/filter_wml]
                                                [/not]
                                            [/have_unit]
                                            [and]
                                                {VARIABLE_CONDITIONAL healpotionI_unlocked$side_number equals yes}
                                                [and]
                                                    #                    {VARIABLE_CONDITIONAL hoplite_healpotion_cooldown$side_number less_than 1}
                                                    {VARIABLE_CONDITIONAL healpotions_in_inventory$side_number greater_than 0}
                                                [/and]
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [store_unit]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                                variable=hoplite_healpotion
                                                kill=no
                                            [/store_unit]
                                            [fire_event]
                                                id=spartan_healingpotion_event
                                            [/fire_event]
                                        [/command]
                                    [/set_menu_item]
                                    [set_menu_item]
                                        id=hoplite_healpotion_on_ally
                                        description=_"Heal this ally with your healing potion"
                                        image="misc/icon_healpotion.png"
                                        [show_if]
                                            [have_unit]
                                                x,y=$x1,$y1
                                                [filter_adjacent]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter_adjacent]
                                                [filter_side]
                                                    [allied_with]
                                                        side=$side_number
                                                    [/allied_with]
                                                [/filter_side]
                                                [not]
                                                    [filter_wml]
                                                        [status]
                                                            unhealable=yes
                                                        [/status]
                                                    [/filter_wml]
                                                [/not]
                                            [/have_unit]
                                            [and]
                                                {VARIABLE_CONDITIONAL healpotionI_unlocked$side_number equals yes}
                                                [and]
                                                    #                    {VARIABLE_CONDITIONAL hoplite_healpotion_cooldown$side_number less_than 1}
                                                    {VARIABLE_CONDITIONAL healpotions_in_inventory$side_number greater_than 0}
                                                [/and]
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [store_unit]
                                                [filter]
                                                    x,y=$x1,$y1
                                                [/filter]
                                                variable=hoplite_healpotion
                                                kill=no
                                            [/store_unit]
                                            [fire_event]
                                                id=spartan_healingpotion_event
                                            [/fire_event]
                                        [/command]
                                    [/set_menu_item]
                                    [set_menu_item]
                                        id=hoplite_teleportaway
                                        description=_"Toggle the 'Teleport Away' upgrade (if you want to save energy)."
                                        [show_if]
                                            [have_unit]
                                                id=Hoplite,Hoplite2
                                                side=$side_number
                                                x,y=$x1,$y1
                                            [/have_unit]
                                            [and]
                                                {VARIABLE_CONDITIONAL teleportaway_unlocked$side_number equals yes}
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [if]
                                                [have_unit]
                                                    id=Hoplite2
                                                [/have_unit]
                                                [then]
                                                    {HOPLITE_PLAYERFILTER (
                                                        {IF_VAR teleportaway_enabled1 not_equals yes (
                                                            [then]
                                                                {VARIABLE teleportaway_enabled1 yes}
                                                            [/then]
                                                            [else]
                                                                {VARIABLE teleportaway_enabled1 no}
                                                            [/else]
                                                        )}
                                                        [print]
                                                            text= _ "Teleport Away set to <b>$teleportaway_enabled1|</b> for side 1"
                                                            size=20
                                                            blue=255
                                                            duration=3000
                                                        [/print]
                                                    ) (
                                                        {IF_VAR teleportaway_enabled2 not_equals yes (
                                                            [then]
                                                                {VARIABLE teleportaway_enabled2 yes}
                                                            [/then]
                                                            [else]
                                                                {VARIABLE teleportaway_enabled2 no}
                                                            [/else]
                                                        )}
                                                        [print]
                                                            text= _ "Teleport Away set to <b>$teleportaway_enabled2|</b> for side 2"
                                                            size=20
                                                            blue=255
                                                            duration=3000
                                                        [/print]
                                                    )}
                                                [/then]
                                                [else]
                                                    {IF_VAR teleportaway_enabled1 not_equals yes (
                                                        [then]
                                                            {VARIABLE teleportaway_enabled1 yes}
                                                        [/then]
                                                        [else]
                                                            {VARIABLE teleportaway_enabled1 no}
                                                        [/else]
                                                    )}
                                                    [print]
                                                        text= _ "Teleport Away set to <b>$teleportaway_enabled1|</b>"
                                                        size=20
                                                        blue=255
                                                        duration=3000
                                                    [/print]
                                                [/else]
                                            [/if]
                                        [/command]
                                    [/set_menu_item]
                                    [set_menu_item]
                                        id=hoplite_footwork
                                        description=_"Toggle the 'Footwork' upgrade"
                                        image="attacks/foot-boot.png~SCALE(20,20)"
                                        [show_if]
                                            [have_unit]
                                                id=Hoplite,Hoplite2
                                                side=$side_number
                                                x,y=$x1,$y1
                                            [/have_unit]
                                            [and]
                                                {VARIABLE_CONDITIONAL footwork_unlocked$side_number equals yes}
                                            [/and]
                                        [/show_if]
                                        [command]
                                            {IF_VAR hoplite_footwork_enabled$side_number not_equals yes (
                                                [then]
                                                    {VARIABLE hoplite_footwork_enabled$side_number yes}
                                                [/then]
                                                [else]
                                                    {VARIABLE hoplite_footwork_enabled$side_number no}
                                                [/else]
                                            )}
                                            [print]
                                                text= _ "Footwork set to <b>$hoplite_footwork_enabled$side_number||</b> for side $side_number|"
                                                size=20
                                                blue=255
                                                duration=3000
                                            [/print]
                                        [/command]
                                    [/set_menu_item]
                                    [set_menu_item]
                                        id=hoplite_deploy_shield
                                        description=_"Deploy Shield on this tile."
                                        image="misc/icon_deployshield.png"
                                        [show_if]
                                            [have_location]
                                                [filter_adjacent_location]
                                                    [filter]
                                                        id=Hoplite,Hoplite2
                                                        side=$side_number
                                                    [/filter]
                                                [/filter_adjacent_location]
                                                [not]
                                                    [filter]
                                                    [/filter]
                                                    [or]
                                                        #TODO: make shield also not deployable on chasms
                                                        terrain={SPARTAN_WALL_TERRAIN}
                                                    [/or]
                                                [/not]
                                                x,y=$x1,$y1
                                            [/have_location]
                                            [and]
                                                [variable]
                                                    name=deployshield_unlocked$side_number
                                                    equals=yes
                                                [/variable]
                                                [and]
                                                    [variable]
                                                        name=hoplite_deployshield_cooldown$side_number
                                                        less_than=1
                                                    [/variable]
                                                [/and]
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [animate_unit]
                                                flag=standing
                                                [facing]
                                                    x,y=$x1,$y1
                                                [/facing]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                            [/animate_unit]
                                            [store_unit]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                                variable=hoplitedeployer
                                                kill=no
                                            [/store_unit]
                                            [unit]
                                                side=$hoplite_allyside
                                                type=Hoplite_Deployed_Shield
                                                x,y=$x1,$y1
                                                animate=yes
                                                placement=map
                                                passable=yes
                                                facing=$hoplitedeployer.facing
                                                [modifications]
                                                    [object]
                                                        silent=yes
                                                        [effect]
                                                            apply_to=new_ability
                                                            [abilities]
                                                                [dummy]
                                                                    id=spartan_ally_owner_side$side_number
                                                                [/dummy]
                                                                [dummy]
                                                                    id=spartan_deployshield_loc_filter
                                                                [/dummy]
                                                            [/abilities]
                                                        [/effect]
                                                    [/object]
                                                [/modifications]
                                            [/unit]
                                            {VARIABLE hoplite_deployshield_cooldown$side_number $hoplite_deployshield_max_cooldown$side_number}

                                            [if]
                                                [variable]
                                                    name=deployshieldII_unlocked$side_number
                                                    equals=yes
                                                [/variable]
                                                [then]
                                                    [object]
                                                        silent=yes
                                                        duration=forever
                                                        [filter]
                                                            ability=spartan_ally_owner_side$side_number
                                                            [and]
                                                                ability=spartan_deployshield_loc_filter
                                                            [/and]
                                                        [/filter]
                                                        [effect]
                                                            apply_to=hitpoints
                                                            increase=$deployshield_hpbonus$side_number
                                                            increase_total=$deployshield_hpbonus$side_number
                                                        [/effect]
                                                        [effect]
                                                            apply_to=new_ability
                                                            [abilities]
                                                                [resistance]
                                                                    id=deployshield_protect
                                                                    add=$deployshield_resistance$side_number
                                                                    max_value=$deployshield_resistance_cap$side_number
                                                                    # applies to any type if we leave it out
                                                                    #apply_to=blade,pierce,impact,fire,cold,arcane
                                                                    [filter_base_value]
                                                                        #                                    greater_than=0
                                                                        less_than=$deployshield_resistance_cap$side_number
                                                                    [/filter_base_value]
                                                                    affect_self=no
                                                                    affect_allies=yes
                                                                    [affect_adjacent]
                                                                        adjacent=n,ne,se,s,sw,nw
                                                                    [/affect_adjacent]
                                                                [/resistance]
                                                            [/abilities]
                                                        [/effect]
                                                    [/object]
                                                [/then]
                                            [/if]
                                            {CLEAR_VARIABLE hoplitedeployer}
                                        [/command]
                                    [/set_menu_item]
                                [/event]
                                [event]
                                    name=last breath
                                    id=spartan_phoenixamulet_event
                                    first_time_only=no

                                    [filter]
                                        id=Hoplite,Hoplite2
                                        [not]
                                            [filter_wml]
                                                [status]
                                                    unhealable=yes
                                                [/status]
                                            [/filter_wml]
                                        [/not]
                                    [/filter]

                                    {IF_VAR phoenixamulet_unlocked$unit.side equals yes (
                                        [and]
                                            {VARIABLE_CONDITIONAL hoplite_revive_cooldown$unit.side less_than 1}
                                        [/and]
                                        [then]
                                            [sound]
                                                name={SOUND_LIST:HOLY}
                                            [/sound]
                                            [store_unit]
                                                [filter]
                                                    x,y=$x1,$y1
                                                [/filter]
                                                variable=hoplite_reborn
                                                kill=no
                                            [/store_unit]
                                            {VARIABLE hoplite_reborn.hitpoints 0}
                                            [unstore_unit]
                                                variable=hoplite_reborn
                                                find_vacant=no
                                            [/unstore_unit]
                                            {CLEAR_VARIABLE hoplite_reborn}
                                            {FLASH_WHITE (
                                                {IF_VAR phoenixamuletII_unlocked$unit.side equals yes (
                                                    [then]
                                                        #                        [heal_unit]
                                                        #                            [filter]
                                                        #                                x,y=$x1,$y1
                                                        #                            [/filter]
                                                        #                            amount=$healpotion_restore$unit.side
                                                        #                            animate=yes
                                                        #                            restore_statuses=no
                                                        #                        [/heal_unit]
                                                        #                        [modify_unit]
                                                        #                            [filter]
                                                        #                                x,y=$x1,$y1
                                                        #                            [/filter]
                                                        #                            [status]
                                                        #                                poisoned=no
                                                        #                            [/status]
                                                        #                        [/modify_unit]
                                                        #                        {HOPLITE_ADD_ENERGY_BY_SIDE $unit.side 75}

                                                        #now phoenix amulet II just copies healing potion instead of giving flat 75 energy

                                                        [store_unit]
                                                            [filter]
                                                                x,y=$x1,$y1
                                                            [/filter]
                                                            variable=hoplite_healpotion
                                                            kill=no
                                                        [/store_unit]
                                                        {VARIABLE tmp_spartan_healpotion_side $unit.side}
                                                        [fire_event]
                                                            id=spartan_healingpotion_event
                                                        [/fire_event]
                                                    [/then]
                                                    [else]
                                                        [heal_unit]
                                                            [filter]
                                                                x,y=$x1,$y1
                                                            [/filter]
                                                            amount=10
                                                            animate=yes
                                                            restore_statuses=yes
                                                        [/heal_unit]
                                                    [/else]
                                                )}
                                                #   [delay]
                                                #     time=500
                                                #   [/delay]
                                                [sound]
                                                    name=fire.wav
                                                [/sound]
                                                [spartan_harm_unit]
                                                    [filter]
                                                        side=$hoplite_enemyside
                                                        [filter_adjacent]
                                                            x,y=$x1,$y1
                                                        [/filter_adjacent]
                                                        [not]
                                                            ability=spartan_bombfilter#otherwise dying to a bomb causes an infinite loop
                                                        [/not]
                                                    [/filter]
                                                    [filter_second]
                                                        x,y=$x1,$y1
                                                    [/filter_second]
                                                    amount=10
                                                    damage_type=fire
                                                    alignment=$unit.alignment
                                                    fire_event=yes
                                                    animate=no
                                                    delay=0
                                                    experience=no
                                                [/spartan_harm_unit]
                                                [store_unit]
                                                    [filter]
                                                        side=$hoplite_enemyside
                                                    [/filter]
                                                    kill=no
                                                    variable=slowed
                                                [/store_unit]

                                                [foreach]
                                                    array=slowed
                                                    index_var=a
                                                    [do]
                                                        {VARIABLE this_item.status.slowed yes}
                                                        [unstore_unit]
                                                            variable=this_item
                                                        [/unstore_unit]
                                                    [/do]
                                                [/foreach]
                                            )}
                                            {VARIABLE hoplite_revive_cooldown$unit.side $hoplite_phoenix_recharge$unit.side}
                                            {VARIABLE_OP revive_progress$unit.side add 1}
                                            {IF_VAR revive_progress$unit.side equals 5 (
                                                [then]
                                                    {ACHIEVEMENT_MESSAGE_LONE revive $unit.side}
                                                [/then]
                                            )}
                                            {CLEAR_VARIABLE hoplite_reborn}
                                            {ALGADUR_LINE phoenix_amulet (
                                                [message]
                                                    speaker=Algadur
                                                    message=_"By my beard, ye actually got back up from that?!"
                                                [/message]
                                                [message]
                                                    id=Hoplite,Hoplite2
                                                    side=$unit.side
                                                    message=_"Indeed, it is only thanks to the Phoenix Amulet that I managed to survive this hit."
                                                [/message]
                                            )}
                                            {ELIZABETH_LINE phoenix_amulet (
                                                [message]
                                                    speaker=Elizabeth
                                                    message=_"By the Lords of Light, you're alive!? That would have killed anyone!"
                                                [/message]
                                                [message]
                                                    id=Hoplite,Hoplite2
                                                    side=$unit.side
                                                    message=_"It is thanks to my Phoenix Amulet that I continue to live."
                                                [/message]
                                                [message]
                                                    speaker=Elizabeth
                                                    message=_"An artifact that can cheat death itself...! Not even the Ruby of Fire can compare to that!"
                                                [/message]
                                            )}
                                        [/then]
                                    )}
                                [/event]
                                [event]
                                    name=attack
                                    first_time_only=no
                                    [filter]
                                        side=$hoplite_enemyside
                                    [/filter]
                                    [filter_second]
                                        id=Hoplite,Hoplite2
                                        ability=hoplite_teleportaway
                                    [/filter_second]

                                    [store_unit]
                                        [filter]
                                            id=Hoplite,Hoplite2
                                            x,y=$x2,$y2
                                        [/filter]
                                        variable=hoplite_teleportloc
                                        kill=no
                                    [/store_unit]

                                    {VARIABLE x2 $hoplite_teleportloc.x}
                                    {VARIABLE y2 $hoplite_teleportloc.y}
                                    {VARIABLE teleportaway_cost $weapon.damage}
                                    {VARIABLE_OP teleportaway_cost divide 10}
                                    {VARIABLE_OP teleportaway_cost multiply 75}
                                    {HOPLITE_GET_RESIST_MULT $second_unit.id $weapon.type}
                                    {VARIABLE_OP teleportaway_cost multiply $tmp_resistmult}
                                    {VARIABLE_OP teleportaway_cost round floor}
                                    {CLEAR_VARIABLE hoplite_teleportloc}
                                    {HOPLITE_TELEPORTAWAY_EVENT $teleportaway_cost (
                                        x,y=$x2,$y2
                                    )}
                                    {CLEAR_VARIABLE teleportaway_cost}
                                [/event]
                                [event]
                                    name=attack end
                                    first_time_only=no
                                    [filter_second]
                                        id=Hoplite,Hoplite2
                                    [/filter_second]
                                    [fire_event]
                                        id=hoplite_adrenaline
                                    [/fire_event]
                                [/event]
                                #moved to a seperate event, to allow for multiple healing potion menu items
                                [event]
                                    id=spartan_healingpotion_event
                                    first_time_only=no

                                    {IF_VAR tmp_spartan_healpotion_side greater_than 0 (
                                        [else]
                                            {VARIABLE tmp_spartan_healpotion_side $side_number}
                                        [/else]
                                    )}


                                    #the "heal ally at low hp" achievement

                                    [if]
                                    [have_unit]
                                        id=$hoplite_healpotion.id
                                        formula="hitpoints <= 5"
                                        [not]
                                            id=Hoplite,Hoplite2
                                            side=$side_number
                                        [/not]
                                    [/have_unit]
                                    [then]
                                        {ACHIEVEMENT_MESSAGE_LONE medic $side_number}
                                    [/then]
                                    [/if]


                                    #unit is now stored earlier, to ensure this works properly for the "heal ally with potion" feature
                                    #            [store_unit]
                                    #                [filter]
                                    #                    id=Hoplite,Hoplite2
                                    #                    side=$tmp_spartan_healpotion_side
                                    #                [/filter]
                                    #                variable=hoplite_healpotion
                                    #                kill=no
                                    #            [/store_unit]
                                    [if]
                                        [variable]
                                            name=hoplite_healpotion.hitpoints
                                            less_than=$hoplite_healpotion.max_hitpoints
                                        [/variable]
                                        [then]
                                            [unstore_unit]
                                                variable=hoplite_healpotion
                                            [/unstore_unit]
                                            [sound]
                                                name=potion.ogg
                                            [/sound]
                                            [heal_unit]
                                                [filter]
                                                    id=$hoplite_healpotion.id
                                                [/filter]
                                                amount=$healpotion_restore$tmp_spartan_healpotion_side
                                                animate=yes
                                                restore_statuses=no
                                            [/heal_unit]
                                            [modify_unit]
                                                [filter]
                                                    id=$hoplite_healpotion.id
                                                [/filter]
                                                [status]
                                                    poisoned=no
                                                [/status]
                                            [/modify_unit]

                                            ##now potions are once per depth
                                            ##                                {IF_VAR healpotionbag_unlocked1 equals yes (
                                            ##                                    [then]
                                            #                                        {VARIABLE hoplite_healpotion_cooldown$tmp_spartan_healpotion_side 1}
                                            ##                                    [/then]
                                            ##                                    [else]
                                            ##                                        {VARIABLE hoplite_healpotion_cooldown1 2}
                                            ##                                    [/else]
                                            ##                                )}

                                            {VARIABLE_OP healpotions_in_inventory$tmp_spartan_healpotion_side sub 1}

                                            {IF_VAR healpotionenergy_unlocked$tmp_spartan_healpotion_side equals yes (
                                                [then]
                                                    {VARIABLE tmp_potionenergybonus_mult 0.5}
                                                [/then]
                                            )}
                                            #energy is added a second time
                                            {IF_VAR healpotionenergyII_unlocked$tmp_spartan_healpotion_side equals yes (
                                                [then]
                                                    {VARIABLE tmp_potionenergybonus_mult 0.8}

                                                    [object]
                                                        silent=yes
                                                        duration=turn end #originally the duration was turn, but that failed to work properly with allies/other player in multiplayer
                                                        [filter]
                                                            id=$hoplite_healpotion.id
                                                        [/filter]
                                                        [effect]
                                                            apply_to=attack
                                                            increase_damage=50%
                                                        [/effect]
                                                    [/object]
                                                    [floating_text]
                                                        [filter]
                                                            id=$hoplite_healpotion.id
                                                        [/filter]
                                                        text="<span color='#ffc800'>" + _ "+50% damage!" + "</span>"
                                                    [/floating_text]
                                                [/then]
                                            )}
                                            {IF_VAR tmp_potionenergybonus_mult greater_than 0 (
                                                [then]
                                                    {VARIABLE tmp_potion_energybonus $hoplite_maxenergy1}
                                                    {VARIABLE_OP tmp_potion_energybonus multiply $tmp_potionenergybonus_mult}
                                                    {VARIABLE_OP tmp_potion_energybonus round floor}
                                                    [delay]
                                                        time=500
                                                    [/delay]
                                                    [sound]
                                                        name=magic-faeriefire.ogg
                                                    [/sound]

                                                    {IF_VAR hoplite_healpotion.side equals $hoplite_allyside (
                                                        [then]
                                                            [object]
                                                                silent=yes
                                                                duration=turn end
                                                                [filter]
                                                                    id=$hoplite_healpotion.id
                                                                [/filter]
                                                                [effect]
                                                                    apply_to=movement
                                                                    increase=1
                                                                [/effect]
                                                            [/object]
                                                        [/then]
                                                        [else]
                                                            {HOPLITE_ADD_ENERGY_BY_SIDE $hoplite_healpotion.side $tmp_potion_energybonus}
                                                        [/else]
                                                    )}
                                                [/then]
                                            )}
                                            {CLEAR_VARIABLE tmp_potionenergybonus_mult}
                                            {CLEAR_VARIABLE tmp_potion_energybonus}
                                        [/then]
                                        [else]
                                            [print]
                                                text= _ "Hitpoints are already full!"
                                                size=20
                                                red=255
                                                duration=2000
                                            [/print]
                                        [/else]
                                    [/if]
                                    {CLEAR_VARIABLE tmp_spartan_healpotion_side}
                                [/event]
                                [event]
                                    id=spartan_skill_menu_event
                                    first_time_only=no
                                    [message]
                                        speaker=narrator
                                        caption=_ "Hoplite Skills menu"
                                        message=_ "Select a skill to use:"
#ifdef MULTIPLAYER
                                        side_for=$side_number
#endif
                                        [option]
                                            image="attacks/blank-attack.png"
                                            description=_"Return to the Game"
                                            [command]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/spear-precise-stab.png"
                                            description=_"<span color='#ffff99'>Precise Stab</span>: melee spear gains +10 damage and slow until the end of the turn
            costs <span color='#ffff99'>50</span> energy"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL skill_spear_unlocked$side_number equals yes}
                                                [and]
                                                    [not]
                                                        [have_unit]
                                                            side=$side_number
                                                            id=Hoplite,Hoplite2
                                                            ability=spartan_skill_used_precise_stab
                                                        [/have_unit]
                                                    [/not]
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 50}
                                                    [then]
                                                        [sound]
                                                            name=windsweep.ogg#works pretty well as a power up sound
                                                        [/sound]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Precise Stab" + "</span>"
                                                        [/floating_text]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=spear
                                                                increase_damage=10
                                                                [set_specials]
                                                                    mode=append
                                                                    {WEAPON_SPECIAL_SLOW}
                                                                [/set_specials]
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    [dummy]
                                                                        id=spartan_skill_used_precise_stab
                                                                    [/dummy]
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -50}
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="icons/protect-royal-3.png"
                                            description=_"<span color='#ffff99'>Charged Bash</span>: shield gains +2 knockback until the end of the turn, costs <span color='#ffff99'>50</span> energy"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL skill_chargedbash_unlocked$side_number equals yes}
                                                [and]
                                                    [not]
                                                        [have_unit]
                                                            side=$side_number
                                                            id=Hoplite,Hoplite2
                                                            ability=spartan_skill_used_chargedbash
                                                        [/have_unit]
                                                    [/not]
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 50}
                                                    [then]
                                                        [sound]
                                                            name=windsweep.ogg#works pretty well as a power up sound
                                                        [/sound]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Charged Bash" + "</span>"
                                                        [/floating_text]
                                                        {VARIABLE tmp_new_knockback 3}
                                                        {VARIABLE_OP tmp_new_knockback add $charged_shieldbash_knockback_bonus$side_number}
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=shield
                                                                remove_specials=knockback
                                                                [set_specials]
                                                                    mode=append
                                                                    {SPARTAN_KNOCKBACKSPECIAL $tmp_new_knockback}
                                                                [/set_specials]
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    [dummy]
                                                                        id=spartan_skill_used_chargedbash
                                                                    [/dummy]
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        {CLEAR_VARIABLE tmp_new_knockback}
                                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -50}
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/frenzy.png"
                                            description=_"<span color='#ffff99'>Execution</span>: axe gains damage equal to 20% of your current energy
            costs <span color='#ffff99'>all</span> of your energy, requires at least 25 energy"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL skill_execution_unlocked$side_number equals yes}
                                                [and]
                                                    [not]
                                                        [have_unit]
                                                            side=$side_number
                                                            id=Hoplite,Hoplite2
                                                            ability=spartan_skill_used_execution
                                                        [/have_unit]
                                                    [/not]
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 25}
                                                    [then]
                                                        [sound]
                                                            name=windsweep.ogg#works pretty well as a power up sound
                                                        [/sound]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Execution" + "</span>"
                                                        [/floating_text]
                                                        {VARIABLE tmp_axe_dmgbonus $hoplite_energy$side_number}
                                                        {VARIABLE_OP tmp_axe_dmgbonus multiply 0.2}
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=axe
                                                                increase_damage=$tmp_axe_dmgbonus
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    [dummy]
                                                                        id=spartan_skill_used_execution
                                                                    [/dummy]
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        {CLEAR_VARIABLE tmp_axe_dmgbonus}
                                                        #drain all energy
                                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -$hoplite_energy$side_number}
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/fireball.png"
                                            description=_"<span color='#ffff99'>Explosive Spear</span>: +10 damage until the end of the turn
   damages enemies adjacent to the target by 50% of the base damage
   Costs <span color='#ffff99'>75</span> energy"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL spearthrowexplode_unlocked$side_number equals yes}
                                                [and]
                                                    [not]
                                                        [have_unit]
                                                            side=$side_number
                                                            id=Hoplite,Hoplite2
                                                            ability=spartan_skill_used_explosive_spear
                                                        [/have_unit]
                                                    [/not]
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 75}
                                                    [then]
                                                        [sound]
                                                            name=windsweep.ogg#works pretty well as a power up sound
                                                        [/sound]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Explosive Spear" + "</span>"
                                                        [/floating_text]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=spear2
                                                                increase_damage=10
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    [dummy]
                                                                        id=spartan_skill_used_explosive_spear
                                                                    [/dummy]
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        #drain all energy
                                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -75}
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="icons/shadowclone.png"
                                            description=_"<span color='#ffff99'>Shadow Clone</span>: Summon an allied Shadow Clone of yourself
   Costs <span color='#ffff99'>100</span> energy
   has a cooldown of $hoplite_shadowclone_cooldown_max$side_number|| depth(s)"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL shadowclone_unlocked$side_number equals yes}
                                                [and]
                                                    {VARIABLE_CONDITIONAL hoplite_shadowclone_cooldown$side_number less_than 1}
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 100}
                                                    [then]
                                                        [if]
                                                            [have_unit]
                                                                id=Hoplite2
                                                            [/have_unit]
                                                            [then]
                                                                {HOPLITE_PLAYERFILTER (
                                                                    {VARIABLE shadowclone_id Hoplite}
                                                                ) (
                                                                    {VARIABLE shadowclone_id Hoplite2}
                                                                )}
                                                            [/then]
                                                            [else]
                                                                {VARIABLE shadowclone_id Hoplite}
                                                            [/else]
                                                        [/if]
                                                        {HOPLITE_SHADOWCLONE_EVENT $shadowclone_id}
                                                        [if]
                                                            [variable]
                                                                name=clonesuccess
                                                                equals=yes
                                                            [/variable]
                                                            [then]
                                                                [floating_text]
                                                                    x,y=$x1,$y1
                                                                    text="<span color='#ffff99'>" + _ "Shadow Clone" + "</span>"
                                                                [/floating_text]
                                                                {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -100}
                                                                {VARIABLE hoplite_shadowclone_cooldown$side_number $hoplite_shadowclone_cooldown_max$side_number}
                                                            [/then]
                                                        [/if]
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                {CLEAR_VARIABLE shadowclone_id}
                                                {CLEAR_VARIABLE shadowclone_type}
                                                {CLEAR_VARIABLE clonesuccess}
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/blank-attack.png~BLIT(attacks/bow-elven.png~CROP(5,5,49,49)~O(70%)~GS()~CS(-200,-40,-0),5,5)"
                                            description=_"<span color='#ffff99'>Spirit Archer</span>: Summon an allied Spirit Archer
   Costs <span color='#ffff99'>100</span> energy
   has a cooldown of 1 depth(s)"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL summonedarcher_unlocked$side_number equals yes}
                                                [and]
                                                    {VARIABLE_CONDITIONAL hoplite_summonedarcher_cooldown$side_number less_than 1}
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 100}
                                                    [then]
                                                        [if]
                                                            [have_unit]
                                                                id=Hoplite2
                                                            [/have_unit]
                                                            [then]
                                                                {HOPLITE_PLAYERFILTER (
                                                                    {VARIABLE summonedarcher_id Hoplite}
                                                                ) (
                                                                    {VARIABLE summonedarcher_id Hoplite2}
                                                                )}
                                                            [/then]
                                                            [else]
                                                                {VARIABLE summonedarcher_id Hoplite}
                                                            [/else]
                                                        [/if]
                                                        {HOPLITE_SUMMONEDARCHER_EVENT $summonedarcher_id}
                                                        [if]
                                                            [variable]
                                                                name=clonesuccess
                                                                equals=yes
                                                            [/variable]
                                                            [then]
                                                                [floating_text]
                                                                    x,y=$x1,$y1
                                                                    text="<span color='#ffff99'>" + _ "Spirit Archer" + "</span>"
                                                                [/floating_text]
                                                                {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -100}
                                                                {VARIABLE hoplite_summonedarcher_cooldown$side_number 1}
                                                            [/then]
                                                        [/if]
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                {CLEAR_VARIABLE summonedarcher_id}
                                                {CLEAR_VARIABLE summonedarcher_type}
                                                {CLEAR_VARIABLE clonesuccess}
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/bow-elven-magic.png"
                                            description=_"<span color='#ffff99'>Overdraw Mode</span>: Bow deals +5 damage
            Bow no longer shoots instantly

            Lasts until you use Quickdraw Mode skill"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL bowIV_unlocked$side_number equals yes}
                                                [and]
                                                    {VARIABLE_CONDITIONAL spartan_bow_mode$side_number equals quickdraw}
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [floating_text]
                                                    x,y=$x1,$y1
                                                    text="<span color='#ffff99'>" + _ "Overdraw Mode" + "</span>"
                                                [/floating_text]
                                                {VARIABLE spartan_bow_mode$side_number overdraw}
                                                [object]
                                                    silent=yes
                                                    duration=forever
                                                    id=bow_overdaw_bonus
                                                    take_only_once=no
                                                    [filter]
                                                        id=Hoplite,Hoplite2
                                                        side=$side_number
                                                    [/filter]
                                                    [effect]
                                                        apply_to=attack
                                                        name=bow
                                                        increase_damage=5
                                                    [/effect]
                                                [/object]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/bow-elven-magic.png"
                                            description=_"<span color='#ffff99'>Quickdraw Mode</span>: Bow shoots instantly
            But no longer has the damage bonus from Overdraw mode

            Lasts until you use Overdraw Mode skill"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL bowIV_unlocked$side_number equals yes}
                                                [and]
                                                    {VARIABLE_CONDITIONAL spartan_bow_mode$side_number equals overdraw}
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [floating_text]
                                                    x,y=$x1,$y1
                                                    text="<span color='#ffff99'>" + _ "Quickdraw Mode" + "</span>"
                                                [/floating_text]
                                                {VARIABLE spartan_bow_mode$side_number quickdraw}
                                                [remove_object]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                    object_id=bow_overdaw_bonus
                                                [/remove_object]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/gaze.png"
                                            description=_"<span color='#ffff99'>Auto-Loyal</span>: Toggle whether enthralled enemies instantly become loyal when enthralled
            This can be useful if you want to enthrall the last remaining enemy on the map or don't want to click the loyal menu each time
            Only works while you are below the loyal thrall limit
            Currently set to <span color='#9999ff'>$spartan_thrall_auto_loyal$side_number||</span>"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL enthrall_loyal_unlocked$side_number equals yes}
                                            [/show_if]
                                            [command]
                                                [floating_text]
                                                    x,y=$x1,$y1
                                                    text="<span color='#ffff99'>" + _ "Auto-Loyal" + "</span>"
                                                [/floating_text]

                                                {IF_VAR spartan_thrall_auto_loyal$side_number equals yes (
                                                [then]
                                                    {VARIABLE spartan_thrall_auto_loyal$side_number no}
                                                [/then]
                                                [else]
                                                    {VARIABLE spartan_thrall_auto_loyal$side_number yes}
                                                [/else]
                                                )}
                                            [/command]
                                        [/option]
                                        [option]
                                            image="icons/book2.png"
                                            description=_"<span color='#ffff99'>Book of Pacts</span>: Choose a pact
   has a cooldown of $hoplite_book_of_pacts_cooldown_max$side_number|| depths
   (unless you cancel out of the pact menu)"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL book_of_pacts_unlocked$side_number equals yes}
                                                [and]
                                                    {VARIABLE_CONDITIONAL hoplite_book_of_pacts_cooldown$side_number less_than 1}
                                                [/and]
                                            [/show_if]
                                            [command]
                                                {VARIABLE tmp_book_of_pacts_menu yes}
                                                [message]
                                                    speaker=narrator
                                                    caption=_"Book of Pacts"
                                                    image="portraits/book.png~GS()~BLEND(0,0,0,0.4)"
                                                    message=_"Choose a pact..."
                                                    [option]
                                                        image="misc/red-x.png"
                                                        description=_"Return to the game"
                                                        [command]
#no longer needed
#                                                            {VARIABLE tmp_pact_cancelled yes}
                                                        [/command]
                                                    [/option]
                                                    {SPARTAN_PACT_OPTIONS}
                                                [/message]

                                                {IF_VAR tmp_spartan_pact_taken_from_book equals yes (
                                                    [then]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Book of Pacts" + "</span>"
                                                        [/floating_text]
                                                        [sound]
                                                            name=magic-dark-big.ogg
                                                        [/sound]
                                                        {VARIABLE hoplite_book_of_pacts_cooldown$side_number $hoplite_book_of_pacts_cooldown_max$side_number}
                                                    [/then]
                                                )}

#                                                {CLEAR_VARIABLE tmp_pact_cancelled}
                                                {CLEAR_VARIABLE tmp_book_of_pacts_menu}
                                                {CLEAR_VARIABLE tmp_spartan_pact_taken_from_book}
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/iceball.png"
                                            description=_"<span color='#ffff99'>Ring of Frost</span>: deal $ringfrost_damage$side_number|| cold damage to units in a 2-tile radius but NOT adjacent to you
    Ends your turn
    costs <span color='#ffff99'>50</span> energy
    Can only use this skill if you can still attack normally"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL skill_ringfrost_unlocked$side_number equals yes}
                                            [/show_if]
                                            [command]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 50}
                                                    [then]
                                                    [if]
                                                        [have_unit]
                                                            x,y=$x1,$y1
                                                            formula="attacks_left > 0"
                                                        [/have_unit]
                                                        [then]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Ring of Frost" + "</span>"
                                                        [/floating_text]
                                                        [animate_unit]
                                                            flag=ringfrost
                                                            [filter]
                                                                x,y=$x1,$y1
                                                            [/filter]
                                                        [/animate_unit]
                                                        [store_unit]
                                                            [filter]
                                                                id=Hoplite,Hoplite2
                                                                side=$side_number
                                                            [/filter]
                                                            variable=hoplitering
                                                            kill=no
                                                        [/store_unit]

                                                        {SPARTAN_CALCULATE_DAMAGE hoplitering $ringfrost_damage$side_number||}
                                                        [spartan_harm_unit]
                                                            [filter]
                                                                side=$hoplite_enemyside
                                                                [filter_location]
                                                                    x,y=$x1,$y1
                                                                    radius=2
                                                                [/filter_location]
                                                                [not]
                                                                    [filter_adjacent]
                                                                        x,y=$x1,$y1
                                                                    [/filter_adjacent]
                                                                [/not]
                                                            [/filter]
                                                            [filter_second]
                                                                id=$hoplitering.id
                                                            [/filter_second]
                                                            #[primary_attack]
                                                            #    name=wizardbeam
                                                            #[/primary_attack]
                                                            amount=$tmp_spartan_calculated_damage
                                                            damage_type=cold
                                                            fire_event=yes
                                                            animate=defender
                                                            delay=0
                                                            experience=yes
                                                        [/spartan_harm_unit]
                                                        {CLEAR_VARIABLE tmp_spartan_calculated_damage}
                                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -50}
                                                        {CLEAR_VARIABLE hoplitering}
                                                        [end_turn]
                                                        [/end_turn]
                                                        [/then]
                                                        [else]
                                                            [print]
                                                                text= _ "You already attacked this turn!"
                                                                size=20
                                                                red=255
                                                                duration=2000
                                                            [/print]
                                                        [/else]
                                                    [/if]
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="icons/fireguardian.png"
                                            description=_"<span color='#ffff99'>Summon Fire Guardian</span>: summon an allied Fire Guardian
    costs <span color='#ffff99'>50</span> energy"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL skill_fireguardian_unlocked$side_number equals yes}
                                            [/show_if]
                                            [command]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 50}
                                                    [then]
                                                        [store_locations]
                                                            [and]
                                                                [filter]
                                                                    x,y=$x1,$y1
                                                                [/filter]
                                                                radius=1
                                                            [/and]
                                                            [and]
                                                                terrain={SPARTAN_UNITSPAWN_TERRAIN}
                                                            [/and]
                                                            [not]
                                                                [filter]
                                                                [/filter]
                                                            [/not]
                                                            variable=fireguardianloc
                                                        [/store_locations]
                                                        {IF_VAR fireguardianloc.length greater_than 0 (
                                                            [then]
                                                                [sound]
                                                                    name=fire.wav
                                                                [/sound]
                                                                [unit]
                                                                    side=$hoplite_allyside
                                                                    type=Hoplite_Fireguardian
                                                                    x,y=$fireguardianloc.x,$fireguardianloc.y
                                                                    animate=yes
                                                                    placement=map
                                                                    passable=yes
                                                                    [modifications]
                                                                        [object]
                                                                            silent=yes
                                                                            [effect]
                                                                                apply_to=new_ability
                                                                                [abilities]
                                                                                    [dummy]
                                                                                        id=spartan_ally_owner_side$side_number
                                                                                    [/dummy]
                                                                                [/abilities]
                                                                            [/effect]
                                                                        [/object]
                                                                        #temporary ability to buff only the latest fire guardian
                                                                        [object]
                                                                            silent=yes
                                                                            duration=turn
                                                                            [effect]
                                                                                apply_to=new_ability
                                                                                [abilities]
                                                                                    [dummy]
                                                                                        id=spartan_fireguardian_filter#replaces the cloneloc coordinate check
                                                                                    [/dummy]
                                                                                [/abilities]
                                                                            [/effect]
                                                                        [/object]
                                                                    [/modifications]
                                                                [/unit]
                                                                [if]
                                                                    [variable]
                                                                        name=fireguardianII_unlocked$side_number
                                                                        equals=yes
                                                                    [/variable]
                                                                    [then]
                                                                        [object]
                                                                            silent=yes
                                                                            duration=forever
                                                                            [filter]
                                                                                ability=spartan_ally_owner_side$side_number
                                                                                [and]
                                                                                    ability=spartan_fireguardian_filter
                                                                                [/and]
                                                                            [/filter]
                                                                            [effect]
                                                                                apply_to=hitpoints
                                                                                increase=5
                                                                                increase_total=5
                                                                            [/effect]
                                                                        [/object]
                                                                    [/then]
                                                                [/if]
                                                                [if]
                                                                    [variable]
                                                                        name=fireguardianIII_unlocked$side_number
                                                                        equals=yes
                                                                    [/variable]
                                                                    [then]
                                                                        [object]
                                                                            silent=yes
                                                                            duration=forever
                                                                            [filter]
                                                                                ability=spartan_ally_owner_side$side_number
                                                                                [and]
                                                                                    ability=spartan_fireguardian_filter
                                                                                [/and]
                                                                            [/filter]
                                                                            [effect]
                                                                                apply_to=attack
                                                                                increase_damage=2
                                                                            [/effect]
                                                                            [effect]
                                                                                apply_to=hitpoints
                                                                                increase=5
                                                                                increase_total=5
                                                                            [/effect]
                                                                        [/object]
                                                                    [/then]
                                                                [/if]
                                                                #remove the temporary ability from the unit, to avoid bugs when summoning multiple fire guardians in one turn
                                                                [object]
                                                                    silent=yes
                                                                    duration=turn
                                                                    [filter]
                                                                        ability=spartan_ally_owner_side$side_number
                                                                        [and]
                                                                            ability=spartan_fireguardian_filter
                                                                        [/and]
                                                                    [/filter]                                                                    
                                                                    [effect]
                                                                        apply_to=remove_ability
                                                                        [abilities]
                                                                            [dummy]
                                                                                id=spartan_fireguardian_filter#replaces the cloneloc coordinate check
                                                                            [/dummy]
                                                                        [/abilities]
                                                                    [/effect]
                                                                [/object]
                                                                [set_variable]
                                                                    name=fireguardiansuccess
                                                                    value=yes
                                                                [/set_variable]
                                                            [/then]
                                                            [else]
                                                                [print]
                                                                    text= _ "All adjacent hexes are occupied!"
                                                                    size=20
                                                                    red=255
                                                                    duration=2000
                                                                [/print]
                                                            [/else]

                                                        )}
                                                        {CLEAR_VARIABLE fireguardianloc}
                                                        [if]
                                                            [variable]
                                                                name=fireguardiansuccess
                                                                equals=yes
                                                            [/variable]
                                                            [then]
                                                                [floating_text]
                                                                    x,y=$x1,$y1
                                                                    text="<span color='#ffff99'>" + _ "Fire Guardian" + "</span>"
                                                                [/floating_text]
                                                                {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -50}
                                                                {ELIZABETH_MAGIC_LINE fireguardian (
                                                                    [message]
                                                                        speaker=Elizabeth
                                                                        message=_"Ah, good old Fire Guardians. Simple but effective."
                                                                    [/message]
                                                                )}
                                                                {ALGADUR_LINE fireguardian (
                                                                    [message]
                                                                        speaker=Algadur
                                                                        message=_"Fire Guardians eh? Fought those things in the caves before, good to have them on our side for once."
                                                                    [/message]
                                                                )}
                                                            [/then]
                                                        [/if]
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                {CLEAR_VARIABLE fireguardiansucces}
                                            [/command]
                                        [/option]
                                    [/message]
                                [/event]
                                [event]
                                    name=turn refresh
                                    id=spartan_burn_damage
                                    first_time_only=no

                                    [store_unit]
                                        [filter]
                                            ability=spartan_burning
                                            formula="self.wml_vars.burn_applier_id = Hoplite"
                                        [/filter]
                                        variable=burn_achievement_check1
                                        kill=no
                                    [/store_unit]

                                    {IF_VAR burn_achievement_check1.length greater_than_equal_to 5 (
                                        [then]
                                            {ACHIEVEMENT_MESSAGE_LONE pyromaniac 1}
                                        [/then]
                                    )}

                                    {CLEAR_VARIABLE burn_achievement_check1}

#ifdef MULTIPLAYER

                                    [store_unit]
                                        [filter]
                                            ability=spartan_burning
                                            formula="self.wml_vars.burn_applier_id = Hoplite..2"#using Hoplite2 directly breaks the formula
                                        [/filter]
                                        variable=burn_achievement_check2
                                        kill=no
                                    [/store_unit]

                                    {IF_VAR burn_achievement_check2.length greater_than_equal_to 5 (
                                        [then]
                                            {ACHIEVEMENT_MESSAGE_LONE pyromaniac 2}
                                        [/then]
                                    )}

                                    {CLEAR_VARIABLE burn_achievement_check2}

#endif

                                    [store_unit]
                                        [filter]
                                            ability=spartan_burning
                                            side=$side_number
                                        [/filter]
                                        variable=burn_store
                                        kill=no
                                    [/store_unit]

                                    [foreach]
                                        array=burn_store
                                        index_var=i
                                        [do]
                                            [spartan_harm_unit]
                                                [filter]
                                                    id=$this_item.id
                                                [/filter]
                                                amount=$this_item.variables.burn_damage
                                                damage_type=fire
                                                fire_event=yes
                                                kill=no
                                                animate=yes
                                            [/spartan_harm_unit]
                                        [/do]
                                    [/foreach]

                                    {CLEAR_VARIABLE burn_store}
                                    [store_unit]
                                        [filter]
                                            ability=spartan_burning
                                            side=$side_number
                                            [and]
                                                [filter_wml]
                                                    hitpoints=1
                                                [/filter_wml]
                                            [/and]
                                        [/filter]
                                        variable=burn_store
                                        kill=no
                                    [/store_unit]

                                    [foreach]
                                        array=burn_store
                                        index_var=ti
                                        [do]
                                            [spartan_kill]
                                                id=$this_item.id
                                                animate=yes
                                                fire_event=yes
                                                experience=yes
                                                [filter_second]
                                                    id=$this_item.variables.burn_applier_id
                                                [/filter_second]
                                            [/spartan_kill]
                                        [/do]
                                    [/foreach]

                                    {CLEAR_VARIABLE burn_store}
                                [/event]
                                [event]
                                    name=attacker hits
                                    id=spartan_axe_cleave
                                    first_time_only=no
                                    [filter_attack]
                                        special_id=spartan_axe_cleave
                                    [/filter_attack]

                                    [store_unit]
                                        [filter]
                                            [filter_side]
                                                [enemy_of]
                                                    side=$unit.side
                                                [/enemy_of]
                                            [/filter_side]
                                            [filter_adjacent]
                                                x,y=$x2,$y2
                                            [/filter_adjacent]
                                            [filter_adjacent]
                                                x,y=$x1,$y1
                                            [/filter_adjacent]
                                            [not]
                                                [filter_wml]
                                                    [status]
                                                        petrified=yes
                                                    [/status]
                                                [/filter_wml]
                                                [or]
                                                    id=$second_unit.id
                                                [/or]
                                            [/not]
                                        [/filter]
                                        variable=bystander
                                    [/store_unit]

                                    {VARIABLE areadmg $weapon.damage}
                                    {VARIABLE_OP areadmg multiply 0.5}

                                    {IF_VAR axe_overkill_unlocked$unit.side equals yes (
                                        [then]
                                            {VARIABLE spartan_overkill_enabled yes}
                                        [/then]
                                    )}

                                    [if]
                                        {VARIABLE_CONDITIONAL unit.status.slowed boolean_equals yes}
                                        [then]
                                            {VARIABLE_OP areadmg divide 2}
                                            {VARIABLE_OP areadmg round floor}
                                        [/then]
                                    [/if]

                                    [foreach]
                                        array=bystander
                                        [do]
                                            [spartan_harm_unit]
                                                [filter]
                                                    id=$this_item.id
                                                [/filter]
                                                [filter_second]
                                                    id=$unit.id
                                                [/filter_second]
                                                amount=$areadmg
                                                damage_type=$weapon.type
                                                fire_event=yes
                                                animate=defender
                                                delay=0
                                                experience=yes
                                            [/spartan_harm_unit]
                                        [/do]
                                    [/foreach]
                                    {CLEAR_VARIABLE bystander}
                                    {CLEAR_VARIABLE spartan_overkill_enabled}
                                [/event]
                                [event]
                                    name=attacker hits
                                    id=spartan_axe_spin
                                    first_time_only=no
                                    [filter_attack]
                                        special_id=spartan_axe_spin
                                    [/filter_attack]

                                    [store_unit]
                                        [filter]
                                            [filter_side]
                                                [enemy_of]
                                                    side=$unit.side
                                                [/enemy_of]
                                            [/filter_side]
                                            [filter_adjacent]
                                                x,y=$x1,$y1
                                            [/filter_adjacent]
                                            [not]
                                                [filter_wml]
                                                    [status]
                                                        petrified=yes
                                                    [/status]
                                                [/filter_wml]
                                                [or]
                                                    id=$second_unit.id
                                                [/or]
                                            [/not]
                                        [/filter]
                                        variable=bystander
                                    [/store_unit]

                                    {VARIABLE areadmg $weapon.damage}
                                    {VARIABLE_OP areadmg multiply 0.5}

                                    {IF_VAR axe_overkill_unlocked$unit.side equals yes (
                                        [then]
                                            {VARIABLE spartan_overkill_enabled yes}
                                        [/then]
                                    )}

                                    [if]
                                        {VARIABLE_CONDITIONAL unit.status.slowed boolean_equals yes}
                                        [then]
                                            {VARIABLE_OP areadmg divide 2}
                                            {VARIABLE_OP areadmg round floor}
                                        [/then]
                                    [/if]

                                    [foreach]
                                        array=bystander
                                        [do]
                                            [spartan_harm_unit]
                                                [filter]
                                                    id=$this_item.id
                                                [/filter]
                                                [filter_second]
                                                    id=$unit.id
                                                [/filter_second]
                                                amount=$areadmg
                                                damage_type=$weapon.type
                                                fire_event=yes
                                                animate=defender
                                                delay=0
                                                experience=yes
                                            [/spartan_harm_unit]
                                        [/do]
                                    [/foreach]
                                    {CLEAR_VARIABLE bystander}
                                    {CLEAR_VARIABLE spartan_overkill_enabled}
                                [/event]
                                [event]
                                    name=attacker hits
                                    id=spartan_energy_siphon
                                    first_time_only=no
                                    [filter_attack]
                                        special_id=spartan_energy_siphon
                                    [/filter_attack]
                                    {HOPLITE_ADD_ENERGY_BY_SIDE $unit.side "$($second_unit.level * 5)"}
                                [/event]
                                [event]
                                    name=attacker hits
                                    id=spartan_energy_siphonII
                                    first_time_only=no
                                    [filter_attack]
                                        special_id=spartan_energy_siphonII
                                    [/filter_attack]
                                    {HOPLITE_ADD_ENERGY_BY_SIDE $unit.side "$($second_unit.level * 10)"}
                                [/event]
#enddef
