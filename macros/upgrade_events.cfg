#textdomain wesnoth-Hoplite

#define HOPLITE_SHADOWCLONE_EVENT ID
    [store_locations]
        [and]
            [filter]
                id={ID}
            [/filter]
            radius=1
        [/and]
        [and]
            terrain={SPARTAN_UNITSPAWN_TERRAIN}
        [/and]
        [not]
            [filter]
            [/filter]
            #[or]
            #    terrain=Xu*^*,Xo*^*,Q*^*,W*^*,S*^*
            #[/or]
        [/not]
        include_borders=no
        variable=cloneloc
    [/store_locations]
    {IF_VAR cloneloc.length greater_than 0 (
        [then]
            [sound]
                name=magic-dark.ogg
            [/sound]
            #the shadowclone archer code is no longer needed
            [if]
                [have_unit]
                    id=Hoplite
                    side=$side_number
                [/have_unit]
                [and]
                    [variable]
                        name=shadowclone_archer_unlocked1
                        equals=yes
                    [/variable]
                [/and]
                [or]
                    [variable]
                        name=shadowclone_archer_unlocked2
                        equals=yes
                    [/variable]
                    [and]
                        [have_unit]
                            id=Hoplite2
                            side=$side_number
                        [/have_unit]
                    [/and]
                [/or]
                [then]
                    {VARIABLE tmp_shadowclone_type Hoplite_Shadowclone_archer_ally}
                [/then]
                [else]
                    {VARIABLE tmp_shadowclone_type Hoplite_Shadowclone_ally}
                [/else]
            [/if]

            [unit]
                side=$hoplite_allyside
                type=$tmp_shadowclone_type
                name=_"Shadow Clone"
                x,y=$cloneloc.x,$cloneloc.y
                animate=yes
                placement=map
                passable=yes
                [modifications]
                    [object]
                        silent=yes
                        [effect]
                            apply_to=new_ability
                            [abilities]
                                [dummy]
                                    id=spartan_ally_owner_side$side_number
                                [/dummy]
                                [dummy]
                                    id=spartan_shadowclone_filter#replaces the cloneloc coordinate check
                                [/dummy]
                            [/abilities]
                        [/effect]
                    [/object]
                [/modifications]
            [/unit]
            {CLEAR_VARIABLE tmp_shadowclone_type}
            [if]
                [variable]
                    name=shadowcloneII_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_shadowclone_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=10
                            increase_total=10
                        [/effect]
                        [effect]
                            apply_to=new_ability
                            [abilities]
                                {ABILITY_HOPLITE_LEAP_NONPLAYER 3}
                            [/abilities]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [variable]
                    name=shadowcloneIII_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_shadowclone_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=5
                            increase_total=5
                        [/effect]
                        [effect]
                            apply_to=resistance
                            replace=no
                            [resistance]
                                blade=-15
                                pierce=-15
                                impact=-15
                                arcane=-15
                                fire=-15
                                cold=-15
                            [/resistance]
                        [/effect]
                        [effect]
                            apply_to=attack
                            name=spear
                            [set_specials]
                                mode=append
                                {WEAPON_SPECIAL_IMPALE}
                            [/set_specials]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [variable]
                    name=shadowcloneIV_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_shadowclone_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=7
                            increase_total=7
                        [/effect]
                        [effect]
                            apply_to=remove_ability
                            [abilities]
                                {ABILITY_HOPLITE_LEAP_NONPLAYER 3}
                            [/abilities]
                        [/effect]
                        [effect]
                            apply_to=new_ability
                            [abilities]
                                {ABILITY_HOPLITE_LEAP_NONPLAYER 2}
                            [/abilities]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [variable]
                    name=shadowcloneV_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_shadowclone_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=8
                            increase_total=8
                        [/effect]
                        [effect]
                            apply_to=remove_ability
                            [abilities]
                                {ABILITY_HOPLITE_LEAP_NONPLAYER 2}
                            [/abilities]
                        [/effect]
                        [effect]
                            apply_to=new_ability
                            [abilities]
                                {ABILITY_HOPLITE_LEAP_NONPLAYER 1}
                            [/abilities]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [variable]
                    name=shadowcloneVI_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_shadowclone_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=10
                            increase_total=10
                        [/effect]
                        [effect]
                            apply_to=attack
                            name=spear
                            increase_damage=5
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [variable]
                    name=shadowcloneIIIb_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_shadowclone_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=attack
                            name=spear
                            increase_damage=5
                        [/effect]
                    [/object]
                [/then]
            [/if]
            #swimming upgrade applies to shadow clones/spirit archers
            [if]
                [variable]
                    name=swimming_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_shadowclone_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=movement_costs
                            replace=yes
                            [movement_costs]
                                shallow_water=1
                                swamp_water=1
                            [/movement_costs]
                        [/effect]
                        #commented out, since it is no longer necessary
                        #            [effect]
                        #               apply_to=new_ability
                        #               [abilities]
                        #                   {ABILITY_HOPLITE_SWIMMER}
                        #               [/abilities]
                        #            [/effect]
                    [/object]
                [/then]
            [/if]
            #levitation upgrade applies to shadow clones/spirit archers
            [if]
                [variable]
                    name=levitation_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_shadowclone_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=movement_costs
                            replace=yes
                            {SPARTAN_FLY_MOVESCOSTS}
                        [/effect]
                        [effect]
                            apply_to=new_animation
                            [standing_anim]
                                start_time=0
                                alpha=0.8~0.4:700,0.4~0.6:300,0.6~0.4:300,0.4~0.8:700
                                submerge=0.01
                                terrain_type=Q*^*,W*^*,S*^*
                                [frame]
                                    duration=2115
                                    image="units/player/protector.png:705"
                                    image_mod="~GS()~CS(-200,-40,-0)"
                                    y=1:255,0:150,-1:150,0:150,1:255,0:150,-1:150,0:150,1:255,0:150,-1:150,0:150
                                [/frame]
                            [/standing_anim]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [set_variable]
                name=clonesuccess
                value=yes
            [/set_variable]
            [fire_event]
                name=spartan_apply_leap_and_sluggish_manually
                [primary_unit]
                    x,y=$cloneloc.x,$cloneloc.y
                [/primary_unit]
            [/fire_event]
            {ELIZABETH_MAGIC_LINE clone_or_archer (
                [message]
                    speaker=Elizabeth
                    message=_"What sort of summoning magic is that, I've never seen it! Oh, you must absolutely show me how you do that later!"
                [/message]
            )}
            {ALGADUR_LINE clone_or_archer (
                [message]
                    speaker=Algadur
                    message=_"Havin' endless reinforcements would have made me battle against those orcs a whole lot different.."
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    side=$side_number
                    message=_"Alas, we cannot change the past, but we can avenge your fallen brothers!"
                [/message]
                [message]
                    speaker=Algadur
                    message=_"Hah, damn right, shield-brother! Let's show those foul creatures our combined might!"
                [/message]
            )}
            {GALATEA_ALLY_LINE clone_or_archer (
                [message]
                    speaker=Galatea
                    message=_"I've summoned all sorts of things in my time, but this seems pretty unique."
                [/message]
            )}
        [/then]
        [else]
            [print]
                text= _ "All adjacent hexes are occupied!"
                size=20
                red=255
                duration=2000
            [/print]
        [/else]
    )}
    {CLEAR_VARIABLE cloneloc}
#enddef

#define HOPLITE_SUMMONEDARCHER_EVENT ID
    [store_locations]
        [and]
            [filter]
                id={ID}
            [/filter]
            radius=1
        [/and]
        [and]
            terrain={SPARTAN_UNITSPAWN_TERRAIN}
        [/and]
        [not]
            [filter]
            [/filter]
#            [or]
#                terrain=Xu*^*,Xo*^*,Q*^*,W*^*,S*^*
#            [/or]
        [/not]
        include_borders=no
        variable=cloneloc
    [/store_locations]
    {IF_VAR cloneloc.length greater_than 0 (
        [then]
            [sound]
                name=magic-dark.ogg
            [/sound]
            #scrapped for now
            #[switch]
            #    variable=spartan_summonedarcher_type$side_number
            #    [case]
            #        value=1
            #        {VARIABLE tmp_summonedarcher_type Hoplite_Summonedarcher_ally}
            #    [/case]
            #    [case]
            #        value=2
            #        {VARIABLE tmp_summonedarcher_type Hoplite_Summonedarcher_upgraded_ally}
            #    [/case]
            #    [else]
            #        {VARIABLE tmp_summonedarcher_type Hoplite_Summonedarcher_ally}
            #    [/else]
            #[/switch]

            {VARIABLE tmp_summonedarcher_type Hoplite_Summonedarcher_ally}

            [unit]
                side=$hoplite_allyside
                type=$tmp_summonedarcher_type
                name=_"Spirit Archer"
                x,y=$cloneloc.x,$cloneloc.y
                animate=yes
                placement=map
                passable=yes
                [modifications]
                    [object]
                        silent=yes
                        [effect]
                            apply_to=new_ability
                            [abilities]
                                [dummy]
                                    id=spartan_ally_owner_side$side_number
                                [/dummy]
                                [dummy]
                                    id=spartan_summonedarcher_filter#replaces the cloneloc coordinate check
                                [/dummy]
                            [/abilities]
                        [/effect]
                    [/object]
                [/modifications]
            [/unit]
            {CLEAR_VARIABLE tmp_summonedarcher_type}
            [if]
                [variable]
                    name=summonedarcherII_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_summonedarcher_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=5
                            increase_total=5
                        [/effect]
                        [effect]
                            apply_to=remove_ability
                            [abilities]
                                {ABILITY_SPARTAN_RANGED 4}
                            [/abilities]
                        [/effect]
                        [effect]
                            apply_to=new_ability
                            [abilities]
                                {ABILITY_SPARTAN_RANGED 5}
                            [/abilities]
                        [/effect]
                        [effect]
                            apply_to=attack
                            name=bow
                            remove_specials=hoplite_ranged
                            [set_specials]
                                mode=append
                                {HOPLITE_RANGED_MACRO_SHARED hoplite_summonedarcherII 5 0 "misc/targethex-archer.png" first ()}
                            [/set_specials]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [variable]
                    name=summonedarcherIII_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_summonedarcher_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=attack
                            name=bow
                            increase_damage=5
                        [/effect]
                        [effect]
                            apply_to=attack
                            name=sword
                            increase_damage=3
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [variable]
                    name=summonedarcherIV_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_summonedarcher_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=5
                            increase_total=5
                        [/effect]
                        [effect]
                            apply_to=remove_ability
                            [abilities]
                                {ABILITY_SPARTAN_RANGED 5}
                            [/abilities]
                        [/effect]
                        [effect]
                            apply_to=new_ability
                            [abilities]
                                {ABILITY_SPARTAN_RANGED 6}
                                {ABILITY_HOPLITE_LEAP_NONPLAYER 3}
                            [/abilities]
                        [/effect]
                        [effect]
                            apply_to=attack
                            name=bow
                            remove_specials=hoplite_ranged
                            [set_specials]
                                mode=append
                                {HOPLITE_RANGED_MACRO_SHARED hoplite_summonedarcherIV 6 0 "misc/targethex-archer.png" first ()}
                            [/set_specials]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [variable]
                    name=summonedarcherV_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_summonedarcher_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=5
                            increase_total=5
                        [/effect]
                        [effect]
                            apply_to=remove_ability
                            [abilities]
                                {ABILITY_HOPLITE_LEAP_NONPLAYER 3}
                            [/abilities]
                        [/effect]
                        [effect]
                            apply_to=new_ability
                            [abilities]
                                {ABILITY_HOPLITE_LEAP_NONPLAYER 1}
                            [/abilities]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [if]
                [variable]
                    name=summonedarcherVI_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_summonedarcher_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=hitpoints
                            increase=5
                            increase_total=5
                        [/effect]
                        [effect]
                            apply_to=attack
                            name=bow
                            increase_damage=5
                        [/effect]
                        [effect]
                            apply_to=attack
                            name=sword
                            increase_damage=2
                        [/effect]
                    [/object]
                [/then]
            [/if]
            #swimming upgrade applies to shadow clones/spirit archers
            [if]
                [variable]
                    name=swimming_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_summonedarcher_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=movement_costs
                            replace=yes
                            [movement_costs]
                                shallow_water=1
                                swamp_water=1
                            [/movement_costs]
                        [/effect]
                        #commented out, since it is no longer necessary
                        #            [effect]
                        #               apply_to=new_ability
                        #               [abilities]
                        #                   {ABILITY_HOPLITE_SWIMMER}
                        #               [/abilities]
                        #            [/effect]
                    [/object]
                [/then]
            [/if]
            #levitation upgrade applies to shadow clones/spirit archers
            [if]
                [variable]
                    name=levitation_unlocked$side_number
                    equals=yes
                [/variable]
                [then]
                    [object]
                        silent=yes
                        duration=forever
                        [filter]
                            ability=spartan_ally_owner_side$side_number
                            [and]
                                ability=spartan_summonedarcher_filter
                            [/and]
                        [/filter]
                        [effect]
                            apply_to=movement_costs
                            replace=yes
                            {SPARTAN_FLY_MOVESCOSTS}
                        [/effect]
                        [effect]
                            apply_to=new_animation
                            [standing_anim]
                                start_time=0
                                alpha=0.8~0.4:700,0.4~0.6:300,0.6~0.4:300,0.4~0.8:700
                                submerge=0.01
                                terrain_type=Q*^*,W*^*,S*^*
                                [frame]
                                    duration=2115
                                    image="units/human-loyalists/longbowman.png:4000"
                                    image_mod="~GS()~CS(-200,-40,-0)"
                                    y=1:255,0:150,-1:150,0:150,1:255,0:150,-1:150,0:150,1:255,0:150,-1:150,0:150
                                [/frame]
                            [/standing_anim]
                        [/effect]
                    [/object]
                [/then]
            [/if]
            [set_variable]
                name=clonesuccess
                value=yes
            [/set_variable]
            [fire_event]
                name=spartan_apply_leap_and_sluggish_manually
                [primary_unit]
                    x,y=$cloneloc.x,$cloneloc.y
                [/primary_unit]
            [/fire_event]
            {ELIZABETH_MAGIC_LINE clone_or_archer (
                [message]
                    speaker=Elizabeth
                    message=_"What sort of summoning magic is that, I've never seen it! Oh, you must absolutely show me how you do that later!"
                [/message]
            )}
            {ALGADUR_LINE clone_or_archer (
                [message]
                    speaker=Algadur
                    message=_"Havin' endless reinforcements would have made me battle against those orcs a whole lot different.."
                [/message]
                [message]
                    id=Hoplite,Hoplite2
                    side=$side_number
                    message=_"Alas, we cannot change the past, but we can avenge your fallen brothers!"
                [/message]
                [message]
                    speaker=Algadur
                    message=_"Hah, damn right, shield-brother! Let's show those foul creatures our combined might!"
                [/message]
            )}
            {GALATEA_ALLY_LINE clone_or_archer (
                [message]
                    speaker=Galatea
                    message=_"I've summoned all sorts of things in my time, but this seems pretty unique."
                [/message]
            )}
        [/then]
        [else]
            [print]
                text= _ "All adjacent hexes are occupied!"
                size=20
                red=255
                duration=2000
            [/print]
        [/else]
    )}
    {CLEAR_VARIABLE cloneloc}
#enddef

#define SPARTAN_APPLY_BURN DAMAGE FILTER ATTACKER_ID
    [store_unit]
        [filter]
            {FILTER}
        [/filter]
        variable=burn_store
        kill=no
    [/store_unit]

    [foreach]
        array=burn_store
        index_var=i
        [do]
            {IF_VAR this_item.variables.burn_damage greater_than_equal_to {DAMAGE} (
                [else]
                    [modify_unit]
                        [filter]
                            id=$this_item.id
                        [/filter]
                        {VARIABLE burn_damage {DAMAGE}}
                        {VARIABLE burn_applier_id {ATTACKER_ID}}
                    [/modify_unit]
                [/else]
            )}

            [if]
                [have_unit]
                    id=$this_item.id
                    ability=spartan_burning
                [/have_unit]
                [else]
                    [object]
                        silent=yes
                        duration=scenario
                        id=spartan_burn
                        take_only_once=no

                        [filter]
                            id=$this_item.id
                        [/filter]

                        [effect]
                            apply_to=new_ability
                            [abilities]
                                [dummy]
                                    id=spartan_burning
                                [/dummy]
                            [/abilities]
                        [/effect]
                        [effect]
                            apply_to=overlay
                            add="misc/overlay-burning.png"
                        [/effect]
                    [/object]
                [/else]
            [/if]
        [/do]
    [/foreach]

    {CLEAR_VARIABLE burn_store}
#enddef

#define SPARTAN_REMOVE_BURN FILTER
    [store_unit]
        [filter]
            {FILTER}
        [/filter]
        variable=unburn_store
        kill=no
    [/store_unit]

    [foreach]
        array=unburn_store
        index_var=i
        [do]
            [modify_unit]
                [filter]
                    id=$this_item.id
                [/filter]
                {CLEAR_VARIABLE burn_damage}
                {CLEAR_VARIABLE burn_applier_id}
            [/modify_unit]

            [if]
                [have_unit]
                    id=$this_item.id
                    ability=spartan_burning
                [/have_unit]
                [then]
                    [remove_object]
                        id=$this_item.id
                        object_id=spartan_burn
                    [/remove_object]
                [/then]
            [/if]
        [/do]
    [/foreach]

    {CLEAR_VARIABLE unburn_store}
#enddef

#this is a macro so that it's usable both for the enthrall menu AND the "apply enthrall buffs rectroactively" mechanic. using ability checks to prevent the same object being repeated on units
#define SPARTAN_APPLY_ENTHRALL_BUFFS FILTER OWNER_SIDE
    [object]
        silent=yes
        duration=forever
        [filter]
            {FILTER}
            [not]
                ability=hoplite_thrall
            [/not]
        [/filter]
        [effect]
            apply_to=halo
            halo="halo/elven/shyde-stationary-halo[1~6].png:150"
        [/effect]
        [effect]
            apply_to=new_ability
            [abilities]
                [dummy]
                    id=hoplite_thrall#for filtering
                [/dummy]
            [/abilities]
        [/effect]
        [effect]
            apply_to=new_ability
            [abilities]
                [dummy]
                    id=spartan_ally_owner_side{OWNER_SIDE}
                [/dummy]
            [/abilities]
        [/effect]
    [/object]

#using this hacky workaround with variables, since the upgrade is only actually set as unlocked AFTER upgrade effects are triggered, and therefore I cannot use a normal 'upgrade is unlocked' check for rectroactively applying the buffs to existing thralls in upgrade code

#    {IF_VAR enthrallII_unlocked{OWNER_SIDE} equals yes (
    {IF_VAR spartan_thrallbuff_enthrallII_{OWNER_SIDE} equals yes (
        [then]
            [object]
                silent=yes
                duration=forever
                [filter]
                    {FILTER}
                    [not]
                        ability=spartan_enthrall_regen
                    [/not]
                [/filter]
                [effect]
                    apply_to=hitpoints
                    increase_total=5
                [/effect]
                [effect]
                    apply_to=attack
                    increase_damage=2
                [/effect]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=spartan_enthrall_regen
                            name= _ "thrall regeneration +2"
                            female_name= _ "female^thrall regeneration +2"
                            description= _ "The unit will heal itself 2 HP per turn. This stacks with normal regeneration/healing abilities."
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/then]
    )}

#using this hacky workaround with variables, since the upgrade is only actually set as unlocked AFTER upgrade effects are triggered, and therefore I cannot use a normal 'upgrade is unlocked' check for rectroactively applying the buffs to existing thralls in upgrade code

#    {IF_VAR enthrallIII_unlocked{OWNER_SIDE} equals yes (
    {IF_VAR spartan_thrallbuff_enthrallIII_{OWNER_SIDE} equals yes (

        [then]
            [object]
                silent=yes
                duration=forever
                [filter]
                    {FILTER}
                    [not]
                        ability=spartan_dummy_thrall_buff_hp_mp
                    [/not]
                [/filter]
                [effect]
                    apply_to=hitpoints
                    increase_total=5
                [/effect]
                [effect]
                    apply_to=movement
                    increase=1
                [/effect]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=spartan_dummy_thrall_buff_hp_mp#for filtering
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/then]
    )}

#using this hacky workaround with variables, since the upgrade is only actually set as unlocked AFTER upgrade effects are triggered, and therefore I cannot use a normal 'upgrade is unlocked' check for rectroactively applying the buffs to existing thralls in upgrade code

#    {IF_VAR enthrallIV_unlocked{OWNER_SIDE} equals yes (
    {IF_VAR spartan_thrallbuff_enthrallIV_{OWNER_SIDE} equals yes (
        [then]
            [object]
                silent=yes
                duration=forever
                [filter]
                    {FILTER}
                    [not]
                        ability=spartan_dummy_thrall_buff_IV
                    [/not]
                [/filter]
                [effect]
                    apply_to=hitpoints
                    increase_total=5
                [/effect]
                [effect]
                    apply_to=attack
                    increase_damage=3
                [/effect]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=spartan_dummy_thrall_buff_IV#for filtering
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/then]
    )}
#enddef

#macro for forge_list.cfg

#define SPARTAN_APPLY_ENTHRALL_BUFFS_RETROACTIVELY OWNER_SIDE
    [store_unit]
        [filter]
            ability=hoplite_thrall
            [and]
                ability=spartan_ally_owner_side{OWNER_SIDE}
            [/and]
        [/filter]
        variable=tmp_hoplite_thralls_to_update
        kill=no
    [/store_unit]
    [foreach]
        array=tmp_hoplite_thralls_to_update
        index_var=i
        [do]
            {SPARTAN_APPLY_ENTHRALL_BUFFS (id=$this_item.id) {OWNER_SIDE}}
        [/do]
    [/foreach]
    {CLEAR_VARIABLE tmp_hoplite_thralls_to_update}
#enddef

#define SPARTAN_TARGET_SPELLS_MENU
                                    #storing the player to check spell radiuses
                                    [store_unit]
                                        [filter]
                                            id=Hoplite,Hoplite2
                                            side=$side_number
                                        [/filter]
                                        variable=tmp_casting_sorcerer
                                        kill=no
                                    [/store_unit]

#get lightning bolt attack index

{SPARTAN_RETURN_ATTACK_INDEX_BY_NAME tmp_casting_sorcerer lightningbolt}
{VARIABLE lightning_bolt_damage$side_number| $tmp_casting_sorcerer.attack[$tmp_index_return].damage}
{CLEAR_VARIABLE tmp_index_return}

                                    [message]
                                        speaker=narrator
                                        caption=_ "Hoplite spell menu"
                                        message=_ "Select a targeted spell to use:"
#ifdef MULTIPLAYER
                                        side_for=$side_number
#endif
                                        [option]
                                            image="attacks/blank-attack.png"
                                            description=_"Return to the Game"
                                            [command]
                                            [/command]
                                        [/option]

#NOTE: enemy-targeting spells should be grouped together with other enemy-targeting spells, summons spells should be grouped together with other summon spells on the list, etc.

                                        [option]
                                            image="attacks/lightning.png"
                                            description=_"<span color='#ffff99'>Lightning Bolt</span>: deal $lightning_bolt_damage$side_number|| fire damage to target enemy $lightning_bolt_extra_text$side_number||$lightning_bolt_chain_text$side_number||
    ends your turn
    Costs <span color='#ffff99'>75</span> energy
    Range: <span color='#ffff99'>unlimited</span>
    Target: <span color='#ffff99'>Enemy</span>
    Can only use this skill if you can still attack normally"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL spell_lightning_unlocked$side_number equals yes}
                                            [/show_if]
                                            [command]
                                                [if]
                                                    [have_unit]
                                                        [filter_side]
                                                            [enemy_of]
                                                                side=$side_number
                                                            [/enemy_of]
                                                        [/filter_side]
                                                        x,y=$x1,$y1
                                                        #[and]
                                                        #    [filter_location]
                                                        #        x,y=$tmp_casting_sorcerer.x,$tmp_casting_sorcerer.y
                                                        #        radius=99
                                                        #    [/filter_location]
                                                        #[/and]
                                                    [/have_unit]
                                                    [then]
                                                    [if]
                                                        [have_unit]
                                                            id=$tmp_casting_sorcerer.id
                                                            formula="attacks_left > 0"
                                                            [not]
                                                                ability=spartan_disable_player_ranged_attacks
                                                            [/not]
                                                        [/have_unit]
                                                        [then]

                                                        [if]
                                                        {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 75}
                                                        [then]
                                                        [floating_text]
                                                            x,y=$tmp_casting_sorcerer.x,$tmp_casting_sorcerer.y
                                                            text="<span color='#ffff99'>" + _ "Lightning Bolt" + "</span>"
                                                        [/floating_text]
                                                        #energy is spent BEFORE harm_unit, so the player can benefit from energy from kills properly
                                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -75}
                                                        #add lightning anims to the attacked unit
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$hoplite_enemyside
                                                                x,y=$x1,$y1
                                                            [/filter]
                                                            [effect]
                                                                apply_to=new_animation
                                                                [extra_anim]
                                                                    flag=hit_by_lightning
                                                                    start_time=-250
                                                                    missile_start_time=-250
                                                                    [missile_frame]
                                                                        halo=halo/lightning-bolt-1-[1~4].png:100
                                                                        halo_y=-125
                                                                        offset=0.0
                                                                        auto_vflip=no
                                                                    [/missile_frame]
                                                                    [frame]
                                                                        duration=400
                                                                        sound=lightning.ogg
                                                                    [/frame]
                                                                [/extra_anim]
                                                                [extra_anim]
                                                                    flag=hit_by_lightning
                                                                    start_time=-250
                                                                    missile_start_time=-250
                                                                    [missile_frame]
                                                                        halo=halo/lightning-bolt-2-[1~4].png:100
                                                                        halo_y=-125
                                                                        offset=0.0
                                                                        auto_vflip=no
                                                                    [/missile_frame]
                                                                    [frame]
                                                                        duration=400
                                                                        sound=lightning.ogg
                                                                    [/frame]
                                                                [/extra_anim]
                                                                [extra_anim]
                                                                    flag=hit_by_lightning
                                                                    start_time=-250
                                                                    missile_start_time=-250
                                                                    [missile_frame]
                                                                        halo=halo/lightning-bolt-3-[1~4].png:100
                                                                        halo_y=-125
                                                                        offset=0.0
                                                                        auto_vflip=no
                                                                    [/missile_frame]
                                                                    [frame]
                                                                        duration=400
                                                                        sound=lightning.ogg
                                                                    [/frame]
                                                                [/extra_anim]
                                                            [/effect]
                                                        [/object]

                                                        [animate_unit]
                                                            flag=hit_by_lightning
                                                            [filter]
                                                                side=$hoplite_enemyside
                                                                x,y=$x1,$y1
                                                            [/filter]
                                                        [/animate_unit]
                                                        {SPARTAN_CALCULATE_DAMAGE tmp_casting_sorcerer $lightning_bolt_damage$side_number||}
                                                        #this variable is used inside the die event for an achievement
                                                        {VARIABLE tmp_enemy_killed_by_lightning_bolt_spell yes}
                                                        {SPARTAN_HIT_BOSS_KILLSTREAK_AND_ENERGY $side_number (x,y=$x1,$y1)}
                                                        {SPARTAN_ATTACKER_UNCOVER_INVISIBILITY id=$tmp_casting_sorcerer.id}
                                                        [spartan_harm_unit]
                                                            [filter]
                                                                side=$hoplite_enemyside
                                                                x,y=$x1,$y1
                                                            [/filter]
                                                            [filter_second]
                                                                id=$tmp_casting_sorcerer.id
                                                            [/filter_second]
                                                            amount=$tmp_spartan_calculated_damage
                                                            damage_type=fire
                                                            fire_event=yes
                                                            animate=defender
                                                            delay=0
                                                            experience=yes
                                                        [/spartan_harm_unit]
                                                        {CLEAR_VARIABLE tmp_enemy_killed_by_lightning_bolt_spell}
                                                        {IF_VAR lightning_slow_unlocked$side_number equals yes (
                                                        [then]
                                                            [modify_unit]
                                                                [filter]
                                                                    side=$hoplite_enemyside
                                                                    x,y=$x1,$y1
                                                                [/filter]
                                                                [status]
                                                                    slowed=yes
                                                                [/status]
                                                            [/modify_unit]
                                                        [/then]
                                                        )}

                                                        [if]
                                                        {VARIABLE_CONDITIONAL lightning_chain_unlocked$side_number equals yes}
                                                        [then]
                                                            {VARIABLE tmp_chainlightning_chain_damage $lightning_bolt_damage$side_number||}

                                                            #manually multiply this for the first chain, since after that chain attack damage is multiplied at the end of the chain attack
                                                            {VARIABLE_OP tmp_chainlightning_chain_damage multiply $lightning_bolt_chain_damagemult$side_number}
                                                            {VARIABLE tmp_chain_lightning_chain_position.x $x1}
                                                            {VARIABLE tmp_chain_lightning_chain_position.y $y1}

                                                            #make sure the target of the spell cannot be hit by chain lightning

                                                            [store_locations]
                                                                x,y=$x1,$y1
                                                                variable=tmp_chainlightning_tiles_already_hit
                                                                include_borders=no
                                                                mode=append
                                                            [/store_locations]

                                                            [while]
                                                                {VARIABLE_CONDITIONAL tmp_chainlightning_chain_damage greater_than_equal_to 5}
                                                                [do]
                                                                    [store_unit]
                                                                        [filter]
                                                                            side=$hoplite_enemyside
                                                                            [filter_location]
                                                                                [not]
                                                                                    find_in=tmp_chainlightning_tiles_already_hit
                                                                                [/not]
                                                                                [and]
                                                                                    x=$tmp_chain_lightning_chain_position.x
                                                                                    y=$tmp_chain_lightning_chain_position.y
                                                                                    radius=1
                                                                                [/and]
                                                                            [/filter_location]
                                                                        [/filter]
                                                                        variable=chainlightning_targets
                                                                        kill=no
                                                                    [/store_unit]

                                                                    [if]
                                                                    {VARIABLE_CONDITIONAL chainlightning_targets.length greater_than 0}
                                                                    [then]

                                                                    {VARIABLE_OP chainlightning_index rand 0.."$($chainlightning_targets.length - 1)"}


                                                                    #add lightning anims to the attacked unit
                                                                    [object]
                                                                        silent=yes
                                                                        duration=turn end
                                                                        [filter]
                                                                            id=$chainlightning_targets[$chainlightning_index].id
                                                                        [/filter]
                                                                        [effect]
                                                                            apply_to=new_animation
                                                                            [extra_anim]
                                                                                flag=hit_by_chainlightning
                                                                                start_time=-100
                                                                                missile_start_time=-100
                                                                                missile2_start_time=-100
                                                                                missile3_start_time=-100
                                                                                #[missile_frame]
                                                                                #    halo=halo/lightning-bolt-1-[1~4].png:100
                                                                                #    halo_y=-125
                                                                                #    offset=0.0
                                                                                #    auto_vflip=no
                                                                                #[/missile_frame]
                                                                                [missile2_frame]
                                                                                    duration=600
                                                                                    halo="halo/undead/idle-flash-[1~21].png"
                                                                                    halo_mod=~GS()~G(128)~B(255)
                                                                                    halo_x=-12
                                                                                    offset=0.0
                                                                                [/missile2_frame]
                                                                                [missile3_frame]
                                                                                    duration=600
                                                                                    halo="halo/undead/idle-flash-[1~21].png~FL(horiz)~FL(vert)"
                                                                                    halo_mod=~GS()~G(128)~B(255)
                                                                                    halo_x=12
                                                                                    offset=0.0
                                                                                [/missile3_frame]
                                                                                [frame]
                                                                                    duration=400
                                                                                    sound=lightning-miss.ogg
                                                                                [/frame]
                                                                            [/extra_anim]
                                                                        [/effect]
                                                                    [/object]
            
                                                                    [animate_unit]
                                                                        flag=hit_by_chainlightning
                                                                        [filter]
                                                                            id=$chainlightning_targets[$chainlightning_index].id
                                                                        [/filter]
                                                                    [/animate_unit]
                                                                    {SPARTAN_CALCULATE_DAMAGE tmp_casting_sorcerer $tmp_chainlightning_chain_damage}
                                                                    #this variable is used inside the die event for an achievement
                                                                    {VARIABLE tmp_enemy_killed_by_lightning_bolt_spell yes}
                                                                    [spartan_harm_unit]
                                                                        [filter]
                                                                            id=$chainlightning_targets[$chainlightning_index].id
                                                                        [/filter]
                                                                        [filter_second]
                                                                            id=$tmp_casting_sorcerer.id
                                                                        [/filter_second]
                                                                        amount=$tmp_spartan_calculated_damage
                                                                        damage_type=fire
                                                                        fire_event=yes
                                                                        animate=defender
                                                                        delay=0
                                                                        experience=yes
                                                                    [/spartan_harm_unit]
                                                                    {CLEAR_VARIABLE tmp_enemy_killed_by_lightning_bolt_spell}

                                                                    #chain lightning chain position is now moved to the attacked unit's position. and damage is multiplied again

                                                                    {VARIABLE tmp_chain_lightning_chain_position.x $chainlightning_targets[$chainlightning_index].x}
                                                                    {VARIABLE tmp_chain_lightning_chain_position.y $chainlightning_targets[$chainlightning_index].y}
                                                                    {VARIABLE_OP tmp_chainlightning_chain_damage multiply $lightning_bolt_chain_damagemult$side_number}


                                                                    #make sure enemies cannot be hit by chain lightning repeatedly
        
                                                                    [store_locations]
                                                                        x,y=$chainlightning_targets[$chainlightning_index].x,$chainlightning_targets[$chainlightning_index].y
                                                                        variable=tmp_chainlightning_tiles_already_hit
                                                                        include_borders=no
                                                                        mode=append
                                                                    [/store_locations]

                                                                    {CLEAR_VARIABLE chainlightning_targets}
                                                                    {CLEAR_VARIABLE chainlightning_index}
                                                                    [/then]
                                                                    [else]
                                                                        #if there are no units to chain, end the while loop by setting the damage number to 0
                                                                        {VARIABLE tmp_chainlightning_chain_damage 0}
                                                                    [/else]
                                                                    [/if]
                                                                [/do]
                                                            [/while]                                                            

                                                            {CLEAR_VARIABLE tmp_chainlightning_chain_damage}
                                                        [/then]
                                                        [/if]

                                                        {CLEAR_VARIABLE tmp_spartan_calculated_damage}
                                                        {CLEAR_VARIABLE tmp_chainlightning_tiles_already_hit}

                                                        {ELIZABETH_MAGIC_LINE lightningbolt (
                                                            [message]
                                                                speaker=Elizabeth
                                                                message=_"I read that the legendary Delfador the Great himself used lightning magic quite often back in his day. Maybe you might become Sparta's own Delfador too."
                                                            [/message]
                                                        )}
                                                        {GALATEA_ALLY_LINE lightningbolt (
                                                            [message]
                                                                speaker=Galatea
                                                                message=_"Quite an effective spell! Once we cross paths with the Merchant again, you should zap that bastard with it!"
                                                            [/message]
                                                        )}

                                                        #manually subtract attacks_left, so that it counts as an attack for Rest upgrades

                                                        {MODIFY_UNIT id=$tmp_casting_sorcerer.id attacks_left "$($tmp_casting_sorcerer.attacks_left - 1)"}

                                                        [end_turn]
                                                        [/end_turn]

                                                        [/then]
                                                        [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                        [/else]
                                                        [/if]
                                                        [/then]
                                                        [else]
                                                            [print]
                                                                text= _ "Cannot attack now!"
                                                                size=20
                                                                red=255
                                                                duration=2000
                                                            [/print]
                                                        [/else]
                                                    [/if]

                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not a valid target!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="icons/horror-eerie-$curse_fear_icon_number$side_number||.png"
                                            description=_"<span color='#ffff99'>Curse of Fear</span>: target enemy gains the 'terrified' ability for 1 turn
    (runs away when near player or allies)
    Cooldown: <span color='#ffff99'>$curse_fear_max_cooldown$side_number||</span> turns per charge
    Range: <span color='#ffff99'>$curse_fear_range$side_number||</span>
    Target: <span color='#ffff99'>Enemy</span>
    Spell Charges: <span color='#ffff99'>$curse_fear_charges$side_number||</span>/$curse_fear_max_charges$side_number||
    Costs 1 charge to use (2 on bosses)"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL spell_curse_fear_unlocked$side_number equals yes}
                                            [/show_if]
                                            [command]
                                                [if]
                                                    [have_unit]
                                                        [filter_side]
                                                            [enemy_of]
                                                                side=$side_number
                                                            [/enemy_of]
                                                        [/filter_side]
                                                        x,y=$x1,$y1
                                                        [and]
                                                            [filter_location]
                                                                x,y=$tmp_casting_sorcerer.x,$tmp_casting_sorcerer.y
                                                                radius=$curse_fear_range$side_number
                                                            [/filter_location]
                                                        [/and]
                                                        [not]
                                                            ability=spartan_terrified
                                                        [/not]
                                                    [/have_unit]
                                                    [then]
                                                        #using curse of fear on bosses doubles the cooldown
                                                        [if]
                                                        [have_unit]
                                                            x,y=$x1,$y1
                                                            ability=hoplite_boss
                                                        [/have_unit]
                                                        [then]
                                                            {VARIABLE tmp_curse_of_fear_charge_cost 2}
                                                        [/then]
                                                        [else]
                                                            {VARIABLE tmp_curse_of_fear_charge_cost 1}
                                                        [/else]
                                                        [/if]

                                                        [if]
                                                        #only usable if the spell has enough charges
                                                        {VARIABLE_CONDITIONAL curse_fear_charges$side_number greater_than_equal_to $tmp_curse_of_fear_charge_cost}
                                                        [then]
                                                        #[floating_text]
                                                        #    x,y=$tmp_casting_sorcerer.x,$tmp_casting_sorcerer.y
                                                        #    text="<span color='#ffff99'>" + _ "Curse of Fear" + "</span>"
                                                        #[/floating_text]
                                                        #show message on the target
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#c800ff'>" + _ "Curse of Fear" + "</span>"
                                                        [/floating_text]
                                                        [sound]
                                                            name={SOUND_LIST:LICH_HIT}
                                                        [/sound]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$hoplite_enemyside
                                                                x,y=$x1,$y1
                                                            [/filter]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    {ABILITY_SPARTAN_TERRIFIED}
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        {VARIABLE_OP curse_fear_charges$side_number sub $tmp_curse_of_fear_charge_cost}
                                                        {VARIABLE curse_fear_cooldown$side_number $curse_fear_max_cooldown$side_number}
#                                                        {VARIABLE curse_fear_cooldown_text$side_number $curse_fear_cooldown$side_number}


                                                        [if]
                                                        [have_unit]
                                                            x,y=$x1,$y1
                                                            ability=hoplite_boss
                                                        [/have_unit]
                                                        [then]
                                                            {ACHIEVEMENT_MESSAGE_LONE curseoffear_boss $side_number}
                                                        [/then]
                                                        [/if]

                                                        {ELIZABETH_MAGIC_LINE curseoffear (
                                                            [message]
                                                                speaker=Elizabeth
                                                                message=_"Curses aren't really my specialty, but I must admit it's fun seeing our foes running away."
                                                            [/message]
                                                        )}

                                                        {GALATEA_ALLY_LINE curseoffear (
                                                            [message]
                                                                speaker=Galatea
                                                                message=_"Yes, tremble before the mighty $protagonist_name$side_number||!"
                                                            [/message]
                                                        )}

                                                        [/then]
                                                        [else]
                                                        [print]
                                                            text= _ "Not enough charges!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                        [/else]
                                                        [/if]
                                                    [/then]
                                                    [else]
                                                        #if the enemy is ALMOST a valid target but is already terrified, show a slightly different message:
                                                        [if]
                                                        [have_unit]
                                                            [filter_side]
                                                                [enemy_of]
                                                                    side=$side_number
                                                                [/enemy_of]
                                                            [/filter_side]
                                                            x,y=$x1,$y1
                                                            [and]
                                                                [filter_location]
                                                                    x,y=$tmp_casting_sorcerer.x,$tmp_casting_sorcerer.y
                                                                    radius=$curse_fear_range$side_number
                                                                [/filter_location]
                                                            [/and]
                                                            ability=spartan_terrified
                                                        [/have_unit]
                                                        [then]
                                                        [print]
                                                            text= _ "Target is already terrified!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                        [/then]
                                                        [else]
                                                        [print]
                                                            text= _ "Not a valid target!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                        [/else]
                                                        [/if]
                                                    [/else]
                                                [/if]
                                                {CLEAR_VARIABLE tmp_curse_of_fear_charge_cost}
                                            [/command]
                                        [/option]
                                        [option]
                                            image="icons/fireguardian.png"
                                            description=_"<span color='#ffff99'>Summon Fire Guardian</span>: summon an allied Fire Guardian
    costs <span color='#ffff99'>50</span> energy
    Range: <span color='#ffff99'>$fireguardian_summon_range$side_number||</span>
    Target: <span color='#ffff99'>Empty tile</span>"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL spell_fireguardian_unlocked$side_number equals yes}
                                            [/show_if]
                                            [command]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 50}
                                                    [then]

                                                    [if]
                                                        [have_location]
                                                            x,y=$x1,$y1
                                                            [not]
                                                                terrain={SPARTAN_WALL_TERRAIN}
                                                            [/not]
                                                        [/have_location]
                                                        #only empty tiles are valid targets for summoning
                                                        [and]
                                                            [not]
                                                                [have_unit]
                                                                    x,y=$x1,$y1
                                                                [/have_unit]
                                                            [/not]
                                                        [/and]
                                                        [and]
                                                        [have_location]
                                                            x,y=$x1,$y1
                                                            [and]
                                                                x,y=$tmp_casting_sorcerer.x,$tmp_casting_sorcerer.y
                                                                radius=$fireguardian_summon_range$side_number
                                                            [/and]
                                                        [/have_location]
                                                        [/and]
                                                        [then]

                                                        #[store_locations]
                                                        #    [and]
                                                        #        #now fire guardian is a targeted spell instead of skill
                                                        #        #[filter]
                                                        #            x,y=$x1,$y1
                                                        #        #[/filter]
                                                        #        #radius=1
                                                        #    [/and]
                                                        #    [and]
                                                        #        terrain={SPARTAN_UNITSPAWN_TERRAIN}
                                                        #    [/and]
                                                        #    [not]
                                                        #        [filter]
                                                        #        [/filter]
                                                        #    [/not]
                                                        #    include_borders=no
                                                        #    variable=fireguardianloc
                                                        #[/store_locations]
                                                        #{IF_VAR fireguardianloc.length greater_than 0 (
                                                        #    [then]
                                                                [sound]
                                                                    name=fire.wav
                                                                [/sound]
                                                                [unit]
                                                                    side=$hoplite_allyside
                                                                    type=Hoplite_Fireguardian
                                                                    #x,y=$fireguardianloc.x,$fireguardianloc.y
                                                                    x,y=$x1,$y1
                                                                    animate=yes
                                                                    placement=map
                                                                    passable=yes
                                                                    [modifications]
                                                                        [object]
                                                                            silent=yes
                                                                            [effect]
                                                                                apply_to=new_ability
                                                                                [abilities]
                                                                                    [dummy]
                                                                                        id=spartan_ally_owner_side$side_number
                                                                                    [/dummy]
                                                                                [/abilities]
                                                                            [/effect]
                                                                        [/object]
                                                                        #temporary ability to buff only the latest fire guardian
                                                                        [object]
                                                                            silent=yes
                                                                            duration=turn
                                                                            [effect]
                                                                                apply_to=new_ability
                                                                                [abilities]
                                                                                    [dummy]
                                                                                        id=spartan_fireguardian_filter#replaces the cloneloc coordinate check
                                                                                    [/dummy]
                                                                                [/abilities]
                                                                            [/effect]
                                                                        [/object]
                                                                    [/modifications]
                                                                [/unit]
                                                                [if]
                                                                    [variable]
                                                                        name=fireguardianII_unlocked$side_number
                                                                        equals=yes
                                                                    [/variable]
                                                                    [then]
                                                                        [object]
                                                                            silent=yes
                                                                            duration=forever
                                                                            [filter]
                                                                                ability=spartan_ally_owner_side$side_number
                                                                                [and]
                                                                                    ability=spartan_fireguardian_filter
                                                                                [/and]
                                                                            [/filter]
                                                                            [effect]
                                                                                apply_to=hitpoints
                                                                                increase=5
                                                                                increase_total=5
                                                                            [/effect]
                                                                        [/object]
                                                                    [/then]
                                                                [/if]
                                                                [if]
                                                                    [variable]
                                                                        name=fireguardianIII_unlocked$side_number
                                                                        equals=yes
                                                                    [/variable]
                                                                    [then]
                                                                        [object]
                                                                            silent=yes
                                                                            duration=forever
                                                                            [filter]
                                                                                ability=spartan_ally_owner_side$side_number
                                                                                [and]
                                                                                    ability=spartan_fireguardian_filter
                                                                                [/and]
                                                                            [/filter]
                                                                            [effect]
                                                                                apply_to=attack
                                                                                increase_damage=2
                                                                            [/effect]
                                                                            [effect]
                                                                                apply_to=hitpoints
                                                                                increase=5
                                                                                increase_total=5
                                                                            [/effect]
                                                                        [/object]
                                                                    [/then]
                                                                [/if]
                                                                #remove the temporary ability from the unit, to avoid bugs when summoning multiple fire guardians in one turn
                                                                [object]
                                                                    silent=yes
                                                                    duration=turn
                                                                    [filter]
                                                                        ability=spartan_ally_owner_side$side_number
                                                                        [and]
                                                                            ability=spartan_fireguardian_filter
                                                                        [/and]
                                                                    [/filter]                                                                    
                                                                    [effect]
                                                                        apply_to=remove_ability
                                                                        [abilities]
                                                                            [dummy]
                                                                                id=spartan_fireguardian_filter#replaces the cloneloc coordinate check
                                                                            [/dummy]
                                                                        [/abilities]
                                                                    [/effect]
                                                                [/object]
                                                                [set_variable]
                                                                    name=fireguardiansuccess
                                                                    value=yes
                                                                [/set_variable]
                                                            [/then]
                                                            [else]
                                                                [print]
                                                                    #now fire guardian is a targeted spell instead of skill
                                                                    #text= _ "All adjacent hexes are occupied!"
                                                                    text= _ "Not a valid target!"
                                                                    size=20
                                                                    red=255
                                                                    duration=2000
                                                                [/print]
                                                            [/else]
                                                        [/if]
#                                                        )}
                                                        {CLEAR_VARIABLE fireguardianloc}
                                                        [if]
                                                            [variable]
                                                                name=fireguardiansuccess
                                                                equals=yes
                                                            [/variable]
                                                            [then]
                                                                [floating_text]
                                                                    x,y=$tmp_casting_sorcerer.x,$tmp_casting_sorcerer.y
                                                                    text="<span color='#ffff99'>" + _ "Fire Guardian" + "</span>"
                                                                [/floating_text]

                                                                #[floating_text]
                                                                #    x,y=$x1,$y1
                                                                #    text="<span color='#ffff99'>" + _ "Fire Guardian" + "</span>"
                                                                #[/floating_text]
                                                                {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -50}
                                                                {ELIZABETH_MAGIC_LINE fireguardian (
                                                                    [message]
                                                                        speaker=Elizabeth
                                                                        message=_"Ah, good old Fire Guardians. Simple but effective."
                                                                    [/message]
                                                                )}
                                                                {ALGADUR_LINE fireguardian (
                                                                    [message]
                                                                        speaker=Algadur
                                                                        message=_"Fire Guardians eh? Fought those things in the caves before, good to have them on our side for once."
                                                                    [/message]
                                                                )}
                                                                {GALATEA_ALLY_LINE fireguardian (
                                                                    [message]
                                                                        speaker=Galatea
                                                                        message=_"Not bad. The fire guardians can be rather effective in numbers."
                                                                    [/message]
                                                                )}
                                                            [/then]
                                                        [/if]
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                {CLEAR_VARIABLE fireguardiansuccess}
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/twister.png"
                                            description=_"<span color='#ffff99'>Sandstorm</span>: summon a $sandstorm_type_text$side_number||
    If you already have a summoned $sandstorm_type_text$side_number||, it is destroyed before the new one is spawned
    Aims its attack on the same turn as summoned
    Costs <span color='#ffff99'>75</span> energy
    Range: <span color='#ffff99'>$sandstorm_range$side_number||</span>
    Target: <span color='#ffff99'>Empty tile</span>"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL spell_sandstorm_unlocked$side_number equals yes}
                                            [/show_if]
                                            [command]
                                                [if]
                                                    [have_location]
                                                        x,y=$x1,$y1
                                                        [not]
                                                            terrain={SPARTAN_WALL_TERRAIN}
                                                        [/not]
                                                    [/have_location]
                                                    #only empty tiles are valid targets for summoning
                                                    [and]
                                                        [not]
                                                            [have_unit]
                                                                x,y=$x1,$y1
                                                            [/have_unit]
                                                        [/not]
                                                    [/and]
                                                    [and]
                                                    [have_location]
                                                        x,y=$x1,$y1
                                                        [and]
                                                            x,y=$tmp_casting_sorcerer.x,$tmp_casting_sorcerer.y
                                                            radius=$sandstorm_range$side_number
                                                        [/and]
                                                    [/have_location]
                                                    [/and]
                                                    [then]
                                                        [if]
                                                        {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 75}
                                                        [then]
                                                                [floating_text]
                                                                    x,y=$tmp_casting_sorcerer.x,$tmp_casting_sorcerer.y
                                                                    text="<span color='#ffff99'>" + _ "Sandstorm" + "</span>"
                                                                [/floating_text]

                                                                #destroy existing sandstorm when summoning a new one (so you can only have one at a time but without a "only usable once per depth" limit)

                                                                [kill]
                                                                    ability=spartan_sandstorm_summon$side_number
                                                                    animate=yes
                                                                    fire_event=yes
                                                                [/kill]

                                                                #hacky workaround since the [kill] did not seem to clear the hexes properly despite having a die event for it

                                                                [fire_event]
                                                                    id=hoplite_clear_targethexes
                                                                [/fire_event]

                                                                [sound]
                                                                    name=windsweep.ogg
                                                                [/sound]
                                                                [unit]
                                                                    side=$hoplite_allyside
                                                                    type=$sandstorm_type$side_number
                                                                    x,y=$x1,$y1
                                                                    animate=yes
                                                                    placement=map
                                                                    passable=yes
                                                                    [modifications]
                                                                        [object]
                                                                            silent=yes
                                                                            [effect]
                                                                                apply_to=new_ability
                                                                                [abilities]
                                                                                    [dummy]
                                                                                        id=spartan_ally_owner_side$side_number
                                                                                    [/dummy]
                                                                                    #for despawning
                                                                                    [dummy]
                                                                                        id=spartan_sandstorm_summon$side_number
                                                                                    [/dummy]
                                                                                [/abilities]
                                                                            [/effect]
                                                                        [/object]
                                                                    [/modifications]
                                                                [/unit]
                                                                [if]
                                                                    [variable]
                                                                        name=sandstormII_unlocked$side_number
                                                                        equals=yes
                                                                    [/variable]
                                                                    [then]
                                                                        [object]
                                                                            silent=yes
                                                                            duration=forever
                                                                            [filter]
                                                                                x,y=$x1,$y1
                                                                                ability=spartan_ally_owner_side$side_number
                                                                                #this is intentionally NOT $sandstorm_type$side_number
                                                                                #that way the hp buff only applies while the player does not have Sandstorm III, since Sand Tornado gains a pretty big stat buff compared to lvl2 as is
                                                                                type=Hoplite_Dust_Devil
                                                                            [/filter]
                                                                            [effect]
                                                                                apply_to=hitpoints
                                                                                increase=10
                                                                                increase_total=10
                                                                            [/effect]
                                                                        [/object]
                                                                    [/then]
                                                                [/if]
                                                                [if]
                                                                    [variable]
                                                                        name=sandstormIV_unlocked$side_number
                                                                        equals=yes
                                                                    [/variable]
                                                                    [then]
                                                                        [object]
                                                                            silent=yes
                                                                            duration=forever
                                                                            [filter]
                                                                                x,y=$x1,$y1
                                                                                ability=spartan_ally_owner_side$side_number
                                                                            [/filter]
                                                                            [effect]
                                                                                apply_to=hitpoints
                                                                                increase=10
                                                                                increase_total=10
                                                                            [/effect]
                                                                        [/object]
                                                                    [/then]
                                                                [/if]
                                                                [if]
                                                                    [variable]
                                                                        name=sandstorm_damage_unlocked$side_number
                                                                        equals=yes
                                                                    [/variable]
                                                                    [then]
                                                                        [object]
                                                                            silent=yes
                                                                            duration=forever
                                                                            [filter]
                                                                                x,y=$x1,$y1
                                                                                ability=spartan_ally_owner_side$side_number
                                                                            [/filter]
                                                                            [effect]
                                                                                apply_to=attack
                                                                                name=pull
                                                                                increase_damage=5
                                                                            [/effect]
                                                                        [/object]
                                                                    [/then]
                                                                [/if]
                                                                [store_unit]
                                                                    [filter]
                                                                        x,y=$x1,$y1
                                                                        ability=spartan_ally_owner_side$side_number
                                                                    [/filter]
                                                                    variable=tmp_summoned_sandstorm
                                                                    kill=no
                                                                [/store_unit]

                                                                #force sandstorm to aim instantly, to make it more useful

                                                                {SPARTAN_RANGED_AIM tmp_summoned_sandstorm}

                                                                {CLEAR_VARIABLE tmp_summoned_sandstorm}

                                                                {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -75}

                                                                {ELIZABETH_MAGIC_LINE sandstorm (
                                                                    [message]
                                                                        speaker=Elizabeth
                                                                        message=_"Sand elementals? Not as deadly as good ol' fire guardians, but it's a good distraction."
                                                                    [/message]
                                                                )}

                                                                {GALATEA_ALLY_LINE sandstorm (
                                                                    [message]
                                                                        speaker=Galatea
                                                                        message=_"I used to have some sand elementals in my army before. You being able to summon them will prove useful."
                                                                    [/message]
                                                                )}

                                                        [/then]
                                                        [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                        [/else]
                                                        [/if]
                                                
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not a valid target!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                    [/message]
                                    {CLEAR_VARIABLE tmp_casting_sorcerer}
#enddef

#define SPARTAN_UPGRADE_EVENTS
    [event]
#now triggers on hit instead of attack end, since the player can now be pushed with knockback counterattacks!
#        name=attack_end
        name=attacker_hits
        id=hoplite_hitandrun_event
        first_time_only=no
        [filter]
            side=$hoplite_playerside
        [/filter]
        [filter_attack]
            special_id=hoplite_hitandrun
        [/filter_attack]
        #removes leaping/teleporting, to prevent it being usable for free with hit-and-run
        [if]
            [have_unit]
#important: the $x1,$y1 checks were replaced by $unit.id checks since the player can now be pushed by a few units in defense!!!
#                x,y=$x1,$y1
                id=$unit.id
                ability=hoplite_leap
                [or]
#                    x,y=$x1,$y1
                    id=$unit.id
                    ability=hoplite_teleport
                [/or]
            [/have_unit]
            [then]
                [object]
                    silent=yes
                    duration=turn end
                    [filter]
#                        x,y=$x1,$y1
                        id=$unit.id
                    [/filter]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            {ABILITY_LEAPING2}
                            {ABILITY_HOPLITE_TELEPORTING}
                        [/abilities]
                    [/effect]
                [/object]
            [/then]
        [/if]
        {MODIFY_UNIT id=$unit.id moves 1}
    [/event]
    [event]
        name=side 1 turn end
        first_time_only=no
        {CHATMSG "rest event"}
        #    {IF_VAR rest_unlocked equals yes (
        #    [or]
        #    [variable]
        #      name=rest_unlocked1
        #      equals=yes
        #    [/variable]
        #    [/or]
        #        [then]
        [store_unit]
            [filter]
                id=Hoplite
                side=$side_number
            [/filter]
            variable=hoplite_rest
            kill=no
        [/store_unit]
        [if]
            [variable]
                name=hoplite_rest.moves
                greater_than=0
            [/variable]
            [and]
                [variable]
                    name=hoplite_rest.attacks_left
                    greater_than=0
                [/variable]
                #this is mainly used for Persuasive Pacifist pact, so Rest can still work despite attacks_left being set to 0
                [or]
                    [have_unit]
                        id=Hoplite
                        side=$side_number
                        ability=spartan_rest_ignore_no_attacks_left
                    [/have_unit]
                [/or]
            [/and]
            [then]
                {VARIABLE hoplite_still yes}
                {IF_VAR shieldwall_unlocked1 equals yes (
                    [then]
                        {VARIABLE shieldup_id Hoplite}
                        [fire_event]
                            id=hoplite_shieldup
                        [/fire_event]
                        {CLEAR_VARIABLE shieldup_id}
                    [/then])}

                    {IF_VAR spear_counter_unlocked$side_number equals yes (
                        [then]
                            [object]
                                silent=yes
                                duration=turn
                                [filter]
                                    id=Hoplite,Hoplite2
                                    side=$side_number
                                [/filter]
                                [effect]
                                    apply_to=attack
                                    name=spear
                                    defense_weight=1.0
                                    [set_specials]
                                        mode=append
                                        {SPECIAL_HOPLITE_COUNTERATTACK}
                                    [/set_specials]
                                [/effect]
                            [/object]
                        [/then]
                    )}
                [/then]
            [/if]
            #        [/then]
            #    )}
            {CLEAR_VARIABLE hoplite_usedportal}
            {CLEAR_VARIABLE hoplite_rest}
        [/event]
#ifdef MULTIPLAYER
        [event]
            name=side 2 turn end
            first_time_only=no
            {CHATMSG "rest event 2"}
            #    {IF_VAR rest_unlocked equals yes (
            #    [or]
            #    [variable]
            #      name=rest_unlocked2
            #      equals=yes
            #    [/variable]
            #    [/or]
            #        [then]
            [store_unit]
                [filter]
                    id=Hoplite2
                    side=$side_number
                [/filter]
                variable=hoplite_rest2
                kill=no
            [/store_unit]
            [if]
                [variable]
                    name=hoplite_rest2.moves
                    greater_than=0
                [/variable]
                [and]
                    [variable]
                        name=hoplite_rest2.attacks_left
                        greater_than=0
                    [/variable]
                    #this is mainly used for Persuasive Pacifist pact, so Rest can still work despite attacks_left being set to 0
                    [or]
                        [have_unit]
                            id=Hoplite2
                            side=$side_number
                            ability=spartan_rest_ignore_no_attacks_left
                        [/have_unit]
                    [/or]
                [/and]
                [then]
                    {VARIABLE hoplite_still2 yes}
                    {IF_VAR shieldwall_unlocked2 equals yes (
                        [then]
                            {VARIABLE shieldup_id Hoplite2}
                            [fire_event]
                                id=hoplite_shieldup
                            [/fire_event]
                            {CLEAR_VARIABLE shieldup_id}
                        [/then])}

                        {IF_VAR spear_counter_unlocked$side_number equals yes (
                            [then]
                                [object]
                                    silent=yes
                                    duration=turn
                                    [filter]
                                        id=Hoplite,Hoplite2
                                        side=$side_number
                                    [/filter]
                                    [effect]
                                        apply_to=attack
                                        name=spear
                                        defense_weight=1.0
                                        [set_specials]
                                            mode=append
                                            {SPECIAL_HOPLITE_COUNTERATTACK}
                                        [/set_specials]
                                    [/effect]
                                [/object]
                            [/then]
                        )}
                    [/then]
                [/if]
                #        [/then]
                #    )}
                {CLEAR_VARIABLE hoplite_usedportal}
                {CLEAR_VARIABLE hoplite_rest2}
            [/event]
#endif
            [event]
                name=side {SPARTAN_ALLY_SIDE} turn
                first_time_only=no
                {CHATMSG "rat_legion event"}
#cooldown is now handled by a foreach loop in misc_events.cfg
#                {VARIABLE_OP rat_cooldown1 sub 1}
#                [if]
#                    [have_unit]
#                        id=Hoplite2
#                    [/have_unit]
#                    [then]
#                        {VARIABLE_OP rat_cooldown2 sub 1}
#                    [/then]
#                [/if]
                {IF_VAR rat_legion_unlocked1 equals yes (
                    [and]
                        [variable]
                            name=rat_cooldown1
                            less_than=1
                        [/variable]
                    [/and]
                    [then]
                        [sound]
                            name={SOUND_LIST:BAT_HIT}
                        [/sound]

                        {SCATTER_UNITS 1 Hoplite_Giantrat_ally 1 (
                            terrain={SPARTAN_UNITSPAWN_TERRAIN}
                            [not]
                                [filter]
                                [/filter]
                                radius=1
                            [/not]
                        ) (
                            side=$hoplite_allyside
                            [modifications]
                                [object]
                                    silent=yes
                                    [effect]
                                        apply_to=new_ability
                                        [abilities]
                                            [dummy]
                                                id=spartan_ally_owner_side1
                                            [/dummy]
                                        [/abilities]
                                    [/effect]
                                [/object]
                            [/modifications]
                        )}

                        [set_variable]
                            name=rat_cooldown1
                            value=4
                        [/set_variable]
                        [/then]
                    )}
                    {IF_VAR rat_legion_unlocked2 equals yes (
                        [and]
                            [variable]
                                name=rat_cooldown2
                                less_than=1
                            [/variable]
                        [/and]
                        [then]
                            [sound]
                                name={SOUND_LIST:BAT_HIT}
                            [/sound]

                            {SCATTER_UNITS 1 Hoplite_Giantrat_ally 1 (
                                terrain={SPARTAN_UNITSPAWN_TERRAIN}
                                [not]
                                    [filter]
                                    [/filter]
                                    radius=1
                                [/not]
                            ) (
                                side=$hoplite_allyside
                                [modifications]
                                    [object]
                                        silent=yes
                                        [effect]
                                            apply_to=new_ability
                                            [abilities]
                                                [dummy]
                                                    id=spartan_ally_owner_side2
                                                [/dummy]
                                            [/abilities]
                                        [/effect]
                                    [/object]
                                [/modifications]
                            )}

                            [set_variable]
                                name=rat_cooldown2
                                value=4
                            [/set_variable]
                            [/then]
                        )}
                        #matters with the ambush upgrade:
                        [modify_side]
                            side=$hoplite_allyside
                            team_name=hoplite
                            user_team_name=_"Allies"
                        [/modify_side]
                    [/event]
                    [event]
                        name=start
                        [set_menu_item]
                            id=hoplite_skills
                            description= _ "Skills"
                            image="misc/skills.png"
                            [show_if]
                                [have_unit]
                                    id=Hoplite,Hoplite2
                                    x,y=$x1,$y1
                                    side=$side_number
                                [/have_unit]
                                #            [and]
                                #                {VARIABLE_CONDITIONAL shadowclone_unlocked$side_number equals yes}
                                #                [and]
                                #                    {VARIABLE_CONDITIONAL hoplite_shadowclone_cooldown$side_number less_than 1}
                                #                [/and]
                                #            [/and]
                            [/show_if]
                            [command]
                                [fire_event]
                                    id=spartan_skill_menu_event
                                    [primary_unit]
                                        x,y=$x1,$y1
                                    [/primary_unit]
                                [/fire_event]
                            [/command]
                        [/set_menu_item]
                        #Sorcerer class targeted spells
                        [set_menu_item]
                            id=hoplite_target_spells
                            description= _ "Targeted Spells"
                            image="misc/sorcerer_spells.png"
                            [show_if]
                                [have_unit]
                                    id=Hoplite,Hoplite2
                                    #x,y=$x1,$y1
                                    side=$side_number
                                [/have_unit]
                                [and]
                                    {VARIABLE_CONDITIONAL spartan_selected_character$side_number equals sorcerer}
                                [/and]
                            [/show_if]
                            [command]
                                #fire event does not work here since there isn't always a unit at x1 y1
                                #[fire_event]
                                #    id=spartan_targeted_spell_menu_event
                                #    [primary_unit]
                                #        x,y=$x1,$y1
                                #    [/primary_unit]
                                #[/fire_event]
                                {SPARTAN_TARGET_SPELLS_MENU}
                            [/command]
                        [/set_menu_item]
                    [/event]
                    #explosive spear animation event:
                    [event]
                        id=spearexplode
                        first_time_only=no
                        {CHATMSG "exploding spear anim"}
                        {IF_VAR spearthrowexplode_unlocked$side_number equals yes (
                            [and]
                                {VARIABLE_CONDITIONAL isspearthrowing equals yes}
                            [/and]
                            [and]
                                [have_unit]
                                    id=Hoplite,Hoplite2
                                    side=$side_number
                                    ability=spartan_skill_used_explosive_spear
                                [/have_unit]
                            [/and]
                            [then]
                                [object]
                                    silent=yes
                                    duration=forever
                                    [filter]
                                        x,y=$x1,$y1
                                    [/filter]
                                    [effect]
                                        apply_to=new_animation
                                        [extra_anim]
                                            flag=explode2
                                            [missile_frame]
                                                halo="projectiles/fireball-impact-[1~16].png~SCALE(300,300):60"
                                                offset=0.0
                                                auto_vflip=no
                                            [/missile_frame]
                                            [frame]
                                                sound=explosion.ogg
                                            [/frame]
                                        [/extra_anim]
                                    [/effect]
                                [/object]
                                [animate_unit]
                                    flag=explode2
                                    [filter]
                                        x,y=$x1,$y1
                                    [/filter]
                                [/animate_unit]
                            [/then]
                        )}
                    [/event]
                    [event]
                        name=start
                        id=hoplite_upgrade_ability_menus
                        first_time_only=no
                        [set_menu_item]
                            id=hoplite_wizardbeam
                            description=_"Cast the flame blast spell in this direction."
                            image="misc/icon_fire.png"
                            [show_if]
                                [have_location]
                                    [filter_adjacent_location]
                                        [filter]
                                            id=Hoplite,Hoplite2
                                            side=$side_number
                                            formula="attacks_left > 0"#to prevent flame blast being usable while having the Persuasive Pacifist pact
                                            [not]
                                                ability=spartan_disable_player_ranged_attacks
                                            [/not]
                                        [/filter]
                                    [/filter_adjacent_location]
                                    x,y=$x1,$y1
                                [/have_location]
                                [and]
                                    [variable]
                                        name=wizardbeam_unlocked$side_number
                                        equals=yes
                                    [/variable]
                                    [and]
                                        [variable]
                                            name=hoplite_wizardbeam_cooldown$side_number
                                            less_than=1
                                        [/variable]
                                    [/and]
                                [/and]
                            [/show_if]
                            [command]
                                [animate_unit]
                                    flag=standing
                                    [facing]
                                        x,y=$x1,$y1
                                    [/facing]
                                    [filter]
                                        id=Hoplite,Hoplite2
                                        side=$side_number
                                    [/filter]
                                [/animate_unit]
                                [store_unit]
                                    [filter]
                                        id=Hoplite,Hoplite2
                                        side=$side_number
                                    [/filter]
                                    variable=hoplitebeam
                                    kill=no
                                [/store_unit]

                                {SPARTAN_GETDIR_REVERSED $hoplitebeam.x $hoplitebeam.y $x1 $y1 tmp_beam_dir}
                                #            {STORE_TARGETLOCS_PART hoplitebeam $tmp_beam_dir 5 0}
                                {STORE_TARGETHEX_LOC hoplitebeam $hoplite_wizardbeam_range$side_number| 0}

                                [foreach]
                                    array=ranged_targetlocs$tmp_beam_dir
                                    variable=this_item2
                                    index_var=e
                                    [do]
                                        [set_variables]
                                            name=tmp_item_tag_container
                                            [value]
                                                x=$this_item2.x
                                                y=$this_item2.y
                                                image="misc/targethex.png"
                                                name=hoplite_player_wizardbeamtargethex
                                            [/value]
                                        [/set_variables]

                                        #am using [insert_tag] instead of just item, otherwise the game doesn't substitute the id variable for some reason

                                        [insert_tag]
                                            name=item
                                            variable=tmp_item_tag_container
                                        [/insert_tag]

                                        {CLEAR_VARIABLE tmp_item_tag_container}
                                    [/do]
                                [/foreach]

                                [sound]
                                    name=magic-dark-big-miss.ogg
                                [/sound]
                                [delay]
                                    time=500
                                [/delay]
                                [remove_item]
                                    image=hoplite_player_wizardbeamtargethex
                                    x,y=0-99
                                [/remove_item]
                                [redraw][/redraw]

                                [if]
                                    [have_unit]
                                        side=$hoplite_enemyside
                                        [filter_location]
                                            find_in=ranged_targetlocs$tmp_beam_dir
                                        [/filter_location]
                                    [/have_unit]
                                    [then]
                                        [animate_unit]
                                            flag=wizardbeam$hoplite_wizardbeam_range$side_number||
                                            [filter]
                                                id=$hoplitebeam.id
                                            [/filter]
                                            [facing]
                                                x,y=$x1,$y1
                                            [/facing]
                                        [/animate_unit]
                                        {VARIABLE wizardbeam_targets yes}
                                        {SPARTAN_HIT_BOSS_KILLSTREAK_AND_ENERGY $side_number (
                                        [filter_location]
                                            find_in=ranged_targetlocs$tmp_beam_dir
                                        [/filter_location]
                                        )}
                                        {SPARTAN_ATTACKER_UNCOVER_INVISIBILITY id=$hoplitebeam.id}
                                    [/then]
                                [/if]

                                {SPARTAN_RETURN_ATTACK_INDEX_BY_NAME hoplitebeam wizardbeam}

                                #using foreach instead of just find_in filter, so that enemies are hit in the right order
                                [foreach]
                                    array=ranged_targetlocs$tmp_beam_dir
                                    variable=this_item2
                                    index_var=e
                                    [do]
                                        {SPARTAN_CALCULATE_DAMAGE hoplitebeam $hoplitebeam.attack[$tmp_index_return].damage}
                                        [spartan_harm_unit]
                                            [filter]
                                                side=$hoplite_enemyside
                                                x,y=$this_item2.x,$this_item2.y
                                            [/filter]
                                            [filter_second]
                                                id=$hoplitebeam.id
                                            [/filter_second]
                                            [primary_attack]
                                                name=wizardbeam
                                            [/primary_attack]
                                            #amount=$hoplitebeam.attack[$tmp_index_return].damage
                                            amount=$tmp_spartan_calculated_damage
                                            damage_type=$hoplitebeam.attack[$tmp_index_return].type
                                            fire_event=yes
                                            animate=defender
                                            delay=0
                                            experience=yes
                                        [/spartan_harm_unit]
                                        {CLEAR_VARIABLE tmp_spartan_calculated_damage}
                                        [if]
                                            [variable]
                                                name=wizardbeam_burn_unlocked$side_number
                                                equals=yes
                                            [/variable]
                                            [then]
                                                {SPARTAN_APPLY_BURN $hoplite_wizardbeam_burn$side_number (
                                                    side=$hoplite_enemyside
                                                    x,y=$this_item2.x,$this_item2.y
                                                ) $hoplitebeam.id}
                                            [/then]
                                        [/if]
                                    [/do]
                                [/foreach]
                                {CLEAR_VARIABLE tmp_index_return}

                                {IF_VAR wizardbeam_targets equals yes (
                                    [then]
                                        {VARIABLE hoplite_wizardbeam_cooldown$side_number $hoplite_wizardbeam_max_cooldown$side_number}

                                        #using two seperate lines instead of an if statement inside the other line, in case there is 1 sorcerer and 1 non-sorcerer player in mp, so both lines can trigger

                                        {IF_VAR spartan_selected_character$side_number equals sorcerer (
                                        [then]

                                        {ALGADUR_LINE flame_blast_sorcerer (
                                             [message]
                                                 speaker=Algadur
                                                 message=_"So ye are a fire mage? Perfect, time to burn some orcs to a crisp!"
                                             [/message]
                                        )}

                                        [/then]
                                        [else]

                                        {ALGADUR_LINE flame_blast (

                                            {IF_VAR algadur_line_archmage equals yes (
                                                [then]
                                                    [message]
                                                        speaker=Algadur
                                                        # wmllint: local spelling spelltomes
                                                        message=_"Putting the old mage's spelltomes to good use already, eh? Ye're quite a quick learner!"
                                                    [/message]
                                                    [message]
                                                        id=Hoplite,Hoplite2
                                                        side=$side_number
                                                        message=_"It seems I have a rather unusually strong affinity for magic, even though I trained most of my life as a warrior."
                                                    [/message]
                                                [/then]
                                                [else]
                                                    [message]
                                                        speaker=Algadur
                                                        message=_"Did you just... cast fire magic?! Where did ye even learn that!?"
                                                    [/message]
                                                    [message]
                                                        id=Hoplite,Hoplite2
                                                        side=$side_number
                                                        message=_"From the secret spelltomes an old mage entrusted to me. It seems I have a rather unusually strong affinity for magic, even though I trained most of my life as a warrior."
                                                    [/message]
                                                [/else]
                                            )}
                                            [message]
                                                speaker=Algadur
                                                message=_"Talented warrior AND talented mage? Yer as rare as an arcanister!"
                                            [/message]
                                        )}

                                        [/else]
                                        )}

                                        #using two seperate lines instead of an if statement inside the other line, in case there is 1 sorcerer and 1 non-sorcerer player in mp, so both lines can trigger


                                        {IF_VAR elizabeth_line_flame_sorcerer not_equals yes (
                                            [and]
                                                [have_unit]
                                                    id=Elizabeth
                                                [/have_unit]
                                            [/and]
                                            [and]
                                                {VARIABLE_CONDITIONAL spartan_selected_character$side_number equals sorcerer}
                                            [/and]
                                            [then]
                                                [message]
                                                    speaker=Elizabeth
                                                    message=_"I see you're a fellow pyromancer, very good! One more thing we got in common."
                                                [/message]
                                                [message]
                                                    side=$side_number
                                                    canrecruit=yes
                                                    message=_"Indeed."
                                                [/message]
                                                {VARIABLE elizabeth_line_flame_sorcerer yes}
                                                {VARIABLE_OP elizabeth_magic_lines add 1}#so I can maybe later add a line about how the hoplite has become basically an archmage, if the value is high enough TODO: maybe make the values seperate in MP
                                            [/then]
                                        )}

                                        {IF_VAR elizabeth_line_flame not_equals yes (
                                            [and]
                                                [have_unit]
                                                    id=Elizabeth
                                                [/have_unit]
                                            [/and]
                                            [not]
                                                {VARIABLE_CONDITIONAL spartan_selected_character$side_number equals sorcerer}
                                            [/not]
                                            [then]
                                                [message]
                                                    speaker=Elizabeth
                                                    message=_"You're a spellcaster too? Wouldn't have guessed from your appearance..."
                                                [/message]
                                                {IF_VAR ratsI_unlocked equals yes (
                                                    [or]
                                                        {VARIABLE_CONDITIONAL ratsI_unlocked1 equals yes}
                                                    [/or]
                                                    [or]
                                                        {VARIABLE_CONDITIONAL ratsI_unlocked2 equals yes}
                                                    [/or]
                                                    [then]
                                                        [message]
                                                            speaker=Elizabeth
                                                            message=_"...But then again, mind-controlling rats isn't very typical of a warrior either."
                                                        [/message]
                                                    [/then])}
                                                    {VARIABLE elizabeth_line_flame yes}
                                                    {VARIABLE_OP elizabeth_magic_lines add 1}#so I can maybe later add a line about how the hoplite has become basically an archmage, if the value is high enough TODO: maybe make the values seperate in MP

                                                    [message]
                                                        side=$side_number
                                                        canrecruit=yes
                                                        message=_"Heh, what can I say, I'm a man of many talents."
                                                    [/message]
                                                [/then])}

                                                #manually subtract attacks_left, so that it counts as an attack for Rest upgrades

                                                {MODIFY_UNIT id=$hoplitebeam.id attacks_left "$($hoplitebeam.attacks_left - 1)"}

                                                [end_turn]
                                                [/end_turn]
                                                {CLEAR_VARIABLE wizardbeam_targets}
                                            [/then]
                                        )}

                                        {GALATEA_ALLY_LINE flameblast (
                                            [message]
                                                speaker=Galatea
                                                message=_"Your pyromancy skills will be helpful in clearing out crowds of the Merchant's minions."
                                            [/message]
                                        )}

                                        {HOPLITE_CLEAR_TMP_TARGETHEXES}
                                        {CLEAR_VARIABLE hoplitebeam}
                                        {CLEAR_VARIABLE tmp_beam_dir}
                                     [/command]
                                [/set_menu_item]

                                [set_menu_item]
                                    id=hoplite_enthrall
                                    description=_"Enthrall this enemy (costs <span color='#2c9fed'>75</span> energy <span color='#ffff99'>per enemy level</span>)"
                                    image="misc/eye-icon.png"
                                    [show_if]
                                        [have_unit]
                                            side=$hoplite_enemyside
                                            #       level=0,1,2
                                            x,y=$x1,$y1
                                            [not]
                                                ability=hoplite_boss_immunities
                                                [or]
                                                    ability=spartan_bombfilter
                                                [/or]
                                            [/not]
                                            [filter_location]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                                radius=$spartan_enthrall_range$side_number
                                                [filter_radius]
                                                    [not]
                                                        terrain={SPARTAN_WALL_TERRAIN}
                                                    [/not]
                                                [/filter_radius]
                                            [/filter_location]
                                        [/have_unit]
                                        [and]
                                            [variable]
                                                name=enthrall_unlocked$side_number
                                                equals=yes
                                            [/variable]
                                        [/and]
                                        #[and]
                                        #    [have_unit]
                                        #        id=Hoplite,Hoplite2
                                        #        side=$side_number
                                        #        [filter_adjacent]
                                        #            x,y=$x1,$y1
                                        #        [/filter_adjacent]
                                        #    [/have_unit]
                                        #[/and]
                                    [/show_if]
                                    [command]
                                        [store_unit]
                                            [filter]
                                                x,y=$x1,$y1
                                            [/filter]
                                            variable=enthrallenemy
                                            kill=no
                                        [/store_unit]
                                        #   [if]
                                        #   [have_unit]
                                        #     x,y=$x1,$y1
                                        #      ability=summonerfilter
                                        #   [/have_unit]
                                        #   [then]
                                        #        [print]
                                        #           text= _ "Can't enthrall summoners!"
                                        #           size=22
                                        #           red=255
                                        #      duration=2000
                                        #        [/print]
                                        #   [/then]
                                        #    [elseif]
                                        #    [have_unit]
                                        #      x,y=$x1,$y1
                                        #      ability=hoplite_boss_immunities
                                        #    [/have_unit]
                                        #    [then]
                                        #        [print]
                                        #           text= _ "Can't enthrall bosses!"
                                        #           size=22
                                        #           red=255
                                        #       duration=100
                                        #        [/print]
                                        #    [/then]
                                        #    [/elseif]
                                        #   [else]
                                        {VARIABLE enthrallenergy $enthrallenemy.level}
                                        {VARIABLE_OP enthrallenergy multiply 75}
                                        {IF_VAR enthrallenergy less_than 35 (
                                            [then]
                                                {VARIABLE enthrallenergy 35}
                                            [/then])}
                                            [if]
                                                [variable]
                                                    name=hoplite_energy$side_number
                                                    greater_than_equal_to=$enthrallenergy
                                                [/variable]
                                                [then]
                                                    {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -$enthrallenergy}
                                                    [sound]
                                                        name=magic-dark-big.ogg
                                                    [/sound]
                                                    [modify_unit]
                                                        [filter]
                                                            x,y=$x1,$y1
                                                        [/filter]
                                                        side=$hoplite_allyside
                                                    [/modify_unit]
                                                    {SPARTAN_APPLY_ENTHRALL_BUFFS (x,y=$x1,$y1) $side_number}
                                                    [heal_unit]
                                                        [filter]
                                                            x,y=$x1,$y1
                                                        [/filter]
                                                        amount=full
                                                        animate=no
                                                        #cure poison/slow
                                                        restore_statuses=yes
                                                    [/heal_unit]
                                                    {SPARTAN_REMOVE_BURN x,y=$x1,$y1}
                                                    [modify_side]
                                                        side=$hoplite_allyside
                                                        controller=ai
                                                        hidden=no
                                                    [/modify_side]

                                                    #if auto-loyal is enabled, make newly-enthralled enemies loyal instantly
                                                    [store_unit]
                                                        [filter]
                                                            ability=hoplite_loyalthrall$side_number
                                                        [/filter]
                                                        variable=tmp_current_thralls
                                                        kill=no
                                                    [/store_unit]
                                                    [if]
                                                        {VARIABLE_CONDITIONAL tmp_current_thralls.length less_than $hoplite_thrall_limit$side_number}
                                                        [and]
                                                            {VARIABLE_CONDITIONAL spartan_thrall_auto_loyal$side_number equals yes}
                                                        [/and]
                                                        [then]
                                                            [object]
                                                                silent=yes
                                                                duration=forever
                                                                [filter]
                                                                    x,y=$x1,$y1
                                                                [/filter]
                                                                [effect]
                                                                    apply_to=new_ability
                                                                    [abilities]
                                                                        [dummy]
                                                                            id=hoplite_loyalthrall$side_number
                                                                        [/dummy]
                                                                        [dummy]
                                                                            id=hoplite_loyalthrall_filter
                                                                        [/dummy]
                                                                    [/abilities]
                                                                [/effect]
                                                            [/object]

                                                            [modify_unit]
                                                                [filter]
                                                                    x,y=$x1,$y1
                                                                [/filter]
                                                                {TRAIT_LOYAL}
                                                            [/modify_unit]
                                                        [/then]
                                                    [/if]
                                                    {CLEAR_VARIABLE tmp_current_thralls}

                                                    #removed cooldown for now, as I bumped up the energy cost instead
                                                    #        [if]
                                                    #            [have_unit]
                                                    #                id=Hoplite2
                                                    #            [/have_unit]
                                                    #            [then]
                                                    #                {HOPLITE_PLAYERFILTER (
                                                    #                    {VARIABLE hoplite_enthrall_cooldown1 3}
                                                    #                ) (
                                                    #                    {VARIABLE hoplite_enthrall_cooldown2 3}
                                                    #                )}
                                                    #            [/then]
                                                    #            [else]
                                                    #                {VARIABLE hoplite_enthrall_cooldown 3}
                                                    #            [/else]
                                                    #        [/if]

                                                    #for stuff like enthrall dialog

                                                    [fire_event]
                                                        name=spartan_enthrall
                                                        [primary_unit]
                                                            x,y=$x1,$y1
                                                        [/primary_unit]
                                                        [secondary_unit]
                                                            id=Hoplite,Hoplite2
                                                            side=$side_number
                                                        [/secondary_unit]
                                                    [/fire_event]

                                                    [if]
                                                        [have_unit]
                                                            x,y=$x1,$y1
                                                            level=3
                                                        [/have_unit]
                                                        [then]
                                                            {ACHIEVEMENT_MESSAGE_LONE enthrall_master $side_number}
                                                        [/then]
                                                    [/if]

                                                    [if]
                                                        [have_unit]
                                                            x,y=$x1,$y1
                                                            ability=hoplite_patron_unit
                                                        [/have_unit]
                                                        [then]
                                                            {ACHIEVEMENT_MESSAGE_LONE enthrall_patron $side_number}
                                                        [/then]
                                                    [/if]

                                                    {ALGADUR_LINE enthrall (
                                                        [message]
                                                            speaker=Algadur
                                                            message=_"That feels all kinds of wrong, lad... But what wouldn't I give to make those filthy orcs slaughter each other!"
                                                        [/message]
                                                    )}
                                                    {ELIZABETH_MAGIC_LINE enthrall (
                                                        [message]
                                                            speaker=Elizabeth
                                                            message=_"I'm not about to say you shouldn't use that, but keep this kind of magic far away from me."
                                                        [/message]
                                                        [message]
                                                            side=$side_number
                                                            canrecruit=yes
                                                            message=_"<b><i>WHAT!?</i></b> By Athena, what sort of ideas are coursing through your mind, woman!? A true warrior of Sparta is a man of honor!"
                                                        [/message]
                                                        [message]
                                                            speaker=Elizabeth
                                                            message=_"Good to hear that."
                                                        [/message]
                                                    )}
                                                    {GALATEA_ALLY_LINE enthrall (
                                                        [message]
                                                            speaker=Galatea
                                                            message=_"So you know how to mind-control people too? Very interesting. Most of my mind-control powers were from the damn <span color='#a456ff'>Pact of Overlord</span>."
                                                        [/message]
                                                    )}
    
                                                    [end_turn]
                                                    [/end_turn]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Not enough energy!"
                                                        size=22
                                                        red=255
                                                        duration=100
                                                    [/print]
                                                [/else]
                                            [/if]
                                            #   [/else]
                                            #   [/if]
                                            {CLEAR_VARIABLE enthrallenemy}
                                            {CLEAR_VARIABLE enthrallenergy}
                                        [/command]
                                    [/set_menu_item]
                                    [set_menu_item]
                                        id=hoplite_loyal_thrall
                                        description=_"Turn this thrall into a loyal thrall (if you are below thrall limit)"
                                        [show_if]
                                            [have_unit]
                                                side=$hoplite_allyside
                                                ability=hoplite_thrall
                                                x,y=$x1,$y1
                                                [not]
                                                    ability=hoplite_loyalthrall$side_number
                                                [/not]
                                            [/have_unit]
                                            [and]
                                                [variable]
                                                    name=enthrall_loyal_unlocked$side_number
                                                    equals=yes
                                                [/variable]
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [store_unit]
                                                [filter]
                                                    ability=hoplite_loyalthrall$side_number
                                                [/filter]
                                                variable=tmp_current_thralls
                                                kill=no
                                            [/store_unit]

                                            [if]
                                                {VARIABLE_CONDITIONAL tmp_current_thralls.length greater_than_equal_to $hoplite_thrall_limit$side_number}
                                                [then]
                                                    [print]
                                                        text= _ "Can't go above the loyal thrall limit!"
                                                        size=22
                                                        red=255
                                                        duration=1500
                                                    [/print]
                                                [/then]
                                                [else]
                                                    [object]
                                                        silent=yes
                                                        duration=forever
                                                        [filter]
                                                            x,y=$x1,$y1
                                                        [/filter]
                                                        [effect]
                                                            apply_to=new_ability
                                                            [abilities]
                                                                [dummy]
                                                                    id=hoplite_loyalthrall$side_number
                                                                [/dummy]
                                                                [dummy]
                                                                    id=hoplite_loyalthrall_filter
                                                                [/dummy]
                                                            [/abilities]
                                                        [/effect]
                                                    [/object]

                                                    [modify_unit]
                                                        [filter]
                                                            x,y=$x1,$y1
                                                        [/filter]
                                                        {TRAIT_LOYAL}
                                                    [/modify_unit]
                                                [/else]
                                            [/if]
                                            {CLEAR_VARIABLE tmp_current_thralls}
                                        [/command]
                                    [/set_menu_item]

                                    [set_menu_item]
                                        id=hoplite_loyal_thrall_remove
                                        description=_"Remove loyal trait from this thrall (so you can make a different thrall loyal)"
                                        [show_if]
                                            [have_unit]
                                                side=$hoplite_allyside
                                                ability=hoplite_thrall
                                                x,y=$x1,$y1
                                                [and]
                                                    ability=hoplite_loyalthrall$side_number
                                                [/and]
                                            [/have_unit]
                                        [/show_if]
                                        [command]
                                            [remove_trait]
                                                x,y=$x1,$y1
                                                trait_id=loyal
                                            [/remove_trait]

                                            [object]
                                                silent=yes
                                                duration=forever
                                                [filter]
                                                    x,y=$x1,$y1
                                                [/filter]
                                                [effect]
                                                    apply_to=remove_ability
                                                    [abilities]
                                                        [dummy]
                                                            id=hoplite_loyalthrall$side_number
                                                        [/dummy]
                                                        [dummy]
                                                            id=hoplite_loyalthrall_filter
                                                        [/dummy]
                                                    [/abilities]
                                                [/effect]
                                            [/object]
                                        [/command]
                                    [/set_menu_item]

                                    [set_menu_item]
                                        id=hoplite_bow
                                        description=_"Aim your bow in this direction (will shoot next turn)"
                                        image="misc/icon_bow.png"
                                        [show_if]
                                            [have_location]
                                                [filter_adjacent_location]
                                                    [filter]
                                                        id=Hoplite,Hoplite2
                                                        side=$side_number
                                                        formula="attacks_left > 0"#to prevent the bow being usable while having the Persuasive Pacifist pact
                                                        [not]
                                                            ability=spartan_disable_player_ranged_attacks
                                                        [/not]
                                                    [/filter]
                                                [/filter_adjacent_location]
                                                x,y=$x1,$y1
                                            [/have_location]
                                            [and]
                                                [variable]
                                                    name=bow_unlocked$side_number
                                                    equals=yes
                                                [/variable]
                                                [and]
                                                    #                [variable]
                                                    #                    name=bowIV_unlocked$side_number
                                                    #                    not_equals=yes
                                                    #                [/variable]
                                                    {VARIABLE_CONDITIONAL spartan_bow_mode$side_number not_equals quickdraw}
                                                [/and]
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [animate_unit]
                                                flag=standing
                                                [facing]
                                                    x,y=$x1,$y1
                                                [/facing]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                            [/animate_unit]
                                            [store_unit]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                                variable=hoplitebow
                                                kill=no
                                            [/store_unit]

                                            {SPARTAN_GETDIR_REVERSED $hoplitebow.x $hoplitebow.y $x1 $y1 tmp_ranged_dir}

                                            {STORE_TARGETHEX_LOC hoplitebow $hoplite_bow_range$hoplitebow.side $hoplite_bow_blindspot$hoplitebow.side}

                                            {SPARTAN_PLACE_TARGETHEXES ranged_targetlocs$tmp_ranged_dir hoplitebow "misc/targethex-archer.png" ()}

                                            {IF_VAR ranged_targetlocs$tmp_ranged_dir|.length greater_than 0 (
                                                [then]
                                                    [sound]
                                                        name=magic-dark-big-miss.ogg
                                                    [/sound]
                                                    {VARIABLE hoplite_bow_aiming$side_number yes}

                                                    #manually subtract attacks_left, so that it counts as an attack for Rest upgrades
    
                                                    {MODIFY_UNIT id=$hoplitebow.id attacks_left "$($hoplitebow.attacks_left - 1)"}

                                                    [end_turn]
                                                    [/end_turn]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Can't aim in this direction!"
                                                        size=22
                                                        red=255
                                                        duration=1500
                                                    [/print]
                                                [/else]
                                            )}

                                            {CLEAR_VARIABLE hoplitebow}
                                            {HOPLITE_CLEAR_TMP_TARGETHEXES}
                                            {CLEAR_VARIABLE tmp_ranged_dir}
                                        [/command]
                                    [/set_menu_item]

                                    [set_menu_item]
                                        id=hoplite_bow2
                                        description=_"Shoot your bow in this direction"
                                        image="misc/icon_bow.png"
                                        [show_if]
                                            [have_location]
                                                [filter_adjacent_location]
                                                    [filter]
                                                        id=Hoplite,Hoplite2
                                                        side=$side_number
                                                        formula="attacks_left > 0"#to prevent the bow being usable while having the Persuasive Pacifist pact
                                                        [not]
                                                            ability=spartan_disable_player_ranged_attacks
                                                        [/not]
                                                    [/filter]
                                                [/filter_adjacent_location]
                                                x,y=$x1,$y1
                                            [/have_location]
                                            [and]
                                                #                [variable]
                                                #                    name=bowIV_unlocked$side_number
                                                #                    equals=yes
                                                #                [/variable]
                                                {VARIABLE_CONDITIONAL spartan_bow_mode$side_number equals quickdraw}
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [animate_unit]
                                                flag=standing
                                                [facing]
                                                    x,y=$x1,$y1
                                                [/facing]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                            [/animate_unit]
                                            [store_unit]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                                variable=hoplitebow
                                                kill=no
                                            [/store_unit]

                                            {SPARTAN_GETDIR_REVERSED $hoplitebow.x $hoplitebow.y $x1 $y1 tmp_bow_dir}

                                            {STORE_TARGETHEX_LOC hoplitebow $hoplite_bow_range$hoplitebow.side $hoplite_bow_blindspot$hoplitebow.side}

                                            [foreach]
                                                array=ranged_targetlocs$tmp_bow_dir
                                                variable=this_item2
                                                index_var=e
                                                [do]
                                                    [set_variables]
                                                        name=tmp_item_tag_container
                                                        [value]
                                                            x=$this_item2.x
                                                            y=$this_item2.y
                                                            image="misc/targethex-archer.png"
                                                            name=hoplite_targethex$hoplitebow.id
                                                        [/value]
                                                    [/set_variables]

                                                    #am using [insert_tag] instead of just item, otherwise the game doesn't substitute the id variable for some reason

                                                    [insert_tag]
                                                        name=item
                                                        variable=tmp_item_tag_container
                                                    [/insert_tag]

                                                    {CLEAR_VARIABLE tmp_item_tag_container}

                                                    [set_variables]
                                                        name=hoplite_targethexes
                                                        mode=append
                                                        [value]
                                                            unit_id=$hoplitebow.id
                                                            x=$this_item2.x
                                                            y=$this_item2.y
                                                            name=hoplite_targethex$hoplitebow.id
                                                        [/value]
                                                    [/set_variables]
                                                [/do]
                                            [/foreach]

                                            {IF_VAR ranged_targetlocs$tmp_bow_dir|.length greater_than 0 (
                                                [then]
                                                    [sound]
                                                        name=magic-dark-big-miss.ogg
                                                    [/sound]
                                                    {VARIABLE hoplite_bow_aiming$side_number yes}
                                                    [delay]
                                                        time=500
                                                    [/delay]

                                                    #manually subtract attacks_left, so that it counts as an attack for Rest upgrades

                                                    #note: in this event's case, hoplitebow is cleared inside hoplite_bow_shoot, so storing the hoplite's attacks in a temporary variable:

                                                    {VARIABLE tmp_bowshoot_old_attacks_left $hoplitebow.attacks_left}

                                                    [fire_event]
                                                        id=hoplite_bow_shoot
                                                    [/fire_event]

                                                    {MODIFY_UNIT (
                                                        id=Hoplite,Hoplite2
                                                        side=$side_number
                                                    ) attacks_left "$($tmp_bowshoot_old_attacks_left - 1)"}
                                                    {CLEAR_VARIABLE tmp_bowshoot_old_attacks_left}

                                                    [end_turn]
                                                    [/end_turn]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Can't shoot in this direction!"
                                                        size=22
                                                        red=255
                                                        duration=1500
                                                    [/print]
                                                [/else]
                                            )}

                                            {CLEAR_VARIABLE hoplitebow}
                                            {HOPLITE_CLEAR_TMP_TARGETHEXES}
                                            {CLEAR_VARIABLE tmp_bow_dir}
                                        [/command]
                                    [/set_menu_item]

                                    [set_menu_item]
                                        id=hoplite_recall_spear
                                        #        description=_"Recall your spear, costs <span color='#2c9fed'>50</span> energy (ends turn)"
                                        description=_"Recall your spear (ends turn)"
                                        image="misc/icon_spear.png"
                                        [show_if]
                                            [variable]
                                                name=spear_recall_unlocked$side_number
                                                equals=yes
                                            [/variable]
                                            [and]
                                                [have_unit]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                    x,y=$x1,$y1
                                                    variation=spearless
                                                [/have_unit]
                                                [or]
                                                    [have_location]
                                                        x,y=$x1,$y1
                                                        find_in=hoplite_spearloc$side_number
                                                    [/have_location]
                                                [/or]
                                            [/and]
                                        [/show_if]
                                        [command]
                                            #recall is now free
                                            #            [if]
                                            ##ifdef MULTIPLAYER
                                            #                [have_unit]
                                            #                    id=Hoplite
                                            #                    side=$side_number
                                            #                [/have_unit]
                                            #                [and]
                                            #                    [variable]
                                            #                        name=hoplite_energy1
                                            #                        greater_than_equal_to=50
                                            #                    [/variable]
                                            #                [/and]
                                            #                [or]
                                            #                    [have_unit]
                                            #                        id=Hoplite2
                                            #                        side=$side_number
                                            #                    [/have_unit]
                                            #                    [and]
                                            #                        [variable]
                                            #                            name=hoplite_energy2
                                            #                            greater_than_equal_to=50
                                            #                        [/variable]
                                            #                    [/and]
                                            #                [/or]
                                            ##endif
                                            ##ifndef MULTIPLAYER
                                            #                    [variable]
                                            #                        name=hoplite_energy
                                            #                        greater_than_equal_to=50
                                            #                    [/variable]
                                            ##endif
                                            #        [then]
                                            ##ifdef MULTIPLAYER
                                            #                    [if]
                                            #                        [have_unit]
                                            #                            id=Hoplite
                                            #                            side=$side_number
                                            #                        [/have_unit]
                                            #                        [then]
                                            #                            {VARIABLE_OP hoplite_energy1 sub 50}
                                            #                            {SET_LABEL 9 1 "Side 1 Energy: $hoplite_energy1|/$hoplite_maxenergy1|"}
                                            #                        [/then]
                                            #                        [else]
                                            #                            {VARIABLE_OP hoplite_energy2 sub 50}
                                            #                            {SET_LABEL 10 1 "Side 2 Energy: $hoplite_energy2|/$hoplite_maxenergy2|"}
                                            #                        [/else]
                                            #                    [/if]
                                            ##endif
                                            ##ifndef MULTIPLAYER
                                            #        {VARIABLE_OP hoplite_energy sub 50}
                                            #        {SET_LABEL 10 1 "Energy: $hoplite_energy|/$hoplite_maxenergy|"}
                                            ##endif

                                            [sound]
                                                name=magic-faeriefire.ogg
                                            [/sound]
                                            [floating_text]
                                                [filter]
                                                    side=$side_number
                                                    canrecruit=yes
                                                [/filter]
                                                text=_"spear recalled"
                                            [/floating_text]


                                            {SPARTAN_CHANGE_VARIATION_PRESERVING_HP_EXACT (
                                                side=$side_number
                                                canrecruit=yes
                                            ) none}

                                            [remove_item]
                                                image=hoplite_spear$side_number
                                                x=0-99
                                                y=0-99
                                            [/remove_item]

                                            {VARIABLE hoplite_spear_on_ground$side_number no}
                                            {CLEAR_VARIABLE hoplite_spearloc$side_number}
                                            [end_turn]
                                            [/end_turn]
                                            #        [/then]
                                            #        [else]
                                            #            [print]
                                            #               text= _ "Not enough energy!"
                                            #               size=22
                                            #               red=255
                                            #           duration=100
                                            #            [/print]
                                            #        [/else]
                                            #        [/if]
                                        [/command]
                                    [/set_menu_item]
                                    [set_menu_item]
                                        id=hoplite_follow_spear
                                        description=_"Follow your spear, costs <span color='#2c9fed'>50</span> energy (ends turn)"
                                        image="misc/icon_spear.png"
                                        [show_if]
                                            [have_unit]
                                                id=Hoplite,Hoplite2
                                                side=$side_number
                                                x,y=$x1,$y1
                                                variation=spearless
                                            [/have_unit]
                                            [or]
                                                [have_location]
                                                    x,y=$x1,$y1
                                                    find_in=hoplite_spearloc$side_number
                                                [/have_location]
                                            [/or]
                                            [and]
                                                [variable]
                                                    name=spear_follow_unlocked$side_number
                                                    equals=yes
                                                [/variable]
                                            [/and]
                                            [and]
                                                [have_location]
                                                    [not]
                                                        [filter]
                                                        [/filter]
                                                    [/not]
                                                    find_in=hoplite_spearloc$side_number
                                                [/have_location]
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [if]
                                                [variable]
                                                    name=hoplite_energy$side_number
                                                    greater_than_equal_to=50
                                                [/variable]
                                                [then]
                                                    {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -50}

                                                    [object]
                                                        silent=yes
                                                        duration=turn end
                                                        [filter]
                                                            side=$side_number
                                                            canrecruit=yes
                                                        [/filter]
                                                        [effect]
                                                            apply_to=new_animation
                                                            {HOPLITE_TELEPORTANIM}
                                                        [/effect]
                                                    [/object]

                                                    [sound]
                                                        name=magic-faeriefire.ogg
                                                    [/sound]
                                                    [store_locations]
                                                        find_in=hoplite_spearloc$side_number
                                                        include_borders=no
                                                        variable=tmp_follow_loc
                                                    [/store_locations]
                                                    [animate_unit]
                                                        flag=pre_teleport
                                                        [filter]
                                                            side=$side_number
                                                            canrecruit=yes
                                                        [/filter]
                                                    [/animate_unit]
                                                    [hide_unit]
                                                        side=$side_number
                                                        canrecruit=yes
                                                    [/hide_unit]
                                                    {TELEPORT_UNIT side,canrecruit=$side_number,yes $tmp_follow_loc.x $tmp_follow_loc.y}
                                                    {CLEAR_VARIABLE tmp_follow_loc}
                                                    [unhide_unit]
                                                        side=$side_number
                                                        canrecruit=yes
                                                    [/unhide_unit]
                                                    [animate_unit]
                                                        flag=post_teleport
                                                        [filter]
                                                            side=$side_number
                                                            canrecruit=yes
                                                        [/filter]
                                                    [/animate_unit]
                                                    {SPARTAN_CHANGE_VARIATION_PRESERVING_HP_EXACT (
                                                        side=$side_number
                                                        canrecruit=yes
                                                    ) none}

                                                    [remove_item]
                                                        image=hoplite_spear$side_number
                                                        x=0-99
                                                        y=0-99
                                                    [/remove_item]

                                                    {VARIABLE hoplite_spear_on_ground$side_number no}
                                                    {CLEAR_VARIABLE hoplite_spearloc$side_number}
                                                    [end_turn]
                                                    [/end_turn]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Not enough energy!"
                                                        size=22
                                                        red=255
                                                        duration=100
                                                    [/print]
                                                [/else]
                                            [/if]
                                        [/command]
                                    [/set_menu_item]
                                [/event]
                                [event]
                                    name=turn refresh
                                    id=hoplite_bow_shoot
                                    first_time_only=no
                                    [filter_condition]
                                        {VARIABLE_CONDITIONAL hoplite_bow_aiming$side_number equals yes}
                                    [/filter_condition]
                                    {CHATMSG "player bow shoot event"}

                                    [store_unit]
                                        [filter]
                                            id=Hoplite,Hoplite2
                                            side=$side_number
                                        [/filter]
                                        variable=hoplitebow
                                        kill=no
                                    [/store_unit]

                                    {STORE_TARGETHEXES_OF_ID $hoplitebow.id hoplite_bow_targethexes}

                                    {HOPLITE_CLEAR_TARGETHEXES_BY_ID $hoplitebow.id}

                                    [foreach]
                                        array=hoplite_bow_targethexes
                                        variable=this_targethex
                                        index_var=e
                                        [do]
                                            #            [chat]
                                            #                message=$this_targethex.x,$this_targethex.y
                                            #            [/chat]
                                            [if]
                                                [have_unit]
                                                    x,y=$this_targethex.x,$this_targethex.y
                                                    [filter_side]
                                                        [enemy_of]
                                                            side=$hoplitebow.side
                                                        [/enemy_of]
                                                    [/filter_side]
                                                    [not]
                                                        ability_type_active=hides
                                                        [not]
                                                            status=uncovered
                                                        [/not]
                                                    [/not]
                                                [/have_unit]
                                                [and]
                                                    {VARIABLE_CONDITIONAL tmp_rangedtarget_found not_equals yes}
                                                [/and]
                                                [or]
                                                    [have_unit]
                                                        x,y=$this_targethex.x,$this_targethex.y
                                                        [filter_side]
                                                            [enemy_of]
                                                                side=$hoplitebow.side
                                                            [/enemy_of]
                                                        [/filter_side]
                                                        ability_type_active=hides
                                                    [/have_unit]
                                                    [and]
                                                        {VARIABLE_CONDITIONAL tmp_rangedtarget_found not_equals yes}
                                                    [/and]
                                                    [and]
                                                        [variable]
                                                            name=bow_eagle_eye_unlocked$side_number
                                                            equals=yes
                                                        [/variable]
                                                    [/and]
                                                [/or]
                                                [then]
                                                    {VARIABLE tmp_rangedtarget_found yes}
                                                    [store_unit]
                                                        [filter]
                                                            x,y=$this_targethex.x,$this_targethex.y
                                                        [/filter]
                                                        variable=hoplitebow_target
                                                    [/store_unit]
                                                [/then]
                                            [/if]
                                        [/do]
                                    [/foreach]
                                    {CLEAR_VARIABLE tmp_rangedtarget_found}

                                    [if]
                                        [have_unit]
                                            id=$hoplitebow_target.id
                                        [/have_unit]
                                        [then]
                                            {SPARTAN_RETURN_ATTACK_INDEX_BY_NAME hoplitebow bow}

                                            {VARIABLE tmp_targetloc.x $hoplitebow_target.x}
                                            {VARIABLE tmp_targetloc.y $hoplitebow_target.y}
                                            [fire_event]
                                                name=attack#to trigger teleportaway event
                                                [primary_unit]
                                                    id=$hoplitebow.id
                                                [/primary_unit]
                                                [secondary_unit]
                                                    id=$hoplitebow_target.id
                                                [/secondary_unit]
                                                [primary_attack]
                                                    name=$hoplitebow.attack[$tmp_index_return].name
                                                    damage=$hoplitebow.attack[$tmp_index_return].damage
                                                    type=$hoplitebow.attack[$tmp_index_return].type
                                                [/primary_attack]
                                            [/fire_event]
                                            [if]
                                                [have_unit]
                                                    id=$hoplitebow_target.id
                                                    x,y=$tmp_targetloc.x,$tmp_targetloc.y#only attack the target if the target hasn't teleported before being attacked
                                                    [not]
                                                        ability_type_active=hides
                                                        [not]
                                                            status=uncovered
                                                        [/not]
                                                    [/not]
                                                [/have_unit]
                                                [or]
                                                    [have_unit]
                                                        id=$hoplitebow_target.id
                                                        x,y=$tmp_targetloc.x,$tmp_targetloc.y#only attack the target if the target hasn't teleported before being attacked
                                                    [/have_unit]
                                                    [and]
                                                        [variable]
                                                            name=bow_eagle_eye_unlocked$side_number
                                                            equals=yes
                                                        [/variable]
                                                    [/and]
                                                [/or]
                                                [then]
                                                    {SPARTAN_CALCULATE_DAMAGE hoplitebow $hoplitebow.attack[$tmp_index_return].damage}
                                                    {SPARTAN_HIT_BOSS_KILLSTREAK_AND_ENERGY $side_number (id=$hoplitebow_target.id)}
                                                    {SPARTAN_ATTACKER_UNCOVER_INVISIBILITY id=$hoplitebow.id}
                                                    [spartan_harm_unit]
                                                        [filter]
                                                            id=$hoplitebow_target.id
                                                        [/filter]
                                                        [filter_second]
                                                            id=$hoplitebow.id
                                                        [/filter_second]
                                                        [primary_attack]
                                                            name=$hoplitebow.attack[$tmp_index_return].name
                                                        [/primary_attack]
                                                        amount=$tmp_spartan_calculated_damage
                                                        damage_type=$hoplitebow.attack[$tmp_index_return].type
                                                        alignment=$hoplitebow.alignment
                                                        fire_event=yes
                                                        animate=yes
                                                        delay=0
                                                        experience=no
                                                    [/spartan_harm_unit]
                                                    {CLEAR_VARIABLE tmp_spartan_calculated_damage}

                                                    [if]
                                                        [variable]
                                                            name=bow_burn_unlocked$side_number
                                                            equals=yes
                                                        [/variable]
                                                        [then]
                                                            {SPARTAN_APPLY_BURN $hoplite_bow_burn$side_number (id=$hoplitebow_target.id) $hoplitebow.id}
                                                        [/then]
                                                    [/if]

                                                    [if]
                                                        [variable]
                                                            name=bow_knockback_unlocked$side_number
                                                            equals=yes
                                                        [/variable]
                                                        [then]
                                                            #source and destination is intentionally reversed
                                                            [store_relative_direction]
                                                                [source]
                                                                    x,y=$hoplitebow_target.x,$hoplitebow_target.y
                                                                [/source]
                                                                [destination]
                                                                    x,y=$hoplitebow.x,$hoplitebow.y
                                                                [/destination]
                                                                variable=hoplitebow_aimdir
                                                            [/store_relative_direction]
                                                            {HOPLITE_KNOCKBACK_CODE_REPEATED $hoplite_bow_knockback_distance$side_number hoplitebow_target hoplitebow $hoplitebow_aimdir}
                                                            {CLEAR_VARIABLE hoplitebow_aimdir}
                                                        [/then]
                                                    [/if]
                                                [/then]
                                            [/if]
                                            {ALGADUR_LINE bow (
                                                [message]
                                                    speaker=Algadur
                                                    message=_"Eh, bows aren't really me thing, but the knife-ears' arrows hurt a lot, so I can't really knock yer tastes."
                                                [/message]
                                            )}
                                            {CLEAR_VARIABLE tmp_targetloc}
                                            {CLEAR_VARIABLE tmp_index_return}
                                        [/then]
                                    [/if]

                                    {CLEAR_VARIABLE hoplitebow}
                                    {CLEAR_VARIABLE hoplitebow_target}
                                    {CLEAR_VARIABLE hoplite_bow_targethexes}
                                    {CLEAR_VARIABLE hoplite_bow_aiming$side_number}
                                [/event]
                                [event]
                                    name=start
                                    [set_menu_item]
                                        id=hoplite_healpotion
                                        description=_"Drink a healing potion to restore some hitpoints."
                                        image="misc/icon_healpotion.png"
                                        [show_if]
                                            [have_unit]
                                                id=Hoplite,Hoplite2
                                                side=$side_number
                                                x,y=$x1,$y1
                                                [not]
                                                    [filter_wml]
                                                        [status]
                                                            unhealable=yes
                                                        [/status]
                                                    [/filter_wml]
                                                [/not]
                                            [/have_unit]
                                            [and]
                                                {VARIABLE_CONDITIONAL healpotionI_unlocked$side_number equals yes}
                                                [and]
                                                    #                    {VARIABLE_CONDITIONAL hoplite_healpotion_cooldown$side_number less_than 1}
                                                    {VARIABLE_CONDITIONAL healpotions_in_inventory$side_number greater_than 0}
                                                [/and]
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [store_unit]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                                variable=hoplite_healpotion
                                                kill=no
                                            [/store_unit]
                                            [fire_event]
                                                id=spartan_healingpotion_event
                                            [/fire_event]
                                        [/command]
                                    [/set_menu_item]
                                    [set_menu_item]
                                        id=hoplite_healpotion_on_ally
                                        description=_"Heal this ally with your healing potion"
                                        image="misc/icon_healpotion.png"
                                        [show_if]
                                            [have_unit]
                                                x,y=$x1,$y1
                                                [filter_adjacent]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter_adjacent]
                                                [filter_side]
                                                    [allied_with]
                                                        side=$side_number
                                                    [/allied_with]
                                                [/filter_side]
                                                [not]
                                                    [filter_wml]
                                                        [status]
                                                            unhealable=yes
                                                        [/status]
                                                    [/filter_wml]
                                                [/not]
                                            [/have_unit]
                                            [and]
                                                {VARIABLE_CONDITIONAL healpotionI_unlocked$side_number equals yes}
                                                [and]
                                                    #                    {VARIABLE_CONDITIONAL hoplite_healpotion_cooldown$side_number less_than 1}
                                                    {VARIABLE_CONDITIONAL healpotions_in_inventory$side_number greater_than 0}
                                                [/and]
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [store_unit]
                                                [filter]
                                                    x,y=$x1,$y1
                                                [/filter]
                                                variable=hoplite_healpotion
                                                kill=no
                                            [/store_unit]
                                            [fire_event]
                                                id=spartan_healingpotion_event
                                            [/fire_event]
                                        [/command]
                                    [/set_menu_item]
                                    [set_menu_item]
                                        id=hoplite_teleportaway
                                        description=_"Toggle the 'Teleport Away' upgrade (if you want to save energy)."
                                        [show_if]
                                            [have_unit]
                                                id=Hoplite,Hoplite2
                                                side=$side_number
                                                x,y=$x1,$y1
                                            [/have_unit]
                                            [and]
                                                {VARIABLE_CONDITIONAL teleportaway_unlocked$side_number equals yes}
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [if]
                                                [have_unit]
                                                    id=Hoplite2
                                                [/have_unit]
                                                [then]
                                                    {HOPLITE_PLAYERFILTER (
                                                        {IF_VAR teleportaway_enabled1 not_equals yes (
                                                            [then]
                                                                {VARIABLE teleportaway_enabled1 yes}
                                                            [/then]
                                                            [else]
                                                                {VARIABLE teleportaway_enabled1 no}
                                                            [/else]
                                                        )}
                                                        [print]
                                                            text= _ "Teleport Away set to <b>$teleportaway_enabled1|</b> for side 1"
                                                            size=20
                                                            blue=255
                                                            duration=3000
                                                        [/print]
                                                    ) (
                                                        {IF_VAR teleportaway_enabled2 not_equals yes (
                                                            [then]
                                                                {VARIABLE teleportaway_enabled2 yes}
                                                            [/then]
                                                            [else]
                                                                {VARIABLE teleportaway_enabled2 no}
                                                            [/else]
                                                        )}
                                                        [print]
                                                            text= _ "Teleport Away set to <b>$teleportaway_enabled2|</b> for side 2"
                                                            size=20
                                                            blue=255
                                                            duration=3000
                                                        [/print]
                                                    )}
                                                [/then]
                                                [else]
                                                    {IF_VAR teleportaway_enabled1 not_equals yes (
                                                        [then]
                                                            {VARIABLE teleportaway_enabled1 yes}
                                                        [/then]
                                                        [else]
                                                            {VARIABLE teleportaway_enabled1 no}
                                                        [/else]
                                                    )}
                                                    [print]
                                                        text= _ "Teleport Away set to <b>$teleportaway_enabled1|</b>"
                                                        size=20
                                                        blue=255
                                                        duration=3000
                                                    [/print]
                                                [/else]
                                            [/if]
                                        [/command]
                                    [/set_menu_item]
                                    [set_menu_item]
                                        id=hoplite_footwork
                                        description=_"Toggle the 'Footwork' upgrade"
                                        image="attacks/foot-boot.png~SCALE(20,20)"
                                        [show_if]
                                            [have_unit]
                                                id=Hoplite,Hoplite2
                                                side=$side_number
                                                x,y=$x1,$y1
                                            [/have_unit]
                                            [and]
                                                {VARIABLE_CONDITIONAL footwork_unlocked$side_number equals yes}
                                            [/and]
                                        [/show_if]
                                        [command]
                                            {IF_VAR hoplite_footwork_enabled$side_number not_equals yes (
                                                [then]
                                                    {VARIABLE hoplite_footwork_enabled$side_number yes}
                                                [/then]
                                                [else]
                                                    {VARIABLE hoplite_footwork_enabled$side_number no}
                                                [/else]
                                            )}
                                            [print]
                                                text= _ "Footwork set to <b>$hoplite_footwork_enabled$side_number||</b> for side $side_number|"
                                                size=20
                                                blue=255
                                                duration=3000
                                            [/print]
                                        [/command]
                                    [/set_menu_item]
                                    [set_menu_item]
                                        id=hoplite_deploy_shield
                                        description=_"Deploy Shield on this tile."
                                        image="misc/icon_deployshield.png"
                                        [show_if]
                                            [have_location]
                                                [filter_adjacent_location]
                                                    [filter]
                                                        id=Hoplite,Hoplite2
                                                        side=$side_number
                                                    [/filter]
                                                [/filter_adjacent_location]
                                                [not]
                                                    [filter]
                                                    [/filter]
                                                    [or]
                                                        #TODO: make shield also not deployable on chasms
                                                        terrain={SPARTAN_WALL_TERRAIN}
                                                    [/or]
                                                [/not]
                                                x,y=$x1,$y1
                                            [/have_location]
                                            [and]
                                                [variable]
                                                    name=deployshield_unlocked$side_number
                                                    equals=yes
                                                [/variable]
                                                [and]
                                                    [variable]
                                                        name=hoplite_deployshield_cooldown$side_number
                                                        less_than=1
                                                    [/variable]
                                                [/and]
                                            [/and]
                                        [/show_if]
                                        [command]
                                            [animate_unit]
                                                flag=standing
                                                [facing]
                                                    x,y=$x1,$y1
                                                [/facing]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                            [/animate_unit]
                                            [store_unit]
                                                [filter]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                [/filter]
                                                variable=hoplitedeployer
                                                kill=no
                                            [/store_unit]
                                            [unit]
                                                side=$hoplite_allyside
                                                type=Hoplite_Deployed_Shield
                                                x,y=$x1,$y1
                                                animate=yes
                                                placement=map
                                                passable=yes
                                                facing=$hoplitedeployer.facing
                                                [modifications]
                                                    [object]
                                                        silent=yes
                                                        [effect]
                                                            apply_to=new_ability
                                                            [abilities]
                                                                [dummy]
                                                                    id=spartan_ally_owner_side$side_number
                                                                [/dummy]
                                                                [dummy]
                                                                    id=spartan_deployshield_loc_filter
                                                                [/dummy]
                                                            [/abilities]
                                                        [/effect]
                                                    [/object]
                                                [/modifications]
                                            [/unit]
                                            {VARIABLE hoplite_deployshield_cooldown$side_number $hoplite_deployshield_max_cooldown$side_number}

                                            [if]
                                                [variable]
                                                    name=deployshieldII_unlocked$side_number
                                                    equals=yes
                                                [/variable]
                                                [then]
                                                    [object]
                                                        silent=yes
                                                        duration=forever
                                                        [filter]
                                                            ability=spartan_ally_owner_side$side_number
                                                            [and]
                                                                ability=spartan_deployshield_loc_filter
                                                            [/and]
                                                        [/filter]
                                                        [effect]
                                                            apply_to=hitpoints
                                                            increase=$deployshield_hpbonus$side_number
                                                            increase_total=$deployshield_hpbonus$side_number
                                                        [/effect]
                                                        [effect]
                                                            apply_to=new_ability
                                                            [abilities]
                                                                [resistance]
                                                                    id=deployshield_protect
                                                                    add=$deployshield_resistance$side_number
                                                                    max_value=$deployshield_resistance_cap$side_number
                                                                    # applies to any type if we leave it out
                                                                    #apply_to=blade,pierce,impact,fire,cold,arcane
                                                                    [filter_base_value]
                                                                        #                                    greater_than=0
                                                                        less_than=$deployshield_resistance_cap$side_number
                                                                    [/filter_base_value]
                                                                    affect_self=no
                                                                    affect_allies=yes
                                                                    [affect_adjacent]
                                                                        adjacent=n,ne,se,s,sw,nw
                                                                    [/affect_adjacent]
                                                                [/resistance]
                                                            [/abilities]
                                                        [/effect]
                                                    [/object]
                                                [/then]
                                            [/if]
                                            {CLEAR_VARIABLE hoplitedeployer}
                                        [/command]
                                    [/set_menu_item]
                                    {SPARTAN_GALATEA_MENU}
                                [/event]
                                [event]
                                    name=last breath
                                    id=spartan_phoenixamulet_event
                                    first_time_only=no

                                    [filter]
                                        id=Hoplite,Hoplite2
                                        [not]
                                            [filter_wml]
                                                [status]
                                                    unhealable=yes
                                                [/status]
                                            [/filter_wml]
                                        [/not]
                                    [/filter]

                                    {IF_VAR phoenixamulet_unlocked$unit.side equals yes (
                                        [and]
                                            {VARIABLE_CONDITIONAL hoplite_revive_cooldown$unit.side less_than 1}
                                        [/and]
                                        [then]
                                            [sound]
                                                name={SOUND_LIST:HOLY}
                                            [/sound]
                                            [store_unit]
                                                [filter]
                                                    x,y=$x1,$y1
                                                [/filter]
                                                variable=hoplite_reborn
                                                kill=no
                                            [/store_unit]
                                            {VARIABLE hoplite_reborn.hitpoints 0}
                                            [unstore_unit]
                                                variable=hoplite_reborn
                                                find_vacant=no
                                            [/unstore_unit]
                                            {CLEAR_VARIABLE hoplite_reborn}
                                            {FLASH_WHITE (
                                                {IF_VAR phoenixamuletII_unlocked$unit.side equals yes (
                                                    [then]
                                                        #                        [heal_unit]
                                                        #                            [filter]
                                                        #                                x,y=$x1,$y1
                                                        #                            [/filter]
                                                        #                            amount=$healpotion_restore$unit.side
                                                        #                            animate=yes
                                                        #                            restore_statuses=no
                                                        #                        [/heal_unit]
                                                        #                        [modify_unit]
                                                        #                            [filter]
                                                        #                                x,y=$x1,$y1
                                                        #                            [/filter]
                                                        #                            [status]
                                                        #                                poisoned=no
                                                        #                            [/status]
                                                        #                        [/modify_unit]
                                                        #                        {HOPLITE_ADD_ENERGY_BY_SIDE $unit.side 75}

                                                        #now phoenix amulet II just copies healing potion instead of giving flat 75 energy

                                                        [store_unit]
                                                            [filter]
                                                                x,y=$x1,$y1
                                                            [/filter]
                                                            variable=hoplite_healpotion
                                                            kill=no
                                                        [/store_unit]
                                                        {VARIABLE tmp_spartan_healpotion_side $unit.side}
                                                        [fire_event]
                                                            id=spartan_healingpotion_event
                                                        [/fire_event]
                                                    [/then]
                                                    [else]
                                                        [heal_unit]
                                                            [filter]
                                                                x,y=$x1,$y1
                                                            [/filter]
                                                            amount=10
                                                            animate=yes
                                                            restore_statuses=yes
                                                        [/heal_unit]
                                                    [/else]
                                                )}
                                                #   [delay]
                                                #     time=500
                                                #   [/delay]
                                                [sound]
                                                    name=fire.wav
                                                [/sound]
                                                [spartan_harm_unit]
                                                    [filter]
                                                        side=$hoplite_enemyside
                                                        [filter_adjacent]
                                                            x,y=$x1,$y1
                                                        [/filter_adjacent]
                                                        [not]
                                                            ability=spartan_bombfilter#otherwise dying to a bomb causes an infinite loop
                                                        [/not]
                                                    [/filter]
                                                    [filter_second]
                                                        x,y=$x1,$y1
                                                    [/filter_second]
                                                    amount=10
                                                    damage_type=fire
                                                    alignment=$unit.alignment
                                                    fire_event=yes
                                                    animate=no
                                                    delay=0
                                                    experience=no
                                                [/spartan_harm_unit]
                                                [store_unit]
                                                    [filter]
                                                        side=$hoplite_enemyside
                                                    [/filter]
                                                    kill=no
                                                    variable=slowed
                                                [/store_unit]

                                                [foreach]
                                                    array=slowed
                                                    index_var=a
                                                    [do]
                                                        {VARIABLE this_item.status.slowed yes}
                                                        [unstore_unit]
                                                            variable=this_item
                                                        [/unstore_unit]
                                                    [/do]
                                                [/foreach]
                                            )}
                                            {VARIABLE hoplite_revive_cooldown$unit.side $hoplite_phoenix_recharge$unit.side}
                                            {VARIABLE_OP revive_progress$unit.side add 1}
                                            {IF_VAR revive_progress$unit.side equals 5 (
                                                [then]
                                                    {ACHIEVEMENT_MESSAGE_LONE revive $unit.side}
                                                [/then]
                                            )}
                                            {CLEAR_VARIABLE hoplite_reborn}
                                            {ALGADUR_LINE phoenix_amulet (
                                                [message]
                                                    speaker=Algadur
                                                    message=_"By my beard, ye actually got back up from that?!"
                                                [/message]
                                                [message]
                                                    id=Hoplite,Hoplite2
                                                    side=$unit.side
                                                    message=_"Indeed, it is only thanks to the Phoenix Amulet that I managed to survive this hit."
                                                [/message]
                                            )}
                                            {ELIZABETH_LINE phoenix_amulet (
                                                [message]
                                                    speaker=Elizabeth
                                                    message=_"By the Lords of Light, you're alive!? That would have killed anyone!"
                                                [/message]
                                                [message]
                                                    id=Hoplite,Hoplite2
                                                    side=$unit.side
                                                    message=_"It is thanks to my Phoenix Amulet that I continue to live."
                                                [/message]
                                                [message]
                                                    speaker=Elizabeth
                                                    message=_"An artifact that can cheat death itself...! Not even the Ruby of Fire can compare to that!"
                                                [/message]
                                            )}
                                        [/then]
                                    )}
                                [/event]
                                [event]
                                    name=attack
                                    first_time_only=no
                                    [filter]
                                        side=$hoplite_enemyside
                                    [/filter]
                                    [filter_second]
                                        id=Hoplite,Hoplite2
                                        ability=hoplite_teleportaway
                                    [/filter_second]

                                    [store_unit]
                                        [filter]
                                            id=Hoplite,Hoplite2
                                            x,y=$x2,$y2
                                        [/filter]
                                        variable=hoplite_teleportloc
                                        kill=no
                                    [/store_unit]

                                    {VARIABLE x2 $hoplite_teleportloc.x}
                                    {VARIABLE y2 $hoplite_teleportloc.y}
                                    {VARIABLE teleportaway_cost $weapon.damage}
                                    {VARIABLE_OP teleportaway_cost divide 10}
                                    {VARIABLE_OP teleportaway_cost multiply 75}
                                    {HOPLITE_GET_RESIST_MULT $second_unit.id $weapon.type}
                                    {VARIABLE_OP teleportaway_cost multiply $tmp_resistmult}
                                    {VARIABLE_OP teleportaway_cost round floor}
                                    {CLEAR_VARIABLE hoplite_teleportloc}
                                    {HOPLITE_TELEPORTAWAY_EVENT $teleportaway_cost (
                                        x,y=$x2,$y2
                                    )}
                                    {CLEAR_VARIABLE teleportaway_cost}
                                [/event]
                                [event]
                                    name=attack end
                                    first_time_only=no
                                    [filter_second]
                                        id=Hoplite,Hoplite2
                                    [/filter_second]
                                    [fire_event]
                                        id=hoplite_adrenaline
                                    [/fire_event]
                                [/event]
                                #moved to a seperate event, to allow for multiple healing potion menu items
                                [event]
                                    id=spartan_healingpotion_event
                                    first_time_only=no

                                    {IF_VAR tmp_spartan_healpotion_side greater_than 0 (
                                        [else]
                                            {VARIABLE tmp_spartan_healpotion_side $side_number}
                                        [/else]
                                    )}


                                    #the "heal ally at low hp" achievement

                                    [if]
                                    [have_unit]
                                        id=$hoplite_healpotion.id
                                        formula="hitpoints <= 5"
                                        [not]
                                            id=Hoplite,Hoplite2
                                            side=$side_number
                                        [/not]
                                    [/have_unit]
                                    [then]
                                        {ACHIEVEMENT_MESSAGE_LONE medic $side_number}
                                    [/then]
                                    [/if]


                                    #unit is now stored earlier, to ensure this works properly for the "heal ally with potion" feature
                                    #            [store_unit]
                                    #                [filter]
                                    #                    id=Hoplite,Hoplite2
                                    #                    side=$tmp_spartan_healpotion_side
                                    #                [/filter]
                                    #                variable=hoplite_healpotion
                                    #                kill=no
                                    #            [/store_unit]


                                    #if players try to use the healing potion at full hp but have Invigorating Healing upgrade, ask for confirmation

                                    [if]
                                        [variable]
                                            name=hoplite_healpotion.hitpoints
                                            greater_than_equal_to=$hoplite_healpotion.max_hitpoints
                                        [/variable]
                                        [and]
                                            {VARIABLE_CONDITIONAL healpotionenergy_unlocked$tmp_spartan_healpotion_side equals yes}
                                        [/and]
                                        [then]
                                            [message]
                                                speaker=narrator
                                                caption=_ "Healing Potion Confirmation"
                                                message=_ "Using a healing potion on a unit with <span color='#ffff99'>full hitpoints</span> will not heal anything, but since you have the <span color='#ffff99'>Invigorating Healing</span> upgrade, you will still get those bonuses.

Are you sure you want to use the healing potion?"
                                                [option]
                                                    image="misc/blank-hex.png"
                                                    description=_"No"
                                                    [command]
                                                    [/command]
                                                [/option]
                                                [option]
                                                    image="icons/healpotionenergy.png"
                                                    description=_"Yes"
                                                    [command]
                                                        {VARIABLE tmp_healpotion_use_despite_full_hp yes}
                                                    [/command]
                                                [/option]
                                            [/message]
                                        [/then]
                                    [/if]

                                    [if]
                                        [variable]
                                            name=hoplite_healpotion.hitpoints
                                            less_than=$hoplite_healpotion.max_hitpoints
                                        [/variable]
                                        [or]
                                            {VARIABLE_CONDITIONAL tmp_healpotion_use_despite_full_hp equals yes}
                                        [/or]
                                        [then]
                                            [unstore_unit]
                                                variable=hoplite_healpotion
                                            [/unstore_unit]
                                            [sound]
                                                name=potion.ogg
                                            [/sound]
                                            [heal_unit]
                                                [filter]
                                                    id=$hoplite_healpotion.id
                                                [/filter]
                                                amount=$healpotion_restore$tmp_spartan_healpotion_side
                                                animate=yes
                                                restore_statuses=no
                                            [/heal_unit]
                                            [modify_unit]
                                                [filter]
                                                    id=$hoplite_healpotion.id
                                                [/filter]
                                                [status]
                                                    poisoned=no
                                                [/status]
                                            [/modify_unit]
                                            {SPARTAN_REMOVE_BURN id=$hoplite_healpotion.id}


                                            ##now potions are once per depth
                                            ##                                {IF_VAR healpotionbag_unlocked1 equals yes (
                                            ##                                    [then]
                                            #                                        {VARIABLE hoplite_healpotion_cooldown$tmp_spartan_healpotion_side 1}
                                            ##                                    [/then]
                                            ##                                    [else]
                                            ##                                        {VARIABLE hoplite_healpotion_cooldown1 2}
                                            ##                                    [/else]
                                            ##                                )}

                                            {VARIABLE_OP healpotions_in_inventory$tmp_spartan_healpotion_side sub 1}

                                            {IF_VAR healpotionenergy_unlocked$tmp_spartan_healpotion_side equals yes (
                                                [then]
                                                    {VARIABLE tmp_potionenergybonus_mult 0.5}
                                                [/then]
                                            )}
                                            #energy is added a second time
                                            {IF_VAR healpotionenergyII_unlocked$tmp_spartan_healpotion_side equals yes (
                                                [then]
                                                    {VARIABLE tmp_potionenergybonus_mult 0.8}

                                                    [object]
                                                        silent=yes
                                                        duration=turn end #originally the duration was turn, but that failed to work properly with allies/other player in multiplayer
                                                        [filter]
                                                            id=$hoplite_healpotion.id
                                                        [/filter]
                                                        [effect]
                                                            apply_to=attack
                                                            increase_damage=50%
                                                        [/effect]
                                                    [/object]
                                                    [floating_text]
                                                        [filter]
                                                            id=$hoplite_healpotion.id
                                                        [/filter]
                                                        text="<span color='#ffc800'>" + _ "+50% damage!" + "</span>"
                                                    [/floating_text]
                                                [/then]
                                            )}
                                            {IF_VAR tmp_potionenergybonus_mult greater_than 0 (
                                                [then]
                                                    {VARIABLE tmp_potion_energybonus $hoplite_maxenergy1}
                                                    {VARIABLE_OP tmp_potion_energybonus multiply $tmp_potionenergybonus_mult}
                                                    {VARIABLE_OP tmp_potion_energybonus round floor}
                                                    [delay]
                                                        time=500
                                                    [/delay]
                                                    [sound]
                                                        name=magic-faeriefire.ogg
                                                    [/sound]

                                                    {IF_VAR hoplite_healpotion.side equals $hoplite_allyside (
                                                        [then]
                                                            [object]
                                                                silent=yes
                                                                duration=turn end
                                                                [filter]
                                                                    id=$hoplite_healpotion.id
                                                                [/filter]
                                                                [effect]
                                                                    apply_to=movement
                                                                    increase=1
                                                                [/effect]
                                                            [/object]
                                                        [/then]
                                                        [else]
                                                            {HOPLITE_ADD_ENERGY_BY_SIDE $hoplite_healpotion.side $tmp_potion_energybonus}
                                                        [/else]
                                                    )}
                                                [/then]
                                            )}
                                            {CLEAR_VARIABLE tmp_potionenergybonus_mult}
                                            {CLEAR_VARIABLE tmp_potion_energybonus}
                                        [/then]
                                        [else]
                                            [print]
                                                text= _ "Hitpoints are already full!"
                                                size=20
                                                red=255
                                                duration=2000
                                            [/print]
                                        [/else]
                                    [/if]
                                    {CLEAR_VARIABLE tmp_spartan_healpotion_side}
                                    {CLEAR_VARIABLE tmp_healpotion_use_despite_full_hp}
                                [/event]
                                [event]
                                    id=spartan_skill_menu_event
                                    first_time_only=no
                                    {SPARTAN_CREATE_COOLDOWN_TEXT_VARIABLES_FOR_SKILL_MENU}
                                    [message]
                                        speaker=narrator
                                        caption=_ "$spartan_classname$side_number|| Skills menu"
                                        message=_ "Select a skill to use:"
#ifdef MULTIPLAYER
                                        side_for=$side_number
#endif
                                        [option]
                                            image="attacks/blank-attack.png"
                                            description=_"Return to the Game"
                                            [command]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/spear-precise-stab.png"
                                            description=_"<span color='#ffff99'>Precise Stab</span>: melee spear gains +$precisestab_damage$side_number|| damage until the end of the turn
   costs <span color='#ffff99'>50</span> energy"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL skill_spear_unlocked$side_number equals yes}
                                                [and]
                                                    [not]
                                                        [have_unit]
                                                            side=$side_number
                                                            id=Hoplite,Hoplite2
                                                            ability=spartan_skill_used_precise_stab
                                                        [/have_unit]
                                                    [/not]
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                #cannot use weapon-boosting skills if you are not even able to attack, otherwise you just waste energy
                                                [have_unit]
                                                    side=$side_number
                                                    id=Hoplite,Hoplite2
                                                    formula="attacks_left > 0"
                                                [/have_unit]
                                                [then]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 50}
                                                    [then]
                                                        [sound]
                                                            name=windsweep.ogg#works pretty well as a power up sound
                                                        [/sound]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Precise Stab" + "</span>"
                                                        [/floating_text]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=spear
                                                                increase_damage=$precisestab_damage$side_number|
                                                                #[set_specials]
                                                                #    mode=append
                                                                #    {WEAPON_SPECIAL_SLOW}
                                                                #[/set_specials]
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    [dummy]
                                                                        id=spartan_skill_used_precise_stab
                                                                    [/dummy]
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -50}
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Cannot use this skill if you are unable to attack!"
                                                        size=20
                                                        red=255
                                                        duration=2000
                                                    [/print]
                                                [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="icons/protect-royal-3.png"
                                            description=_"<span color='#ffff99'>Charged Bash</span>: shield gains +2 knockback$chargedbash_text$side_number|$chargedbash_text_stun$side_number| until the end of the turn
   costs <span color='#ffff99'>50</span> energy"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL skill_chargedbash_unlocked$side_number equals yes}
                                                [and]
                                                    [not]
                                                        [have_unit]
                                                            side=$side_number
                                                            id=Hoplite,Hoplite2
                                                            ability=spartan_skill_used_chargedbash
                                                        [/have_unit]
                                                    [/not]
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                #cannot use weapon-boosting skills if you are not even able to attack, otherwise you just waste energy
                                                [have_unit]
                                                    side=$side_number
                                                    id=Hoplite,Hoplite2
                                                    formula="attacks_left > 0"
                                                [/have_unit]
                                                [then]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 50}
                                                    [then]
                                                        [sound]
                                                            name=windsweep.ogg#works pretty well as a power up sound
                                                        [/sound]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Charged Bash" + "</span>"
                                                        [/floating_text]
                                                        {VARIABLE tmp_new_knockback 3}
                                                        {VARIABLE_OP tmp_new_knockback add $charged_shieldbash_knockback_bonus$side_number}
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=shield
                                                                increase_damage=$chargedbash_damage$side_number
                                                                remove_specials=knockback
                                                                [set_specials]
                                                                    mode=append
                                                                    {SPARTAN_KNOCKBACKSPECIAL $tmp_new_knockback}
                                                                [/set_specials]
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    [dummy]
                                                                        id=spartan_skill_used_chargedbash
                                                                    [/dummy]
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        [if]
                                                        {VARIABLE_CONDITIONAL chargedbash_stun_unlocked$side_number equals yes}
                                                        [then]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=shield
                                                                [set_specials]
                                                                    mode=append
                                                                    {WEAPON_SPECIAL_SPARTAN_LONG_SLOW}
                                                                [/set_specials]
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    [dummy]
                                                                        id=spartan_skill_used_chargedbash
                                                                    [/dummy]
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        [/then]
                                                        [/if]

                                                        {CLEAR_VARIABLE tmp_new_knockback}
                                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -50}
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Cannot use this skill if you are unable to attack!"
                                                        size=20
                                                        red=255
                                                        duration=2000
                                                    [/print]
                                                [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/shortsword-rapid-slash.png"
                                            description=_"<span color='#ffff99'>Rapid Slash</span>: after your next melee attack this turn
    You can immediately attack again
    But you can only use the shortsword for that attack
    Stacks with Sword Combo
    (if you get a Combo kill while Rapid Slash is active
    you can attack 2 extra times instead of 1)
    If you get another attack (like from Sword Combo) you can use other weapons again
    Can only use the skill once per turn
    costs <span color='#ffff99'>50</span> energy"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL skill_rapid_slash_unlocked$side_number equals yes}
                                                [and]
                                                    [not]
                                                        [have_unit]
                                                            side=$side_number
                                                            id=Hoplite,Hoplite2
                                                            ability=spartan_skill_used_rapid_slash
                                                        [/have_unit]
                                                    [/not]
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                #cannot use weapon-boosting skills if you are not even able to attack, otherwise you just waste energy
                                                [have_unit]
                                                    side=$side_number
                                                    id=Hoplite,Hoplite2
                                                    formula="attacks_left > 0"
                                                [/have_unit]
                                                [then]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 50}
                                                    [then]
                                                        [sound]
                                                            name=windsweep.ogg#works pretty well as a power up sound
                                                        [/sound]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Rapid Slash" + "</span>"
                                                        [/floating_text]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            id=rapid_slash_effects
                                                            take_only_once=no
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    [dummy]
                                                                        id=spartan_rapid_slash_active
                                                                    [/dummy]
                                                                    [dummy]
                                                                        id=spartan_skill_used_rapid_slash
                                                                    [/dummy]
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    [dummy]
                                                                        id=spartan_skill_used_rapid_slash
                                                                    [/dummy]
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -50}
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Cannot use this skill if you are unable to attack!"
                                                        size=20
                                                        red=255
                                                        duration=2000
                                                    [/print]
                                                [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/frenzy.png"
                                            description=_"<span color='#ffff99'>Execution</span>: axe gains damage equal to 20% of your current energy
   costs <span color='#ffff99'>all</span> of your energy, requires at least 25 energy"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL skill_execution_unlocked$side_number equals yes}
                                                [and]
                                                    [not]
                                                        [have_unit]
                                                            side=$side_number
                                                            id=Hoplite,Hoplite2
                                                            ability=spartan_skill_used_execution
                                                        [/have_unit]
                                                    [/not]
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                #cannot use weapon-boosting skills if you are not even able to attack, otherwise you just waste energy
                                                [have_unit]
                                                    side=$side_number
                                                    id=Hoplite,Hoplite2
                                                    formula="attacks_left > 0"
                                                [/have_unit]
                                                [then]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 25}
                                                    [then]
                                                        [sound]
                                                            name=windsweep.ogg#works pretty well as a power up sound
                                                        [/sound]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Execution" + "</span>"
                                                        [/floating_text]
                                                        {VARIABLE tmp_axe_dmgbonus $hoplite_energy$side_number}
                                                        {VARIABLE_OP tmp_axe_dmgbonus multiply 0.2}
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=axe
                                                                increase_damage=$tmp_axe_dmgbonus
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    [dummy]
                                                                        id=spartan_skill_used_execution
                                                                    [/dummy]
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        {CLEAR_VARIABLE tmp_axe_dmgbonus}
                                                        #drain all energy
                                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -$hoplite_energy$side_number}
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Cannot use this skill if you are unable to attack!"
                                                        size=20
                                                        red=255
                                                        duration=2000
                                                    [/print]
                                                [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/fireball.png"
                                            description=_"<span color='#ffff99'>Explosive Spear</span>: +$hoplite_spearthrow_explosive_damage_bonus$side_number|| damage until the end of the turn
   damages enemies adjacent to the target by 50% of the base damage
   Costs <span color='#ffff99'>75</span> energy"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL spearthrowexplode_unlocked$side_number equals yes}
                                                [and]
                                                    [not]
                                                        [have_unit]
                                                            side=$side_number
                                                            id=Hoplite,Hoplite2
                                                            ability=spartan_skill_used_explosive_spear
                                                        [/have_unit]
                                                    [/not]
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                #cannot use weapon-boosting skills if you are not even able to attack, otherwise you just waste energy
                                                [have_unit]
                                                    side=$side_number
                                                    id=Hoplite,Hoplite2
                                                    formula="attacks_left > 0"
                                                [/have_unit]
                                                #cannot use Explosive Spear skill when the spear is on the ground
                                                [and]
                                                    {VARIABLE_CONDITIONAL hoplite_spear_on_ground$side_number not_equals yes}                               
                                                [/and]
                                                [then]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 75}
                                                    [then]
                                                        [sound]
                                                            name=windsweep.ogg#works pretty well as a power up sound
                                                        [/sound]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Explosive Spear" + "</span>"
                                                        [/floating_text]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=spear2
                                                                increase_damage=$hoplite_spearthrow_explosive_damage_bonus$side_number
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    [dummy]
                                                                        id=spartan_skill_used_explosive_spear
                                                                    [/dummy]
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        #drain all energy
                                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -75}
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Cannot use this skill if you are unable to attack or the spear is on the ground!"
                                                        size=20
                                                        red=255
                                                        duration=2000
                                                    [/print]
                                                [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="icons/shadowclone.png"
                                            description=_"<span color='#ffff99'>Shadow Clone</span>: Summon an allied Shadow Clone of yourself
   Costs <span color='#ffff99'>100</span> energy
   has a cooldown of $hoplite_shadowclone_cooldown_max$side_number|| depth(s)"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL shadowclone_unlocked$side_number equals yes}
                                                [and]
                                                    {VARIABLE_CONDITIONAL hoplite_shadowclone_cooldown$side_number less_than 1}
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 100}
                                                    [then]
                                                        [if]
                                                            [have_unit]
                                                                id=Hoplite2
                                                            [/have_unit]
                                                            [then]
                                                                {HOPLITE_PLAYERFILTER (
                                                                    {VARIABLE shadowclone_id Hoplite}
                                                                ) (
                                                                    {VARIABLE shadowclone_id Hoplite2}
                                                                )}
                                                            [/then]
                                                            [else]
                                                                {VARIABLE shadowclone_id Hoplite}
                                                            [/else]
                                                        [/if]
                                                        {HOPLITE_SHADOWCLONE_EVENT $shadowclone_id}
                                                        [if]
                                                            [variable]
                                                                name=clonesuccess
                                                                equals=yes
                                                            [/variable]
                                                            [then]
                                                                [floating_text]
                                                                    x,y=$x1,$y1
                                                                    text="<span color='#ffff99'>" + _ "Shadow Clone" + "</span>"
                                                                [/floating_text]
                                                                {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -100}
                                                                {VARIABLE hoplite_shadowclone_cooldown$side_number $hoplite_shadowclone_cooldown_max$side_number}
                                                            [/then]
                                                        [/if]
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                {CLEAR_VARIABLE shadowclone_id}
                                                {CLEAR_VARIABLE shadowclone_type}
                                                {CLEAR_VARIABLE clonesuccess}
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/blank-attack.png~BLIT(attacks/bow-elven.png~CROP(5,5,49,49)~O(70%)~GS()~CS(-200,-40,-0),5,5)"
                                            description=_"<span color='#ffff99'>Spirit Archer</span>: Summon an allied Spirit Archer
   Costs <span color='#ffff99'>100</span> energy
   has a cooldown of 1 depth(s)"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL summonedarcher_unlocked$side_number equals yes}
                                                [and]
                                                    {VARIABLE_CONDITIONAL hoplite_summonedarcher_cooldown$side_number less_than 1}
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 100}
                                                    [then]
                                                        [if]
                                                            [have_unit]
                                                                id=Hoplite2
                                                            [/have_unit]
                                                            [then]
                                                                {HOPLITE_PLAYERFILTER (
                                                                    {VARIABLE summonedarcher_id Hoplite}
                                                                ) (
                                                                    {VARIABLE summonedarcher_id Hoplite2}
                                                                )}
                                                            [/then]
                                                            [else]
                                                                {VARIABLE summonedarcher_id Hoplite}
                                                            [/else]
                                                        [/if]
                                                        {HOPLITE_SUMMONEDARCHER_EVENT $summonedarcher_id}
                                                        [if]
                                                            [variable]
                                                                name=clonesuccess
                                                                equals=yes
                                                            [/variable]
                                                            [then]
                                                                [floating_text]
                                                                    x,y=$x1,$y1
                                                                    text="<span color='#ffff99'>" + _ "Spirit Archer" + "</span>"
                                                                [/floating_text]
                                                                {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -100}
                                                                {VARIABLE hoplite_summonedarcher_cooldown$side_number 1}
                                                            [/then]
                                                        [/if]
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                {CLEAR_VARIABLE summonedarcher_id}
                                                {CLEAR_VARIABLE summonedarcher_type}
                                                {CLEAR_VARIABLE clonesuccess}
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/bow-elven-magic.png"
                                            description=_"<span color='#ffff99'>Overdraw Mode</span>: Bow deals +$spartan_bow_overdraw_damagebonus$side_number|| damage
            Bow no longer shoots instantly

            Lasts until you use Quickdraw Mode skill"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL bowIV_unlocked$side_number equals yes}
                                                [and]
                                                    {VARIABLE_CONDITIONAL spartan_bow_mode$side_number equals quickdraw}
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [floating_text]
                                                    x,y=$x1,$y1
                                                    text="<span color='#ffff99'>" + _ "Overdraw Mode" + "</span>"
                                                [/floating_text]
                                                {VARIABLE spartan_bow_mode$side_number overdraw}
                                                [object]
                                                    silent=yes
                                                    duration=forever
                                                    id=bow_overdraw_bonus
                                                    take_only_once=no
                                                    [filter]
                                                        id=Hoplite,Hoplite2
                                                        side=$side_number
                                                    [/filter]
                                                    [effect]
                                                        apply_to=attack
                                                        name=bow
                                                        increase_damage=$spartan_bow_overdraw_damagebonus$side_number
                                                    [/effect]
                                                [/object]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/bow-elven-magic.png"
                                            description=_"<span color='#ffff99'>Quickdraw Mode</span>: Bow shoots instantly
            But no longer has the damage bonus from Overdraw mode

            Lasts until you use Overdraw Mode skill"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL bowIV_unlocked$side_number equals yes}
                                                [and]
                                                    {VARIABLE_CONDITIONAL spartan_bow_mode$side_number equals overdraw}
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [floating_text]
                                                    x,y=$x1,$y1
                                                    text="<span color='#ffff99'>" + _ "Quickdraw Mode" + "</span>"
                                                [/floating_text]
                                                {VARIABLE spartan_bow_mode$side_number quickdraw}
                                                [remove_object]
                                                    id=Hoplite,Hoplite2
                                                    side=$side_number
                                                    object_id=bow_overdraw_bonus
                                                [/remove_object]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/gaze.png"
                                            description=_"<span color='#ffff99'>Auto-Loyal</span>: Toggle whether enthralled enemies instantly become loyal when enthralled
            This can be useful if you want to enthrall the last remaining enemy on the map or don't want to click the loyal menu each time
            Only works while you are below the loyal thrall limit
            Currently set to <span color='#9999ff'>$spartan_thrall_auto_loyal$side_number||</span>"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL enthrall_loyal_unlocked$side_number equals yes}
                                            [/show_if]
                                            [command]
                                                [floating_text]
                                                    x,y=$x1,$y1
                                                    text="<span color='#ffff99'>" + _ "Auto-Loyal" + "</span>"
                                                [/floating_text]

                                                {IF_VAR spartan_thrall_auto_loyal$side_number equals yes (
                                                [then]
                                                    {VARIABLE spartan_thrall_auto_loyal$side_number no}
                                                [/then]
                                                [else]
                                                    {VARIABLE spartan_thrall_auto_loyal$side_number yes}
                                                [/else]
                                                )}
                                            [/command]
                                        [/option]
                                        [option]
                                            image="icons/book2.png"
                                            description=_"<span color='#ffff99'>Book of Pacts</span>: Choose a pact
   has a cooldown of $hoplite_book_of_pacts_cooldown_max$side_number|| depths
   (unless you cancel out of the pact menu)"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL book_of_pacts_unlocked$side_number equals yes}
                                                [and]
                                                    {VARIABLE_CONDITIONAL hoplite_book_of_pacts_cooldown$side_number less_than 1}
                                                [/and]
                                            [/show_if]
                                            [command]
                                                {VARIABLE tmp_book_of_pacts_menu yes}
                                                [message]
                                                    speaker=narrator
                                                    caption=_"Book of Pacts"
                                                    image="portraits/book.png~GS()~BLEND(0,0,0,0.4)"
                                                    message=_"Choose a pact..."
                                                    [option]
                                                        image="misc/red-x.png"
                                                        description=_"Return to the game"
                                                        [command]
#no longer needed
#                                                            {VARIABLE tmp_pact_cancelled yes}
                                                        [/command]
                                                    [/option]
                                                    {SPARTAN_PACT_OPTIONS}
                                                [/message]

                                                {IF_VAR tmp_spartan_pact_taken_from_book equals yes (
                                                    [then]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Book of Pacts" + "</span>"
                                                        [/floating_text]
                                                        [sound]
                                                            name=magic-dark-big.ogg
                                                        [/sound]
                                                        {VARIABLE hoplite_book_of_pacts_cooldown$side_number $hoplite_book_of_pacts_cooldown_max$side_number}
                                                    [/then]
                                                )}

#                                                {CLEAR_VARIABLE tmp_pact_cancelled}
                                                {CLEAR_VARIABLE tmp_book_of_pacts_menu}
                                                {CLEAR_VARIABLE tmp_spartan_pact_taken_from_book}
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/iceball.png"
                                            description=_"<span color='#ffff99'>Ring of Frost</span>: deal $ringfrost_damage$side_number|| cold damage to units in a 2-tile radius but NOT adjacent to you
    Ends your turn
    costs <span color='#ffff99'>50</span> energy
    Can only use this skill if you can still attack normally
    Not affected by damage buffs
    Energy/turn is only spent if there are enemies in range of the attack"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL skill_ringfrost_unlocked$side_number equals yes}
                                            [/show_if]
                                            [command]
                                                [if]
                                                    {VARIABLE_CONDITIONAL hoplite_energy$side_number greater_than_equal_to 50}
                                                    [then]
                                                    [if]
                                                        [have_unit]
                                                            x,y=$x1,$y1
                                                            formula="attacks_left > 0"
                                                            [not]
                                                                ability=spartan_disable_player_ranged_attacks
                                                            [/not]
                                                        [/have_unit]
                                                        [then]

                                                        #only trigger the skill if there are targets in range:

                                                        [store_locations]
                                                            terrain=!,{SPARTAN_WALL_TERRAIN}
                                                            [and]
                                                                x,y=$x1,$y1
                                                                radius=2
                                                                #[filter_radius]
                                                                #    terrain=!,{SPARTAN_WALL_TERRAIN}
                                                                #[/filter_radius]
                                                            [/and]
                                                            [not]
                                                                x,y=$x1,$y1
                                                            [/not]
                                                            [and]
                                                                [not]
                                                                    x,y=$x1,$y1
                                                                    radius=1
                                                                [/not]
                                                            [/and]
                                                            variable=tmp_ring_of_frost_targethexes
                                                            include_borders=no
                                                            mode=append
                                                        [/store_locations]

                                                        [foreach]
                                                            array=tmp_ring_of_frost_targethexes
                                                            variable=this_item2
                                                            index_var=e
                                                            [do]
                                                                [set_variables]
                                                                    name=tmp_item_tag_container
                                                                    [value]
                                                                        x=$this_item2.x
                                                                        y=$this_item2.y
                                                                        image="misc/targethex.png"
                                                                        name=hoplite_player_ring_of_frost_targethex
                                                                    [/value]
                                                                [/set_variables]

                                                                #am using [insert_tag] instead of just item, otherwise the game doesn't substitute the id variable for some reason

                                                                [insert_tag]
                                                                    name=item
                                                                    variable=tmp_item_tag_container
                                                                [/insert_tag]

                                                                {CLEAR_VARIABLE tmp_item_tag_container}
                                                            [/do]
                                                        [/foreach]

                                                        [sound]
                                                            name=magic-dark-big-miss.ogg
                                                        [/sound]
                                                        [delay]
                                                            time=500
                                                        [/delay]
                                                        [remove_item]
                                                            image=hoplite_player_ring_of_frost_targethex
                                                            x,y=0-99
                                                        [/remove_item]
                                                        [redraw][/redraw]

                                                        [if]
                                                        [have_unit]
                                                            side=$hoplite_enemyside
                                                            #using find_in to ensure consistency
                                                            [filter_location]
                                                                find_in=tmp_ring_of_frost_targethexes
                                                            [/filter_location]
                                                        [/have_unit]
                                                        [then]

                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Ring of Frost" + "</span>"
                                                        [/floating_text]
                                                        #energy is spent BEFORE harm_unit, so the player can benefit from energy from kills properly
                                                        {HOPLITE_ADD_ENERGY_BY_SIDE $side_number -50}
                                                        [animate_unit]
                                                            flag=ringfrost
                                                            [filter]
                                                                x,y=$x1,$y1
                                                            [/filter]
                                                        [/animate_unit]
                                                        [store_unit]
                                                            [filter]
                                                                id=Hoplite,Hoplite2
                                                                side=$side_number
                                                            [/filter]
                                                            variable=hoplitering
                                                            kill=no
                                                        [/store_unit]
                                                        {SPARTAN_CALCULATE_DAMAGE hoplitering $ringfrost_damage$side_number||}

                                                        #check how many enemies got hit by ring of frost:
                                                        [store_unit]
                                                            [filter]
                                                                side=$hoplite_enemyside
                                                                #using find_in to ensure consistency
                                                                [filter_location]
                                                                    find_in=tmp_ring_of_frost_targethexes
                                                                [/filter_location]
                                                                #[filter_location]
                                                                #    x,y=$x1,$y1
                                                                #    radius=2
                                                                #[/filter_location]
                                                                #[not]
                                                                #    [filter_adjacent]
                                                                #        x,y=$x1,$y1
                                                                #    [/filter_adjacent]
                                                                #[/not]
                                                            [/filter]
                                                            variable=tmp_ring_of_frost_targets_for_achievement
                                                            kill=no
                                                        [/store_unit]

                                                        {SPARTAN_HIT_BOSS_KILLSTREAK_AND_ENERGY $side_number (
                                                            #using find_in to ensure consistency
                                                            [filter_location]
                                                                find_in=tmp_ring_of_frost_targethexes
                                                            [/filter_location]

                                                            #[filter_location]
                                                            #    x,y=$x1,$y1
                                                            #    radius=2
                                                            #[/filter_location]
                                                            #[not]
                                                            #    [filter_adjacent]
                                                            #        x,y=$x1,$y1
                                                            #    [/filter_adjacent]
                                                            #[/not]
                                                        )}
                                                        {SPARTAN_ATTACKER_UNCOVER_INVISIBILITY id=$hoplitering.id}

                                                        [spartan_harm_unit]
                                                            [filter]
                                                                side=$hoplite_enemyside
                                                                #using find_in to ensure consistency
                                                                [filter_location]
                                                                    find_in=tmp_ring_of_frost_targethexes
                                                                [/filter_location]
                                                                #[filter_location]
                                                                #    x,y=$x1,$y1
                                                                #    radius=2
                                                                #[/filter_location]
                                                                #[not]
                                                                #    [filter_adjacent]
                                                                #        x,y=$x1,$y1
                                                                #    [/filter_adjacent]
                                                                #[/not]
                                                            [/filter]
                                                            [filter_second]
                                                                id=$hoplitering.id
                                                            [/filter_second]
                                                            #[primary_attack]
                                                            #    name=wizardbeam
                                                            #[/primary_attack]
                                                            amount=$tmp_spartan_calculated_damage
                                                            damage_type=cold
                                                            fire_event=yes
                                                            animate=defender
                                                            delay=0
                                                            experience=yes
                                                        [/spartan_harm_unit]
                                                        {IF_VAR tmp_ring_of_frost_targets_for_achievement.length greater_than_equal_to 4 (
                                                        [then]
                                                            {ACHIEVEMENT_MESSAGE_LONE ringfrost_aoe $side_number}
                                                        [/then]
                                                        )}
                                                        {CLEAR_VARIABLE tmp_ring_of_frost_targets_for_achievement}

                                                        {CLEAR_VARIABLE tmp_spartan_calculated_damage}
                                                        {CLEAR_VARIABLE hoplitering}
                                                        {ELIZABETH_MAGIC_LINE ringoffrost (
                                                            [message]
                                                                speaker=Elizabeth
                                                                message=_"I'm more of a pyromancer myself, but I suppose ice magic has its merits too."
                                                            [/message]
                                                        )}
                                                        {GALATEA_ALLY_LINE ringfrost (
                                                            [message]
                                                                speaker=Galatea
                                                                message=_"I see you know cryomancy too. You remind me of Donovan a bit. His subordinates' ice magic research was quite useful."
                                                            [/message]
                                                        )}

                                                        #manually subtract attacks_left, so that it counts as an attack for Rest upgrades

                                                        {MODIFY_UNIT id=$hoplitering.id attacks_left "$($hoplitering.attacks_left - 1)"}

                                                        [end_turn]
                                                        [/end_turn]

                                                        [/then]
                                                        [/if]

                                                        [/then]
                                                        [else]
                                                            [print]
                                                                text= _ "Cannot attack now!"
                                                                size=20
                                                                red=255
                                                                duration=2000
                                                            [/print]
                                                        [/else]
                                                    [/if]
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Not enough energy!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                {CLEAR_VARIABLE tmp_ring_of_frost_targethexes}
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/staff-enchant-arcane.png"
                                            description=_"<span color='#ffff99'>Smiting Staff</span>: staff gains +$staff_arcane_damage$side_number|| damage until the end of the turn$staff_arcane_text$side_number||
    staff damage type changes from impact to arcane while this is active
    cannot use the other staff enchantments while this is active
    Cooldown: <span color='#ffff99'>$staff_arcane_max_cooldown$side_number||</span> turns
    Remaining Cooldown: <span color='#ffff99'>$staff_arcane_cooldown$side_number|_textvar|</span>"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL skill_staff_enchantment_unlocked$side_number equals yes}
                                                [and]
                                                    [not]
                                                        [have_unit]
                                                            side=$side_number
                                                            id=Hoplite,Hoplite2
                                                            ability=spartan_skill_used_a_staff_enchantment
                                                        [/have_unit]
                                                    [/not]
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                #cannot use weapon-boosting skills if you are not even able to attack, otherwise you just waste energy
                                                [have_unit]
                                                    side=$side_number
                                                    id=Hoplite,Hoplite2
                                                    formula="attacks_left > 0"
                                                [/have_unit]
                                                [then]
                                                [if]
                                                    {VARIABLE_CONDITIONAL staff_arcane_cooldown$side_number less_than_equal_to 0}
                                                    [then]
                                                        #[sound]
                                                        #    name=windsweep.ogg#works pretty well as a power up sound
                                                        #[/sound]
                                                        [sound]
                                                            name={SOUND_LIST:HOLY_MISS}
                                                        [/sound]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Smiting Staff" + "</span>"
                                                        [/floating_text]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=staff
                                                                increase_damage=$staff_arcane_damage$side_number|
                                                                set_type=arcane
                                                                #[set_specials]
                                                                #    mode=append
                                                                #    {WEAPON_SPECIAL_SLOW}
                                                                #[/set_specials]
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    [dummy]
                                                                        id=spartan_skill_used_a_staff_enchantment
                                                                    [/dummy]
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        [if]
                                                        {VARIABLE_CONDITIONAL staff_arcane_damage_holy$side_number greater_than 0}
                                                        [then]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=staff
                                                                [set_specials]
                                                                    mode=append
                                                                    {WEAPON_SPECIAL_SPARTAN_HOLY $staff_arcane_damage_holy$side_number}
                                                                [/set_specials]
                                                            [/effect]
                                                        [/object]
                                                        [/then]
                                                        [/if]

                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=staff
                                                                [set_specials]
                                                                    mode=append
                                                                    [dummy]
                                                                        #can be staff_anim_arcane_small, staff_anim_arcane_medium or staff_anim_arcane_big
                                                                        id=staff_anim_arcane_$staff_arcane_anim_size$side_number||
                                                                    [/dummy]
                                                                [/set_specials]
                                                            [/effect]
                                                        [/object]

                                                        [if]
                                                        {VARIABLE_CONDITIONAL staff_arcane_biganim$side_number equals yes}
                                                        [then]
                                                        [/then]
                                                        [/if]
                                                        {VARIABLE staff_arcane_cooldown$side_number $staff_arcane_max_cooldown$side_number}
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Skill is still on cooldown!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Cannot use this skill if you are unable to attack!"
                                                        size=20
                                                        red=255
                                                        duration=2000
                                                    [/print]
                                                [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/staff-enchant-fire.png"
                                            description=_"<span color='#ffff99'>Burning Bash</span>: staff applies burn until the end of the turn
    burning enemies take $staff_fire_burn$side_number|| damage per turn until killed
    staff damage type changes from impact to fire while this is active
    cannot use the other staff enchantments while this is active
    Cooldown: <span color='#ffff99'>$staff_fire_max_cooldown$side_number||</span> turns
    Remaining Cooldown: <span color='#ffff99'>$staff_fire_cooldown$side_number|_textvar|</span>"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL skill_staff_enchantment_unlocked$side_number equals yes}
                                                [and]
                                                    [not]
                                                        [have_unit]
                                                            side=$side_number
                                                            id=Hoplite,Hoplite2
                                                            ability=spartan_skill_used_a_staff_enchantment
                                                        [/have_unit]
                                                    [/not]
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                #cannot use weapon-boosting skills if you are not even able to attack, otherwise you just waste energy
                                                [have_unit]
                                                    side=$side_number
                                                    id=Hoplite,Hoplite2
                                                    formula="attacks_left > 0"
                                                [/have_unit]
                                                [then]
                                                [if]
                                                    {VARIABLE_CONDITIONAL staff_fire_cooldown$side_number less_than_equal_to 0}
                                                    [then]
                                                        #[sound]
                                                        #    name=windsweep.ogg#works pretty well as a power up sound
                                                        #[/sound]
                                                        [sound]
                                                            name=fire.wav
                                                        [/sound]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Burning Bash" + "</span>"
                                                        [/floating_text]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=staff
                                                                set_type=fire
                                                                [set_specials]
                                                                    mode=append
                                                                    {WEAPON_SPECIAL_SPARTAN_BURN $staff_fire_burn$side_number}
                                                                [/set_specials]
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    [dummy]
                                                                        id=spartan_skill_used_a_staff_enchantment
                                                                    [/dummy]
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        {VARIABLE staff_fire_cooldown$side_number $staff_fire_max_cooldown$side_number}
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Skill is still on cooldown!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Cannot use this skill if you are unable to attack!"
                                                        size=20
                                                        red=255
                                                        duration=2000
                                                    [/print]
                                                [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                        [option]
                                            image="attacks/staff-enchant-cold.png"
                                            description=_"<span color='#ffff99'>Freezing Touch</span>: staff applies slow until the end of the turn$staff_cold_text$side_number||
    staff damage type changes from impact to cold while this is active
    cannot use the other staff enchantments while this is active
    Cooldown: <span color='#ffff99'>$staff_cold_max_cooldown$side_number||</span> turns
    Remaining Cooldown: <span color='#ffff99'>$staff_cold_cooldown$side_number|_textvar|</span>"
                                            [show_if]
                                                {VARIABLE_CONDITIONAL staff_enchantmentII_unlocked$side_number equals yes}
                                                [and]
                                                    [not]
                                                        [have_unit]
                                                            side=$side_number
                                                            id=Hoplite,Hoplite2
                                                            ability=spartan_skill_used_a_staff_enchantment
                                                        [/have_unit]
                                                    [/not]
                                                [/and]
                                            [/show_if]
                                            [command]
                                                [if]
                                                #cannot use weapon-boosting skills if you are not even able to attack, otherwise you just waste energy
                                                [have_unit]
                                                    side=$side_number
                                                    id=Hoplite,Hoplite2
                                                    formula="attacks_left > 0"
                                                [/have_unit]
                                                [then]
                                                [if]
                                                    {VARIABLE_CONDITIONAL staff_cold_cooldown$side_number less_than_equal_to 0}
                                                    [then]
                                                        #[sound]
                                                        #    name=windsweep.ogg#works pretty well as a power up sound
                                                        #[/sound]
                                                        [sound]
                                                            name=magic-dark.ogg
                                                        [/sound]
                                                        [floating_text]
                                                            x,y=$x1,$y1
                                                            text="<span color='#ffff99'>" + _ "Freezing Touch" + "</span>"
                                                        [/floating_text]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=staff
                                                                set_type=cold
                                                                [set_specials]
                                                                    mode=append
                                                                    {WEAPON_SPECIAL_SLOW}
                                                                [/set_specials]
                                                            [/effect]
                                                            [effect]
                                                                apply_to=new_ability
                                                                [abilities]
                                                                    [dummy]
                                                                        id=spartan_skill_used_a_staff_enchantment
                                                                    [/dummy]
                                                                [/abilities]
                                                            [/effect]
                                                        [/object]
                                                        [if]
                                                        {VARIABLE_CONDITIONAL staff_enchantmentVI_unlocked$side_number equals yes}
                                                        [then]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=staff
                                                                [set_specials]
                                                                    mode=append
                                                                    {WEAPON_SPECIAL_SPARTAN_SWEEPING_SLOW}
                                                                [/set_specials]
                                                            [/effect]
                                                        [/object]
                                                        [/then]
                                                        [/if]
                                                        #Staff Enchantments V adds a fire resistance buff to this skill
                                                        [if]
                                                        {VARIABLE_CONDITIONAL staff_enchantmentV_unlocked$side_number equals yes}
                                                        [then]
                                                        [object]
                                                            silent=yes
                                                            duration=turn#so that it works on the enemy turn
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=resistance
                                                                replace=no
                                                                [resistance]
                                                                    fire=-30
                                                                [/resistance]
                                                            [/effect]                                                            
                                                        [/object]
                                                        [/then]
                                                        [/if]
                                                        [if]
                                                        {VARIABLE_CONDITIONAL staff_enchantmentVII_unlocked$side_number equals yes}
                                                        [then]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=staff
                                                                [set_specials]
                                                                    mode=append
                                                                    {WEAPON_SPECIAL_SPARTAN_LONG_SLOW}
                                                                [/set_specials]
                                                            [/effect]
                                                        [/object]
                                                        [/then]
                                                        [/if]
                                                        [if]
                                                        {VARIABLE_CONDITIONAL staff_enchantmentVIII_unlocked$side_number equals yes}
                                                        [then]
                                                        [object]
                                                            silent=yes
                                                            duration=turn end
                                                            [filter]
                                                                side=$side_number
                                                                id=Hoplite,Hoplite2
                                                            [/filter]
                                                            [effect]
                                                                apply_to=attack
                                                                name=staff
                                                                remove_specials=spartan_sweepingslow
                                                                [set_specials]
                                                                    mode=append
                                                                    {WEAPON_SPECIAL_SPARTAN_SWEEPING_LONG_SLOW}
                                                                [/set_specials]
                                                            [/effect]
                                                        [/object]
                                                        [/then]
                                                        [/if]
                                                        {VARIABLE staff_cold_cooldown$side_number $staff_cold_max_cooldown$side_number}
                                                    [/then]
                                                    [else]
                                                        [print]
                                                            text= _ "Skill is still on cooldown!"
                                                            size=20
                                                            red=255
                                                            duration=2000
                                                        [/print]
                                                    [/else]
                                                [/if]
                                                [/then]
                                                [else]
                                                    [print]
                                                        text= _ "Cannot use this skill if you are unable to attack!"
                                                        size=20
                                                        red=255
                                                        duration=2000
                                                    [/print]
                                                [/else]
                                                [/if]
                                            [/command]
                                        [/option]
                                    [/message]
                                    {SPARTAN_CLEAR_COOLDOWN_TEXT_VARIABLES}
                                [/event]
                                [event]
                                    name=turn refresh
                                    id=spartan_burn_damage
                                    first_time_only=no

                                    [store_unit]
                                        [filter]
                                            ability=spartan_burning
                                            formula="self.wml_vars.burn_applier_id = Hoplite"
                                        [/filter]
                                        variable=burn_achievement_check1
                                        kill=no
                                    [/store_unit]

                                    {IF_VAR burn_achievement_check1.length greater_than_equal_to 5 (
                                        [then]
                                            {ACHIEVEMENT_MESSAGE_LONE pyromaniac 1}
                                        [/then]
                                    )}

                                    {CLEAR_VARIABLE burn_achievement_check1}

#ifdef MULTIPLAYER

                                    [store_unit]
                                        [filter]
                                            ability=spartan_burning
                                            formula="self.wml_vars.burn_applier_id = Hoplite..2"#using Hoplite2 directly breaks the formula
                                        [/filter]
                                        variable=burn_achievement_check2
                                        kill=no
                                    [/store_unit]

                                    {IF_VAR burn_achievement_check2.length greater_than_equal_to 5 (
                                        [then]
                                            {ACHIEVEMENT_MESSAGE_LONE pyromaniac 2}
                                        [/then]
                                    )}

                                    {CLEAR_VARIABLE burn_achievement_check2}

#endif

                                    [store_unit]
                                        [filter]
                                            ability=spartan_burning
                                            side=$side_number
                                        [/filter]
                                        variable=burn_store
                                        kill=no
                                    [/store_unit]

                                    [foreach]
                                        array=burn_store
                                        index_var=i
                                        [do]
                                            [spartan_harm_unit]
                                                [filter]
                                                    id=$this_item.id
                                                [/filter]
                                                [filter_second]
                                                    id=$this_item.variables.burn_applier_id
                                                [/filter_second]
                                                amount=$this_item.variables.burn_damage
                                                damage_type=fire
                                                fire_event=yes
#                                                kill=no
                                                kill=yes
                                                animate=yes
                                            [/spartan_harm_unit]
                                        [/do]
                                    [/foreach]

                                    {CLEAR_VARIABLE burn_store}

                                    #commented out this obsolete code. in the original version kill=no was needed for exp to work properly. in Spartan experience is generally irrelevant, so this code is not needed at all

                                    #[store_unit]
                                    #    [filter]
                                    #        ability=spartan_burning
                                    #        side=$side_number
                                    #        [and]
                                    #            [filter_wml]
                                    #                hitpoints=1
                                    #            [/filter_wml]
                                    #        [/and]
                                    #    [/filter]
                                    #    variable=burn_store
                                    #    kill=no
                                    #[/store_unit]
#
                                    #[foreach]
                                    #    array=burn_store
                                    #    index_var=ti
                                    #    [do]
                                    #        [spartan_kill]
                                    #            id=$this_item.id
                                    #            animate=yes
                                    #            fire_event=yes
                                    #            experience=yes
                                    #            [filter_second]
                                    #                id=$this_item.variables.burn_applier_id
                                    #            [/filter_second]
                                    #        [/spartan_kill]
                                    #    [/do]
                                    #[/foreach]
#
                                    #{CLEAR_VARIABLE burn_store}
                                [/event]
                                [event]
                                    name=attacker hits
                                    id=spartan_axe_cleave
                                    first_time_only=no
                                    [filter_attack]
                                        special_id=spartan_axe_cleave
                                    [/filter_attack]

                                    [store_unit]
                                        [filter]
                                            [filter_side]
                                                [enemy_of]
                                                    side=$unit.side
                                                [/enemy_of]
                                            [/filter_side]
                                            [filter_adjacent]
                                                x,y=$x2,$y2
                                            [/filter_adjacent]
                                            [filter_adjacent]
                                                x,y=$x1,$y1
                                            [/filter_adjacent]
                                            [not]
                                                [filter_wml]
                                                    [status]
                                                        petrified=yes
                                                    [/status]
                                                [/filter_wml]
                                                [or]
                                                    id=$second_unit.id
                                                [/or]
                                            [/not]
                                        [/filter]
                                        variable=bystander
                                    [/store_unit]

                                    {VARIABLE areadmg $weapon.damage}
                                    {VARIABLE_OP areadmg multiply 0.5}

                                    {IF_VAR axe_overkill_unlocked$unit.side equals yes (
                                        [then]
                                            {VARIABLE spartan_overkill_enabled yes}
                                        [/then]
                                    )}

                                    [if]
                                        {VARIABLE_CONDITIONAL unit.status.slowed boolean_equals yes}
                                        [then]
                                            {VARIABLE_OP areadmg divide 2}
                                            {VARIABLE_OP areadmg round floor}
                                        [/then]
                                    [/if]

                                    [foreach]
                                        array=bystander
                                        [do]
                                            [spartan_harm_unit]
                                                [filter]
                                                    id=$this_item.id
                                                [/filter]
                                                [filter_second]
                                                    id=$unit.id
                                                [/filter_second]
                                                amount=$areadmg
                                                damage_type=$weapon.type
                                                fire_event=yes
                                                animate=defender
                                                delay=0
                                                experience=yes
                                            [/spartan_harm_unit]
                                        [/do]
                                    [/foreach]
                                    {CLEAR_VARIABLE bystander}
                                    {CLEAR_VARIABLE spartan_overkill_enabled}
                                [/event]
                                [event]
                                    name=attacker hits
                                    id=spartan_axe_spin
                                    first_time_only=no
                                    [filter_attack]
                                        special_id=spartan_axe_spin
                                    [/filter_attack]

                                    [store_unit]
                                        [filter]
                                            [filter_side]
                                                [enemy_of]
                                                    side=$unit.side
                                                [/enemy_of]
                                            [/filter_side]
                                            [filter_adjacent]
                                                x,y=$x1,$y1
                                            [/filter_adjacent]
                                            [not]
                                                [filter_wml]
                                                    [status]
                                                        petrified=yes
                                                    [/status]
                                                [/filter_wml]
                                                [or]
                                                    id=$second_unit.id
                                                [/or]
                                            [/not]
                                        [/filter]
                                        variable=bystander
                                    [/store_unit]

                                    {VARIABLE areadmg $weapon.damage}
                                    {VARIABLE_OP areadmg multiply 0.5}

                                    {IF_VAR axe_overkill_unlocked$unit.side equals yes (
                                        [then]
                                            {VARIABLE spartan_overkill_enabled yes}
                                        [/then]
                                    )}

                                    [if]
                                        {VARIABLE_CONDITIONAL unit.status.slowed boolean_equals yes}
                                        [then]
                                            {VARIABLE_OP areadmg divide 2}
                                            {VARIABLE_OP areadmg round floor}
                                        [/then]
                                    [/if]

                                    [foreach]
                                        array=bystander
                                        [do]
                                            [spartan_harm_unit]
                                                [filter]
                                                    id=$this_item.id
                                                [/filter]
                                                [filter_second]
                                                    id=$unit.id
                                                [/filter_second]
                                                amount=$areadmg
                                                damage_type=$weapon.type
                                                fire_event=yes
                                                animate=defender
                                                delay=0
                                                experience=yes
                                            [/spartan_harm_unit]
                                        [/do]
                                    [/foreach]
                                    {CLEAR_VARIABLE bystander}
                                    {CLEAR_VARIABLE spartan_overkill_enabled}
                                [/event]
                                [event]
                                    name=attacker hits
                                    id=spartan_energy_siphon
                                    first_time_only=no
                                    [filter_attack]
                                        special_id=spartan_energy_siphon
                                    [/filter_attack]
                                    {HOPLITE_ADD_ENERGY_BY_SIDE $unit.side "$($second_unit.level * 5)"}
                                [/event]
                                [event]
                                    name=attacker hits
                                    id=spartan_energy_siphonII
                                    first_time_only=no
                                    [filter_attack]
                                        special_id=spartan_energy_siphonII
                                    [/filter_attack]
                                    {HOPLITE_ADD_ENERGY_BY_SIDE $unit.side "$($second_unit.level * 10)"}
                                [/event]
                                [event]
                                    name=die
                                    id=spartan_reaper_harvest
                                    first_time_only=no
                                    [filter]
                                       side=$hoplite_enemyside                                     
                                    [/filter]
                                    [filter_condition]
                                        #it is a shared upgrade and it sets the unlocked variable for both side 1 and 2, so filtering for side 1 is good enough
                                        {VARIABLE_CONDITIONAL reaper_harvest_unlocked1 equals yes}
                                    [/filter_condition]
                                    {VARIABLE_OP reaper_harvest_counter add $unit.level}

                                    {IF_VAR reaper_harvest_counter greater_than_equal_to $reaper_harvest_levels_requirement (
                                    [then]
                                        {UNIT $hoplite_allyside (Hoplite_Poltergeist) $x1 $y1 (
                                            placement=map
                                            passable=yes
                                            generate_name=yes
                                            random_gender=yes
                                            animate=yes
                                        )}
#                                        {VARIABLE_OP reaper_harvest_counter sub $reaper_harvest_levels_requirement}
                                        {VARIABLE reaper_harvest_counter 0}
                                    [/then]
                                    )}
                                [/event]
                                [event]
                                    name=die
                                    id=spartan_reaper_harvest2
                                    first_time_only=no
                                    [filter]
                                       side=$hoplite_enemyside                                     
                                    [/filter]
                                    [filter_condition]
                                        #it is a shared upgrade and it sets the unlocked variable for both side 1 and 2, so filtering for side 1 is good enough
                                        {VARIABLE_CONDITIONAL reaper_harvestII_unlocked1 equals yes}
                                    [/filter_condition]
                                    {VARIABLE_OP reaper_harvest_nightgaunt_counter add $unit.level}

                                    {IF_VAR reaper_harvest_nightgaunt_counter greater_than_equal_to $reaper_harvest_nightgaunt_levels_requirement (
                                    [then]
                                        {UNIT $hoplite_allyside (Hoplite_Nightgaunt) $x1 $y1 (
                                            placement=map
                                            passable=yes
                                            generate_name=yes
                                            random_gender=yes
                                            animate=yes
                                        )}
#                                          {VARIABLE_OP reaper_harvest_nightgaunt_counter sub $reaper_harvest_nightgaunt_levels_requirement}
                                        {VARIABLE reaper_harvest_nightgaunt_counter 0}
                                    [/then]
                                    )}
                                [/event]

    [event]
        name=attack_end
        id=spartan_rapidslash_event
        first_time_only=no
        priority=10#the "end turn on attack end" even is priority 0, so we make this take place before that
        [filter]
            side=$hoplite_playerside
            ability=spartan_rapid_slash_active
        [/filter]
        #removes the extra attack abilities, keeps the _used ability so the skill can't be spammed
        [remove_object]
            id=$unit.id
            object_id=rapid_slash_effects
        [/remove_object]

        [object]
            silent=yes
            duration=turn end
            id=rapid_slash_restrictions
            take_only_once=no
            [filter]
                side=$side_number
                id=Hoplite,Hoplite2
            [/filter]
            [effect]
                apply_to=attack
                range=melee
                [not]
                    name=sword
                [/not]
                [set_specials]
                    mode=append
                    [disable]
                        id=rapidslash_restrict_other_melees
                    [/disable]
                [/set_specials]
            [/effect]
            [effect]
                apply_to=new_ability
                [abilities]
                    {ABILITY_SPARTAN_DISABLE_PLAYER_RANGED_ATTACKS}
                    [dummy]
                        id=spartan_rapidslash_restrictions_active
                    [/dummy]
                [/abilities]
            [/effect]
        [/object]

        {MODIFY_UNIT id=$unit.id attacks_left "$($unit.attacks_left + 1)"}

        [floating_text]
            x,y=$x1,$y1
            text=_"rapid slash"
        [/floating_text]
    [/event]
    [event]
        name=attack_end
        id=spartan_rapidslash_event2
        first_time_only=no
        priority=15#happens BEFORE the previous event, to avoid triggering the events twice in a row
        [filter]
            side=$hoplite_playerside
            ability=spartan_rapidslash_restrictions_active
        [/filter]
        #removes the extra attack abilities, keeps the _used ability so the skill can't be spammed
        [remove_object]
            id=$unit.id
            object_id=rapid_slash_restrictions
        [/remove_object]
    [/event]
#enddef
